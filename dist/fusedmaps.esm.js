function e(e,t){const n=window.cartocolor;if(!n)return null;const i=n[e];if(!i)return null;const o=Object.keys(i).map(Number).filter(e=>!isNaN(e)).sort((e,t)=>e-t),l=o.find(e=>e>=t)||o[o.length-1];return i[l]?[...i[l]]:null}function t(e,t){if(!Array.isArray(e)||e.length<3)return null;const[n,i,o]=e;return`rgba(${n},${i},${o},${e.length>=4?e[3]/255:t??1})`}const n=["#e0f3db","#ccebc5","#a8ddb5","#7bccc4","#4eb3d3","#2b8cbe","#0868ac","#084081"],i=["#7F3C8D","#11A579","#3969AC","#F2B701","#E73F74","#80BA5A","#E68310","#008695","#CF1C90","#f97b72"];function o(t,n){if(!t)return null;if(Array.isArray(t))return null;if("string"==typeof t)return t;const o=t["@@function"],l=t.attr;return o&&l?"colorCategories"===o?function(t,n){let o=t.categories?t.categories.map(e=>"object"==typeof e?e:{value:e,label:String(e)}):function(e,t,n){const i=new Map;return(e||[]).forEach(e=>{const o=e?.[t]??e?.properties?.[t];if(null!=o&&""!==o&&"null"!==o&&!i.has(o)){const t=n?e?.[n]??e?.properties?.[n]??o:o;i.set(o,String(t))}}),[...i.entries()].sort((e,t)=>"number"==typeof e[0]&&"number"==typeof t[0]?e[0]-t[0]:String(e[0]).localeCompare(String(t[0]))).map(([e,t])=>({value:e,label:t}))}(n,t.attr,t.labelAttr);if(!o.length)return"rgba(128,128,128,0.5)";let l=e(t.colors||"Bold",Math.max(o.length,3));l&&l.length||(l=i);const a=t.nullColor?`rgb(${t.nullColor.slice(0,3).join(",")})`:"rgba(128,128,128,0.5)",r=["match",["get",t.attr]];return o.forEach((e,t)=>{r.push(e.value),r.push(l[t%l.length])}),r.push(a),t._detectedCategories=o,r}(t,n):"colorContinuous"===o?function(t){if(!t.domain?.length)return null;const[n,i]=t.domain,o=n>i,l=o?[i,n]:[n,i],a=t.steps||7;let r=e(t.colors||"TealGrn",a);if(!r||!r.length)return["interpolate",["linear"],["get",t.attr],l[0],"rgb(237,248,251)",l[1],"rgb(0,109,44)"];o&&r.reverse();const s=["interpolate",["linear"],["get",t.attr]];return r.forEach((e,t)=>{const n=l[0]+(l[1]-l[0])*t/(r.length-1);s.push(n),s.push(e)}),s}(t):null:null}function l(e){if(null==e)return null;try{if("string"==typeof e){const t=e.startsWith("0x")?e.slice(2):e;return/^\d+$/.test(t)?BigInt(t).toString(16):(/[a-f]/i.test(t),t.toLowerCase())}if("number"==typeof e)return BigInt(Math.trunc(e)).toString(16);if("bigint"==typeof e)return e.toString(16)}catch(e){}return null}let a=null;function r(){return window.deck||null}function s(t){if(!t)return null;if(Array.isArray(t))return t;if("string"==typeof t&&t.startsWith("@@=")){const e=t.slice(3);return t=>{try{return new Function("object",`const properties = object?.properties || object || {}; return (${e});`)(t)}catch{return null}}}if("object"==typeof t&&t["@@function"]){const n=t["@@function"],i=t.attr;if(!i)return null;if("colorContinuous"===n){const n=t.domain;if(!Array.isArray(n)||n.length<2)return null;const o=Number(n[0]),l=Number(n[n.length-1]);if(!Number.isFinite(o)||!Number.isFinite(l)||o===l)return null;const a=Math.max(2,Number(t.steps??7)),r=e(t.colors||"ArmyRose",a)||null;if(!r?.length)return null;const s=o>l,c=!!t.reverse,d=(s?!c:c)?[...r].reverse():[...r],u=Math.min(o,l),p=Math.max(o,l),y=Array.isArray(t.nullColor)?t.nullColor:[184,184,184];return e=>{const t=(e?.properties||e||{})[i];let n=null;if("number"==typeof t)n=t;else if("string"==typeof t){const e=parseFloat(t);n=Number.isFinite(e)?e:null}if(null==n||!Number.isFinite(n))return y;const o=(n-u)/(p-u),l=Math.max(0,Math.min(d.length-1,Math.round(o*(d.length-1)))),a=d[l].replace("#","");return[parseInt(a.slice(0,2),16),parseInt(a.slice(2,4),16),parseInt(a.slice(4,6),16)]}}if("colorCategories"===n){const n=Array.isArray(t.categories)?t.categories:Array.isArray(t.domain)?t.domain:[],o=e(t.colors||"Bold",Math.max(n.length,3))||null,l=Array.isArray(t.nullColor)?t.nullColor:[184,184,184],a=new Map;return o?.length&&n.length&&n.forEach((e,t)=>{const n=o[t%o.length]||"#999999",i=String(n).replace("#",""),l=parseInt(i.slice(0,2),16),r=parseInt(i.slice(2,4),16),s=parseInt(i.slice(4,6),16);a.set(String(e),[l,r,s])}),e=>{const t=(e?.properties||e||{})[i];return null==t?l:a.get(String(t))||l}}}return null}function c(e,t,n){const i=Math.PI-2*Math.PI*t/Math.pow(2,n),o=e/Math.pow(2,n)*360-180,l=180/Math.PI*Math.atan(Math.sinh(i)),a=Math.PI-2*Math.PI*(t+1)/Math.pow(2,n),r=(e+1)/Math.pow(2,n)*360-180;return{west:o,south:180/Math.PI*Math.atan(Math.sinh(a)),east:r,north:l}}function d(e,t){return!(e.east<t.west||e.west>t.east||e.north<t.south||e.south>t.north)}function u(e){const t=e.hexLayer?.getFillColor;if(!t||"object"!=typeof t||Array.isArray(t))return{enabled:!1,attr:null};if("colorContinuous"!==t["@@function"])return{enabled:!1,attr:null};const n=t.attr||null;if(!n)return{enabled:!1,attr:null};const i=Array.isArray(t.domain)&&t.domain.length>=2;return{enabled:!0===t.autoDomain||!i,attr:n}}function p(e){if(null==e)return null;if("number"==typeof e)return Number.isFinite(e)?e:null;if("bigint"==typeof e){const t=Number(e);return Number.isFinite(t)?t:null}if("string"==typeof e){const t=parseFloat(e);return Number.isFinite(t)?t:null}return null}function y(e,t,n,i,o){return function(e,t,n,i){if(e.getZoom()<10)return null;const o=t.tileStats[n.id];if(!o)return null;const l=e.getBounds(),a={west:l.getWest(),east:l.getEast(),south:l.getSouth(),north:l.getNorth()};let r=Number.POSITIVE_INFINITY,s=Number.NEGATIVE_INFINITY,u=0;for(const[e,t]of Object.entries(o)){const[n,o,l]=e.split("/").map(Number);Number.isFinite(n)&&Number.isFinite(o)&&Number.isFinite(l)&&(Math.abs(n-i)>1||d(c(o,l,n),a)&&(Number.isFinite(t.min)&&(r=Math.min(r,t.min),u++),Number.isFinite(t.max)&&(s=Math.max(s,t.max))))}if(u<2||!Number.isFinite(r)||!Number.isFinite(s))return null;const p=s-r;if(Number.isFinite(p)&&p>0){const e=.01*p;r-=e,s+=e}return r>=s?[r-1,s+1]:[r,s]}(e,t,n,o)}function g(e,t){const n=e.hexLayer?.getFillColor;if(!n||"object"!=typeof n)return!1;const i=n._dynamicDomain;return!!(!Array.isArray(i)||i.length<2||(()=>{const e=i[1]-i[0]?i[1]-i[0]:1;return Math.abs(t[0]-i[0])/e>.05||Math.abs(t[1]-i[1])/e>.05})())&&(n._dynamicDomain=t,!0)}function m(e){const t=e.tileLayerConfig||{};return{tileSize:t.tileSize??256,minZoom:t.minZoom??0,maxZoom:t.maxZoom??19,zoomOffset:t.zoomOffset??0,maxRequests:t.maxRequests??10,refinementStrategy:t.refinementStrategy??"best-available"}}function f(e,t,n,i){const o=r();if(!o)return[];const c=o.TileLayer,d=o.H3HexagonLayer||o?.GeoLayers?.H3HexagonLayer;return c&&d?e.filter(e=>"hex"===e.layerType&&e.isTileLayer&&e.tileUrl).map(e=>e).filter(e=>!1!==t[e.id]).slice().reverse().map(e=>{const t=e.tileUrl,o=m(e),r=e.hexLayer||{},y=r.getFillColor,g=y&&"object"==typeof y&&!Array.isArray(y)&&Array.isArray(y._dynamicDomain)?{...y,domain:y._dynamicDomain}:y,f=r.getLineColor,b=f&&"object"==typeof f&&!Array.isArray(f)&&Array.isArray(f._dynamicDomain)?{...f,domain:f._dynamicDomain}:f,h=s(g),v=s(b),x=function(e){let t=5381;for(let n=0;n<e.length;n++)t=(t<<5)+t^e.charCodeAt(n);return(t>>>0).toString(16)}(`${JSON.stringify({fd:g&&"object"==typeof g?g.domain||g._dynamicDomain:null,ld:b&&"object"==typeof b?b.domain||b._dynamicDomain:null})}|${JSON.stringify({f:g,l:b,stroked:!1!==r.stroked,filled:!1!==r.filled,extruded:!0===r.extruded,opacity:r.opacity,elevationScale:r.elevationScale,coverage:r.coverage,lineWidthMinPixels:r.lineWidthMinPixels})}`),w=!1!==r.stroked,C=!1!==r.filled,L=!0===r.extruded,E="number"==typeof r.opacity?r.opacity:.8,I=r.lineWidthMinPixels??1,F=r.elevationScale??1,$=r.coverage??.9,S=u(e),M=o.refinementStrategy||(S.enabled?"no-overlap":"best-available");return new c({id:`${e.id}-tiles-${x}`,data:t,tileSize:o.tileSize,minZoom:o.minZoom,maxZoom:o.maxZoom,zoomOffset:o.zoomOffset,maxRequests:o.maxRequests,refinementStrategy:M,pickable:!0,visible:!0,getTileData:async({index:o,signal:r})=>{const{x:s,y:c,z:d}=o,y=t.replace("{z}",d).replace("{x}",s).replace("{y}",c),g=y,m=`${d}/${s}/${c}`;if(n.cache.has(g))return n.cache.get(g);if(n.inflight.has(g))try{return await n.inflight.get(g)}catch{return n.cache.get(g)||[]}i(1);const f=(async()=>{try{const i=await fetch(y,{signal:r});if(r?.aborted)return null;if(!i.ok)throw new Error(`tile http ${i.status}`);const s=(i.headers.get("Content-Type")||"").toLowerCase();let c,d=null;if(s.includes("application/octet-stream")||s.includes("application/parquet")||y.endsWith(".parquet")){let e=window.hyparquet;if(!e?.parquetMetadataAsync||!e?.parquetReadObjects)try{e=await async function(){const e=window;return e.hyparquet?.parquetMetadataAsync&&e.hyparquet?.parquetReadObjects?e.hyparquet:a||(a=(async()=>{const t=await new Function("u","return import(u)")("https://cdn.jsdelivr.net/npm/hyparquet@1.23.3/+esm"),n=t?.default&&(t.default.parquetReadObjects||t.default.parquetMetadataAsync)?t.default:t;return e.hyparquet=n,e.hyparquet})().catch(e=>{throw a=null,e}),a)}()}catch(e){return console.error("[tiles] failed to auto-load hyparquet",e),null}const t=await i.arrayBuffer();if(r?.aborted)return null;if(!t||0===t.byteLength)return[];const n={byteLength:t.byteLength,slice:async(e,n)=>t.slice(e,n)},o=await e.parquetMetadataAsync(n);if(d=o,r?.aborted)return null;c=await e.parquetReadObjects({file:n,utf8:!1,metadata:o})}else{let e=await i.text();if(r?.aborted)return null;e=e.replace(/\"(hex|h3|index|id)\"\s*:\s*(\d+)/gi,(e,t,n)=>`"${t}":"${n}"`),c=JSON.parse(e)}const f=(o=c,t=(Array.isArray(o)?o:Array.isArray(o?.data)?o.data:Array.isArray(o?.features)?o.features:[]).map(e=>e?.properties?{...e.properties}:{...e}).map(e=>{const t=l(e.hex??e.h3??e.index??e.id);if(!t)return null;const n={...e,hex:t};return{...n,properties:{...n}}}).filter(Boolean),(t||[]).map(e=>{const t=function(e){const t={};for(const n of Object.keys(e||{})){const i=e[n];if("bigint"==typeof i){const e=String(n).toLowerCase();"hex"===e||"h3"===e||"index"===e||"id"===e?t[n]=i.toString(16):i<=BigInt(Number.MAX_SAFE_INTEGER)&&i>=BigInt(Number.MIN_SAFE_INTEGER)?t[n]=Number(i):t[n]=i.toString()}else t[n]=i}return t}(e?.properties?e.properties:e||{});return{...t,properties:{...t}}}));n.cache.set(g,f);try{const t=u(e);if(t.enabled&&t.attr&&d){const i=function(e,t){const n=e?.row_groups||e?.rowGroups||e?.row_groups_list||null;if(!Array.isArray(n)||0===n.length)return null;let i=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY,l=!1;for(const e of n){const n=e?.columns||e?.columns_list||null;if(Array.isArray(n))for(const e of n){const n=e?.meta_data||e?.metaData||e?.metadata||null,a=n?.path_in_schema||n?.pathInSchema||n?.path||null,r=Array.isArray(a)?String(a[a.length-1]):"string"==typeof a?a:null;if(!r||r!==t)continue;const s=n?.statistics||n?.stats||e?.statistics||null;if(!s)continue;const c=p(s.min_value??s.min??s.minimum??s.minValue),d=p(s.max_value??s.max??s.maximum??s.maxValue);null!=c&&null!=d&&(l=!0,c<i&&(i=c),d>o&&(o=d))}}return l&&Number.isFinite(i)&&Number.isFinite(o)?i===o?{min:i-1,max:o+1}:{min:i,max:o}:null}(d,t.attr);if(i){n.tileStats[e.id]||(n.tileStats[e.id]={}),n.tileStats[e.id][m]={min:i.min,max:i.max};try{window.dispatchEvent(new CustomEvent("fusedmaps:autodomain:dirty"))}catch{}}}}catch(e){}return f}catch(e){return null}finally{n.inflight.delete(g),i(-1)}var t,o})();return n.inflight.set(g,f),await f},renderSubLayers:e=>{const t=e.data||[];return t&&t.length?new d({id:`${e.id}-h3`,data:t,getHexagon:e=>e.hex,pickable:!0,stroked:w,filled:C,extruded:L,opacity:E,coverage:$,lineWidthMinPixels:I,elevationScale:F,...h?{getFillColor:h}:{},...v?{getLineColor:v}:{}}):null}})}):[]}const b={};function h(e,n,i,a){!function(e,t){t.forEach(t=>{[`${t.id}-fill`,`${t.id}-extrusion`,`${t.id}-outline`,`${t.id}-circle`,`${t.id}-line`,`${t.id}-raster`].forEach(t=>{try{e.getLayer(t)&&e.removeLayer(t)}catch(e){}});try{e.getSource(t.id)&&e.removeSource(t.id)}catch(e){}})}(e,n),[...n].reverse().forEach(n=>{const a=!1!==i[n.id];switch(n.layerType){case"hex":{const i=n;if(i.isTileLayer);else if(i.data?.length){const r=function(e){const t=[];for(const n of e){const e=l(n.hex??n.h3??n.index??n.id);if(e&&window.h3?.isValidCell(e))try{const i=window.h3.cellToBoundary(e).map(([e,t])=>[t,e]);i.push(i[0]),t.push({type:"Feature",properties:{...n,hex:e},geometry:{type:"Polygon",coordinates:[i]}})}catch(e){}}return{type:"FeatureCollection",features:t}}(i.data);b[n.id]=r,function(e,n,i,l){const a=n.hexLayer||{},r=n.data||[];e.addSource(n.id,{type:"geojson",data:i});const s=Array.isArray(a.getFillColor)?t(a.getFillColor,.8):o(a.getFillColor,r)||"rgba(0,144,255,0.7)",c=a.getLineColor?Array.isArray(a.getLineColor)?t(a.getLineColor,1):o(a.getLineColor,r):"rgba(255,255,255,0.3)",d="number"==typeof a.opacity&&isFinite(a.opacity)?Math.max(0,Math.min(1,a.opacity)):.8;if(a.extruded){const t=a.elevationScale||1;e.addLayer({id:`${n.id}-extrusion`,type:"fill-extrusion",source:n.id,paint:{"fill-extrusion-color":s,"fill-extrusion-height":a.getFillColor?.attr?["*",["get",a.getFillColor.attr],t]:100,"fill-extrusion-base":0,"fill-extrusion-opacity":d},layout:{visibility:l?"visible":"none"}})}else!1!==a.filled&&e.addLayer({id:`${n.id}-fill`,type:"fill",source:n.id,paint:{"fill-color":s,"fill-opacity":d},layout:{visibility:l?"visible":"none"}});e.addLayer({id:`${n.id}-outline`,type:"line",source:n.id,paint:{"line-color":c,"line-width":a.lineWidthMinPixels||.5},layout:{visibility:l?"visible":"none"}})}(e,i,r,a)}break}case"vector":{const t=n;t.geojson&&(b[n.id]=t.geojson,function(e,t,n){const i=t.geojson;if(!i?.features?.length)return;e.addSource(t.id,{type:"geojson",data:i});const l=i.features.map(e=>e.properties||{}),a=t.fillColorConfig?.["@@function"]?o(t.fillColorConfig,l):t.fillColorRgba||"rgba(0,144,255,0.6)",r=t.lineColorConfig?.["@@function"]?o(t.lineColorConfig,l):t.lineColorRgba||"rgba(100,100,100,0.8)",s="number"==typeof t.lineWidth&&isFinite(t.lineWidth)?t.lineWidth:1,c="number"==typeof t.opacity&&isFinite(t.opacity)?Math.max(0,Math.min(1,t.opacity)):.8;let d=!1,u=!1,p=!1;for(const e of i.features){const t=e.geometry?.type;"Point"!==t&&"MultiPoint"!==t||(u=!0),"Polygon"!==t&&"MultiPolygon"!==t||(d=!0),"LineString"!==t&&"MultiLineString"!==t||(p=!0)}d&&(!1!==t.isFilled&&e.addLayer({id:`${t.id}-fill`,type:"fill",source:t.id,paint:{"fill-color":a,"fill-opacity":c},filter:["any",["==",["geometry-type"],"Polygon"],["==",["geometry-type"],"MultiPolygon"]],layout:{visibility:n?"visible":"none"}}),!1!==t.isStroked&&e.addLayer({id:`${t.id}-outline`,type:"line",source:t.id,layout:{"line-join":"round","line-cap":"round",visibility:n?"visible":"none"},paint:{"line-color":r,"line-width":s},filter:["any",["==",["geometry-type"],"Polygon"],["==",["geometry-type"],"MultiPolygon"]]})),p&&e.addLayer({id:`${t.id}-line`,type:"line",source:t.id,layout:{"line-join":"round","line-cap":"round",visibility:n?"visible":"none"},paint:{"line-color":r,"line-width":s,"line-opacity":1},filter:["any",["==",["geometry-type"],"LineString"],["==",["geometry-type"],"MultiLineString"]]}),u&&e.addLayer({id:`${t.id}-circle`,type:"circle",source:t.id,paint:{"circle-radius":t.pointRadius||6,"circle-color":a,"circle-stroke-color":"rgba(0,0,0,0.5)","circle-stroke-width":1,"circle-opacity":.9},filter:["any",["==",["geometry-type"],"Point"],["==",["geometry-type"],"MultiPoint"]],layout:{visibility:n?"visible":"none"}})}(e,t,a));break}case"mvt":!function(e,t,n){const i=t.sourceLayer||"udf";e.addSource(t.id,{type:"vector",tiles:[t.tileUrl],minzoom:t.minzoom||0,maxzoom:t.maxzoom||22});const o=t.fillColor||"#FFF5CC",l=t.lineColor||"#FFFFFF",a=t.fillOpacity??.8,r=t.lineWidth??1;!1!==t.isFilled&&e.addLayer({id:`${t.id}-fill`,type:"fill",source:t.id,"source-layer":i,paint:{"fill-color":o,"fill-opacity":a},layout:{visibility:n?"visible":"none"}}),e.addLayer({id:`${t.id}-line`,type:"line",source:t.id,"source-layer":i,paint:{"line-color":l,"line-width":r},layout:{visibility:n?"visible":"none"}}),t.isExtruded&&e.addLayer({id:`${t.id}-extrusion`,type:"fill-extrusion",source:t.id,"source-layer":i,paint:{"fill-extrusion-color":o,"fill-extrusion-height":["*",["get",t.heightProperty||"height"],t.heightMultiplier||1],"fill-extrusion-base":0,"fill-extrusion-opacity":t.extrusionOpacity??.9},layout:{visibility:n?"visible":"none"}})}(e,n,a);break;case"raster":!function(e,t,n){const i=t.opacity??t.rasterLayer?.opacity??1;e.addSource(t.id,{type:"raster",tiles:[t.tileUrl],tileSize:256}),e.addLayer({id:`${t.id}-raster`,type:"raster",source:t.id,paint:{"raster-opacity":Math.max(0,Math.min(1,i))},layout:{visibility:n?"visible":"none"}})}(e,n,a)}});let s=null;if(n.some(e=>"hex"===e.layerType&&e.isTileLayer&&e.tileUrl)){const t=function(e,t,n){const i=r();if(!i?.MapboxOverlay||!i?.TileLayer)return null;const o={cache:new Map,inflight:new Map,tilesLoading:0,tileStats:{}},l=function(){let e=document.getElementById("tile-loader");e||(e=document.createElement("div"),e.id="tile-loader",e.innerHTML='<div class="loader-spinner"></div><span id="loader-text">Loading tiles...</span>',document.body.appendChild(e));const t=document.getElementById("loader-text");let n=null,i=0;return{setLoading:o=>{i=Math.max(0,i+o),e&&(i>0?(n&&clearTimeout(n),e.classList.add("active"),t&&(t.textContent=1===i?"Loading tile...":`Loading ${i} tiles...`)):n=setTimeout(()=>e?.classList.remove("active"),300))}}}(),a=()=>f(t,n,o,l.setLoading),s=new i.MapboxOverlay({interleaved:!0,useDevicePixels:!0,layers:a()});try{e.addControl(s)}catch{}const c=()=>{try{s.setProps({layers:a()});try{e.triggerRepaint?.()}catch{}}catch{}},d=t.filter(e=>"hex"===e.layerType&&e.isTileLayer).map(e=>({layer:e,...u(e),tileCfg:m(e)})).filter(e=>e.enabled&&e.attr);let p=null;const b=t=>{d.length&&(p&&clearTimeout(p),p=setTimeout(()=>{let t=!1;for(const n of d){const i=Math.round(e.getZoom())+(n.tileCfg.zoomOffset||0),l=y(e,o,n.layer,n.attr,i);l&&g(n.layer,l)&&(t=!0)}if(t){c();try{window.dispatchEvent(new CustomEvent("fusedmaps:legend:update"))}catch{}}},t))},h=()=>b(800),v=()=>b(1200),x=()=>b(150);if(d.length){e.on("moveend",h),e.on("idle",v);try{window.addEventListener("fusedmaps:autodomain:dirty",x)}catch{}b(1500)}return{overlay:s,rebuild:c,pickObject:e=>{try{return s.pickObject(e)}catch{return null}},destroy:()=>{p&&clearTimeout(p);try{e.off("moveend",h)}catch{}try{e.off("idle",v)}catch{}try{window.removeEventListener("fusedmaps:autodomain:dirty",x)}catch{}try{e.removeControl(s)}catch{}}}}(e,n,i);s=t?.overlay||null,s&&t&&(s.__fused_hex_tiles__=t)}return{deckOverlay:s}}let v=null;function x(n,i){const o=document.getElementById("layer-list");o&&(o.innerHTML=n.map(n=>{const o=!1!==i[n.id],l=function(n){let i="#0090ff";const o=e=>e&&e.length?1===e.length?e[0]:`linear-gradient(to bottom, ${e.map((t,n)=>`${t} ${n/(e.length-1)*100}%`).join(", ")})`:null;if("hex"===n.layerType){const l=n.hexLayer||{},a=!1===l.filled&&l.getLineColor?l.getLineColor:l.getFillColor;if(Array.isArray(a)){const e=t(a,1);e&&(i=e)}else if(a&&"object"==typeof a){const t=a["@@function"];if("colorContinuous"===t||"colorCategories"===t){let n=e(a.colors||("colorCategories"===t?"Bold":"TealGrn"),a.steps||7);if(n?.length){const e=a.domain,t=Array.isArray(e)&&e.length>=2&&e[0]>e[e.length-1],l=!!a.reverse;(t?!l:l)&&(n=[...n].reverse()),i=o(n)||i}}}}else if("vector"===n.layerType){const t=n;if(t.lineColorRgba&&!t.isFilled)i=t.lineColorRgba;else if(t.fillColorRgba)i=t.fillColorRgba;else if(t.fillColorConfig&&"object"==typeof t.fillColorConfig){const n=t.fillColorConfig.colors;if(n){const t=e(n,7);t?.length&&(i=o(t)||i)}}}else"raster"===n.layerType&&(i="linear-gradient(to bottom, #888, #444)");return i}(n),a=o?'<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>':'<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/></svg>';return`\n      <div class="layer-item ${o?"":"disabled"}" \n           data-layer-id="${n.id}" \n           style="--layer-strip: ${l};" \n           onclick="onLayerItemClick(event, '${n.id}')">\n        <span class="layer-name">${n.name}</span>\n        <span class="layer-eye" onclick="event.stopPropagation(); toggleLayerVisibility('${n.id}', ${!o})">${a}</span>\n      </div>\n    `}).join(""))}function w(t,o,l){const a=document.getElementById("color-legend");if(!a)return;const r=t.filter(e=>!1!==o[e.id]);if(!r.length)return void(a.style.display="none");let s="";r.forEach(t=>{const o=function(t){let o=null;if("hex"===t.layerType){const e=t.hexLayer||{};o=!1===e.filled&&e.getLineColor?e.getLineColor:e.getFillColor}else if("vector"===t.layerType){const e=t;if(o=e.fillColorConfig,!o?.["@@function"]&&e.lineColorRgba&&!e.isFilled)return`\n        <div class="legend-layer">\n          <div class="legend-title">\n            <span class="legend-line" style="background:${e.lineColorRgba};"></span>\n            ${t.name}\n          </div>\n        </div>\n      `}const l=o?.["@@function"];if(!l||!o?.attr)return"";if("colorContinuous"!==l&&"colorCategories"!==l)return"";const a=o.colors||("colorCategories"===l?"Bold":"TealGrn");return"colorCategories"===l?function(t,n,o){let l=n._detectedCategories||n.categories||[];if(l=l.map(e=>"object"==typeof e&&e.label?e:{value:e,label:e}),!l.length)return"";let a=e(o,Math.max(l.length,3));a?.length||(a=i);const r=n.labelAttr||n.attr;return`\n    <div class="legend-layer">\n      <div class="legend-title">\n        <span class="legend-dot" style="background:${a[0]};"></span>\n        ${t}: ${r}\n      </div>\n      <div class="legend-categories">\n        ${l.map((e,t)=>`\n          <div class="legend-cat-item">\n            <div class="legend-cat-swatch" style="background:${a[t%a.length]};"></div>\n            <span class="legend-cat-label" title="${e.label}">${e.label}</span>\n          </div>\n        `).join("")}\n      </div>\n    </div>\n  `}(t.name,o,a):"colorContinuous"===l?function(t,i,o){const l=i._dynamicDomain||i.domain;if(!l?.length)return"";const[a,r]=l,s=a>r;let c=e(o,i.steps||7);c?.length||(c=n),s&&(c=[...c].reverse());const d=`linear-gradient(to right, ${c.map((e,t)=>`${e} ${t/(c.length-1)*100}%`).join(", ")})`;return`\n    <div class="legend-layer">\n      <div class="legend-title">\n        <span class="legend-dot" style="background:${c[Math.floor(c.length/2)]};"></span>\n        ${t}: ${i.attr}\n      </div>\n      <div class="legend-gradient" style="background:${d};"></div>\n      <div class="legend-labels">\n        <span>${a.toFixed(1)}</span>\n        <span>${r.toFixed(1)}</span>\n      </div>\n    </div>\n  `}(t.name,o,a):""}(t);o&&(s+=o)}),s?(a.innerHTML=s,a.style.display="block"):a.style.display="none"}function C(e,t,n){class i{onAdd(e){this._map=e;const i=document.createElement("div");i.className="mapboxgl-ctrl mapboxgl-ctrl-group";const o=(e,t,n)=>{const i=document.createElement("button");return i.type="button",i.title=t,i.setAttribute("aria-label",t),i.style.fontSize="16px",i.style.lineHeight="20px",i.style.fontWeight="600",i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="center",i.textContent=e,i.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation();try{n()}catch(e){}}),i};return i.appendChild(o("+","Zoom in",()=>e.zoomIn({duration:250}))),i.appendChild(o("−","Zoom out",()=>e.zoomOut({duration:250}))),i.appendChild(o("⌂","Reset view",()=>{e.easeTo({center:[t.longitude,t.latitude],zoom:Number.isFinite(t.zoom)?t.zoom:e.getZoom(),pitch:Number.isFinite(t.pitch??0)?t.pitch??0:e.getPitch(),bearing:Number.isFinite(t.bearing??0)?t.bearing??0:e.getBearing(),duration:600})})),n&&i.appendChild(((t,n)=>{const i=document.createElement("button");return i.type="button",i.title=n,i.setAttribute("aria-label",n),i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="center",i.innerHTML='<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" style="display:block">\n              <path d="M4 8h3l1.2-2h7.6L17 8h3a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2z"/>\n              <circle cx="12" cy="14" r="3.2"/>\n            </svg>',i.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation();try{!function(e){const t=`map-screenshot-${(new Date).toISOString().replace(/[:.]/g,"-")}.png`;try{const n=e.getCanvas(),i=document.createElement("a");if(i.download=t,"function"==typeof n.toBlob)return void n.toBlob(e=>{try{if(!e)throw new Error("toBlob returned null");const t=URL.createObjectURL(e);i.href=t,document.body.appendChild(i),i.click(),i.remove(),setTimeout(()=>URL.revokeObjectURL(t),1e3)}catch(e){console.error("Screenshot failed:",e),alert("Screenshot blocked (likely due to CORS/tainted canvas from raster tiles). Try using only CORS-enabled layers/tiles.")}},"image/png");const o=n.toDataURL("image/png");i.href=o,document.body.appendChild(i),i.click(),i.remove()}catch(e){console.error("Screenshot failed:",e),alert("Screenshot blocked (likely due to CORS/tainted canvas from raster tiles). Try using only CORS-enabled layers/tiles.")}}(e)}catch(e){}}),i})(0,"Download screenshot")),this._container=i,i}onRemove(){try{this._container?.parentNode?.removeChild(this._container)}catch(e){}this._map=void 0,this._container=void 0}}try{e.addControl(new i,"bottom-left")}catch(e){}}function L(e,t,n){!function(e){try{e.addControl(new mapboxgl.ScaleControl({maxWidth:110,unit:"metric"}),"bottom-left")}catch(e){}}(e),C(e,t,n);const i=function(e){const t=e.getCanvasContainer?.()||e.getCanvas?.();if(!t)return()=>{};let n=!1,i=0,o=0,l=0,a=0;const r=()=>{if(n){n=!1;try{e.dragPan.enable()}catch(e){}try{t.style.cursor=""}catch(e){}window.removeEventListener("pointermove",s,{passive:!1}),window.removeEventListener("pointerup",c,{passive:!1}),window.removeEventListener("pointercancel",c,{passive:!1})}},s=t=>{if(!n)return;if(!t.metaKey)return r();const s=t.clientX-i,c=t.clientY-o;var d;e.setBearing(l+.35*s),e.setPitch((d=a-.25*c,Math.max(0,Math.min(85,d)))),t.preventDefault()},c=e=>{r();try{e.preventDefault()}catch(e){}},d=r=>{if(0===r.button&&r.ctrlKey&&!r.metaKey)return r.preventDefault(),void r.stopPropagation();if(!n&&0===r.button&&r.metaKey){n=!0,i=r.clientX,o=r.clientY,l=e.getBearing(),a=e.getPitch();try{e.dragPan.disable()}catch(e){}try{t.style.cursor="grabbing"}catch(e){}window.addEventListener("pointermove",s,{passive:!1}),window.addEventListener("pointerup",c,{passive:!1}),window.addEventListener("pointercancel",c,{passive:!1}),r.stopPropagation(),r.preventDefault()}};return t.addEventListener("pointerdown",d,{passive:!1,capture:!0}),()=>{try{r()}catch(e){}try{t.removeEventListener("pointerdown",d,{capture:!0})}catch(e){}}}(e);return{destroy:()=>{try{i()}catch(e){}}}}function E(e,t){try{return Number.isFinite(e)?e.toFixed(t):""}catch{return""}}function I(e,t,n){try{const i=t.getBoundingClientRect().width||280;e.style.setProperty("--debug-panel-w",`${i}px`);const o=t.classList.contains("collapsed");n.style.left=o?"0px":`var(--debug-panel-w, ${i}px)`}catch(e){}}function F(e,t,n){return Math.max(t,Math.min(n,e))}function $(e){return e&&"object"==typeof e?"colorContinuous"!==e["@@function"]?null:e:null}function S(e){const t=new Set;try{const n=e.hexLayer?.getFillColor,i=e.hexLayer?.getLineColor;n?.attr&&t.add(String(n.attr)),i?.attr&&t.add(String(i.attr));const o=e.hexLayer?.tooltipAttrs;Array.isArray(o)&&o.forEach(e=>t.add(String(e)))}catch(e){}return[...t].filter(Boolean)}let M=!1,k=null;function N(e,t){let n={type:"FeatureCollection",features:[]};if(t){const e=t.properties||{},i=e.hex||e.h3;if(i&&window.h3)try{const t=l(i);if(t&&window.h3.isValidCell(t)){const i=window.h3.cellToBoundary(t).map(([e,t])=>[t,e]);i.push(i[0]),n.features.push({type:"Feature",geometry:{type:"Polygon",coordinates:[i]},properties:e})}}catch(e){}else t.geometry&&n.features.push({type:"Feature",geometry:t.geometry,properties:e})}M?e.getSource("feature-hl").setData(n):(e.addSource("feature-hl",{type:"geojson",data:n}),e.addLayer({id:"feature-hl-fill",type:"fill",source:"feature-hl",paint:{"fill-color":"rgba(255,255,0,0.3)","fill-opacity":1}}),e.addLayer({id:"feature-hl-line",type:"line",source:"feature-hl",paint:{"line-color":"rgba(255,255,0,1)","line-width":3}}),M=!0),k=t}function A(e){let t=null,n=null;try{"BroadcastChannel"in window&&(t=new BroadcastChannel(e))}catch(e){}function i(e){if(!n)return;let t;try{t="string"==typeof e.data?JSON.parse(e.data):e.data}catch{return}n(t)}return{send:function(e){const n=JSON.stringify(e);try{t&&t.postMessage(e)}catch(e){}try{window.parent.postMessage(n,"*")}catch(e){}try{window.top&&window.top!==window.parent&&window.top.postMessage(n,"*")}catch(e){}try{if(window.top?.frames)for(let e=0;e<window.top.frames.length;e++){const t=window.top.frames[e];if(t!==window)try{t.postMessage(n,"*")}catch(e){}}}catch(e){}},onMessage:function(e){n=e,t&&(t.onmessage=e=>{n&&n(e.data)}),window.addEventListener("message",i)},destroy:function(){t&&(t.close(),t=null),window.removeEventListener("message",i),n=null}}}function T(e="component"){return`${e}-${Math.random().toString(36).substr(2,9)}`}function B(e,t,n){t.broadcast?.enabled&&function(e,t={}){const n=t.channel||"fused-bus",i=t.dataset||"all",o=T("map-broadcast"),l=A(n);let a=null;function r(){const t=function(e){const t=e.getBounds();return[+t.getWest().toFixed(6),+t.getSouth().toFixed(6),+t.getEast().toFixed(6),+t.getNorth().toFixed(6)]}(e);if(r=a,(n=t)&&r&&n[0]===r[0]&&n[1]===r[1]&&n[2]===r[2]&&n[3]===r[3])return;var n,r;a=t;const[s,c,d,u]=t;l.send({type:"filter",fromComponent:o,timestamp:Date.now(),dataset:i,filter:{type:"spatial",field:"geometry",values:[s,c,d,u]}}),l.send({type:"spatial_filter",source:o,timestamp:Date.now(),bounds:{sw:{lng:s,lat:c},ne:{lng:d,lat:u}}})}e.on("move",r),e.on("moveend",r),e.on("load",()=>{setTimeout(r,300)}),e.loaded()&&setTimeout(r,100),setTimeout(()=>{l.send({type:"component_ready",componentType:"map",componentId:o,capabilities:["spatial_filter"],dataSource:"viewport",protocol:"unified"})},200)}(e,{channel:t.broadcast.channel,dataset:t.broadcast.dataset}),t.sync?.enabled&&function(e,t={}){let n=t.channel||"default";n.includes("::")||(n=`map-sync::${n}`);const i=T("map"),o=A(n);let l=!1,a=!1,r={x:NaN,y:NaN,z:NaN};const s=(e,t,n)=>Math.abs(e-t)<n;function c(){const t=e.getCenter();return{longitude:+t.lng.toFixed(6),latitude:+t.lat.toFixed(6),zoom:+e.getZoom().toFixed(3),bearing:+e.getBearing().toFixed(1),pitch:+e.getPitch().toFixed(1),id:i,ts:Date.now()}}function d(){if(l)return;const e=c(),{longitude:t,latitude:n,zoom:i}=e;s(t,r.x,1e-6)&&s(n,r.y,1e-6)&&s(i,r.z,.001)||(r={x:t,y:n,z:i},o.send({type:"sync",...e}))}let u=null;const p=()=>{a=!0},y=()=>{a&&(a=!1,d())};e.on("dragstart",p),e.on("zoomstart",p),e.on("rotatestart",p),e.on("pitchstart",p),e.on("moveend",y),e.on("move",()=>{a&&!l&&(u&&clearTimeout(u),u=setTimeout(d,0))}),o.onMessage(t=>{var n;"sync"===t.type&&t.id!==i&&(n=t)&&n.id!==i&&(l||a||(l=!0,e.jumpTo({center:[n.longitude,n.latitude],zoom:n.zoom,bearing:n.bearing,pitch:n.pitch}),requestAnimationFrame(()=>{l=!1})))}),e.on("load",()=>{setTimeout(()=>o.send({type:"sync",...c()}),100+100*Math.random())}),document.addEventListener("visibilitychange",()=>{document.hidden&&(l=!1,a=!1)})}(e,{channel:t.sync.channel}),t.clickBroadcast,t.locationListener}const _={};function j(e){const t=e.containerId||"map";try{const t="light"===e.ui?.theme?"light":"dark";document.documentElement.setAttribute("data-theme",t)}catch(e){}e.layers.forEach(e=>{_[e.id]=!1!==e.visible});const n=function(e){const{containerId:t,mapboxToken:n,styleUrl:i,initialViewState:o,screenshotEnabled:l}=e;return window.mapboxgl.accessToken=n,new window.mapboxgl.Map({container:t,style:i,center:[o.longitude,o.latitude],zoom:o.zoom,pitch:o.pitch||0,bearing:o.bearing||0,projection:"mercator",pitchWithRotate:!0,...l?{preserveDrawingBuffer:!0}:{}})}({containerId:t,mapboxToken:e.mapboxToken,styleUrl:e.styleUrl,initialViewState:e.initialViewState,screenshotEnabled:!1!==e.ui?.screenshot}),i=L(n,e.initialViewState,!1!==e.ui?.screenshot),o=e.debug?function(e,t){let n=document.getElementById("debug-shell");n||(n=document.createElement("div"),n.id="debug-shell",n.innerHTML='\n      <div id="debug-panel">\n        <div id="debug-content">\n          <div class="debug-section">\n            <div class="debug-section-title">Editing Layer</div>\n            <div class="debug-row">\n              <span class="debug-label">Layer</span>\n              <select class="debug-select" id="dbg-layer-select"></select>\n            </div>\n          </div>\n\n          <div class="debug-section">\n            <div class="debug-section-title">Hex Layer</div>\n            <div class="debug-toggles">\n              <label class="debug-checkbox"><input type="checkbox" id="dbg-filled" checked /> Filled</label>\n              <label class="debug-checkbox"><input type="checkbox" id="dbg-stroked" checked /> Stroked</label>\n              <label class="debug-checkbox"><input type="checkbox" id="dbg-extruded" /> Extruded</label>\n            </div>\n            <div class="debug-row" style="margin-top:8px;">\n              <span class="debug-label">Opacity</span>\n              <input type="range" class="debug-slider" id="dbg-opacity-slider" min="0" max="1" step="0.05" value="1" />\n              <input type="number" class="debug-input debug-input-sm" id="dbg-opacity" step="0.1" min="0" max="1" value="1" />\n            </div>\n          </div>\n\n          <div class="debug-section" id="fill-color-section">\n            <div class="debug-section-title">Fill Color</div>\n            <div class="debug-row">\n              <span class="debug-label">Function</span>\n              <select class="debug-select" id="dbg-fill-fn">\n                <option value="colorContinuous">colorContinuous</option>\n                <option value="static">Static Color</option>\n              </select>\n            </div>\n            <div id="fill-fn-options">\n              <div class="debug-row">\n                <span class="debug-label">Attribute</span>\n                <select class="debug-select" id="dbg-attr"></select>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label">Palette</span>\n                <select class="debug-select" id="dbg-palette"></select>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label">Domain</span>\n                <input type="number" class="debug-input debug-input-sm" id="dbg-domain-min" step="0.1" placeholder="min" />\n                <span style="color:#666;">–</span>\n                <input type="number" class="debug-input debug-input-sm" id="dbg-domain-max" step="0.1" placeholder="max" />\n              </div>\n              <div class="debug-row">\n                <span class="debug-label">Steps</span>\n                <input type="number" class="debug-input debug-input-sm" id="dbg-steps" step="1" min="2" max="20" value="7" />\n              </div>\n              <div class="debug-row">\n                <span class="debug-label">Null Color</span>\n                <input type="color" class="debug-color" id="dbg-null-color" value="#b8b8b8" />\n                <span class="debug-color-label" id="dbg-null-color-label">#b8b8b8</span>\n              </div>\n            </div>\n            <div id="fill-static-options" style="display:none;">\n              <div class="debug-row">\n                <span class="debug-label">Color</span>\n                <input type="color" class="debug-color" id="dbg-fill-static" value="#0090ff" />\n                <span class="debug-color-label" id="dbg-fill-static-label">#0090ff</span>\n              </div>\n            </div>\n          </div>\n\n          <div class="debug-section" id="line-color-section">\n            <div class="debug-section-title">Line Color</div>\n            <div class="debug-row">\n              <span class="debug-label">Function</span>\n              <select class="debug-select" id="dbg-line-fn">\n                <option value="colorContinuous">colorContinuous</option>\n                <option value="static" selected>Static Color</option>\n              </select>\n            </div>\n            <div id="line-fn-options" style="display:none;">\n              <div class="debug-row">\n                <span class="debug-label">Attribute</span>\n                <select class="debug-select" id="dbg-line-attr"></select>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label">Palette</span>\n                <select class="debug-select" id="dbg-line-palette"></select>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label">Domain</span>\n                <input type="number" class="debug-input debug-input-sm" id="dbg-line-domain-min" step="0.1" placeholder="min" />\n                <span style="color:#666;">–</span>\n                <input type="number" class="debug-input debug-input-sm" id="dbg-line-domain-max" step="0.1" placeholder="max" />\n              </div>\n            </div>\n            <div id="line-static-options">\n              <div class="debug-row">\n                <span class="debug-label">Color</span>\n                <input type="color" class="debug-color" id="dbg-line-static" value="#ffffff" />\n                <span class="debug-color-label" id="dbg-line-static-label">#ffffff</span>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label">Line Width</span>\n                <input type="range" class="debug-slider" id="dbg-line-width-slider" min="0" max="5" step="0.5" value="1" />\n                <input type="number" class="debug-input debug-input-sm" id="dbg-line-width" step="0.5" min="0" max="10" value="1" />\n              </div>\n            </div>\n          </div>\n\n          <div class="debug-section">\n            <div class="debug-section-title">View State</div>\n            <div class="debug-row">\n              <span class="debug-label">Longitude</span>\n              <input type="number" class="debug-input" id="dbg-lng" step="0.0001" />\n            </div>\n            <div class="debug-row">\n              <span class="debug-label">Latitude</span>\n              <input type="number" class="debug-input" id="dbg-lat" step="0.0001" />\n            </div>\n            <div class="debug-row">\n              <span class="debug-label">Zoom</span>\n              <input type="number" class="debug-input" id="dbg-zoom" step="0.1" min="0" max="22" />\n            </div>\n            <div class="debug-row">\n              <span class="debug-label">Pitch</span>\n              <input type="number" class="debug-input" id="dbg-pitch" step="1" min="0" max="85" />\n            </div>\n            <div class="debug-row">\n              <span class="debug-label">Bearing</span>\n              <input type="number" class="debug-input" id="dbg-bearing" step="1" />\n            </div>\n            <div class="debug-row">\n              <span class="debug-label"></span>\n              <button type="button" class="debug-btn" id="dbg-apply">Apply</button>\n              <button type="button" class="debug-btn debug-btn-secondary" id="dbg-copy">Copy current</button>\n            </div>\n          </div>\n\n          <div class="debug-section">\n            <div class="debug-section-title">Current ViewState</div>\n            <textarea id="dbg-view-output" class="debug-output" readonly></textarea>\n          </div>\n\n          <div class="debug-section">\n            <div class="debug-section-title">Layer Config</div>\n            <textarea id="dbg-output" class="debug-output" readonly></textarea>\n          </div>\n        </div>\n        <div id="debug-resize-handle" title="Drag to resize"></div>\n      </div>\n      <div id="debug-toggle" title="Toggle debug panel">&#x2039;</div>\n    ',document.body.appendChild(n));const i=document.getElementById("debug-panel"),o=document.getElementById("debug-toggle"),l=document.getElementById("debug-resize-handle"),a=document.getElementById("dbg-layer-select"),r=document.getElementById("dbg-filled"),s=document.getElementById("dbg-stroked"),c=document.getElementById("dbg-extruded"),d=document.getElementById("dbg-opacity-slider"),u=document.getElementById("dbg-opacity"),p=document.getElementById("dbg-fill-fn"),y=document.getElementById("fill-fn-options"),g=document.getElementById("fill-static-options"),m=document.getElementById("dbg-attr"),f=document.getElementById("dbg-palette"),b=document.getElementById("dbg-domain-min"),h=document.getElementById("dbg-domain-max"),v=document.getElementById("dbg-steps"),x=document.getElementById("dbg-null-color"),w=document.getElementById("dbg-null-color-label"),C=document.getElementById("dbg-fill-static"),L=document.getElementById("dbg-fill-static-label"),M=document.getElementById("dbg-line-fn"),k=document.getElementById("line-fn-options"),N=document.getElementById("line-static-options"),A=document.getElementById("dbg-line-attr"),T=document.getElementById("dbg-line-palette"),B=document.getElementById("dbg-line-domain-min"),_=document.getElementById("dbg-line-domain-max"),j=document.getElementById("dbg-line-static"),P=document.getElementById("dbg-line-static-label"),z=document.getElementById("dbg-line-width-slider"),O=document.getElementById("dbg-line-width"),D=document.getElementById("dbg-lng"),R=document.getElementById("dbg-lat"),q=document.getElementById("dbg-zoom"),V=document.getElementById("dbg-pitch"),H=document.getElementById("dbg-bearing"),W=document.getElementById("dbg-view-output"),Z=document.getElementById("dbg-output"),U=t.initialViewState,G=Object.keys(window.cartocolor||{}).sort((e,t)=>e.localeCompare(t)),Y=e=>{e.innerHTML=G.map(e=>`<option value="${e}">${e}</option>`).join("")};Y(f),Y(T);const J=t.layers.filter(e=>"hex"===e.layerType);a.innerHTML=J.map(e=>`<option value="${e.id}">${e.name||e.id}</option>`).join(""),!a.value&&J.length&&(a.value=J[0].id);const X=()=>{const e=a.value;return J.find(t=>t.id===e)||null},K=()=>{try{const n=(e._controls||[]).find(e=>e&&e.__fused_hex_tiles__);t.__deckOverlay=n||t.__deckOverlay}catch(e){}};K();const Q=()=>{try{Z.value=JSON.stringify(X(),null,2)}catch(e){Z.value=""}},ee=()=>{const e=p.value;y.style.display="colorContinuous"===e?"block":"none",g.style.display="static"===e?"block":"none"},te=()=>{const e=M.value;k.style.display="colorContinuous"===e?"block":"none",N.style.display="static"===e?"block":"none"},ne=()=>{const e=X();if(!e)return;const t=e.hexLayer||{};r.checked=!1!==t.filled,s.checked=!1!==t.stroked,c.checked=!0===t.extruded;const n="number"==typeof t.opacity?t.opacity:1;d.value=String(n),u.value=String(n);const i=t.getFillColor,o=$(i);if(o){p.value="colorContinuous",m.innerHTML=S(e).map(e=>`<option value="${e}">${e}</option>`).join(""),o.attr&&(m.value=String(o.attr)),o.colors&&(f.value=String(o.colors));const t=Array.isArray(o.domain)?o.domain:[0,1];b.value=E(Number(t[0]),2),h.value=E(Number(t[1]),2),v.value=String(o.steps??7);const n=`#${(Array.isArray(o.nullColor)?o.nullColor:[184,184,184]).slice(0,3).map(e=>F(Number(e),0,255).toString(16).padStart(2,"0")).join("")}`;x.value=n,w.textContent=n}else if(Array.isArray(i)){p.value="static";const e=`#${i.slice(0,3).map(e=>F(Number(e),0,255).toString(16).padStart(2,"0")).join("")}`;C.value=e,L.textContent=e}else p.value="colorContinuous";const l=t.getLineColor,a=$(l);if(a){M.value="colorContinuous",A.innerHTML=S(e).map(e=>`<option value="${e}">${e}</option>`).join(""),a.attr&&(A.value=String(a.attr)),a.colors&&(T.value=String(a.colors));const t=Array.isArray(a.domain)?a.domain:[0,1];B.value=E(Number(t[0]),2),_.value=E(Number(t[1]),2)}else if(Array.isArray(l)){M.value="static";const e=`#${l.slice(0,3).map(e=>F(Number(e),0,255).toString(16).padStart(2,"0")).join("")}`;j.value=e,P.textContent=e}else M.value="static";const y=t.lineWidthMinPixels??1;z.value=String(y),O.value=String(y),ee(),te(),Q()},ie=()=>{const e=X();if(!e)return;e.hexLayer=e.hexLayer||{};const n=e.hexLayer;n.filled=!!r.checked,n.stroked=!!s.checked,n.extruded=!!c.checked;const i=parseFloat(u.value);if(Number.isFinite(i)&&(n.opacity=F(i,0,1)),"static"===p.value){const e=C.value||"#0090ff",t=parseInt(e.slice(1,3),16),i=parseInt(e.slice(3,5),16),o=parseInt(e.slice(5,7),16);n.getFillColor=[t,i,o]}else{const e=m.value||"data_avg",t=f.value||"Earth",i=parseFloat(b.value),o=parseFloat(h.value),l=parseInt(v.value||"7",10),a=x.value||"#b8b8b8",r=parseInt(a.slice(1,3),16),s=parseInt(a.slice(3,5),16),c=parseInt(a.slice(5,7),16);n.getFillColor={"@@function":"colorContinuous",attr:e,domain:[Number.isFinite(i)?i:0,Number.isFinite(o)?o:1],colors:t,steps:Number.isFinite(l)?l:7,nullColor:[r,s,c],autoDomain:!0}}if("static"===M.value){const e=j.value||"#ffffff",t=parseInt(e.slice(1,3),16),i=parseInt(e.slice(3,5),16),o=parseInt(e.slice(5,7),16);n.getLineColor=[t,i,o]}else{const e=A.value||"data_avg",t=T.value||"Earth",i=parseFloat(B.value),o=parseFloat(_.value);n.getLineColor={"@@function":"colorContinuous",attr:e,domain:[Number.isFinite(i)?i:0,Number.isFinite(o)?o:1],colors:t,steps:parseInt(v.value||"7",10)||7,autoDomain:!0}}const o=parseFloat(O.value);Number.isFinite(o)&&(n.lineWidthMinPixels=F(o,0,10)),Q(),K(),(()=>{try{const e=t.__deckOverlay||null,n=e?.__fused_hex_tiles__;n?.rebuild?.()}catch(e){}try{window.dispatchEvent(new CustomEvent("fusedmaps:legend:update"))}catch(e){}})()},oe=()=>{try{const t=function(e){const t=e.getCenter();return{longitude:t.lng,latitude:t.lat,zoom:e.getZoom(),pitch:e.getPitch(),bearing:e.getBearing()}}(e);if(W.value=JSON.stringify(t,null,2),n&&function(){const e=document.activeElement;return!(!e||!e.closest?.("#debug-panel")||"INPUT"!==e.tagName&&"TEXTAREA"!==e.tagName&&"SELECT"!==e.tagName)}())return;D.value=E(t.longitude,5),R.value=E(t.latitude,5),q.value=E(t.zoom,2),V.value=E(t.pitch??0,1),H.value=E(t.bearing??0,1)}catch(e){}},le=()=>{const e=i.classList.toggle("collapsed");o.innerHTML=e?"&#x203A;":"&#x2039;",I(n,i,o)},ae=t=>{try{t.preventDefault(),t.stopPropagation()}catch(e){}(()=>{const t=parseFloat(D.value),n=parseFloat(R.value),i=parseFloat(q.value),o=parseFloat(V.value),l=parseFloat(H.value);try{e.jumpTo({center:[Number.isFinite(t)?t:U.longitude,Number.isFinite(n)?n:U.latitude],zoom:Number.isFinite(i)?i:e.getZoom(),pitch:Number.isFinite(o)?o:e.getPitch(),bearing:Number.isFinite(l)?l:e.getBearing()})}catch(e){}})()},re=async e=>{try{e.preventDefault(),e.stopPropagation()}catch(e){}await(async()=>{try{await navigator.clipboard.writeText(W.value||"")}catch(e){}})()};let se=!1,ce=0,de=280;const ue=e=>{if(!se)return;const t=e.clientX-ce,l=F(de+t,240,520);i.style.width=`${l}px`,I(n,i,o),e.preventDefault()},pe=e=>{se&&(se=!1,window.removeEventListener("pointermove",ue),window.removeEventListener("pointerup",pe))},ye=e=>{se=!0,ce=e.clientX,de=i.getBoundingClientRect().width||280,window.addEventListener("pointermove",ue,{passive:!1}),window.addEventListener("pointerup",pe),e.preventDefault(),e.stopPropagation()};o.addEventListener("click",le),document.getElementById("dbg-apply").addEventListener("click",ae),document.getElementById("dbg-copy").addEventListener("click",re),l.addEventListener("pointerdown",ye,{passive:!1}),a.addEventListener("change",()=>ne()),p.addEventListener("change",()=>{ee(),ie()}),M.addEventListener("change",()=>{te(),ie()}),[r,s,c].forEach(e=>e.addEventListener("change",ie)),d.addEventListener("input",()=>{u.value=d.value,ie()}),u.addEventListener("change",()=>{d.value=u.value,ie()}),[m,f,b,h,v].forEach(e=>e.addEventListener("change",ie)),x.addEventListener("input",()=>{w.textContent=x.value,ie()}),C.addEventListener("input",()=>{L.textContent=C.value,ie()}),[A,T,B,_].forEach(e=>e.addEventListener("change",ie)),j.addEventListener("input",()=>{P.textContent=j.value,ie()}),z.addEventListener("input",()=>{O.value=z.value,ie()}),O.addEventListener("change",()=>{z.value=O.value,ie()});try{e.on("moveend",oe),e.on("rotateend",oe),e.on("pitchend",oe)}catch(e){}return ee(),te(),ne(),oe(),I(n,i,o),window.addEventListener("resize",()=>I(n,i,o)),{destroy:()=>{try{o.removeEventListener("click",le)}catch(e){}try{document.getElementById("dbg-apply").removeEventListener("click",ae),document.getElementById("dbg-copy").removeEventListener("click",re)}catch(e){}try{l.removeEventListener("pointerdown",ye)}catch(e){}try{e.off("moveend",oe),e.off("rotateend",oe),e.off("pitchend",oe)}catch(e){}try{n?.remove()}catch(e){}}}}(n,e):null;let l=null,a=null;return!1!==e.ui?.layerPanel&&function(t,i){v=(t,i)=>{P(t,i,n,e,l)};let o=document.getElementById("layer-panel");o||(o=document.createElement("div"),o.id="layer-panel",o.innerHTML='<div id="layer-list"></div>',document.body.appendChild(o)),window.toggleLayerVisibility=(e,t)=>{v&&v(e,t)},window.onLayerItemClick=(e,t)=>{try{if(e&&e.target.closest?.(".layer-eye"))return}catch(e){}const n=!1!==i[t];v&&v(t,!n)},x(t,i)}(e.layers,_),!1!==e.ui?.legend&&function(e,t){let n=document.getElementById("color-legend");n||(n=document.createElement("div"),n.id="color-legend",n.className="color-legend",n.style.display="none",document.body.appendChild(n)),w(e,t)}(e.layers,_),n.on("load",()=>{const t=h(n,e.layers,_);l=t.deckOverlay,x(e.layers,_),w(e.layers,_),a=()=>{w(e.layers,_)};try{window.addEventListener("fusedmaps:legend:update",a)}catch(e){}!1!==e.ui?.tooltip&&function(e,t,n,i){let o=document.getElementById("tooltip");o||(o=document.createElement("div"),o.id="tooltip",document.body.appendChild(o));const l=[];t.forEach(e=>{if(e.isTileLayer)return;const t=[];"hex"===e.layerType?((e.hexLayer||{}).extruded?t.push(`${e.id}-extrusion`):t.push(`${e.id}-fill`),t.push(`${e.id}-outline`)):"vector"===e.layerType?t.push(`${e.id}-fill`,`${e.id}-outline`,`${e.id}-circle`,`${e.id}-line`):"mvt"===e.layerType&&t.push(`${e.id}-fill`,`${e.id}-line`,`${e.id}-extrusion`),t.forEach(t=>{l.push({layerId:t,layerDef:e})})}),e.on("mousemove",a=>{const r=l.map(e=>e.layerId).filter(t=>e.getLayer(t)),s=e=>{const n=t.findIndex(t=>t.id===e);return-1===n?Number.POSITIVE_INFINITY:n};let c=null,d=Number.POSITIVE_INFINITY;if(r.length){const t=e.queryRenderedFeatures(a.point,{layers:r});for(const e of t||[]){const t=l.find(t=>t.layerId===e.layer?.id);if(!t)continue;if(!1===n[t.layerDef.id])continue;const i=s(t.layerDef.id);i<d&&(d=i,c={type:"mapbox",layerDef:t.layerDef,props:e.properties||{}});break}}if(i){const e=i.__fused_hex_tiles__,o=e?.pickObject||i?.pickObject;try{const e=o?.({x:a.point.x,y:a.point.y,radius:4});if(e?.object){const i=String(e.layer?.id||""),o=i.includes("-tiles")?i.split("-tiles")[0]:i,l=t.find(e=>e.id===o);if(l&&!1!==n[l.id]){const t=s(l.id);t<d&&(d=t,c={type:"deck",layerDef:l,props:e.object.properties||e.object||{}})}}}catch(e){}}if(!c)return o.style.display="none",void(e.getCanvas().style.cursor="");e.getCanvas().style.cursor="pointer";const u=function(e){if("hex"===e.layerType){const t=e;return t.hexLayer?.tooltipColumns||t.hexLayer?.tooltipAttrs||t.tooltipColumns||[]}if("vector"===e.layerType){const t=e;return t.vectorLayer?.tooltipColumns||t.vectorLayer?.tooltipAttrs||t.tooltipColumns||[]}return e.tooltipColumns||[]}(c.layerDef),p=function(e,t){const n=[];return null!=e.hex&&n.push(`<span class="tt-row"><span class="tt-key">hex</span><span class="tt-val">${String(e.hex).slice(0,12)}...</span></span>`),t.length?(t.forEach(t=>{if("hex"===t)return;const i=e[t];if(null==i)return;const o="number"==typeof i?Number(i).toFixed(2):String(i);n.push(`<span class="tt-row"><span class="tt-key">${t}</span><span class="tt-val">${o}</span></span>`)}),n):(0===n.length&&Object.keys(e).slice(0,5).forEach(t=>{n.push(`<span class="tt-row"><span class="tt-key">${t}</span><span class="tt-val">${e[t]}</span></span>`)}),n)}(c.props,u);p.length?(o.innerHTML=`<strong class="tt-title">${c.layerDef.name}</strong>`+p.join(""),o.style.left=`${a.point.x+10}px`,o.style.top=`${a.point.y+10}px`,o.style.display="block"):o.style.display="none"}),e.on("mouseleave",()=>{e.getCanvas().style.cursor="",o.style.display="none"})}(n,e.layers,_,l),!1!==e.highlightOnClick&&function(e,t,n,i){e.on("click",n=>{const o=function(e,t){const n=[];return t.forEach(t=>{if(t.isTileLayer)return;const i=t.layerType;let o=[];if("vector"===i)o=[`${t.id}-fill`,`${t.id}-circle`,`${t.id}-line`];else if("hex"===i){const e=t;o=[e.hexLayer?.extruded?`${t.id}-extrusion`:`${t.id}-fill`]}o.forEach(t=>{try{e.getLayer(t)&&n.push(t)}catch(e){}})}),["gdf-fill","gdf-circle","hex-fill"].forEach(t=>{try{e.getLayer(t)&&n.push(t)}catch(e){}}),n}(e,t);if(!o.length)return;let l=[];try{l=e.queryRenderedFeatures(n.point,{layers:o})||[]}catch(e){}if(l.length>0)N(e,l[0]);else if(i){const t=i?.pickObject?.({x:n.point.x,y:n.point.y,radius:4});t?.object?N(e,{properties:t.object.properties||t.object,geometry:null}):k&&N(e,null)}else k&&N(e,null)})}(n,e.layers,0,l),e.messaging&&B(n,e.messaging,e.layers),e.hasCustomView||function(e,t){const n=new mapboxgl.LngLatBounds,i=b;t.forEach(e=>{if(e.isTileLayer)return;const t=i[e.id];t?.features?.length&&t.features.forEach(e=>{"Point"===e.geometry?.type?n.extend(e.geometry.coordinates):"Polygon"===e.geometry?.type||"MultiPolygon"===e.geometry?.type?("Polygon"===e.geometry.type?[e.geometry.coordinates]:e.geometry.coordinates).forEach(e=>e[0]?.forEach(e=>n.extend(e))):"LineString"===e.geometry?.type&&e.geometry.coordinates.forEach(e=>n.extend(e))})}),n.isEmpty()||e.fitBounds(n,{padding:50,maxZoom:15,duration:500})}(n,e.layers)}),n.on("load",()=>{[100,500,1e3].forEach(e=>setTimeout(()=>n.resize(),e))}),window.addEventListener("resize",()=>n.resize()),document.addEventListener("visibilitychange",()=>{document.hidden||setTimeout(()=>n.resize(),100)}),{map:n,deckOverlay:l,setLayerVisibility:(t,i)=>{P(t,i,n,e,l)},updateLegend:()=>{w(e.layers,_)},destroy:()=>{try{l?.__fused_hex_tiles__?.destroy?.()}catch(e){}try{i?.destroy?.()}catch(e){}try{o?.destroy?.()}catch(e){}try{a&&window.removeEventListener("fusedmaps:legend:update",a)}catch(e){}n.remove?.()}}}function P(e,t,n,i,o){_[e]=t,function(e,t,n,i,o){const l=i.find(e=>e.id===t);if(l)switch(l.layerType){case"hex":{const i=l;if(i.isTileLayer){const e=o?.__fused_hex_tiles__;try{e?.rebuild?.()}catch(e){}}else!function(e,t,n,i){(i?[`${t}-extrusion`,`${t}-outline`]:[`${t}-fill`,`${t}-outline`]).forEach(t=>{try{e.getLayer(t)&&e.setLayoutProperty(t,"visibility",n?"visible":"none")}catch(e){}})}(e,t,n,!0===i.hexLayer?.extruded);break}case"vector":case"mvt":!function(e,t,n){[`${t}-fill`,`${t}-outline`,`${t}-line`,`${t}-circle`,`${t}-extrusion`].forEach(t=>{try{e.getLayer(t)&&e.setLayoutProperty(t,"visibility",n?"visible":"none")}catch(e){}})}(e,t,n);break;case"raster":!function(e,t,n){const i=`${t}-raster`;try{e.getLayer(i)&&e.setLayoutProperty(i,"visibility",n?"visible":"none")}catch(e){}}(e,t,n)}}(n,e,t,i.layers,o),x(i.layers,_),w(i.layers,_)}"undefined"!=typeof window&&(window.FusedMaps={init:j});var z={init:j};export{z as default,j as init};
//# sourceMappingURL=fusedmaps.esm.js.map
