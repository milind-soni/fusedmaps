function e(e,t){void 0!==t.longitude&&void 0!==t.latitude&&e.setCenter([t.longitude,t.latitude]),void 0!==t.zoom&&e.setZoom(t.zoom),void 0!==t.pitch&&e.setPitch(t.pitch),void 0!==t.bearing&&e.setBearing(t.bearing)}function t(e){const t=e.getCenter();return{longitude:t.lng,latitude:t.lat,zoom:e.getZoom(),pitch:e.getPitch(),bearing:e.getBearing()}}function n(e,t){const n=window.cartocolor;if(!n)return null;const i=n[e];if(!i)return null;const o=Object.keys(i).map(Number).filter(e=>!isNaN(e)).sort((e,t)=>e-t),r=o.find(e=>e>=t)||o[o.length-1];return i[r]?[...i[r]]:null}function i(e,t){if(!Array.isArray(e)||e.length<3)return null;const[n,i,o]=e;return`rgba(${n},${i},${o},${e.length>=4?e[3]/255:t??1})`}const o=["#e0f3db","#ccebc5","#a8ddb5","#7bccc4","#4eb3d3","#2b8cbe","#0868ac","#084081"],r=["#7F3C8D","#11A579","#3969AC","#F2B701","#E73F74","#80BA5A","#E68310","#008695","#CF1C90","#f97b72"];function l(e,t,n){const i=new Map;return(e||[]).forEach(e=>{const o=e?.[t]??e?.properties?.[t];if(null!=o&&""!==o&&"null"!==o&&!i.has(o)){const t=n?e?.[n]??e?.properties?.[n]??o:o;i.set(o,String(t))}}),[...i.entries()].sort((e,t)=>"number"==typeof e[0]&&"number"==typeof t[0]?e[0]-t[0]:String(e[0]).localeCompare(String(t[0]))).map(([e,t])=>({value:e,label:t}))}function a(e,t){if(!e)return null;if(Array.isArray(e))return null;if("string"==typeof e)return e;const i=e["@@function"],o=e.attr;return i&&o?"colorCategories"===i?function(e,t){const i=Array.isArray(e.domain)?e.domain:[];let o=e.categories?e.categories.map(e=>"object"==typeof e?e:{value:e,label:String(e)}):i.length?i.map(e=>({value:e,label:String(e?.label??e)})):l(t,e.attr,e.labelAttr);if(!o.length)return"rgba(128,128,128,0.5)";let a=n(e.colors||"Bold",Math.max(o.length,3));a&&a.length||(a=r);const s=e.nullColor?`rgb(${e.nullColor.slice(0,3).join(",")})`:"rgba(128,128,128,0.5)",c=["match",["get",e.attr]];return o.forEach((e,t)=>{c.push(e.value),c.push(a[t%a.length])}),c.push(s),e._detectedCategories=o,c}(e,t):"colorContinuous"===i?function(e){if(!e.domain?.length)return null;const[t,i]=e.domain,o=t>i;let r=o?[i,t]:[t,i];if(r[0]===r[1]){const e=r[0],t=Math.abs(e)>0?.1*Math.abs(e):1;r=[e-t,e+t]}const l=!!e.reverse,a=e.steps||7,s=e.colors||"TealGrn",c=e.nullColor?`rgb(${e.nullColor.slice(0,3).join(",")})`:"rgb(184,184,184)";let d=n(s,a);if(!d||!d.length)return["case",["==",["get",e.attr],null],c,["interpolate",["linear"],["get",e.attr],r[0],"rgb(237,248,251)",r[1],"rgb(0,109,44)"]];(o?!l:l)&&(d=[...d].reverse());const u=["interpolate",["linear"],["get",e.attr]];return d.forEach((e,t)=>{const n=r[0]+(r[1]-r[0])*t/(d.length-1);u.push(n),u.push(e)}),["case",["==",["get",e.attr],null],c,u]}(e):null:null}function s(e){if(null==e)return null;try{if("string"==typeof e){const t=e.startsWith("0x")?e.slice(2):e;return/^\d+$/.test(t)?BigInt(t).toString(16):(/[a-f]/i.test(t),t.toLowerCase())}if("number"==typeof e)return BigInt(Math.trunc(e)).toString(16);if("bigint"==typeof e)return e.toString(16)}catch(e){}return null}function c(e){const t=[];for(const n of e){const e=s(n.hex??n.h3??n.index??n.id);if(e&&window.h3?.isValidCell(e))try{const i=window.h3.cellToBoundary(e).map(([e,t])=>[t,e]);i.push(i[0]),t.push({type:"Feature",properties:{...n,hex:e},geometry:{type:"Polygon",coordinates:[i]}})}catch(e){}}return{type:"FeatureCollection",features:t}}function d(e,t,n,o){const r=t.hexLayer||{},l=t.data||[];try{const i=e.getSource(t.id);i&&"function"==typeof i.setData?i.setData(n):i||e.addSource(t.id,{type:"geojson",data:n})}catch(e){}const s=Array.isArray(r.getFillColor)?i(r.getFillColor,.8):a(r.getFillColor,l)||"rgba(0,144,255,0.7)",c=r.getLineColor?Array.isArray(r.getLineColor)?i(r.getLineColor,1):a(r.getLineColor,l):"rgba(255,255,255,0.3)",d="number"==typeof r.opacity&&isFinite(r.opacity)?Math.max(0,Math.min(1,r.opacity)):.8;if(r.extruded){const n=r.elevationScale||1,i=r.elevationProperty||r.getFillColor?.attr||null;e.addLayer({id:`${t.id}-extrusion`,type:"fill-extrusion",source:t.id,paint:{"fill-extrusion-color":s,"fill-extrusion-height":i?["*",["to-number",["get",i],0],n]:100,"fill-extrusion-base":0,"fill-extrusion-opacity":d},layout:{visibility:o?"visible":"none"}})}else!1!==r.filled&&e.addLayer({id:`${t.id}-fill`,type:"fill",source:t.id,paint:{"fill-color":s,"fill-opacity":d},layout:{visibility:o?"visible":"none"}});!1!==r.stroked&&e.addLayer({id:`${t.id}-outline`,type:"line",source:t.id,paint:{"line-color":c,"line-width":r.lineWidthMinPixels||.5},layout:{visibility:o?"visible":"none"}})}function u(e,t,n,i){(i?[`${t}-extrusion`,`${t}-outline`]:[`${t}-fill`,`${t}-outline`]).forEach(t=>{try{e.getLayer(t)&&e.setLayoutProperty(t,"visibility",n?"visible":"none")}catch(e){}})}function p(e,t,n){return Math.max(t,Math.min(n,e))}function f(e,t){try{const n=String(e||"").trim();if(!/^#[0-9a-fA-F]{6}$/.test(n))return null;const i=parseInt(n.slice(1,3),16),o=parseInt(n.slice(3,5),16),r=parseInt(n.slice(5,7),16);return"number"==typeof t&&Number.isFinite(t)?[i,o,r,p(Math.round(t),0,255)]:[i,o,r]}catch{return null}}function y(e){return!Array.isArray(e)||e.length<3?"#888888":"#"+e.slice(0,3).map(e=>p(Math.round(e),0,255).toString(16).padStart(2,"0")).join("")}function g(e,t){try{return Number.isFinite(e)?e.toFixed(t):""}catch{return""}}const m="-fill",h="-extrusion",b="-outline",v="-fill",x="-outline",C="-circle",L="-line",w="-fill",E="-line",S="-extrusion",F="-raster",A="-fill",$="-line",k="-circles";function T(e){return e.isTileLayer||"raster"===e.layerType?[]:function(e){const{includeAll:t=!1}={},n=[];switch(e.layerType){case"hex":{const i=e;if(i.isTileLayer)return n;const o=!0===i.hexLayer?.extruded;t?(n.push(`${e.id}${m}`),n.push(`${e.id}${h}`),n.push(`${e.id}${b}`)):(o?n.push(`${e.id}${h}`):n.push(`${e.id}${m}`),n.push(`${e.id}${b}`));break}case"vector":n.push(`${e.id}${v}`),n.push(`${e.id}${x}`),n.push(`${e.id}${C}`),n.push(`${e.id}${L}`);break;case"mvt":n.push(`${e.id}${w}`),n.push(`${e.id}${E}`),n.push(`${e.id}${S}`);break;case"raster":n.push(`${e.id}${F}`);break;case"pmtiles":n.push(`${e.id}${A}`),n.push(`${e.id}${$}`),n.push(`${e.id}${k}`)}return n}(e)}function M(e){if(e.isTileLayer)return null;switch(e.layerType){case"vector":{const t=e,n=t.geojson;if(n?.features?.length){for(const i of n.features){const n=i.geometry?.type;if("Polygon"===n||"MultiPolygon"===n)return!1!==t.isFilled?`${e.id}${v}`:`${e.id}${x}`}for(const t of n.features){const n=t.geometry?.type;if("LineString"===n||"MultiLineString"===n)return`${e.id}${L}`}for(const t of n.features){const n=t.geometry?.type;if("Point"===n||"MultiPoint"===n)return`${e.id}${C}`}}return`${e.id}${v}`}case"hex":{const t=e;return!0===t.hexLayer?.extruded?`${e.id}${h}`:`${e.id}${m}`}case"mvt":return`${e.id}${w}`;case"raster":return`${e.id}${F}`;case"pmtiles":return`${e.id}${A}`;default:return null}}const N="rgba(255,255,0,0.3)",O="rgba(255,255,0,1)",_=["id","ID","Id","fid","FID","OBJECTID","objectid","name","Name","NAME","Field Name","field_name","Farm Name","farm_name","Farm","farm","GEOID","geoid","GeoID","geo_id","FIPS","fips","STATEFP","COUNTYFP","tile_id","tileId","feature_id","featureId","index","hex","h3","h3_index","cell_id","h3_cell"];let P=!1,I=null,j=_;const R=new Map,q=["id","ID","Id","fid","FID","OBJECTID","objectid","index","Field Name","field_name","name","Name","NAME","GEOID","geoid","GeoID","geo_id","FIPS","fips","tile_id","tileId","feature_id","featureId","hex","h3","h3_index","cell_id","h3_cell","Farm Name","farm_name","Farm","farm","STATEFP","COUNTYFP"];function D(e,t){const n=R.get(e);if(!n?.features)return null;let i=null,o=0,r=1/0;for(const e of n.features){const n=e.properties||{};let l=0,a=1/0;for(let e=0;e<q.length;e++){const i=q[e];void 0!==t[i]&&void 0!==n[i]&&String(t[i])===String(n[i])&&(l++,e<a&&(a=e))}for(const e of j)q.includes(e)||void 0!==t[e]&&void 0!==n[e]&&String(t[e])===String(n[e])&&l++;(l>o||l===o&&a<r)&&(o=l,r=a,i=e)}if(i){const e=i.properties?.["Field Name"]||i.properties?.field_name||i.properties?.name||"unknown",n=t["Field Name"]||t.field_name||t.name||"unknown";return console.log("[Highlight] findOriginalFeature: searched for",n,"-> matched",e,"(score:",o,"priority:",r,")"),i}for(const e of n.features){const n=e.properties||{};let i=!0,o=!1;for(const[e,r]of Object.entries(t))if(void 0!==n[e]&&(o=!0,String(n[e])!==String(r))){i=!1;break}if(i&&o)return e}return null}function B(e,t){const n=[];return t.forEach(t=>{T(t).forEach(t=>{try{e.getLayer(t)&&n.push(t)}catch(e){}})}),["gdf-fill","gdf-circle","hex-fill"].forEach(t=>{try{e.getLayer(t)&&n.push(t)}catch(e){}}),n}function z(e,t){console.log("[Highlight] highlightFeature called with:",t?{layer:t.layer?.id,source:t.source,hasGeometry:!!t.geometry,props:t.properties}:"null (clearing)");let n={type:"FeatureCollection",features:[]};if(t){const e=t.properties||{},i=e.hex||e.h3;if(i&&window.h3)try{const t=s(i);if(t&&window.h3.isValidCell(t)){const i=window.h3.cellToBoundary(t).map(([e,t])=>[t,e]);i.push(i[0]),n.features.push({type:"Feature",geometry:{type:"Polygon",coordinates:[i]},properties:e})}}catch(e){}else if(t.source&&R.has(t.source)){console.log("[Highlight] Looking up original geometry for source:",t.source);const i=D(t.source,e);i?.geometry?(console.log("[Highlight] Found original geometry"),n.features.push({type:"Feature",geometry:i.geometry,properties:e})):t.geometry&&(console.log("[Highlight] Original not found, using clipped geometry"),n.features.push({type:"Feature",geometry:t.geometry,properties:e}))}else t.geometry&&n.features.push({type:"Feature",geometry:t.geometry,properties:e})}P?e.getSource("feature-hl").setData(n):(e.addSource("feature-hl",{type:"geojson",data:n}),e.addLayer({id:"feature-hl-fill",type:"fill",source:"feature-hl",paint:{"fill-color":N,"fill-opacity":1}}),e.addLayer({id:"feature-hl-line",type:"line",source:"feature-hl",paint:{"line-color":O,"line-width":3}}),P=!0),console.log("[Highlight] Set highlight data with",n.features.length,"features"),I=t}function U(e){const t=[],n=new Set;for(const[i,o]of R.entries())if(o?.features)for(const i of o.features){const o=i.properties||{};for(const r of j)if(void 0!==e[r]&&void 0!==o[r]&&String(e[r])===String(o[r])){const e=o.id||o["Field Name"]||o.name||JSON.stringify("Polygon"===i.geometry?.type?i.geometry.coordinates?.[0]?.[0]:Math.random());n.has(String(e))||(n.add(String(e)),t.push(i));break}}return t}function W(e,t){const n={type:"FeatureCollection",features:[]};for(const e of t)e?.geometry&&n.features.push({type:"Feature",geometry:e.geometry,properties:e.properties||{}});P?e.getSource("feature-hl").setData(n):(e.addSource("feature-hl",{type:"geojson",data:n}),e.addLayer({id:"feature-hl-fill",type:"fill",source:"feature-hl",paint:{"fill-color":N,"fill-opacity":1}}),e.addLayer({id:"feature-hl-line",type:"line",source:"feature-hl",paint:{"line-color":O,"line-width":3}}),P=!0),I=t.length>0?t[0]:null}function H(e,t,n){const i=t.geojson;if(!i?.features?.length)return;const o={type:"geojson",data:i},r=t.geojsonSource;r&&"object"==typeof r&&("number"==typeof r.tolerance&&(o.tolerance=r.tolerance),"number"==typeof r.buffer&&(o.buffer=r.buffer),"number"==typeof r.maxzoom&&(o.maxzoom=r.maxzoom)),e.addSource(t.id,o),function(e,t){console.log("[Highlight] Registering original GeoJSON for source:",e,"with",t?.features?.length,"features"),R.set(e,t)}(t.id,i);const l=i.features.map(e=>e.properties||{}),s=t.fillColorConfig?.["@@function"]?a(t.fillColorConfig,l):t.fillColorRgba||"rgba(0,144,255,0.6)",c=t.lineColorConfig?.["@@function"]?a(t.lineColorConfig,l):t.lineColorRgba||"rgba(100,100,100,0.8)",d="number"==typeof t.lineWidth&&isFinite(t.lineWidth)?t.lineWidth:1,u="number"==typeof t.opacity&&isFinite(t.opacity)?Math.max(0,Math.min(1,t.opacity)):.8;let p=!1,f=!1,y=!1;for(const e of i.features){const t=e.geometry?.type;"Point"!==t&&"MultiPoint"!==t||(f=!0),"Polygon"!==t&&"MultiPolygon"!==t||(p=!0),"LineString"!==t&&"MultiLineString"!==t||(y=!0)}if(p){const i=!1===t.isFilled?0:u;e.addLayer({id:`${t.id}-fill`,type:"fill",source:t.id,paint:{"fill-color":s,"fill-opacity":i},filter:["any",["==",["geometry-type"],"Polygon"],["==",["geometry-type"],"MultiPolygon"]],layout:{visibility:n?"visible":"none"}}),!1!==t.isStroked&&e.addLayer({id:`${t.id}-outline`,type:"line",source:t.id,layout:{"line-join":"round","line-cap":"round",visibility:n?"visible":"none"},paint:{"line-color":c,"line-width":d},filter:["any",["==",["geometry-type"],"Polygon"],["==",["geometry-type"],"MultiPolygon"]]})}y&&e.addLayer({id:`${t.id}-line`,type:"line",source:t.id,layout:{"line-join":"round","line-cap":"round",visibility:n?"visible":"none"},paint:{"line-color":c,"line-width":d,"line-opacity":1},filter:["any",["==",["geometry-type"],"LineString"],["==",["geometry-type"],"MultiLineString"]]}),f&&e.addLayer({id:`${t.id}-circle`,type:"circle",source:t.id,paint:{"circle-radius":t.pointRadius||6,"circle-color":s,"circle-stroke-color":"rgba(0,0,0,0.5)","circle-stroke-width":1,"circle-opacity":.9},filter:["any",["==",["geometry-type"],"Point"],["==",["geometry-type"],"MultiPoint"]],layout:{visibility:n?"visible":"none"}})}function V(e,t,n){const i=t.sourceLayer||"udf";e.addSource(t.id,{type:"vector",tiles:[t.tileUrl],minzoom:t.minzoom||0,maxzoom:t.maxzoom||22});const o=t.fillColorConfig?.["@@function"]?a(t.fillColorConfig,void 0):t.fillColor||"#FFF5CC",r=t.lineColorConfig?.["@@function"]?a(t.lineColorConfig,void 0):t.lineColor||"#FFFFFF",l=t.fillOpacity??.8,s=t.lineWidth??1;!1!==t.isFilled&&e.addLayer({id:`${t.id}-fill`,type:"fill",source:t.id,"source-layer":i,paint:{"fill-color":o,"fill-opacity":l},layout:{visibility:n?"visible":"none"}}),e.addLayer({id:`${t.id}-line`,type:"line",source:t.id,"source-layer":i,paint:{"line-color":r,"line-width":s},layout:{visibility:n?"visible":"none"}}),t.isExtruded&&e.addLayer({id:`${t.id}-extrusion`,type:"fill-extrusion",source:t.id,"source-layer":i,paint:{"fill-extrusion-color":o,"fill-extrusion-height":["*",["get",t.heightProperty||"height"],t.heightMultiplier||1],"fill-extrusion-base":0,"fill-extrusion-opacity":t.extrusionOpacity??.9},layout:{visibility:n?"visible":"none"}})}function Z(e,t,n){[`${t}-fill`,`${t}-outline`,`${t}-line`,`${t}-circle`,`${t}-extrusion`].forEach(t=>{try{e.getLayer(t)&&e.setLayoutProperty(t,"visibility",n?"visible":"none")}catch(e){}})}function G(e){return Math.max(0,Math.min(1,e))}function J(e,t,n){const i=t.opacity??t.rasterLayer?.opacity??1,o="string"==typeof t.tileUrl&&t.tileUrl.length>0,r="string"==typeof t.imageUrl&&t.imageUrl.length>0&&Array.isArray(t.imageBounds)&&4===t.imageBounds.length;if(o||r)if(r){const o=function(e){const[t,n,i,o]=e;return[[t,o],[i,o],[i,n],[t,n]]}(t.imageBounds),r=t.id,l=`${t.id}-raster`;(async function(e,t=3,n=500){let i=null;for(let o=0;o<t;o++)try{const t=await fetch(e);if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);const n=await t.blob();return new Promise((e,t)=>{const i=new FileReader;i.onloadend=()=>e(i.result),i.onerror=()=>t(new Error("Failed to read blob")),i.readAsDataURL(n)})}catch(e){i=e,o<t-1&&await new Promise(e=>setTimeout(e,n*Math.pow(2,o)))}throw i||new Error("Failed to fetch image")})(t.imageUrl).then(t=>{e.getSource(r)||(e.addSource(r,{type:"image",url:t,coordinates:o}),e.addLayer({id:l,type:"raster",source:r,paint:{"raster-opacity":G(i)},layout:{visibility:n?"visible":"none"}}))}).catch(e=>{console.warn(`[FusedMaps] Failed to load raster image after retries: ${t.imageUrl}`,e)})}else e.addSource(t.id,{type:"raster",tiles:[t.tileUrl],tileSize:256}),e.addLayer({id:`${t.id}-raster`,type:"raster",source:t.id,paint:{"raster-opacity":G(i)},layout:{visibility:n?"visible":"none"}})}function Y(e,t,n){const i=`${t}-raster`;try{e.getLayer(i)&&e.setLayoutProperty(i,"visibility",n?"visible":"none")}catch(e){}}let Q=null,X=null,K=null,ee=0;function te(e){Q||(Q=document.getElementById("tile-loader"),Q||(Q=document.createElement("div"),Q.id="tile-loader",Q.innerHTML='<div class="loader-spinner"></div><span id="loader-text">Loading tiles...</span>',document.body.appendChild(Q)),X=document.getElementById("loader-text")),ee=Math.max(0,ee+e),Q&&(ee>0?(K&&(clearTimeout(K),K=null),Q.classList.add("active"),X&&(X.textContent=1===ee?"Loading tile...":`Loading ${ee} tiles...`)):K=setTimeout(()=>{Q?.classList.remove("active")},300))}function ne(e){for(const t of e)t.state=0;const t=Array.from(e).sort((e,t)=>t.zoom-e.zoom);for(const e of t)e.isSelected&&ie(e);for(const e of t)e.isSelected&&(e.isLoaded||e.content)&&oe(e);const n=Array.from(t).reverse();for(const e of n)if(e.isVisible=Boolean(2&e.state),e.children&&(e.isVisible||1&e.state))for(const t of e.children)t.state=1;else e.isSelected&&re(e)}function ie(e){let t=e;for(;t;){if(t.isLoaded||t.content)return t.state|=2,!0;t=t.parent}return!1}function oe(e){let t=e.parent;for(;t;)t.state=0,t.isVisible=!1,t=t.parent}function re(e){if(e.children)for(const t of e.children)t.isLoaded||t.content?t.state|=2:re(t)}let le=null;function ae(){return window.deck||null}function se(e,t,i){if(!i)return null;if(Array.isArray(i))return i;if("string"==typeof i&&i.startsWith("@@=")){const e=i.slice(3);return t=>{try{return new Function("object",`const properties = object?.properties || object || {}; return (${e});`)(t)}catch{return null}}}if("object"==typeof i&&i["@@function"]){const o=i["@@function"],r=i.attr;if(!r)return null;if("colorContinuous"===o){const e=i.domain;if(!Array.isArray(e)||e.length<2)return null;const t=Number(e[0]),o=Number(e[e.length-1]);if(!Number.isFinite(t)||!Number.isFinite(o)||t===o)return null;const l=Math.max(2,Number(i.steps??7)),a=n(i.colors||"ArmyRose",l)||null;if(!a?.length)return null;const s=t>o,c=!!i.reverse,d=(s?!c:c)?[...a].reverse():[...a],u=Math.min(t,o),p=Math.max(t,o),f=Array.isArray(i.nullColor)?i.nullColor:[184,184,184],y=d.map(e=>{const t=e.replace("#","");return[parseInt(t.slice(0,2),16),parseInt(t.slice(2,4),16),parseInt(t.slice(4,6),16)]});return e=>{const t=(e?.properties||e||{})[r];let n=null;if("number"==typeof t)n=t;else if("string"==typeof t){const e=parseFloat(t);n=Number.isFinite(e)?e:null}if(null==n||!Number.isFinite(n))return f;const i=Math.max(0,Math.min(1,(n-u)/(p-u)))*(y.length-1),o=Math.floor(i),l=Math.min(o+1,y.length-1),a=i-o,s=y[o],c=y[l];return[Math.round(s[0]+(c[0]-s[0])*a),Math.round(s[1]+(c[1]-s[1])*a),Math.round(s[2]+(c[2]-s[2])*a)]}}if("colorCategories"===o){const o=Array.isArray(i.categories)?i.categories:Array.isArray(i.domain)?i.domain:[],l=i.colors||"Bold",a=Array.isArray(i.nullColor)?i.nullColor:[184,184,184];if(o.length){const e=n(l,Math.max(o.length,3))||null,t=new Map;e?.length&&o.forEach((n,i)=>{const o=e[i%e.length]||"#999999",r=String(o).replace("#",""),l=parseInt(r.slice(0,2),16),a=parseInt(r.slice(2,4),16),s=parseInt(r.slice(4,6),16);t.set(String(n?.value??n),[l,a,s])});try{i._detectedCategories=o.map(e=>"object"==typeof e?{value:e.value,label:String(e.label??e.value)}:{value:e,label:String(e)})}catch(e){}return e=>{const n=(e?.properties||e||{})[r];return null==n?a:t.get(String(n))||a}}const s=t.id;e.catState[s]=e.catState[s]||{};const c=e.catState[s][r]||{lut:new Map,pairs:[],next:0};e.catState[s][r]=c;const d=n(l,12)||null,u=d?.length?d:["#7fc97f","#beaed4","#fdc086","#ffff99","#386cb0","#f0027f","#bf5b17","#666666"],p=()=>{try{if(c.debounce)return;c.debounce=setTimeout(()=>{c.debounce=null;try{window.dispatchEvent(new CustomEvent("fusedmaps:legend:update"))}catch(e){}},150)}catch(e){}};return e=>{const t=(e?.properties||e||{})[r];if(null==t||""===t||"null"===t)return a;const n=String(t);let o=c.lut.get(n);if(!o){const e=u[c.next%u.length]||"#999999";c.next+=1;const t=String(e).replace("#","");o=[parseInt(t.slice(0,2),16),parseInt(t.slice(2,4),16),parseInt(t.slice(4,6),16)],c.lut.set(n,o),c.pairs.length<50&&c.pairs.push({value:n,label:n});try{i._detectedCategories=c.pairs}catch(e){}p()}return o||a}}}return null}function ce(e,t,n){const i=Math.PI-2*Math.PI*t/Math.pow(2,n),o=e/Math.pow(2,n)*360-180,r=180/Math.PI*Math.atan(Math.sinh(i)),l=Math.PI-2*Math.PI*(t+1)/Math.pow(2,n),a=(e+1)/Math.pow(2,n)*360-180;return{west:o,south:180/Math.PI*Math.atan(Math.sinh(l)),east:a,north:r}}function de(e,t){return!(e.east<t.west||e.west>t.east||e.north<t.south||e.south>t.north)}function ue(e){const t=e.hexLayer?.getFillColor;if(!t||"object"!=typeof t||Array.isArray(t))return{enabled:!1,attr:null};if("colorContinuous"!==t["@@function"])return{enabled:!1,attr:null};const n=t.attr||null;if(!n)return{enabled:!1,attr:null};if(!0===e.fillDomainFromUser||!0===t.fillDomainFromUser)return{enabled:!1,attr:n};const i=Array.isArray(t.domain)&&t.domain.length>=2;return{enabled:!0===t.autoDomain||!i,attr:n}}function pe(e){if(null==e)return null;if("number"==typeof e)return Number.isFinite(e)?e:null;if("bigint"==typeof e){const t=Number(e);return Number.isFinite(t)?t:null}if("string"==typeof e){const t=parseFloat(e);return Number.isFinite(t)?t:null}return null}function fe(e,t,n,i,o){const r=e.getZoom(),l=n.tileUrl||"",a=l.replace(/\/?\{z\}\/?\{x\}\/?\{y\}.*$/,"");if(r<10)return null;if(!i)return null;if(!l)return null;const s=e.getBounds(),c={west:s.getWest(),east:s.getEast(),south:s.getSouth(),north:s.getNorth()},d=[];for(const[e,n]of t.cache.entries()){const t=e.split("|");if(t.length<2)continue;if(!t[0].startsWith(a))continue;const[r,l,s]=t[1].split("/").map(Number);if(Number.isFinite(r)&&Number.isFinite(l)&&Number.isFinite(s)&&(!(Math.abs(r-o)>1)&&de(ce(l,s,r),c)&&Array.isArray(n))){for(const e of n){if(d.length>=5e3)break;const t=e?.properties||e;if(!t)continue;const n=t[i];if(null==n)continue;const o="number"==typeof n?n:parseFloat(String(n));Number.isFinite(o)&&d.push(o)}if(d.length>=5e3)break}}if(d.length<30)return function(e,t,n,i){if(e.getZoom()<10)return null;const o=t.tileStats[n.id];if(!o)return null;const r=e.getBounds(),l={west:r.getWest(),east:r.getEast(),south:r.getSouth(),north:r.getNorth()};let a=Number.POSITIVE_INFINITY,s=Number.NEGATIVE_INFINITY,c=0;for(const[e,t]of Object.entries(o)){const[n,o,r]=e.split("/").map(Number);Number.isFinite(n)&&Number.isFinite(o)&&Number.isFinite(r)&&(Math.abs(n-i)>1||de(ce(o,r,n),l)&&(Number.isFinite(t.min)&&(a=Math.min(a,t.min),c++),Number.isFinite(t.max)&&(s=Math.max(s,t.max))))}if(c<2||!Number.isFinite(a)||!Number.isFinite(s))return null;const d=s-a;if(Number.isFinite(d)&&d>0){const e=.01*d;a-=e,s+=e}return a>=s?[a-1,s+1]:[a,s]}(e,t,n,o);d.sort((e,t)=>e-t);const u=Math.floor(.02*d.length),p=Math.min(d.length-1,Math.ceil(.98*d.length)-1),f=d[Math.max(0,u)],y=d[Math.max(0,p)];return Number.isFinite(f)&&Number.isFinite(y)?f>=y?[f-1,y+1]:[f,y]:null}function ye(e,t){const n=e.hexLayer?.getFillColor;if(!n||"object"!=typeof n)return!1;const i=n._dynamicDomain;return!!(!Array.isArray(i)||i.length<2||(()=>{const e=i[1]-i[0]?i[1]-i[0]:1;return Math.abs(t[0]-i[0])/e>.05||Math.abs(t[1]-i[1])/e>.05})())&&(n._dynamicDomain=t,!0)}function ge(e){const t=e.tileLayerConfig||{};return{tileSize:t.tileSize??256,minZoom:t.minZoom??0,maxZoom:t.maxZoom??19,zoomOffset:t.zoomOffset??0,maxRequests:t.maxRequests??20}}function me(e,t,n,i,o){const r=ae();if(!r)return[];const l=r.TileLayer,a=r.H3HexagonLayer||r?.GeoLayers?.H3HexagonLayer;return l&&a?e.filter(e=>"hex"===e.layerType&&e.isTileLayer&&e.tileUrl).map(e=>e).filter(e=>!1!==t[e.id]).slice().reverse().map(e=>{const t=e.tileUrl,r=ge(e),c=e.hexLayer||{},d=c.getFillColor,u=d&&"object"==typeof d&&!Array.isArray(d)&&Array.isArray(d._dynamicDomain)?{...d,domain:d._dynamicDomain}:d,p=c.getLineColor,f=p&&"object"==typeof p&&!Array.isArray(p)&&Array.isArray(p._dynamicDomain)?{...p,domain:p._dynamicDomain}:p,y=se(n,e,u),g=se(n,e,f),m=(e=>{let t=5381;for(let n=0;n<e.length;n++)t=(t<<5)+t^e.charCodeAt(n);return(t>>>0).toString(16)})(JSON.stringify({fd:u&&"object"==typeof u?u.domain||u._dynamicDomain:null,ld:f&&"object"==typeof f?f.domain||f._dynamicDomain:null})),h=!1!==c.stroked,b=!1!==c.filled,v=!0===c.extruded,x="number"==typeof c.opacity?c.opacity:.8,C=c.lineWidthMinPixels??1,L=c.elevationScale??1,w=c.coverage??.9,E=c.elevationProperty||(u&&"object"==typeof u?u.attr:null)||null,S=o?.[e.id],F=JSON.stringify({fill:u,line:f}),A=`${e.id}-tiles-${m}`;return new l({id:A,data:t,tileSize:r.tileSize,minZoom:r.minZoom,maxZoom:r.maxZoom,zoomOffset:r.zoomOffset,maxRequests:r.maxRequests,maxCacheSize:200,refinementStrategy:ne,pickable:!0,autoHighlight:!0,visible:!0,...S?{beforeId:S}:{},onTileError:e=>{console.warn("[tiles] Tile error:",e.message)},onViewportLoad:()=>{try{window.dispatchEvent(new CustomEvent("fusedmaps:legend:update"))}catch{}},getTileData:async({index:o,signal:r})=>{const{x:l,y:a,z:c}=o,d=t.replace("{z}",c).replace("{x}",l).replace("{y}",a),u=`${c}/${l}/${a}`,p=`${d}|${u}`;if(n.cache.has(p))return n.cache.get(p);if(n.inflight.has(p))try{return await n.inflight.get(p)}catch{}i(1);const f=(async()=>{try{const i=await fetch(d,{signal:r});if(r?.aborted)return null;if(!i.ok)throw new Error(`HTTP ${i.status} for tile ${u}`);const l=(i.headers.get("Content-Type")||"").toLowerCase();let a,c=null;if(l.includes("application/octet-stream")||l.includes("application/parquet")||d.endsWith(".parquet")){let e=window.hyparquet;if(!e?.parquetMetadataAsync||!e?.parquetReadObjects)try{e=await async function(){const e=window;return e.hyparquet?.parquetMetadataAsync&&e.hyparquet?.parquetReadObjects?e.hyparquet:le||(le=(async()=>{const t=await new Function("u","return import(u)")("https://cdn.jsdelivr.net/npm/hyparquet@1.23.3/+esm"),n=t?.default&&(t.default.parquetReadObjects||t.default.parquetMetadataAsync)?t.default:t;return e.hyparquet=n,e.hyparquet})().catch(e=>{throw le=null,e}),le)}()}catch(e){throw new Error(`Failed to load hyparquet for tile ${u}`)}const t=await i.arrayBuffer();if(r?.aborted)return null;if(!t||0===t.byteLength)return[];const n={byteLength:t.byteLength,slice:async(e,n)=>t.slice(e,n)},o=await e.parquetMetadataAsync(n);if(c=o,r?.aborted)return null;a=await e.parquetReadObjects({file:n,utf8:!1,metadata:o})}else{let e=await i.text();if(r?.aborted)return null;e=e.replace(/\"(hex|h3|index|id)\"\s*:\s*(\d+)/gi,(e,t,n)=>`"${t}":"${n}"`),a=JSON.parse(e)}const f=(o=a,t=(Array.isArray(o)?o:Array.isArray(o?.data)?o.data:Array.isArray(o?.features)?o.features:[]).map(e=>e?.properties?{...e.properties}:{...e}).map(e=>{const t=s(e.hex??e.h3??e.index??e.id);if(!t)return null;const n={...e,hex:t};return{...n,properties:{...n}}}).filter(Boolean),(t||[]).map(e=>{const t=function(e){const t={};for(const n of Object.keys(e||{})){const i=e[n];if("bigint"==typeof i){const e=String(n).toLowerCase();"hex"===e||"h3"===e||"index"===e||"id"===e?t[n]=i.toString(16):i<=BigInt(Number.MAX_SAFE_INTEGER)&&i>=BigInt(Number.MIN_SAFE_INTEGER)?t[n]=Number(i):t[n]=i.toString()}else t[n]=i}return t}(e?.properties?e.properties:e||{});return{...t,properties:{...t}}}));n.cache.set(p,f);try{const t=ue(e);if(t.enabled&&t.attr&&c){const i=function(e,t){const n=e?.row_groups||e?.rowGroups||e?.row_groups_list||null;if(!Array.isArray(n)||0===n.length)return null;let i=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY,r=!1;for(const e of n){const n=e?.columns||e?.columns_list||null;if(Array.isArray(n))for(const e of n){const n=e?.meta_data||e?.metaData||e?.metadata||null,l=n?.path_in_schema||n?.pathInSchema||n?.path||null,a=Array.isArray(l)?String(l[l.length-1]):"string"==typeof l?l:null;if(!a||a!==t)continue;const s=n?.statistics||n?.stats||e?.statistics||null;if(!s)continue;const c=pe(s.min_value??s.min??s.minimum??s.minValue),d=pe(s.max_value??s.max??s.maximum??s.maxValue);null!=c&&null!=d&&(r=!0,c<i&&(i=c),d>o&&(o=d))}}return r&&Number.isFinite(i)&&Number.isFinite(o)?i===o?{min:i-1,max:o+1}:{min:i,max:o}:null}(c,t.attr);if(i){n.tileStats[e.id]||(n.tileStats[e.id]={}),n.tileStats[e.id][u]={min:i.min,max:i.max};try{window.dispatchEvent(new CustomEvent("fusedmaps:autodomain:dirty"))}catch{}}}}catch(e){}try{window.dispatchEvent(new CustomEvent("fusedmaps:legend:update"))}catch{}return f}catch(e){if(r?.aborted)return null;throw e}finally{n.inflight.delete(p),i(-1)}var t,o})();return n.inflight.set(p,f),f},renderSubLayers:e=>{const t=e.data||[];return t&&t.length?new a({id:`${e.id}-h3`,data:t,getHexagon:e=>e.hex,pickable:!0,stroked:h,filled:b,extruded:v,opacity:x,coverage:w,lineWidthMinPixels:C,elevationScale:L,...v&&E?{getElevation:e=>Number(e?.[E]??0)}:{},...y?{getFillColor:y}:{},...g?{getLineColor:g}:{},updateTriggers:{getFillColor:F,getLineColor:F}}):null}})}):[]}let he=null,be=!1,ve=null,xe=null,Ce=null;const Le=new Map;function we(e){const t=e?.json||{},n=[];if(Array.isArray(t.vector_layers))for(const e of t.vector_layers)e?.id&&n.push(String(e.id));if(t?.tilestats?.layers&&Array.isArray(t.tilestats.layers))for(const e of t.tilestats.layers){const t=e?.layer;t&&!n.includes(String(t))&&n.push(String(t))}return n}async function Ee(e){if(Le.has(e))return Le.get(e);const t=(async()=>{const t=new((await async function(){return xe||Ce||(Ce=new Function("u","return import(u)")("https://cdn.jsdelivr.net/npm/pmtiles@3.0.6/+esm").then(e=>(xe=e,xe)).finally(()=>{Ce=null}),Ce)}()).PMTiles)(e);let n={};try{n=await t.getMetadata()}catch(e){n={}}const i=[];if(n?.vector_layers?.length>0)for(const e of n.vector_layers)e?.id&&i.push(String(e.id));if(n?.tilestats?.layers&&Array.isArray(n.tilestats.layers))for(const e of n.tilestats.layers){const t=e?.layer;t&&!i.includes(String(t))&&i.push(String(t))}return i})();return Le.set(e,t),t.catch(()=>Le.delete(e)),t}async function Se(){return he||ve||(window.mapboxPmTiles?(he=window.mapboxPmTiles,he):(ve=new Promise((e,t)=>{const n=document.createElement("script");n.src="https://cdn.jsdelivr.net/npm/mapbox-pmtiles@1.0.54/dist/mapbox-pmtiles.umd.min.js",n.onload=()=>{he=window.mapboxPmTiles,e(he)},n.onerror=()=>t(new Error("Failed to load mapbox-pmtiles library")),document.head.appendChild(n)}).finally(()=>{ve=null}),ve))}function Fe(e,t,n="#ff8c00"){if(!e)return n;if("string"==typeof e)return e;if(Array.isArray(e))return e;const i=e["@@function"],o=e.attr||t;if("colorContinuous"===i){const t=e.domain||[0,100],n=e.steps||7,i=!!e.reverse;let r=e.colors;"string"==typeof r&&(r=function(e,t=7){const n=window.cartocolor,i=["#440154","#414487","#2a788e","#22a884","#7ad151","#fde725"];if(!n)return i;const o=n[e];if(o){const e=Object.keys(o).map(Number).filter(e=>!isNaN(e)).sort((e,t)=>t-e);return o[e.find(e=>e<=t)||e[e.length-1]]||i}return i}(r,n)),r&&Array.isArray(r)||(r=["#440154","#21918c","#fde725"]),i&&r.length>1&&(r=[...r].reverse());const l=e.nullColor?Array.isArray(e.nullColor)?`rgb(${e.nullColor.slice(0,3).join(",")})`:e.nullColor:"rgb(184,184,184)",a=["interpolate",["linear"],["to-number",["get",o]]],s=r.length;for(let e=0;e<s;e++){const n=e/(s-1),i=t[0]+n*(t[1]-t[0]);a.push(i,r[e])}return["case",["==",["get",o],null],l,a]}if("colorCategories"===i){const t=e.categories||{},n=e.othersColor||"#888888",i=["match",["get",o]];for(const[e,n]of Object.entries(t))i.push(e,n);return i.push(n),i}return n}async function Ae(e,t,n,i=!1){if(0===t.length)return;await async function(){if(be)return;const e=window.mapboxgl;if(!e?.Style?.setSourceType)throw new Error("Mapbox GL JS v3 with Style.setSourceType is required for PMTiles");const t=await Se();e.Style.setSourceType(t.SOURCE_TYPE,t.PmTilesSource),be=!0}();const o=await Se();for(let r=0;r<t.length;r++){const l=t[r];if(!l.pmtilesUrl)continue;const a=!1!==n[l.id],s=`${l.id}-source`;try{const t=await o.PmTilesSource.getHeader(l.pmtilesUrl),n=[t.minLon,t.minLat,t.maxLon,t.maxLat];let c=we(t);const d=c[0]||"default",u="string"==typeof l.sourceLayer?l.sourceLayer.trim():"";if(!u&&0===c.length)try{c=await Ee(l.pmtilesUrl)}catch(e){}const p=c[0]||d,f=new Set([...l.excludeSourceLayers||[],...l.exclude_source_layers||[],...l.vectorLayer?.excludeSourceLayers||[],...l.vectorLayer?.exclude_source_layers||[]].filter(Boolean)),y=e=>e.filter(e=>!f.has(e)),g=!u&&c.length>1?y(c):c,m="*"===u?y(c):u?[u]:c.length>1?g:[p];0===m.length&&console.warn("[FusedMaps] PMTiles: could not detect any source-layers; set `source_layer` explicitly for:",l.id),u&&"*"!==u&&c.length>0&&!c.includes(u)&&console.warn("[FusedMaps] PMTiles: requested source-layer not found in header.json:",{requested:u,available:c}),e.getSource(s)||e.addSource(s,{type:o.SOURCE_TYPE,url:l.pmtilesUrl,minzoom:t.minZoom,maxzoom:t.maxZoom,bounds:n});const h=l.vectorLayer||{},b=l.fillOpacity??h.opacity??.8,v=l.lineWidth??1,x=l.pointRadiusMinPixels??4,C=!1!==l.isFilled,L=!1!==l.isStroked?v:0,w=C?b:0,E=Fe(l.fillColorConfig||h.getFillColor,l.colorAttribute||"value","#ff8c00"),S=Fe(l.lineColorConfig||h.getLineColor,l.colorAttribute||"value","#ffffff"),F=e=>e.replace(/[^a-zA-Z0-9_-]+/g,"-");for(const t of m){const n=F(t||"default"),i={};"number"==typeof l.minzoom&&(i.minzoom=l.minzoom),"number"==typeof l.maxzoom&&(i.maxzoom=l.maxzoom);const o=`${l.id}-${n}-circles`;e.getLayer(o)||e.addLayer({id:o,type:"circle",source:s,"source-layer":t,filter:["==",["geometry-type"],"Point"],...i,paint:{"circle-radius":["interpolate",["exponential",2],["zoom"],0,.5*x,10,x,15,4*x,20,20*x],"circle-color":E,"circle-opacity":w,"circle-stroke-color":S,"circle-stroke-width":L},layout:{visibility:a?"visible":"none"}});const r=`${l.id}-${n}-fill`;e.getLayer(r)||e.addLayer({id:r,type:"fill",source:s,"source-layer":t,filter:["==",["geometry-type"],"Polygon"],...i,paint:{"fill-color":E,"fill-opacity":w},layout:{visibility:a?"visible":"none"}});const c=`${l.id}-${n}-line`;e.getLayer(c)||e.addLayer({id:c,type:"line",source:s,"source-layer":t,...i,paint:{"line-color":S,"line-width":L,"line-opacity":b},layout:{visibility:a?"visible":"none"}})}!i&&n&&0===r&&e.fitBounds([[n[0],n[1]],[n[2],n[3]]],{padding:50,duration:0})}catch(e){console.error(`[FusedMaps] Failed to add PMTiles layer ${l.id}:`,e)}}}const $e={};function ke(){return $e}function Te(e,t){$e[e]=t}function Me(e){delete $e[e]}function Ne(e,t,n,i){!function(e,t){t.forEach(t=>{_e(e,t)})}(e,t),[...t].reverse().forEach(t=>{const i=!1!==n[t.id];switch(t.layerType){case"hex":{const n=t;if(n.isTileLayer);else if(n.data?.length){const o=c(n.data);Te(t.id,o),d(e,n,o,i)}break}case"vector":{const n=t;n.geojson&&(Te(t.id,n.geojson),H(e,n,i));break}case"mvt":V(e,t,i);break;case"raster":J(e,t,i)}});const o={};for(let e=0;e<t.length;e++){const n=t[e];if("hex"===n.layerType&&n.isTileLayer)for(let i=e-1;i>=0;i--){const e=t[i];if("hex"===e.layerType&&e.isTileLayer)continue;const r=M(e);if(r){o[n.id]=r;break}}}let r=null;if(t.some(e=>"hex"===e.layerType&&e.isTileLayer&&e.tileUrl)){const i=function(e,t,n,i){const o=ae();if(!o?.MapboxOverlay||!o?.TileLayer)return null;const r={cache:new Map,inflight:new Map,tilesLoading:0,tileStats:{},catState:{}},l=e=>{try{te(e)}catch(e){}},a={current:n},s=()=>me(t,a.current,r,l,i),c={current:null},d=new o.MapboxOverlay({interleaved:!0,useDevicePixels:!0,layers:s(),onHover:e=>{c.current=e?.object?e:null}});try{e.addControl(d)}catch{}const u=t=>{t&&(a.current=t);try{d.setProps({layers:s()});try{e.fire("move"),e.fire("moveend"),e.triggerRepaint?.()}catch{}if(t)try{window.dispatchEvent(new CustomEvent("fusedmaps:autodomain:dirty"))}catch{}}catch{}},p=t.filter(e=>"hex"===e.layerType&&e.isTileLayer).map(e=>({layer:e,...ue(e),tileCfg:ge(e)})).filter(e=>e.enabled&&e.attr);let f=null;const y=t=>{p.length&&(f&&clearTimeout(f),f=setTimeout(()=>{const t=p.filter(e=>!1!==a.current[e.layer.id]);let n=!1;for(const i of t){const t=Math.round(e.getZoom())+(i.tileCfg.zoomOffset||0),o=fe(e,r,i.layer,i.attr,t);o&&ye(i.layer,o)&&(n=!0)}if(n){u();try{window.dispatchEvent(new CustomEvent("fusedmaps:legend:update"))}catch{}}},t))},g=()=>y(1e3),m=()=>y(1500),h=()=>y(200);if(p.length){e.on("moveend",g),e.on("idle",m);try{window.addEventListener("fusedmaps:autodomain:dirty",h)}catch{}y(1500)}return{overlay:d,rebuild:u,pickObject:e=>{try{return d.pickObject(e)}catch{return null}},getHoverInfo:()=>c.current,getTileData:()=>r.cache,destroy:()=>{f&&clearTimeout(f);try{e.off("moveend",g)}catch{}try{e.off("idle",m)}catch{}try{window.removeEventListener("fusedmaps:autodomain:dirty",h)}catch{}try{e.removeControl(d)}catch{}}}}(e,t,n,o);r=i?.overlay||null,r&&i&&(r.__fused_hex_tiles__=i)}const l=t.filter(e=>"pmtiles"===e.layerType);return l.length>0&&Ae(e,l,n,!0===i?.hasCustomView).catch(e=>{console.error("[FusedMaps] Failed to add PMTiles layers:",e)}),{deckOverlay:r}}function Oe(e,t,n,i){switch(t.layerType){case"hex":{const i=t;if(!i.isTileLayer&&i.data?.length){const o=c(i.data);Te(t.id,o),d(e,i,o,n)}break}case"vector":{const i=t;i.geojson&&(Te(t.id,i.geojson),H(e,i,n));break}case"mvt":V(e,t,n);break;case"raster":J(e,t,n);break;case"pmtiles":Ae(e,[t],{[t.id]:n},!0===i?.hasCustomView).catch(e=>{console.error("[FusedMaps] Failed to add PMTiles layer:",e)})}}function _e(e,t){if("pmtiles"===t.layerType)return function(e,t){const n=`${t}-`,i=e.getStyle()?.layers||[];for(let t=i.length-1;t>=0;t--){const o=i[t]?.id;if(o&&o.startsWith(n))try{e.getLayer(o)&&e.removeLayer(o)}catch(e){}}const o=`${t}-source`;e.getSource(o)&&e.removeSource(o)}(e,t.id),void Me(t.id);const n=function(e){const t=e.id;return[`${t}-fill`,`${t}-extrusion`,`${t}-outline`,`${t}-circle`,`${t}-line`,`${t}-raster`,`${t}-circles`]}(t);n.forEach(t=>{try{e.getLayer(t)&&e.removeLayer(t)}catch(e){}});try{e.getSource(t.id)&&e.removeSource(t.id),e.getSource(`${t.id}-source`)&&e.removeSource(`${t.id}-source`)}catch(e){}Me(t.id)}function Pe(e,t,n,i){e.getLayer(t)&&e.setPaintProperty(t,n,i)}function Ie(e,t,n,i){e.getLayer(t)&&e.setLayoutProperty(t,n,i)}function je(e,t,n){const i=e.getSource(t);return!(!i||"function"!=typeof i.setData||(i.setData(n),0))}function Re(e){return"top-left"===e||"bottom-left"===e}const qe={"top-left":"fm-widgets-top-left","top-right":"fm-widgets-top-right","bottom-left":"fm-widgets-bottom-left","bottom-right":"fm-widgets-bottom-right","top-center":"fm-widgets-top-center"};function De(e){const t=qe[e];let n=document.getElementById(t);return n||(n=document.createElement("div"),n.id=t,n.className=`fm-widget-container fm-widget-${e}`,document.body.appendChild(n)),n}let Be=null,ze=null,Ue=!1,We=!1,He=null,Ve={},Ze=null;function Ge(e){return He?!1!==He.get(e)?.visible:!1!==Ve[e]}function Je(e){const t=e.target;if(!t)return;const n=t.closest?.(".layer-group-header");if(n){const i=n.getAttribute("data-group-name")||"";if(!i)return;if(t.closest?.(".group-eye")){const e=document.querySelectorAll(`.layer-item[data-group="${i}"]`),t=[];e.forEach(e=>{const n=e.getAttribute("data-layer-id");n&&t.push(n)});const n=t.some(e=>Ge(e));t.forEach(e=>Be?.(e,!n))}else{tt[i]=!tt[i];const e=n.nextElementSibling;e?.classList.contains("layer-group-content")&&e.classList.toggle("collapsed",!tt[i]);const t=n.querySelector(".group-chevron");t&&(t.innerHTML=tt[i]?Ke:et)}return e.preventDefault(),void e.stopPropagation()}const i=t.closest?.(".layer-item");if(!i)return;const o=i.getAttribute("data-layer-id")||"";if(o&&(t.closest?.(".layer-eye")||t.closest?.(".layer-item"))){const t=Ge(o);Be?.(o,!t),e.preventDefault(),e.stopPropagation()}}const Ye='<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>',Qe='<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/></svg>',Xe='<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M11.99 18.54l-7.37-5.73L3 14.07l9 7 9-7-1.63-1.27-7.38 5.74zM12 16l7.36-5.73L21 9l-9-7-9 7 1.63 1.27L12 16z"/></svg>',Ke='<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>',et='<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>',tt={};function nt(e,t,n,i,o="top-right",r=!1){Be=n;const l=i;He=l||null,Ve=t||{};const a=De(o),s=Re(o);let c=document.getElementById("layer-panel");if(!c){c=document.createElement("div"),c.id="layer-panel";const e=s?" is-left":"";c.className=r?`fm-dropdown-widget${e}`:`fm-dropdown-widget collapsed${e}`,c.innerHTML=`\n      <button id="layer-panel-toggle" class="fm-dropdown-toggle" title="Layers">\n        ${Xe}\n      </button>\n      <div class="fm-dropdown-panel" id="layer-panel-dropdown">\n        <div class="fm-dropdown-header">\n          <span class="fm-dropdown-header-icon">${Xe}</span>\n          <span class="fm-dropdown-title">Layers</span>\n          <button class="fm-dropdown-close" id="layer-panel-close" title="Close"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>\n        </div>\n        <div id="layer-list"></div>\n      </div>\n    `,a.appendChild(c);const t=document.getElementById("layer-panel-toggle");t?.addEventListener("click",e=>{e.stopPropagation();const t=c?.classList.contains("collapsed");t&&document.querySelectorAll(".fm-dropdown-widget:not(#layer-panel)").forEach(e=>{e.classList.add("collapsed")}),c?.classList.toggle("collapsed")});const n=document.getElementById("layer-panel-close");n?.addEventListener("click",e=>{e.stopPropagation(),c?.classList.add("collapsed")}),document.addEventListener("click",e=>{const t=e.target;c?.contains(t)||c?.classList.add("collapsed")})}return Ze=c,We||(c.addEventListener("click",Je),We=!0),l?rt(l):lt(e,t),l&&(ze=l.on("*",e=>{"visibility"!==e.type&&"reorder"!==e.type&&"add"!==e.type&&"remove"!==e.type&&"batch"!==e.type||rt(l)})),Ue||(Ue=!0,window.addEventListener("fusedmaps:legend:update",()=>{l&&rt(l)})),{destroy:()=>{ze&&(ze(),ze=null),Ze?.removeEventListener("click",Je),We=!1,Ze=null,He=null}}}function it(e,t,o,r){const l=function(e){let t="#0090ff";const o=e=>e&&e.length?1===e.length?e[0]:`linear-gradient(to bottom, ${e.map((t,n)=>`${t} ${n/(e.length-1)*100}%`).join(", ")})`:null;if("hex"===e.layerType){const r=e.hexLayer||{},l=!1===r.filled&&r.getLineColor?r.getLineColor:r.getFillColor;if(Array.isArray(l)){const e=i(l,1);e&&(t=e)}else if(l&&"object"==typeof l){const e=l["@@function"];if("colorContinuous"===e||"colorCategories"===e){let i=n(l.colors||("colorCategories"===e?"Bold":"TealGrn"),l.steps||7);if(i?.length){const e=l.domain,n=Array.isArray(e)&&e.length>=2&&e[0]>e[e.length-1],r=!!l.reverse;(n?!r:r)&&(i=[...i].reverse()),t=o(i)||t}}}}else if("vector"===e.layerType){const i=e,r=(i.vectorLayer?.opacity??i.opacity??1)<.1||!i.isFilled;let l=null;if(r&&i.lineColorConfig?l=i.lineColorConfig:i.fillColorConfig?l=i.fillColorConfig:i.lineColorConfig&&(l=i.lineColorConfig),l&&"object"==typeof l){const e=l["@@function"];if("colorContinuous"===e||"colorCategories"===e){let i=n(l.colors||("colorCategories"===e?"Bold":"TealGrn"),l.steps||7);if(i?.length){const e=l.domain,n=Array.isArray(e)&&e.length>=2&&e[0]>e[e.length-1],r=!!l.reverse;(n?!r:r)&&(i=[...i].reverse()),t=o(i)||t}}}else r&&i.lineColorRgba?t=i.lineColorRgba:i.fillColorRgba&&(t=i.fillColorRgba)}else if("pmtiles"===e.layerType){const i=e;if(i.fillColorConfig&&"object"==typeof i.fillColorConfig){const e=i.fillColorConfig.colors;if(e){let r=n(e,7);r?.length&&(!!i.fillColorConfig.reverse&&(r=[...r].reverse()),t=o(r)||t)}}}else"raster"===e.layerType&&(t="linear-gradient(to bottom, #888, #444)");return t}(e),a=t?Ye:Qe,s=r?` data-group="${r}"`:"";return`\n    <div class="layer-item${r?" layer-item-grouped":""} ${t?"":"disabled"}"\n         data-layer-id="${e.id}"\n         data-order="${o}"${s}\n         style="--layer-strip: ${l};">\n      <span class="layer-name">${e.name}</span>\n      <span class="layer-eye" title="Toggle visibility">${a}</span>\n    </div>\n  `}function ot(e){let t=0;return e.forEach(e=>{Ge(e)&&t++}),0===t?"none":t===e.length?"all":"mixed"}function rt(e){const t=document.getElementById("layer-list");if(!t)return;const n=e.getAll(),i=new Map;n.forEach(e=>{const t=e.config.group;t&&"string"==typeof t&&(i.has(t)||i.set(t,[]),i.get(t).push(e))});const o=new Set;let r="";n.forEach(e=>{const t=e.config.group;if(t){if(!o.has(t)){o.add(t);const e=i.get(t),n=e.map(e=>e.config.id);void 0===tt[t]&&(tt[t]=!0);const l=tt[t],a=ot(n);let s=Ye,c="";"none"===a?(s=Qe,c=" group-hidden"):"mixed"===a&&(c=" group-mixed"),r+=`\n        <div class="layer-group-header" data-group-name="${t}">\n          <span class="group-chevron">${l?Ke:et}</span>\n          <span class="group-name">${t}</span>\n          <span class="group-eye${c}" title="Toggle group visibility">${s}</span>\n        </div>\n      `,r+=`<div class="layer-group-content${l?"":" collapsed"}">`,e.forEach(e=>{r+=it(e.config,e.visible,e.order,t)}),r+="</div>"}}else r+=it(e.config,e.visible,e.order)}),t.innerHTML=r}function lt(e,t){const n=document.getElementById("layer-list");if(!n)return;Ve=t||{};const i=new Map;e.forEach(e=>{const t=e.group;t&&"string"==typeof t&&(i.has(t)||i.set(t,[]),i.get(t).push(e))});const o=new Set;let r="";e.forEach((e,n)=>{const l=e.group;if(l){if(!o.has(l)){o.add(l);const e=i.get(l),n=e.map(e=>e.id);void 0===tt[l]&&(tt[l]=!0);const a=tt[l],s=ot(n);let c=Ye,d="";"none"===s?(c=Qe,d=" group-hidden"):"mixed"===s&&(d=" group-mixed"),r+=`\n        <div class="layer-group-header" data-group-name="${l}">\n          <span class="group-chevron">${a?Ke:et}</span>\n          <span class="group-name">${l}</span>\n          <span class="group-eye${d}" title="Toggle group visibility">${c}</span>\n        </div>\n      `,r+=`<div class="layer-group-content${a?"":" collapsed"}">`,e.forEach((e,n)=>{const i=!1!==t[e.id];r+=it(e,i,n,l)}),r+="</div>"}}else{const i=!1!==t[e.id];r+=it(e,i,n)}}),n.innerHTML=r}const at='<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><rect x="3" y="5" width="4" height="3" rx="0.5"/><rect x="9" y="5" width="12" height="3" rx="0.5"/><rect x="3" y="10.5" width="4" height="3" rx="0.5"/><rect x="9" y="10.5" width="9" height="3" rx="0.5"/><rect x="3" y="16" width="4" height="3" rx="0.5"/><rect x="9" y="16" width="6" height="3" rx="0.5"/></svg>';function st(e,t,i,a){const s=document.getElementById("color-legend"),c=document.getElementById("legend-content");if(!s)return;const d=e.filter(e=>!1!==t[e.id]);if(!d.length)return void(s.style.display="none");let u="";d.forEach(e=>{const t=function(e,t,i){let a=null;if("hex"===e.layerType){const t=e,n=t.hexLayer||{};if(a=!1===n.filled&&n.getLineColor?n.getLineColor:n.getFillColor,t.isTileLayer&&function(e){if("string"!=typeof e)return!1;if(!e.startsWith("@@="))return!1;const t=e.includes("properties.r")||e.includes(".r]")||e.includes(".r,"),n=e.includes("properties.g")||e.includes(".g]")||e.includes(".g,"),i=e.includes("properties.b")||e.includes(".b]")||e.includes(".b,");return t&&n&&i}(a)&&i&&i.size>0){const o=n.legendAttr||(Array.isArray(n.tooltipColumns)?n.tooltipColumns[0]:null)||(Array.isArray(t.tooltipColumns)?t.tooltipColumns[0]:null)||"taxsubgrp",r=Number.isFinite(n.legendMaxCategories)?n.legendMaxCategories:40;return function(e,t,n="taxsubgrp",i=40){try{if(!t||0===t.size)return"";const o=new Map;for(const e of t.values())if(Array.isArray(e)){for(const t of e){const e=t?.properties||t||{},r=e[n];if(null==r||""===r||"null"===r)continue;const l=String(r);if(o.has(l))continue;const a=Number(e.r),s=Number(e.g),c=Number(e.b);if(!Number.isFinite(a)||!Number.isFinite(s)||!Number.isFinite(c))continue;const d=e=>Math.max(0,Math.min(255,Math.round(e)));if(o.set(l,[d(a),d(s),d(c)]),o.size>=i)break}if(o.size>=i)break}return 0===o.size?"":`\n      <div class="legend-layer">\n        <div class="legend-title">${e}</div>\n        <div class="legend-categories">\n          ${[...o.keys()].sort((e,t)=>e.localeCompare(t)).map(e=>({label:e,rgb:o.get(e)})).map(e=>`\n            <div class="legend-cat-item">\n              <div class="legend-cat-swatch" style="background:rgb(${e.rgb[0]},${e.rgb[1]},${e.rgb[2]});"></div>\n              <span class="legend-cat-label" title="${e.label}">${e.label}</span>\n            </div>\n          `).join("")}\n        </div>\n      </div>\n    `}catch(e){return""}}(e.name,i,o,r)}}else if("vector"===e.layerType||"mvt"===e.layerType||"pmtiles"===e.layerType){const t=e,n=(t.vectorLayer?.opacity??t.style?.opacity??1)<.1||!1===t.vectorLayer?.filled||!1===t.style?.filled,i=e=>e?.["@@function"]||"continuous"===e?.type||"categorical"===e?.type,o=t.fillColorConfig||t.style?.fillColor,r=t.lineColorConfig||t.style?.lineColor;if(n&&i(r)?a=r:i(o)?a=o:i(r)&&(a=r),!i(a)&&t.lineColorRgba&&!t.isFilled)return`\n        <div class="legend-layer">\n          <div class="legend-title">\n            <span class="legend-line" style="background:${t.lineColorRgba};"></span>\n            ${e.name}\n          </div>\n        </div>\n      `}const s=a?.["@@function"]||("continuous"===a?.type?"colorContinuous":"categorical"===a?.type?"colorCategories":null);if(!s||!a?.attr)return"";if("colorContinuous"!==s&&"colorCategories"!==s)return"";const c=a.colors||a.palette||("colorCategories"===s?"Bold":"TealGrn");if("colorCategories"===s){try{const n=a;if(!(Array.isArray(n._detectedCategories)&&n._detectedCategories.length||Array.isArray(n.categories)&&n.categories.length)&&n.attr){let i=[];const o=t?.[e.id];if(o?.features?.length)i=o.features.map(e=>e?.properties||{});else if("hex"===e.layerType)i=e.data||[];else if("vector"===e.layerType){const t=e.geojson;t?.features?.length&&(i=t.features.map(e=>e?.properties||{}))}const r=l(i,n.attr,n.labelAttr);n._detectedCategories=r.slice(0,50)}}catch(e){}return function(e,t,i){let o=t._detectedCategories||t.categories||[];if(o=o.map(e=>"object"==typeof e&&e.label?e:{value:e,label:e}),!o.length)return"";let l=n(i,Math.max(o.length,3));return l?.length||(l=r),`\n    <div class="legend-layer">\n      <div class="legend-title">${e}</div>\n      <div class="legend-categories">\n        ${o.map((e,t)=>`\n          <div class="legend-cat-item">\n            <div class="legend-cat-swatch" style="background:${l[t%l.length]};"></div>\n            <span class="legend-cat-label" title="${e.label}">${e.label}</span>\n          </div>\n        `).join("")}\n      </div>\n    </div>\n  `}(e.name,a,c)}return"colorContinuous"===s?function(e,t,i){const r=t._dynamicDomain||t.domain;if(!r?.length)return"";const[l,a]=r,s=l>a;let c=n(i,t.steps||7);c?.length||(c=o),s&&(c=[...c].reverse());return`\n    <div class="legend-layer">\n      <div class="legend-title">${e}</div>\n      <div class="legend-gradient" style="background:${`linear-gradient(to right, ${c.map((e,t)=>`${e} ${t/(c.length-1)*100}%`).join(", ")})`};"></div>\n      <div class="legend-labels">\n        <span>${l.toFixed(1)}</span>\n        <span>${a.toFixed(1)}</span>\n      </div>\n    </div>\n  `}(e.name,a,c):""}(e,i,a);t&&(u+=t)}),u?(c?c.innerHTML=u:s.innerHTML=u,s.style.display="block"):s.style.display="none"}function ct(e){return Number.isInteger(e)?String(e):e.toFixed(2)}const dt=[{id:"dark",label:"Dark",style:"mapbox://styles/mapbox/dark-v11",thumbnail:"linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%)"},{id:"satellite",label:"Satellite",style:"mapbox://styles/mapbox/satellite-streets-v12",thumbnail:"linear-gradient(135deg, #2d5016 0%, #1a3a0f 50%, #0d2818 100%)"},{id:"light",label:"Light",style:"mapbox://styles/mapbox/light-v11",thumbnail:"linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 50%, #d0d0d0 100%)"},{id:"streets",label:"Streets",style:"mapbox://styles/mapbox/streets-v12",thumbnail:"linear-gradient(135deg, #e8e4d9 0%, #d4cfc0 50%, #b8c4a8 100%)"}];function ut(e,t,n,i="bottom-left"){const o="top-center"===i?"top-left":i,r={...t};return e.addControl(new class{onAdd(e){this._map=e;const t=document.createElement("div");t.className="mapboxgl-ctrl mapboxgl-ctrl-group";const i=(e,t,n)=>{const i=document.createElement("button");return i.type="button",i.title=t,i.setAttribute("aria-label",t),i.style.fontSize="16px",i.style.lineHeight="20px",i.style.fontWeight="600",i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="center",i.textContent=e,i.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),n()}),i};return t.appendChild(i("+","Zoom in",()=>e.zoomIn({duration:250}))),t.appendChild(i("","Zoom out",()=>e.zoomOut({duration:250}))),t.appendChild(i("","Reset view",()=>{e.easeTo({center:[r.longitude,r.latitude],zoom:Number.isFinite(r.zoom)?r.zoom:e.getZoom(),pitch:Number.isFinite(r.pitch??0)?r.pitch??0:e.getPitch(),bearing:Number.isFinite(r.bearing??0)?r.bearing??0:e.getBearing(),duration:600})})),n&&t.appendChild(((t,n)=>{const i=document.createElement("button");return i.type="button",i.title=n,i.setAttribute("aria-label",n),i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="center",i.innerHTML='<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" style="display:block">\n              <path d="M4 8h3l1.2-2h7.6L17 8h3a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2z"/>\n              <circle cx="12" cy="14" r="3.2"/>\n            </svg>',i.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),function(e){const t=`map-screenshot-${(new Date).toISOString().replace(/[:.]/g,"-")}.png`;try{const n=e.getCanvas(),i=document.createElement("a");if(i.download=t,"function"==typeof n.toBlob)return void n.toBlob(e=>{if(!e)return console.error("Screenshot failed: toBlob returned null"),void alert("Screenshot blocked (likely due to CORS/tainted canvas from raster tiles).");const t=URL.createObjectURL(e);i.href=t,document.body.appendChild(i),i.click(),i.remove(),setTimeout(()=>URL.revokeObjectURL(t),1e3)},"image/png");const o=n.toDataURL("image/png");i.href=o,document.body.appendChild(i),i.click(),i.remove()}catch(e){console.error("Screenshot failed:",e),alert("Screenshot blocked (likely due to CORS/tainted canvas from raster tiles).")}}(e)}),i})(0,"Download screenshot")),this._container=t,t}onRemove(){this._container?.parentNode?.removeChild(this._container),this._map=void 0,this._container=void 0}},o),{setHomeViewState:e=>{e&&("number"==typeof e.longitude&&Number.isFinite(e.longitude)&&(r.longitude=e.longitude),"number"==typeof e.latitude&&Number.isFinite(e.latitude)&&(r.latitude=e.latitude),"number"==typeof e.zoom&&Number.isFinite(e.zoom)&&(r.zoom=e.zoom),"number"==typeof e.pitch&&Number.isFinite(e.pitch)&&(r.pitch=e.pitch),"number"==typeof e.bearing&&Number.isFinite(e.bearing)&&(r.bearing=e.bearing))}}}function pt(e,t,n=!0){const i="boolean"==typeof n?{screenshot:n}:n,o=i.positions||{},r=o.controls??"bottom-left",l=o.scale??"bottom-left",a=o.basemap??"bottom-left";!1!==l&&function(e,t="bottom-left"){const n="top-center"===t?"top-left":t;e.addControl(new mapboxgl.ScaleControl({maxWidth:110,unit:"imperial"}),n)}(e,l);let s=null;!1!==r&&(s=ut(e,t,!1!==i.screenshot,r));const c=function(e){const t=e.getCanvasContainer?.()||e.getCanvas?.();if(!t)return()=>{};let n=!1,i=0,o=0,r=0,l=0;const a=()=>{n&&(n=!1,e.dragPan.enable(),t.style.cursor="",window.removeEventListener("pointermove",s,{passive:!1}),window.removeEventListener("pointerup",c,{passive:!1}),window.removeEventListener("pointercancel",c,{passive:!1}))},s=t=>{if(!n)return;if(!t.metaKey)return a();const s=t.clientX-i,c=t.clientY-o;var d;e.setBearing(r+.35*s),e.setPitch((d=l-.25*c,Math.max(0,Math.min(85,d)))),t.preventDefault()},c=e=>{a(),e.preventDefault()},d=a=>{if(0===a.button&&a.ctrlKey&&!a.metaKey)return a.preventDefault(),void a.stopPropagation();n||0===a.button&&a.metaKey&&(n=!0,i=a.clientX,o=a.clientY,r=e.getBearing(),l=e.getPitch(),e.dragPan.disable(),t.style.cursor="grabbing",window.addEventListener("pointermove",s,{passive:!1}),window.addEventListener("pointerup",c,{passive:!1}),window.addEventListener("pointercancel",c,{passive:!1}),a.stopPropagation(),a.preventDefault())};return t.addEventListener("pointerdown",d,{passive:!1,capture:!0}),()=>{a(),t.removeEventListener("pointerdown",d,{capture:!0})}}(e);let d=null;return!1!==i.basemapSwitcher&&!1!==a&&(d=function(e,t){const n=t.basemaps||dt;let i=(e=>{const t=n.find(t=>e.includes(t.id));return t?.id||n[0]?.id||"dark"})(t.currentStyle),o=!1;const r=document.createElement("div");r.className="fm-basemap-switcher";const l=document.createElement("button");l.type="button",l.className="fm-basemap-trigger",l.title="Change basemap",l.setAttribute("aria-label","Change basemap"),l.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/></svg>';const a=document.createElement("div");a.className="fm-basemap-options";const s=new Map;n.forEach(n=>{const l=document.createElement("button");l.type="button",l.title=n.label,l.setAttribute("data-basemap",n.id),l.className="fm-basemap-option"+(n.id===i?" is-active":"");const c=document.createElement("div");c.className="fm-basemap-option-thumb",c.style.background=n.thumbnail;const d=document.createElement("div");d.className="fm-basemap-option-label",d.textContent=n.label,l.appendChild(c),l.appendChild(d),l.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation(),s.forEach((e,t)=>{e.classList.toggle("is-active",t===n.id)}),i=n.id,o=!1,r.classList.remove("is-open"),e.setStyle(n.style),t.onStyleChange?.(n)}),l.addEventListener("mouseenter",()=>{n.id!==i&&l.classList.add("is-hover")}),l.addEventListener("mouseleave",()=>{n.id!==i&&l.classList.remove("is-hover")}),s.set(n.id,l),a.appendChild(l)});const c=()=>{o=!1,r.classList.remove("is-open")};l.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),o?c():(o=!0,r.classList.add("is-open"))});const d=e=>{o&&!r.contains(e.target)&&c()},u=e=>{o&&"Escape"===e.key&&(e.preventDefault(),c())};document.addEventListener("click",d),document.addEventListener("keydown",u),r.appendChild(l),r.appendChild(a);const p=t.position||"bottom-left",f=e.getContainer().querySelector(`.mapboxgl-ctrl-${p}`);return f&&f.insertBefore(r,f.firstChild),{destroy:()=>{document.removeEventListener("click",d),document.removeEventListener("keydown",u),r.remove()},setActive:e=>{s.get(e)&&(s.forEach((t,n)=>{t.classList.toggle("is-active",n===e)}),i=e)}}}(e,{currentStyle:i.currentStyle||"",onStyleChange:i.onStyleChange,position:a})),{destroy:()=>{c(),d?.destroy()},setHomeViewState:s?.setHomeViewState}}function ft(e){if(!e||"object"!=typeof e)return e;if(Array.isArray(e))return e;const t=e["@@function"];if("colorContinuous"===t){const t={type:"continuous",attr:e.attr,palette:e.colors};return e.domain&&(t.domain=e.domain),"number"==typeof e.steps&&(t.steps=e.steps),e.nullColor&&(t.nullColor=e.nullColor),e.reverse&&(t.reverse=e.reverse),t}if("colorCategories"===t){const t={type:"categorical",attr:e.attr};return e.colors&&(t.palette=e.colors),e.categories&&(t.categories=e.categories),e.labelAttr&&(t.labelAttr=e.labelAttr),e.nullColor&&(t.nullColor=e.nullColor),t}return e}function yt(e){if(!e||"object"!=typeof e)return{};const t={};return void 0!==e.getFillColor&&(t.fillColor=ft(e.getFillColor)),void 0!==e.getLineColor&&(t.lineColor=ft(e.getLineColor)),"number"==typeof e.opacity&&(t.opacity=e.opacity),"boolean"==typeof e.filled&&(t.filled=e.filled),"boolean"==typeof e.stroked&&(t.stroked=e.stroked),"boolean"==typeof e.extruded&&(t.extruded=e.extruded),e.elevationProperty&&(t.elevationAttr=e.elevationProperty),"number"==typeof e.elevationScale&&(t.elevationScale=e.elevationScale),"number"==typeof e.lineWidthMinPixels?t.lineWidth=e.lineWidthMinPixels:"number"==typeof e.getLineWidth&&(t.lineWidth=e.getLineWidth),"number"==typeof e.pointRadiusMinPixels?t.pointRadius=e.pointRadiusMinPixels:"number"==typeof e.pointRadius&&(t.pointRadius=e.pointRadius),t}function gt(e,t=0){const n=e=>"  ".repeat(e),i=t+1;if(null==e)return"None";const o=typeof e;if("boolean"===o)return e?"True":"False";if("number"===o)return Number.isFinite(e)?String(e):"None";if("string"===o){if(e.startsWith("@@py:")){const t=e.slice(5).trim();if(/^[A-Za-z_][A-Za-z0-9_\\.]*$/.test(t))return t}return JSON.stringify(e)}if(Array.isArray(e))return e.length?`[\n${e.map(e=>`${n(i)}${gt(e,i)}`).join(",\n")}\n${n(t)}]`:"[]";if(function(e){return!!e&&"object"==typeof e&&!Array.isArray(e)}(e)){const o=Object.keys(e);return o.length?`{\n${o.map(t=>`${n(i)}${JSON.stringify(t)}: ${gt(e[t],i)}`).join(",\n")}\n${n(t)}}`:"{}"}try{return JSON.stringify(String(e))}catch{return"None"}}function mt(e,t){try{e.innerHTML=t.map(e=>`<option value="${e}">${e}</option>`).join("")}catch(e){}}function ht(e,t,n){const i=function(e,t){try{const n=window.cartocolor?.[e];if(!n)return null;const i=Object.keys(n).map(e=>Number(e)).filter(e=>Number.isFinite(e)).sort((e,t)=>e-t),o=n[i.find(e=>e>=t)??i[i.length-1]];return Array.isArray(o)?[...o]:null}catch(e){return null}}(e,Math.max(t,3)),o=n&&i?.length?[...i].reverse():i;return o?.length?`linear-gradient(90deg, ${o.map((e,t)=>`${e} ${t/Math.max(1,o.length-1)*100}%`).join(", ")})`:"linear-gradient(90deg, #555, #999)"}function bt(e){const t=!!e.getReverse(),n=Math.max(2,Math.min(20,e.getSteps()));e.menuEl.innerHTML=e.palettes.map(e=>`<div class="pal-item" data-pal="${e}" title="${e}">\n        <div class="pal-item-swatch" style="background:${ht(e,n,t)};"></div>\n      </div>`).join(""),e.menuEl.querySelectorAll(".pal-item").forEach(t=>{t.addEventListener("click",n=>{try{n.preventDefault(),n.stopPropagation()}catch(e){}const i=t.getAttribute("data-pal")||"";i&&(e.selectEl.value=i),e.menuEl.style.display="none",vt(e);try{e.onPicked()}catch(e){}})})}function vt(e){try{const t=!!e.getReverse(),n=Math.max(2,Math.min(20,e.getSteps())),i=e.selectEl.value||"Palette";e.swatchEl.style.background=ht(i,n,t),e.triggerEl.title=i}catch(e){}}const xt="debug-shell",Ct={layerSelect:"dbg-layer-select",hexSection:"dbg-hex-section",viewStateSection:"dbg-viewstate-section",fillColorSection:"fill-color-section",lineColorSection:"line-color-section",filledEl:"dbg-filled",strokedEl:"dbg-stroked",extrudedEl:"dbg-extruded",extrusionControls:"dbg-extrusion-controls",elevAttrEl:"dbg-elev-attr",elevScaleEl:"dbg-elev-scale",opacitySliderEl:"dbg-opacity-slider",opacityEl:"dbg-opacity",fillFnEl:"dbg-fill-fn",fillFnOptions:"fill-fn-options",fillStaticOptions:"fill-static-options",fillExpressionInfo:"fill-expression-info",fillExpressionLabel:"fill-expression-label",fillAttrEl:"dbg-attr",fillPaletteEl:"dbg-palette",fillPalTrigger:"dbg-palette-trigger",fillPalSwatch:"dbg-palette-swatch",fillPalMenu:"dbg-palette-menu",fillDomainMinEl:"dbg-domain-min",fillDomainMaxEl:"dbg-domain-max",fillRangeMinEl:"dbg-domain-range-min",fillRangeMaxEl:"dbg-domain-range-max",fillStepsEl:"dbg-steps",fillReverseEl:"dbg-fill-reverse",fillNullEl:"dbg-null-color",fillNullLabel:"dbg-null-color-label",fillStaticEl:"dbg-fill-static",fillStaticLabel:"dbg-fill-static-label",lineFnEl:"dbg-line-fn",lineFnOptions:"line-fn-options",lineStaticOptions:"line-static-options",lineExpressionInfo:"line-expression-info",lineExpressionLabel:"line-expression-label",lineAttrEl:"dbg-line-attr",linePaletteEl:"dbg-line-palette",linePalTrigger:"dbg-line-palette-trigger",linePalSwatch:"dbg-line-palette-swatch",linePalMenu:"dbg-line-palette-menu",lineDomainMinEl:"dbg-line-domain-min",lineDomainMaxEl:"dbg-line-domain-max",lineReverseEl:"dbg-line-reverse",lineStaticEl:"dbg-line-static",lineStaticLabel:"dbg-line-static-label",lineWidthSliderEl:"dbg-line-width-slider",lineWidthEl:"dbg-line-width",lngEl:"dbg-lng",latEl:"dbg-lat",zoomEl:"dbg-zoom",pitchEl:"dbg-pitch",bearingEl:"dbg-bearing",viewOut:"dbg-view-output",layerOut:"dbg-output",sqlSection:"sql-section",sqlStatusEl:"sql-status",sqlInputEl:"dbg-sql",aiPromptRow:"ai-prompt-row",aiPromptInput:"ai-prompt-input",aiPromptBtn:"ai-prompt-btn",aiPromptStatus:"ai-prompt-status"};function Lt(e,t,n,i){try{e.getLayer(t)&&e.setPaintProperty(t,n,i)}catch{}}function wt(e,t,n){try{const i=e.getStyle?.()?.layers||[];for(const o of i){const i=o?.id;if(i&&i.startsWith(t)&&e.getLayer(i))for(const[t,o]of Object.entries(n))try{e.setPaintProperty(i,t,o)}catch{}}}catch{}}function Et(e){try{if(!e)return!1;const t="hex"===e.layerType,n=!!e.isTileLayer,i=!!e.parquetData||!!e.parquetUrl;return t&&!n&&i}catch(e){return!1}}function St(e,t,n){try{const i=t.getBoundingClientRect().width||280;e.style.setProperty("--debug-panel-w",`${i}px`),n.style.left=t.classList.contains("collapsed")?"0px":`var(--debug-panel-w, ${i}px)`}catch{}}function Ft(e){return e&&"object"==typeof e?"colorContinuous"!==e["@@function"]?null:e:null}function At(e){return"string"==typeof e&&e.startsWith("@@=")}function $t(e){if(e.includes("properties.r")&&e.includes("properties.g")&&e.includes("properties.b"))return"RGB from properties";const t=e.slice(3);return t.length>30?t.slice(0,27)+"...":t}function kt(e){const t=new Set;try{const n=e.hexLayer?.getFillColor,i=e.hexLayer?.getLineColor;n?.attr&&t.add(String(n.attr)),i?.attr&&t.add(String(i.attr));const o=e.tooltipColumns||e.hexLayer?.tooltipColumns,r=e.tooltipAttrs||e.hexLayer?.tooltipAttrs;Array.isArray(o)&&o.forEach(e=>{e&&"hex"!==e&&t.add(String(e))}),Array.isArray(r)&&r.forEach(e=>{e&&"hex"!==e&&t.add(String(e))})}catch(e){}return[...t].filter(Boolean)}function Tt(e){try{const t=e.geojson?.features?.[0],n=t?.properties||{};return Object.keys(n||{}).filter(e=>e&&"_fused_idx"!==e)}catch(e){return[]}}function Mt(e,n){const i=n.sidebar||(n.debug?"show":null),{shell:o,panel:r,toggle:l,resizeHandle:s}=function(){let e=document.getElementById(xt);e||(e=document.createElement("div"),e.id=xt,e.innerHTML='\n      <div id="debug-panel">\n        <div id="debug-content">\n          <div class="debug-tabs" role="tablist" aria-label="Debug tabs">\n            <button type="button" class="debug-tab-btn active" id="dbg-tab-btn-ui" data-tab="ui" role="tab" aria-selected="true">UI</button>\n            <button type="button" class="debug-tab-btn" id="dbg-tab-btn-sql" data-tab="sql" role="tab" aria-selected="false">SQL</button>\n          </div>\n\n          <div class="debug-tab-panel" id="dbg-tab-panel-ui" role="tabpanel" aria-label="UI tab">\n          <div class="debug-section">\n            <div class="debug-section-title">Editing Layer</div>\n            <div class="debug-row">\n              <span class="debug-label">Layer</span>\n              <select class="debug-select" id="dbg-layer-select"></select>\n            </div>\n          </div>\n\n          <div class="debug-section" id="dbg-hex-section">\n            <div class="debug-section-title">Style</div>\n            <div class="debug-toggles">\n              <label class="debug-checkbox"><input type="checkbox" id="dbg-filled" checked /> Filled</label>\n              <label class="debug-checkbox"><input type="checkbox" id="dbg-stroked" checked /> Stroked</label>\n              <label class="debug-checkbox"><input type="checkbox" id="dbg-extruded" /> Extruded</label>\n            </div>\n            <div id="dbg-extrusion-controls" style="display:none;margin-top:8px;">\n              <div class="debug-row">\n                <span class="debug-label">Height attr</span>\n                <select class="debug-select" id="dbg-elev-attr"></select>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label">Height scale</span>\n                <input type="number" class="debug-input debug-input-sm" id="dbg-elev-scale" step="0.1" value="1" />\n              </div>\n            </div>\n            <div class="debug-row" style="margin-top:8px;">\n              <span class="debug-label">Opacity</span>\n              <input type="range" class="debug-slider" id="dbg-opacity-slider" min="0" max="1" step="0.05" value="1" />\n              <input type="number" class="debug-input debug-input-sm" id="dbg-opacity" step="0.1" min="0" max="1" value="1" />\n            </div>\n          </div>\n\n          <div class="debug-section" id="fill-color-section">\n            <div class="debug-section-title">Fill Color</div>\n            <div class="debug-row">\n              <span class="debug-label">Function</span>\n              <select class="debug-select" id="dbg-fill-fn">\n                <option value="colorContinuous">colorContinuous</option>\n                <option value="static">Static Color</option>\n                <option value="expression">Expression</option>\n              </select>\n            </div>\n            <div id="fill-expression-info" style="display:none;">\n              <div class="debug-row">\n                <span class="debug-label"></span>\n                <span id="fill-expression-label" style="color:var(--ui-muted-2);font-size:11px;font-style:italic;">RGB from properties</span>\n              </div>\n            </div>\n            <div id="fill-fn-options">\n              <div class="debug-row">\n                <span class="debug-label">Attribute</span>\n                <select class="debug-select" id="dbg-attr"></select>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label">Palette</span>\n                <select class="debug-select pal-hidden" id="dbg-palette"></select>\n                <div class="pal-dd" id="dbg-palette-dd">\n                  <button type="button" class="pal-trigger" id="dbg-palette-trigger" title="Palette">\n                    <span class="pal-name" id="dbg-palette-name">Palette</span>\n                    <span class="pal-swatch" id="dbg-palette-swatch"></span>\n                  </button>\n                  <div class="pal-menu" id="dbg-palette-menu" style="display:none;"></div>\n                </div>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label"></span>\n                <label class="debug-checkbox" style="margin-left:auto;"><input type="checkbox" id="dbg-fill-reverse" /> Reverse</label>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label">Domain</span>\n                <input type="number" class="debug-input debug-input-sm" id="dbg-domain-min" step="0.1" placeholder="min" />\n                <span style="color:#666;"></span>\n                <input type="number" class="debug-input debug-input-sm" id="dbg-domain-max" step="0.1" placeholder="max" />\n              </div>\n            <div class="debug-row">\n              <span class="debug-label"></span>\n              <div class="debug-dual-range" aria-label="Domain range">\n                <input type="range" class="debug-range-min" id="dbg-domain-range-min" min="0" max="100" step="0.1" value="0" />\n                <input type="range" class="debug-range-max" id="dbg-domain-range-max" min="0" max="100" step="0.1" value="100" />\n              </div>\n            </div>\n              <div class="debug-row">\n                <span class="debug-label">Steps</span>\n                <input type="number" class="debug-input debug-input-sm" id="dbg-steps" step="1" min="2" max="20" value="7" />\n              </div>\n              <div class="debug-row">\n                <span class="debug-label">Null Color</span>\n                <input type="color" class="debug-color" id="dbg-null-color" value="#b8b8b8" />\n                <span class="debug-color-label" id="dbg-null-color-label">#b8b8b8</span>\n              </div>\n            </div>\n            <div id="fill-static-options" style="display:none;">\n              <div class="debug-row">\n                <span class="debug-label">Color</span>\n                <input type="color" class="debug-color" id="dbg-fill-static" value="#0090ff" />\n                <span class="debug-color-label" id="dbg-fill-static-label">#0090ff</span>\n              </div>\n            </div>\n          </div>\n\n          <div class="debug-section" id="line-color-section">\n            <div class="debug-section-title">Line Color</div>\n            <div class="debug-row">\n              <span class="debug-label">Function</span>\n              <select class="debug-select" id="dbg-line-fn">\n                <option value="colorContinuous">colorContinuous</option>\n                <option value="static" selected>Static Color</option>\n                <option value="expression">Expression</option>\n              </select>\n            </div>\n            <div id="line-expression-info" style="display:none;">\n              <div class="debug-row">\n                <span class="debug-label"></span>\n                <span id="line-expression-label" style="color:var(--ui-muted-2);font-size:11px;font-style:italic;">RGB from properties</span>\n              </div>\n            </div>\n            <div id="line-fn-options" style="display:none;">\n              <div class="debug-row">\n                <span class="debug-label">Attribute</span>\n                <select class="debug-select" id="dbg-line-attr"></select>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label">Palette</span>\n                <select class="debug-select pal-hidden" id="dbg-line-palette"></select>\n                <div class="pal-dd" id="dbg-line-palette-dd">\n                  <button type="button" class="pal-trigger" id="dbg-line-palette-trigger" title="Palette">\n                    <span class="pal-name" id="dbg-line-palette-name">Palette</span>\n                    <span class="pal-swatch" id="dbg-line-palette-swatch"></span>\n                  </button>\n                  <div class="pal-menu" id="dbg-line-palette-menu" style="display:none;"></div>\n                </div>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label"></span>\n                <label class="debug-checkbox" style="margin-left:auto;"><input type="checkbox" id="dbg-line-reverse" /> Reverse</label>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label">Domain</span>\n                <input type="number" class="debug-input debug-input-sm" id="dbg-line-domain-min" step="0.1" placeholder="min" />\n                <span style="color:#666;"></span>\n                <input type="number" class="debug-input debug-input-sm" id="dbg-line-domain-max" step="0.1" placeholder="max" />\n              </div>\n            </div>\n            <div id="line-static-options">\n              <div class="debug-row">\n                <span class="debug-label">Color</span>\n                <input type="color" class="debug-color" id="dbg-line-static" value="#ffffff" />\n                <span class="debug-color-label" id="dbg-line-static-label">#ffffff</span>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label">Line Width</span>\n                <input type="range" class="debug-slider" id="dbg-line-width-slider" min="0" max="5" step="0.5" value="1" />\n                <input type="number" class="debug-input debug-input-sm" id="dbg-line-width" step="0.5" min="0" max="10" value="1" />\n              </div>\n            </div>\n          </div>\n\n          <div class="debug-section" id="dbg-viewstate-section">\n            <div class="debug-section-title">View State</div>\n            <div class="debug-row">\n              <span class="debug-label">Longitude</span>\n              <input type="number" class="debug-input" id="dbg-lng" step="0.0001" />\n            </div>\n            <div class="debug-row">\n              <span class="debug-label">Latitude</span>\n              <input type="number" class="debug-input" id="dbg-lat" step="0.0001" />\n            </div>\n            <div class="debug-row">\n              <span class="debug-label">Zoom</span>\n              <input type="number" class="debug-input" id="dbg-zoom" step="0.1" min="0" max="22" />\n            </div>\n            <div class="debug-row">\n              <span class="debug-label">Pitch</span>\n              <input type="number" class="debug-input" id="dbg-pitch" step="1" min="0" max="85" />\n            </div>\n            <div class="debug-row">\n              <span class="debug-label">Bearing</span>\n              <input type="number" class="debug-input" id="dbg-bearing" step="1" />\n            </div>\n          </div>\n\n          <div class="debug-section">\n            <details id="dbg-view-details">\n              <summary class="debug-section-title" style="cursor:pointer; user-select:none;">Current ViewState</summary>\n              <textarea id="dbg-view-output" class="debug-output" readonly></textarea>\n            </details>\n          </div>\n\n          <div class="debug-section">\n            <div class="debug-section-title">Layer Config</div>\n            <textarea id="dbg-output" class="debug-output" readonly></textarea>\n          </div>\n          </div>\n\n          <div class="debug-tab-panel" id="dbg-tab-panel-sql" role="tabpanel" aria-label="SQL tab" style="display:none;">\n            <div class="debug-section" id="sql-section">\n              <div class="debug-section-title">SQL <span id="sql-status" style="float:right;font-weight:normal;color:var(--ui-muted-2);"></span></div>\n              <textarea id="dbg-sql" class="debug-output" style="height:120px;font-family:monospace;font-size:11px;resize:vertical;" placeholder="WHERE expression (e.g. data = 111)\nor\nFull SQL (SELECT ... FROM data ...)"></textarea>\n              <div id="ai-prompt-row" class="ai-prompt-row" style="display:none;">\n                <input type="text" id="ai-prompt-input" class="debug-input" placeholder="Ask AI: &quot;filter to corn areas over 50%&quot;" />\n                <button type="button" id="ai-prompt-btn" class="ai-prompt-btn" title="Generate SQL">AI</button>\n                <span id="ai-prompt-status" class="ai-prompt-status"></span>\n              </div>\n            </div>\n          </div>\n        </div>\n        <div id="debug-resize-handle" title="Drag to resize"></div>\n      </div>\n      <div id="debug-toggle" title="Toggle sidebar">&#x2039;</div>\n  ',document.body.appendChild(e));const t=document.getElementById("debug-panel"),n=document.getElementById("debug-toggle"),i=document.getElementById("debug-resize-handle");if(!t||!n||!i)throw new Error("[FusedMaps] Debug panel DOM missing expected elements");return{shell:e,panel:t,toggle:n,resizeHandle:i}}();try{"hide"===i?(r.classList.add("collapsed"),l.innerHTML="&#x203A;"):(r.classList.remove("collapsed"),l.innerHTML="&#x2039;"),St(o,r,l)}catch(e){}const{layerSelect:u,hexSection:m,viewStateSection:h,fillColorSection:b,lineColorSection:v,filledEl:x,strokedEl:C,extrudedEl:L,extrusionControls:w,elevAttrEl:E,elevScaleEl:S,opacitySliderEl:F,opacityEl:A,fillFnEl:$,fillFnOptions:k,fillStaticOptions:T,fillExpressionInfo:M,fillExpressionLabel:N,fillAttrEl:O,fillPaletteEl:_,fillPalTrigger:P,fillPalSwatch:I,fillPalMenu:j,fillDomainMinEl:R,fillDomainMaxEl:q,fillRangeMinEl:D,fillRangeMaxEl:B,fillStepsEl:z,fillReverseEl:U,fillNullEl:W,fillNullLabel:H,fillStaticEl:V,fillStaticLabel:Z,lineFnEl:G,lineFnOptions:J,lineStaticOptions:Y,lineExpressionInfo:Q,lineExpressionLabel:X,lineAttrEl:K,linePaletteEl:ee,linePalTrigger:te,linePalSwatch:ne,linePalMenu:ie,lineDomainMinEl:oe,lineDomainMaxEl:re,lineReverseEl:le,lineStaticEl:ae,lineStaticLabel:se,lineWidthSliderEl:ce,lineWidthEl:de,lngEl:ue,latEl:pe,zoomEl:fe,pitchEl:ye,bearingEl:ge,viewOut:me,layerOut:he,sqlSection:be,sqlStatusEl:ve,sqlInputEl:xe,aiPromptRow:Ce,aiPromptInput:Le,aiPromptBtn:we,aiPromptStatus:Ee}=function(){const e={};for(const[t,n]of Object.entries(Ct)){const i=document.getElementById(n);if(!i)throw new Error(`[FusedMaps] Debug panel missing element #${n}`);e[t]=i}return e}(),Se=document.getElementById("dbg-tab-btn-ui"),Ae=document.getElementById("dbg-tab-btn-sql"),$e=document.getElementById("dbg-tab-panel-ui"),Te=document.getElementById("dbg-tab-panel-sql"),Me=n.layers.some(e=>"hex"===e.layerType&&!e.isTileLayer&&(e.parquetUrl||e.parquetData));!Me&&Ae&&(Ae.style.display="none");let Ne=null;const Oe=(e,t=!0)=>{"sql"!==e||Me||(e="ui");try{if($e&&($e.style.display="ui"===e?"block":"none"),Te&&(Te.style.display="sql"===e?"block":"none"),Se&&(Se.classList.toggle("active","ui"===e),Se.setAttribute("aria-selected","ui"===e?"true":"false")),Ae&&(Ae.classList.toggle("active","sql"===e),Ae.setAttribute("aria-selected","sql"===e?"true":"false")),t)try{localStorage.setItem("fusedmaps:debug:tab",e)}catch(e){}}catch(e){}try{"sql"===e&&Ne?.onTabActivated()}catch(e){}},_e=e=>{const t=e?.currentTarget,n=String(t?.getAttribute?.("data-tab")||"").toLowerCase();"ui"!==n&&"sql"!==n||Oe(n,!0)};try{Se?.addEventListener("click",_e),Ae?.addEventListener("click",_e)}catch(e){}Oe("ui",!1);const Pe=function(){try{return Object.keys(window.cartocolor||{}).sort((e,t)=>e.localeCompare(t))}catch(e){return[]}}();mt(_,Pe),mt(ee,Pe);const Ie=()=>{const e=parseInt(z?.value||"7",10);return Number.isFinite(e)?Math.max(2,Math.min(20,e)):7},je=function(e){const t=[],n=[],i=()=>{try{t.forEach(e=>{try{e.style.display="none"}catch(e){}})}catch(e){}},o=()=>i();try{document.addEventListener("click",o),window.addEventListener("blur",o)}catch(e){}return{attach:o=>{const r={...o,palettes:e,closeAll:i};t.push(r.menuEl);try{bt(r),vt(r)}catch(e){}const l=e=>{try{e.preventDefault(),e.stopPropagation()}catch(e){}const t="none"!==r.menuEl.style.display;r.closeAll();try{bt(r),vt(r)}catch(e){}r.menuEl.style.display=t?"none":"block"};try{r.triggerEl.addEventListener("click",l)}catch(e){}const a={refresh:()=>{try{bt(r),vt(r)}catch(e){}},destroy:()=>{try{r.triggerEl.removeEventListener("click",l)}catch(e){}try{const e=t.indexOf(r.menuEl);e>=0&&t.splice(e,1)}catch(e){}}};return n.push(a),a},refreshAll:()=>{try{n.forEach(e=>e.refresh())}catch(e){}},destroy:()=>{try{n.forEach(e=>e.destroy())}catch(e){}try{document.removeEventListener("click",o),window.removeEventListener("blur",o)}catch(e){}}}}(Pe),Re=je.attach({selectEl:_,menuEl:j,swatchEl:I,triggerEl:P,getSteps:Ie,getReverse:()=>!!U.checked,onPicked:()=>et()}),qe=je.attach({selectEl:ee,menuEl:ie,swatchEl:ne,triggerEl:te,getSteps:Ie,getReverse:()=>!!le.checked,onPicked:()=>et()}),De=n.layers.filter(e=>"hex"===e.layerType||"vector"===e.layerType||"pmtiles"===e.layerType);u.innerHTML=De.map(e=>`<option value="${e.id}">${e.name||e.id}</option>`).join(""),!u.value&&De.length&&(u.value=De[0].id);const Be=()=>{const e=u.value;return De.find(t=>t.id===e)||null},ze=()=>{try{const e=n.__deckOverlay||null,t=e?.__fused_hex_tiles__;t?.rebuild?.()}catch(e){}try{window.dispatchEvent(new CustomEvent("fusedmaps:legend:update"))}catch(e){}},Ue=()=>{try{const t=(e._controls||[]).find(e=>e&&e.__fused_hex_tiles__);n.__deckOverlay=t||n.__deckOverlay}catch(e){}};Ue();const We=()=>{try{const e=2e5,t=e=>{const t={name:e.name};if(!1===e.visible&&(t.visible=!1),"hex"===e.layerType){const n=yt(e.hexLayer||{}),i={};if(Object.keys(n).length&&(i.style=n),e.isTileLayer&&e.tileUrl){t.type="hex",t.tile_url=e.tileUrl;const n=e.tileLayerConfig||e.tileLayer||null;if(n&&"object"==typeof n){const e={};"number"==typeof n.minZoom&&(e.minZoom=n.minZoom),"number"==typeof n.maxZoom&&(e.maxZoom=n.maxZoom),"number"==typeof n.zoomOffset&&(e.zoomOffset=n.zoomOffset),Object.keys(e).length&&(i.tile=e)}}else t.type="hex",e.parquetUrl&&(t.parquetUrl=e.parquetUrl),e.sql&&(t.sql=e.sql),e.parquetUrl||(t.data=e.dataRef?`@@py:${String(e.dataRef)}`:null);return Object.keys(i).length&&(t.config=i),t}if("vector"===e.layerType){t.type="vector",t.data=e.dataRef?`@@py:${String(e.dataRef)}`:null;const n=yt(e.vectorLayer||{});return Object.keys(n).length&&(t.config={style:n}),t}if("mvt"===e.layerType){t.type="vector",t.tile_url=e.tileUrl,t.source_layer=e.sourceLayer||"udf";const n={};return e.fillColorConfig?n.fillColor=yt({getFillColor:e.fillColorConfig}).fillColor:e.fillColor&&(n.fillColor=e.fillColor),e.lineColorConfig?n.lineColor=yt({getLineColor:e.lineColorConfig}).lineColor:e.lineColor&&(n.lineColor=e.lineColor),"number"==typeof e.lineWidth&&(n.lineWidth=e.lineWidth),"number"==typeof e.fillOpacity&&(n.opacity=e.fillOpacity),Object.keys(n).length&&(t.config={style:n}),t}if("pmtiles"===e.layerType){t.type="pmtiles",e.pmtilesPath?t.pmtiles_path=e.pmtilesPath:t.pmtiles_url=e.pmtilesUrl,e.sourceLayer&&(t.source_layer=e.sourceLayer),"number"==typeof e.minzoom&&(t.minzoom=e.minzoom),"number"==typeof e.maxzoom&&(t.maxzoom=e.maxzoom);const n={...e.vectorLayer||{}};e.fillColorConfig&&(n.getFillColor=e.fillColorConfig),e.lineColorConfig&&(n.getLineColor=e.lineColorConfig),"number"==typeof e.fillOpacity&&(n.opacity=e.fillOpacity),"number"==typeof e.lineWidth&&(n.lineWidthMinPixels=e.lineWidth),"number"==typeof e.pointRadiusMinPixels&&(n.pointRadiusMinPixels=e.pointRadiusMinPixels),"boolean"==typeof e.isFilled&&(n.filled=e.isFilled),"boolean"==typeof e.isStroked&&(n.stroked=e.isStroked);const i=yt(n);return Object.keys(i).length&&(t.config={style:i}),t}if("raster"===e.layerType){t.type="raster",e.tileUrl&&(t.tile_url=e.tileUrl),e.imageUrl&&(t.image_url=e.imageUrl),e.imageBounds&&(t.bounds=e.imageBounds);const n=e.opacity??e.rasterLayer?.opacity;return"number"==typeof n&&Number.isFinite(n)&&1!==n&&(t.config={style:{opacity:n}}),t}return t};let i=`layers = ${gt((n.layers||[]).map(t),0)}`;i.length>e&&(i=i.slice(0,e)+"\n... (truncated)\n"),he.value=i}catch(e){he.value=""}};Ne=function(e){const{sqlSection:t,sqlStatusEl:n,sqlInputEl:i,getActiveLayer:o,updateLayerOutput:r}=e;try{t.style.display="block"}catch(e){}let l=null,a=null,s=!1,c=!1,d=!1;const u=()=>{if(d)return;const e=o();if(!Et(e))return;const t=(()=>{try{if(a)return String(a.getValue()||"").trim()}catch(e){}return String(i.value||"").trim()})()||"SELECT * FROM data";try{e.sql=t}catch(e){}try{r()}catch(e){}try{n.textContent="typing..."}catch(e){}clearTimeout(l),l=setTimeout(()=>{try{window.dispatchEvent(new CustomEvent("fusedmaps:sql:update",{detail:{layerId:e.id,sql:t}}))}catch(e){}},500)},p=()=>{try{if(!a||c)return;c=!0,a.on("change",()=>u())}catch(e){}},f=()=>u();try{i.addEventListener("input",f)}catch(e){}const y=e=>{try{const t=e?.detail||{},i=String(t.layerId||""),r=String(t.status||""),l=o();if(!l||String(l.id)!==i)return;n.textContent=r}catch(e){}};try{window.addEventListener("fusedmaps:sql:status",y)}catch(e){}return{onTabActivated:()=>{(async()=>{try{if(a||s)return;if(s=!0,window.CodeMirror){try{const e=window.CodeMirror;a=e.fromTextArea(i,{mode:"text/x-sql",theme:"material-darker",lineNumbers:!1,gutters:[],lineWrapping:!0,indentUnit:2,tabSize:2,indentWithTabs:!1}),a.setSize("100%","180px")}catch(e){}return void p()}const e=e=>{if(document.querySelector(`link[href="${e}"]`))return;const t=document.createElement("link");t.rel="stylesheet",t.href=e,document.head.appendChild(t)};e("https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css"),e("https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-darker.min.css");const t=e=>new Promise((t,n)=>{if(document.querySelector(`script[src="${e}"]`))return t();const i=document.createElement("script");i.src=e,i.async=!0,i.onload=()=>t(),i.onerror=()=>n(new Error(`failed to load ${e}`)),document.head.appendChild(i)});await t("https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"),await t("https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/sql/sql.min.js");try{const e=window.CodeMirror;if(!e)return;a=e.fromTextArea(i,{mode:"text/x-sql",theme:"material-darker",lineNumbers:!1,gutters:[],lineWrapping:!0,indentUnit:2,tabSize:2,indentWithTabs:!1}),a.setSize("100%","180px")}catch(e){}p()}finally{s=!1}})().then(()=>{try{a?.refresh?.()}catch(e){}})},syncFromLayer:e=>{const t=Et(e);d=!0;try{i.disabled=!t,t?(i.value=String(e.sql||"SELECT * FROM data"),i.placeholder="SELECT * FROM data"):(i.value="",i.placeholder="Select a DuckDB (parquetUrl/parquetData) hex layer to enable SQL.")}catch(e){}try{if(a){t?(a.setValue(String(e.sql||"SELECT * FROM data")),a.setOption("readOnly",!1)):(a.setValue("-- Select a DuckDB-backed hex layer to enable SQL"),a.setOption("readOnly","nocursor"));try{a.refresh?.()}catch(e){}}}catch(e){}d=!1;try{n.textContent=t?"":"disabled"}catch(e){}},applySql:e=>{const t=o();if(Et(t)){d=!0;try{i.value=e,a&&a.setValue(e),t.sql=e,r()}catch(e){}d=!1;try{window.dispatchEvent(new CustomEvent("fusedmaps:sql:update",{detail:{layerId:t.id,sql:e}}))}catch(e){}}},destroy:()=>{try{clearTimeout(l)}catch(e){}try{i.removeEventListener("input",f)}catch(e){}try{window.removeEventListener("fusedmaps:sql:status",y)}catch(e){}try{a?.toTextArea?.()}catch(e){}a=null}}}({sqlSection:be,sqlStatusEl:ve,sqlInputEl:xe,getActiveLayer:()=>Be(),updateLayerOutput:We});const He=n.aiUdfUrl,Ve=n.aiSchema,Ze=n.aiContext;if(He)try{Ce.style.display="flex"}catch(e){}const Ge=async()=>{if(!He)return;const e=Le.value.trim();if(e)try{we.disabled=!0,Le.disabled=!0,Ee.textContent="thinking...",Ee.style.color="var(--ui-muted-2)";let t=He+(He.includes("?")?"&":"?")+"prompt="+encodeURIComponent(e);Ve&&(t+="&schema="+encodeURIComponent(Ve)),Ze&&(t+="&context="+encodeURIComponent(Ze));const n=await fetch(t);if(!n.ok)throw new Error(`HTTP ${n.status}`);let i=await n.text();i=i.trim().replace(/^["']|["']$/g,"").replace(/```sql/gi,"").replace(/```/g,"").trim(),Ne?.applySql(i),Ee.textContent="",Le.value=""}catch(e){Ee.textContent=e?.message||"error",Ee.style.color="#ff6b6b"}finally{we.disabled=!1,Le.disabled=!1}};try{Le.addEventListener("keypress",e=>{"Enter"===e.key&&Ge()}),we.addEventListener("click",Ge)}catch(e){}const Je=()=>{const e=$.value;k.style.display="colorContinuous"===e?"block":"none",T.style.display="static"===e?"block":"none",M.style.display="expression"===e?"block":"none",$.disabled="expression"===e},Ye=()=>{const e=G.value;J.style.display="colorContinuous"===e?"block":"none",Y.style.display="static"===e?"block":"none",Q.style.display="expression"===e?"block":"none",G.disabled="expression"===e},Qe=()=>{try{b&&(b.style.display=x.checked?"block":"none")}catch(e){}},Xe=()=>{try{v&&(v.style.display=C.checked?"block":"none")}catch(e){}},Ke=()=>{const e=Be();if(!e)return;const t="hex"===e.layerType,n="vector"===e.layerType,i="pmtiles"===e.layerType,o=t&&e.hexLayer||{};try{m&&(m.style.display=t||n||i?"block":"none")}catch(e){}try{h&&(h.style.display="block")}catch(e){}t?(x.checked=!1!==o.filled,C.checked=!1!==o.stroked,L.checked=!0===o.extruded):(x.checked=!1!==e.isFilled,C.checked=!1!==e.isStroked,L.checked=!1),Qe(),Xe();try{const n=L?.parentElement;if(n&&(n.style.display=t?"":"none"),w&&(w.style.display=t&&L.checked?"block":"none"),t&&E){const t=kt(e),n=[""].concat(t||[]);E.innerHTML=n.map(e=>e?`<option value="${e}">${e}</option>`:'<option value="">(use fill attr)</option>').join(""),E.value=String(o.elevationProperty||"")}t&&S&&(S.value=String("number"==typeof o.elevationScale&&Number.isFinite(o.elevationScale)?o.elevationScale:1))}catch(e){}const r=t?"number"==typeof o.opacity?o.opacity:1:"number"==typeof e.opacity?e.opacity:.9;if(F.value=String(r),A.value=String(r),t){const t=o.getFillColor;if(At(t)){$.value="expression",$.disabled=!0,N.textContent=$t(t);const n=kt(e);n.length&&(O.innerHTML=n.map(e=>`<option value="${e}">${e}</option>`).join(""))}else $.disabled=!1;const n=Ft(t);if(!At(t)&&n){$.value="colorContinuous",O.innerHTML=kt(e).map(e=>`<option value="${e}">${e}</option>`).join(""),n.attr&&(O.value=String(n.attr)),n.colors&&(_.value=String(n.colors));try{U.checked=!!n.reverse}catch(e){U.checked=!1}try{Re.refresh()}catch(e){}const t=Array.isArray(n.domain)?n.domain:[0,1];R.value=g(Number(t[0]),2),q.value=g(Number(t[1]),2);try{const e=Math.min(Number(t[0]),Number(t[1])),n=Math.max(Number(t[0]),Number(t[1]));Number.isFinite(e)&&Number.isFinite(n)&&(D.min=String(e),D.max=String(n),B.min=String(e),B.max=String(n),D.step="0.1",B.step="0.1",D.value=String(Number(t[0])),B.value=String(Number(t[1])))}catch(e){}z.value=String(n.steps??7);const i=y(Array.isArray(n.nullColor)?n.nullColor:[184,184,184]);W.value=i,H.textContent=i}else if(!At(t)&&Array.isArray(t)){$.value="static";try{U.checked=!1}catch{}const n=y(t);V.value=n,Z.textContent=n;const i=kt(e);i.length&&(O.innerHTML=i.map(e=>`<option value="${e}">${e}</option>`).join(""))}else if(!At(t)){$.value="colorContinuous";try{U.checked=!1}catch(e){}const t=kt(e);t.length&&(O.innerHTML=t.map(e=>`<option value="${e}">${e}</option>`).join(""))}}else if(n||i){const t=e,n=t.fillColorConfig,o=(()=>{if(!i)return Tt(e);const o=new Set;return n?.attr&&o.add(String(n.attr)),t.lineColorConfig?.attr&&o.add(String(t.lineColorConfig.attr)),t.colorAttribute&&o.add(String(t.colorAttribute)),o.add("value"),[...o].filter(Boolean)})();if(O.innerHTML=o.map(e=>`<option value="${e}">${e}</option>`).join(""),n&&"object"==typeof n&&"colorContinuous"===n["@@function"]){$.value="colorContinuous",n.attr&&(O.value=String(n.attr)),n.colors&&(_.value=String(n.colors));try{U.checked=!!n.reverse}catch(e){U.checked=!1}try{Re.refresh()}catch(e){}const e=Array.isArray(n.domain)?n.domain:[0,1];R.value=g(Number(e[0]),2),q.value=g(Number(e[1]),2);try{const t=Math.min(Number(e[0]),Number(e[1])),n=Math.max(Number(e[0]),Number(e[1]));Number.isFinite(t)&&Number.isFinite(n)&&(D.min=String(t),D.max=String(n),B.min=String(t),B.max=String(n),D.step="0.1",B.step="0.1",D.value=String(Number(e[0])),B.value=String(Number(e[1])))}catch(e){}z.value=String(n.steps??7);const t=y(Array.isArray(n.nullColor)?n.nullColor:[184,184,184]);W.value=t,H.textContent=t}else{$.value="static";try{U.checked=!1}catch(e){}V.value="#0090ff",Z.textContent=V.value}}if(t){const t=o.getLineColor;if(At(t)){G.value="expression",G.disabled=!0,X.textContent=$t(t);const n=kt(e);n.length&&(K.innerHTML=n.map(e=>`<option value="${e}">${e}</option>`).join(""))}else G.disabled=!1;const n=Ft(t);if(!At(t)&&n){G.value="colorContinuous",K.innerHTML=kt(e).map(e=>`<option value="${e}">${e}</option>`).join(""),n.attr&&(K.value=String(n.attr)),n.colors&&(ee.value=String(n.colors));try{le.checked=!!n.reverse}catch(e){le.checked=!1}try{qe.refresh()}catch(e){}const t=Array.isArray(n.domain)?n.domain:[0,1];oe.value=g(Number(t[0]),2),re.value=g(Number(t[1]),2)}else if(!At(t)&&Array.isArray(t)){G.value="static";try{le.checked=!1}catch{}const n=y(t);ae.value=n,se.textContent=n;const i=kt(e);i.length&&(K.innerHTML=i.map(e=>`<option value="${e}">${e}</option>`).join(""))}else if(!At(t)){G.value="static";try{le.checked=!1}catch{}const t=kt(e);t.length&&(K.innerHTML=t.map(e=>`<option value="${e}">${e}</option>`).join(""))}}else if(n||i){const t=e,n=t.lineColorConfig,o=(()=>{if(!i)return Tt(e);const o=new Set;return n?.attr&&o.add(String(n.attr)),t.fillColorConfig?.attr&&o.add(String(t.fillColorConfig.attr)),t.colorAttribute&&o.add(String(t.colorAttribute)),o.add("value"),[...o].filter(Boolean)})();if(K.innerHTML=o.map(e=>`<option value="${e}">${e}</option>`).join(""),n&&"object"==typeof n&&"colorContinuous"===n["@@function"]){G.value="colorContinuous",n.attr&&(K.value=String(n.attr)),n.colors&&(ee.value=String(n.colors));try{le.checked=!!n.reverse}catch(e){le.checked=!1}try{qe.refresh()}catch(e){}const e=Array.isArray(n.domain)?n.domain:[0,1];oe.value=g(Number(e[0]),2),re.value=g(Number(e[1]),2)}else{G.value="static";try{le.checked=!1}catch(e){}}}const l=t?o.lineWidthMinPixels??1:e.lineWidth??1;ce.value=String(l),de.value=String(l),Je(),Ye(),We();try{Ne?.syncFromLayer(e)}catch(e){}},et=()=>{const t=Be();t&&function(e){const{map:t,layer:n,els:i,updateLayerOutput:o,findDeckOverlayOnMap:r,rebuildDeck:l}=e;if(!n)return;const s="hex"===n.layerType,u="vector"===n.layerType,y="pmtiles"===n.layerType;s&&(n.hexLayer=n.hexLayer||{});const g=s?n.hexLayer:{},m=parseFloat(i.opacityEl.value),h=Number.isFinite(m)?p(m,0,1):1;if(s){g.filled=!!i.filledEl.checked,g.stroked=!!i.strokedEl.checked,g.extruded=!!i.extrudedEl.checked,g.opacity=h;try{i.extrusionControls&&(i.extrusionControls.style.display=g.extruded?"block":"none");const e=parseFloat(i.elevScaleEl?.value||"1");g.elevationScale=Number.isFinite(e)?e:1;const t=String(i.elevAttrEl?.value||"").trim();t?g.elevationProperty=t:delete g.elevationProperty}catch(e){}}else if(u||y){n.isFilled=!!i.filledEl.checked,n.isStroked=!!i.strokedEl.checked,n.opacity=h;try{n.vectorLayer={...n.vectorLayer||{},filled:!!i.filledEl.checked,stroked:!!i.strokedEl.checked,opacity:h}}catch(e){}}if(s)if("static"===i.fillFnEl.value){const e=i.fillStaticEl.value||"#0090ff",t=parseInt(e.slice(1,3),16),n=parseInt(e.slice(3,5),16),o=parseInt(e.slice(5,7),16);g.getFillColor=[t,n,o]}else{const e=i.fillAttrEl.value||"data_avg",t=i.fillPaletteEl.value||"Earth",n=!!i.fillReverseEl.checked,o=parseFloat(i.fillDomainMinEl.value),r=parseFloat(i.fillDomainMaxEl.value),l=parseInt(i.fillStepsEl.value||"7",10),a=i.fillNullEl.value||"#b8b8b8",s=parseInt(a.slice(1,3),16),c=parseInt(a.slice(3,5),16),d=parseInt(a.slice(5,7),16);g.getFillColor={"@@function":"colorContinuous",attr:e,domain:[Number.isFinite(o)?o:0,Number.isFinite(r)?r:1],colors:t,reverse:n,steps:Number.isFinite(l)?l:7,nullColor:[s,c,d],autoDomain:!1!==g.getFillColor?.autoDomain}}else if(u||y)if("static"===i.fillFnEl.value){const e=i.fillStaticEl.value||"#0090ff";n.fillColorConfig=null,n.fillColorRgba=e;try{const t=f(e,200)||f(e);n.vectorLayer&&(n.vectorLayer.getFillColor=t||e)}catch{}}else{const e=i.fillAttrEl.value||"value",t=i.fillPaletteEl.value||"ArmyRose",o=!!i.fillReverseEl.checked,r=parseFloat(i.fillDomainMinEl.value),l=parseFloat(i.fillDomainMaxEl.value),a=parseInt(i.fillStepsEl.value||"7",10),s=i.fillNullEl.value||"#b8b8b8",c=parseInt(s.slice(1,3),16),d=parseInt(s.slice(3,5),16),u=parseInt(s.slice(5,7),16);n.fillColorRgba=null;const p={"@@function":"colorContinuous",attr:e,domain:[Number.isFinite(r)?r:0,Number.isFinite(l)?l:1],colors:t,reverse:o,steps:Number.isFinite(a)?a:7,nullColor:[c,d,u]};n.fillColorConfig=p,y&&(n.colorAttribute=e);try{n.vectorLayer&&(n.vectorLayer.getFillColor=p)}catch(e){}}if(s)if("static"===i.lineFnEl.value){const e=i.lineStaticEl.value||"#ffffff",t=parseInt(e.slice(1,3),16),n=parseInt(e.slice(3,5),16),o=parseInt(e.slice(5,7),16);g.getLineColor=[t,n,o]}else{const e=i.lineAttrEl.value||"data_avg",t=i.linePaletteEl.value||"Earth",n=!!i.lineReverseEl.checked,o=parseFloat(i.lineDomainMinEl.value),r=parseFloat(i.lineDomainMaxEl.value);g.getLineColor={"@@function":"colorContinuous",attr:e,domain:[Number.isFinite(o)?o:0,Number.isFinite(r)?r:1],colors:t,reverse:n,steps:parseInt(i.fillStepsEl.value||"7",10)||7,autoDomain:!1!==g.getLineColor?.autoDomain}}else if(u||y)if("static"===i.lineFnEl.value){const e=i.lineStaticEl.value||"#ffffff";n.lineColorConfig=null,n.lineColorRgba=e;try{const t=f(e,255)||f(e);n.vectorLayer&&(n.vectorLayer.getLineColor=t||e)}catch{}}else{const e=i.lineAttrEl.value||"value",t=i.linePaletteEl.value||"ArmyRose",o=!!i.lineReverseEl.checked,r=parseFloat(i.lineDomainMinEl.value),l=parseFloat(i.lineDomainMaxEl.value);n.lineColorRgba=null;const a={"@@function":"colorContinuous",attr:e,domain:[Number.isFinite(r)?r:0,Number.isFinite(l)?l:1],colors:t,reverse:o,steps:parseInt(i.fillStepsEl.value||"7",10)||7};n.lineColorConfig=a;try{n.vectorLayer&&(n.vectorLayer.getLineColor=a)}catch(e){}}const b=parseFloat(i.lineWidthEl.value),v=Number.isFinite(b)?p(b,0,10):1;if(s)g.lineWidthMinPixels=v;else if(u||y){n.lineWidth=v;try{n.vectorLayer&&(n.vectorLayer.lineWidthMinPixels=v)}catch(e){}}o(),r(),l();try{if("hex"===n.layerType&&!n.isTileLayer){const e=n.parquetData||n.parquetUrl?ke()?.[n.id]||{type:"FeatureCollection",features:[]}:c(n.data||[]),i=function(e,t){try{const n=e.getStyle?.(),i=n?.layers||[],o=[`${t}-fill`,`${t}-extrusion`,`${t}-outline`];for(const e of o){const t=i.find(t=>t&&t.id===e);if(t)return"none"!==t.layout?.visibility}}catch{}return!0}(t,n.id);!function(e,t,n,i){try{const i=e.getSource(t.id);i&&"function"==typeof i.setData?i.setData(n):e.addSource(t.id,{type:"geojson",data:n})}catch(e){}!function(e,t){const n=[`${t}-fill`,`${t}-extrusion`,`${t}-outline`];for(const t of n)try{e.getLayer(t)&&e.removeLayer(t)}catch(e){}}(e,t.id),d(e,t,n,i)}(t,n,e,i)}}catch(e){}try{if(u){const e=n,i=e.geojson?.features?.map(e=>e?.properties||{})||[],o=e.fillColorConfig?.["@@function"]?a(e.fillColorConfig,i):e.fillColorRgba||"#0090ff",r=e.lineColorConfig?.["@@function"]?a(e.lineColorConfig,i):e.lineColorRgba||"#ffffff",l=!1===e.isFilled?0:h,s=!1===e.isStroked?0:1;wt(t,`${e.id}-`,{"fill-color":o,"fill-opacity":l,"line-color":r,"line-width":v,"line-opacity":s}),Lt(t,`${e.id}-circle`,"circle-color",o),Lt(t,`${e.id}-circle`,"circle-opacity",l),Lt(t,`${e.id}-circle`,"circle-stroke-color",r),Lt(t,`${e.id}-circle`,"circle-stroke-width",v)}}catch{}try{if(y){const e=n,i=!1===e.isFilled?0:h,o=!1===e.isStroked?0:1,r=e.colorAttribute||"value",l=e.fillColorConfig?Fe(e.fillColorConfig,r,"#ff8c00"):e.fillColorRgba||"#ff8c00",a=e.lineColorConfig?Fe(e.lineColorConfig,r,"#ffffff"):e.lineColorRgba||"#ffffff",s=!1===e.isStroked?0:v;wt(t,`${e.id}-`,{"fill-color":l,"fill-opacity":i,"line-color":a,"line-width":s,"line-opacity":o,"circle-color":l,"circle-opacity":i,"circle-stroke-color":a,"circle-stroke-width":s})}}catch(e){console.warn("[FusedMaps] PMTiles update error:",e)}}({map:e,layer:t,els:{filledEl:x,strokedEl:C,extrudedEl:L,extrusionControls:w,elevAttrEl:E,elevScaleEl:S,opacityEl:A,fillFnEl:$,fillAttrEl:O,fillPaletteEl:_,fillReverseEl:U,fillDomainMinEl:R,fillDomainMaxEl:q,fillStepsEl:z,fillNullEl:W,fillStaticEl:V,lineFnEl:G,lineAttrEl:K,linePaletteEl:ee,lineReverseEl:le,lineDomainMinEl:oe,lineDomainMaxEl:re,lineStaticEl:ae,lineWidthEl:de},updateLayerOutput:We,findDeckOverlayOnMap:Ue,rebuildDeck:ze})},tt=()=>{const e=parseFloat(R.value),t=parseFloat(q.value);Number.isFinite(e)&&(D.value=String(e)),Number.isFinite(t)&&(B.value=String(t))},nt=()=>{let e=parseFloat(D.value),t=parseFloat(B.value);Number.isFinite(e)&&Number.isFinite(t)&&(e>t&&([e,t]=[t,e]),D.value=String(e),B.value=String(t),R.value=String(e),q.value=String(t))},it=()=>{const e=Be();if(e){e.fillDomainFromUser=!0;try{if("hex"!==e.layerType)return;const t=e.hexLayer||{};if(t.getFillColor&&"object"==typeof t.getFillColor){t.getFillColor.autoDomain=!1;try{delete t.getFillColor._dynamicDomain}catch(e){}}if(t.getLineColor&&"object"==typeof t.getLineColor){t.getLineColor.autoDomain=!1;try{delete t.getLineColor._dynamicDomain}catch(e){}}}catch(e){}}},ot=()=>{nt()},rt=()=>{nt(),it(),et()},lt=()=>{try{const n=t(e);if(me.value=`initialViewState = ${gt(n,0)}`,o&&function(){const e=document.activeElement;return!(!e||!e.closest?.("#debug-panel")||"INPUT"!==e.tagName&&"TEXTAREA"!==e.tagName&&"SELECT"!==e.tagName)}())return;ue.value=g(n.longitude,5),pe.value=g(n.latitude,5),fe.value=g(n.zoom,2),ye.value=g(n.pitch??0,1),ge.value=g(n.bearing??0,1)}catch(e){}},at=()=>{const e=r.classList.toggle("collapsed");l.innerHTML=e?"&#x203A;":"&#x2039;",St(o,r,l)};let st=!1,ct=0,dt=280;const ut=e=>{if(!st)return;const t=e.clientX-ct,n=p(dt+t,240,520);r.style.width=`${n}px`,St(o,r,l),e.preventDefault()},pt=e=>{st&&(st=!1,window.removeEventListener("pointermove",ut),window.removeEventListener("pointerup",pt))},ft=e=>{st=!0,ct=e.clientX,dt=r.getBoundingClientRect().width||280,window.addEventListener("pointermove",ut,{passive:!1}),window.addEventListener("pointerup",pt),e.preventDefault(),e.stopPropagation()};l.addEventListener("click",at),s.addEventListener("pointerdown",ft,{passive:!1}),u.addEventListener("change",()=>Ke()),$.addEventListener("change",()=>{Je(),et()}),G.addEventListener("change",()=>{Ye(),et()}),x.addEventListener("change",()=>{Qe(),et()}),C.addEventListener("change",()=>{Xe(),et()}),L.addEventListener("change",()=>{try{w&&(w.style.display=L.checked?"block":"none")}catch(e){}et()}),E.addEventListener("change",et),S.addEventListener("input",et),S.addEventListener("change",et),F.addEventListener("input",()=>{A.value=F.value,et()}),A.addEventListener("change",()=>{F.value=A.value,et()}),[O,z,U].forEach(e=>e.addEventListener("change",()=>{try{Re.refresh()}catch(e){}try{qe.refresh()}catch(e){}et()})),R.addEventListener("input",()=>{tt()}),q.addEventListener("input",()=>{tt()}),R.addEventListener("change",()=>{it(),et()}),q.addEventListener("change",()=>{it(),et()}),D.addEventListener("input",ot),B.addEventListener("input",ot),D.addEventListener("change",rt),B.addEventListener("change",rt),W.addEventListener("input",()=>{H.textContent=W.value,et()}),V.addEventListener("input",()=>{Z.textContent=V.value,et()}),[K,oe,re,le].forEach(e=>e.addEventListener("change",()=>{try{qe.refresh()}catch(e){}et()})),ae.addEventListener("input",()=>{se.textContent=ae.value,et()}),ce.addEventListener("input",()=>{de.value=ce.value,et()}),de.addEventListener("change",()=>{ce.value=de.value,et()});try{e.on("moveend",lt),e.on("rotateend",lt),e.on("pitchend",lt)}catch(e){}Je(),Ye();try{Re.refresh()}catch(e){}try{qe.refresh()}catch(e){}Ke(),lt(),St(o,r,l);const ht=()=>St(o,r,l);return window.addEventListener("resize",ht),{destroy:()=>{try{je.destroy()}catch(e){}try{l.removeEventListener("click",at)}catch(e){}try{Se?.removeEventListener("click",_e)}catch(e){}try{Ae?.removeEventListener("click",_e)}catch(e){}try{window.removeEventListener("resize",ht)}catch(e){}try{s.removeEventListener("pointerdown",ft)}catch(e){}try{e.off("moveend",lt),e.off("rotateend",lt),e.off("pitchend",lt)}catch(e){}try{Ne?.destroy()}catch(e){}try{Ne=null}catch(e){}try{o?.remove()}catch(e){}}}}function Nt(e){let t=null,n=null;try{"BroadcastChannel"in window&&(t=new BroadcastChannel(e))}catch(e){}function i(e){if(!n)return;let t;try{t="string"==typeof e.data?JSON.parse(e.data):e.data}catch{return}n(t)}return{send:function(e){const n=JSON.stringify(e);try{t&&t.postMessage(e)}catch(e){}try{window.parent.postMessage(n,"*")}catch(e){}try{window.top&&window.top!==window.parent&&window.top.postMessage(n,"*")}catch(e){}try{if(window.top?.frames)for(let e=0;e<window.top.frames.length;e++){const t=window.top.frames[e];if(t!==window)try{t.postMessage(n,"*")}catch(e){}}}catch(e){}},onMessage:function(e){n=e,t&&(t.onmessage=e=>{n&&n(e.data)}),window.addEventListener("message",i)},destroy:function(){t&&(t.close(),t=null),window.removeEventListener("message",i),n=null}}}function Ot(e="component"){return`${e}-${Math.random().toString(36).slice(2,11)}`}function _t(e,t,n,i){const o=i.channel||"fused-bus",r=i.messageType||"feature_click",l=i.properties||null,a=!1!==i.includeCoords,s=!1!==i.includeLayer,c=Ot("click-broadcast"),d=Nt(o);function u(){const n=[];for(const i of t)if(!i.isTileLayer)if("vector"===i.layerType)for(const t of["-fill","-circle","-line"]){const o=`${i.id}${t}`;try{e.getLayer(o)&&n.push(o)}catch{}}else if("hex"===i.layerType){const t=(i.hexLayer||{}).extruded?[`${i.id}-extrusion`]:[`${i.id}-fill`];for(const i of t)try{e.getLayer(i)&&n.push(i)}catch{}}return n}function p(e){if(!l||!Array.isArray(l))return{...e};const t={};for(const n of l)void 0!==e[n]&&(t[n]=e[n]);return t}function f(e,t,n){const i={type:r,fromComponent:c,properties:p(e),timestamp:Date.now()};a&&n&&(i.lngLat=n),s&&(i.layer=t),console.log("[ClickBroadcast] Sending feature_click:",i),d.send(i)}function y(i){!function(t){const i=u();if(i.length)try{if((e.queryRenderedFeatures(t.point,{layers:i})||[]).length)return!0}catch{}if(n?.pickObject)try{const e=n.pickObject({x:t.point.x,y:t.point.y,radius:1});if(e?.object)return!0}catch{}return!1}(i)?function(e){const t={type:"feature_deselect",fromComponent:c,properties:null,timestamp:Date.now()};a&&e&&(t.lngLat=e),d.send(t)}({lng:i.lngLat.lng,lat:i.lngLat.lat}):(function(n){const i=u();if(!i.length)return;let o=[];try{o=e.queryRenderedFeatures(n.point,{layers:i})||[]}catch(e){return void console.warn("[ClickBroadcast] Error querying features:",e)}if(!o.length)return;const r=o[0];f(r.properties||{},function(e){const n=t.find(t=>e.startsWith(t.id));return n?.name||n?.id||e}(r.layer?.id||""),{lng:n.lngLat.lng,lat:n.lngLat.lat})}(i),function(i){if(!n?.pickObject)return;const o=u();if(o.length)try{const t=e.queryRenderedFeatures(i.point,{layers:o});if(t?.length)return}catch{}try{const e=n.pickObject({x:i.point.x,y:i.point.y,radius:1});if(!e?.object)return;const o=e.object,r=o.properties||o||{};let l="hex-tiles";const a=e.layer?.id||"";if(a){const e=a.match(/^([^-]+)/);if(e){const n=e[1],i=t.find(e=>e.id===n||e.id.startsWith(n));i&&(l=i.name||i.id)}}f(r,l,{lng:i.lngLat.lng,lat:i.lngLat.lat})}catch(e){console.warn("[ClickBroadcast] Error picking deck object:",e)}}(i))}return e.on("click",y),{destroy:function(){e.off("click",y),d.destroy()}}}function Pt(e,t,n,i){const o={};if(t.broadcast?.enabled&&function(e,t={}){const n=t.channel||"fused-bus",i=t.dataset||"all",o=Ot("map-broadcast"),r=Nt(n);let l=null;function a(){const t=function(e){const t=e.getBounds();return[+t.getWest().toFixed(6),+t.getSouth().toFixed(6),+t.getEast().toFixed(6),+t.getNorth().toFixed(6)]}(e);if(a=l,(n=t)&&a&&n[0]===a[0]&&n[1]===a[1]&&n[2]===a[2]&&n[3]===a[3])return;var n,a;l=t;const[s,c,d,u]=t;r.send({type:"filter",fromComponent:o,timestamp:Date.now(),dataset:i,filter:{type:"spatial",field:"geometry",values:[s,c,d,u]}})}e.on("move",a),e.on("moveend",a),e.on("load",()=>{setTimeout(a,300)}),e.loaded()&&setTimeout(a,100),setTimeout(()=>{r.send({type:"component_ready",componentType:"map",componentId:o,capabilities:["spatial_filter"],dataSource:"viewport",protocol:"unified"})},200)}(e,{channel:t.broadcast.channel,dataset:t.broadcast.dataset}),t.sync?.enabled&&function(e,t={}){let n=t.channel||"default";n.includes("::")||(n=`map-sync::${n}`);const i=Ot("map"),o=Nt(n);let r=!1,l=!1,a={x:NaN,y:NaN,z:NaN};const s=(e,t,n)=>Math.abs(e-t)<n;function c(){const t=e.getCenter();return{longitude:+t.lng.toFixed(6),latitude:+t.lat.toFixed(6),zoom:+e.getZoom().toFixed(3),bearing:+e.getBearing().toFixed(1),pitch:+e.getPitch().toFixed(1),id:i,ts:Date.now()}}function d(){if(r)return;const e=c(),{longitude:t,latitude:n,zoom:i}=e;s(t,a.x,1e-6)&&s(n,a.y,1e-6)&&s(i,a.z,.001)||(a={x:t,y:n,z:i},o.send({type:"sync",...e}))}let u=null;const p=()=>{l=!0},f=()=>{l&&(l=!1,d())};e.on("dragstart",p),e.on("zoomstart",p),e.on("rotatestart",p),e.on("pitchstart",p),e.on("moveend",f),e.on("move",()=>{l&&!r&&(u&&clearTimeout(u),u=setTimeout(d,0))}),o.onMessage(t=>{var n;"sync"===t.type&&t.id!==i&&(n=t)&&n.id!==i&&(r||l||(r=!0,e.jumpTo({center:[n.longitude,n.latitude],zoom:n.zoom,bearing:n.bearing,pitch:n.pitch}),requestAnimationFrame(()=>{r=!1})))}),e.on("load",()=>{setTimeout(()=>o.send({type:"sync",...c()}),100+100*Math.random())});const y=()=>{document.hidden&&(r=!1,l=!1)};document.addEventListener("visibilitychange",y)}(e,{channel:t.sync.channel}),t.clickBroadcast?.enabled){const r=_t(e,n,i||null,{channel:t.clickBroadcast.channel,messageType:t.clickBroadcast.messageType,properties:t.clickBroadcast.properties,includeCoords:t.clickBroadcast.includeCoords,includeLayer:t.clickBroadcast.includeLayer});o.clickBroadcastDestroy=r.destroy}if(t.locationListener?.enabled){const n=function(e,t={}){const n=t.channel||"fused-bus",i=t.zoomOffset??0,o=t.padding??100,r=t.maxZoom??16,l=Ot("location-listener"),a=Nt(n);return a.onMessage(function(t){if(!t)return;if(t.fromComponent===l)return;const n=t.type||t.message_type;if("clear_selection"!==n&&"feature_deselect"!==n){if("location_change"===n||"feature_click"===n||"hex_click"===n){const s=t.bounds||t.location?.bounds,c=t.properties||t.location,d=t.selectionType;console.log("[LocationListener] Received message:",{type:n,selectionType:d,hasProperties:!!c,field:c?.field});const u=t.fromComponent||"";if(("feature_click"!==n||!u.startsWith("click-broadcast"))&&"farm"!==d&&c&&"function"==typeof window.__fusedHighlightByProperties)try{const e={};"field"===d&&c.field?(e["Field Name"]=c.field,e.field_name=c.field,e.name=c.field,e.Name=c.field):(Object.assign(e,c),c.name&&(e.name=c.name,e.Name=c.name,e.NAME=c.name,e["Field Name"]=c.name,e.field_name=c.name),c.farm&&(e.farm=c.farm,e.Farm=c.farm,e.FARM=c.farm,e["Farm Name"]=c.farm,e.farm_name=c.farm)),window.__fusedHighlightByProperties(e,!1)}catch{}if("location_change"===n&&"field"===d&&c?.field){const e={type:"feature_click",fromComponent:l,source:"fusedmaps-location-listener",properties:{"Field Name":c.field},bounds:s};console.log("[LocationListener] Re-broadcasting field selection:",e);try{a.send(e)}catch(e){console.warn("[LocationListener] Re-broadcast failed:",e)}}if("farm"===d)try{"function"==typeof window.__fusedHighlightClear&&window.__fusedHighlightClear()}catch{}if(s&&Array.isArray(s)&&4===s.length){const[t,n,l,a]=s;if(!(Number.isFinite(t)&&Number.isFinite(n)&&Number.isFinite(l)&&Number.isFinite(a)))return void console.warn("[LocationListener] Invalid bounds:",s);const c=Math.max(0,Math.min(o,250));i>0&&e.once?.("moveend",()=>{const t=e.getZoom(),n=Math.min(t+i,r);e.easeTo?.({zoom:n,duration:300})});try{e.fitBounds([[t,n],[l,a]],{padding:c,duration:800,maxZoom:r})}catch(i){console.warn("[LocationListener] fitBounds failed, using flyTo fallback:",i);const o=(t+l)/2,r=(n+a)/2;e.flyTo?.({center:[o,r],zoom:14,duration:800})}}}}else try{if("function"==typeof window.__fusedHighlightClear)window.__fusedHighlightClear();else if(e.getSource("feature-hl")){const t=e.getSource("feature-hl");t&&"function"==typeof t.setData&&t.setData({type:"FeatureCollection",features:[]})}}catch{}}),{destroy:function(){a.destroy()}}}(e,{channel:t.locationListener.channel,zoomOffset:t.locationListener.zoomOffset,padding:t.locationListener.padding,maxZoom:t.locationListener.maxZoom,idFields:t.locationListener.idFields});o.locationListenerDestroy=n.destroy}return o}const It="1.33.1-dev13.0",jt=new Map;function Rt(e){return/^[A-Za-z_][A-Za-z0-9_]*$/.test(e)}const qt=["hex","h3","index","id","cell_id","h3_cell","h3_index","h3_id","cell","h3cell","hexid","hex_id"],Dt=["VARCHAR","TEXT","STRING","CHAR","BPCHAR","NAME"];class Bt{constructor(e){this.duck=null,this.db=null,this.conn=null,this.tableByLayerId=new Map,this.loadedTables=new Set,this.hasSpatial=!1,this.version=e?.version||It}get ready(){return!!this.conn}async init(){if(this.conn)return;this.duck=await async function(e=It){const t=jt.get(e);if(t)return t;const n=import(`https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@${e}/+esm`);return jt.set(e,n),n}(this.version);const e=this.duck,t=await e.selectBundle(e.getJsDelivrBundles()),n=await(await fetch(t.mainWorker)).text(),i=new Worker(URL.createObjectURL(new Blob([n],{type:"application/javascript"}))),o=new e.AsyncDuckDB(new e.ConsoleLogger,i);await o.instantiate(t.mainModule);const r=await o.connect();try{await r.query("INSTALL h3 FROM community")}catch(e){}try{await r.query("LOAD h3")}catch(e){}try{await r.query("INSTALL spatial")}catch(e){}try{await r.query("LOAD spatial"),this.hasSpatial=!0}catch(e){this.hasSpatial=!1}this.db=o,this.conn=r}layerTableName(e){const t=this.tableByLayerId.get(e.id);if(t)return t;const n=e.id.replace(/-/g,"_");return this.tableByLayerId.set(e.id,n),n}async ensureLayerTable(e){if(await this.init(),!this.db||!this.conn)throw new Error("DuckDB not initialized");const t=this.layerTableName(e);if(this.loadedTables.has(t))return t;let n=null;if(e.parquetData)n=function(e){const t=atob(e),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n}(e.parquetData);else if(e.parquetUrl){const t=await fetch(e.parquetUrl);if(!t.ok)throw new Error(`Failed to fetch parquetUrl (${t.status})`);const i=await t.arrayBuffer();n=new Uint8Array(i)}if(!n)throw new Error("Missing parquetData or parquetUrl for SQL layer");return await this.db.registerFileBuffer(`${t}.parquet`,n),await this.conn.query(`CREATE OR REPLACE TABLE ${t} AS SELECT * FROM read_parquet('${t}.parquet')`),this.loadedTables.add(t),t}async runSql(e,t){if(await this.ensureLayerTable(e),!this.conn)throw new Error("DuckDB not initialized");const n=this.layerTableName(e);await this.conn.query(`CREATE OR REPLACE VIEW data AS SELECT * FROM ${n}`);const i=(t||"").trim(),o=/^(with|select)\b/i.test(i)?i:`SELECT * FROM data WHERE (${i||"1=1"})`,r=(await this.conn.query(o)).toArray().map(e=>function(e){const t=new Set(qt.map(e=>e.toLowerCase())),n={};for(const i of Object.keys(e)){let o=e[i];"bigint"==typeof o&&(o=t.has(i.toLowerCase())?o.toString(16):Number(o)),n[i]=o}const i=s(n.hex??n.h3??n.index??n.id??n.cell_id??n.h3_cell??n.h3_index??n.h3_id??n.cell??n.h3cell??n.hexid??n.hex_id);return i&&(n.hex=i),n}(e)).filter(e=>!!e.hex);return{rows:r,count:r.length}}async getMinMaxFromQuery(e,t,n){if(await this.ensureLayerTable(e),!this.conn)return null;const i=this.layerTableName(e);await this.conn.query(`CREATE OR REPLACE VIEW data AS SELECT * FROM ${i}`);const o=(n||"").trim(),r=/^(with|select)\b/i.test(o)?o:`SELECT * FROM data WHERE (${o||"1=1"})`,l=`"${String(t).replace(/"/g,'""')}"`,a=(await this.conn.query(`SELECT MIN(${l}) as min_val, MAX(${l}) as max_val FROM (${r}) AS q`)).toArray()[0];if(!a)return null;let s=a.min_val,c=a.max_val;return"bigint"==typeof s&&(s=Number(s)),"bigint"==typeof c&&(c=Number(c)),Number.isFinite(s)&&Number.isFinite(c)?{min:s,max:c}:null}async runSqlGeoJSON(e,t){if(await this.ensureLayerTable(e),!this.conn)throw new Error("DuckDB not initialized");if(!this.hasSpatial)return null;const n=this.layerTableName(e);await this.conn.query(`CREATE OR REPLACE VIEW data AS SELECT * FROM ${n}`);const i=(t||"").trim(),o=/^(with|select)\b/i.test(i)?i:`SELECT * FROM data WHERE (${i||"1=1"})`,r=(await this.conn.query(`DESCRIBE SELECT * FROM (${o}) AS q`)).toArray(),l=[],a={};for(const e of r){const t=String(e?.column_name||e?.name||""),n=String(e?.column_type||e?.type||"");t&&(l.push(t),a[t]=n)}const s=qt.find(e=>l.includes(e))||null;if(!s)return null;const c=function(e){const t=(e||"").toUpperCase();return Dt.some(e=>t.includes(e))}(a[s]||"")?`h3_string_to_h3("${s}")`:`CAST("${s}" AS BIGINT)`;if(!l.every(Rt))return null;const d=`\n      WITH q AS (${o})\n      SELECT\n        count(*)::BIGINT AS cnt,\n        CASE\n          WHEN count(*) = 0 THEN '{"type":"FeatureCollection","features":[]}'\n          ELSE (\n            '{"type":"FeatureCollection","features":[' ||\n              string_agg(\n                '{"type":"Feature","geometry":' ||\n                  ST_AsGeoJSON(ST_GeomFromText(h3_cell_to_boundary_wkt(${c}))) ||\n                ',"properties":' || to_json(struct_pack(${l.map(e=>`${e} := "${e}"`).join(", ")})) || '}',\n                ','\n              ) ||\n            ']}'\n          )\n        END AS gj\n      FROM q\n      WHERE "${s}" IS NOT NULL\n        AND h3_is_valid_cell(${c})\n    `,u=(await this.conn.query(d)).toArray()[0];if(!u)return{geojson:{type:"FeatureCollection",features:[]},count:0};let p=u.cnt;"bigint"==typeof p&&(p=Number(p));const f=String(u.gj||'{"type":"FeatureCollection","features":[]}');return{geojson:JSON.parse(f),count:Number(p)||0}}async getMinMax(e,t){if(await this.ensureLayerTable(e),!this.conn)return null;const n=this.layerTableName(e);await this.conn.query(`CREATE OR REPLACE VIEW data AS SELECT * FROM ${n}`);const i=(await this.conn.query(`SELECT MIN("${t}") as min_val, MAX("${t}") as max_val FROM data`)).toArray()[0];if(!i)return null;let o=i.min_val,r=i.max_val;return"bigint"==typeof o&&(o=Number(o)),"bigint"==typeof r&&(r=Number(r)),Number.isFinite(o)&&Number.isFinite(r)?{min:o,max:r}:null}}let zt=null,Ut={};function Wt(e){return!("hex"!==e.layerType||e.isTileLayer||!e.parquetData&&!e.parquetUrl)}function Ht(){let e=document.getElementById("sql-loader");e||(e=document.createElement("div"),e.id="sql-loader",e.innerHTML='<div class="loader-spinner"></div><span id="sql-loader-text">DuckDB</span>',document.body.appendChild(e));const t=document.getElementById("sql-loader-text");let n=null;const i=new Map;return{setStatus:(o,r)=>{i.set(o,String(r||"")),(()=>{if(!e)return;const o=[...i.entries()].filter(([,e])=>(e=>{const t=(e||"").toLowerCase();return!!t&&!t.startsWith("error:")&&!t.includes(" rows")&&(t.includes("initializ")||t.includes("running")||t.includes("loading")||t.includes("fetch"))})(e));if(o.length){n&&clearTimeout(n),e.classList.add("active");const i=o.some(([,e])=>String(e||"").toLowerCase().includes("initializ"));return void(t&&(t.textContent=i?"Initialising":"Loading"))}n=setTimeout(()=>e?.classList.remove("active"),300)})()}}}function Vt(e,t){try{window.dispatchEvent(new CustomEvent("fusedmaps:sql:status",{detail:{layerId:e,status:t}}))}catch(e){}try{zt||(zt=Ht()),zt?.setStatus(e,t)}catch(e){}}class Zt{constructor(){this.layers=new Map,this.listeners=new Map,this.nextOrder=0,this.listeners.set("*",new Set)}init(e){this.layers.clear(),this.nextOrder=0,e.forEach((e,t)=>{const n={config:e,visible:!1!==e.visible,order:t};this.layers.set(e.id,n),this.nextOrder=Math.max(this.nextOrder,t+1)}),this.emit({type:"batch",layerId:"*"})}add(e,t){if(this.layers.has(e.id))return console.warn(`[LayerStore] Layer ${e.id} already exists, updating instead`),this.update(e.id,e);const n=t?.order??this.nextOrder;void 0!==t?.order&&this.shiftOrdersFrom(n,1);const i={config:e,visible:!1!==e.visible,order:n};return this.layers.set(e.id,i),this.nextOrder=Math.max(this.nextOrder,n+1),this.emit({type:"add",layerId:e.id,layer:i}),i}remove(e){const t=this.layers.get(e);return!!t&&(this.layers.delete(e),this.recomputeOrders(),this.emit({type:"remove",layerId:e,layer:t}),!0)}update(e,t){const n=this.layers.get(e);if(n)return n.config={...n.config,...t},"visible"in t&&(n.visible=!1!==t.visible),this.emit({type:"update",layerId:e,layer:n,changes:t}),n;console.warn(`[LayerStore] Layer ${e} not found`)}updateStyle(e,t,n){const i=this.layers.get(e);if(!i)return;const o=i.config;return o[t]||(o[t]={}),o[t]={...o[t],...n},this.emit({type:"update",layerId:e,layer:i,changes:{[t]:o[t]}}),i}setVisible(e,t){const n=this.layers.get(e);n&&n.visible!==t&&(n.visible=t,n.config.visible=t,this.emit({type:"visibility",layerId:e,layer:n}))}toggleVisible(e){const t=this.layers.get(e);return!!t&&(this.setVisible(e,!t.visible),t.visible)}setVisibleBatch(e){Object.entries(e).forEach(([e,t])=>{const n=this.layers.get(e);n&&n.visible!==t&&(n.visible=t,n.config.visible=t)}),this.emit({type:"batch",layerId:"*"})}reorder(e,t){const n=this.layers.get(e);if(!n)return;const i=n.order;if(i===t)return;const o=this.layers.size-1;t=Math.max(0,Math.min(o,t)),this.layers.forEach((n,o)=>{o!==e&&(i<t?n.order>i&&n.order<=t&&n.order--:n.order>=t&&n.order<i&&n.order++)}),n.order=t,this.emit({type:"reorder",layerId:e,layer:n,previousOrder:i,newOrder:t})}moveUp(e){const t=this.layers.get(e);t&&this.reorder(e,t.order+1)}moveDown(e){const t=this.layers.get(e);t&&this.reorder(e,t.order-1)}moveToTop(e){this.reorder(e,this.layers.size-1)}moveToBottom(e){this.reorder(e,0)}setGeoJSON(e,t){const n=this.layers.get(e);n&&(n.geojson=t,this.emit({type:"geojson",layerId:e,layer:n}))}getGeoJSON(e){return this.layers.get(e)?.geojson}getAllGeoJSONs(){const e={};return this.layers.forEach((t,n)=>{t.geojson&&(e[n]=t.geojson)}),e}get(e){return this.layers.get(e)}getConfig(e){return this.layers.get(e)?.config}has(e){return this.layers.has(e)}getAll(){return[...this.layers.values()].sort((e,t)=>e.order-t.order)}getAllConfigs(){return this.getAll().map(e=>e.config)}getVisible(){return this.getAll().filter(e=>e.visible)}getVisibleConfigs(){return this.getVisible().map(e=>e.config)}getVisibilityState(){const e={};return this.layers.forEach((t,n)=>{e[n]=t.visible}),e}getByType(e){return this.getAll().filter(t=>t.config.layerType===e)}get size(){return this.layers.size}on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>this.off(e,t)}off(e,t){this.listeners.get(e)?.delete(t)}emit(e){this.listeners.get(e.type)?.forEach(t=>{try{t(e)}catch(e){console.error("[LayerStore] Event handler error:",e)}}),this.listeners.get("*")?.forEach(t=>{try{t(e)}catch(e){console.error("[LayerStore] Event handler error:",e)}})}shiftOrdersFrom(e,t){this.layers.forEach(n=>{n.order>=e&&(n.order+=t)})}recomputeOrders(){const e=this.getAll();e.forEach((e,t)=>{e.order=t}),this.nextOrder=e.length}clone(e,t,n){const i=this.layers.get(e);if(!i)return;const o=JSON.parse(JSON.stringify(i.config));return o.id=t,n&&(o.name=n),this.add(o,{order:i.order+1})}rename(e,t){const n=this.layers.get(e);n&&(n.config.name=t,this.emit({type:"update",layerId:e,layer:n,changes:{name:t}}))}clear(){this.layers.clear(),this.nextOrder=0,this.emit({type:"batch",layerId:"*"})}export(){return{layers:this.getAllConfigs(),visibility:this.getVisibilityState()}}}function Gt(){return new Zt}function Jt(e){if(e){if("string"==typeof e)return e;if(Array.isArray(e))return(t=e).length>=4?`rgba(${t[0]},${t[1]},${t[2]},${t[3]/255})`:`rgb(${t[0]},${t[1]},${t[2]})`;var t;if("type"in e){if("continuous"===e.type){const t=e;return{"@@function":"colorContinuous",attr:t.attr,domain:t.domain||[0,1],colors:t.palette,steps:t.steps,nullColor:t.nullColor,reverse:t.reverse,autoDomain:t.autoDomain??!0}}if("categorical"===e.type){const t=e;return{"@@function":"colorCategories",attr:t.attr,categories:t.categories,labelAttr:t.labelAttr,colors:t.palette,nullColor:t.nullColor}}}return"@@function"in e?e:void 0}}function Yt(e){switch(e.layerType){case"hex":return function(e){const t=e.style||{},n=e.tile||{};return{id:e.id,name:e.name,layerType:"hex",visible:e.visible,group:e.group,data:e.data,tileUrl:e.tileUrl,isTileLayer:!!e.tileUrl,parquetUrl:e.parquetUrl,parquetData:e.parquetData,sql:e.sql,dataRef:e.dataRef,tooltipColumns:e.tooltip,hexLayer:{filled:t.filled??!0,stroked:t.stroked??!0,extruded:t.extruded??!1,opacity:t.opacity??.9,elevationProperty:t.elevationAttr,elevationScale:t.elevationScale??1,getFillColor:Jt(t.fillColor),getLineColor:Jt(t.lineColor),lineWidthMinPixels:t.lineWidth??1,tooltipColumns:e.tooltip},tileLayerConfig:Object.keys(n).length>0?{minZoom:n.minZoom,maxZoom:n.maxZoom,zoomOffset:n.zoomOffset,tileSize:n.tileSize,maxRequests:n.maxRequests}:void 0}}(e);case"vector":return function(e){const t=e.style||{},n=Jt(t.fillColor),i=Jt(t.lineColor);return{id:e.id,name:e.name,layerType:"vector",visible:e.visible,group:e.group,geojson:e.geojson,geojsonSource:e.source,dataRef:e.dataRef,tooltipColumns:e.tooltip,vectorLayer:{filled:t.filled??!0,stroked:t.stroked??!0,opacity:t.opacity??.9,getFillColor:n,getLineColor:i,lineWidthMinPixels:t.lineWidth??1,pointRadiusMinPixels:t.pointRadius??5},fillColorConfig:Qt(n)?n:void 0,fillColorRgba:"string"==typeof n?n:void 0,lineColorConfig:Qt(i)?i:void 0,lineColorRgba:"string"==typeof i?i:void 0,lineWidth:t.lineWidth??1,pointRadius:t.pointRadius??5,isFilled:t.filled??!0,isStroked:t.stroked??!0,opacity:t.opacity??.9}}(e);case"mvt":return function(e){const t=e.style||{},n=e.tile||{},i=Jt(t.fillColor),o=Jt(t.lineColor);return{id:e.id,name:e.name,layerType:"mvt",visible:e.visible,group:e.group,tileUrl:e.tileUrl,sourceLayer:e.sourceLayer,dataRef:e.dataRef,tooltipColumns:e.tooltip,minzoom:n.minZoom,maxzoom:n.maxZoom,fillColorConfig:Qt(i)?i:void 0,fillColor:"string"==typeof i?i:void 0,fillOpacity:t.opacity??.9,isFilled:t.filled??!0,lineColorConfig:Qt(o)?o:void 0,lineColor:"string"==typeof o?o:void 0,lineWidth:t.lineWidth??1,isExtruded:t.extruded??!1,heightProperty:t.elevationAttr,heightMultiplier:t.elevationScale}}(e);case"raster":return{id:(t=e).id,name:t.name,layerType:"raster",visible:t.visible,group:t.group,tileUrl:t.tileUrl,imageUrl:t.imageUrl,imageBounds:t.imageBounds,dataRef:t.dataRef,opacity:t.opacity??.9,rasterLayer:{opacity:t.opacity??.9}};case"pmtiles":return function(e){const t=e.style||{},n=e.tile||{},i=Jt(t.fillColor),o=Jt(t.lineColor);return{id:e.id,name:e.name,layerType:"pmtiles",visible:e.visible,group:e.group,pmtilesUrl:e.pmtilesUrl,pmtilesPath:e.pmtilesPath,sourceLayer:e.sourceLayer,excludeSourceLayers:e.excludeSourceLayers,dataRef:e.dataRef,tooltipColumns:e.tooltip,minzoom:n.minZoom,maxzoom:n.maxZoom,fillColorConfig:Qt(i)?i:void 0,lineColorConfig:Qt(o)?o:void 0,fillOpacity:t.opacity??.9,lineWidth:t.lineWidth??1,pointRadiusMinPixels:t.pointRadius??5,isFilled:t.filled??!0,isStroked:t.stroked??!0,colorAttribute:t.fillColor?.attr}}(e);default:return e}var t}function Qt(e){return!(!e||"object"!=typeof e||Array.isArray(e))&&("@@function"in e||"type"in e)}function Xt(e){return"style"in e||"tile"in e||"tooltip"in e}const Kt=["hex","vector","mvt","raster","pmtiles"];function en(n){const o=n.containerId||"map",r=n.layers.map(e=>Xt(e)?Yt(e):e),l={...n,layers:r},p=Gt();p.init(r);const f="light"===n.ui?.theme?"light":"dark";document.documentElement.setAttribute("data-theme",f);const y=function(e){const{containerId:t,mapboxToken:n,styleUrl:i,initialViewState:o,screenshotEnabled:r,minZoom:l,maxZoom:a}=e;window.mapboxgl.accessToken=n;const s={};"number"==typeof l&&Number.isFinite(l)&&(s.minZoom=Math.max(0,Math.min(24,l))),"number"==typeof a&&Number.isFinite(a)&&(s.maxZoom=Math.max(0,Math.min(24,a)));const c=new window.mapboxgl.Map({container:t,style:i,center:[o.longitude,o.latitude],zoom:o.zoom,pitch:o.pitch||0,bearing:o.bearing||0,projection:"mercator",pitchWithRotate:!0,attributionControl:!1,...s,...r?{preserveDrawingBuffer:!0}:{}});return c.addControl(new window.mapboxgl.AttributionControl({compact:!0})),c.on("error",e=>{const t=e?.error?.message||"";t.includes("Could not load image")||t.includes("not, or is no longer, usable")||console.warn("[FusedMaps] Map error:",e?.error||e)}),c}({containerId:o,mapboxToken:n.mapboxToken,styleUrl:n.styleUrl,initialViewState:n.initialViewState,screenshotEnabled:!1!==n.ui?.screenshot,minZoom:n.minZoom,maxZoom:n.maxZoom}),g=n.widgets||{},m=(e,t)=>!1===e?{position:!1,expanded:!1}:"string"==typeof e?{position:e,expanded:!1}:e&&"object"==typeof e?{position:e.position??t,expanded:!0===e.expanded}:{position:t,expanded:!1},h=m(g.controls,"bottom-left"),b=m(g.scale,"bottom-left"),v=m(g.basemap,"bottom-left"),x=m(g.layers,"top-right"),C=m(g.legend,"bottom-right"),L=m(g.geocoder,!1),w=h.position,E=b.position,S=v.position,F=x.position,A=C.position,$=L.position,k=pt(y,n.initialViewState,{screenshot:!1!==n.ui?.screenshot,basemapSwitcher:!1!==n.ui?.basemapSwitcher&&!1!==S,currentStyle:n.styleUrl||"",positions:{controls:!1!==w&&w,scale:!1!==E&&E,basemap:!1!==S&&S}}),M=l.sidebar||!!l.debug?Mt(y,l):null,q={current:null};let H=null,V=null;const G=()=>y.resize(),J=()=>{document.hidden||setTimeout(G,100)},Q=()=>p.getVisibilityState(),X=()=>{try{return q.current?.__fused_hex_tiles__?.getTileData?.()||void 0}catch(e){return}},K=()=>{lt(p.getAllConfigs(),Q()),st(p.getAllConfigs(),Q(),p.getAllGeoJSONs(),X())},ee=p.on("*",e=>{"visibility"!==e.type&&"update"!==e.type&&"batch"!==e.type||K()});let ne=null;!1!==$&&(ne=function(e,t){const{position:n="top-right",placeholder:i="Search location...",mapboxToken:o}=t,r="top-center"!==n;let l=document.getElementById("location-search");l||(l=document.createElement("div"),l.id="location-search",r?De(n).appendChild(l):(document.body.appendChild(l),Object.assign(l.style,{position:"fixed",top:"12px",left:"50%",transform:"translateX(-50%)",right:"auto",bottom:"auto"}))),l.innerHTML=`\n    <input type="text" id="search-input" placeholder="${i}" autocomplete="off" />\n    <div class="search-results" id="search-results"></div>\n  `;const a=document.getElementById("search-input"),s=document.getElementById("search-results");let c=null;function d(t){const n=t.target.value.trim();if(c&&clearTimeout(c),n.length<2)return s.classList.remove("visible"),void(s.innerHTML="");c=setTimeout(()=>{!async function(t){try{const i=`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(t)}.json?access_token=${o}&limit=5`,r=await fetch(i);if(!r.ok)throw new Error("Geocoding failed");const l=await r.json();l.features&&l.features.length>0?(n=l.features,s.innerHTML=n.map(e=>{const t=e.text||e.place_name,n=e.place_name.replace(e.text+", ","").replace(e.text,"");return`\n        <div class="search-item" data-lng="${e.center[0]}" data-lat="${e.center[1]}" data-bbox="${e.bbox?e.bbox.join(","):""}">\n          <div class="place-name">${t}</div>\n          ${n?`<div class="place-context">${n}</div>`:""}\n        </div>\n      `}).join(""),s.classList.add("visible"),s.querySelectorAll(".search-item").forEach(t=>{t.addEventListener("click",()=>{const n=t,i=parseFloat(n.dataset.lng||"0"),o=parseFloat(n.dataset.lat||"0"),r=n.dataset.bbox;if(r){const[t,n,i,o]=r.split(",").map(Number);e.fitBounds([[t,n],[i,o]],{padding:50,duration:1500})}else e.flyTo({center:[i,o],zoom:12,duration:1500});a.value=n.querySelector(".place-name")?.textContent||"",s.classList.remove("visible")})})):(s.innerHTML='<div class="search-item" style="color:var(--ui-muted);">No results found</div>',s.classList.add("visible"))}catch(e){console.error("[Geocoder] Error:",e),s.classList.remove("visible")}var n}(n)},300)}function u(e){"Escape"===e.key&&(s.classList.remove("visible"),a.blur())}function p(e){e.target?.closest?.("#location-search")||s.classList.remove("visible")}return a.addEventListener("input",d),a.addEventListener("keydown",u),document.addEventListener("click",p),{destroy:function(){c&&clearTimeout(c),a.removeEventListener("input",d),a.removeEventListener("keydown",u),document.removeEventListener("click",p),l?.remove()}}}(y,{position:$,mapboxToken:n.mapboxToken}),$===F&&setTimeout(()=>{const e=document.getElementById("layer-panel");e&&(e.style.top="56px")},0)),!1!==n.ui?.legend&&!1!==A&&function(e,t,n,i="bottom-right",o,r=!1){const l=De(i);let a=document.getElementById("color-legend");if(!a){a=document.createElement("div"),a.id="color-legend",a.className=r?"color-legend fm-dropdown-widget":"color-legend fm-dropdown-widget collapsed",a.style.display="none",a.innerHTML=`\n      <button id="legend-toggle" class="fm-dropdown-toggle" title="Legend">\n        ${at}\n      </button>\n      <div class="fm-dropdown-panel" id="legend-dropdown">\n        <div class="fm-dropdown-header">\n          <span class="fm-dropdown-header-icon">${at}</span>\n          <span class="fm-dropdown-title">Legend</span>\n          <button class="fm-dropdown-close" id="legend-close" title="Close"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>\n        </div>\n        <div id="legend-content"></div>\n      </div>\n    `,l.appendChild(a);const e=document.getElementById("legend-toggle");e?.addEventListener("click",e=>{e.stopPropagation();const t=a?.classList.contains("collapsed");t&&document.querySelectorAll(".fm-dropdown-widget:not(#color-legend)").forEach(e=>{e.classList.add("collapsed")}),a?.classList.toggle("collapsed")});const t=document.getElementById("legend-close");t?.addEventListener("click",e=>{e.stopPropagation(),a?.classList.add("collapsed")}),document.addEventListener("click",e=>{a?.contains(e.target)||a?.classList.add("collapsed")})}st(e,t,n,o)}(p.getAllConfigs(),Q(),p.getAllGeoJSONs(),A,void 0,C.expanded),!1!==n.ui?.layerPanel&&!1!==F&&nt(p.getAllConfigs(),Q(),(e,t)=>{tn(e,t,y,p,q.current)},p,F,x.expanded);let ie=null;y.on("load",()=>{const e=Ne(y,p.getAllConfigs(),Q(),l);q.current=e.deckOverlay;const o=p.getAllConfigs().filter(e=>"mvt"===e.layerType||"raster"===e.layerType||"pmtiles"===e.layerType).map(e=>e.id);o.length>0&&(ie=function(e,t){if(!t.length)return()=>{};const n=new Set(t),i=new Set;let o=0;const r=e=>{const t=e?.sourceId;if(!t||!n.has(t))return;if(!e?.tile)return;const r=e?.tile?.tileID?.key,l=null!=r&&""!==r?`${t}-${r}`:`${t}-unknown-${++o}`;i.has(l)||(i.add(l),te(1))},l=e=>{const t=e?.sourceId;if(!t||!n.has(t))return;if(!e?.tile)return;const o=e?.tile?.tileID?.key;if(null!=o&&""!==o){const e=`${t}-${o}`;return void(i.delete(e)&&te(-1))}for(const e of i)if(e.startsWith(`${t}-unknown-`)){i.delete(e),te(-1);break}},a=()=>{const e=i.size;i.clear(),e>0&&te(-e)};return e.on("sourcedataloading",r),e.on("sourcedata",l),e.on("idle",a),()=>{e.off("sourcedataloading",r),e.off("sourcedata",l),e.off("idle",a);const t=i.size;i.clear(),t>0&&te(-t)}}(y,o));const r=ke();if(Object.entries(r).forEach(([e,t])=>{p.setGeoJSON(e,t)}),K(),H=()=>{st(p.getAllConfigs(),Q(),p.getAllGeoJSONs(),X())},window.addEventListener("fusedmaps:legend:update",H),!1!==n.ui?.tooltip&&function(e,t,n,i){const o={current:i};let r=document.getElementById("tooltip");r||(r=document.createElement("div"),r.id="tooltip",document.body.appendChild(r));const l=[];t.forEach(e=>{e.isTileLayer||"pmtiles"!==e.layerType&&T(e).forEach(t=>{l.push({layerId:t,layerDef:e})})}),e.on("mousemove",n=>{const i=[...l];try{const n=e.getStyle?.()?.layers||[];for(const e of t){if("pmtiles"!==e.layerType)continue;const t=`${e.id}-`;for(const o of n){const n=o?.id;"string"==typeof n&&n.startsWith(t)&&i.push({layerId:n,layerDef:e})}}}catch(e){}const a=i.map(e=>e.layerId).filter(t=>e.getLayer(t)),s=e=>{const n=t.findIndex(t=>t.id===e);return-1===n?Number.POSITIVE_INFINITY:n};let c=null,d=Number.POSITIVE_INFINITY;if(a.length){const t=e.queryRenderedFeatures(n.point,{layers:a});for(const e of t||[]){const t=i.find(t=>t.layerId===e.layer?.id);if(!t)continue;const n=s(t.layerDef.id);n<d&&(d=n,c={type:"mapbox",layerDef:t.layerDef,props:e.properties||{}});break}}const u=o.current;if(u){let e=null;const i=u.__fused_hex_tiles__;if(i?.getHoverInfo&&(e=i.getHoverInfo()),!e?.object)try{"function"==typeof u.pickObject&&(e=u.pickObject({x:n.point.x,y:n.point.y,radius:4}))}catch(e){}if(e?.object){const n=String(e.layer?.id||""),i=n.includes("-tiles")?n.split("-tiles")[0]:n.split("-")[0],o=t.find(e=>e.id===i)||t.find(e=>n.startsWith(e.id));if(o){const t=s(o.id);t<d&&(d=t,c={type:"deck",layerDef:o,props:e.object.properties||e.object||{}})}}}if(!c)return r.style.display="none",void(e.getCanvas().style.cursor="");e.getCanvas().style.cursor="pointer";const p=function(e){const t=e;if("hex"===e.layerType){const n=e;return n.hexLayer?.tooltipColumns||n.hexLayer?.tooltipAttrs||n.tooltipColumns||t.tooltip||[]}if("vector"===e.layerType){const n=e;return n.vectorLayer?.tooltipColumns||n.vectorLayer?.tooltipAttrs||n.tooltipColumns||t.tooltip||[]}return"pmtiles"===e.layerType?t.vectorLayer?.tooltipColumns||t.vectorLayer?.tooltipAttrs||t.tooltipColumns||t.tooltip||[]:t.tooltipColumns||t.tooltip||[]}(c.layerDef),f=function(e,t,n){const i=[];if(null!=e.hex&&i.push(`<span class="tt-row"><span class="tt-key">hex</span><span class="tt-val">${String(e.hex).slice(0,12)}...</span></span>`),t.length)return t.forEach(t=>{if("hex"===t)return;const n=e[t];if(null==n)return;const o="number"==typeof n?ct(n):String(n);i.push(`<span class="tt-row"><span class="tt-key">${t}</span><span class="tt-val">${o}</span></span>`)}),i;if("hex"===n?.layerType){const t=n,o=t.hexLayer?.getFillColor?.attr||"metric";if(null!=e[o]){const t=e[o],n="number"==typeof t?ct(t):String(t);return i.push(`<span class="tt-row"><span class="tt-key">${o}</span><span class="tt-val">${n}</span></span>`),i}}return 0===i.length&&Object.keys(e).filter(e=>"hex"!==e&&"properties"!==e).slice(0,5).forEach(t=>{const n=e[t];if(null==n)return;const o="number"==typeof n?ct(n):String(n);i.push(`<span class="tt-row"><span class="tt-key">${t}</span><span class="tt-val">${o}</span></span>`)}),i}(c.props,p,c.layerDef);f.length?(r.innerHTML=`<strong class="tt-title">${c.layerDef.name}</strong>`+f.join(""),r.style.left=`${n.point.x+10}px`,r.style.top=`${n.point.y+10}px`,r.style.display="block"):r.style.display="none"}),e.on("mouseleave",()=>{e.getCanvas().style.cursor="",r.style.display="none"})}(y,p.getAllConfigs(),Q(),q.current),!1!==n.highlightOnClick){const e=n.messaging?.locationListener?.idFields?{idFields:n.messaging.locationListener.idFields}:void 0;!function(e,t,n,i,o){if(o?.idFields&&Array.isArray(o.idFields)&&o.idFields.length>0){const e=new Set(o.idFields);j=[...o.idFields,..._.filter(t=>!e.has(t))]}else j=_;window.__fusedHighlightByProperties=(n,i)=>{console.log("[Highlight] __fusedHighlightByProperties called with:",n),function(e,t,n,i=!1){if(!n||0===Object.keys(n).length)return;if(i){const t=U(n);if(t.length>0)return void W(e,t)}const o=B(e,t);if(!o.length)return;let r=[];try{r=e.queryRenderedFeatures(void 0,{layers:o})||[]}catch(e){return}const l=j,a=[],c=new Set;for(const t of r){const o=t.properties||{};let r=!1;for(const s of l)if(void 0!==n[s]&&void 0!==o[s]&&String(n[s])===String(o[s])){const n=o.id||o.name||o["Field Name"]||JSON.stringify(t.geometry?.coordinates?.[0]?.[0]||Math.random());if(c.has(String(n))||(c.add(String(n)),a.push(t)),r=!0,!i)return void z(e,t);break}if(!r){let r=!0;for(const[e,t]of Object.entries(n))if(void 0!==o[e]&&String(o[e])!==String(t)){r=!1;break}if(r&&Object.keys(n).length>0&&Object.keys(n).some(e=>void 0!==o[e])){const n=o.id||o.name||o["Field Name"]||JSON.stringify(t.geometry?.coordinates?.[0]?.[0]||Math.random());if(c.has(String(n))||(c.add(String(n)),a.push(t)),!i)return void z(e,t)}}}if(0===a.length){const t=U(n);if(t.length>0)return void W(e,i?t:[t[0]])}i&&a.length>0&&function(e,t){const n={type:"FeatureCollection",features:[]};for(const e of t){if(!e)continue;const t=e.properties||{},i=t.hex||t.h3;if(i&&window.h3)try{const e=s(i);if(e&&window.h3.isValidCell(e)){const i=window.h3.cellToBoundary(e).map(([e,t])=>[t,e]);i.push(i[0]),n.features.push({type:"Feature",geometry:{type:"Polygon",coordinates:[i]},properties:t})}}catch(e){}else if(e.source&&R.has(e.source)){const i=D(e.source,t);i?.geometry?n.features.push({type:"Feature",geometry:i.geometry,properties:t}):e.geometry&&n.features.push({type:"Feature",geometry:e.geometry,properties:t})}else e.geometry&&n.features.push({type:"Feature",geometry:e.geometry,properties:t})}P?e.getSource("feature-hl").setData(n):(e.addSource("feature-hl",{type:"geojson",data:n}),e.addLayer({id:"feature-hl-fill",type:"fill",source:"feature-hl",paint:{"fill-color":N,"fill-opacity":1}}),e.addLayer({id:"feature-hl-line",type:"line",source:"feature-hl",paint:{"line-color":O,"line-width":3}}),P=!0),I=t.length>0?t[0]:null}(e,a)}(e,t,n,i)},window.__fusedHighlightClear=()=>{z(e,null)},e.on("click",n=>{const o=B(e,t);if(console.log("[Highlight] Click - queryLayers:",o),!o.length)return void console.log("[Highlight] No queryable layers, skipping");let r=[];try{r=e.queryRenderedFeatures(n.point,{layers:o})||[],console.log("[Highlight] queryRenderedFeatures returned:",r.length,"features"),r.length>0&&console.log("[Highlight] First feature:",r[0].layer?.id,r[0].properties)}catch(e){console.warn("[Highlight] queryRenderedFeatures error:",e)}if(r.length>0)z(e,r[0]);else if(i){const t=i?.pickObject?.({x:n.point.x,y:n.point.y,radius:4});t?.object?z(e,{properties:t.object.properties||t.object,geometry:null}):I&&z(e,null)}else I&&z(e,null)})}(y,p.getAllConfigs(),Q(),q.current,e)}if(n.messaging&&Pt(y,n.messaging,p.getAllConfigs(),q.current),V=function(e,t,n,o){const r=(t.layers||[]).filter(Wt);if(!r.length)return null;try{Ut={};for(const e of r)Ut[e.id]=e.name||e.id}catch(e){}try{zt||(zt=Ht())}catch(e){}const l=new Bt;let s=!1;const c=async(t,r)=>{if(!s){Vt(t.id,"initializing...");try{if(await l.init(),s)return;try{const e=t.hexLayer?.getFillColor,n=e&&"object"==typeof e&&!Array.isArray(e)?e.attr:null,i=e&&"object"==typeof e&&!Array.isArray(e)&&(!0===e.autoDomain||!Array.isArray(e.domain));if(n&&i&&!0!==t.fillDomainFromUser){const e=await l.getMinMax(t,String(n));e&&t.hexLayer&&"object"==typeof t.hexLayer.getFillColor&&!Array.isArray(t.hexLayer.getFillColor)&&(t.hexLayer.getFillColor.domain=[e.min,e.max])}}catch(e){}t.sql=r||t.sql||"SELECT * FROM data";try{const e=t.sql||"SELECT * FROM data",n=!0===t.fillDomainFromUser,i=t.hexLayer?.getFillColor;if(!n&&i&&"object"==typeof i&&!Array.isArray(i)&&"colorContinuous"===i["@@function"]){const n=String(i.attr||"");if(n&&!0===i.autoDomain){const o=await l.getMinMaxFromQuery(t,n,e);o&&(i.domain=[o.min,o.max])}}const o=t.hexLayer?.getLineColor;if(!n&&o&&"object"==typeof o&&!Array.isArray(o)&&"colorContinuous"===o["@@function"]){const n=String(o.attr||"");if(n&&!0===o.autoDomain){const i=await l.getMinMaxFromQuery(t,n,e);i&&(o.domain=[i.min,i.max])}}}catch(e){}Vt(t.id,"running...");const c=await l.runSqlGeoJSON(t,t.sql||"SELECT * FROM data");if(s)return;if(!c?.geojson)throw new Error("DuckDB GeoJSON path unavailable (requires spatial + h3 extensions and compatible columns).");const u=c.geojson;Te(t.id,u);const p=!1!==n[t.id],f=function(e,t,n){try{const i=e.getSource(t);if(i&&"function"==typeof i.setData)return i.setData(n),!0}catch(e){}return!1}(e,t.id,u);if(!f)try{d(e,t,u,p)}catch(e){}!function(e,t){const n=t.hexLayer||{},o=t.data||[],r=Array.isArray(n.getFillColor)?i(n.getFillColor,.8):a(n.getFillColor,o)||"rgba(0,144,255,0.7)",l=n.getLineColor?Array.isArray(n.getLineColor)?i(n.getLineColor,1):a(n.getLineColor,o):"rgba(255,255,255,0.3)",s="number"==typeof n.opacity&&isFinite(n.opacity)?Math.max(0,Math.min(1,n.opacity)):.8;try{n.extruded&&e.getLayer(`${t.id}-extrusion`)&&(e.setPaintProperty(`${t.id}-extrusion`,"fill-extrusion-color",r),e.setPaintProperty(`${t.id}-extrusion`,"fill-extrusion-opacity",s))}catch(e){}try{!n.extruded&&e.getLayer(`${t.id}-fill`)&&(e.setPaintProperty(`${t.id}-fill`,"fill-color",r),e.setPaintProperty(`${t.id}-fill`,"fill-opacity",s))}catch(e){}try{e.getLayer(`${t.id}-outline`)&&(e.setPaintProperty(`${t.id}-outline`,"line-color",l),e.setPaintProperty(`${t.id}-outline`,"line-width",n.lineWidthMinPixels||.5))}catch(e){}}(e,t),Vt(t.id,`${(c.count||0).toLocaleString()} rows`),function(){try{window.dispatchEvent(new Event("fusedmaps:legend:update"))}catch(e){}}();try{o?.()}catch(e){}}catch(e){Vt(t.id,`error: ${(e?.message||"query failed").slice(0,60)}`)}}};(async()=>{for(const e of r){if(s)break;const t=(e.sql||"SELECT * FROM data").trim();await c(e,t)}})();const u=e=>{const t=e?.detail||{},n=String(t.layerId||""),i=String(t.sql||""),o=r.find(e=>e.id===n);o&&c(o,i)};try{window.addEventListener("fusedmaps:sql:update",u)}catch(e){}return{destroy:()=>{s=!0;try{window.removeEventListener("fusedmaps:sql:update",u)}catch(e){}}}}(y,l,Q(),()=>{const e=ke();Object.entries(e).forEach(([e,t])=>{p.setGeoJSON(e,t)}),K()}),!n.hasCustomView){!function(e,t,n){const i=new mapboxgl.LngLatBounds,o=n.getAllGeoJSONs();t.forEach(e=>{if(e.isTileLayer)return;if("raster"===e.layerType){const t=e.imageBounds;if(Array.isArray(t)&&4===t.length){const[e,n,o,r]=t;[e,n,o,r].every(e=>"number"==typeof e&&Number.isFinite(e))&&(i.extend([e,n]),i.extend([o,r]))}return}const t=o[e.id];t?.features?.length&&t.features.forEach(e=>{"Point"===e.geometry?.type?i.extend(e.geometry.coordinates):"Polygon"===e.geometry?.type||"MultiPolygon"===e.geometry?.type?("Polygon"===e.geometry.type?[e.geometry.coordinates]:e.geometry.coordinates).forEach(e=>e[0]?.forEach(e=>i.extend(e))):"LineString"===e.geometry?.type&&e.geometry.coordinates.forEach(e=>i.extend(e))})}),i.isEmpty()||e.fitBounds(i,{padding:50,maxZoom:15,duration:500})}(y,p.getAllConfigs(),p);const e=()=>{const n=t(y);k?.setHomeViewState?.(n),y.off("moveend",e)};y.on("moveend",e)}y.on("style.load",()=>{const e=Ne(y,p.getAllConfigs(),Q(),l);q.current=e.deckOverlay;const t=ke();Object.entries(t).forEach(([e,t])=>{p.setGeoJSON(e,t)}),p.getAllConfigs().forEach(e=>{"hex"!==e.layerType||e.isTileLayer||!e.parquetUrl&&!e.parquetData||window.dispatchEvent(new CustomEvent("fusedmaps:sql:update",{detail:{layerId:e.id,sql:e.sql||"SELECT * FROM data"}}))}),K()})}),y.on("load",()=>{[100,500,1e3].forEach(e=>setTimeout(G,e))}),window.addEventListener("resize",G),document.addEventListener("visibilitychange",J);const oe=()=>{const e=t(y);let n;try{const e=y.getBounds();n={west:e.getWest(),south:e.getSouth(),east:e.getEast(),north:e.getNorth()}}catch(e){}const i=p.getAllGeoJSONs();return{viewState:e,...n?{bounds:n}:{},layers:p.getAll().map(e=>{const t=e.config,n=Array.isArray(t.tooltipColumns)?t.tooltipColumns:Array.isArray(t.hexLayer?.tooltipColumns)?t.hexLayer.tooltipColumns:Array.isArray(t.hexLayer?.tooltipAttrs)?t.hexLayer.tooltipAttrs:Array.isArray(t.vectorLayer?.tooltipColumns)?t.vectorLayer.tooltipColumns:Array.isArray(t.vectorLayer?.tooltipAttrs)?t.vectorLayer.tooltipAttrs:void 0;let o;try{const t=i[e.config.id],n=t?.features?.[0],r=n?.properties;r&&"object"==typeof r&&(o=Object.keys(r).slice(0,200))}catch(e){}return{id:e.config.id,name:e.config.name,layerType:e.config.layerType,visible:e.visible,order:e.order,...o?{propertyKeys:o}:{},...n?{tooltipColumns:n}:{}}})}},re={map:y,get deckOverlay(){return q.current},store:p,getState:oe,dispatch:t=>{const n=Array.isArray(t)?t:[t];for(const t of n)if(t&&"object"==typeof t)switch(t.type){case"setViewState":{const n=t.viewState||{},i=Number.isFinite(t.options?.duration)?t.options.duration:null;i&&i>0?y.easeTo({...n,duration:i}):e(y,n);break}case"fitBounds":{const e=t.bounds;if(Array.isArray(e)&&4===e.length){const[n,i,o,r]=e,l=t.options||{};y.fitBounds([[n,i],[o,r]],{padding:Number.isFinite(l.padding)?l.padding:50,maxZoom:Number.isFinite(l.maxZoom)?l.maxZoom:15,duration:Number.isFinite(l.duration)?l.duration:500})}break}case"setLayerVisibility":tn(t.layerId,!!t.visible,y,p,q.current);break;case"updateLayer":{const e=t.layerId,n=t.changes||{};re.updateLayer(e,n);break}case"addLayer":re.addLayer(t.layer,t.options);break;case"removeLayer":re.removeLayer(t.layerId);break;case"moveLayerUp":re.moveLayerUp(t.layerId);break;case"moveLayerDown":re.moveLayerDown(t.layerId);break;case"updateLegend":st(p.getAllConfigs(),Q(),p.getAllGeoJSONs(),X())}return oe()},setLayerVisibility:(e,t)=>{tn(e,t,y,p,q.current)},updateLegend:()=>{st(p.getAllConfigs(),Q(),p.getAllGeoJSONs(),X())},addLayer:(e,t)=>{const n=function(e){return e&&"object"==typeof e?e.id&&"string"==typeof e.id?e.layerType&&Kt.includes(e.layerType)?{valid:!0}:{valid:!1,error:`Layer config must have a valid layerType: ${Kt.join(", ")}`}:{valid:!1,error:"Layer config must have a string id"}:{valid:!1,error:"Layer config must be an object"}}(e);if(!n.valid)return console.warn("[FusedMaps] addLayer:",n.error),null;const i=Xt(e)?Yt(e):e,o=p.add(i,t);try{Oe(y,o.config,o.visible,l)}catch{const e=Ne(y,p.getAllConfigs(),Q(),l);q.current=e.deckOverlay}return K(),o},removeLayer:e=>{if(!e||"string"!=typeof e)return console.warn("[FusedMaps] removeLayer: layerId must be a non-empty string"),!1;const t=p.get(e)?.config,n=p.remove(e);if(n){try{t&&_e(y,t)}catch{const e=Ne(y,p.getAllConfigs(),Q(),l);q.current=e.deckOverlay}K()}return n},updateLayer:(e,t)=>{if(!e||"string"!=typeof e)return console.warn("[FusedMaps] updateLayer: layerId must be a non-empty string"),null;if(!t||"object"!=typeof t)return console.warn("[FusedMaps] updateLayer: changes must be an object"),null;const n=p.get(e)?.config,o=p.update(e,t);if(o){if((1!==Object.keys(t).length||!Object.prototype.hasOwnProperty.call(t,"visible"))&&n){const e=function(e,t,n,o){if(!t||!n)return!1;if(t.id!==n.id)return!1;if(t.layerType!==n.layerType)return!1;const r=n.id;if("raster"===n.layerType){const i=t,l=n;if(i.tileUrl!==l.tileUrl||i.imageUrl!==l.imageUrl||JSON.stringify(i.imageBounds)!==JSON.stringify(l.imageBounds))return!1;const a=l.opacity??l.rasterLayer?.opacity??1;return Pe(e,`${r}-raster`,"raster-opacity",Math.max(0,Math.min(1,a))),Y(e,r,o),!0}if("vector"===n.layerType){const i=t,l=n;if(i.isFilled!==l.isFilled||i.isStroked!==l.isStroked||i.tileUrl!==l.tileUrl||i.sourceLayer!==l.sourceLayer)return!1;if(l.geojson&&!je(e,r,l.geojson)&&!e.getSource(r))return!1;const s=l.geojson,c=s?.features?.map(e=>e.properties||{})||[],d=l.fillColorConfig?.["@@function"]?a(l.fillColorConfig,c):l.fillColorRgba||"rgba(0,144,255,0.6)",u=l.lineColorConfig?.["@@function"]?a(l.lineColorConfig,c):l.lineColorRgba||"rgba(100,100,100,0.8)",p="number"==typeof l.lineWidth&&isFinite(l.lineWidth)?l.lineWidth:1,f="number"==typeof l.opacity&&isFinite(l.opacity)?Math.max(0,Math.min(1,l.opacity)):.8,y="number"==typeof l.pointRadius&&isFinite(l.pointRadius)?l.pointRadius:6;return Pe(e,`${r}-fill`,"fill-color",d),Pe(e,`${r}-fill`,"fill-opacity",f),Pe(e,`${r}-outline`,"line-color",u),Pe(e,`${r}-outline`,"line-width",p),Pe(e,`${r}-line`,"line-color",u),Pe(e,`${r}-line`,"line-width",p),Pe(e,`${r}-line`,"line-opacity",1),Pe(e,`${r}-circle`,"circle-radius",y),Pe(e,`${r}-circle`,"circle-color",d),Pe(e,`${r}-circle`,"circle-opacity",.9),Pe(e,`${r}-circle`,"circle-stroke-color",u),Pe(e,`${r}-circle`,"circle-stroke-width",1),Z(e,r,o),!0}if("hex"===n.layerType){const l=t,s=n;if(s.isTileLayer)return!1;if(l.hexLayer?.extruded!==s.hexLayer?.extruded||l.hexLayer?.filled!==s.hexLayer?.filled||l.hexLayer?.stroked!==s.hexLayer?.stroked)return!1;const d=s.data&&Array.isArray(s.data)?c(s.data):null;if(d&&!je(e,r,d)&&!e.getSource(r))return!1;const p=s.hexLayer||{},f=s.data||[],y=Array.isArray(p.getFillColor)?i(p.getFillColor,.8):a(p.getFillColor,f)||"rgba(0,144,255,0.7)",g=p.getLineColor?Array.isArray(p.getLineColor)?i(p.getLineColor,1):a(p.getLineColor,f):"rgba(255,255,255,0.3)",m="number"==typeof p.opacity&&isFinite(p.opacity)?Math.max(0,Math.min(1,p.opacity)):.8;Pe(e,`${r}-fill`,"fill-color",y),Pe(e,`${r}-fill`,"fill-opacity",m),Pe(e,`${r}-outline`,"line-color",g),Pe(e,`${r}-outline`,"line-width",p.lineWidthMinPixels||.5);const h=p.elevationScale||1,b=p.elevationProperty||p.getFillColor?.attr||null;return Pe(e,`${r}-extrusion`,"fill-extrusion-color",y),Pe(e,`${r}-extrusion`,"fill-extrusion-height",b?["*",["to-number",["get",b],0],h]:100),Pe(e,`${r}-extrusion`,"fill-extrusion-opacity",m),u(e,r,o,!0===p.extruded),!0}if("mvt"===n.layerType){const i=t,l=n;if(i.tileUrl!==l.tileUrl||i.sourceLayer!==l.sourceLayer||i.isExtruded!==l.isExtruded||i.isFilled!==l.isFilled)return!1;const s=l.fillColorConfig?.["@@function"]?a(l.fillColorConfig,void 0):l.fillColor||"#FFF5CC",c=l.lineColorConfig?.["@@function"]?a(l.lineColorConfig,void 0):l.lineColor||"#FFFFFF",d=l.fillOpacity??.8,u=l.lineWidth??1;return Pe(e,`${r}-fill`,"fill-color",s),Pe(e,`${r}-fill`,"fill-opacity",d),Pe(e,`${r}-line`,"line-color",c),Pe(e,`${r}-line`,"line-width",u),e.getLayer(`${r}-extrusion`)&&(Pe(e,`${r}-extrusion`,"fill-extrusion-color",s),Pe(e,`${r}-extrusion`,"fill-extrusion-height",["*",["get",l.heightProperty||"height"],l.heightMultiplier||1]),Pe(e,`${r}-extrusion`,"fill-extrusion-opacity",l.extrusionOpacity??.9)),Z(e,r,o),!0}if("pmtiles"===n.layerType){const i=t,l=n;if(i.pmtilesUrl!==l.pmtilesUrl||i.pmtilesPath!==l.pmtilesPath||JSON.stringify(i.excludeSourceLayers||[])!==JSON.stringify(l.excludeSourceLayers||[])||i.sourceLayer!==l.sourceLayer||i.renderPoints!==l.renderPoints||i.renderLines!==l.renderLines||i.renderPolygons!==l.renderPolygons)return!1;const a=l.vectorLayer||{},s=l.fillOpacity??a.opacity??.8,c=l.lineWidth??1,d=l.pointRadiusMinPixels??4,u=!1!==l.isFilled,p=!1!==l.isStroked?c:0,f=u?s:0,y=l.colorAttribute||"value",g=Fe(l.fillColorConfig||a.getFillColor,y,"#ff8c00"),m=Fe(l.lineColorConfig||a.getLineColor,y,"#ffffff"),h=`${r}-`,b=e.getStyle()?.layers||[];for(const t of b){const n=t?.id;n&&n.startsWith(h)&&(n.endsWith("-fill")?(Pe(e,n,"fill-color",g),Pe(e,n,"fill-opacity",f)):n.endsWith("-line")?(Pe(e,n,"line-color",m),Pe(e,n,"line-width",p),Pe(e,n,"line-opacity",s)):n.endsWith("-circles")&&(Pe(e,n,"circle-radius",["interpolate",["exponential",2],["zoom"],0,.5*d,10,d,15,4*d,20,20*d]),Pe(e,n,"circle-color",g),Pe(e,n,"circle-opacity",f),Pe(e,n,"circle-stroke-color",m),Pe(e,n,"circle-stroke-width",p)),Ie(e,n,"visibility",o?"visible":"none"))}return!0}return!1}(y,n,o.config,o.visible);if(!e)try{_e(y,n),Oe(y,o.config,o.visible,l)}catch{const e=Ne(y,p.getAllConfigs(),Q(),l);q.current=e.deckOverlay}}K()}return o},getLayer:e=>p.get(e),getLayers:()=>p.getAll(),moveLayerUp:e=>{p.moveUp(e);const t=Ne(y,p.getAllConfigs(),Q(),l);q.current=t.deckOverlay},moveLayerDown:e=>{p.moveDown(e);const t=Ne(y,p.getAllConfigs(),Q(),l);q.current=t.deckOverlay},destroy:()=>{try{window.removeEventListener("resize",G)}catch{}try{document.removeEventListener("visibilitychange",J)}catch{}try{H&&window.removeEventListener("fusedmaps:legend:update",H)}catch{}try{ee()}catch{}try{q.current?.__fused_hex_tiles__?.destroy?.()}catch{}try{k?.destroy?.()}catch{}try{M?.destroy?.()}catch{}try{V?.destroy?.()}catch{}try{ne?.destroy?.()}catch{}try{ie?.()}catch{}y.remove?.()}};return re}function tn(e,t,n,i,o){i.setVisible(e,t);const r=i.getVisibilityState();let l;!function(e,t,n,i,o,r){const l=i.find(e=>e.id===t);if(l)switch(l.layerType){case"hex":{const i=l;if(i.isTileLayer){const e=o?.__fused_hex_tiles__;try{e?.rebuild?.(r)}catch(e){}}else u(e,t,n,!0===i.hexLayer?.extruded);break}case"vector":case"mvt":Z(e,t,n);break;case"raster":Y(e,t,n);break;case"pmtiles":!function(e,t,n){const i=`${t}-`,o=e.getStyle()?.layers||[];for(const t of o){const o=t?.id;if(o&&o.startsWith(i))try{e.setLayoutProperty(o,"visibility",n?"visible":"none")}catch(e){}}}(e,t,n)}}(n,e,t,i.getAllConfigs(),o,r);try{l=o?.__fused_hex_tiles__?.getTileData?.()||void 0}catch(e){}lt(i.getAllConfigs(),r),st(i.getAllConfigs(),r,i.getAllGeoJSONs(),l)}"undefined"!=typeof window&&(window.FusedMaps={init:en});var nn={init:en};export{Zt as LayerStore,Gt as createLayerStore,nn as default,en as init,Re as isLeftPosition};
//# sourceMappingURL=fusedmaps.esm.js.map
