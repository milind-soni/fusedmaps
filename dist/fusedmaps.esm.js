function e(e){const t=e.getCenter();return{longitude:t.lng,latitude:t.lat,zoom:e.getZoom(),pitch:e.getPitch(),bearing:e.getBearing()}}function t(e,t){const i=window.cartocolor;if(!i)return null;const n=i[e];if(!n)return null;const r=Object.keys(n).map(Number).filter(e=>!isNaN(e)).sort((e,t)=>e-t),l=r.find(e=>e>=t)||r[r.length-1];return n[l]?[...n[l]]:null}function i(e,t){if(!Array.isArray(e)||e.length<3)return null;const[i,n,r]=e;return`rgba(${i},${n},${r},${e.length>=4?e[3]/255:t??1})`}const n=["#e0f3db","#ccebc5","#a8ddb5","#7bccc4","#4eb3d3","#2b8cbe","#0868ac","#084081"],r=["#7F3C8D","#11A579","#3969AC","#F2B701","#E73F74","#80BA5A","#E68310","#008695","#CF1C90","#f97b72"];function l(e,t,i){const n=new Map;return(e||[]).forEach(e=>{const r=e?.[t]??e?.properties?.[t];if(null!=r&&""!==r&&"null"!==r&&!n.has(r)){const t=i?e?.[i]??e?.properties?.[i]??r:r;n.set(r,String(t))}}),[...n.entries()].sort((e,t)=>"number"==typeof e[0]&&"number"==typeof t[0]?e[0]-t[0]:String(e[0]).localeCompare(String(t[0]))).map(([e,t])=>({value:e,label:t}))}function o(e,i){if(!e)return null;if(Array.isArray(e))return null;if("string"==typeof e)return e;const n=e["@@function"],o=e.attr;return n&&o?"colorCategories"===n?function(e,i){const n=Array.isArray(e.domain)?e.domain:[];let o=e.categories?e.categories.map(e=>"object"==typeof e?e:{value:e,label:String(e)}):n.length?n.map(e=>({value:e,label:String(e?.label??e)})):l(i,e.attr,e.labelAttr);if(!o.length)return"rgba(128,128,128,0.5)";let a=t(e.colors||"Bold",Math.max(o.length,3));a&&a.length||(a=r);const s=e.nullColor?`rgb(${e.nullColor.slice(0,3).join(",")})`:"rgba(128,128,128,0.5)",c=["match",["get",e.attr]];return o.forEach((e,t)=>{c.push(e.value),c.push(a[t%a.length])}),c.push(s),e._detectedCategories=o,c}(e,i):"colorContinuous"===n?function(e){if(!e.domain?.length)return null;const[i,n]=e.domain,r=i>n,l=r?[n,i]:[i,n],o=!!e.reverse,a=e.steps||7;let s=t(e.colors||"TealGrn",a);if(!s||!s.length)return["interpolate",["linear"],["get",e.attr],l[0],"rgb(237,248,251)",l[1],"rgb(0,109,44)"];(r?!o:o)&&(s=[...s].reverse());const c=["interpolate",["linear"],["get",e.attr]];return s.forEach((e,t)=>{const i=l[0]+(l[1]-l[0])*t/(s.length-1);c.push(i),c.push(e)}),c}(e):null:null}function a(e){if(null==e)return null;try{if("string"==typeof e){const t=e.startsWith("0x")?e.slice(2):e;return/^\d+$/.test(t)?BigInt(t).toString(16):(/[a-f]/i.test(t),t.toLowerCase())}if("number"==typeof e)return BigInt(Math.trunc(e)).toString(16);if("bigint"==typeof e)return e.toString(16)}catch(e){}return null}function s(e){const t=[];for(const i of e){const e=a(i.hex??i.h3??i.index??i.id);if(e&&window.h3?.isValidCell(e))try{const n=window.h3.cellToBoundary(e).map(([e,t])=>[t,e]);n.push(n[0]),t.push({type:"Feature",properties:{...i,hex:e},geometry:{type:"Polygon",coordinates:[n]}})}catch(e){}}return{type:"FeatureCollection",features:t}}function c(e,t,n,r){const l=t.hexLayer||{},a=t.data||[];try{const i=e.getSource(t.id);i&&"function"==typeof i.setData?i.setData(n):i||e.addSource(t.id,{type:"geojson",data:n})}catch(e){}const s=Array.isArray(l.getFillColor)?i(l.getFillColor,.8):o(l.getFillColor,a)||"rgba(0,144,255,0.7)",c=l.getLineColor?Array.isArray(l.getLineColor)?i(l.getLineColor,1):o(l.getLineColor,a):"rgba(255,255,255,0.3)",d="number"==typeof l.opacity&&isFinite(l.opacity)?Math.max(0,Math.min(1,l.opacity)):.8;if(l.extruded){const i=l.elevationScale||1,n=l.elevationProperty||l.getFillColor?.attr||null;e.addLayer({id:`${t.id}-extrusion`,type:"fill-extrusion",source:t.id,paint:{"fill-extrusion-color":s,"fill-extrusion-height":n?["*",["to-number",["get",n],0],i]:100,"fill-extrusion-base":0,"fill-extrusion-opacity":d},layout:{visibility:r?"visible":"none"}})}else!1!==l.filled&&e.addLayer({id:`${t.id}-fill`,type:"fill",source:t.id,paint:{"fill-color":s,"fill-opacity":d},layout:{visibility:r?"visible":"none"}});!1!==l.stroked&&e.addLayer({id:`${t.id}-outline`,type:"line",source:t.id,paint:{"line-color":c,"line-width":l.lineWidthMinPixels||.5},layout:{visibility:r?"visible":"none"}})}function d(e,t,i,n){(n?[`${t}-extrusion`,`${t}-outline`]:[`${t}-fill`,`${t}-outline`]).forEach(t=>{try{e.getLayer(t)&&e.setLayoutProperty(t,"visibility",i?"visible":"none")}catch(e){}})}function u(e,t,i){const n=t.geojson;if(!n?.features?.length)return;e.addSource(t.id,{type:"geojson",data:n});const r=n.features.map(e=>e.properties||{}),l=t.fillColorConfig?.["@@function"]?o(t.fillColorConfig,r):t.fillColorRgba||"rgba(0,144,255,0.6)",a=t.lineColorConfig?.["@@function"]?o(t.lineColorConfig,r):t.lineColorRgba||"rgba(100,100,100,0.8)",s="number"==typeof t.lineWidth&&isFinite(t.lineWidth)?t.lineWidth:1,c="number"==typeof t.opacity&&isFinite(t.opacity)?Math.max(0,Math.min(1,t.opacity)):.8;let d=!1,u=!1,y=!1;for(const e of n.features){const t=e.geometry?.type;"Point"!==t&&"MultiPoint"!==t||(u=!0),"Polygon"!==t&&"MultiPolygon"!==t||(d=!0),"LineString"!==t&&"MultiLineString"!==t||(y=!0)}d&&(!1!==t.isFilled&&e.addLayer({id:`${t.id}-fill`,type:"fill",source:t.id,paint:{"fill-color":l,"fill-opacity":c},filter:["any",["==",["geometry-type"],"Polygon"],["==",["geometry-type"],"MultiPolygon"]],layout:{visibility:i?"visible":"none"}}),!1!==t.isStroked&&e.addLayer({id:`${t.id}-outline`,type:"line",source:t.id,layout:{"line-join":"round","line-cap":"round",visibility:i?"visible":"none"},paint:{"line-color":a,"line-width":s},filter:["any",["==",["geometry-type"],"Polygon"],["==",["geometry-type"],"MultiPolygon"]]})),y&&e.addLayer({id:`${t.id}-line`,type:"line",source:t.id,layout:{"line-join":"round","line-cap":"round",visibility:i?"visible":"none"},paint:{"line-color":a,"line-width":s,"line-opacity":1},filter:["any",["==",["geometry-type"],"LineString"],["==",["geometry-type"],"MultiLineString"]]}),u&&e.addLayer({id:`${t.id}-circle`,type:"circle",source:t.id,paint:{"circle-radius":t.pointRadius||6,"circle-color":l,"circle-stroke-color":"rgba(0,0,0,0.5)","circle-stroke-width":1,"circle-opacity":.9},filter:["any",["==",["geometry-type"],"Point"],["==",["geometry-type"],"MultiPoint"]],layout:{visibility:i?"visible":"none"}})}function y(e,t,i){const n=t.sourceLayer||"udf";e.addSource(t.id,{type:"vector",tiles:[t.tileUrl],minzoom:t.minzoom||0,maxzoom:t.maxzoom||22});const r=t.fillColorConfig?.["@@function"]?o(t.fillColorConfig,void 0):t.fillColor||"#FFF5CC",l=t.lineColorConfig?.["@@function"]?o(t.lineColorConfig,void 0):t.lineColor||"#FFFFFF",a=t.fillOpacity??.8,s=t.lineWidth??1;!1!==t.isFilled&&e.addLayer({id:`${t.id}-fill`,type:"fill",source:t.id,"source-layer":n,paint:{"fill-color":r,"fill-opacity":a},layout:{visibility:i?"visible":"none"}}),e.addLayer({id:`${t.id}-line`,type:"line",source:t.id,"source-layer":n,paint:{"line-color":l,"line-width":s},layout:{visibility:i?"visible":"none"}}),t.isExtruded&&e.addLayer({id:`${t.id}-extrusion`,type:"fill-extrusion",source:t.id,"source-layer":n,paint:{"fill-extrusion-color":r,"fill-extrusion-height":["*",["get",t.heightProperty||"height"],t.heightMultiplier||1],"fill-extrusion-base":0,"fill-extrusion-opacity":t.extrusionOpacity??.9},layout:{visibility:i?"visible":"none"}})}function p(e,t,i){[`${t}-fill`,`${t}-outline`,`${t}-line`,`${t}-circle`,`${t}-extrusion`].forEach(t=>{try{e.getLayer(t)&&e.setLayoutProperty(t,"visibility",i?"visible":"none")}catch(e){}})}function f(e,t,i){const n=t.opacity??t.rasterLayer?.opacity??1,r="string"==typeof t.tileUrl&&t.tileUrl.length>0,l="string"==typeof t.imageUrl&&t.imageUrl.length>0&&Array.isArray(t.imageBounds)&&4===t.imageBounds.length;if(r||l){if(l){const i=function(e){const[t,i,n,r]=e;return[[t,r],[n,r],[n,i],[t,i]]}(t.imageBounds);e.addSource(t.id,{type:"image",url:t.imageUrl,coordinates:i})}else e.addSource(t.id,{type:"raster",tiles:[t.tileUrl],tileSize:256});var o;e.addLayer({id:`${t.id}-raster`,type:"raster",source:t.id,paint:{"raster-opacity":(o=n,Math.max(0,Math.min(1,o)))},layout:{visibility:i?"visible":"none"}})}}function g(e,t,i){const n=`${t}-raster`;try{e.getLayer(n)&&e.setLayoutProperty(n,"visibility",i?"visible":"none")}catch(e){}}let h=null;function m(){return window.deck||null}function b(e,i,n){if(!n)return null;if(Array.isArray(n))return n;if("string"==typeof n&&n.startsWith("@@=")){const e=n.slice(3);return t=>{try{return new Function("object",`const properties = object?.properties || object || {}; return (${e});`)(t)}catch{return null}}}if("object"==typeof n&&n["@@function"]){const r=n["@@function"],l=n.attr;if(!l)return null;if("colorContinuous"===r){const e=n.domain;if(!Array.isArray(e)||e.length<2)return null;const i=Number(e[0]),r=Number(e[e.length-1]);if(!Number.isFinite(i)||!Number.isFinite(r)||i===r)return null;const o=Math.max(2,Number(n.steps??7)),a=t(n.colors||"ArmyRose",o)||null;if(!a?.length)return null;const s=i>r,c=!!n.reverse,d=(s?!c:c)?[...a].reverse():[...a],u=Math.min(i,r),y=Math.max(i,r),p=Array.isArray(n.nullColor)?n.nullColor:[184,184,184];return e=>{const t=(e?.properties||e||{})[l];let i=null;if("number"==typeof t)i=t;else if("string"==typeof t){const e=parseFloat(t);i=Number.isFinite(e)?e:null}if(null==i||!Number.isFinite(i))return p;const n=(i-u)/(y-u),r=Math.max(0,Math.min(d.length-1,Math.round(n*(d.length-1)))),o=d[r].replace("#","");return[parseInt(o.slice(0,2),16),parseInt(o.slice(2,4),16),parseInt(o.slice(4,6),16)]}}if("colorCategories"===r){const r=Array.isArray(n.categories)?n.categories:Array.isArray(n.domain)?n.domain:[],o=n.colors||"Bold",a=Array.isArray(n.nullColor)?n.nullColor:[184,184,184];if(r.length){const e=t(o,Math.max(r.length,3))||null,i=new Map;e?.length&&r.forEach((t,n)=>{const r=e[n%e.length]||"#999999",l=String(r).replace("#",""),o=parseInt(l.slice(0,2),16),a=parseInt(l.slice(2,4),16),s=parseInt(l.slice(4,6),16);i.set(String(t?.value??t),[o,a,s])});try{n._detectedCategories=r.map(e=>"object"==typeof e?{value:e.value,label:String(e.label??e.value)}:{value:e,label:String(e)})}catch(e){}return e=>{const t=(e?.properties||e||{})[l];return null==t?a:i.get(String(t))||a}}const s=i.id;e.catState[s]=e.catState[s]||{};const c=e.catState[s][l]||{lut:new Map,pairs:[],next:0};e.catState[s][l]=c;const d=t(o,12)||null,u=d?.length?d:["#7fc97f","#beaed4","#fdc086","#ffff99","#386cb0","#f0027f","#bf5b17","#666666"],y=()=>{try{if(c.debounce)return;c.debounce=setTimeout(()=>{c.debounce=null;try{window.dispatchEvent(new CustomEvent("fusedmaps:legend:update"))}catch(e){}},150)}catch(e){}};return e=>{const t=(e?.properties||e||{})[l];if(null==t||""===t||"null"===t)return a;const i=String(t);let r=c.lut.get(i);if(!r){const e=u[c.next%u.length]||"#999999";c.next+=1;const t=String(e).replace("#","");r=[parseInt(t.slice(0,2),16),parseInt(t.slice(2,4),16),parseInt(t.slice(4,6),16)],c.lut.set(i,r),c.pairs.length<50&&c.pairs.push({value:i,label:i});try{n._detectedCategories=c.pairs}catch(e){}y()}return r||a}}}return null}function v(e,t,i){const n=Math.PI-2*Math.PI*t/Math.pow(2,i),r=e/Math.pow(2,i)*360-180,l=180/Math.PI*Math.atan(Math.sinh(n)),o=Math.PI-2*Math.PI*(t+1)/Math.pow(2,i),a=(e+1)/Math.pow(2,i)*360-180;return{west:r,south:180/Math.PI*Math.atan(Math.sinh(o)),east:a,north:l}}function C(e,t){return!(e.east<t.west||e.west>t.east||e.north<t.south||e.south>t.north)}function x(e){const t=e.hexLayer?.getFillColor;if(!t||"object"!=typeof t||Array.isArray(t))return{enabled:!1,attr:null};if("colorContinuous"!==t["@@function"])return{enabled:!1,attr:null};const i=t.attr||null;if(!i)return{enabled:!1,attr:null};if(!0===e.fillDomainFromUser||!0===t.fillDomainFromUser)return{enabled:!1,attr:i};const n=Array.isArray(t.domain)&&t.domain.length>=2;return{enabled:!0===t.autoDomain||!n,attr:i}}function E(e){if(null==e)return null;if("number"==typeof e)return Number.isFinite(e)?e:null;if("bigint"==typeof e){const t=Number(e);return Number.isFinite(t)?t:null}if("string"==typeof e){const t=parseFloat(e);return Number.isFinite(t)?t:null}return null}function L(e,t,i,n,r){return function(e,t,i,n){if(e.getZoom()<10)return null;const r=t.tileStats[i.id];if(!r)return null;const l=e.getBounds(),o={west:l.getWest(),east:l.getEast(),south:l.getSouth(),north:l.getNorth()};let a=Number.POSITIVE_INFINITY,s=Number.NEGATIVE_INFINITY,c=0;for(const[e,t]of Object.entries(r)){const[i,r,l]=e.split("/").map(Number);Number.isFinite(i)&&Number.isFinite(r)&&Number.isFinite(l)&&(Math.abs(i-n)>1||C(v(r,l,i),o)&&(Number.isFinite(t.min)&&(a=Math.min(a,t.min),c++),Number.isFinite(t.max)&&(s=Math.max(s,t.max))))}if(c<2||!Number.isFinite(a)||!Number.isFinite(s))return null;const d=s-a;if(Number.isFinite(d)&&d>0){const e=.01*d;a-=e,s+=e}return a>=s?[a-1,s+1]:[a,s]}(e,t,i,r)}function w(e,t){const i=e.hexLayer?.getFillColor;if(!i||"object"!=typeof i)return!1;const n=i._dynamicDomain;return!!(!Array.isArray(n)||n.length<2||(()=>{const e=n[1]-n[0]?n[1]-n[0]:1;return Math.abs(t[0]-n[0])/e>.05||Math.abs(t[1]-n[1])/e>.05})())&&(i._dynamicDomain=t,!0)}function S(e){const t=e.tileLayerConfig||{};return{tileSize:t.tileSize??256,minZoom:t.minZoom??0,maxZoom:t.maxZoom??19,zoomOffset:t.zoomOffset??0,maxRequests:t.maxRequests??10,refinementStrategy:t.refinementStrategy??"best-available"}}function A(e,t,i,n){const r=m();if(!r)return[];const l=r.TileLayer,o=r.H3HexagonLayer||r?.GeoLayers?.H3HexagonLayer;return l&&o?e.filter(e=>"hex"===e.layerType&&e.isTileLayer&&e.tileUrl).map(e=>e).filter(e=>!1!==t[e.id]).slice().reverse().map(e=>{const t=e.tileUrl,r=S(e),s=e.hexLayer||{},c=s.getFillColor,d=c&&"object"==typeof c&&!Array.isArray(c)&&Array.isArray(c._dynamicDomain)?{...c,domain:c._dynamicDomain}:c,u=s.getLineColor,y=u&&"object"==typeof u&&!Array.isArray(u)&&Array.isArray(u._dynamicDomain)?{...u,domain:u._dynamicDomain}:u,p=b(i,e,d),f=b(i,e,y),g=function(e){let t=5381;for(let i=0;i<e.length;i++)t=(t<<5)+t^e.charCodeAt(i);return(t>>>0).toString(16)}(`${JSON.stringify({fd:d&&"object"==typeof d?d.domain||d._dynamicDomain:null,ld:y&&"object"==typeof y?y.domain||y._dynamicDomain:null})}|${JSON.stringify({f:d,l:y,stroked:!1!==s.stroked,filled:!1!==s.filled,extruded:!0===s.extruded,opacity:s.opacity,elevationScale:s.elevationScale,coverage:s.coverage,lineWidthMinPixels:s.lineWidthMinPixels})}`),m=!1!==s.stroked,v=!1!==s.filled,C=!0===s.extruded,L="number"==typeof s.opacity?s.opacity:.8,w=s.lineWidthMinPixels??1,A=s.elevationScale??1,F=s.coverage??.9,$=s.elevationProperty||(d&&"object"==typeof d?d.attr:null)||null,M=x(e),T=r.refinementStrategy||(M.enabled?"no-overlap":"best-available");return new l({id:`${e.id}-tiles-${g}`,data:t,tileSize:r.tileSize,minZoom:r.minZoom,maxZoom:r.maxZoom,zoomOffset:r.zoomOffset,maxRequests:r.maxRequests,refinementStrategy:T,pickable:!0,visible:!0,getTileData:async({index:r,signal:l})=>{const{x:o,y:s,z:c}=r,d=t.replace("{z}",c).replace("{x}",o).replace("{y}",s),u=d,y=`${c}/${o}/${s}`;if(i.cache.has(u))return i.cache.get(u);if(i.inflight.has(u))try{return await i.inflight.get(u)}catch{return i.cache.get(u)||[]}n(1);const p=(async()=>{try{const n=await fetch(d,{signal:l});if(l?.aborted)return null;if(!n.ok)throw new Error(`tile http ${n.status}`);const o=(n.headers.get("Content-Type")||"").toLowerCase();let s,c=null;if(o.includes("application/octet-stream")||o.includes("application/parquet")||d.endsWith(".parquet")){let e=window.hyparquet;if(!e?.parquetMetadataAsync||!e?.parquetReadObjects)try{e=await async function(){const e=window;return e.hyparquet?.parquetMetadataAsync&&e.hyparquet?.parquetReadObjects?e.hyparquet:h||(h=(async()=>{const t=await new Function("u","return import(u)")("https://cdn.jsdelivr.net/npm/hyparquet@1.23.3/+esm"),i=t?.default&&(t.default.parquetReadObjects||t.default.parquetMetadataAsync)?t.default:t;return e.hyparquet=i,e.hyparquet})().catch(e=>{throw h=null,e}),h)}()}catch(e){return console.error("[tiles] failed to auto-load hyparquet",e),null}const t=await n.arrayBuffer();if(l?.aborted)return null;if(!t||0===t.byteLength)return[];const i={byteLength:t.byteLength,slice:async(e,i)=>t.slice(e,i)},r=await e.parquetMetadataAsync(i);if(c=r,l?.aborted)return null;s=await e.parquetReadObjects({file:i,utf8:!1,metadata:r})}else{let e=await n.text();if(l?.aborted)return null;e=e.replace(/\"(hex|h3|index|id)\"\s*:\s*(\d+)/gi,(e,t,i)=>`"${t}":"${i}"`),s=JSON.parse(e)}const p=(r=s,t=(Array.isArray(r)?r:Array.isArray(r?.data)?r.data:Array.isArray(r?.features)?r.features:[]).map(e=>e?.properties?{...e.properties}:{...e}).map(e=>{const t=a(e.hex??e.h3??e.index??e.id);if(!t)return null;const i={...e,hex:t};return{...i,properties:{...i}}}).filter(Boolean),(t||[]).map(e=>{const t=function(e){const t={};for(const i of Object.keys(e||{})){const n=e[i];if("bigint"==typeof n){const e=String(i).toLowerCase();"hex"===e||"h3"===e||"index"===e||"id"===e?t[i]=n.toString(16):n<=BigInt(Number.MAX_SAFE_INTEGER)&&n>=BigInt(Number.MIN_SAFE_INTEGER)?t[i]=Number(n):t[i]=n.toString()}else t[i]=n}return t}(e?.properties?e.properties:e||{});return{...t,properties:{...t}}}));i.cache.set(u,p);try{const t=x(e);if(t.enabled&&t.attr&&c){const n=function(e,t){const i=e?.row_groups||e?.rowGroups||e?.row_groups_list||null;if(!Array.isArray(i)||0===i.length)return null;let n=Number.POSITIVE_INFINITY,r=Number.NEGATIVE_INFINITY,l=!1;for(const e of i){const i=e?.columns||e?.columns_list||null;if(Array.isArray(i))for(const e of i){const i=e?.meta_data||e?.metaData||e?.metadata||null,o=i?.path_in_schema||i?.pathInSchema||i?.path||null,a=Array.isArray(o)?String(o[o.length-1]):"string"==typeof o?o:null;if(!a||a!==t)continue;const s=i?.statistics||i?.stats||e?.statistics||null;if(!s)continue;const c=E(s.min_value??s.min??s.minimum??s.minValue),d=E(s.max_value??s.max??s.maximum??s.maxValue);null!=c&&null!=d&&(l=!0,c<n&&(n=c),d>r&&(r=d))}}return l&&Number.isFinite(n)&&Number.isFinite(r)?n===r?{min:n-1,max:r+1}:{min:n,max:r}:null}(c,t.attr);if(n){i.tileStats[e.id]||(i.tileStats[e.id]={}),i.tileStats[e.id][y]={min:n.min,max:n.max};try{window.dispatchEvent(new CustomEvent("fusedmaps:autodomain:dirty"))}catch{}}}}catch(e){}return p}catch(e){return null}finally{i.inflight.delete(u),n(-1)}var t,r})();return i.inflight.set(u,p),await p},renderSubLayers:e=>{const t=e.data||[];return t&&t.length?new o({id:`${e.id}-h3`,data:t,getHexagon:e=>e.hex,pickable:!0,stroked:m,filled:v,extruded:C,opacity:L,coverage:F,lineWidthMinPixels:w,elevationScale:A,...C&&$?{getElevation:e=>Number(e?.[$]??0)}:{},...p?{getFillColor:p}:{},...f?{getLineColor:f}:{}}):null}})}):[]}let F=null,$=!1,M=null,T=null,k=null;const N=new Map;function O(e){const t=e?.json||{},i=[];if(Array.isArray(t.vector_layers))for(const e of t.vector_layers)e?.id&&i.push(String(e.id));if(t?.tilestats?.layers&&Array.isArray(t.tilestats.layers))for(const e of t.tilestats.layers){const t=e?.layer;t&&!i.includes(String(t))&&i.push(String(t))}return i}async function P(e){if(N.has(e))return N.get(e);const t=(async()=>{const t=new((await async function(){return T||k||(k=new Function("u","return import(u)")("https://cdn.jsdelivr.net/npm/pmtiles@3.0.6/+esm").then(e=>(T=e,T)).finally(()=>{k=null}),k)}()).PMTiles)(e);let i={};try{i=await t.getMetadata()}catch(e){i={}}const n=[];if(i?.vector_layers?.length>0)for(const e of i.vector_layers)e?.id&&n.push(String(e.id));if(i?.tilestats?.layers&&Array.isArray(i.tilestats.layers))for(const e of i.tilestats.layers){const t=e?.layer;t&&!n.includes(String(t))&&n.push(String(t))}return n})();return N.set(e,t),t.catch(()=>N.delete(e)),t}async function _(){return F||M||(window.mapboxPmTiles?(F=window.mapboxPmTiles,F):(M=new Promise((e,t)=>{const i=document.createElement("script");i.src="https://cdn.jsdelivr.net/npm/mapbox-pmtiles@1.0.54/dist/mapbox-pmtiles.umd.min.js",i.onload=()=>{F=window.mapboxPmTiles,e(F)},i.onerror=()=>t(new Error("Failed to load mapbox-pmtiles library")),document.head.appendChild(i)}).finally(()=>{M=null}),M))}function I(e,t,i="#ff8c00"){if(!e)return i;if("string"==typeof e)return e;if(Array.isArray(e))return e;const n=e["@@function"],r=e.attr||t;if("colorContinuous"===n){const t=e.domain||[0,100],i=e.steps||7,n=!!e.reverse;let l=e.colors;"string"==typeof l&&(l=function(e,t=7){const i=window.cartocolor,n=["#440154","#414487","#2a788e","#22a884","#7ad151","#fde725"];if(!i)return n;const r=i[e];if(r){const e=Object.keys(r).map(Number).filter(e=>!isNaN(e)).sort((e,t)=>t-e);return r[e.find(e=>e<=t)||e[e.length-1]]||n}return n}(l,i)),l&&Array.isArray(l)||(l=["#440154","#21918c","#fde725"]),n&&l.length>1&&(l=[...l].reverse());const o=["interpolate",["linear"],["coalesce",["to-number",["get",r]],0]],a=l.length;for(let e=0;e<a;e++){const i=e/(a-1),n=t[0]+i*(t[1]-t[0]);o.push(n,l[e])}return o}if("colorCategories"===n){const t=e.categories||{},i=e.othersColor||"#888888",n=["match",["get",r]];for(const[e,i]of Object.entries(t))n.push(e,i);return n.push(i),n}return i}async function j(e,t,i,n=!1){if(0===t.length)return;await async function(){if($)return;const e=window.mapboxgl;if(!e?.Style?.setSourceType)throw new Error("Mapbox GL JS v3 with Style.setSourceType is required for PMTiles");const t=await _();e.Style.setSourceType(t.SOURCE_TYPE,t.PmTilesSource),$=!0}();const r=await _();for(let l=0;l<t.length;l++){const o=t[l];if(!o.pmtilesUrl)continue;const a=!1!==i[o.id],s=`${o.id}-source`;try{const t=await r.PmTilesSource.getHeader(o.pmtilesUrl),i=[t.minLon,t.minLat,t.maxLon,t.maxLat];let c=O(t);const d=c[0]||"default",u="string"==typeof o.sourceLayer?o.sourceLayer.trim():"";if(!u&&0===c.length)try{c=await P(o.pmtilesUrl)}catch(e){}const y=c[0]||d,p=new Set([...o.excludeSourceLayers||[],...o.exclude_source_layers||[],...o.vectorLayer?.excludeSourceLayers||[],...o.vectorLayer?.exclude_source_layers||[]].filter(Boolean)),f=e=>e.filter(e=>!p.has(e)),g=!u&&c.length>1?f(c):c,h="*"===u?f(c):u?[u]:c.length>1?g:[y];0===h.length&&console.warn("[FusedMaps] PMTiles: could not detect any source-layers; set `source_layer` explicitly for:",o.id),u&&"*"!==u&&c.length>0&&!c.includes(u)&&console.warn("[FusedMaps] PMTiles: requested source-layer not found in header.json:",{requested:u,available:c}),e.getSource(s)||e.addSource(s,{type:r.SOURCE_TYPE,url:o.pmtilesUrl,minzoom:t.minZoom,maxzoom:t.maxZoom,bounds:i});const m=o.vectorLayer||{},b=o.fillOpacity??m.opacity??.8,v=o.lineWidth??1,C=o.pointRadiusMinPixels??4,x=!1!==o.isFilled,E=!1!==o.isStroked?v:0,L=x?b:0,w=!1!==o.renderPoints&&!1!==o.vectorLayer?.renderPoints,S=!1!==o.renderLines&&!1!==o.vectorLayer?.renderLines,A=!1!==o.renderPolygons&&!1!==o.vectorLayer?.renderPolygons,F=I(o.fillColorConfig||m.getFillColor,o.colorAttribute||"value","#ff8c00"),$=I(o.lineColorConfig||m.getLineColor,o.colorAttribute||"value","#ffffff"),M=e=>e.replace(/[^a-zA-Z0-9_-]+/g,"-");for(const t of h){const i=M(t||"default"),n={};if("number"==typeof o.minzoom&&(n.minzoom=o.minzoom),"number"==typeof o.maxzoom&&(n.maxzoom=o.maxzoom),w){const r=`${o.id}-${i}-circles`;e.getLayer(r)||e.addLayer({id:r,type:"circle",source:s,"source-layer":t,...n,paint:{"circle-radius":["interpolate",["exponential",2],["zoom"],0,.5*C,10,C,15,4*C,20,20*C],"circle-color":F,"circle-opacity":L,"circle-stroke-color":$,"circle-stroke-width":E},layout:{visibility:a?"visible":"none"}})}if(A){const r=`${o.id}-${i}-fill`;e.getLayer(r)||e.addLayer({id:r,type:"fill",source:s,"source-layer":t,...n,paint:{"fill-color":F,"fill-opacity":L},layout:{visibility:a?"visible":"none"}})}if(S){const r=`${o.id}-${i}-line`;e.getLayer(r)||e.addLayer({id:r,type:"line",source:s,"source-layer":t,...n,paint:{"line-color":$,"line-width":E,"line-opacity":b},layout:{visibility:a?"visible":"none"}})}}!n&&i&&0===l&&e.fitBounds([[i[0],i[1]],[i[2],i[3]]],{padding:50,duration:0})}catch(e){console.error(`[FusedMaps] Failed to add PMTiles layer ${o.id}:`,e)}}}const R={};function D(){return R}function q(e,t){R[e]=t}function z(e){delete R[e]}function B(e,t,i,n){!function(e,t){t.forEach(t=>{W(e,t)})}(e,t),[...t].reverse().forEach(t=>{const n=!1!==i[t.id];switch(t.layerType){case"hex":{const i=t;if(i.isTileLayer);else if(i.data?.length){const r=s(i.data);q(t.id,r),c(e,i,r,n)}break}case"vector":{const i=t;i.geojson&&(q(t.id,i.geojson),u(e,i,n));break}case"mvt":y(e,t,n);break;case"raster":f(e,t,n)}});let r=null;if(t.some(e=>"hex"===e.layerType&&e.isTileLayer&&e.tileUrl)){const n=function(e,t,i){const n=m();if(!n?.MapboxOverlay||!n?.TileLayer)return null;const r={cache:new Map,inflight:new Map,tilesLoading:0,tileStats:{},catState:{}},l=function(){let e=document.getElementById("tile-loader");e||(e=document.createElement("div"),e.id="tile-loader",e.innerHTML='<div class="loader-spinner"></div><span id="loader-text">Loading tiles...</span>',document.body.appendChild(e));const t=document.getElementById("loader-text");let i=null,n=0;return{setLoading:r=>{n=Math.max(0,n+r),e&&(n>0?(i&&clearTimeout(i),e.classList.add("active"),t&&(t.textContent=1===n?"Loading tile...":`Loading ${n} tiles...`)):i=setTimeout(()=>e?.classList.remove("active"),300))}}}(),o=()=>A(t,i,r,l.setLoading),a=new n.MapboxOverlay({interleaved:!0,useDevicePixels:!0,layers:o()});try{e.addControl(a)}catch{}const s=()=>{try{a.setProps({layers:o()});try{e.triggerRepaint?.()}catch{}}catch{}},c=t.filter(e=>"hex"===e.layerType&&e.isTileLayer).map(e=>({layer:e,...x(e),tileCfg:S(e)})).filter(e=>e.enabled&&e.attr);let d=null;const u=t=>{c.length&&(d&&clearTimeout(d),d=setTimeout(()=>{let t=!1;for(const i of c){const n=Math.round(e.getZoom())+(i.tileCfg.zoomOffset||0),l=L(e,r,i.layer,i.attr,n);l&&w(i.layer,l)&&(t=!0)}if(t){s();try{window.dispatchEvent(new CustomEvent("fusedmaps:legend:update"))}catch{}}},t))},y=()=>u(800),p=()=>u(1200),f=()=>u(150);if(c.length){e.on("moveend",y),e.on("idle",p);try{window.addEventListener("fusedmaps:autodomain:dirty",f)}catch{}u(1500)}return{overlay:a,rebuild:s,pickObject:e=>{try{return a.pickObject(e)}catch{return null}},destroy:()=>{d&&clearTimeout(d);try{e.off("moveend",y)}catch{}try{e.off("idle",p)}catch{}try{window.removeEventListener("fusedmaps:autodomain:dirty",f)}catch{}try{e.removeControl(a)}catch{}}}}(e,t,i);r=n?.overlay||null,r&&n&&(r.__fused_hex_tiles__=n)}const l=t.filter(e=>"pmtiles"===e.layerType);return l.length>0&&j(e,l,i,!0===n?.hasCustomView).catch(e=>{console.error("[FusedMaps] Failed to add PMTiles layers:",e)}),{deckOverlay:r}}function U(e,t,i,n){switch(t.layerType){case"hex":{const n=t;if(!n.isTileLayer&&n.data?.length){const r=s(n.data);q(t.id,r),c(e,n,r,i)}break}case"vector":{const n=t;n.geojson&&(q(t.id,n.geojson),u(e,n,i));break}case"mvt":y(e,t,i);break;case"raster":f(e,t,i);break;case"pmtiles":j(e,[t],{[t.id]:i},!0===n?.hasCustomView).catch(e=>{console.error("[FusedMaps] Failed to add PMTiles layer:",e)})}}function W(e,t){if("pmtiles"===t.layerType)return function(e,t){const i=`${t}-`,n=e.getStyle()?.layers||[];for(let t=n.length-1;t>=0;t--){const r=n[t]?.id;if(r&&r.startsWith(i))try{e.getLayer(r)&&e.removeLayer(r)}catch(e){}}const r=`${t}-source`;e.getSource(r)&&e.removeSource(r)}(e,t.id),void z(t.id);[`${t.id}-fill`,`${t.id}-extrusion`,`${t.id}-outline`,`${t.id}-circle`,`${t.id}-line`,`${t.id}-raster`,`${t.id}-circles`].forEach(t=>{try{e.getLayer(t)&&e.removeLayer(t)}catch(e){}});try{e.getSource(t.id)&&e.removeSource(t.id),e.getSource(`${t.id}-source`)&&e.removeSource(`${t.id}-source`)}catch(e){}z(t.id)}function H(e,t,i,n){try{e.getLayer(t)&&e.setPaintProperty(t,i,n)}catch(e){}}function V(e,t,i,n){try{e.getLayer(t)&&e.setLayoutProperty(t,i,n)}catch(e){}}function J(e,t,i){try{const n=e.getSource(t);if(n&&"function"==typeof n.setData)return n.setData(i),!0}catch(e){}return!1}let G=null,Z=null,Y=!1,X=!1,Q=null,K={},ee=null;function te(e){try{const t=e.target;if(!t)return;if(t.closest?.(".layer-drag"))return;const i=t.closest?.(".layer-item");if(!i)return;const n=i.getAttribute("data-layer-id")||"";if(!n)return;if(t.closest?.(".layer-eye")||t.closest?.(".layer-item")){const t=function(e){try{return Q?!1!==Q.get(e)?.visible:!1!==K[e]}catch(e){return!0}}(n);G?.(n,!t),e.preventDefault()}}catch(e){}}const ie='<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>',ne='<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/></svg>';function re(e,t,i,n){G=i;const r=n;Q=r||null,K=t||{};let l=document.getElementById("layer-panel");if(l||(l=document.createElement("div"),l.id="layer-panel",l.innerHTML='<div id="layer-list"></div>',document.body.appendChild(l)),ee=l,!X)try{l.addEventListener("click",te),X=!0}catch(e){}if(r?le(r):oe(e,t),r&&(Z=r.on("*",e=>{"visibility"!==e.type&&"reorder"!==e.type&&"add"!==e.type&&"remove"!==e.type&&"batch"!==e.type||le(r)})),!Y){Y=!0;try{window.addEventListener("fusedmaps:legend:update",()=>{try{r&&le(r)}catch(e){}})}catch(e){}}return{destroy:()=>{Z&&(Z(),Z=null);try{ee?.removeEventListener("click",te)}catch(e){}X=!1,ee=null,Q=null}}}function le(e){const t=document.getElementById("layer-list");if(!t)return;const i=e.getAll();t.innerHTML=i.map(e=>{const t=e.config,i=e.visible,n=ae(t),r=i?ie:ne;return`\n      <div class="layer-item ${i?"":"disabled"}" \n           data-layer-id="${t.id}"\n           data-order="${e.order}"\n           style="--layer-strip: ${n};">\n        <span class="layer-drag" title="Drag to reorder"><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor" opacity="0.5"><path d="M11 18c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zm-2-8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 4c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg></span>\n        <span class="layer-name">${t.name}</span>\n        <span class="layer-eye" title="Toggle visibility">${r}</span>\n      </div>\n    `}).join("")}function oe(e,t){const i=document.getElementById("layer-list");i&&(K=t||{},i.innerHTML=e.map(e=>{const i=!1!==t[e.id],n=ae(e),r=i?ie:ne;return`\n      <div class="layer-item ${i?"":"disabled"}" \n           data-layer-id="${e.id}" \n           style="--layer-strip: ${n};">\n        <span class="layer-name">${e.name}</span>\n        <span class="layer-eye" title="Toggle visibility">${r}</span>\n      </div>\n    `}).join(""))}function ae(e){let n="#0090ff";const r=e=>e&&e.length?1===e.length?e[0]:`linear-gradient(to bottom, ${e.map((t,i)=>`${t} ${i/(e.length-1)*100}%`).join(", ")})`:null;if("hex"===e.layerType){const l=e.hexLayer||{},o=!1===l.filled&&l.getLineColor?l.getLineColor:l.getFillColor;if(Array.isArray(o)){const e=i(o,1);e&&(n=e)}else if(o&&"object"==typeof o){const e=o["@@function"];if("colorContinuous"===e||"colorCategories"===e){let i=t(o.colors||("colorCategories"===e?"Bold":"TealGrn"),o.steps||7);if(i?.length){const e=o.domain,t=Array.isArray(e)&&e.length>=2&&e[0]>e[e.length-1],l=!!o.reverse;(t?!l:l)&&(i=[...i].reverse()),n=r(i)||n}}}}else if("vector"===e.layerType){const i=e;if(i.lineColorRgba&&!i.isFilled)n=i.lineColorRgba;else if(i.fillColorRgba)n=i.fillColorRgba;else if(i.fillColorConfig&&"object"==typeof i.fillColorConfig){const e=i.fillColorConfig.colors;if(e){const i=t(e,7);i?.length&&(n=r(i)||n)}}}else if("pmtiles"===e.layerType){const i=e;if(i.fillColorConfig&&"object"==typeof i.fillColorConfig){const e=i.fillColorConfig.colors;if(e){let l=t(e,7);l?.length&&(!!i.fillColorConfig.reverse&&(l=[...l].reverse()),n=r(l)||n)}}}else"raster"===e.layerType&&(n="linear-gradient(to bottom, #888, #444)");return n}function se(e,i,o){const a=document.getElementById("color-legend");if(!a)return;const s=e.filter(e=>!1!==i[e.id]);if(!s.length)return void(a.style.display="none");let c="";s.forEach(e=>{const i=function(e,i){let o=null;if("hex"===e.layerType){const t=e.hexLayer||{};o=!1===t.filled&&t.getLineColor?t.getLineColor:t.getFillColor}else if("vector"===e.layerType){const t=e;if(o=t.fillColorConfig,!o?.["@@function"]&&t.lineColorRgba&&!t.isFilled)return`\n        <div class="legend-layer">\n          <div class="legend-title">\n            <span class="legend-line" style="background:${t.lineColorRgba};"></span>\n            ${e.name}\n          </div>\n        </div>\n      `}const a=o?.["@@function"];if(!a||!o?.attr)return"";if("colorContinuous"!==a&&"colorCategories"!==a)return"";const s=o.colors||("colorCategories"===a?"Bold":"TealGrn");if("colorCategories"===a){try{const t=o;if(!(Array.isArray(t._detectedCategories)&&t._detectedCategories.length||Array.isArray(t.categories)&&t.categories.length)&&t.attr){let n=[];const r=i?.[e.id];if(r?.features?.length)n=r.features.map(e=>e?.properties||{});else if("hex"===e.layerType)n=e.data||[];else if("vector"===e.layerType){const t=e.geojson;t?.features?.length&&(n=t.features.map(e=>e?.properties||{}))}const o=l(n,t.attr,t.labelAttr);t._detectedCategories=o.slice(0,50)}}catch(e){}return function(e,i,n){let l=i._detectedCategories||i.categories||[];if(l=l.map(e=>"object"==typeof e&&e.label?e:{value:e,label:e}),!l.length)return"";let o=t(n,Math.max(l.length,3));o?.length||(o=r);const a=i.labelAttr||i.attr;return`\n    <div class="legend-layer">\n      <div class="legend-title">\n        <span class="legend-dot" style="background:${o[0]};"></span>\n        ${e}: ${a}\n      </div>\n      <div class="legend-categories">\n        ${l.map((e,t)=>`\n          <div class="legend-cat-item">\n            <div class="legend-cat-swatch" style="background:${o[t%o.length]};"></div>\n            <span class="legend-cat-label" title="${e.label}">${e.label}</span>\n          </div>\n        `).join("")}\n      </div>\n    </div>\n  `}(e.name,o,s)}return"colorContinuous"===a?function(e,i,r){const l=i._dynamicDomain||i.domain;if(!l?.length)return"";const[o,a]=l,s=o>a;let c=t(r,i.steps||7);c?.length||(c=n),s&&(c=[...c].reverse());const d=`linear-gradient(to right, ${c.map((e,t)=>`${e} ${t/(c.length-1)*100}%`).join(", ")})`;return`\n    <div class="legend-layer">\n      <div class="legend-title">\n        <span class="legend-dot" style="background:${c[Math.floor(c.length/2)]};"></span>\n        ${e}: ${i.attr}\n      </div>\n      <div class="legend-gradient" style="background:${d};"></div>\n      <div class="legend-labels">\n        <span>${o.toFixed(1)}</span>\n        <span>${a.toFixed(1)}</span>\n      </div>\n    </div>\n  `}(e.name,o,s):""}(e,o);i&&(c+=i)}),c?(a.innerHTML=c,a.style.display="block"):a.style.display="none"}function ce(e,t,i){const n={...t};class r{onAdd(e){this._map=e;const t=document.createElement("div");t.className="mapboxgl-ctrl mapboxgl-ctrl-group";const r=(e,t,i)=>{const n=document.createElement("button");return n.type="button",n.title=t,n.setAttribute("aria-label",t),n.style.fontSize="16px",n.style.lineHeight="20px",n.style.fontWeight="600",n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.textContent=e,n.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation();try{i()}catch(e){}}),n};return t.appendChild(r("+","Zoom in",()=>e.zoomIn({duration:250}))),t.appendChild(r("−","Zoom out",()=>e.zoomOut({duration:250}))),t.appendChild(r("⌂","Reset view",()=>{e.easeTo({center:[n.longitude,n.latitude],zoom:Number.isFinite(n.zoom)?n.zoom:e.getZoom(),pitch:Number.isFinite(n.pitch??0)?n.pitch??0:e.getPitch(),bearing:Number.isFinite(n.bearing??0)?n.bearing??0:e.getBearing(),duration:600})})),i&&t.appendChild(((t,i)=>{const n=document.createElement("button");return n.type="button",n.title=i,n.setAttribute("aria-label",i),n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.innerHTML='<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" style="display:block">\n              <path d="M4 8h3l1.2-2h7.6L17 8h3a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2z"/>\n              <circle cx="12" cy="14" r="3.2"/>\n            </svg>',n.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation();try{!function(e){const t=`map-screenshot-${(new Date).toISOString().replace(/[:.]/g,"-")}.png`;try{const i=e.getCanvas(),n=document.createElement("a");if(n.download=t,"function"==typeof i.toBlob)return void i.toBlob(e=>{try{if(!e)throw new Error("toBlob returned null");const t=URL.createObjectURL(e);n.href=t,document.body.appendChild(n),n.click(),n.remove(),setTimeout(()=>URL.revokeObjectURL(t),1e3)}catch(e){console.error("Screenshot failed:",e),alert("Screenshot blocked (likely due to CORS/tainted canvas from raster tiles). Try using only CORS-enabled layers/tiles.")}},"image/png");const r=i.toDataURL("image/png");n.href=r,document.body.appendChild(n),n.click(),n.remove()}catch(e){console.error("Screenshot failed:",e),alert("Screenshot blocked (likely due to CORS/tainted canvas from raster tiles). Try using only CORS-enabled layers/tiles.")}}(e)}catch(e){}}),n})(0,"Download screenshot")),this._container=t,t}onRemove(){try{this._container?.parentNode?.removeChild(this._container)}catch(e){}this._map=void 0,this._container=void 0}}try{e.addControl(new r,"bottom-left")}catch(e){}return{setHomeViewState:e=>{try{if(!e)return;"number"==typeof e.longitude&&Number.isFinite(e.longitude)&&(n.longitude=e.longitude),"number"==typeof e.latitude&&Number.isFinite(e.latitude)&&(n.latitude=e.latitude),"number"==typeof e.zoom&&Number.isFinite(e.zoom)&&(n.zoom=e.zoom),"number"==typeof e.pitch&&Number.isFinite(e.pitch)&&(n.pitch=e.pitch),"number"==typeof e.bearing&&Number.isFinite(e.bearing)&&(n.bearing=e.bearing)}catch(e){}}}}function de(e,t,i){!function(e){try{e.addControl(new mapboxgl.ScaleControl({maxWidth:110,unit:"metric"}),"bottom-left")}catch(e){}}(e);const n=ce(e,t,i),r=function(e){const t=e.getCanvasContainer?.()||e.getCanvas?.();if(!t)return()=>{};let i=!1,n=0,r=0,l=0,o=0;const a=()=>{if(i){i=!1;try{e.dragPan.enable()}catch(e){}try{t.style.cursor=""}catch(e){}window.removeEventListener("pointermove",s,{passive:!1}),window.removeEventListener("pointerup",c,{passive:!1}),window.removeEventListener("pointercancel",c,{passive:!1})}},s=t=>{if(!i)return;if(!t.metaKey)return a();const s=t.clientX-n,c=t.clientY-r;var d;e.setBearing(l+.35*s),e.setPitch((d=o-.25*c,Math.max(0,Math.min(85,d)))),t.preventDefault()},c=e=>{a();try{e.preventDefault()}catch(e){}},d=a=>{if(0===a.button&&a.ctrlKey&&!a.metaKey)return a.preventDefault(),void a.stopPropagation();if(!i&&0===a.button&&a.metaKey){i=!0,n=a.clientX,r=a.clientY,l=e.getBearing(),o=e.getPitch();try{e.dragPan.disable()}catch(e){}try{t.style.cursor="grabbing"}catch(e){}window.addEventListener("pointermove",s,{passive:!1}),window.addEventListener("pointerup",c,{passive:!1}),window.addEventListener("pointercancel",c,{passive:!1}),a.stopPropagation(),a.preventDefault()}};return t.addEventListener("pointerdown",d,{passive:!1,capture:!0}),()=>{try{a()}catch(e){}try{t.removeEventListener("pointerdown",d,{capture:!0})}catch(e){}}}(e);return{destroy:()=>{try{r()}catch(e){}},setHomeViewState:n?.setHomeViewState}}function ue(e){return!!e&&"object"==typeof e&&!Array.isArray(e)}function ye(e,t){if(e===t)return!0;if(typeof e!=typeof t)return!1;if(Array.isArray(e)&&Array.isArray(t)){if(e.length!==t.length)return!1;for(let i=0;i<e.length;i++)if(!ye(e[i],t[i]))return!1;return!0}if(ue(e)&&ue(t)){const i=Object.keys(e),n=Object.keys(t);if(i.length!==n.length)return!1;for(const n of i){if(!(n in t))return!1;if(!ye(e[n],t[n]))return!1}return!0}return!1}function pe(e,t){if(ye(e,t))return;if(Array.isArray(t))return t;if(!ue(t))return t;const i={};for(const n of Object.keys(t)){const r=pe(e?.[n],t[n]);void 0!==r&&(i[n]=r)}return Object.keys(i).length?i:void 0}function fe(e,t=0){const i=e=>"  ".repeat(e),n=t+1;if(null==e)return"None";const r=typeof e;if("boolean"===r)return e?"True":"False";if("number"===r)return Number.isFinite(e)?String(e):"None";if("string"===r){if(e.startsWith("@@py:")){const t=e.slice(5).trim();if(/^[A-Za-z_][A-Za-z0-9_\\.]*$/.test(t))return t}return JSON.stringify(e)}if(Array.isArray(e))return e.length?`[\n${e.map(e=>`${i(n)}${fe(e,n)}`).join(",\n")}\n${i(t)}]`:"[]";if(ue(e)){const r=Object.keys(e);return r.length?`{\n${r.map(t=>`${i(n)}${JSON.stringify(t)}: ${fe(e[t],n)}`).join(",\n")}\n${i(t)}}`:"{}"}try{return JSON.stringify(String(e))}catch{return"None"}}function ge(e,t){try{e.innerHTML=t.map(e=>`<option value="${e}">${e}</option>`).join("")}catch(e){}}function he(e,t,i){const n=function(e,t){try{const i=window.cartocolor?.[e];if(!i)return null;const n=Object.keys(i).map(e=>Number(e)).filter(e=>Number.isFinite(e)).sort((e,t)=>e-t),r=i[n.find(e=>e>=t)??n[n.length-1]];return Array.isArray(r)?[...r]:null}catch(e){return null}}(e,Math.max(t,3)),r=i&&n?.length?[...n].reverse():n;return r?.length?`linear-gradient(90deg, ${r.map((e,t)=>`${e} ${t/Math.max(1,r.length-1)*100}%`).join(", ")})`:"linear-gradient(90deg, #555, #999)"}function me(e){const t=!!e.getReverse(),i=Math.max(2,Math.min(20,e.getSteps()));e.menuEl.innerHTML=e.palettes.map(e=>`<div class="pal-item" data-pal="${e}" title="${e}">\n        <div class="pal-item-swatch" style="background:${he(e,i,t)};"></div>\n      </div>`).join(""),e.menuEl.querySelectorAll(".pal-item").forEach(t=>{t.addEventListener("click",i=>{try{i.preventDefault(),i.stopPropagation()}catch(e){}const n=t.getAttribute("data-pal")||"";n&&(e.selectEl.value=n),e.menuEl.style.display="none";try{e.onPicked()}catch(e){}})})}function be(e){try{const t=!!e.getReverse(),i=Math.max(2,Math.min(20,e.getSteps())),n=e.selectEl.value||"Palette";e.swatchEl.style.background=he(n,i,t),e.triggerEl.title=n}catch(e){}}const ve="debug-shell";function Ce(e,t,i){return Math.max(t,Math.min(i,e))}function xe(e,t,i,n){try{e.getLayer(t)&&e.setPaintProperty(t,i,n)}catch(e){}}function Ee(e,t,i,n){try{const r=e.getStyle?.()?.layers||[];for(const l of r){const r=l?.id;if(r&&r.startsWith(t)&&e.getLayer(r))try{e.setPaintProperty(r,i,n)}catch(e){}}}catch(e){}}function Le(e,t){try{const i=String(e||"").trim();if(!/^#[0-9a-fA-F]{6}$/.test(i))return null;const n=parseInt(i.slice(1,3),16),r=parseInt(i.slice(3,5),16),l=parseInt(i.slice(5,7),16);return"number"==typeof t&&Number.isFinite(t)?[n,r,l,Math.max(0,Math.min(255,Math.round(t)))]:[n,r,l]}catch(e){return null}}function we(e,t){try{return Number.isFinite(e)?e.toFixed(t):""}catch{return""}}function Se(e,t,i){try{const n=t.getBoundingClientRect().width||280;e.style.setProperty("--debug-panel-w",`${n}px`);const r=t.classList.contains("collapsed");i.style.left=r?"0px":`var(--debug-panel-w, ${n}px)`}catch(e){}}function Ae(e,t,i){return Math.max(t,Math.min(i,e))}function Fe(e){return e&&"object"==typeof e?"colorContinuous"!==e["@@function"]?null:e:null}function $e(e){const t=new Set;try{const i=e.hexLayer?.getFillColor,n=e.hexLayer?.getLineColor;i?.attr&&t.add(String(i.attr)),n?.attr&&t.add(String(n.attr));const r=e.hexLayer?.tooltipAttrs;Array.isArray(r)&&r.forEach(e=>t.add(String(e)))}catch(e){}return[...t].filter(Boolean)}function Me(e){try{const t=e.geojson?.features?.[0],i=t?.properties||{};return Object.keys(i||{}).filter(e=>e&&"_fused_idx"!==e)}catch(e){return[]}}const Te={filled:!0,stroked:!0,pickable:!0,extruded:!1,elevationScale:1,opacity:1,getHexagon:"@@=properties.hex",getFillColor:{"@@function":"colorContinuous",attr:"cnt",steps:20,colors:"ArmyRose",nullColor:[184,184,184]},getLineColor:[255,255,255],lineWidthMinPixels:1},ke={minZoom:0,maxZoom:19,zoomOffset:0},Ne={filled:!0,stroked:!0,pickable:!0,opacity:.8,lineWidthMinPixels:0,pointRadiusMinPixels:10,getFillColor:{"@@function":"colorContinuous",attr:"house_age",domain:[0,50],colors:"ArmyRose",steps:7,nullColor:[200,200,200,180]}};function Oe(t,i){const n=i.sidebar||(i.debug?"show":null),{shell:r,panel:l,toggle:a,resizeHandle:d}=function(){let e=document.getElementById(ve);e||(e=document.createElement("div"),e.id=ve,e.innerHTML='\n      <div id="debug-panel">\n        <div id="debug-content">\n          <div class="debug-section">\n            <div class="debug-section-title">Editing Layer</div>\n            <div class="debug-row">\n              <span class="debug-label">Layer</span>\n              <select class="debug-select" id="dbg-layer-select"></select>\n            </div>\n          </div>\n\n          <div class="debug-section" id="dbg-hex-section">\n            <div class="debug-section-title">Hex Layer</div>\n            <div class="debug-toggles">\n              <label class="debug-checkbox"><input type="checkbox" id="dbg-filled" checked /> Filled</label>\n              <label class="debug-checkbox"><input type="checkbox" id="dbg-stroked" checked /> Stroked</label>\n              <label class="debug-checkbox"><input type="checkbox" id="dbg-extruded" /> Extruded</label>\n            </div>\n            <div id="dbg-extrusion-controls" style="display:none;margin-top:8px;">\n              <div class="debug-row">\n                <span class="debug-label">Height attr</span>\n                <select class="debug-select" id="dbg-elev-attr"></select>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label">Height scale</span>\n                <input type="number" class="debug-input debug-input-sm" id="dbg-elev-scale" step="0.1" value="1" />\n              </div>\n            </div>\n            <div class="debug-row" style="margin-top:8px;">\n              <span class="debug-label">Opacity</span>\n              <input type="range" class="debug-slider" id="dbg-opacity-slider" min="0" max="1" step="0.05" value="1" />\n              <input type="number" class="debug-input debug-input-sm" id="dbg-opacity" step="0.1" min="0" max="1" value="1" />\n            </div>\n          </div>\n\n          <div class="debug-section" id="fill-color-section">\n            <div class="debug-section-title">Fill Color</div>\n            <div class="debug-row">\n              <span class="debug-label">Function</span>\n              <select class="debug-select" id="dbg-fill-fn">\n                <option value="colorContinuous">colorContinuous</option>\n                <option value="static">Static Color</option>\n              </select>\n            </div>\n            <div id="fill-fn-options">\n              <div class="debug-row">\n                <span class="debug-label">Attribute</span>\n                <select class="debug-select" id="dbg-attr"></select>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label">Palette</span>\n                <select class="debug-select pal-hidden" id="dbg-palette"></select>\n                <div class="pal-dd" id="dbg-palette-dd">\n                  <button type="button" class="pal-trigger" id="dbg-palette-trigger" title="Palette">\n                    <span class="pal-name" id="dbg-palette-name">Palette</span>\n                    <span class="pal-swatch" id="dbg-palette-swatch"></span>\n                  </button>\n                  <div class="pal-menu" id="dbg-palette-menu" style="display:none;"></div>\n                </div>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label"></span>\n                <label class="debug-checkbox" style="margin-left:auto;"><input type="checkbox" id="dbg-fill-reverse" /> Reverse</label>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label">Domain</span>\n                <input type="number" class="debug-input debug-input-sm" id="dbg-domain-min" step="0.1" placeholder="min" />\n                <span style="color:#666;">–</span>\n                <input type="number" class="debug-input debug-input-sm" id="dbg-domain-max" step="0.1" placeholder="max" />\n              </div>\n            <div class="debug-row">\n              <span class="debug-label"></span>\n              <div class="debug-dual-range" aria-label="Domain range">\n                <input type="range" class="debug-range-min" id="dbg-domain-range-min" min="0" max="100" step="0.1" value="0" />\n                <input type="range" class="debug-range-max" id="dbg-domain-range-max" min="0" max="100" step="0.1" value="100" />\n              </div>\n            </div>\n              <div class="debug-row">\n                <span class="debug-label">Steps</span>\n                <input type="number" class="debug-input debug-input-sm" id="dbg-steps" step="1" min="2" max="20" value="7" />\n              </div>\n              <div class="debug-row">\n                <span class="debug-label">Null Color</span>\n                <input type="color" class="debug-color" id="dbg-null-color" value="#b8b8b8" />\n                <span class="debug-color-label" id="dbg-null-color-label">#b8b8b8</span>\n              </div>\n            </div>\n            <div id="fill-static-options" style="display:none;">\n              <div class="debug-row">\n                <span class="debug-label">Color</span>\n                <input type="color" class="debug-color" id="dbg-fill-static" value="#0090ff" />\n                <span class="debug-color-label" id="dbg-fill-static-label">#0090ff</span>\n              </div>\n            </div>\n          </div>\n\n          <div class="debug-section" id="line-color-section">\n            <div class="debug-section-title">Line Color</div>\n            <div class="debug-row">\n              <span class="debug-label">Function</span>\n              <select class="debug-select" id="dbg-line-fn">\n                <option value="colorContinuous">colorContinuous</option>\n                <option value="static" selected>Static Color</option>\n              </select>\n            </div>\n            <div id="line-fn-options" style="display:none;">\n              <div class="debug-row">\n                <span class="debug-label">Attribute</span>\n                <select class="debug-select" id="dbg-line-attr"></select>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label">Palette</span>\n                <select class="debug-select pal-hidden" id="dbg-line-palette"></select>\n                <div class="pal-dd" id="dbg-line-palette-dd">\n                  <button type="button" class="pal-trigger" id="dbg-line-palette-trigger" title="Palette">\n                    <span class="pal-name" id="dbg-line-palette-name">Palette</span>\n                    <span class="pal-swatch" id="dbg-line-palette-swatch"></span>\n                  </button>\n                  <div class="pal-menu" id="dbg-line-palette-menu" style="display:none;"></div>\n                </div>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label"></span>\n                <label class="debug-checkbox" style="margin-left:auto;"><input type="checkbox" id="dbg-line-reverse" /> Reverse</label>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label">Domain</span>\n                <input type="number" class="debug-input debug-input-sm" id="dbg-line-domain-min" step="0.1" placeholder="min" />\n                <span style="color:#666;">–</span>\n                <input type="number" class="debug-input debug-input-sm" id="dbg-line-domain-max" step="0.1" placeholder="max" />\n              </div>\n            </div>\n            <div id="line-static-options">\n              <div class="debug-row">\n                <span class="debug-label">Color</span>\n                <input type="color" class="debug-color" id="dbg-line-static" value="#ffffff" />\n                <span class="debug-color-label" id="dbg-line-static-label">#ffffff</span>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label">Line Width</span>\n                <input type="range" class="debug-slider" id="dbg-line-width-slider" min="0" max="5" step="0.5" value="1" />\n                <input type="number" class="debug-input debug-input-sm" id="dbg-line-width" step="0.5" min="0" max="10" value="1" />\n              </div>\n            </div>\n          </div>\n\n          <div class="debug-section" id="dbg-viewstate-section">\n            <div class="debug-section-title">View State</div>\n            <div class="debug-row">\n              <span class="debug-label">Longitude</span>\n              <input type="number" class="debug-input" id="dbg-lng" step="0.0001" />\n            </div>\n            <div class="debug-row">\n              <span class="debug-label">Latitude</span>\n              <input type="number" class="debug-input" id="dbg-lat" step="0.0001" />\n            </div>\n            <div class="debug-row">\n              <span class="debug-label">Zoom</span>\n              <input type="number" class="debug-input" id="dbg-zoom" step="0.1" min="0" max="22" />\n            </div>\n            <div class="debug-row">\n              <span class="debug-label">Pitch</span>\n              <input type="number" class="debug-input" id="dbg-pitch" step="1" min="0" max="85" />\n            </div>\n            <div class="debug-row">\n              <span class="debug-label">Bearing</span>\n              <input type="number" class="debug-input" id="dbg-bearing" step="1" />\n            </div>\n          </div>\n\n          <div class="debug-section" id="sql-section" style="display:none;">\n            <div class="debug-section-title">SQL <span id="sql-status" style="float:right;font-weight:normal;color:var(--ui-muted-2);"></span></div>\n            <textarea id="dbg-sql" class="debug-output" style="height:60px;font-family:monospace;font-size:11px;resize:vertical;" placeholder="WHERE expression (e.g. data = 111)\n—or—\nFull SQL (SELECT ... FROM data ...)"></textarea>\n          </div>\n\n          <div class="debug-section">\n            <details id="dbg-view-details">\n              <summary class="debug-section-title" style="cursor:pointer; user-select:none;">Current ViewState</summary>\n              <textarea id="dbg-view-output" class="debug-output" readonly></textarea>\n            </details>\n          </div>\n\n          <div class="debug-section">\n            <div class="debug-section-title">Layer Config</div>\n            <textarea id="dbg-output" class="debug-output" readonly></textarea>\n          </div>\n        </div>\n        <div id="debug-resize-handle" title="Drag to resize"></div>\n      </div>\n      <div id="debug-toggle" title="Toggle sidebar">&#x2039;</div>\n  ',document.body.appendChild(e));const t=document.getElementById("debug-panel"),i=document.getElementById("debug-toggle"),n=document.getElementById("debug-resize-handle");if(!t||!i||!n)throw new Error("[FusedMaps] Debug panel DOM missing expected elements");return{shell:e,panel:t,toggle:i,resizeHandle:n}}();try{"hide"===n?(l.classList.add("collapsed"),a.innerHTML="&#x203A;"):(l.classList.remove("collapsed"),a.innerHTML="&#x2039;"),Se(r,l,a)}catch(e){}const{layerSelect:u,hexSection:y,viewStateSection:p,fillColorSection:f,lineColorSection:g,filledEl:h,strokedEl:m,extrudedEl:b,extrusionControls:v,elevAttrEl:C,elevScaleEl:x,opacitySliderEl:E,opacityEl:L,fillFnEl:w,fillFnOptions:S,fillStaticOptions:A,fillAttrEl:F,fillPaletteEl:$,fillPalTrigger:M,fillPalSwatch:T,fillPalMenu:k,fillDomainMinEl:N,fillDomainMaxEl:O,fillRangeMinEl:P,fillRangeMaxEl:_,fillStepsEl:j,fillReverseEl:R,fillNullEl:q,fillNullLabel:z,fillStaticEl:B,fillStaticLabel:U,lineFnEl:W,lineFnOptions:H,lineStaticOptions:V,lineAttrEl:J,linePaletteEl:G,linePalTrigger:Z,linePalSwatch:Y,linePalMenu:X,lineDomainMinEl:Q,lineDomainMaxEl:K,lineReverseEl:ee,lineStaticEl:te,lineStaticLabel:ie,lineWidthSliderEl:ne,lineWidthEl:re,lngEl:le,latEl:oe,zoomEl:ae,pitchEl:se,bearingEl:ce,viewOut:de,layerOut:ue,sqlSection:ye,sqlStatusEl:he,sqlInputEl:Oe}=function(){const e=e=>{const t=document.getElementById(e);if(!t)throw new Error(`[FusedMaps] Debug panel missing element #${e}`);return t};return{layerSelect:e("dbg-layer-select"),hexSection:e("dbg-hex-section"),viewStateSection:e("dbg-viewstate-section"),fillColorSection:e("fill-color-section"),lineColorSection:e("line-color-section"),filledEl:e("dbg-filled"),strokedEl:e("dbg-stroked"),extrudedEl:e("dbg-extruded"),extrusionControls:e("dbg-extrusion-controls"),elevAttrEl:e("dbg-elev-attr"),elevScaleEl:e("dbg-elev-scale"),opacitySliderEl:e("dbg-opacity-slider"),opacityEl:e("dbg-opacity"),fillFnEl:e("dbg-fill-fn"),fillFnOptions:e("fill-fn-options"),fillStaticOptions:e("fill-static-options"),fillAttrEl:e("dbg-attr"),fillPaletteEl:e("dbg-palette"),fillPalTrigger:e("dbg-palette-trigger"),fillPalSwatch:e("dbg-palette-swatch"),fillPalMenu:e("dbg-palette-menu"),fillDomainMinEl:e("dbg-domain-min"),fillDomainMaxEl:e("dbg-domain-max"),fillRangeMinEl:e("dbg-domain-range-min"),fillRangeMaxEl:e("dbg-domain-range-max"),fillStepsEl:e("dbg-steps"),fillReverseEl:e("dbg-fill-reverse"),fillNullEl:e("dbg-null-color"),fillNullLabel:e("dbg-null-color-label"),fillStaticEl:e("dbg-fill-static"),fillStaticLabel:e("dbg-fill-static-label"),lineFnEl:e("dbg-line-fn"),lineFnOptions:e("line-fn-options"),lineStaticOptions:e("line-static-options"),lineAttrEl:e("dbg-line-attr"),linePaletteEl:e("dbg-line-palette"),linePalTrigger:e("dbg-line-palette-trigger"),linePalSwatch:e("dbg-line-palette-swatch"),linePalMenu:e("dbg-line-palette-menu"),lineDomainMinEl:e("dbg-line-domain-min"),lineDomainMaxEl:e("dbg-line-domain-max"),lineReverseEl:e("dbg-line-reverse"),lineStaticEl:e("dbg-line-static"),lineStaticLabel:e("dbg-line-static-label"),lineWidthSliderEl:e("dbg-line-width-slider"),lineWidthEl:e("dbg-line-width"),lngEl:e("dbg-lng"),latEl:e("dbg-lat"),zoomEl:e("dbg-zoom"),pitchEl:e("dbg-pitch"),bearingEl:e("dbg-bearing"),viewOut:e("dbg-view-output"),layerOut:e("dbg-output"),sqlSection:e("sql-section"),sqlStatusEl:e("sql-status"),sqlInputEl:e("dbg-sql")}}();i.initialViewState;const Pe=function(){try{return Object.keys(window.cartocolor||{}).sort((e,t)=>e.localeCompare(t))}catch(e){return[]}}();ge($,Pe),ge(G,Pe);const _e=()=>{const e=parseInt(j?.value||"7",10);return Number.isFinite(e)?Math.max(2,Math.min(20,e)):7},Ie=function(e){const t=[],i=[],n=()=>{try{t.forEach(e=>{try{e.style.display="none"}catch(e){}})}catch(e){}},r=()=>n();try{document.addEventListener("click",r),window.addEventListener("blur",r)}catch(e){}return{attach:r=>{const l={...r,palettes:e,closeAll:n};t.push(l.menuEl);try{me(l),be(l)}catch(e){}const o=e=>{try{e.preventDefault(),e.stopPropagation()}catch(e){}const t="none"!==l.menuEl.style.display;l.closeAll();try{me(l),be(l)}catch(e){}l.menuEl.style.display=t?"none":"block"};try{l.triggerEl.addEventListener("click",o)}catch(e){}const a={refresh:()=>{try{me(l),be(l)}catch(e){}},destroy:()=>{try{l.triggerEl.removeEventListener("click",o)}catch(e){}try{const e=t.indexOf(l.menuEl);e>=0&&t.splice(e,1)}catch(e){}}};return i.push(a),a},refreshAll:()=>{try{i.forEach(e=>e.refresh())}catch(e){}},destroy:()=>{try{i.forEach(e=>e.destroy())}catch(e){}try{document.removeEventListener("click",r),window.removeEventListener("blur",r)}catch(e){}}}}(Pe),je=Ie.attach({selectEl:$,menuEl:k,swatchEl:T,triggerEl:M,getSteps:_e,getReverse:()=>!!R.checked,onPicked:()=>Je()}),Re=Ie.attach({selectEl:G,menuEl:X,swatchEl:Y,triggerEl:Z,getSteps:_e,getReverse:()=>!!ee.checked,onPicked:()=>Je()}),De=i.layers.filter(e=>"hex"===e.layerType||"vector"===e.layerType||"pmtiles"===e.layerType);u.innerHTML=De.map(e=>`<option value="${e.id}">${e.name||e.id}</option>`).join(""),!u.value&&De.length&&(u.value=De[0].id);const qe=()=>{const e=u.value;return De.find(t=>t.id===e)||null},ze=()=>{try{const e=i.__deckOverlay||null,t=e?.__fused_hex_tiles__;t?.rebuild?.()}catch(e){}try{window.dispatchEvent(new CustomEvent("fusedmaps:legend:update"))}catch(e){}},Be=()=>{try{const e=(t._controls||[]).find(e=>e&&e.__fused_hex_tiles__);i.__deckOverlay=e||i.__deckOverlay}catch(e){}};Be();const Ue=()=>{try{const e=2e5,t=e=>{const t={name:e.name};if(!1===e.visible&&(t.visible=!1),"hex"===e.layerType){const i=e.hexLayer||{},n={hexLayer:pe(Te,i)||{}};if(e.isTileLayer&&e.tileUrl){t.type="hex",t.tile_url=e.tileUrl;const i=e.tileLayerConfig||e.tileLayer||null;if(i&&"object"==typeof i){const e=pe(ke,i);e&&Object.keys(e).length&&(n.tileLayer=e)}}else t.type="hex",e.parquetUrl&&(t.parquetUrl=e.parquetUrl),e.sql&&(t.sql=e.sql),e.parquetUrl||(t.data=e.dataRef?`@@py:${String(e.dataRef)}`:null);return t.config=n,t}if("vector"===e.layerType)return t.type="vector",t.data=e.dataRef?`@@py:${String(e.dataRef)}`:null,t.config={vectorLayer:pe(Ne,e.vectorLayer||{})||{}},t;if("mvt"===e.layerType){t.type="vector",t.tile_url=e.tileUrl,t.source_layer=e.sourceLayer||"udf";const i={};return e.fillColorConfig?i.getFillColor=e.fillColorConfig:e.fillColor&&(i.getFillColor=e.fillColor),e.lineColorConfig?i.getLineColor=e.lineColorConfig:e.lineColor&&(i.getLineColor=e.lineColor),"number"==typeof e.lineWidth&&(i.lineWidthMinPixels=e.lineWidth),"number"==typeof e.fillOpacity&&(i.opacity=e.fillOpacity),t.config={vectorLayer:i},t}if("pmtiles"===e.layerType){t.type="pmtiles",e.pmtilesPath?t.pmtiles_path=e.pmtilesPath:t.pmtiles_url=e.pmtilesUrl,e.sourceLayer&&(t.source_layer=e.sourceLayer),"number"==typeof e.minzoom&&(t.minzoom=e.minzoom),"number"==typeof e.maxzoom&&(t.maxzoom=e.maxzoom);const i={...e.vectorLayer||{}};return e.fillColorConfig&&(i.getFillColor=e.fillColorConfig),e.lineColorConfig&&(i.getLineColor=e.lineColorConfig),"number"==typeof e.fillOpacity&&(i.opacity=e.fillOpacity),"number"==typeof e.lineWidth&&(i.lineWidthMinPixels=e.lineWidth),"number"==typeof e.pointRadiusMinPixels&&(i.pointRadiusMinPixels=e.pointRadiusMinPixels),"boolean"==typeof e.isFilled&&(i.filled=e.isFilled),"boolean"==typeof e.isStroked&&(i.stroked=e.isStroked),t.config={vectorLayer:pe(Ne,i)||{}},t}if("raster"===e.layerType){t.type="raster",e.tileUrl&&(t.tile_url=e.tileUrl),e.imageUrl&&(t.image_url=e.imageUrl),e.imageBounds&&(t.bounds=e.imageBounds);const i=e.opacity??e.rasterLayer?.opacity;return t.config="number"==typeof i&&Number.isFinite(i)&&1!==i?{rasterLayer:{opacity:i}}:{},t}return t};let n=`layers = ${fe((i.layers||[]).map(t),0)}`;n.length>e&&(n=n.slice(0,e)+"\n... (truncated)\n"),ue.value=n}catch(e){ue.value=""}},We=()=>{const e=w.value;S.style.display="colorContinuous"===e?"block":"none",A.style.display="static"===e?"block":"none"},He=()=>{const e=W.value;H.style.display="colorContinuous"===e?"block":"none",V.style.display="static"===e?"block":"none"},Ve=()=>{const e=qe();if(!e)return;const t="hex"===e.layerType,i="vector"===e.layerType,n="pmtiles"===e.layerType,r=t&&e.hexLayer||{};try{y&&(y.style.display=t?"block":"none")}catch(e){}try{f&&(f.style.display=t||i||n?"block":"none")}catch(e){}try{g&&(g.style.display=t||i||n?"block":"none")}catch(e){}try{ye&&(ye.style.display="none")}catch(e){}try{p&&(p.style.display="block")}catch(e){}t?(h.checked=!1!==r.filled,m.checked=!1!==r.stroked,b.checked=!0===r.extruded):(h.checked=!1!==e.isFilled,m.checked=!1!==e.isStroked,b.checked=!1);try{if(v&&(v.style.display=t&&b.checked?"block":"none"),t&&C){const t=$e(e),i=[""].concat(t||[]);C.innerHTML=i.map(e=>e?`<option value="${e}">${e}</option>`:'<option value="">(use fill attr)</option>').join(""),C.value=String(r.elevationProperty||"")}t&&x&&(x.value=String("number"==typeof r.elevationScale&&Number.isFinite(r.elevationScale)?r.elevationScale:1))}catch(e){}const l=t?"number"==typeof r.opacity?r.opacity:1:"number"==typeof e.opacity?e.opacity:.9;if(E.value=String(l),L.value=String(l),t){const t=r.getFillColor,i=Fe(t);if(i){w.value="colorContinuous",F.innerHTML=$e(e).map(e=>`<option value="${e}">${e}</option>`).join(""),i.attr&&(F.value=String(i.attr)),i.colors&&($.value=String(i.colors));try{R.checked=!!i.reverse}catch(e){R.checked=!1}try{je.refresh()}catch(e){}const t=Array.isArray(i.domain)?i.domain:[0,1];N.value=we(Number(t[0]),2),O.value=we(Number(t[1]),2);try{const e=Math.min(Number(t[0]),Number(t[1])),i=Math.max(Number(t[0]),Number(t[1]));Number.isFinite(e)&&Number.isFinite(i)&&(P.min=String(e),P.max=String(i),_.min=String(e),_.max=String(i),P.step="0.1",_.step="0.1",P.value=String(Number(t[0])),_.value=String(Number(t[1])))}catch(e){}j.value=String(i.steps??7);const n=`#${(Array.isArray(i.nullColor)?i.nullColor:[184,184,184]).slice(0,3).map(e=>Ae(Number(e),0,255).toString(16).padStart(2,"0")).join("")}`;q.value=n,z.textContent=n}else if(Array.isArray(t)){w.value="static";try{R.checked=!1}catch(e){}const e=`#${t.slice(0,3).map(e=>Ae(Number(e),0,255).toString(16).padStart(2,"0")).join("")}`;B.value=e,U.textContent=e}else{w.value="colorContinuous";try{R.checked=!1}catch(e){}}}else if(i||n){const t=e,i=t.fillColorConfig,r=(()=>{if(!n)return Me(e);const r=new Set;return i?.attr&&r.add(String(i.attr)),t.lineColorConfig?.attr&&r.add(String(t.lineColorConfig.attr)),t.colorAttribute&&r.add(String(t.colorAttribute)),r.add("value"),[...r].filter(Boolean)})();if(F.innerHTML=r.map(e=>`<option value="${e}">${e}</option>`).join(""),i&&"object"==typeof i&&"colorContinuous"===i["@@function"]){w.value="colorContinuous",i.attr&&(F.value=String(i.attr)),i.colors&&($.value=String(i.colors));try{R.checked=!!i.reverse}catch(e){R.checked=!1}try{je.refresh()}catch(e){}const e=Array.isArray(i.domain)?i.domain:[0,1];N.value=we(Number(e[0]),2),O.value=we(Number(e[1]),2);try{const t=Math.min(Number(e[0]),Number(e[1])),i=Math.max(Number(e[0]),Number(e[1]));Number.isFinite(t)&&Number.isFinite(i)&&(P.min=String(t),P.max=String(i),_.min=String(t),_.max=String(i),P.step="0.1",_.step="0.1",P.value=String(Number(e[0])),_.value=String(Number(e[1])))}catch(e){}j.value=String(i.steps??7);const t=`#${(Array.isArray(i.nullColor)?i.nullColor:[184,184,184]).slice(0,3).map(e=>Ae(Number(e),0,255).toString(16).padStart(2,"0")).join("")}`;q.value=t,z.textContent=t}else{w.value="static";try{R.checked=!1}catch(e){}B.value="#0090ff",U.textContent=B.value}}if(t){const t=r.getLineColor,i=Fe(t);if(i){W.value="colorContinuous",J.innerHTML=$e(e).map(e=>`<option value="${e}">${e}</option>`).join(""),i.attr&&(J.value=String(i.attr)),i.colors&&(G.value=String(i.colors));try{ee.checked=!!i.reverse}catch(e){ee.checked=!1}try{Re.refresh()}catch(e){}const t=Array.isArray(i.domain)?i.domain:[0,1];Q.value=we(Number(t[0]),2),K.value=we(Number(t[1]),2)}else if(Array.isArray(t)){W.value="static";try{ee.checked=!1}catch(e){}const e=`#${t.slice(0,3).map(e=>Ae(Number(e),0,255).toString(16).padStart(2,"0")).join("")}`;te.value=e,ie.textContent=e}else{W.value="static";try{ee.checked=!1}catch(e){}}}else if(i||n){const t=e,i=t.lineColorConfig,r=(()=>{if(!n)return Me(e);const r=new Set;return i?.attr&&r.add(String(i.attr)),t.fillColorConfig?.attr&&r.add(String(t.fillColorConfig.attr)),t.colorAttribute&&r.add(String(t.colorAttribute)),r.add("value"),[...r].filter(Boolean)})();if(J.innerHTML=r.map(e=>`<option value="${e}">${e}</option>`).join(""),i&&"object"==typeof i&&"colorContinuous"===i["@@function"]){W.value="colorContinuous",i.attr&&(J.value=String(i.attr)),i.colors&&(G.value=String(i.colors));try{ee.checked=!!i.reverse}catch(e){ee.checked=!1}try{Re.refresh()}catch(e){}const e=Array.isArray(i.domain)?i.domain:[0,1];Q.value=we(Number(e[0]),2),K.value=we(Number(e[1]),2)}else{W.value="static";try{ee.checked=!1}catch(e){}}}const o=t?r.lineWidthMinPixels??1:e.lineWidth??1;ne.value=String(o),re.value=String(o),We(),He(),Ue();try{const t=!("hex"!==e.layerType||e.isTileLayer||!e.parquetData&&!e.parquetUrl);ye&&(ye.style.display=t?"block":"none"),Oe&&t&&(Oe.value=String(e.sql||"SELECT * FROM data")),he&&(he.textContent="")}catch(e){}},Je=()=>{const e=qe();e&&function(e){const{map:t,layer:i,els:n,updateLayerOutput:r,findDeckOverlayOnMap:l,rebuildDeck:a}=e;if(!i)return;const d="hex"===i.layerType,u="vector"===i.layerType,y="pmtiles"===i.layerType;d&&(i.hexLayer=i.hexLayer||{});const p=d?i.hexLayer:{},f=parseFloat(n.opacityEl.value),g=Number.isFinite(f)?Ce(f,0,1):1;if(d){p.filled=!!n.filledEl.checked,p.stroked=!!n.strokedEl.checked,p.extruded=!!n.extrudedEl.checked,p.opacity=g;try{n.extrusionControls&&(n.extrusionControls.style.display=p.extruded?"block":"none");const e=parseFloat(n.elevScaleEl?.value||"1");p.elevationScale=Number.isFinite(e)?e:1;const t=String(n.elevAttrEl?.value||"").trim();t?p.elevationProperty=t:delete p.elevationProperty}catch(e){}}else if(u||y){i.isFilled=!!n.filledEl.checked,i.isStroked=!!n.strokedEl.checked,i.opacity=g;try{i.vectorLayer={...i.vectorLayer||{},filled:!!n.filledEl.checked,stroked:!!n.strokedEl.checked,opacity:g}}catch(e){}}if(d)if("static"===n.fillFnEl.value){const e=n.fillStaticEl.value||"#0090ff",t=parseInt(e.slice(1,3),16),i=parseInt(e.slice(3,5),16),r=parseInt(e.slice(5,7),16);p.getFillColor=[t,i,r]}else{const e=n.fillAttrEl.value||"data_avg",t=n.fillPaletteEl.value||"Earth",i=!!n.fillReverseEl.checked,r=parseFloat(n.fillDomainMinEl.value),l=parseFloat(n.fillDomainMaxEl.value),o=parseInt(n.fillStepsEl.value||"7",10),a=n.fillNullEl.value||"#b8b8b8",s=parseInt(a.slice(1,3),16),c=parseInt(a.slice(3,5),16),d=parseInt(a.slice(5,7),16);p.getFillColor={"@@function":"colorContinuous",attr:e,domain:[Number.isFinite(r)?r:0,Number.isFinite(l)?l:1],colors:t,reverse:i,steps:Number.isFinite(o)?o:7,nullColor:[s,c,d],autoDomain:!1!==p.getFillColor?.autoDomain}}else if(u||y)if("static"===n.fillFnEl.value){const e=n.fillStaticEl.value||"#0090ff";i.fillColorConfig=null,i.fillColorRgba=e;try{const t=Le(e,200)||Le(e)||null;i.vectorLayer&&(i.vectorLayer.getFillColor=t||e)}catch(e){}}else{const e=n.fillAttrEl.value||"value",t=n.fillPaletteEl.value||"ArmyRose",r=!!n.fillReverseEl.checked,l=parseFloat(n.fillDomainMinEl.value),o=parseFloat(n.fillDomainMaxEl.value),a=parseInt(n.fillStepsEl.value||"7",10),s=n.fillNullEl.value||"#b8b8b8",c=parseInt(s.slice(1,3),16),d=parseInt(s.slice(3,5),16),u=parseInt(s.slice(5,7),16);i.fillColorRgba=null;const p={"@@function":"colorContinuous",attr:e,domain:[Number.isFinite(l)?l:0,Number.isFinite(o)?o:1],colors:t,reverse:r,steps:Number.isFinite(a)?a:7,nullColor:[c,d,u]};i.fillColorConfig=p,y&&(i.colorAttribute=e);try{i.vectorLayer&&(i.vectorLayer.getFillColor=p)}catch(e){}}if(d)if("static"===n.lineFnEl.value){const e=n.lineStaticEl.value||"#ffffff",t=parseInt(e.slice(1,3),16),i=parseInt(e.slice(3,5),16),r=parseInt(e.slice(5,7),16);p.getLineColor=[t,i,r]}else{const e=n.lineAttrEl.value||"data_avg",t=n.linePaletteEl.value||"Earth",i=!!n.lineReverseEl.checked,r=parseFloat(n.lineDomainMinEl.value),l=parseFloat(n.lineDomainMaxEl.value);p.getLineColor={"@@function":"colorContinuous",attr:e,domain:[Number.isFinite(r)?r:0,Number.isFinite(l)?l:1],colors:t,reverse:i,steps:parseInt(n.fillStepsEl.value||"7",10)||7,autoDomain:!1!==p.getLineColor?.autoDomain}}else if(u||y)if("static"===n.lineFnEl.value){const e=n.lineStaticEl.value||"#ffffff";i.lineColorConfig=null,i.lineColorRgba=e;try{const t=Le(e,255)||Le(e)||null;i.vectorLayer&&(i.vectorLayer.getLineColor=t||e)}catch(e){}}else{const e=n.lineAttrEl.value||"value",t=n.linePaletteEl.value||"ArmyRose",r=!!n.lineReverseEl.checked,l=parseFloat(n.lineDomainMinEl.value),o=parseFloat(n.lineDomainMaxEl.value);i.lineColorRgba=null;const a={"@@function":"colorContinuous",attr:e,domain:[Number.isFinite(l)?l:0,Number.isFinite(o)?o:1],colors:t,reverse:r,steps:parseInt(n.fillStepsEl.value||"7",10)||7};i.lineColorConfig=a;try{i.vectorLayer&&(i.vectorLayer.getLineColor=a)}catch(e){}}const h=parseFloat(n.lineWidthEl.value),m=Number.isFinite(h)?Ce(h,0,10):1;if(d)p.lineWidthMinPixels=m;else if(u||y){i.lineWidth=m;try{i.vectorLayer&&(i.vectorLayer.lineWidthMinPixels=m)}catch(e){}}r(),l(),a();try{if("hex"===i.layerType&&!i.isTileLayer){const e=i.parquetData||i.parquetUrl?D()?.[i.id]||{type:"FeatureCollection",features:[]}:s(i.data||[]),n=function(e,t){try{const i=e.getStyle?.(),n=i?.layers||[],r=[`${t}-fill`,`${t}-extrusion`,`${t}-outline`];for(const e of r){const t=n.find(t=>t&&t.id===e);if(!t)continue;const i=t.layout?.visibility;return"none"!==i}}catch(e){}return!0}(t,i.id);!function(e,t,i,n){try{const n=e.getSource(t.id);n&&"function"==typeof n.setData?n.setData(i):e.addSource(t.id,{type:"geojson",data:i})}catch(e){}!function(e,t){const i=[`${t}-fill`,`${t}-extrusion`,`${t}-outline`];for(const t of i)try{e.getLayer(t)&&e.removeLayer(t)}catch(e){}}(e,t.id),c(e,t,i,n)}(t,i,e,n)}}catch(e){}try{if(u){const e=i,n=e.geojson,r=n?.features?.map(e=>e?.properties||{})||[],l=e.fillColorConfig?.["@@function"]?o(e.fillColorConfig,r):e.fillColorRgba||"#0090ff",a=e.lineColorConfig?.["@@function"]?o(e.lineColorConfig,r):e.lineColorRgba||"#ffffff",s=!1===e.isFilled?0:g,c=!1===e.isStroked?0:1;Ee(t,`${e.id}-`,"fill-color",l),Ee(t,`${e.id}-`,"fill-opacity",s),xe(t,`${e.id}-outline`,"line-color",a),xe(t,`${e.id}-outline`,"line-width",m),xe(t,`${e.id}-outline`,"line-opacity",c),Ee(t,`${e.id}-`,"line-color",a),Ee(t,`${e.id}-`,"line-width",m),Ee(t,`${e.id}-`,"line-opacity",c),xe(t,`${e.id}-circle`,"circle-color",l),xe(t,`${e.id}-circle`,"circle-opacity",s),xe(t,`${e.id}-circle`,"circle-stroke-color",a),xe(t,`${e.id}-circle`,"circle-stroke-width",m)}}catch(e){}try{if(y){const e=i,n=!1===e.isFilled?0:g,r=!1===e.isStroked?0:1,l=e.colorAttribute||"value",o=e.fillColorConfig?I(e.fillColorConfig,l,"#ff8c00"):e.fillColorRgba||"#ff8c00",a=e.lineColorConfig?I(e.lineColorConfig,l,"#ffffff"):e.lineColorRgba||"#ffffff",s=!1===e.isStroked?0:m;Ee(t,`${e.id}-`,"fill-color",o),Ee(t,`${e.id}-`,"fill-opacity",n),Ee(t,`${e.id}-`,"line-color",a),Ee(t,`${e.id}-`,"line-width",s),Ee(t,`${e.id}-`,"line-opacity",r),Ee(t,`${e.id}-`,"circle-color",o),Ee(t,`${e.id}-`,"circle-opacity",n),Ee(t,`${e.id}-`,"circle-stroke-color",a),Ee(t,`${e.id}-`,"circle-stroke-width",s)}}catch(e){console.warn("[FusedMaps] PMTiles update error:",e)}}({map:t,layer:e,els:{filledEl:h,strokedEl:m,extrudedEl:b,extrusionControls:v,elevAttrEl:C,elevScaleEl:x,opacityEl:L,fillFnEl:w,fillAttrEl:F,fillPaletteEl:$,fillReverseEl:R,fillDomainMinEl:N,fillDomainMaxEl:O,fillStepsEl:j,fillNullEl:q,fillStaticEl:B,lineFnEl:W,lineAttrEl:J,linePaletteEl:G,lineReverseEl:ee,lineDomainMinEl:Q,lineDomainMaxEl:K,lineStaticEl:te,lineWidthEl:re},updateLayerOutput:Ue,findDeckOverlayOnMap:Be,rebuildDeck:ze})},Ge=()=>{const e=parseFloat(N.value),t=parseFloat(O.value);Number.isFinite(e)&&(P.value=String(e)),Number.isFinite(t)&&(_.value=String(t))},Ze=()=>{let e=parseFloat(P.value),t=parseFloat(_.value);Number.isFinite(e)&&Number.isFinite(t)&&(e>t&&([e,t]=[t,e]),P.value=String(e),_.value=String(t),N.value=String(e),O.value=String(t))},Ye=()=>{const e=qe();if(e){e.fillDomainFromUser=!0;try{if("hex"!==e.layerType)return;const t=e.hexLayer||{};if(t.getFillColor&&"object"==typeof t.getFillColor){t.getFillColor.autoDomain=!1;try{delete t.getFillColor._dynamicDomain}catch(e){}}if(t.getLineColor&&"object"==typeof t.getLineColor){t.getLineColor.autoDomain=!1;try{delete t.getLineColor._dynamicDomain}catch(e){}}}catch(e){}}},Xe=()=>{Ze()},Qe=()=>{Ze(),Ye(),Je()},Ke=()=>{try{const i=e(t);if(de.value=`initialViewState = ${fe(i,0)}`,r&&function(){const e=document.activeElement;return!(!e||!e.closest?.("#debug-panel")||"INPUT"!==e.tagName&&"TEXTAREA"!==e.tagName&&"SELECT"!==e.tagName)}())return;le.value=we(i.longitude,5),oe.value=we(i.latitude,5),ae.value=we(i.zoom,2),se.value=we(i.pitch??0,1),ce.value=we(i.bearing??0,1)}catch(e){}},et=()=>{const e=l.classList.toggle("collapsed");a.innerHTML=e?"&#x203A;":"&#x2039;",Se(r,l,a)};let tt=!1,it=0,nt=280;const rt=e=>{if(!tt)return;const t=e.clientX-it,i=Ae(nt+t,240,520);l.style.width=`${i}px`,Se(r,l,a),e.preventDefault()},lt=e=>{tt&&(tt=!1,window.removeEventListener("pointermove",rt),window.removeEventListener("pointerup",lt))},ot=e=>{tt=!0,it=e.clientX,nt=l.getBoundingClientRect().width||280,window.addEventListener("pointermove",rt,{passive:!1}),window.addEventListener("pointerup",lt),e.preventDefault(),e.stopPropagation()};a.addEventListener("click",et),d.addEventListener("pointerdown",ot,{passive:!1}),u.addEventListener("change",()=>Ve()),w.addEventListener("change",()=>{We(),Je()}),W.addEventListener("change",()=>{He(),Je()}),[h,m].forEach(e=>e.addEventListener("change",Je)),b.addEventListener("change",()=>{try{v&&(v.style.display=b.checked?"block":"none")}catch(e){}Je()}),C.addEventListener("change",Je),x.addEventListener("input",Je),x.addEventListener("change",Je),E.addEventListener("input",()=>{L.value=E.value,Je()}),L.addEventListener("change",()=>{E.value=L.value,Je()}),[F,j,R].forEach(e=>e.addEventListener("change",()=>{try{je.refresh()}catch(e){}try{Re.refresh()}catch(e){}Je()})),N.addEventListener("input",()=>{Ge()}),O.addEventListener("input",()=>{Ge()}),N.addEventListener("change",()=>{Ye(),Je()}),O.addEventListener("change",()=>{Ye(),Je()}),P.addEventListener("input",Xe),_.addEventListener("input",Xe),P.addEventListener("change",Qe),_.addEventListener("change",Qe),q.addEventListener("input",()=>{z.textContent=q.value,Je()}),B.addEventListener("input",()=>{U.textContent=B.value,Je()}),[J,Q,K,ee].forEach(e=>e.addEventListener("change",()=>{try{Re.refresh()}catch(e){}Je()})),te.addEventListener("input",()=>{ie.textContent=te.value,Je()}),ne.addEventListener("input",()=>{re.value=ne.value,Je()}),re.addEventListener("change",()=>{ne.value=re.value,Je()});let at=null;const st=()=>{const e=qe();if(!e)return;if("hex"!==e.layerType||e.isTileLayer||!e.parquetData&&!e.parquetUrl)return;const t=String(Oe?.value||"").trim()||"SELECT * FROM data";try{Oe&&(Oe.value=t)}catch(e){}e.sql=t;try{Ue()}catch(e){}he&&(he.textContent="typing..."),clearTimeout(at),at=setTimeout(()=>{try{window.dispatchEvent(new CustomEvent("fusedmaps:sql:update",{detail:{layerId:e.id,sql:t}}))}catch(e){}},500)};try{Oe?.addEventListener("input",st)}catch(e){}const ct=e=>{try{const t=e?.detail||{},i=String(t.layerId||""),n=String(t.status||""),r=qe();if(!r||r.id!==i)return;he&&(he.textContent=n)}catch(e){}};try{window.addEventListener("fusedmaps:sql:status",ct)}catch(e){}try{t.on("moveend",Ke),t.on("rotateend",Ke),t.on("pitchend",Ke)}catch(e){}We(),He();try{je.refresh()}catch(e){}try{Re.refresh()}catch(e){}return Ve(),Ke(),Se(r,l,a),window.addEventListener("resize",()=>Se(r,l,a)),{destroy:()=>{try{Ie.destroy()}catch(e){}try{a.removeEventListener("click",et)}catch(e){}try{d.removeEventListener("pointerdown",ot)}catch(e){}try{t.off("moveend",Ke),t.off("rotateend",Ke),t.off("pitchend",Ke)}catch(e){}try{window.removeEventListener("fusedmaps:sql:status",ct)}catch(e){}try{r?.remove()}catch(e){}}}}let Pe=!1,_e=null;function Ie(e,t){let i={type:"FeatureCollection",features:[]};if(t){const e=t.properties||{},n=e.hex||e.h3;if(n&&window.h3)try{const t=a(n);if(t&&window.h3.isValidCell(t)){const n=window.h3.cellToBoundary(t).map(([e,t])=>[t,e]);n.push(n[0]),i.features.push({type:"Feature",geometry:{type:"Polygon",coordinates:[n]},properties:e})}}catch(e){}else t.geometry&&i.features.push({type:"Feature",geometry:t.geometry,properties:e})}Pe?e.getSource("feature-hl").setData(i):(e.addSource("feature-hl",{type:"geojson",data:i}),e.addLayer({id:"feature-hl-fill",type:"fill",source:"feature-hl",paint:{"fill-color":"rgba(255,255,0,0.3)","fill-opacity":1}}),e.addLayer({id:"feature-hl-line",type:"line",source:"feature-hl",paint:{"line-color":"rgba(255,255,0,1)","line-width":3}}),Pe=!0),_e=t}function je(e){let t=null,i=null;try{"BroadcastChannel"in window&&(t=new BroadcastChannel(e))}catch(e){}function n(e){if(!i)return;let t;try{t="string"==typeof e.data?JSON.parse(e.data):e.data}catch{return}i(t)}return{send:function(e){const i=JSON.stringify(e);try{t&&t.postMessage(e)}catch(e){}try{window.parent.postMessage(i,"*")}catch(e){}try{window.top&&window.top!==window.parent&&window.top.postMessage(i,"*")}catch(e){}try{if(window.top?.frames)for(let e=0;e<window.top.frames.length;e++){const t=window.top.frames[e];if(t!==window)try{t.postMessage(i,"*")}catch(e){}}}catch(e){}},onMessage:function(e){i=e,t&&(t.onmessage=e=>{i&&i(e.data)}),window.addEventListener("message",n)},destroy:function(){t&&(t.close(),t=null),window.removeEventListener("message",n),i=null}}}function Re(e="component"){return`${e}-${Math.random().toString(36).substr(2,9)}`}function De(e,t,i){t.broadcast?.enabled&&function(e,t={}){const i=t.channel||"fused-bus",n=t.dataset||"all",r=Re("map-broadcast"),l=je(i);let o=null;function a(){const t=function(e){const t=e.getBounds();return[+t.getWest().toFixed(6),+t.getSouth().toFixed(6),+t.getEast().toFixed(6),+t.getNorth().toFixed(6)]}(e);if(a=o,(i=t)&&a&&i[0]===a[0]&&i[1]===a[1]&&i[2]===a[2]&&i[3]===a[3])return;var i,a;o=t;const[s,c,d,u]=t;l.send({type:"filter",fromComponent:r,timestamp:Date.now(),dataset:n,filter:{type:"spatial",field:"geometry",values:[s,c,d,u]}}),l.send({type:"spatial_filter",source:r,timestamp:Date.now(),bounds:{sw:{lng:s,lat:c},ne:{lng:d,lat:u}}})}e.on("move",a),e.on("moveend",a),e.on("load",()=>{setTimeout(a,300)}),e.loaded()&&setTimeout(a,100),setTimeout(()=>{l.send({type:"component_ready",componentType:"map",componentId:r,capabilities:["spatial_filter"],dataSource:"viewport",protocol:"unified"})},200)}(e,{channel:t.broadcast.channel,dataset:t.broadcast.dataset}),t.sync?.enabled&&function(e,t={}){let i=t.channel||"default";i.includes("::")||(i=`map-sync::${i}`);const n=Re("map"),r=je(i);let l=!1,o=!1,a={x:NaN,y:NaN,z:NaN};const s=(e,t,i)=>Math.abs(e-t)<i;function c(){const t=e.getCenter();return{longitude:+t.lng.toFixed(6),latitude:+t.lat.toFixed(6),zoom:+e.getZoom().toFixed(3),bearing:+e.getBearing().toFixed(1),pitch:+e.getPitch().toFixed(1),id:n,ts:Date.now()}}function d(){if(l)return;const e=c(),{longitude:t,latitude:i,zoom:n}=e;s(t,a.x,1e-6)&&s(i,a.y,1e-6)&&s(n,a.z,.001)||(a={x:t,y:i,z:n},r.send({type:"sync",...e}))}let u=null;const y=()=>{o=!0},p=()=>{o&&(o=!1,d())};e.on("dragstart",y),e.on("zoomstart",y),e.on("rotatestart",y),e.on("pitchstart",y),e.on("moveend",p),e.on("move",()=>{o&&!l&&(u&&clearTimeout(u),u=setTimeout(d,0))}),r.onMessage(t=>{var i;"sync"===t.type&&t.id!==n&&(i=t)&&i.id!==n&&(l||o||(l=!0,e.jumpTo({center:[i.longitude,i.latitude],zoom:i.zoom,bearing:i.bearing,pitch:i.pitch}),requestAnimationFrame(()=>{l=!1})))}),e.on("load",()=>{setTimeout(()=>r.send({type:"sync",...c()}),100+100*Math.random())}),document.addEventListener("visibilitychange",()=>{document.hidden&&(l=!1,o=!1)})}(e,{channel:t.sync.channel}),t.clickBroadcast,t.locationListener}const qe="1.33.1-dev13.0",ze=new Map;function Be(e){return/^[A-Za-z_][A-Za-z0-9_]*$/.test(e)}class Ue{constructor(e){this.duck=null,this.db=null,this.conn=null,this.tableByLayerId=new Map,this.loadedTables=new Set,this.hasSpatial=!1,this.version=e?.version||qe}get ready(){return!!this.conn}async init(){if(this.conn)return;this.duck=await async function(e=qe){const t=ze.get(e);if(t)return t;const i=import(`https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@${e}/+esm`);return ze.set(e,i),i}(this.version);const e=this.duck,t=await e.selectBundle(e.getJsDelivrBundles()),i=await(await fetch(t.mainWorker)).text(),n=new Worker(URL.createObjectURL(new Blob([i],{type:"application/javascript"}))),r=new e.AsyncDuckDB(new e.ConsoleLogger,n);await r.instantiate(t.mainModule);const l=await r.connect();try{await l.query("INSTALL h3 FROM community")}catch(e){}try{await l.query("LOAD h3")}catch(e){}try{await l.query("INSTALL spatial")}catch(e){}try{await l.query("LOAD spatial"),this.hasSpatial=!0}catch(e){this.hasSpatial=!1}this.db=r,this.conn=l}layerTableName(e){const t=this.tableByLayerId.get(e.id);if(t)return t;const i=e.id.replace(/-/g,"_");return this.tableByLayerId.set(e.id,i),i}async ensureLayerTable(e){if(await this.init(),!this.db||!this.conn)throw new Error("DuckDB not initialized");const t=this.layerTableName(e);if(this.loadedTables.has(t))return t;let i=null;if(e.parquetData)i=function(e){const t=atob(e),i=new Uint8Array(t.length);for(let e=0;e<t.length;e++)i[e]=t.charCodeAt(e);return i}(e.parquetData);else if(e.parquetUrl){const t=await fetch(e.parquetUrl);if(!t.ok)throw new Error(`Failed to fetch parquetUrl (${t.status})`);const n=await t.arrayBuffer();i=new Uint8Array(n)}if(!i)throw new Error("Missing parquetData or parquetUrl for SQL layer");return await this.db.registerFileBuffer(`${t}.parquet`,i),await this.conn.query(`CREATE OR REPLACE TABLE ${t} AS SELECT * FROM read_parquet('${t}.parquet')`),this.loadedTables.add(t),t}async runSql(e,t){if(await this.ensureLayerTable(e),!this.conn)throw new Error("DuckDB not initialized");const i=this.layerTableName(e);await this.conn.query(`CREATE OR REPLACE VIEW data AS SELECT * FROM ${i}`);const n=(t||"").trim(),r=/^(with|select)\b/i.test(n)?n:`SELECT * FROM data WHERE (${n||"1=1"})`,l=(await this.conn.query(r)).toArray().map(e=>function(e){const t=new Set(["hex","h3","index","id"]),i={};for(const n of Object.keys(e)){let r=e[n];"bigint"==typeof r&&(r=t.has(n.toLowerCase())?r.toString(16):Number(r)),i[n]=r}const n=a(i.hex??i.h3??i.index??i.id);return n&&(i.hex=n),i}(e)).filter(e=>!!e.hex);return{rows:l,count:l.length}}async getMinMaxFromQuery(e,t,i){if(await this.ensureLayerTable(e),!this.conn)return null;const n=this.layerTableName(e);await this.conn.query(`CREATE OR REPLACE VIEW data AS SELECT * FROM ${n}`);const r=(i||"").trim(),l=/^(with|select)\b/i.test(r)?r:`SELECT * FROM data WHERE (${r||"1=1"})`,o=`"${String(t).replace(/"/g,'""')}"`,a=(await this.conn.query(`SELECT MIN(${o}) as min_val, MAX(${o}) as max_val FROM (${l}) AS q`)).toArray()[0];if(!a)return null;let s=a.min_val,c=a.max_val;return"bigint"==typeof s&&(s=Number(s)),"bigint"==typeof c&&(c=Number(c)),Number.isFinite(s)&&Number.isFinite(c)?{min:s,max:c}:null}async runSqlGeoJSON(e,t){if(await this.ensureLayerTable(e),!this.conn)throw new Error("DuckDB not initialized");if(!this.hasSpatial)return null;const i=this.layerTableName(e);await this.conn.query(`CREATE OR REPLACE VIEW data AS SELECT * FROM ${i}`);const n=(t||"").trim(),r=/^(with|select)\b/i.test(n)?n:`SELECT * FROM data WHERE (${n||"1=1"})`,l=await this.conn.query(`SELECT * FROM (${r}) AS q LIMIT 0`),o=(l?.schema?.fields||[]).map(e=>String(e?.name||"")).filter(Boolean),a=["hex","h3","index","id"].find(e=>o.includes(e))||null;if(!a)return null;if(!o.every(Be))return null;const s=`\n      WITH q AS (${r})\n      SELECT\n        count(*)::BIGINT AS cnt,\n        CASE\n          WHEN count(*) = 0 THEN '{"type":"FeatureCollection","features":[]}'\n          ELSE (\n            '{"type":"FeatureCollection","features":[' ||\n              string_agg(\n                '{"type":"Feature","geometry":' ||\n                  ST_AsGeoJSON(ST_GeomFromText(h3_cell_to_boundary_wkt(CAST("${a}" AS BIGINT)))) ||\n                ',"properties":' || to_json(struct_pack(${o.map(e=>`${e} := "${e}"`).join(", ")})) || '}',\n                ','\n              ) ||\n            ']}'\n          )\n        END AS gj\n      FROM q\n      WHERE "${a}" IS NOT NULL\n        AND h3_is_valid_cell(CAST("${a}" AS BIGINT))\n    `,c=(await this.conn.query(s)).toArray()[0];if(!c)return{geojson:{type:"FeatureCollection",features:[]},count:0};let d=c.cnt;"bigint"==typeof d&&(d=Number(d));const u=String(c.gj||'{"type":"FeatureCollection","features":[]}');return{geojson:JSON.parse(u),count:Number(d)||0}}async getMinMax(e,t){if(await this.ensureLayerTable(e),!this.conn)return null;const i=this.layerTableName(e);await this.conn.query(`CREATE OR REPLACE VIEW data AS SELECT * FROM ${i}`);const n=(await this.conn.query(`SELECT MIN("${t}") as min_val, MAX("${t}") as max_val FROM data`)).toArray()[0];if(!n)return null;let r=n.min_val,l=n.max_val;return"bigint"==typeof r&&(r=Number(r)),"bigint"==typeof l&&(l=Number(l)),Number.isFinite(r)&&Number.isFinite(l)?{min:r,max:l}:null}}let We=null,He={};function Ve(e){return!("hex"!==e.layerType||e.isTileLayer||!e.parquetData&&!e.parquetUrl)}function Je(){let e=document.getElementById("sql-loader");e||(e=document.createElement("div"),e.id="sql-loader",e.innerHTML='<div class="loader-spinner"></div><span id="sql-loader-text">DuckDB…</span>',document.body.appendChild(e));const t=document.getElementById("sql-loader-text");let i=null;const n=new Map;return{setStatus:(r,l)=>{n.set(r,String(l||"")),(()=>{if(!e)return;const r=[...n.entries()].filter(([,e])=>(e=>{const t=(e||"").toLowerCase();return!!t&&!t.startsWith("error:")&&!t.includes(" rows")&&(t.includes("initializ")||t.includes("running")||t.includes("loading")||t.includes("fetch"))})(e));if(r.length){i&&clearTimeout(i),e.classList.add("active");const n=r.some(([,e])=>String(e||"").toLowerCase().includes("initializ"));return void(t&&(t.textContent=n?"Initialising…":"Loading…"))}i=setTimeout(()=>e?.classList.remove("active"),300)})()}}}function Ge(e,t){try{window.dispatchEvent(new CustomEvent("fusedmaps:sql:status",{detail:{layerId:e,status:t}}))}catch(e){}try{We||(We=Je()),We?.setStatus(e,t)}catch(e){}}class Ze{constructor(){this.layers=new Map,this.listeners=new Map,this.nextOrder=0,this.listeners.set("*",new Set)}init(e){this.layers.clear(),this.nextOrder=0,e.forEach((e,t)=>{const i={config:e,visible:!1!==e.visible,order:t};this.layers.set(e.id,i),this.nextOrder=Math.max(this.nextOrder,t+1)}),this.emit({type:"batch",layerId:"*"})}add(e,t){if(this.layers.has(e.id))return console.warn(`[LayerStore] Layer ${e.id} already exists, updating instead`),this.update(e.id,e);const i=t?.order??this.nextOrder;void 0!==t?.order&&this.shiftOrdersFrom(i,1);const n={config:e,visible:!1!==e.visible,order:i};return this.layers.set(e.id,n),this.nextOrder=Math.max(this.nextOrder,i+1),this.emit({type:"add",layerId:e.id,layer:n}),n}remove(e){const t=this.layers.get(e);return!!t&&(this.layers.delete(e),this.recomputeOrders(),this.emit({type:"remove",layerId:e,layer:t}),!0)}update(e,t){const i=this.layers.get(e);if(i)return i.config={...i.config,...t},"visible"in t&&(i.visible=!1!==t.visible),this.emit({type:"update",layerId:e,layer:i,changes:t}),i;console.warn(`[LayerStore] Layer ${e} not found`)}updateStyle(e,t,i){const n=this.layers.get(e);if(!n)return;const r=n.config;return r[t]||(r[t]={}),r[t]={...r[t],...i},this.emit({type:"update",layerId:e,layer:n,changes:{[t]:r[t]}}),n}setVisible(e,t){const i=this.layers.get(e);i&&i.visible!==t&&(i.visible=t,i.config.visible=t,this.emit({type:"visibility",layerId:e,layer:i}))}toggleVisible(e){const t=this.layers.get(e);return!!t&&(this.setVisible(e,!t.visible),t.visible)}setVisibleBatch(e){Object.entries(e).forEach(([e,t])=>{const i=this.layers.get(e);i&&i.visible!==t&&(i.visible=t,i.config.visible=t)}),this.emit({type:"batch",layerId:"*"})}reorder(e,t){const i=this.layers.get(e);if(!i)return;const n=i.order;if(n===t)return;const r=this.layers.size-1;t=Math.max(0,Math.min(r,t)),this.layers.forEach((i,r)=>{r!==e&&(n<t?i.order>n&&i.order<=t&&i.order--:i.order>=t&&i.order<n&&i.order++)}),i.order=t,this.emit({type:"reorder",layerId:e,layer:i,previousOrder:n,newOrder:t})}moveUp(e){const t=this.layers.get(e);t&&this.reorder(e,t.order+1)}moveDown(e){const t=this.layers.get(e);t&&this.reorder(e,t.order-1)}moveToTop(e){this.reorder(e,this.layers.size-1)}moveToBottom(e){this.reorder(e,0)}setGeoJSON(e,t){const i=this.layers.get(e);i&&(i.geojson=t,this.emit({type:"geojson",layerId:e,layer:i}))}getGeoJSON(e){return this.layers.get(e)?.geojson}getAllGeoJSONs(){const e={};return this.layers.forEach((t,i)=>{t.geojson&&(e[i]=t.geojson)}),e}get(e){return this.layers.get(e)}getConfig(e){return this.layers.get(e)?.config}has(e){return this.layers.has(e)}getAll(){return[...this.layers.values()].sort((e,t)=>e.order-t.order)}getAllConfigs(){return this.getAll().map(e=>e.config)}getVisible(){return this.getAll().filter(e=>e.visible)}getVisibleConfigs(){return this.getVisible().map(e=>e.config)}getVisibilityState(){const e={};return this.layers.forEach((t,i)=>{e[i]=t.visible}),e}getByType(e){return this.getAll().filter(t=>t.config.layerType===e)}get size(){return this.layers.size}on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>this.off(e,t)}off(e,t){this.listeners.get(e)?.delete(t)}emit(e){this.listeners.get(e.type)?.forEach(t=>{try{t(e)}catch(e){console.error("[LayerStore] Event handler error:",e)}}),this.listeners.get("*")?.forEach(t=>{try{t(e)}catch(e){console.error("[LayerStore] Event handler error:",e)}})}shiftOrdersFrom(e,t){this.layers.forEach(i=>{i.order>=e&&(i.order+=t)})}recomputeOrders(){const e=this.getAll();e.forEach((e,t)=>{e.order=t}),this.nextOrder=e.length}clone(e,t,i){const n=this.layers.get(e);if(!n)return;const r=JSON.parse(JSON.stringify(n.config));return r.id=t,i&&(r.name=i),this.add(r,{order:n.order+1})}rename(e,t){const i=this.layers.get(e);i&&(i.config.name=t,this.emit({type:"update",layerId:e,layer:i,changes:{name:t}}))}clear(){this.layers.clear(),this.nextOrder=0,this.emit({type:"batch",layerId:"*"})}export(){return{layers:this.getAllConfigs(),visibility:this.getVisibilityState()}}}function Ye(){return new Ze}function Xe(t){const n=t.containerId||"map",r=Ye();r.init(t.layers);try{const e="light"===t.ui?.theme?"light":"dark";document.documentElement.setAttribute("data-theme",e)}catch(e){}const l=function(e){const{containerId:t,mapboxToken:i,styleUrl:n,initialViewState:r,screenshotEnabled:l}=e;return window.mapboxgl.accessToken=i,new window.mapboxgl.Map({container:t,style:n,center:[r.longitude,r.latitude],zoom:r.zoom,pitch:r.pitch||0,bearing:r.bearing||0,projection:"mercator",pitchWithRotate:!0,...l?{preserveDrawingBuffer:!0}:{}})}({containerId:n,mapboxToken:t.mapboxToken,styleUrl:t.styleUrl,initialViewState:t.initialViewState,screenshotEnabled:!1!==t.ui?.screenshot}),a=de(l,t.initialViewState,!1!==t.ui?.screenshot),u=t.sidebar||!!t.debug?Oe(l,t):null;let y=null,f=null,h=null;const m=()=>r.getVisibilityState(),b=()=>{try{oe(r.getAllConfigs(),m())}catch(e){}try{se(r.getAllConfigs(),m(),r.getAllGeoJSONs())}catch(e){}},v=r.on("*",e=>{"visibility"!==e.type&&"update"!==e.type&&"batch"!==e.type||b()});return!1!==t.ui?.layerPanel&&re(r.getAllConfigs(),m(),(e,t)=>{Qe(e,t,l,r,y)},r),!1!==t.ui?.legend&&function(e,t,i){let n=document.getElementById("color-legend");n||(n=document.createElement("div"),n.id="color-legend",n.className="color-legend",n.style.display="none",document.body.appendChild(n)),se(e,t,i)}(r.getAllConfigs(),m(),r.getAllGeoJSONs()),l.on("load",()=>{const n=B(l,r.getAllConfigs(),m(),t);y=n.deckOverlay;const s=D();Object.entries(s).forEach(([e,t])=>{r.setGeoJSON(e,t)}),b(),f=()=>{se(r.getAllConfigs(),m(),r.getAllGeoJSONs())};try{window.addEventListener("fusedmaps:legend:update",f)}catch(e){}if(!1!==t.ui?.tooltip&&function(e,t,i,n){let r=document.getElementById("tooltip");r||(r=document.createElement("div"),r.id="tooltip",document.body.appendChild(r));const l=[];t.forEach(e=>{if(e.isTileLayer)return;const t=[];"hex"===e.layerType?((e.hexLayer||{}).extruded?t.push(`${e.id}-extrusion`):t.push(`${e.id}-fill`),t.push(`${e.id}-outline`)):"vector"===e.layerType?t.push(`${e.id}-fill`,`${e.id}-outline`,`${e.id}-circle`,`${e.id}-line`):"mvt"===e.layerType?t.push(`${e.id}-fill`,`${e.id}-line`,`${e.id}-extrusion`):e.layerType,t.forEach(t=>{l.push({layerId:t,layerDef:e})})}),e.on("mousemove",o=>{const a=[...l];try{const i=e.getStyle?.()?.layers||[];for(const e of t){if("pmtiles"!==e.layerType)continue;const t=`${e.id}-`;for(const n of i){const i=n?.id;"string"==typeof i&&i.startsWith(t)&&a.push({layerId:i,layerDef:e})}}}catch(e){}const s=a.map(e=>e.layerId).filter(t=>e.getLayer(t)),c=e=>{const i=t.findIndex(t=>t.id===e);return-1===i?Number.POSITIVE_INFINITY:i};let d=null,u=Number.POSITIVE_INFINITY;if(s.length){const t=e.queryRenderedFeatures(o.point,{layers:s});for(const e of t||[]){const t=a.find(t=>t.layerId===e.layer?.id);if(!t)continue;if(!1===i[t.layerDef.id])continue;const n=c(t.layerDef.id);n<u&&(u=n,d={type:"mapbox",layerDef:t.layerDef,props:e.properties||{}});break}}if(n){const e=n.__fused_hex_tiles__,r=e?.pickObject||n?.pickObject;try{const e=r?.({x:o.point.x,y:o.point.y,radius:4});if(e?.object){const n=String(e.layer?.id||""),r=n.includes("-tiles")?n.split("-tiles")[0]:n,l=t.find(e=>e.id===r);if(l&&!1!==i[l.id]){const t=c(l.id);t<u&&(u=t,d={type:"deck",layerDef:l,props:e.object.properties||e.object||{}})}}}catch(e){}}if(!d)return r.style.display="none",void(e.getCanvas().style.cursor="");e.getCanvas().style.cursor="pointer";const y=function(e){if("hex"===e.layerType){const t=e;return t.hexLayer?.tooltipColumns||t.hexLayer?.tooltipAttrs||t.tooltipColumns||[]}if("vector"===e.layerType){const t=e;return t.vectorLayer?.tooltipColumns||t.vectorLayer?.tooltipAttrs||t.tooltipColumns||[]}if("pmtiles"===e.layerType){const t=e;return t.vectorLayer?.tooltipColumns||t.vectorLayer?.tooltipAttrs||t.tooltipColumns||[]}return e.tooltipColumns||[]}(d.layerDef),p=function(e,t){const i=[];return null!=e.hex&&i.push(`<span class="tt-row"><span class="tt-key">hex</span><span class="tt-val">${String(e.hex).slice(0,12)}...</span></span>`),t.length?(t.forEach(t=>{if("hex"===t)return;const n=e[t];if(null==n)return;const r="number"==typeof n?Number(n).toFixed(2):String(n);i.push(`<span class="tt-row"><span class="tt-key">${t}</span><span class="tt-val">${r}</span></span>`)}),i):(0===i.length&&Object.keys(e).slice(0,5).forEach(t=>{i.push(`<span class="tt-row"><span class="tt-key">${t}</span><span class="tt-val">${e[t]}</span></span>`)}),i)}(d.props,y);p.length?(r.innerHTML=`<strong class="tt-title">${d.layerDef.name}</strong>`+p.join(""),r.style.left=`${o.point.x+10}px`,r.style.top=`${o.point.y+10}px`,r.style.display="block"):r.style.display="none"}),e.on("mouseleave",()=>{e.getCanvas().style.cursor="",r.style.display="none"})}(l,r.getAllConfigs(),m(),y),!1!==t.highlightOnClick&&function(e,t,i,n){e.on("click",i=>{const r=function(e,t){const i=[];return t.forEach(t=>{if(t.isTileLayer)return;const n=t.layerType;let r=[];if("vector"===n)r=[`${t.id}-fill`,`${t.id}-circle`,`${t.id}-line`];else if("hex"===n){const e=t;r=[e.hexLayer?.extruded?`${t.id}-extrusion`:`${t.id}-fill`]}r.forEach(t=>{try{e.getLayer(t)&&i.push(t)}catch(e){}})}),["gdf-fill","gdf-circle","hex-fill"].forEach(t=>{try{e.getLayer(t)&&i.push(t)}catch(e){}}),i}(e,t);if(!r.length)return;let l=[];try{l=e.queryRenderedFeatures(i.point,{layers:r})||[]}catch(e){}if(l.length>0)Ie(e,l[0]);else if(n){const t=n?.pickObject?.({x:i.point.x,y:i.point.y,radius:4});t?.object?Ie(e,{properties:t.object.properties||t.object,geometry:null}):_e&&Ie(e,null)}else _e&&Ie(e,null)})}(l,r.getAllConfigs(),m(),y),t.messaging&&De(l,t.messaging,r.getAllConfigs()),h=function(e,t,n,r){const l=(t.layers||[]).filter(Ve);if(!l.length)return null;try{He={};for(const e of l)He[e.id]=e.name||e.id}catch(e){}try{We||(We=Je())}catch(e){}const a=new Ue;let s=!1;const d=async(t,l)=>{if(!s){Ge(t.id,"initializing...");try{if(await a.init(),s)return;try{const e=t.hexLayer?.getFillColor,i=e&&"object"==typeof e&&!Array.isArray(e)?e.attr:null,n=e&&"object"==typeof e&&!Array.isArray(e)&&(!0===e.autoDomain||!Array.isArray(e.domain));if(i&&n&&!0!==t.fillDomainFromUser){const e=await a.getMinMax(t,String(i));e&&t.hexLayer&&"object"==typeof t.hexLayer.getFillColor&&!Array.isArray(t.hexLayer.getFillColor)&&(t.hexLayer.getFillColor.domain=[e.min,e.max])}}catch(e){}t.sql=l||t.sql||"SELECT * FROM data";try{const e=t.sql||"SELECT * FROM data",i=!0===t.fillDomainFromUser,n=t.hexLayer?.getFillColor;if(!i&&n&&"object"==typeof n&&!Array.isArray(n)&&"colorContinuous"===n["@@function"]){const i=String(n.attr||"");if(i&&!0===n.autoDomain){const r=await a.getMinMaxFromQuery(t,i,e);r&&(n.domain=[r.min,r.max])}}const r=t.hexLayer?.getLineColor;if(!i&&r&&"object"==typeof r&&!Array.isArray(r)&&"colorContinuous"===r["@@function"]){const i=String(r.attr||"");if(i&&!0===r.autoDomain){const n=await a.getMinMaxFromQuery(t,i,e);n&&(r.domain=[n.min,n.max])}}}catch(e){}Ge(t.id,"running...");const d=await a.runSqlGeoJSON(t,t.sql||"SELECT * FROM data");if(s)return;if(!d?.geojson)throw new Error("DuckDB GeoJSON path unavailable (requires spatial + h3 extensions and compatible columns).");const u=d.geojson;q(t.id,u);const y=!1!==n[t.id],p=function(e,t,i){try{const n=e.getSource(t);if(n&&"function"==typeof n.setData)return n.setData(i),!0}catch(e){}return!1}(e,t.id,u);if(!p)try{c(e,t,u,y)}catch(e){}!function(e,t){const n=t.hexLayer||{},r=t.data||[],l=Array.isArray(n.getFillColor)?i(n.getFillColor,.8):o(n.getFillColor,r)||"rgba(0,144,255,0.7)",a=n.getLineColor?Array.isArray(n.getLineColor)?i(n.getLineColor,1):o(n.getLineColor,r):"rgba(255,255,255,0.3)",s="number"==typeof n.opacity&&isFinite(n.opacity)?Math.max(0,Math.min(1,n.opacity)):.8;try{n.extruded&&e.getLayer(`${t.id}-extrusion`)&&(e.setPaintProperty(`${t.id}-extrusion`,"fill-extrusion-color",l),e.setPaintProperty(`${t.id}-extrusion`,"fill-extrusion-opacity",s))}catch(e){}try{!n.extruded&&e.getLayer(`${t.id}-fill`)&&(e.setPaintProperty(`${t.id}-fill`,"fill-color",l),e.setPaintProperty(`${t.id}-fill`,"fill-opacity",s))}catch(e){}try{e.getLayer(`${t.id}-outline`)&&(e.setPaintProperty(`${t.id}-outline`,"line-color",a),e.setPaintProperty(`${t.id}-outline`,"line-width",n.lineWidthMinPixels||.5))}catch(e){}}(e,t),Ge(t.id,`${(d.count||0).toLocaleString()} rows`),function(){try{window.dispatchEvent(new Event("fusedmaps:legend:update"))}catch(e){}}();try{r?.()}catch(e){}}catch(e){Ge(t.id,`error: ${(e?.message||"query failed").slice(0,60)}`)}}};(async()=>{for(const e of l){if(s)break;const t=(e.sql||"SELECT * FROM data").trim();await d(e,t)}})();const u=e=>{const t=e?.detail||{},i=String(t.layerId||""),n=String(t.sql||""),r=l.find(e=>e.id===i);r&&d(r,n)};try{window.addEventListener("fusedmaps:sql:update",u)}catch(e){}return{destroy:()=>{s=!0;try{window.removeEventListener("fusedmaps:sql:update",u)}catch(e){}}}}(l,t,m(),()=>{const e=D();Object.entries(e).forEach(([e,t])=>{r.setGeoJSON(e,t)}),b()}),!t.hasCustomView){!function(e,t,i){const n=new mapboxgl.LngLatBounds,r=i.getAllGeoJSONs();t.forEach(e=>{if(e.isTileLayer)return;if("raster"===e.layerType){const t=e.imageBounds;if(Array.isArray(t)&&4===t.length){const[e,i,r,l]=t;[e,i,r,l].every(e=>"number"==typeof e&&Number.isFinite(e))&&(n.extend([e,i]),n.extend([r,l]))}return}const t=r[e.id];t?.features?.length&&t.features.forEach(e=>{"Point"===e.geometry?.type?n.extend(e.geometry.coordinates):"Polygon"===e.geometry?.type||"MultiPolygon"===e.geometry?.type?("Polygon"===e.geometry.type?[e.geometry.coordinates]:e.geometry.coordinates).forEach(e=>e[0]?.forEach(e=>n.extend(e))):"LineString"===e.geometry?.type&&e.geometry.coordinates.forEach(e=>n.extend(e))})}),n.isEmpty()||e.fitBounds(n,{padding:50,maxZoom:15,duration:500})}(l,r.getAllConfigs(),r);try{const t=()=>{try{const t=e(l);a?.setHomeViewState?.(t)}catch(e){}try{l.off("moveend",t)}catch(e){}};l.on("moveend",t)}catch(e){}}}),l.on("load",()=>{[100,500,1e3].forEach(e=>setTimeout(()=>l.resize(),e))}),window.addEventListener("resize",()=>l.resize()),document.addEventListener("visibilitychange",()=>{document.hidden||setTimeout(()=>l.resize(),100)}),{map:l,deckOverlay:y,store:r,setLayerVisibility:(e,t)=>{Qe(e,t,l,r,y)},updateLegend:()=>{se(r.getAllConfigs(),m(),r.getAllGeoJSONs())},addLayer:(e,i)=>{const n=r.add(e,i);try{U(l,n.config,n.visible,t)}catch(e){const i=B(l,r.getAllConfigs(),m(),t);y=i.deckOverlay}return b(),n},removeLayer:e=>{const i=r.get(e)?.config,n=r.remove(e);if(n){try{i&&W(l,i)}catch(e){const i=B(l,r.getAllConfigs(),m(),t);y=i.deckOverlay}b()}return n},updateLayer:(e,n)=>{const a=r.get(e)?.config,c=r.update(e,n);if(c){if((1!==Object.keys(n||{}).length||!Object.prototype.hasOwnProperty.call(n,"visible"))&&a){const e=function(e,t,n,r){if(!t||!n)return!1;if(t.id!==n.id)return!1;if(t.layerType!==n.layerType)return!1;const l=n.id;if("raster"===n.layerType){const i=t,o=n;if(i.tileUrl!==o.tileUrl||i.imageUrl!==o.imageUrl||JSON.stringify(i.imageBounds)!==JSON.stringify(o.imageBounds))return!1;const a=o.opacity??o.rasterLayer?.opacity??1;return H(e,`${l}-raster`,"raster-opacity",Math.max(0,Math.min(1,a))),g(e,l,r),!0}if("vector"===n.layerType){const i=t,a=n;if(i.isFilled!==a.isFilled||i.isStroked!==a.isStroked||i.tileUrl!==a.tileUrl||i.sourceLayer!==a.sourceLayer)return!1;if(a.geojson&&!J(e,l,a.geojson)&&!e.getSource(l))return!1;const s=a.geojson,c=s?.features?.map(e=>e.properties||{})||[],d=a.fillColorConfig?.["@@function"]?o(a.fillColorConfig,c):a.fillColorRgba||"rgba(0,144,255,0.6)",u=a.lineColorConfig?.["@@function"]?o(a.lineColorConfig,c):a.lineColorRgba||"rgba(100,100,100,0.8)",y="number"==typeof a.lineWidth&&isFinite(a.lineWidth)?a.lineWidth:1,f="number"==typeof a.opacity&&isFinite(a.opacity)?Math.max(0,Math.min(1,a.opacity)):.8,g="number"==typeof a.pointRadius&&isFinite(a.pointRadius)?a.pointRadius:6;return H(e,`${l}-fill`,"fill-color",d),H(e,`${l}-fill`,"fill-opacity",f),H(e,`${l}-outline`,"line-color",u),H(e,`${l}-outline`,"line-width",y),H(e,`${l}-line`,"line-color",u),H(e,`${l}-line`,"line-width",y),H(e,`${l}-line`,"line-opacity",1),H(e,`${l}-circle`,"circle-radius",g),H(e,`${l}-circle`,"circle-color",d),H(e,`${l}-circle`,"circle-opacity",.9),H(e,`${l}-circle`,"circle-stroke-color",u),H(e,`${l}-circle`,"circle-stroke-width",1),p(e,l,r),!0}if("hex"===n.layerType){const a=t,c=n;if(c.isTileLayer)return!1;if(a.hexLayer?.extruded!==c.hexLayer?.extruded||a.hexLayer?.filled!==c.hexLayer?.filled||a.hexLayer?.stroked!==c.hexLayer?.stroked)return!1;const u=c.data&&Array.isArray(c.data)?s(c.data):null;if(u&&!J(e,l,u)&&!e.getSource(l))return!1;const y=c.hexLayer||{},p=c.data||[],f=Array.isArray(y.getFillColor)?i(y.getFillColor,.8):o(y.getFillColor,p)||"rgba(0,144,255,0.7)",g=y.getLineColor?Array.isArray(y.getLineColor)?i(y.getLineColor,1):o(y.getLineColor,p):"rgba(255,255,255,0.3)",h="number"==typeof y.opacity&&isFinite(y.opacity)?Math.max(0,Math.min(1,y.opacity)):.8;H(e,`${l}-fill`,"fill-color",f),H(e,`${l}-fill`,"fill-opacity",h),H(e,`${l}-outline`,"line-color",g),H(e,`${l}-outline`,"line-width",y.lineWidthMinPixels||.5);const m=y.elevationScale||1,b=y.elevationProperty||y.getFillColor?.attr||null;return H(e,`${l}-extrusion`,"fill-extrusion-color",f),H(e,`${l}-extrusion`,"fill-extrusion-height",b?["*",["to-number",["get",b],0],m]:100),H(e,`${l}-extrusion`,"fill-extrusion-opacity",h),d(e,l,r,!0===y.extruded),!0}if("mvt"===n.layerType){const i=t,a=n;if(i.tileUrl!==a.tileUrl||i.sourceLayer!==a.sourceLayer||i.isExtruded!==a.isExtruded||i.isFilled!==a.isFilled)return!1;const s=a.fillColorConfig?.["@@function"]?o(a.fillColorConfig,void 0):a.fillColor||"#FFF5CC",c=a.lineColorConfig?.["@@function"]?o(a.lineColorConfig,void 0):a.lineColor||"#FFFFFF",d=a.fillOpacity??.8,u=a.lineWidth??1;return H(e,`${l}-fill`,"fill-color",s),H(e,`${l}-fill`,"fill-opacity",d),H(e,`${l}-line`,"line-color",c),H(e,`${l}-line`,"line-width",u),e.getLayer(`${l}-extrusion`)&&(H(e,`${l}-extrusion`,"fill-extrusion-color",s),H(e,`${l}-extrusion`,"fill-extrusion-height",["*",["get",a.heightProperty||"height"],a.heightMultiplier||1]),H(e,`${l}-extrusion`,"fill-extrusion-opacity",a.extrusionOpacity??.9)),p(e,l,r),!0}if("pmtiles"===n.layerType){const i=t,o=n;if(i.pmtilesUrl!==o.pmtilesUrl||i.pmtilesPath!==o.pmtilesPath||JSON.stringify(i.excludeSourceLayers||[])!==JSON.stringify(o.excludeSourceLayers||[])||i.sourceLayer!==o.sourceLayer||i.renderPoints!==o.renderPoints||i.renderLines!==o.renderLines||i.renderPolygons!==o.renderPolygons)return!1;const a=o.vectorLayer||{},s=o.fillOpacity??a.opacity??.8,c=o.lineWidth??1,d=o.pointRadiusMinPixels??4,u=!1!==o.isFilled,y=!1!==o.isStroked?c:0,p=u?s:0,f=o.colorAttribute||"value",g=I(o.fillColorConfig||a.getFillColor,f,"#ff8c00"),h=I(o.lineColorConfig||a.getLineColor,f,"#ffffff"),m=`${l}-`,b=e.getStyle()?.layers||[];for(const t of b){const i=t?.id;i&&i.startsWith(m)&&(i.endsWith("-fill")?(H(e,i,"fill-color",g),H(e,i,"fill-opacity",p)):i.endsWith("-line")?(H(e,i,"line-color",h),H(e,i,"line-width",y),H(e,i,"line-opacity",s)):i.endsWith("-circles")&&(H(e,i,"circle-radius",["interpolate",["exponential",2],["zoom"],0,.5*d,10,d,15,4*d,20,20*d]),H(e,i,"circle-color",g),H(e,i,"circle-opacity",p),H(e,i,"circle-stroke-color",h),H(e,i,"circle-stroke-width",y)),V(e,i,"visibility",r?"visible":"none"))}return!0}return!1}(l,a,c.config,c.visible);if(!e)try{W(l,a),U(l,c.config,c.visible,t)}catch(e){const i=B(l,r.getAllConfigs(),m(),t);y=i.deckOverlay}}b()}return c},getLayer:e=>r.get(e),getLayers:()=>r.getAll(),moveLayerUp:e=>{r.moveUp(e);const i=B(l,r.getAllConfigs(),m(),t);y=i.deckOverlay},moveLayerDown:e=>{r.moveDown(e);const i=B(l,r.getAllConfigs(),m(),t);y=i.deckOverlay},destroy:()=>{try{v()}catch(e){}try{y?.__fused_hex_tiles__?.destroy?.()}catch(e){}try{a?.destroy?.()}catch(e){}try{u?.destroy?.()}catch(e){}try{h?.destroy?.()}catch(e){}try{f&&window.removeEventListener("fusedmaps:legend:update",f)}catch(e){}l.remove?.()}}}function Qe(e,t,i,n,r){n.setVisible(e,t),function(e,t,i,n,r){const l=n.find(e=>e.id===t);if(l)switch(l.layerType){case"hex":{const n=l;if(n.isTileLayer){const e=r?.__fused_hex_tiles__;try{e?.rebuild?.()}catch(e){}}else d(e,t,i,!0===n.hexLayer?.extruded);break}case"vector":case"mvt":p(e,t,i);break;case"raster":g(e,t,i);break;case"pmtiles":!function(e,t,i){const n=`${t}-`,r=e.getStyle()?.layers||[];for(const t of r){const r=t?.id;if(r&&r.startsWith(n))try{e.setLayoutProperty(r,"visibility",i?"visible":"none")}catch(e){}}}(e,t,i)}}(i,e,t,n.getAllConfigs(),r),oe(n.getAllConfigs(),n.getVisibilityState()),se(n.getAllConfigs(),n.getVisibilityState(),n.getAllGeoJSONs())}"undefined"!=typeof window&&(window.FusedMaps={init:Xe});var Ke={init:Xe};export{Ze as LayerStore,Ye as createLayerStore,Ke as default,Xe as init};
//# sourceMappingURL=fusedmaps.esm.js.map
