function e(e,t){void 0!==t.longitude&&void 0!==t.latitude&&e.setCenter([t.longitude,t.latitude]),void 0!==t.zoom&&e.setZoom(t.zoom),void 0!==t.pitch&&e.setPitch(t.pitch),void 0!==t.bearing&&e.setBearing(t.bearing)}function t(e){const t=e.getCenter();return{longitude:t.lng,latitude:t.lat,zoom:e.getZoom(),pitch:e.getPitch(),bearing:e.getBearing()}}function i(e,t){const i=window.cartocolor;if(!i)return null;const n=i[e];if(!n)return null;const r=Object.keys(n).map(Number).filter(e=>!isNaN(e)).sort((e,t)=>e-t),o=r.find(e=>e>=t)||r[r.length-1];return n[o]?[...n[o]]:null}function n(e,t){if(!Array.isArray(e)||e.length<3)return null;const[i,n,r]=e;return`rgba(${i},${n},${r},${e.length>=4?e[3]/255:t??1})`}const r=["#e0f3db","#ccebc5","#a8ddb5","#7bccc4","#4eb3d3","#2b8cbe","#0868ac","#084081"],o=["#7F3C8D","#11A579","#3969AC","#F2B701","#E73F74","#80BA5A","#E68310","#008695","#CF1C90","#f97b72"];function a(e,t,i){const n=new Map;return(e||[]).forEach(e=>{const r=e?.[t]??e?.properties?.[t];if(null!=r&&""!==r&&"null"!==r&&!n.has(r)){const t=i?e?.[i]??e?.properties?.[i]??r:r;n.set(r,String(t))}}),[...n.entries()].sort((e,t)=>"number"==typeof e[0]&&"number"==typeof t[0]?e[0]-t[0]:String(e[0]).localeCompare(String(t[0]))).map(([e,t])=>({value:e,label:t}))}function l(e,t){if(!e)return null;if(Array.isArray(e))return null;if("string"==typeof e)return e;const n=e["@@function"],r=e.attr;return n&&r?"colorCategories"===n?function(e,t){const n=Array.isArray(e.domain)?e.domain:[];let r=e.categories?e.categories.map(e=>"object"==typeof e?e:{value:e,label:String(e)}):n.length?n.map(e=>({value:e,label:String(e?.label??e)})):a(t,e.attr,e.labelAttr);if(!r.length)return"rgba(128,128,128,0.5)";let l=i(e.colors||"Bold",Math.max(r.length,3));l&&l.length||(l=o);const s=e.nullColor?`rgb(${e.nullColor.slice(0,3).join(",")})`:"rgba(128,128,128,0.5)",c=["match",["get",e.attr]];return r.forEach((e,t)=>{c.push(e.value),c.push(l[t%l.length])}),c.push(s),e._detectedCategories=r,c}(e,t):"colorContinuous"===n?function(e){if(!e.domain?.length)return null;const[t,n]=e.domain,r=t>n;let o=r?[n,t]:[t,n];if(o[0]===o[1]){const e=o[0],t=Math.abs(e)>0?.1*Math.abs(e):1;o=[e-t,e+t]}const a=!!e.reverse,l=e.steps||7,s=e.colors||"TealGrn",c=e.nullColor?`rgb(${e.nullColor.slice(0,3).join(",")})`:"rgb(184,184,184)";let d=i(s,l);if(!d||!d.length)return["case",["==",["get",e.attr],null],c,["interpolate",["linear"],["get",e.attr],o[0],"rgb(237,248,251)",o[1],"rgb(0,109,44)"]];(r?!a:a)&&(d=[...d].reverse());const u=["interpolate",["linear"],["get",e.attr]];return d.forEach((e,t)=>{const i=o[0]+(o[1]-o[0])*t/(d.length-1);u.push(i),u.push(e)}),["case",["==",["get",e.attr],null],c,u]}(e):null:null}function s(e){if(null==e)return null;try{if("string"==typeof e){const t=e.startsWith("0x")?e.slice(2):e;return/^\d+$/.test(t)?BigInt(t).toString(16):(/[a-f]/i.test(t),t.toLowerCase())}if("number"==typeof e)return BigInt(Math.trunc(e)).toString(16);if("bigint"==typeof e)return e.toString(16)}catch(e){}return null}function c(e){const t=[];for(const i of e){const e=s(i.hex??i.h3??i.index??i.id);if(e&&window.h3?.isValidCell(e))try{const n=window.h3.cellToBoundary(e).map(([e,t])=>[t,e]);n.push(n[0]),t.push({type:"Feature",properties:{...i,hex:e},geometry:{type:"Polygon",coordinates:[n]}})}catch(e){}}return{type:"FeatureCollection",features:t}}function d(e,t,i,r){const o=t.hexLayer||{},a=t.data||[];try{const n=e.getSource(t.id);n&&"function"==typeof n.setData?n.setData(i):n||e.addSource(t.id,{type:"geojson",data:i})}catch(e){}const s=Array.isArray(o.getFillColor)?n(o.getFillColor,.8):l(o.getFillColor,a)||"rgba(0,144,255,0.7)",c=o.getLineColor?Array.isArray(o.getLineColor)?n(o.getLineColor,1):l(o.getLineColor,a):"rgba(255,255,255,0.3)",d="number"==typeof o.opacity&&isFinite(o.opacity)?Math.max(0,Math.min(1,o.opacity)):.8;if(o.extruded){const i=o.elevationScale||1,n=o.elevationProperty||o.getFillColor?.attr||null;e.addLayer({id:`${t.id}-extrusion`,type:"fill-extrusion",source:t.id,paint:{"fill-extrusion-color":s,"fill-extrusion-height":n?["*",["to-number",["get",n],0],i]:100,"fill-extrusion-base":0,"fill-extrusion-opacity":d},layout:{visibility:r?"visible":"none"}})}else!1!==o.filled&&e.addLayer({id:`${t.id}-fill`,type:"fill",source:t.id,paint:{"fill-color":s,"fill-opacity":d},layout:{visibility:r?"visible":"none"}});!1!==o.stroked&&e.addLayer({id:`${t.id}-outline`,type:"line",source:t.id,paint:{"line-color":c,"line-width":o.lineWidthMinPixels||.5},layout:{visibility:r?"visible":"none"}})}function u(e,t,i,n){(n?[`${t}-extrusion`,`${t}-outline`]:[`${t}-fill`,`${t}-outline`]).forEach(t=>{try{e.getLayer(t)&&e.setLayoutProperty(t,"visibility",i?"visible":"none")}catch(e){}})}function p(e,t,i){const n=t.geojson;if(!n?.features?.length)return;const r={type:"geojson",data:n},o=t.geojsonSource;o&&"object"==typeof o&&("number"==typeof o.tolerance&&(r.tolerance=o.tolerance),"number"==typeof o.buffer&&(r.buffer=o.buffer),"number"==typeof o.maxzoom&&(r.maxzoom=o.maxzoom)),e.addSource(t.id,r);const a=n.features.map(e=>e.properties||{}),s=t.fillColorConfig?.["@@function"]?l(t.fillColorConfig,a):t.fillColorRgba||"rgba(0,144,255,0.6)",c=t.lineColorConfig?.["@@function"]?l(t.lineColorConfig,a):t.lineColorRgba||"rgba(100,100,100,0.8)",d="number"==typeof t.lineWidth&&isFinite(t.lineWidth)?t.lineWidth:1,u="number"==typeof t.opacity&&isFinite(t.opacity)?Math.max(0,Math.min(1,t.opacity)):.8;let p=!1,y=!1,f=!1;for(const e of n.features){const t=e.geometry?.type;"Point"!==t&&"MultiPoint"!==t||(y=!0),"Polygon"!==t&&"MultiPolygon"!==t||(p=!0),"LineString"!==t&&"MultiLineString"!==t||(f=!0)}p&&(!1!==t.isFilled&&e.addLayer({id:`${t.id}-fill`,type:"fill",source:t.id,paint:{"fill-color":s,"fill-opacity":u},filter:["any",["==",["geometry-type"],"Polygon"],["==",["geometry-type"],"MultiPolygon"]],layout:{visibility:i?"visible":"none"}}),!1!==t.isStroked&&e.addLayer({id:`${t.id}-outline`,type:"line",source:t.id,layout:{"line-join":"round","line-cap":"round",visibility:i?"visible":"none"},paint:{"line-color":c,"line-width":d},filter:["any",["==",["geometry-type"],"Polygon"],["==",["geometry-type"],"MultiPolygon"]]})),f&&e.addLayer({id:`${t.id}-line`,type:"line",source:t.id,layout:{"line-join":"round","line-cap":"round",visibility:i?"visible":"none"},paint:{"line-color":c,"line-width":d,"line-opacity":1},filter:["any",["==",["geometry-type"],"LineString"],["==",["geometry-type"],"MultiLineString"]]}),y&&e.addLayer({id:`${t.id}-circle`,type:"circle",source:t.id,paint:{"circle-radius":t.pointRadius||6,"circle-color":s,"circle-stroke-color":"rgba(0,0,0,0.5)","circle-stroke-width":1,"circle-opacity":.9},filter:["any",["==",["geometry-type"],"Point"],["==",["geometry-type"],"MultiPoint"]],layout:{visibility:i?"visible":"none"}})}function y(e,t,i){const n=t.sourceLayer||"udf";e.addSource(t.id,{type:"vector",tiles:[t.tileUrl],minzoom:t.minzoom||0,maxzoom:t.maxzoom||22});const r=t.fillColorConfig?.["@@function"]?l(t.fillColorConfig,void 0):t.fillColor||"#FFF5CC",o=t.lineColorConfig?.["@@function"]?l(t.lineColorConfig,void 0):t.lineColor||"#FFFFFF",a=t.fillOpacity??.8,s=t.lineWidth??1;!1!==t.isFilled&&e.addLayer({id:`${t.id}-fill`,type:"fill",source:t.id,"source-layer":n,paint:{"fill-color":r,"fill-opacity":a},layout:{visibility:i?"visible":"none"}}),e.addLayer({id:`${t.id}-line`,type:"line",source:t.id,"source-layer":n,paint:{"line-color":o,"line-width":s},layout:{visibility:i?"visible":"none"}}),t.isExtruded&&e.addLayer({id:`${t.id}-extrusion`,type:"fill-extrusion",source:t.id,"source-layer":n,paint:{"fill-extrusion-color":r,"fill-extrusion-height":["*",["get",t.heightProperty||"height"],t.heightMultiplier||1],"fill-extrusion-base":0,"fill-extrusion-opacity":t.extrusionOpacity??.9},layout:{visibility:i?"visible":"none"}})}function f(e,t,i){[`${t}-fill`,`${t}-outline`,`${t}-line`,`${t}-circle`,`${t}-extrusion`].forEach(t=>{try{e.getLayer(t)&&e.setLayoutProperty(t,"visibility",i?"visible":"none")}catch(e){}})}function g(e){return Math.max(0,Math.min(1,e))}function m(e,t,i){const n=t.opacity??t.rasterLayer?.opacity??1,r="string"==typeof t.tileUrl&&t.tileUrl.length>0,o="string"==typeof t.imageUrl&&t.imageUrl.length>0&&Array.isArray(t.imageBounds)&&4===t.imageBounds.length;if(r||o)if(o){const r=function(e){const[t,i,n,r]=e;return[[t,r],[n,r],[n,i],[t,i]]}(t.imageBounds),o=t.id,a=`${t.id}-raster`;(async function(e,t=3,i=500){let n=null;for(let r=0;r<t;r++)try{const t=await fetch(e);if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);const i=await t.blob();return new Promise((e,t)=>{const n=new FileReader;n.onloadend=()=>e(n.result),n.onerror=()=>t(new Error("Failed to read blob")),n.readAsDataURL(i)})}catch(e){n=e,r<t-1&&await new Promise(e=>setTimeout(e,i*Math.pow(2,r)))}throw n||new Error("Failed to fetch image")})(t.imageUrl).then(t=>{e.getSource(o)||(e.addSource(o,{type:"image",url:t,coordinates:r}),e.addLayer({id:a,type:"raster",source:o,paint:{"raster-opacity":g(n)},layout:{visibility:i?"visible":"none"}}))}).catch(e=>{console.warn(`[FusedMaps] Failed to load raster image after retries: ${t.imageUrl}`,e)})}else e.addSource(t.id,{type:"raster",tiles:[t.tileUrl],tileSize:256}),e.addLayer({id:`${t.id}-raster`,type:"raster",source:t.id,paint:{"raster-opacity":g(n)},layout:{visibility:i?"visible":"none"}})}function h(e,t,i){const n=`${t}-raster`;try{e.getLayer(n)&&e.setLayoutProperty(n,"visibility",i?"visible":"none")}catch(e){}}let b=null;function v(){return window.deck||null}function x(e,t,n){if(!n)return null;if(Array.isArray(n))return n;if("string"==typeof n&&n.startsWith("@@=")){const e=n.slice(3);return t=>{try{return new Function("object",`const properties = object?.properties || object || {}; return (${e});`)(t)}catch{return null}}}if("object"==typeof n&&n["@@function"]){const r=n["@@function"],o=n.attr;if(!o)return null;if("colorContinuous"===r){const e=n.domain;if(!Array.isArray(e)||e.length<2)return null;const t=Number(e[0]),r=Number(e[e.length-1]);if(!Number.isFinite(t)||!Number.isFinite(r)||t===r)return null;const a=Math.max(2,Number(n.steps??7)),l=i(n.colors||"ArmyRose",a)||null;if(!l?.length)return null;const s=t>r,c=!!n.reverse,d=(s?!c:c)?[...l].reverse():[...l],u=Math.min(t,r),p=Math.max(t,r),y=Array.isArray(n.nullColor)?n.nullColor:[184,184,184];return e=>{const t=(e?.properties||e||{})[o];let i=null;if("number"==typeof t)i=t;else if("string"==typeof t){const e=parseFloat(t);i=Number.isFinite(e)?e:null}if(null==i||!Number.isFinite(i))return y;const n=(i-u)/(p-u),r=Math.max(0,Math.min(d.length-1,Math.round(n*(d.length-1)))),a=d[r].replace("#","");return[parseInt(a.slice(0,2),16),parseInt(a.slice(2,4),16),parseInt(a.slice(4,6),16)]}}if("colorCategories"===r){const r=Array.isArray(n.categories)?n.categories:Array.isArray(n.domain)?n.domain:[],a=n.colors||"Bold",l=Array.isArray(n.nullColor)?n.nullColor:[184,184,184];if(r.length){const e=i(a,Math.max(r.length,3))||null,t=new Map;e?.length&&r.forEach((i,n)=>{const r=e[n%e.length]||"#999999",o=String(r).replace("#",""),a=parseInt(o.slice(0,2),16),l=parseInt(o.slice(2,4),16),s=parseInt(o.slice(4,6),16);t.set(String(i?.value??i),[a,l,s])});try{n._detectedCategories=r.map(e=>"object"==typeof e?{value:e.value,label:String(e.label??e.value)}:{value:e,label:String(e)})}catch(e){}return e=>{const i=(e?.properties||e||{})[o];return null==i?l:t.get(String(i))||l}}const s=t.id;e.catState[s]=e.catState[s]||{};const c=e.catState[s][o]||{lut:new Map,pairs:[],next:0};e.catState[s][o]=c;const d=i(a,12)||null,u=d?.length?d:["#7fc97f","#beaed4","#fdc086","#ffff99","#386cb0","#f0027f","#bf5b17","#666666"],p=()=>{try{if(c.debounce)return;c.debounce=setTimeout(()=>{c.debounce=null;try{window.dispatchEvent(new CustomEvent("fusedmaps:legend:update"))}catch(e){}},150)}catch(e){}};return e=>{const t=(e?.properties||e||{})[o];if(null==t||""===t||"null"===t)return l;const i=String(t);let r=c.lut.get(i);if(!r){const e=u[c.next%u.length]||"#999999";c.next+=1;const t=String(e).replace("#","");r=[parseInt(t.slice(0,2),16),parseInt(t.slice(2,4),16),parseInt(t.slice(4,6),16)],c.lut.set(i,r),c.pairs.length<50&&c.pairs.push({value:i,label:i});try{n._detectedCategories=c.pairs}catch(e){}p()}return r||l}}}return null}function C(e,t,i){const n=Math.PI-2*Math.PI*t/Math.pow(2,i),r=e/Math.pow(2,i)*360-180,o=180/Math.PI*Math.atan(Math.sinh(n)),a=Math.PI-2*Math.PI*(t+1)/Math.pow(2,i),l=(e+1)/Math.pow(2,i)*360-180;return{west:r,south:180/Math.PI*Math.atan(Math.sinh(a)),east:l,north:o}}function w(e,t){return!(e.east<t.west||e.west>t.east||e.north<t.south||e.south>t.north)}function L(e){const t=e.hexLayer?.getFillColor;if(!t||"object"!=typeof t||Array.isArray(t))return{enabled:!1,attr:null};if("colorContinuous"!==t["@@function"])return{enabled:!1,attr:null};const i=t.attr||null;if(!i)return{enabled:!1,attr:null};if(!0===e.fillDomainFromUser||!0===t.fillDomainFromUser)return{enabled:!1,attr:i};const n=Array.isArray(t.domain)&&t.domain.length>=2;return{enabled:!0===t.autoDomain||!n,attr:i}}function E(e){if(null==e)return null;if("number"==typeof e)return Number.isFinite(e)?e:null;if("bigint"==typeof e){const t=Number(e);return Number.isFinite(t)?t:null}if("string"==typeof e){const t=parseFloat(e);return Number.isFinite(t)?t:null}return null}function S(e,t,i,n,r){if(e.getZoom()<10)return null;if(!n)return null;const o=e.getBounds(),a={west:o.getWest(),east:o.getEast(),south:o.getSouth(),north:o.getNorth()},l=[];for(const[e,i]of t.cache.entries()){const t=e.split("|");if(t.length<2)continue;const[o,s,c]=t[1].split("/").map(Number);if(Number.isFinite(o)&&Number.isFinite(s)&&Number.isFinite(c)&&(!(Math.abs(o-r)>1)&&w(C(s,c,o),a)&&Array.isArray(i))){for(const e of i){if(l.length>=5e3)break;const t=e?.properties||e;if(!t)continue;const i=t[n];if(null==i)continue;const r="number"==typeof i?i:parseFloat(String(i));Number.isFinite(r)&&l.push(r)}if(l.length>=5e3)break}}if(l.length<30)return function(e,t,i,n){if(e.getZoom()<10)return null;const r=t.tileStats[i.id];if(!r)return null;const o=e.getBounds(),a={west:o.getWest(),east:o.getEast(),south:o.getSouth(),north:o.getNorth()};let l=Number.POSITIVE_INFINITY,s=Number.NEGATIVE_INFINITY,c=0;for(const[e,t]of Object.entries(r)){const[i,r,o]=e.split("/").map(Number);Number.isFinite(i)&&Number.isFinite(r)&&Number.isFinite(o)&&(Math.abs(i-n)>1||w(C(r,o,i),a)&&(Number.isFinite(t.min)&&(l=Math.min(l,t.min),c++),Number.isFinite(t.max)&&(s=Math.max(s,t.max))))}if(c<2||!Number.isFinite(l)||!Number.isFinite(s))return null;const d=s-l;if(Number.isFinite(d)&&d>0){const e=.01*d;l-=e,s+=e}return l>=s?[l-1,s+1]:[l,s]}(e,t,i,r);l.sort((e,t)=>e-t);const s=Math.floor(.02*l.length),c=Math.min(l.length-1,Math.ceil(.98*l.length)-1),d=l[Math.max(0,s)],u=l[Math.max(0,c)];return Number.isFinite(d)&&Number.isFinite(u)?d>=u?[d-1,u+1]:[d,u]:null}function A(e,t){const i=e.hexLayer?.getFillColor;if(!i||"object"!=typeof i)return!1;const n=i._dynamicDomain;return!!(!Array.isArray(n)||n.length<2||(()=>{const e=n[1]-n[0]?n[1]-n[0]:1;return Math.abs(t[0]-n[0])/e>.05||Math.abs(t[1]-n[1])/e>.05})())&&(i._dynamicDomain=t,!0)}function k(e){const t=e.tileLayerConfig||{};return{tileSize:t.tileSize??256,minZoom:t.minZoom??0,maxZoom:t.maxZoom??19,zoomOffset:t.zoomOffset??0,maxRequests:t.maxRequests??10,refinementStrategy:t.refinementStrategy??"best-available"}}function F(e,t,i,n,r){const o=v();if(!o)return[];const a=o.TileLayer,l=o.H3HexagonLayer||o?.GeoLayers?.H3HexagonLayer;return a&&l?e.filter(e=>"hex"===e.layerType&&e.isTileLayer&&e.tileUrl).map(e=>e).filter(e=>!1!==t[e.id]).slice().reverse().map(e=>{const t=e.tileUrl,o=k(e),c=e.hexLayer||{},d=c.getFillColor,u=d&&"object"==typeof d&&!Array.isArray(d)&&Array.isArray(d._dynamicDomain)?{...d,domain:d._dynamicDomain}:d,p=c.getLineColor,y=p&&"object"==typeof p&&!Array.isArray(p)&&Array.isArray(p._dynamicDomain)?{...p,domain:p._dynamicDomain}:p,f=x(i,e,u),g=x(i,e,y),m=function(e){let t=5381;for(let i=0;i<e.length;i++)t=(t<<5)+t^e.charCodeAt(i);return(t>>>0).toString(16)}(`${JSON.stringify({fd:u&&"object"==typeof u?u.domain||u._dynamicDomain:null,ld:y&&"object"==typeof y?y.domain||y._dynamicDomain:null})}|${JSON.stringify({f:u,l:y,stroked:!1!==c.stroked,filled:!1!==c.filled,extruded:!0===c.extruded,opacity:c.opacity,elevationScale:c.elevationScale,coverage:c.coverage,lineWidthMinPixels:c.lineWidthMinPixels})}`),h=!1!==c.stroked,v=!1!==c.filled,C=!0===c.extruded,w="number"==typeof c.opacity?c.opacity:.8,S=c.lineWidthMinPixels??1,A=c.elevationScale??1,F=c.coverage??.9,T=c.elevationProperty||(u&&"object"==typeof u?u.attr:null)||null,$=o.refinementStrategy||"best-available",M=r?.[e.id];return new a({id:`${e.id}-tiles-${m}`,data:t,tileSize:o.tileSize,minZoom:o.minZoom,maxZoom:o.maxZoom,zoomOffset:o.zoomOffset,maxRequests:o.maxRequests,maxCacheSize:200,refinementStrategy:$,pickable:!0,autoHighlight:!0,visible:!0,...M?{beforeId:M}:{},getTileData:async({index:r,signal:o})=>{const{x:a,y:l,z:c}=r,d=t.replace("{z}",c).replace("{x}",a).replace("{y}",l),u=d,p=`${c}/${a}/${l}`;if(i.cache.has(u))return i.cache.get(u);if(i.inflight.has(u))try{return await i.inflight.get(u)}catch{return i.cache.get(u)||[]}const y=i.retryState.get(u);if(y&&y.attempts>=3){if(Date.now()-y.lastAttempt<3e4)return[];i.retryState.delete(u)}n(1);const f=(async()=>{const t=(y?.attempts||0)+1,r=()=>{i.retryState.set(u,{attempts:t,lastAttempt:Date.now()})};try{const t=await fetch(d,{signal:o});if(o?.aborted)return null;if(!t.ok)throw new Error(`tile http ${t.status}`);const n=(t.headers.get("Content-Type")||"").toLowerCase();let c,y=null;if(n.includes("application/octet-stream")||n.includes("application/parquet")||d.endsWith(".parquet")){let e=window.hyparquet;if(!e?.parquetMetadataAsync||!e?.parquetReadObjects)try{e=await async function(){const e=window;return e.hyparquet?.parquetMetadataAsync&&e.hyparquet?.parquetReadObjects?e.hyparquet:b||(b=(async()=>{const t=await new Function("u","return import(u)")("https://cdn.jsdelivr.net/npm/hyparquet@1.23.3/+esm"),i=t?.default&&(t.default.parquetReadObjects||t.default.parquetMetadataAsync)?t.default:t;return e.hyparquet=i,e.hyparquet})().catch(e=>{throw b=null,e}),b)}()}catch(e){return console.error("[tiles] failed to auto-load hyparquet",e),r(),null}const i=await t.arrayBuffer();if(o?.aborted)return null;if(!i||0===i.byteLength)return[];const n={byteLength:i.byteLength,slice:async(e,t)=>i.slice(e,t)},a=await e.parquetMetadataAsync(n);if(y=a,o?.aborted)return null;c=await e.parquetReadObjects({file:n,utf8:!1,metadata:a})}else{let e=await t.text();if(o?.aborted)return null;e=e.replace(/\"(hex|h3|index|id)\"\s*:\s*(\d+)/gi,(e,t,i)=>`"${t}":"${i}"`),c=JSON.parse(e)}const f=(l=c,a=(Array.isArray(l)?l:Array.isArray(l?.data)?l.data:Array.isArray(l?.features)?l.features:[]).map(e=>e?.properties?{...e.properties}:{...e}).map(e=>{const t=s(e.hex??e.h3??e.index??e.id);if(!t)return null;const i={...e,hex:t};return{...i,properties:{...i}}}).filter(Boolean),(a||[]).map(e=>{const t=function(e){const t={};for(const i of Object.keys(e||{})){const n=e[i];if("bigint"==typeof n){const e=String(i).toLowerCase();"hex"===e||"h3"===e||"index"===e||"id"===e?t[i]=n.toString(16):n<=BigInt(Number.MAX_SAFE_INTEGER)&&n>=BigInt(Number.MIN_SAFE_INTEGER)?t[i]=Number(n):t[i]=n.toString()}else t[i]=n}return t}(e?.properties?e.properties:e||{});return{...t,properties:{...t}}}));i.cache.set(u,f),i.retryState.delete(u);try{const t=L(e);if(t.enabled&&t.attr&&y){const n=function(e,t){const i=e?.row_groups||e?.rowGroups||e?.row_groups_list||null;if(!Array.isArray(i)||0===i.length)return null;let n=Number.POSITIVE_INFINITY,r=Number.NEGATIVE_INFINITY,o=!1;for(const e of i){const i=e?.columns||e?.columns_list||null;if(Array.isArray(i))for(const e of i){const i=e?.meta_data||e?.metaData||e?.metadata||null,a=i?.path_in_schema||i?.pathInSchema||i?.path||null,l=Array.isArray(a)?String(a[a.length-1]):"string"==typeof a?a:null;if(!l||l!==t)continue;const s=i?.statistics||i?.stats||e?.statistics||null;if(!s)continue;const c=E(s.min_value??s.min??s.minimum??s.minValue),d=E(s.max_value??s.max??s.maximum??s.maxValue);null!=c&&null!=d&&(o=!0,c<n&&(n=c),d>r&&(r=d))}}return o&&Number.isFinite(n)&&Number.isFinite(r)?n===r?{min:n-1,max:r+1}:{min:n,max:r}:null}(y,t.attr);if(n){i.tileStats[e.id]||(i.tileStats[e.id]={}),i.tileStats[e.id][p]={min:n.min,max:n.max};try{window.dispatchEvent(new CustomEvent("fusedmaps:autodomain:dirty"))}catch{}}}}catch(e){}try{window.dispatchEvent(new CustomEvent("fusedmaps:legend:update"))}catch{}return f}catch(e){if(o?.aborted)return null;if(r(),t<3){const e=500*Math.pow(2,t-1);console.warn(`[tiles] Tile load failed (attempt ${t}/3), retrying in ${e}ms:`,p),setTimeout(()=>{try{window.dispatchEvent(new CustomEvent("fusedmaps:tiles:retry"))}catch(e){}},e)}else console.warn("[tiles] Tile load failed after 3 attempts:",p);return null}finally{i.inflight.delete(u),n(-1)}var a,l})();return i.inflight.set(u,f),await f},renderSubLayers:e=>{const t=e.data||[];return t&&t.length?new l({id:`${e.id}-h3`,data:t,getHexagon:e=>e.hex,pickable:!0,stroked:h,filled:v,extruded:C,opacity:w,coverage:F,lineWidthMinPixels:S,elevationScale:A,...C&&T?{getElevation:e=>Number(e?.[T]??0)}:{},...f?{getFillColor:f}:{},...g?{getLineColor:g}:{}}):null}})}):[]}let T=null,$=!1,M=null,N=null,P=null;const j=new Map;function O(e){const t=e?.json||{},i=[];if(Array.isArray(t.vector_layers))for(const e of t.vector_layers)e?.id&&i.push(String(e.id));if(t?.tilestats?.layers&&Array.isArray(t.tilestats.layers))for(const e of t.tilestats.layers){const t=e?.layer;t&&!i.includes(String(t))&&i.push(String(t))}return i}async function q(e){if(j.has(e))return j.get(e);const t=(async()=>{const t=new((await async function(){return N||P||(P=new Function("u","return import(u)")("https://cdn.jsdelivr.net/npm/pmtiles@3.0.6/+esm").then(e=>(N=e,N)).finally(()=>{P=null}),P)}()).PMTiles)(e);let i={};try{i=await t.getMetadata()}catch(e){i={}}const n=[];if(i?.vector_layers?.length>0)for(const e of i.vector_layers)e?.id&&n.push(String(e.id));if(i?.tilestats?.layers&&Array.isArray(i.tilestats.layers))for(const e of i.tilestats.layers){const t=e?.layer;t&&!n.includes(String(t))&&n.push(String(t))}return n})();return j.set(e,t),t.catch(()=>j.delete(e)),t}async function I(){return T||M||(window.mapboxPmTiles?(T=window.mapboxPmTiles,T):(M=new Promise((e,t)=>{const i=document.createElement("script");i.src="https://cdn.jsdelivr.net/npm/mapbox-pmtiles@1.0.54/dist/mapbox-pmtiles.umd.min.js",i.onload=()=>{T=window.mapboxPmTiles,e(T)},i.onerror=()=>t(new Error("Failed to load mapbox-pmtiles library")),document.head.appendChild(i)}).finally(()=>{M=null}),M))}function R(e,t,i="#ff8c00"){if(!e)return i;if("string"==typeof e)return e;if(Array.isArray(e))return e;const n=e["@@function"],r=e.attr||t;if("colorContinuous"===n){const t=e.domain||[0,100],i=e.steps||7,n=!!e.reverse;let o=e.colors;"string"==typeof o&&(o=function(e,t=7){const i=window.cartocolor,n=["#440154","#414487","#2a788e","#22a884","#7ad151","#fde725"];if(!i)return n;const r=i[e];if(r){const e=Object.keys(r).map(Number).filter(e=>!isNaN(e)).sort((e,t)=>t-e);return r[e.find(e=>e<=t)||e[e.length-1]]||n}return n}(o,i)),o&&Array.isArray(o)||(o=["#440154","#21918c","#fde725"]),n&&o.length>1&&(o=[...o].reverse());const a=e.nullColor?Array.isArray(e.nullColor)?`rgb(${e.nullColor.slice(0,3).join(",")})`:e.nullColor:"rgb(184,184,184)",l=["interpolate",["linear"],["to-number",["get",r]]],s=o.length;for(let e=0;e<s;e++){const i=e/(s-1),n=t[0]+i*(t[1]-t[0]);l.push(n,o[e])}return["case",["==",["get",r],null],a,l]}if("colorCategories"===n){const t=e.categories||{},i=e.othersColor||"#888888",n=["match",["get",r]];for(const[e,i]of Object.entries(t))n.push(e,i);return n.push(i),n}return i}async function D(e,t,i,n=!1){if(0===t.length)return;await async function(){if($)return;const e=window.mapboxgl;if(!e?.Style?.setSourceType)throw new Error("Mapbox GL JS v3 with Style.setSourceType is required for PMTiles");const t=await I();e.Style.setSourceType(t.SOURCE_TYPE,t.PmTilesSource),$=!0}();const r=await I();for(let o=0;o<t.length;o++){const a=t[o];if(!a.pmtilesUrl)continue;const l=!1!==i[a.id],s=`${a.id}-source`;try{const t=await r.PmTilesSource.getHeader(a.pmtilesUrl),i=[t.minLon,t.minLat,t.maxLon,t.maxLat];let c=O(t);const d=c[0]||"default",u="string"==typeof a.sourceLayer?a.sourceLayer.trim():"";if(!u&&0===c.length)try{c=await q(a.pmtilesUrl)}catch(e){}const p=c[0]||d,y=new Set([...a.excludeSourceLayers||[],...a.exclude_source_layers||[],...a.vectorLayer?.excludeSourceLayers||[],...a.vectorLayer?.exclude_source_layers||[]].filter(Boolean)),f=e=>e.filter(e=>!y.has(e)),g=!u&&c.length>1?f(c):c,m="*"===u?f(c):u?[u]:c.length>1?g:[p];0===m.length&&console.warn("[FusedMaps] PMTiles: could not detect any source-layers; set `source_layer` explicitly for:",a.id),u&&"*"!==u&&c.length>0&&!c.includes(u)&&console.warn("[FusedMaps] PMTiles: requested source-layer not found in header.json:",{requested:u,available:c}),e.getSource(s)||e.addSource(s,{type:r.SOURCE_TYPE,url:a.pmtilesUrl,minzoom:t.minZoom,maxzoom:t.maxZoom,bounds:i});const h=a.vectorLayer||{},b=a.fillOpacity??h.opacity??.8,v=a.lineWidth??1,x=a.pointRadiusMinPixels??4,C=!1!==a.isFilled,w=!1!==a.isStroked?v:0,L=C?b:0,E=!1!==a.renderPoints&&!1!==a.vectorLayer?.renderPoints,S=!1!==a.renderLines&&!1!==a.vectorLayer?.renderLines,A=!1!==a.renderPolygons&&!1!==a.vectorLayer?.renderPolygons,k=R(a.fillColorConfig||h.getFillColor,a.colorAttribute||"value","#ff8c00"),F=R(a.lineColorConfig||h.getLineColor,a.colorAttribute||"value","#ffffff"),T=e=>e.replace(/[^a-zA-Z0-9_-]+/g,"-");for(const t of m){const i=T(t||"default"),n={};if("number"==typeof a.minzoom&&(n.minzoom=a.minzoom),"number"==typeof a.maxzoom&&(n.maxzoom=a.maxzoom),E){const r=`${a.id}-${i}-circles`;e.getLayer(r)||e.addLayer({id:r,type:"circle",source:s,"source-layer":t,...n,paint:{"circle-radius":["interpolate",["exponential",2],["zoom"],0,.5*x,10,x,15,4*x,20,20*x],"circle-color":k,"circle-opacity":L,"circle-stroke-color":F,"circle-stroke-width":w},layout:{visibility:l?"visible":"none"}})}if(A){const r=`${a.id}-${i}-fill`;e.getLayer(r)||e.addLayer({id:r,type:"fill",source:s,"source-layer":t,...n,paint:{"fill-color":k,"fill-opacity":L},layout:{visibility:l?"visible":"none"}})}if(S){const r=`${a.id}-${i}-line`;e.getLayer(r)||e.addLayer({id:r,type:"line",source:s,"source-layer":t,...n,paint:{"line-color":F,"line-width":w,"line-opacity":b},layout:{visibility:l?"visible":"none"}})}}!n&&i&&0===o&&e.fitBounds([[i[0],i[1]],[i[2],i[3]]],{padding:50,duration:0})}catch(e){console.error(`[FusedMaps] Failed to add PMTiles layer ${a.id}:`,e)}}}const _={};function B(){return _}function z(e,t){_[e]=t}function U(e){delete _[e]}function W(e){switch(e.layerType){case"vector":{const t=e,i=t.geojson;if(i?.features?.length){for(const n of i.features){const i=n.geometry?.type;if("Polygon"===i||"MultiPolygon"===i)return!1!==t.isFilled?`${e.id}-fill`:`${e.id}-outline`}for(const t of i.features){const i=t.geometry?.type;if("LineString"===i||"MultiLineString"===i)return`${e.id}-line`}for(const t of i.features){const i=t.geometry?.type;if("Point"===i||"MultiPoint"===i)return`${e.id}-circle`}}return`${e.id}-fill`}case"hex":{const t=e;return t.isTileLayer?null:t.hexLayer?.extruded?`${e.id}-extrusion`:`${e.id}-fill`}case"mvt":case"pmtiles":return`${e.id}-fill`;case"raster":return`${e.id}-raster`;default:return null}}function H(e,t,i,n){!function(e,t){t.forEach(t=>{V(e,t)})}(e,t),[...t].reverse().forEach(t=>{const n=!1!==i[t.id];switch(t.layerType){case"hex":{const i=t;if(i.isTileLayer);else if(i.data?.length){const r=c(i.data);z(t.id,r),d(e,i,r,n)}break}case"vector":{const i=t;i.geojson&&(z(t.id,i.geojson),p(e,i,n));break}case"mvt":y(e,t,n);break;case"raster":m(e,t,n)}});const r={};for(let e=0;e<t.length;e++){const i=t[e];if("hex"===i.layerType&&i.isTileLayer)for(let n=e-1;n>=0;n--){const e=t[n];if("hex"===e.layerType&&e.isTileLayer)continue;const o=W(e);if(o){r[i.id]=o;break}}}let o=null;if(t.some(e=>"hex"===e.layerType&&e.isTileLayer&&e.tileUrl)){const n=function(e,t,i,n){const r=v();if(!r?.MapboxOverlay||!r?.TileLayer)return null;const o={cache:new Map,inflight:new Map,retryState:new Map,tilesLoading:0,tileStats:{},catState:{}},a=function(){let e=document.getElementById("tile-loader");e||(e=document.createElement("div"),e.id="tile-loader",e.innerHTML='<div class="loader-spinner"></div><span id="loader-text">Loading tiles...</span>',document.body.appendChild(e));const t=document.getElementById("loader-text");let i=null,n=0;return{setLoading:r=>{n=Math.max(0,n+r),e&&(n>0?(i&&clearTimeout(i),e.classList.add("active"),t&&(t.textContent=1===n?"Loading tile...":`Loading ${n} tiles...`)):i=setTimeout(()=>e?.classList.remove("active"),300))}}}(),l={current:i},s=()=>F(t,l.current,o,a.setLoading,n),c={current:null},d=new r.MapboxOverlay({interleaved:!0,useDevicePixels:!0,layers:s(),onHover:e=>{c.current=e?.object?e:null}});try{e.addControl(d)}catch{}const u=t=>{t&&(l.current=t);try{d.setProps({layers:s()});try{e.triggerRepaint?.()}catch{}}catch{}},p=t.filter(e=>"hex"===e.layerType&&e.isTileLayer).map(e=>({layer:e,...L(e),tileCfg:k(e)})).filter(e=>e.enabled&&e.attr);let y=null;const f=t=>{p.length&&(y&&clearTimeout(y),y=setTimeout(()=>{let t=!1;for(const i of p){const n=Math.round(e.getZoom())+(i.tileCfg.zoomOffset||0),r=S(e,o,i.layer,i.attr,n);r&&A(i.layer,r)&&(t=!0)}if(t){u();try{window.dispatchEvent(new CustomEvent("fusedmaps:legend:update"))}catch{}}},t))},g=()=>f(800),m=()=>f(1200),h=()=>f(150);if(p.length){e.on("moveend",g),e.on("idle",m);try{window.addEventListener("fusedmaps:autodomain:dirty",h)}catch{}f(1500)}const b=()=>{try{u()}catch(e){}};try{window.addEventListener("fusedmaps:tiles:retry",b)}catch{}return{overlay:d,rebuild:u,pickObject:e=>{try{return d.pickObject(e)}catch{return null}},getHoverInfo:()=>c.current,getTileData:()=>o.cache,destroy:()=>{y&&clearTimeout(y);try{e.off("moveend",g)}catch{}try{e.off("idle",m)}catch{}try{window.removeEventListener("fusedmaps:autodomain:dirty",h)}catch{}try{window.removeEventListener("fusedmaps:tiles:retry",b)}catch{}try{e.removeControl(d)}catch{}}}}(e,t,i,r);o=n?.overlay||null,o&&n&&(o.__fused_hex_tiles__=n)}const a=t.filter(e=>"pmtiles"===e.layerType);return a.length>0&&D(e,a,i,!0===n?.hasCustomView).catch(e=>{console.error("[FusedMaps] Failed to add PMTiles layers:",e)}),{deckOverlay:o}}function G(e,t,i,n){switch(t.layerType){case"hex":{const n=t;if(!n.isTileLayer&&n.data?.length){const r=c(n.data);z(t.id,r),d(e,n,r,i)}break}case"vector":{const n=t;n.geojson&&(z(t.id,n.geojson),p(e,n,i));break}case"mvt":y(e,t,i);break;case"raster":m(e,t,i);break;case"pmtiles":D(e,[t],{[t.id]:i},!0===n?.hasCustomView).catch(e=>{console.error("[FusedMaps] Failed to add PMTiles layer:",e)})}}function V(e,t){if("pmtiles"===t.layerType)return function(e,t){const i=`${t}-`,n=e.getStyle()?.layers||[];for(let t=n.length-1;t>=0;t--){const r=n[t]?.id;if(r&&r.startsWith(i))try{e.getLayer(r)&&e.removeLayer(r)}catch(e){}}const r=`${t}-source`;e.getSource(r)&&e.removeSource(r)}(e,t.id),void U(t.id);[`${t.id}-fill`,`${t.id}-extrusion`,`${t.id}-outline`,`${t.id}-circle`,`${t.id}-line`,`${t.id}-raster`,`${t.id}-circles`].forEach(t=>{try{e.getLayer(t)&&e.removeLayer(t)}catch(e){}});try{e.getSource(t.id)&&e.removeSource(t.id),e.getSource(`${t.id}-source`)&&e.removeSource(`${t.id}-source`)}catch(e){}U(t.id)}function Z(e,t,i,n){try{e.getLayer(t)&&e.setPaintProperty(t,i,n)}catch(e){}}function J(e,t,i,n){try{e.getLayer(t)&&e.setLayoutProperty(t,i,n)}catch(e){}}function Y(e,t,i){try{const n=e.getSource(t);if(n&&"function"==typeof n.setData)return n.setData(i),!0}catch(e){}return!1}const X={"top-left":"fm-widgets-top-left","top-right":"fm-widgets-top-right","bottom-left":"fm-widgets-bottom-left","bottom-right":"fm-widgets-bottom-right","top-center":"fm-widgets-top-center"};function Q(e){const t=X[e];let i=document.getElementById(t);return i||(i=document.createElement("div"),i.id=t,i.className=`fm-widget-container fm-widget-${e}`,document.body.appendChild(i)),i}let K=null,ee=null,te=!1,ie=!1,ne=null,re={},oe=null;function ae(e){try{const t=e.target;if(!t)return;const i=t.closest?.(".layer-item");if(!i)return;const n=i.getAttribute("data-layer-id")||"";if(!n)return;if(t.closest?.(".layer-eye")||t.closest?.(".layer-item")){const t=function(e){try{return ne?!1!==ne.get(e)?.visible:!1!==re[e]}catch(e){return!0}}(n);K?.(n,!t),e.preventDefault(),e.stopPropagation()}}catch(e){}}const le='<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>',se='<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/></svg>',ce='<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M11.99 18.54l-7.37-5.73L3 14.07l9 7 9-7-1.63-1.27-7.38 5.74zM12 16l7.36-5.73L21 9l-9-7-9 7 1.63 1.27L12 16z"/></svg>';function de(e,t,i,n,r="top-right",o=!1){K=i;const a=n;ne=a||null,re=t||{};const l=Q(r);let s=document.getElementById("layer-panel");if(!s){s=document.createElement("div"),s.id="layer-panel",s.className=o?"fm-dropdown-widget":"fm-dropdown-widget collapsed",s.innerHTML=`\n      <button id="layer-panel-toggle" class="fm-dropdown-toggle" title="Layers">\n        ${ce}\n      </button>\n      <div class="fm-dropdown-panel" id="layer-panel-dropdown">\n        <div class="fm-dropdown-header">\n          <span class="fm-dropdown-header-icon">${ce}</span>\n          <span class="fm-dropdown-title">Layers</span>\n          <button class="fm-dropdown-close" id="layer-panel-close" title="Close"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>\n        </div>\n        <div id="layer-list"></div>\n      </div>\n    `,l.appendChild(s);const e=document.getElementById("layer-panel-toggle");e?.addEventListener("click",e=>{e.stopPropagation();const t=s?.classList.contains("collapsed");t&&document.querySelectorAll(".fm-dropdown-widget:not(#layer-panel)").forEach(e=>{e.classList.add("collapsed")}),s?.classList.toggle("collapsed")});const t=document.getElementById("layer-panel-close");t?.addEventListener("click",e=>{e.stopPropagation(),s?.classList.add("collapsed")}),document.addEventListener("click",e=>{const t=e.target;s?.contains(t)||s?.classList.add("collapsed")})}if(oe=s,!ie)try{s.addEventListener("click",ae),ie=!0}catch(e){}if(a?ue(a):pe(e,t),a&&(ee=a.on("*",e=>{"visibility"!==e.type&&"reorder"!==e.type&&"add"!==e.type&&"remove"!==e.type&&"batch"!==e.type||ue(a)})),!te){te=!0;try{window.addEventListener("fusedmaps:legend:update",()=>{try{a&&ue(a)}catch(e){}})}catch(e){}}return{destroy:()=>{ee&&(ee(),ee=null);try{oe?.removeEventListener("click",ae)}catch(e){}ie=!1,oe=null,ne=null}}}function ue(e){const t=document.getElementById("layer-list");if(!t)return;const i=e.getAll();t.innerHTML=i.map(e=>{const t=e.config,i=e.visible,n=ye(t),r=i?le:se;return`\n      <div class="layer-item ${i?"":"disabled"}"\n           data-layer-id="${t.id}"\n           data-order="${e.order}"\n           style="--layer-strip: ${n};">\n        <span class="layer-name">${t.name}</span>\n        <span class="layer-eye" title="Toggle visibility">${r}</span>\n      </div>\n    `}).join("")}function pe(e,t){const i=document.getElementById("layer-list");i&&(re=t||{},i.innerHTML=e.map(e=>{const i=!1!==t[e.id],n=ye(e),r=i?le:se;return`\n      <div class="layer-item ${i?"":"disabled"}" \n           data-layer-id="${e.id}" \n           style="--layer-strip: ${n};">\n        <span class="layer-name">${e.name}</span>\n        <span class="layer-eye" title="Toggle visibility">${r}</span>\n      </div>\n    `}).join(""))}function ye(e){let t="#0090ff";const r=e=>e&&e.length?1===e.length?e[0]:`linear-gradient(to bottom, ${e.map((t,i)=>`${t} ${i/(e.length-1)*100}%`).join(", ")})`:null;if("hex"===e.layerType){const o=e.hexLayer||{},a=!1===o.filled&&o.getLineColor?o.getLineColor:o.getFillColor;if(Array.isArray(a)){const e=n(a,1);e&&(t=e)}else if(a&&"object"==typeof a){const e=a["@@function"];if("colorContinuous"===e||"colorCategories"===e){let n=i(a.colors||("colorCategories"===e?"Bold":"TealGrn"),a.steps||7);if(n?.length){const e=a.domain,i=Array.isArray(e)&&e.length>=2&&e[0]>e[e.length-1],o=!!a.reverse;(i?!o:o)&&(n=[...n].reverse()),t=r(n)||t}}}}else if("vector"===e.layerType){const n=e,o=(n.vectorLayer?.opacity??n.opacity??1)<.1||!n.isFilled;let a=null;if(o&&n.lineColorConfig?a=n.lineColorConfig:n.fillColorConfig?a=n.fillColorConfig:n.lineColorConfig&&(a=n.lineColorConfig),a&&"object"==typeof a){const e=a["@@function"];if("colorContinuous"===e||"colorCategories"===e){let n=i(a.colors||("colorCategories"===e?"Bold":"TealGrn"),a.steps||7);if(n?.length){const e=a.domain,i=Array.isArray(e)&&e.length>=2&&e[0]>e[e.length-1],o=!!a.reverse;(i?!o:o)&&(n=[...n].reverse()),t=r(n)||t}}}else o&&n.lineColorRgba?t=n.lineColorRgba:n.fillColorRgba&&(t=n.fillColorRgba)}else if("pmtiles"===e.layerType){const n=e;if(n.fillColorConfig&&"object"==typeof n.fillColorConfig){const e=n.fillColorConfig.colors;if(e){let o=i(e,7);o?.length&&(!!n.fillColorConfig.reverse&&(o=[...o].reverse()),t=r(o)||t)}}}else"raster"===e.layerType&&(t="linear-gradient(to bottom, #888, #444)");return t}const fe='<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><rect x="3" y="5" width="4" height="3" rx="0.5"/><rect x="9" y="5" width="12" height="3" rx="0.5"/><rect x="3" y="10.5" width="4" height="3" rx="0.5"/><rect x="9" y="10.5" width="9" height="3" rx="0.5"/><rect x="3" y="16" width="4" height="3" rx="0.5"/><rect x="9" y="16" width="6" height="3" rx="0.5"/></svg>';function ge(e,t,n,l){const s=document.getElementById("color-legend"),c=document.getElementById("legend-content");if(!s)return;const d=e.filter(e=>!1!==t[e.id]);if(!d.length)return void(s.style.display="none");let u="";d.forEach(e=>{const t=function(e,t,n){let l=null;if("hex"===e.layerType){const t=e,i=t.hexLayer||{};if(l=!1===i.filled&&i.getLineColor?i.getLineColor:i.getFillColor,t.isTileLayer&&function(e){if("string"!=typeof e)return!1;if(!e.startsWith("@@="))return!1;const t=e.includes("properties.r")||e.includes(".r]")||e.includes(".r,"),i=e.includes("properties.g")||e.includes(".g]")||e.includes(".g,"),n=e.includes("properties.b")||e.includes(".b]")||e.includes(".b,");return t&&i&&n}(l)&&n&&n.size>0){const r=i.legendAttr||(Array.isArray(i.tooltipColumns)?i.tooltipColumns[0]:null)||(Array.isArray(t.tooltipColumns)?t.tooltipColumns[0]:null)||"taxsubgrp",o=Number.isFinite(i.legendMaxCategories)?i.legendMaxCategories:40;return function(e,t,i="taxsubgrp",n=40){try{if(!t||0===t.size)return"";const r=new Map;for(const e of t.values())if(Array.isArray(e)){for(const t of e){const e=t?.properties||t||{},o=e[i];if(null==o||""===o||"null"===o)continue;const a=String(o);if(r.has(a))continue;const l=Number(e.r),s=Number(e.g),c=Number(e.b);if(!Number.isFinite(l)||!Number.isFinite(s)||!Number.isFinite(c))continue;const d=e=>Math.max(0,Math.min(255,Math.round(e)));if(r.set(a,[d(l),d(s),d(c)]),r.size>=n)break}if(r.size>=n)break}return 0===r.size?"":`\n      <div class="legend-layer">\n        <div class="legend-title">${e}</div>\n        <div class="legend-categories">\n          ${[...r.keys()].sort((e,t)=>e.localeCompare(t)).map(e=>({label:e,rgb:r.get(e)})).map(e=>`\n            <div class="legend-cat-item">\n              <div class="legend-cat-swatch" style="background:rgb(${e.rgb[0]},${e.rgb[1]},${e.rgb[2]});"></div>\n              <span class="legend-cat-label" title="${e.label}">${e.label}</span>\n            </div>\n          `).join("")}\n        </div>\n      </div>\n    `}catch(e){return""}}(e.name,n,r,o)}}else if("vector"===e.layerType){const t=e,i=e=>e?.["@@function"]||"continuous"===e?.type||"categorical"===e?.type;if(((t.vectorLayer?.opacity??1)<.1||!1===t.vectorLayer?.filled)&&i(t.lineColorConfig)?l=t.lineColorConfig:i(t.fillColorConfig)?l=t.fillColorConfig:i(t.lineColorConfig)&&(l=t.lineColorConfig),!i(l)&&t.lineColorRgba&&!t.isFilled)return`\n        <div class="legend-layer">\n          <div class="legend-title">\n            <span class="legend-line" style="background:${t.lineColorRgba};"></span>\n            ${e.name}\n          </div>\n        </div>\n      `}const s=l?.["@@function"]||("continuous"===l?.type?"colorContinuous":"categorical"===l?.type?"colorCategories":null);if(!s||!l?.attr)return"";if("colorContinuous"!==s&&"colorCategories"!==s)return"";const c=l.colors||l.palette||("colorCategories"===s?"Bold":"TealGrn");if("colorCategories"===s){try{const i=l;if(!(Array.isArray(i._detectedCategories)&&i._detectedCategories.length||Array.isArray(i.categories)&&i.categories.length)&&i.attr){let n=[];const r=t?.[e.id];if(r?.features?.length)n=r.features.map(e=>e?.properties||{});else if("hex"===e.layerType)n=e.data||[];else if("vector"===e.layerType){const t=e.geojson;t?.features?.length&&(n=t.features.map(e=>e?.properties||{}))}const o=a(n,i.attr,i.labelAttr);i._detectedCategories=o.slice(0,50)}}catch(e){}return function(e,t,n){let r=t._detectedCategories||t.categories||[];if(r=r.map(e=>"object"==typeof e&&e.label?e:{value:e,label:e}),!r.length)return"";let a=i(n,Math.max(r.length,3));return a?.length||(a=o),`\n    <div class="legend-layer">\n      <div class="legend-title">${e}</div>\n      <div class="legend-categories">\n        ${r.map((e,t)=>`\n          <div class="legend-cat-item">\n            <div class="legend-cat-swatch" style="background:${a[t%a.length]};"></div>\n            <span class="legend-cat-label" title="${e.label}">${e.label}</span>\n          </div>\n        `).join("")}\n      </div>\n    </div>\n  `}(e.name,l,c)}return"colorContinuous"===s?function(e,t,n){const o=t._dynamicDomain||t.domain;if(!o?.length)return"";const[a,l]=o,s=a>l;let c=i(n,t.steps||7);c?.length||(c=r),s&&(c=[...c].reverse());return`\n    <div class="legend-layer">\n      <div class="legend-title">${e}</div>\n      <div class="legend-gradient" style="background:${`linear-gradient(to right, ${c.map((e,t)=>`${e} ${t/(c.length-1)*100}%`).join(", ")})`};"></div>\n      <div class="legend-labels">\n        <span>${a.toFixed(1)}</span>\n        <span>${l.toFixed(1)}</span>\n      </div>\n    </div>\n  `}(e.name,l,c):""}(e,n,l);t&&(u+=t)}),u?(c?c.innerHTML=u:s.innerHTML=u,s.style.display="block"):s.style.display="none"}function me(e){return Number.isInteger(e)?String(e):e.toFixed(2)}const he=[{id:"dark",label:"Dark",style:"mapbox://styles/mapbox/dark-v11",thumbnail:"linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%)"},{id:"satellite",label:"Satellite",style:"mapbox://styles/mapbox/satellite-streets-v12",thumbnail:"linear-gradient(135deg, #2d5016 0%, #1a3a0f 50%, #0d2818 100%)"},{id:"light",label:"Light",style:"mapbox://styles/mapbox/light-v11",thumbnail:"linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 50%, #d0d0d0 100%)"},{id:"streets",label:"Streets",style:"mapbox://styles/mapbox/streets-v12",thumbnail:"linear-gradient(135deg, #e8e4d9 0%, #d4cfc0 50%, #b8c4a8 100%)"}];function be(e,t,i,n="bottom-left"){const r={...t};class o{onAdd(e){this._map=e;const t=document.createElement("div");t.className="mapboxgl-ctrl mapboxgl-ctrl-group";const n=(e,t,i)=>{const n=document.createElement("button");return n.type="button",n.title=t,n.setAttribute("aria-label",t),n.style.fontSize="16px",n.style.lineHeight="20px",n.style.fontWeight="600",n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.textContent=e,n.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation();try{i()}catch(e){}}),n};return t.appendChild(n("+","Zoom in",()=>e.zoomIn({duration:250}))),t.appendChild(n("−","Zoom out",()=>e.zoomOut({duration:250}))),t.appendChild(n("⌂","Reset view",()=>{e.easeTo({center:[r.longitude,r.latitude],zoom:Number.isFinite(r.zoom)?r.zoom:e.getZoom(),pitch:Number.isFinite(r.pitch??0)?r.pitch??0:e.getPitch(),bearing:Number.isFinite(r.bearing??0)?r.bearing??0:e.getBearing(),duration:600})})),i&&t.appendChild(((t,i)=>{const n=document.createElement("button");return n.type="button",n.title=i,n.setAttribute("aria-label",i),n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.innerHTML='<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" style="display:block">\n              <path d="M4 8h3l1.2-2h7.6L17 8h3a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2z"/>\n              <circle cx="12" cy="14" r="3.2"/>\n            </svg>',n.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation();try{!function(e){const t=`map-screenshot-${(new Date).toISOString().replace(/[:.]/g,"-")}.png`;try{const i=e.getCanvas(),n=document.createElement("a");if(n.download=t,"function"==typeof i.toBlob)return void i.toBlob(e=>{try{if(!e)throw new Error("toBlob returned null");const t=URL.createObjectURL(e);n.href=t,document.body.appendChild(n),n.click(),n.remove(),setTimeout(()=>URL.revokeObjectURL(t),1e3)}catch(e){console.error("Screenshot failed:",e),alert("Screenshot blocked (likely due to CORS/tainted canvas from raster tiles). Try using only CORS-enabled layers/tiles.")}},"image/png");const r=i.toDataURL("image/png");n.href=r,document.body.appendChild(n),n.click(),n.remove()}catch(e){console.error("Screenshot failed:",e),alert("Screenshot blocked (likely due to CORS/tainted canvas from raster tiles). Try using only CORS-enabled layers/tiles.")}}(e)}catch(e){}}),n})(0,"Download screenshot")),this._container=t,t}onRemove(){try{this._container?.parentNode?.removeChild(this._container)}catch(e){}this._map=void 0,this._container=void 0}}try{e.addControl(new o,n)}catch(e){}return{setHomeViewState:e=>{try{if(!e)return;"number"==typeof e.longitude&&Number.isFinite(e.longitude)&&(r.longitude=e.longitude),"number"==typeof e.latitude&&Number.isFinite(e.latitude)&&(r.latitude=e.latitude),"number"==typeof e.zoom&&Number.isFinite(e.zoom)&&(r.zoom=e.zoom),"number"==typeof e.pitch&&Number.isFinite(e.pitch)&&(r.pitch=e.pitch),"number"==typeof e.bearing&&Number.isFinite(e.bearing)&&(r.bearing=e.bearing)}catch(e){}}}}function ve(e,t,i=!0){const n="boolean"==typeof i?{screenshot:i}:i,r=n.positions||{},o=r.controls??"bottom-left",a=r.scale??"bottom-left",l=r.basemap??"bottom-left";!1!==a&&function(e,t="bottom-left"){try{e.addControl(new mapboxgl.ScaleControl({maxWidth:110,unit:"metric"}),t)}catch(e){}}(e,a);let s=null;!1!==o&&(s=be(e,t,!1!==n.screenshot,o));const c=function(e){const t=e.getCanvasContainer?.()||e.getCanvas?.();if(!t)return()=>{};let i=!1,n=0,r=0,o=0,a=0;const l=()=>{if(i){i=!1;try{e.dragPan.enable()}catch(e){}try{t.style.cursor=""}catch(e){}window.removeEventListener("pointermove",s,{passive:!1}),window.removeEventListener("pointerup",c,{passive:!1}),window.removeEventListener("pointercancel",c,{passive:!1})}},s=t=>{if(!i)return;if(!t.metaKey)return l();const s=t.clientX-n,c=t.clientY-r;var d;e.setBearing(o+.35*s),e.setPitch((d=a-.25*c,Math.max(0,Math.min(85,d)))),t.preventDefault()},c=e=>{l();try{e.preventDefault()}catch(e){}},d=l=>{if(0===l.button&&l.ctrlKey&&!l.metaKey)return l.preventDefault(),void l.stopPropagation();if(!i&&0===l.button&&l.metaKey){i=!0,n=l.clientX,r=l.clientY,o=e.getBearing(),a=e.getPitch();try{e.dragPan.disable()}catch(e){}try{t.style.cursor="grabbing"}catch(e){}window.addEventListener("pointermove",s,{passive:!1}),window.addEventListener("pointerup",c,{passive:!1}),window.addEventListener("pointercancel",c,{passive:!1}),l.stopPropagation(),l.preventDefault()}};return t.addEventListener("pointerdown",d,{passive:!1,capture:!0}),()=>{try{l()}catch(e){}try{t.removeEventListener("pointerdown",d,{capture:!0})}catch(e){}}}(e);let d=null;return!1!==n.basemapSwitcher&&!1!==l&&(d=function(e,t){const i=t.basemaps||he;let n=(e=>{const t=i.find(t=>e.includes(t.id));return t?.id||i[0]?.id||"dark"})(t.currentStyle),r=!1;const o=document.createElement("div");o.className="fm-basemap-switcher";const a=document.createElement("button");a.type="button",a.className="fm-basemap-trigger",a.title="Change basemap",a.setAttribute("aria-label","Change basemap"),a.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/></svg>';const l=document.createElement("div");l.className="fm-basemap-options";const s=new Map;i.forEach(i=>{const a=document.createElement("button");a.type="button",a.title=i.label,a.setAttribute("data-basemap",i.id),a.className="fm-basemap-option"+(i.id===n?" is-active":"");const c=document.createElement("div");c.className="fm-basemap-option-thumb",c.style.background=i.thumbnail;const d=document.createElement("div");d.className="fm-basemap-option-label",d.textContent=i.label,a.appendChild(c),a.appendChild(d),a.addEventListener("click",a=>{a.preventDefault(),a.stopPropagation(),s.forEach((e,t)=>{try{e.classList.toggle("is-active",t===i.id)}catch(e){}}),n=i.id,r=!1;try{o.classList.remove("is-open")}catch(e){}try{e.setStyle(i.style)}catch(e){console.error("[BasemapSwitcher] Failed to set style:",e)}if(t.onStyleChange)try{t.onStyleChange(i)}catch(e){}}),a.addEventListener("mouseenter",()=>{if(i.id!==n)try{a.classList.add("is-hover")}catch(e){}}),a.addEventListener("mouseleave",()=>{if(i.id!==n)try{a.classList.remove("is-hover")}catch(e){}}),s.set(i.id,a),l.appendChild(a)});const c=()=>{r=!1;try{o.classList.remove("is-open")}catch(e){}};a.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),r?c():(()=>{r=!0;try{o.classList.add("is-open")}catch(e){}})()});const d=e=>{r&&!o.contains(e.target)&&c()},u=e=>{r&&"Escape"===e.key&&(e.preventDefault(),c())};document.addEventListener("click",d),document.addEventListener("keydown",u),o.appendChild(a),o.appendChild(l);try{const i=t.position||"bottom-left",n=e.getContainer().querySelector(`.mapboxgl-ctrl-${i}`);n&&n.insertBefore(o,n.firstChild)}catch(e){}return{destroy:()=>{try{document.removeEventListener("click",d),document.removeEventListener("keydown",u),o.remove()}catch(e){}},setActive:e=>{s.get(e)&&(s.forEach((t,i)=>{try{t.classList.toggle("is-active",i===e)}catch(e){}}),n=e)}}}(e,{currentStyle:n.currentStyle||"",onStyleChange:n.onStyleChange,position:l})),{destroy:()=>{try{c()}catch(e){}try{d?.destroy()}catch(e){}},setHomeViewState:s?.setHomeViewState}}function xe(e){if(!e||"object"!=typeof e)return e;if(Array.isArray(e))return e;const t=e["@@function"];if("colorContinuous"===t){const t={type:"continuous",attr:e.attr,palette:e.colors};return e.domain&&(t.domain=e.domain),"number"==typeof e.steps&&(t.steps=e.steps),e.nullColor&&(t.nullColor=e.nullColor),e.reverse&&(t.reverse=e.reverse),t}if("colorCategories"===t){const t={type:"categorical",attr:e.attr};return e.colors&&(t.palette=e.colors),e.categories&&(t.categories=e.categories),e.labelAttr&&(t.labelAttr=e.labelAttr),e.nullColor&&(t.nullColor=e.nullColor),t}return e}function Ce(e){if(!e||"object"!=typeof e)return{};const t={};return void 0!==e.getFillColor&&(t.fillColor=xe(e.getFillColor)),void 0!==e.getLineColor&&(t.lineColor=xe(e.getLineColor)),"number"==typeof e.opacity&&(t.opacity=e.opacity),"boolean"==typeof e.filled&&(t.filled=e.filled),"boolean"==typeof e.stroked&&(t.stroked=e.stroked),"boolean"==typeof e.extruded&&(t.extruded=e.extruded),e.elevationProperty&&(t.elevationAttr=e.elevationProperty),"number"==typeof e.elevationScale&&(t.elevationScale=e.elevationScale),"number"==typeof e.lineWidthMinPixels?t.lineWidth=e.lineWidthMinPixels:"number"==typeof e.getLineWidth&&(t.lineWidth=e.getLineWidth),"number"==typeof e.pointRadiusMinPixels?t.pointRadius=e.pointRadiusMinPixels:"number"==typeof e.pointRadius&&(t.pointRadius=e.pointRadius),t}function we(e,t=0){const i=e=>"  ".repeat(e),n=t+1;if(null==e)return"None";const r=typeof e;if("boolean"===r)return e?"True":"False";if("number"===r)return Number.isFinite(e)?String(e):"None";if("string"===r){if(e.startsWith("@@py:")){const t=e.slice(5).trim();if(/^[A-Za-z_][A-Za-z0-9_\\.]*$/.test(t))return t}return JSON.stringify(e)}if(Array.isArray(e))return e.length?`[\n${e.map(e=>`${i(n)}${we(e,n)}`).join(",\n")}\n${i(t)}]`:"[]";if(function(e){return!!e&&"object"==typeof e&&!Array.isArray(e)}(e)){const r=Object.keys(e);return r.length?`{\n${r.map(t=>`${i(n)}${JSON.stringify(t)}: ${we(e[t],n)}`).join(",\n")}\n${i(t)}}`:"{}"}try{return JSON.stringify(String(e))}catch{return"None"}}function Le(e,t){try{e.innerHTML=t.map(e=>`<option value="${e}">${e}</option>`).join("")}catch(e){}}function Ee(e,t,i){const n=function(e,t){try{const i=window.cartocolor?.[e];if(!i)return null;const n=Object.keys(i).map(e=>Number(e)).filter(e=>Number.isFinite(e)).sort((e,t)=>e-t),r=i[n.find(e=>e>=t)??n[n.length-1]];return Array.isArray(r)?[...r]:null}catch(e){return null}}(e,Math.max(t,3)),r=i&&n?.length?[...n].reverse():n;return r?.length?`linear-gradient(90deg, ${r.map((e,t)=>`${e} ${t/Math.max(1,r.length-1)*100}%`).join(", ")})`:"linear-gradient(90deg, #555, #999)"}function Se(e){const t=!!e.getReverse(),i=Math.max(2,Math.min(20,e.getSteps()));e.menuEl.innerHTML=e.palettes.map(e=>`<div class="pal-item" data-pal="${e}" title="${e}">\n        <div class="pal-item-swatch" style="background:${Ee(e,i,t)};"></div>\n      </div>`).join(""),e.menuEl.querySelectorAll(".pal-item").forEach(t=>{t.addEventListener("click",i=>{try{i.preventDefault(),i.stopPropagation()}catch(e){}const n=t.getAttribute("data-pal")||"";n&&(e.selectEl.value=n),e.menuEl.style.display="none",Ae(e);try{e.onPicked()}catch(e){}})})}function Ae(e){try{const t=!!e.getReverse(),i=Math.max(2,Math.min(20,e.getSteps())),n=e.selectEl.value||"Palette";e.swatchEl.style.background=Ee(n,i,t),e.triggerEl.title=n}catch(e){}}const ke="debug-shell",Fe={layerSelect:"dbg-layer-select",hexSection:"dbg-hex-section",viewStateSection:"dbg-viewstate-section",fillColorSection:"fill-color-section",lineColorSection:"line-color-section",filledEl:"dbg-filled",strokedEl:"dbg-stroked",extrudedEl:"dbg-extruded",extrusionControls:"dbg-extrusion-controls",elevAttrEl:"dbg-elev-attr",elevScaleEl:"dbg-elev-scale",opacitySliderEl:"dbg-opacity-slider",opacityEl:"dbg-opacity",fillFnEl:"dbg-fill-fn",fillFnOptions:"fill-fn-options",fillStaticOptions:"fill-static-options",fillExpressionInfo:"fill-expression-info",fillExpressionLabel:"fill-expression-label",fillAttrEl:"dbg-attr",fillPaletteEl:"dbg-palette",fillPalTrigger:"dbg-palette-trigger",fillPalSwatch:"dbg-palette-swatch",fillPalMenu:"dbg-palette-menu",fillDomainMinEl:"dbg-domain-min",fillDomainMaxEl:"dbg-domain-max",fillRangeMinEl:"dbg-domain-range-min",fillRangeMaxEl:"dbg-domain-range-max",fillStepsEl:"dbg-steps",fillReverseEl:"dbg-fill-reverse",fillNullEl:"dbg-null-color",fillNullLabel:"dbg-null-color-label",fillStaticEl:"dbg-fill-static",fillStaticLabel:"dbg-fill-static-label",lineFnEl:"dbg-line-fn",lineFnOptions:"line-fn-options",lineStaticOptions:"line-static-options",lineExpressionInfo:"line-expression-info",lineExpressionLabel:"line-expression-label",lineAttrEl:"dbg-line-attr",linePaletteEl:"dbg-line-palette",linePalTrigger:"dbg-line-palette-trigger",linePalSwatch:"dbg-line-palette-swatch",linePalMenu:"dbg-line-palette-menu",lineDomainMinEl:"dbg-line-domain-min",lineDomainMaxEl:"dbg-line-domain-max",lineReverseEl:"dbg-line-reverse",lineStaticEl:"dbg-line-static",lineStaticLabel:"dbg-line-static-label",lineWidthSliderEl:"dbg-line-width-slider",lineWidthEl:"dbg-line-width",lngEl:"dbg-lng",latEl:"dbg-lat",zoomEl:"dbg-zoom",pitchEl:"dbg-pitch",bearingEl:"dbg-bearing",viewOut:"dbg-view-output",layerOut:"dbg-output",sqlSection:"sql-section",sqlStatusEl:"sql-status",sqlInputEl:"dbg-sql",aiPromptRow:"ai-prompt-row",aiPromptInput:"ai-prompt-input",aiPromptBtn:"ai-prompt-btn",aiPromptStatus:"ai-prompt-status"};function Te(e,t,i){return Math.max(t,Math.min(i,e))}function $e(e,t){try{const i=String(e||"").trim();if(!/^#[0-9a-fA-F]{6}$/.test(i))return null;const n=parseInt(i.slice(1,3),16),r=parseInt(i.slice(3,5),16),o=parseInt(i.slice(5,7),16);return"number"==typeof t&&Number.isFinite(t)?[n,r,o,Te(Math.round(t),0,255)]:[n,r,o]}catch{return null}}function Me(e){return!Array.isArray(e)||e.length<3?"#888888":"#"+e.slice(0,3).map(e=>Te(Math.round(e),0,255).toString(16).padStart(2,"0")).join("")}function Ne(e,t){try{return Number.isFinite(e)?e.toFixed(t):""}catch{return""}}function Pe(e,t,i,n){try{e.getLayer(t)&&e.setPaintProperty(t,i,n)}catch{}}function je(e,t,i){try{const n=e.getStyle?.()?.layers||[];for(const r of n){const n=r?.id;if(n&&n.startsWith(t)&&e.getLayer(n))for(const[t,r]of Object.entries(i))try{e.setPaintProperty(n,t,r)}catch{}}}catch{}}function Oe(e){try{if(!e)return!1;const t="hex"===e.layerType,i=!!e.isTileLayer,n=!!e.parquetData||!!e.parquetUrl;return t&&!i&&n}catch(e){return!1}}function qe(e,t,i){try{const n=t.getBoundingClientRect().width||280;e.style.setProperty("--debug-panel-w",`${n}px`),i.style.left=t.classList.contains("collapsed")?"0px":`var(--debug-panel-w, ${n}px)`}catch{}}function Ie(e){return e&&"object"==typeof e?"colorContinuous"!==e["@@function"]?null:e:null}function Re(e){return"string"==typeof e&&e.startsWith("@@=")}function De(e){if(e.includes("properties.r")&&e.includes("properties.g")&&e.includes("properties.b"))return"RGB from properties";const t=e.slice(3);return t.length>30?t.slice(0,27)+"...":t}function _e(e){const t=new Set;try{const i=e.hexLayer?.getFillColor,n=e.hexLayer?.getLineColor;i?.attr&&t.add(String(i.attr)),n?.attr&&t.add(String(n.attr));const r=e.tooltipColumns||e.hexLayer?.tooltipColumns,o=e.tooltipAttrs||e.hexLayer?.tooltipAttrs;Array.isArray(r)&&r.forEach(e=>{e&&"hex"!==e&&t.add(String(e))}),Array.isArray(o)&&o.forEach(e=>{e&&"hex"!==e&&t.add(String(e))})}catch(e){}return[...t].filter(Boolean)}function Be(e){try{const t=e.geojson?.features?.[0],i=t?.properties||{};return Object.keys(i||{}).filter(e=>e&&"_fused_idx"!==e)}catch(e){return[]}}function ze(e,i){const n=i.sidebar||(i.debug?"show":null),{shell:r,panel:o,toggle:a,resizeHandle:s}=function(){let e=document.getElementById(ke);e||(e=document.createElement("div"),e.id=ke,e.innerHTML='\n      <div id="debug-panel">\n        <div id="debug-content">\n          <div class="debug-tabs" role="tablist" aria-label="Debug tabs">\n            <button type="button" class="debug-tab-btn active" id="dbg-tab-btn-ui" data-tab="ui" role="tab" aria-selected="true">UI</button>\n            <button type="button" class="debug-tab-btn" id="dbg-tab-btn-sql" data-tab="sql" role="tab" aria-selected="false">SQL</button>\n          </div>\n\n          <div class="debug-tab-panel" id="dbg-tab-panel-ui" role="tabpanel" aria-label="UI tab">\n          <div class="debug-section">\n            <div class="debug-section-title">Editing Layer</div>\n            <div class="debug-row">\n              <span class="debug-label">Layer</span>\n              <select class="debug-select" id="dbg-layer-select"></select>\n            </div>\n          </div>\n\n          <div class="debug-section" id="dbg-hex-section">\n            <div class="debug-section-title">Hex Layer</div>\n            <div class="debug-toggles">\n              <label class="debug-checkbox"><input type="checkbox" id="dbg-filled" checked /> Filled</label>\n              <label class="debug-checkbox"><input type="checkbox" id="dbg-stroked" checked /> Stroked</label>\n              <label class="debug-checkbox"><input type="checkbox" id="dbg-extruded" /> Extruded</label>\n            </div>\n            <div id="dbg-extrusion-controls" style="display:none;margin-top:8px;">\n              <div class="debug-row">\n                <span class="debug-label">Height attr</span>\n                <select class="debug-select" id="dbg-elev-attr"></select>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label">Height scale</span>\n                <input type="number" class="debug-input debug-input-sm" id="dbg-elev-scale" step="0.1" value="1" />\n              </div>\n            </div>\n            <div class="debug-row" style="margin-top:8px;">\n              <span class="debug-label">Opacity</span>\n              <input type="range" class="debug-slider" id="dbg-opacity-slider" min="0" max="1" step="0.05" value="1" />\n              <input type="number" class="debug-input debug-input-sm" id="dbg-opacity" step="0.1" min="0" max="1" value="1" />\n            </div>\n          </div>\n\n          <div class="debug-section" id="fill-color-section">\n            <div class="debug-section-title">Fill Color</div>\n            <div class="debug-row">\n              <span class="debug-label">Function</span>\n              <select class="debug-select" id="dbg-fill-fn">\n                <option value="colorContinuous">colorContinuous</option>\n                <option value="static">Static Color</option>\n                <option value="expression">Expression</option>\n              </select>\n            </div>\n            <div id="fill-expression-info" style="display:none;">\n              <div class="debug-row">\n                <span class="debug-label"></span>\n                <span id="fill-expression-label" style="color:var(--ui-muted-2);font-size:11px;font-style:italic;">RGB from properties</span>\n              </div>\n            </div>\n            <div id="fill-fn-options">\n              <div class="debug-row">\n                <span class="debug-label">Attribute</span>\n                <select class="debug-select" id="dbg-attr"></select>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label">Palette</span>\n                <select class="debug-select pal-hidden" id="dbg-palette"></select>\n                <div class="pal-dd" id="dbg-palette-dd">\n                  <button type="button" class="pal-trigger" id="dbg-palette-trigger" title="Palette">\n                    <span class="pal-name" id="dbg-palette-name">Palette</span>\n                    <span class="pal-swatch" id="dbg-palette-swatch"></span>\n                  </button>\n                  <div class="pal-menu" id="dbg-palette-menu" style="display:none;"></div>\n                </div>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label"></span>\n                <label class="debug-checkbox" style="margin-left:auto;"><input type="checkbox" id="dbg-fill-reverse" /> Reverse</label>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label">Domain</span>\n                <input type="number" class="debug-input debug-input-sm" id="dbg-domain-min" step="0.1" placeholder="min" />\n                <span style="color:#666;">–</span>\n                <input type="number" class="debug-input debug-input-sm" id="dbg-domain-max" step="0.1" placeholder="max" />\n              </div>\n            <div class="debug-row">\n              <span class="debug-label"></span>\n              <div class="debug-dual-range" aria-label="Domain range">\n                <input type="range" class="debug-range-min" id="dbg-domain-range-min" min="0" max="100" step="0.1" value="0" />\n                <input type="range" class="debug-range-max" id="dbg-domain-range-max" min="0" max="100" step="0.1" value="100" />\n              </div>\n            </div>\n              <div class="debug-row">\n                <span class="debug-label">Steps</span>\n                <input type="number" class="debug-input debug-input-sm" id="dbg-steps" step="1" min="2" max="20" value="7" />\n              </div>\n              <div class="debug-row">\n                <span class="debug-label">Null Color</span>\n                <input type="color" class="debug-color" id="dbg-null-color" value="#b8b8b8" />\n                <span class="debug-color-label" id="dbg-null-color-label">#b8b8b8</span>\n              </div>\n            </div>\n            <div id="fill-static-options" style="display:none;">\n              <div class="debug-row">\n                <span class="debug-label">Color</span>\n                <input type="color" class="debug-color" id="dbg-fill-static" value="#0090ff" />\n                <span class="debug-color-label" id="dbg-fill-static-label">#0090ff</span>\n              </div>\n            </div>\n          </div>\n\n          <div class="debug-section" id="line-color-section">\n            <div class="debug-section-title">Line Color</div>\n            <div class="debug-row">\n              <span class="debug-label">Function</span>\n              <select class="debug-select" id="dbg-line-fn">\n                <option value="colorContinuous">colorContinuous</option>\n                <option value="static" selected>Static Color</option>\n                <option value="expression">Expression</option>\n              </select>\n            </div>\n            <div id="line-expression-info" style="display:none;">\n              <div class="debug-row">\n                <span class="debug-label"></span>\n                <span id="line-expression-label" style="color:var(--ui-muted-2);font-size:11px;font-style:italic;">RGB from properties</span>\n              </div>\n            </div>\n            <div id="line-fn-options" style="display:none;">\n              <div class="debug-row">\n                <span class="debug-label">Attribute</span>\n                <select class="debug-select" id="dbg-line-attr"></select>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label">Palette</span>\n                <select class="debug-select pal-hidden" id="dbg-line-palette"></select>\n                <div class="pal-dd" id="dbg-line-palette-dd">\n                  <button type="button" class="pal-trigger" id="dbg-line-palette-trigger" title="Palette">\n                    <span class="pal-name" id="dbg-line-palette-name">Palette</span>\n                    <span class="pal-swatch" id="dbg-line-palette-swatch"></span>\n                  </button>\n                  <div class="pal-menu" id="dbg-line-palette-menu" style="display:none;"></div>\n                </div>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label"></span>\n                <label class="debug-checkbox" style="margin-left:auto;"><input type="checkbox" id="dbg-line-reverse" /> Reverse</label>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label">Domain</span>\n                <input type="number" class="debug-input debug-input-sm" id="dbg-line-domain-min" step="0.1" placeholder="min" />\n                <span style="color:#666;">–</span>\n                <input type="number" class="debug-input debug-input-sm" id="dbg-line-domain-max" step="0.1" placeholder="max" />\n              </div>\n            </div>\n            <div id="line-static-options">\n              <div class="debug-row">\n                <span class="debug-label">Color</span>\n                <input type="color" class="debug-color" id="dbg-line-static" value="#ffffff" />\n                <span class="debug-color-label" id="dbg-line-static-label">#ffffff</span>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label">Line Width</span>\n                <input type="range" class="debug-slider" id="dbg-line-width-slider" min="0" max="5" step="0.5" value="1" />\n                <input type="number" class="debug-input debug-input-sm" id="dbg-line-width" step="0.5" min="0" max="10" value="1" />\n              </div>\n            </div>\n          </div>\n\n          <div class="debug-section" id="dbg-viewstate-section">\n            <div class="debug-section-title">View State</div>\n            <div class="debug-row">\n              <span class="debug-label">Longitude</span>\n              <input type="number" class="debug-input" id="dbg-lng" step="0.0001" />\n            </div>\n            <div class="debug-row">\n              <span class="debug-label">Latitude</span>\n              <input type="number" class="debug-input" id="dbg-lat" step="0.0001" />\n            </div>\n            <div class="debug-row">\n              <span class="debug-label">Zoom</span>\n              <input type="number" class="debug-input" id="dbg-zoom" step="0.1" min="0" max="22" />\n            </div>\n            <div class="debug-row">\n              <span class="debug-label">Pitch</span>\n              <input type="number" class="debug-input" id="dbg-pitch" step="1" min="0" max="85" />\n            </div>\n            <div class="debug-row">\n              <span class="debug-label">Bearing</span>\n              <input type="number" class="debug-input" id="dbg-bearing" step="1" />\n            </div>\n          </div>\n\n          <div class="debug-section">\n            <details id="dbg-view-details">\n              <summary class="debug-section-title" style="cursor:pointer; user-select:none;">Current ViewState</summary>\n              <textarea id="dbg-view-output" class="debug-output" readonly></textarea>\n            </details>\n          </div>\n\n          <div class="debug-section">\n            <div class="debug-section-title">Layer Config</div>\n            <textarea id="dbg-output" class="debug-output" readonly></textarea>\n          </div>\n          </div>\n\n          <div class="debug-tab-panel" id="dbg-tab-panel-sql" role="tabpanel" aria-label="SQL tab" style="display:none;">\n            <div class="debug-section" id="sql-section">\n              <div class="debug-section-title">SQL <span id="sql-status" style="float:right;font-weight:normal;color:var(--ui-muted-2);"></span></div>\n              <textarea id="dbg-sql" class="debug-output" style="height:120px;font-family:monospace;font-size:11px;resize:vertical;" placeholder="WHERE expression (e.g. data = 111)\n—or—\nFull SQL (SELECT ... FROM data ...)"></textarea>\n              <div id="ai-prompt-row" class="ai-prompt-row" style="display:none;">\n                <input type="text" id="ai-prompt-input" class="debug-input" placeholder="Ask AI: &quot;filter to corn areas over 50%&quot;" />\n                <button type="button" id="ai-prompt-btn" class="ai-prompt-btn" title="Generate SQL">AI</button>\n                <span id="ai-prompt-status" class="ai-prompt-status"></span>\n              </div>\n            </div>\n          </div>\n        </div>\n        <div id="debug-resize-handle" title="Drag to resize"></div>\n      </div>\n      <div id="debug-toggle" title="Toggle sidebar">&#x2039;</div>\n  ',document.body.appendChild(e));const t=document.getElementById("debug-panel"),i=document.getElementById("debug-toggle"),n=document.getElementById("debug-resize-handle");if(!t||!i||!n)throw new Error("[FusedMaps] Debug panel DOM missing expected elements");return{shell:e,panel:t,toggle:i,resizeHandle:n}}();try{"hide"===n?(o.classList.add("collapsed"),a.innerHTML="&#x203A;"):(o.classList.remove("collapsed"),a.innerHTML="&#x2039;"),qe(r,o,a)}catch(e){}const{layerSelect:u,hexSection:p,viewStateSection:y,fillColorSection:f,lineColorSection:g,filledEl:m,strokedEl:h,extrudedEl:b,extrusionControls:v,elevAttrEl:x,elevScaleEl:C,opacitySliderEl:w,opacityEl:L,fillFnEl:E,fillFnOptions:S,fillStaticOptions:A,fillExpressionInfo:k,fillExpressionLabel:F,fillAttrEl:T,fillPaletteEl:$,fillPalTrigger:M,fillPalSwatch:N,fillPalMenu:P,fillDomainMinEl:j,fillDomainMaxEl:O,fillRangeMinEl:q,fillRangeMaxEl:I,fillStepsEl:D,fillReverseEl:_,fillNullEl:z,fillNullLabel:U,fillStaticEl:W,fillStaticLabel:H,lineFnEl:G,lineFnOptions:V,lineStaticOptions:Z,lineExpressionInfo:J,lineExpressionLabel:Y,lineAttrEl:X,linePaletteEl:Q,linePalTrigger:K,linePalSwatch:ee,linePalMenu:te,lineDomainMinEl:ie,lineDomainMaxEl:ne,lineReverseEl:re,lineStaticEl:oe,lineStaticLabel:ae,lineWidthSliderEl:le,lineWidthEl:se,lngEl:ce,latEl:de,zoomEl:ue,pitchEl:pe,bearingEl:ye,viewOut:fe,layerOut:ge,sqlSection:me,sqlStatusEl:he,sqlInputEl:be,aiPromptRow:ve,aiPromptInput:xe,aiPromptBtn:Ee,aiPromptStatus:ze}=function(){const e={};for(const[t,i]of Object.entries(Fe)){const n=document.getElementById(i);if(!n)throw new Error(`[FusedMaps] Debug panel missing element #${i}`);e[t]=n}return e}(),Ue=document.getElementById("dbg-tab-btn-ui"),We=document.getElementById("dbg-tab-btn-sql"),He=document.getElementById("dbg-tab-panel-ui"),Ge=document.getElementById("dbg-tab-panel-sql");let Ve=null;const Ze=(e,t=!0)=>{try{if(He&&(He.style.display="ui"===e?"block":"none"),Ge&&(Ge.style.display="sql"===e?"block":"none"),Ue&&(Ue.classList.toggle("active","ui"===e),Ue.setAttribute("aria-selected","ui"===e?"true":"false")),We&&(We.classList.toggle("active","sql"===e),We.setAttribute("aria-selected","sql"===e?"true":"false")),t)try{localStorage.setItem("fusedmaps:debug:tab",e)}catch(e){}}catch(e){}try{"sql"===e&&Ve?.onTabActivated()}catch(e){}},Je=e=>{const t=e?.currentTarget,i=String(t?.getAttribute?.("data-tab")||"").toLowerCase();"ui"!==i&&"sql"!==i||Ze(i,!0)};try{Ue?.addEventListener("click",Je),We?.addEventListener("click",Je)}catch(e){}try{const e=String(localStorage.getItem("fusedmaps:debug:tab")||"").toLowerCase();Ze("sql"===e?"sql":"ui",!1)}catch(e){Ze("ui",!1)}const Ye=function(){try{return Object.keys(window.cartocolor||{}).sort((e,t)=>e.localeCompare(t))}catch(e){return[]}}();Le($,Ye),Le(Q,Ye);const Xe=()=>{const e=parseInt(D?.value||"7",10);return Number.isFinite(e)?Math.max(2,Math.min(20,e)):7},Qe=function(e){const t=[],i=[],n=()=>{try{t.forEach(e=>{try{e.style.display="none"}catch(e){}})}catch(e){}},r=()=>n();try{document.addEventListener("click",r),window.addEventListener("blur",r)}catch(e){}return{attach:r=>{const o={...r,palettes:e,closeAll:n};t.push(o.menuEl);try{Se(o),Ae(o)}catch(e){}const a=e=>{try{e.preventDefault(),e.stopPropagation()}catch(e){}const t="none"!==o.menuEl.style.display;o.closeAll();try{Se(o),Ae(o)}catch(e){}o.menuEl.style.display=t?"none":"block"};try{o.triggerEl.addEventListener("click",a)}catch(e){}const l={refresh:()=>{try{Se(o),Ae(o)}catch(e){}},destroy:()=>{try{o.triggerEl.removeEventListener("click",a)}catch(e){}try{const e=t.indexOf(o.menuEl);e>=0&&t.splice(e,1)}catch(e){}}};return i.push(l),l},refreshAll:()=>{try{i.forEach(e=>e.refresh())}catch(e){}},destroy:()=>{try{i.forEach(e=>e.destroy())}catch(e){}try{document.removeEventListener("click",r),window.removeEventListener("blur",r)}catch(e){}}}}(Ye),Ke=Qe.attach({selectEl:$,menuEl:P,swatchEl:N,triggerEl:M,getSteps:Xe,getReverse:()=>!!_.checked,onPicked:()=>yt()}),et=Qe.attach({selectEl:Q,menuEl:te,swatchEl:ee,triggerEl:K,getSteps:Xe,getReverse:()=>!!re.checked,onPicked:()=>yt()}),tt=i.layers.filter(e=>"hex"===e.layerType||"vector"===e.layerType||"pmtiles"===e.layerType);u.innerHTML=tt.map(e=>`<option value="${e.id}">${e.name||e.id}</option>`).join(""),!u.value&&tt.length&&(u.value=tt[0].id);const it=()=>{const e=u.value;return tt.find(t=>t.id===e)||null},nt=()=>{try{const e=i.__deckOverlay||null,t=e?.__fused_hex_tiles__;t?.rebuild?.()}catch(e){}try{window.dispatchEvent(new CustomEvent("fusedmaps:legend:update"))}catch(e){}},rt=()=>{try{const t=(e._controls||[]).find(e=>e&&e.__fused_hex_tiles__);i.__deckOverlay=t||i.__deckOverlay}catch(e){}};rt();const ot=()=>{try{const e=2e5,t=e=>{const t={name:e.name};if(!1===e.visible&&(t.visible=!1),"hex"===e.layerType){const i=Ce(e.hexLayer||{}),n={};if(Object.keys(i).length&&(n.style=i),e.isTileLayer&&e.tileUrl){t.type="hex",t.tile_url=e.tileUrl;const i=e.tileLayerConfig||e.tileLayer||null;if(i&&"object"==typeof i){const e={};"number"==typeof i.minZoom&&(e.minZoom=i.minZoom),"number"==typeof i.maxZoom&&(e.maxZoom=i.maxZoom),"number"==typeof i.zoomOffset&&(e.zoomOffset=i.zoomOffset),Object.keys(e).length&&(n.tile=e)}}else t.type="hex",e.parquetUrl&&(t.parquetUrl=e.parquetUrl),e.sql&&(t.sql=e.sql),e.parquetUrl||(t.data=e.dataRef?`@@py:${String(e.dataRef)}`:null);return Object.keys(n).length&&(t.config=n),t}if("vector"===e.layerType){t.type="vector",t.data=e.dataRef?`@@py:${String(e.dataRef)}`:null;const i=Ce(e.vectorLayer||{});return Object.keys(i).length&&(t.config={style:i}),t}if("mvt"===e.layerType){t.type="vector",t.tile_url=e.tileUrl,t.source_layer=e.sourceLayer||"udf";const i={};return e.fillColorConfig?i.fillColor=Ce({getFillColor:e.fillColorConfig}).fillColor:e.fillColor&&(i.fillColor=e.fillColor),e.lineColorConfig?i.lineColor=Ce({getLineColor:e.lineColorConfig}).lineColor:e.lineColor&&(i.lineColor=e.lineColor),"number"==typeof e.lineWidth&&(i.lineWidth=e.lineWidth),"number"==typeof e.fillOpacity&&(i.opacity=e.fillOpacity),Object.keys(i).length&&(t.config={style:i}),t}if("pmtiles"===e.layerType){t.type="pmtiles",e.pmtilesPath?t.pmtiles_path=e.pmtilesPath:t.pmtiles_url=e.pmtilesUrl,e.sourceLayer&&(t.source_layer=e.sourceLayer),"number"==typeof e.minzoom&&(t.minzoom=e.minzoom),"number"==typeof e.maxzoom&&(t.maxzoom=e.maxzoom);const i={...e.vectorLayer||{}};e.fillColorConfig&&(i.getFillColor=e.fillColorConfig),e.lineColorConfig&&(i.getLineColor=e.lineColorConfig),"number"==typeof e.fillOpacity&&(i.opacity=e.fillOpacity),"number"==typeof e.lineWidth&&(i.lineWidthMinPixels=e.lineWidth),"number"==typeof e.pointRadiusMinPixels&&(i.pointRadiusMinPixels=e.pointRadiusMinPixels),"boolean"==typeof e.isFilled&&(i.filled=e.isFilled),"boolean"==typeof e.isStroked&&(i.stroked=e.isStroked);const n=Ce(i);return Object.keys(n).length&&(t.config={style:n}),t}if("raster"===e.layerType){t.type="raster",e.tileUrl&&(t.tile_url=e.tileUrl),e.imageUrl&&(t.image_url=e.imageUrl),e.imageBounds&&(t.bounds=e.imageBounds);const i=e.opacity??e.rasterLayer?.opacity;return"number"==typeof i&&Number.isFinite(i)&&1!==i&&(t.config={style:{opacity:i}}),t}return t};let n=`layers = ${we((i.layers||[]).map(t),0)}`;n.length>e&&(n=n.slice(0,e)+"\n... (truncated)\n"),ge.value=n}catch(e){ge.value=""}};Ve=function(e){const{sqlSection:t,sqlStatusEl:i,sqlInputEl:n,getActiveLayer:r,updateLayerOutput:o}=e;try{t.style.display="block"}catch(e){}let a=null,l=null,s=!1,c=!1,d=!1;const u=()=>{if(d)return;const e=r();if(!Oe(e))return;const t=(()=>{try{if(l)return String(l.getValue()||"").trim()}catch(e){}return String(n.value||"").trim()})()||"SELECT * FROM data";try{e.sql=t}catch(e){}try{o()}catch(e){}try{i.textContent="typing..."}catch(e){}clearTimeout(a),a=setTimeout(()=>{try{window.dispatchEvent(new CustomEvent("fusedmaps:sql:update",{detail:{layerId:e.id,sql:t}}))}catch(e){}},500)},p=()=>{try{if(!l||c)return;c=!0,l.on("change",()=>u())}catch(e){}},y=()=>u();try{n.addEventListener("input",y)}catch(e){}const f=e=>{try{const t=e?.detail||{},n=String(t.layerId||""),o=String(t.status||""),a=r();if(!a||String(a.id)!==n)return;i.textContent=o}catch(e){}};try{window.addEventListener("fusedmaps:sql:status",f)}catch(e){}return{onTabActivated:()=>{(async()=>{try{if(l||s)return;if(s=!0,window.CodeMirror){try{const e=window.CodeMirror;l=e.fromTextArea(n,{mode:"text/x-sql",theme:"material-darker",lineNumbers:!1,gutters:[],lineWrapping:!0,indentUnit:2,tabSize:2,indentWithTabs:!1}),l.setSize("100%","180px")}catch(e){}return void p()}const e=e=>{if(document.querySelector(`link[href="${e}"]`))return;const t=document.createElement("link");t.rel="stylesheet",t.href=e,document.head.appendChild(t)};e("https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css"),e("https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-darker.min.css");const t=e=>new Promise((t,i)=>{if(document.querySelector(`script[src="${e}"]`))return t();const n=document.createElement("script");n.src=e,n.async=!0,n.onload=()=>t(),n.onerror=()=>i(new Error(`failed to load ${e}`)),document.head.appendChild(n)});await t("https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"),await t("https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/sql/sql.min.js");try{const e=window.CodeMirror;if(!e)return;l=e.fromTextArea(n,{mode:"text/x-sql",theme:"material-darker",lineNumbers:!1,gutters:[],lineWrapping:!0,indentUnit:2,tabSize:2,indentWithTabs:!1}),l.setSize("100%","180px")}catch(e){}p()}finally{s=!1}})().then(()=>{try{l?.refresh?.()}catch(e){}})},syncFromLayer:e=>{const t=Oe(e);d=!0;try{n.disabled=!t,t?(n.value=String(e.sql||"SELECT * FROM data"),n.placeholder="SELECT * FROM data"):(n.value="",n.placeholder="Select a DuckDB (parquetUrl/parquetData) hex layer to enable SQL.")}catch(e){}try{if(l){t?(l.setValue(String(e.sql||"SELECT * FROM data")),l.setOption("readOnly",!1)):(l.setValue("-- Select a DuckDB-backed hex layer to enable SQL"),l.setOption("readOnly","nocursor"));try{l.refresh?.()}catch(e){}}}catch(e){}d=!1;try{i.textContent=t?"":"disabled"}catch(e){}},applySql:e=>{const t=r();if(Oe(t)){d=!0;try{n.value=e,l&&l.setValue(e),t.sql=e,o()}catch(e){}d=!1;try{window.dispatchEvent(new CustomEvent("fusedmaps:sql:update",{detail:{layerId:t.id,sql:e}}))}catch(e){}}},destroy:()=>{try{clearTimeout(a)}catch(e){}try{n.removeEventListener("input",y)}catch(e){}try{window.removeEventListener("fusedmaps:sql:status",f)}catch(e){}try{l?.toTextArea?.()}catch(e){}l=null}}}({sqlSection:me,sqlStatusEl:he,sqlInputEl:be,getActiveLayer:()=>it(),updateLayerOutput:ot});const at=i.aiUdfUrl,lt=i.aiSchema,st=i.aiContext;if(at)try{ve.style.display="flex"}catch(e){}const ct=async()=>{if(!at)return;const e=xe.value.trim();if(e)try{Ee.disabled=!0,xe.disabled=!0,ze.textContent="thinking...",ze.style.color="var(--ui-muted-2)";let t=at+(at.includes("?")?"&":"?")+"prompt="+encodeURIComponent(e);lt&&(t+="&schema="+encodeURIComponent(lt)),st&&(t+="&context="+encodeURIComponent(st));const i=await fetch(t);if(!i.ok)throw new Error(`HTTP ${i.status}`);let n=await i.text();n=n.trim().replace(/^["']|["']$/g,"").replace(/```sql/gi,"").replace(/```/g,"").trim(),Ve?.applySql(n),ze.textContent="",xe.value=""}catch(e){ze.textContent=e?.message||"error",ze.style.color="#ff6b6b"}finally{Ee.disabled=!1,xe.disabled=!1}};try{xe.addEventListener("keypress",e=>{"Enter"===e.key&&ct()}),Ee.addEventListener("click",ct)}catch(e){}const dt=()=>{const e=E.value;S.style.display="colorContinuous"===e?"block":"none",A.style.display="static"===e?"block":"none",k.style.display="expression"===e?"block":"none",E.disabled="expression"===e},ut=()=>{const e=G.value;V.style.display="colorContinuous"===e?"block":"none",Z.style.display="static"===e?"block":"none",J.style.display="expression"===e?"block":"none",G.disabled="expression"===e},pt=()=>{const e=it();if(!e)return;const t="hex"===e.layerType,i="vector"===e.layerType,n="pmtiles"===e.layerType,r=t&&e.hexLayer||{};try{p&&(p.style.display=t?"block":"none")}catch(e){}try{f&&(f.style.display=t||i||n?"block":"none")}catch(e){}try{g&&(g.style.display=t||i||n?"block":"none")}catch(e){}try{y&&(y.style.display="block")}catch(e){}t?(m.checked=!1!==r.filled,h.checked=!1!==r.stroked,b.checked=!0===r.extruded):(m.checked=!1!==e.isFilled,h.checked=!1!==e.isStroked,b.checked=!1);try{if(v&&(v.style.display=t&&b.checked?"block":"none"),t&&x){const t=_e(e),i=[""].concat(t||[]);x.innerHTML=i.map(e=>e?`<option value="${e}">${e}</option>`:'<option value="">(use fill attr)</option>').join(""),x.value=String(r.elevationProperty||"")}t&&C&&(C.value=String("number"==typeof r.elevationScale&&Number.isFinite(r.elevationScale)?r.elevationScale:1))}catch(e){}const o=t?"number"==typeof r.opacity?r.opacity:1:"number"==typeof e.opacity?e.opacity:.9;if(w.value=String(o),L.value=String(o),t){const t=r.getFillColor;if(Re(t)){E.value="expression",E.disabled=!0,F.textContent=De(t);const i=_e(e);i.length&&(T.innerHTML=i.map(e=>`<option value="${e}">${e}</option>`).join(""))}else E.disabled=!1;const i=Ie(t);if(!Re(t)&&i){E.value="colorContinuous",T.innerHTML=_e(e).map(e=>`<option value="${e}">${e}</option>`).join(""),i.attr&&(T.value=String(i.attr)),i.colors&&($.value=String(i.colors));try{_.checked=!!i.reverse}catch(e){_.checked=!1}try{Ke.refresh()}catch(e){}const t=Array.isArray(i.domain)?i.domain:[0,1];j.value=Ne(Number(t[0]),2),O.value=Ne(Number(t[1]),2);try{const e=Math.min(Number(t[0]),Number(t[1])),i=Math.max(Number(t[0]),Number(t[1]));Number.isFinite(e)&&Number.isFinite(i)&&(q.min=String(e),q.max=String(i),I.min=String(e),I.max=String(i),q.step="0.1",I.step="0.1",q.value=String(Number(t[0])),I.value=String(Number(t[1])))}catch(e){}D.value=String(i.steps??7);const n=Me(Array.isArray(i.nullColor)?i.nullColor:[184,184,184]);z.value=n,U.textContent=n}else if(!Re(t)&&Array.isArray(t)){E.value="static";try{_.checked=!1}catch{}const i=Me(t);W.value=i,H.textContent=i;const n=_e(e);n.length&&(T.innerHTML=n.map(e=>`<option value="${e}">${e}</option>`).join(""))}else if(!Re(t)){E.value="colorContinuous";try{_.checked=!1}catch(e){}const t=_e(e);t.length&&(T.innerHTML=t.map(e=>`<option value="${e}">${e}</option>`).join(""))}}else if(i||n){const t=e,i=t.fillColorConfig,r=(()=>{if(!n)return Be(e);const r=new Set;return i?.attr&&r.add(String(i.attr)),t.lineColorConfig?.attr&&r.add(String(t.lineColorConfig.attr)),t.colorAttribute&&r.add(String(t.colorAttribute)),r.add("value"),[...r].filter(Boolean)})();if(T.innerHTML=r.map(e=>`<option value="${e}">${e}</option>`).join(""),i&&"object"==typeof i&&"colorContinuous"===i["@@function"]){E.value="colorContinuous",i.attr&&(T.value=String(i.attr)),i.colors&&($.value=String(i.colors));try{_.checked=!!i.reverse}catch(e){_.checked=!1}try{Ke.refresh()}catch(e){}const e=Array.isArray(i.domain)?i.domain:[0,1];j.value=Ne(Number(e[0]),2),O.value=Ne(Number(e[1]),2);try{const t=Math.min(Number(e[0]),Number(e[1])),i=Math.max(Number(e[0]),Number(e[1]));Number.isFinite(t)&&Number.isFinite(i)&&(q.min=String(t),q.max=String(i),I.min=String(t),I.max=String(i),q.step="0.1",I.step="0.1",q.value=String(Number(e[0])),I.value=String(Number(e[1])))}catch(e){}D.value=String(i.steps??7);const t=Me(Array.isArray(i.nullColor)?i.nullColor:[184,184,184]);z.value=t,U.textContent=t}else{E.value="static";try{_.checked=!1}catch(e){}W.value="#0090ff",H.textContent=W.value}}if(t){const t=r.getLineColor;if(Re(t)){G.value="expression",G.disabled=!0,Y.textContent=De(t);const i=_e(e);i.length&&(X.innerHTML=i.map(e=>`<option value="${e}">${e}</option>`).join(""))}else G.disabled=!1;const i=Ie(t);if(!Re(t)&&i){G.value="colorContinuous",X.innerHTML=_e(e).map(e=>`<option value="${e}">${e}</option>`).join(""),i.attr&&(X.value=String(i.attr)),i.colors&&(Q.value=String(i.colors));try{re.checked=!!i.reverse}catch(e){re.checked=!1}try{et.refresh()}catch(e){}const t=Array.isArray(i.domain)?i.domain:[0,1];ie.value=Ne(Number(t[0]),2),ne.value=Ne(Number(t[1]),2)}else if(!Re(t)&&Array.isArray(t)){G.value="static";try{re.checked=!1}catch{}const i=Me(t);oe.value=i,ae.textContent=i;const n=_e(e);n.length&&(X.innerHTML=n.map(e=>`<option value="${e}">${e}</option>`).join(""))}else if(!Re(t)){G.value="static";try{re.checked=!1}catch{}const t=_e(e);t.length&&(X.innerHTML=t.map(e=>`<option value="${e}">${e}</option>`).join(""))}}else if(i||n){const t=e,i=t.lineColorConfig,r=(()=>{if(!n)return Be(e);const r=new Set;return i?.attr&&r.add(String(i.attr)),t.fillColorConfig?.attr&&r.add(String(t.fillColorConfig.attr)),t.colorAttribute&&r.add(String(t.colorAttribute)),r.add("value"),[...r].filter(Boolean)})();if(X.innerHTML=r.map(e=>`<option value="${e}">${e}</option>`).join(""),i&&"object"==typeof i&&"colorContinuous"===i["@@function"]){G.value="colorContinuous",i.attr&&(X.value=String(i.attr)),i.colors&&(Q.value=String(i.colors));try{re.checked=!!i.reverse}catch(e){re.checked=!1}try{et.refresh()}catch(e){}const e=Array.isArray(i.domain)?i.domain:[0,1];ie.value=Ne(Number(e[0]),2),ne.value=Ne(Number(e[1]),2)}else{G.value="static";try{re.checked=!1}catch(e){}}}const a=t?r.lineWidthMinPixels??1:e.lineWidth??1;le.value=String(a),se.value=String(a),dt(),ut(),ot();try{Ve?.syncFromLayer(e)}catch(e){}},yt=()=>{const t=it();t&&function(e){const{map:t,layer:i,els:n,updateLayerOutput:r,findDeckOverlayOnMap:o,rebuildDeck:a}=e;if(!i)return;const s="hex"===i.layerType,u="vector"===i.layerType,p="pmtiles"===i.layerType;s&&(i.hexLayer=i.hexLayer||{});const y=s?i.hexLayer:{},f=parseFloat(n.opacityEl.value),g=Number.isFinite(f)?Te(f,0,1):1;if(s){y.filled=!!n.filledEl.checked,y.stroked=!!n.strokedEl.checked,y.extruded=!!n.extrudedEl.checked,y.opacity=g;try{n.extrusionControls&&(n.extrusionControls.style.display=y.extruded?"block":"none");const e=parseFloat(n.elevScaleEl?.value||"1");y.elevationScale=Number.isFinite(e)?e:1;const t=String(n.elevAttrEl?.value||"").trim();t?y.elevationProperty=t:delete y.elevationProperty}catch(e){}}else if(u||p){i.isFilled=!!n.filledEl.checked,i.isStroked=!!n.strokedEl.checked,i.opacity=g;try{i.vectorLayer={...i.vectorLayer||{},filled:!!n.filledEl.checked,stroked:!!n.strokedEl.checked,opacity:g}}catch(e){}}if(s)if("static"===n.fillFnEl.value){const e=n.fillStaticEl.value||"#0090ff",t=parseInt(e.slice(1,3),16),i=parseInt(e.slice(3,5),16),r=parseInt(e.slice(5,7),16);y.getFillColor=[t,i,r]}else{const e=n.fillAttrEl.value||"data_avg",t=n.fillPaletteEl.value||"Earth",i=!!n.fillReverseEl.checked,r=parseFloat(n.fillDomainMinEl.value),o=parseFloat(n.fillDomainMaxEl.value),a=parseInt(n.fillStepsEl.value||"7",10),l=n.fillNullEl.value||"#b8b8b8",s=parseInt(l.slice(1,3),16),c=parseInt(l.slice(3,5),16),d=parseInt(l.slice(5,7),16);y.getFillColor={"@@function":"colorContinuous",attr:e,domain:[Number.isFinite(r)?r:0,Number.isFinite(o)?o:1],colors:t,reverse:i,steps:Number.isFinite(a)?a:7,nullColor:[s,c,d],autoDomain:!1!==y.getFillColor?.autoDomain}}else if(u||p)if("static"===n.fillFnEl.value){const e=n.fillStaticEl.value||"#0090ff";i.fillColorConfig=null,i.fillColorRgba=e;try{const t=$e(e,200)||$e(e);i.vectorLayer&&(i.vectorLayer.getFillColor=t||e)}catch{}}else{const e=n.fillAttrEl.value||"value",t=n.fillPaletteEl.value||"ArmyRose",r=!!n.fillReverseEl.checked,o=parseFloat(n.fillDomainMinEl.value),a=parseFloat(n.fillDomainMaxEl.value),l=parseInt(n.fillStepsEl.value||"7",10),s=n.fillNullEl.value||"#b8b8b8",c=parseInt(s.slice(1,3),16),d=parseInt(s.slice(3,5),16),u=parseInt(s.slice(5,7),16);i.fillColorRgba=null;const y={"@@function":"colorContinuous",attr:e,domain:[Number.isFinite(o)?o:0,Number.isFinite(a)?a:1],colors:t,reverse:r,steps:Number.isFinite(l)?l:7,nullColor:[c,d,u]};i.fillColorConfig=y,p&&(i.colorAttribute=e);try{i.vectorLayer&&(i.vectorLayer.getFillColor=y)}catch(e){}}if(s)if("static"===n.lineFnEl.value){const e=n.lineStaticEl.value||"#ffffff",t=parseInt(e.slice(1,3),16),i=parseInt(e.slice(3,5),16),r=parseInt(e.slice(5,7),16);y.getLineColor=[t,i,r]}else{const e=n.lineAttrEl.value||"data_avg",t=n.linePaletteEl.value||"Earth",i=!!n.lineReverseEl.checked,r=parseFloat(n.lineDomainMinEl.value),o=parseFloat(n.lineDomainMaxEl.value);y.getLineColor={"@@function":"colorContinuous",attr:e,domain:[Number.isFinite(r)?r:0,Number.isFinite(o)?o:1],colors:t,reverse:i,steps:parseInt(n.fillStepsEl.value||"7",10)||7,autoDomain:!1!==y.getLineColor?.autoDomain}}else if(u||p)if("static"===n.lineFnEl.value){const e=n.lineStaticEl.value||"#ffffff";i.lineColorConfig=null,i.lineColorRgba=e;try{const t=$e(e,255)||$e(e);i.vectorLayer&&(i.vectorLayer.getLineColor=t||e)}catch{}}else{const e=n.lineAttrEl.value||"value",t=n.linePaletteEl.value||"ArmyRose",r=!!n.lineReverseEl.checked,o=parseFloat(n.lineDomainMinEl.value),a=parseFloat(n.lineDomainMaxEl.value);i.lineColorRgba=null;const l={"@@function":"colorContinuous",attr:e,domain:[Number.isFinite(o)?o:0,Number.isFinite(a)?a:1],colors:t,reverse:r,steps:parseInt(n.fillStepsEl.value||"7",10)||7};i.lineColorConfig=l;try{i.vectorLayer&&(i.vectorLayer.getLineColor=l)}catch(e){}}const m=parseFloat(n.lineWidthEl.value),h=Number.isFinite(m)?Te(m,0,10):1;if(s)y.lineWidthMinPixels=h;else if(u||p){i.lineWidth=h;try{i.vectorLayer&&(i.vectorLayer.lineWidthMinPixels=h)}catch(e){}}r(),o(),a();try{if("hex"===i.layerType&&!i.isTileLayer){const e=i.parquetData||i.parquetUrl?B()?.[i.id]||{type:"FeatureCollection",features:[]}:c(i.data||[]),n=function(e,t){try{const i=e.getStyle?.(),n=i?.layers||[],r=[`${t}-fill`,`${t}-extrusion`,`${t}-outline`];for(const e of r){const t=n.find(t=>t&&t.id===e);if(t)return"none"!==t.layout?.visibility}}catch{}return!0}(t,i.id);!function(e,t,i,n){try{const n=e.getSource(t.id);n&&"function"==typeof n.setData?n.setData(i):e.addSource(t.id,{type:"geojson",data:i})}catch(e){}!function(e,t){const i=[`${t}-fill`,`${t}-extrusion`,`${t}-outline`];for(const t of i)try{e.getLayer(t)&&e.removeLayer(t)}catch(e){}}(e,t.id),d(e,t,i,n)}(t,i,e,n)}}catch(e){}try{if(u){const e=i,n=e.geojson?.features?.map(e=>e?.properties||{})||[],r=e.fillColorConfig?.["@@function"]?l(e.fillColorConfig,n):e.fillColorRgba||"#0090ff",o=e.lineColorConfig?.["@@function"]?l(e.lineColorConfig,n):e.lineColorRgba||"#ffffff",a=!1===e.isFilled?0:g,s=!1===e.isStroked?0:1;je(t,`${e.id}-`,{"fill-color":r,"fill-opacity":a,"line-color":o,"line-width":h,"line-opacity":s}),Pe(t,`${e.id}-circle`,"circle-color",r),Pe(t,`${e.id}-circle`,"circle-opacity",a),Pe(t,`${e.id}-circle`,"circle-stroke-color",o),Pe(t,`${e.id}-circle`,"circle-stroke-width",h)}}catch{}try{if(p){const e=i,n=!1===e.isFilled?0:g,r=!1===e.isStroked?0:1,o=e.colorAttribute||"value",a=e.fillColorConfig?R(e.fillColorConfig,o,"#ff8c00"):e.fillColorRgba||"#ff8c00",l=e.lineColorConfig?R(e.lineColorConfig,o,"#ffffff"):e.lineColorRgba||"#ffffff",s=!1===e.isStroked?0:h;je(t,`${e.id}-`,{"fill-color":a,"fill-opacity":n,"line-color":l,"line-width":s,"line-opacity":r,"circle-color":a,"circle-opacity":n,"circle-stroke-color":l,"circle-stroke-width":s})}}catch(e){console.warn("[FusedMaps] PMTiles update error:",e)}}({map:e,layer:t,els:{filledEl:m,strokedEl:h,extrudedEl:b,extrusionControls:v,elevAttrEl:x,elevScaleEl:C,opacityEl:L,fillFnEl:E,fillAttrEl:T,fillPaletteEl:$,fillReverseEl:_,fillDomainMinEl:j,fillDomainMaxEl:O,fillStepsEl:D,fillNullEl:z,fillStaticEl:W,lineFnEl:G,lineAttrEl:X,linePaletteEl:Q,lineReverseEl:re,lineDomainMinEl:ie,lineDomainMaxEl:ne,lineStaticEl:oe,lineWidthEl:se},updateLayerOutput:ot,findDeckOverlayOnMap:rt,rebuildDeck:nt})},ft=()=>{const e=parseFloat(j.value),t=parseFloat(O.value);Number.isFinite(e)&&(q.value=String(e)),Number.isFinite(t)&&(I.value=String(t))},gt=()=>{let e=parseFloat(q.value),t=parseFloat(I.value);Number.isFinite(e)&&Number.isFinite(t)&&(e>t&&([e,t]=[t,e]),q.value=String(e),I.value=String(t),j.value=String(e),O.value=String(t))},mt=()=>{const e=it();if(e){e.fillDomainFromUser=!0;try{if("hex"!==e.layerType)return;const t=e.hexLayer||{};if(t.getFillColor&&"object"==typeof t.getFillColor){t.getFillColor.autoDomain=!1;try{delete t.getFillColor._dynamicDomain}catch(e){}}if(t.getLineColor&&"object"==typeof t.getLineColor){t.getLineColor.autoDomain=!1;try{delete t.getLineColor._dynamicDomain}catch(e){}}}catch(e){}}},ht=()=>{gt()},bt=()=>{gt(),mt(),yt()},vt=()=>{try{const i=t(e);if(fe.value=`initialViewState = ${we(i,0)}`,r&&function(){const e=document.activeElement;return!(!e||!e.closest?.("#debug-panel")||"INPUT"!==e.tagName&&"TEXTAREA"!==e.tagName&&"SELECT"!==e.tagName)}())return;ce.value=Ne(i.longitude,5),de.value=Ne(i.latitude,5),ue.value=Ne(i.zoom,2),pe.value=Ne(i.pitch??0,1),ye.value=Ne(i.bearing??0,1)}catch(e){}},xt=()=>{const e=o.classList.toggle("collapsed");a.innerHTML=e?"&#x203A;":"&#x2039;",qe(r,o,a)};let Ct=!1,wt=0,Lt=280;const Et=e=>{if(!Ct)return;const t=e.clientX-wt,i=Te(Lt+t,240,520);o.style.width=`${i}px`,qe(r,o,a),e.preventDefault()},St=e=>{Ct&&(Ct=!1,window.removeEventListener("pointermove",Et),window.removeEventListener("pointerup",St))},At=e=>{Ct=!0,wt=e.clientX,Lt=o.getBoundingClientRect().width||280,window.addEventListener("pointermove",Et,{passive:!1}),window.addEventListener("pointerup",St),e.preventDefault(),e.stopPropagation()};a.addEventListener("click",xt),s.addEventListener("pointerdown",At,{passive:!1}),u.addEventListener("change",()=>pt()),E.addEventListener("change",()=>{dt(),yt()}),G.addEventListener("change",()=>{ut(),yt()}),[m,h].forEach(e=>e.addEventListener("change",yt)),b.addEventListener("change",()=>{try{v&&(v.style.display=b.checked?"block":"none")}catch(e){}yt()}),x.addEventListener("change",yt),C.addEventListener("input",yt),C.addEventListener("change",yt),w.addEventListener("input",()=>{L.value=w.value,yt()}),L.addEventListener("change",()=>{w.value=L.value,yt()}),[T,D,_].forEach(e=>e.addEventListener("change",()=>{try{Ke.refresh()}catch(e){}try{et.refresh()}catch(e){}yt()})),j.addEventListener("input",()=>{ft()}),O.addEventListener("input",()=>{ft()}),j.addEventListener("change",()=>{mt(),yt()}),O.addEventListener("change",()=>{mt(),yt()}),q.addEventListener("input",ht),I.addEventListener("input",ht),q.addEventListener("change",bt),I.addEventListener("change",bt),z.addEventListener("input",()=>{U.textContent=z.value,yt()}),W.addEventListener("input",()=>{H.textContent=W.value,yt()}),[X,ie,ne,re].forEach(e=>e.addEventListener("change",()=>{try{et.refresh()}catch(e){}yt()})),oe.addEventListener("input",()=>{ae.textContent=oe.value,yt()}),le.addEventListener("input",()=>{se.value=le.value,yt()}),se.addEventListener("change",()=>{le.value=se.value,yt()});try{e.on("moveend",vt),e.on("rotateend",vt),e.on("pitchend",vt)}catch(e){}dt(),ut();try{Ke.refresh()}catch(e){}try{et.refresh()}catch(e){}return pt(),vt(),qe(r,o,a),window.addEventListener("resize",()=>qe(r,o,a)),{destroy:()=>{try{Qe.destroy()}catch(e){}try{a.removeEventListener("click",xt)}catch(e){}try{Ue?.removeEventListener("click",Je)}catch(e){}try{We?.removeEventListener("click",Je)}catch(e){}try{s.removeEventListener("pointerdown",At)}catch(e){}try{e.off("moveend",vt),e.off("rotateend",vt),e.off("pitchend",vt)}catch(e){}try{Ve?.destroy()}catch(e){}try{Ve=null}catch(e){}try{r?.remove()}catch(e){}}}}let Ue=!1,We=null;function He(e,t){const i=[];return t.forEach(t=>{if(t.isTileLayer)return;const n=t.layerType;let r=[];if("vector"===n)r=[`${t.id}-fill`,`${t.id}-circle`,`${t.id}-line`];else if("hex"===n){const e=t;r=[e.hexLayer?.extruded?`${t.id}-extrusion`:`${t.id}-fill`]}r.forEach(t=>{try{e.getLayer(t)&&i.push(t)}catch(e){}})}),["gdf-fill","gdf-circle","hex-fill"].forEach(t=>{try{e.getLayer(t)&&i.push(t)}catch(e){}}),i}function Ge(e,t){let i={type:"FeatureCollection",features:[]};if(t){const e=t.properties||{},n=e.hex||e.h3;if(n&&window.h3)try{const t=s(n);if(t&&window.h3.isValidCell(t)){const n=window.h3.cellToBoundary(t).map(([e,t])=>[t,e]);n.push(n[0]),i.features.push({type:"Feature",geometry:{type:"Polygon",coordinates:[n]},properties:e})}}catch(e){}else t.geometry&&i.features.push({type:"Feature",geometry:t.geometry,properties:e})}Ue?e.getSource("feature-hl").setData(i):(e.addSource("feature-hl",{type:"geojson",data:i}),e.addLayer({id:"feature-hl-fill",type:"fill",source:"feature-hl",paint:{"fill-color":"rgba(255,255,0,0.3)","fill-opacity":1}}),e.addLayer({id:"feature-hl-line",type:"line",source:"feature-hl",paint:{"line-color":"rgba(255,255,0,1)","line-width":3}}),Ue=!0),We=t}function Ve(e){let t=null,i=null;try{"BroadcastChannel"in window&&(t=new BroadcastChannel(e))}catch(e){}function n(e){if(!i)return;let t;try{t="string"==typeof e.data?JSON.parse(e.data):e.data}catch{return}i(t)}return{send:function(e){const i=JSON.stringify(e);try{t&&t.postMessage(e)}catch(e){}try{window.parent.postMessage(i,"*")}catch(e){}try{window.top&&window.top!==window.parent&&window.top.postMessage(i,"*")}catch(e){}try{if(window.top?.frames)for(let e=0;e<window.top.frames.length;e++){const t=window.top.frames[e];if(t!==window)try{t.postMessage(i,"*")}catch(e){}}}catch(e){}},onMessage:function(e){i=e,t&&(t.onmessage=e=>{i&&i(e.data)}),window.addEventListener("message",n)},destroy:function(){t&&(t.close(),t=null),window.removeEventListener("message",n),i=null}}}function Ze(e="component"){return`${e}-${Math.random().toString(36).substr(2,9)}`}function Je(e,t,i,n){const r=n.channel||"fused-bus",o=n.messageType||"feature_click",a=n.properties||null,l=!1!==n.includeCoords,s=!1!==n.includeLayer,c=Ze("click-broadcast"),d=Ve(r);function u(){const i=[];for(const n of t)if(!n.isTileLayer)if("vector"===n.layerType)for(const t of["-fill","-circle","-line"]){const r=`${n.id}${t}`;try{e.getLayer(r)&&i.push(r)}catch{}}else if("hex"===n.layerType){const t=(n.hexLayer||{}).extruded?[`${n.id}-extrusion`]:[`${n.id}-fill`];for(const n of t)try{e.getLayer(n)&&i.push(n)}catch{}}return i}function p(e){if(!a||!Array.isArray(a))return{...e};const t={};for(const i of a)void 0!==e[i]&&(t[i]=e[i]);return t}function y(e,t,i){const n={type:o,fromComponent:c,properties:p(e),timestamp:Date.now()};l&&i&&(n.lngLat=i),s&&(n.layer=t),d.send(n)}function f(n){!function(t){const n=u();if(n.length)try{if((e.queryRenderedFeatures(t.point,{layers:n})||[]).length)return!0}catch{}if(i?.pickObject)try{const e=i.pickObject({x:t.point.x,y:t.point.y,radius:1});if(e?.object)return!0}catch{}return!1}(n)?function(e){const t={type:"feature_deselect",fromComponent:c,properties:null,timestamp:Date.now()};l&&e&&(t.lngLat=e),d.send(t)}({lng:n.lngLat.lng,lat:n.lngLat.lat}):(function(i){const n=u();if(!n.length)return;let r=[];try{r=e.queryRenderedFeatures(i.point,{layers:n})||[]}catch(e){return void console.warn("[ClickBroadcast] Error querying features:",e)}if(!r.length)return;const o=r[0];y(o.properties||{},function(e){const i=t.find(t=>e.startsWith(t.id));return i?.name||i?.id||e}(o.layer?.id||""),{lng:i.lngLat.lng,lat:i.lngLat.lat})}(n),function(n){if(!i?.pickObject)return;const r=u();if(r.length)try{const t=e.queryRenderedFeatures(n.point,{layers:r});if(t?.length)return}catch{}try{const e=i.pickObject({x:n.point.x,y:n.point.y,radius:1});if(!e?.object)return;const r=e.object,o=r.properties||r||{};let a="hex-tiles";const l=e.layer?.id||"";if(l){const e=l.match(/^([^-]+)/);if(e){const i=e[1],n=t.find(e=>e.id===i||e.id.startsWith(i));n&&(a=n.name||n.id)}}y(o,a,{lng:n.lngLat.lng,lat:n.lngLat.lat})}catch(e){console.warn("[ClickBroadcast] Error picking deck object:",e)}}(n))}return e.on("click",f),{destroy:function(){e.off("click",f),d.destroy()}}}function Ye(e,t,i,n){const r={};if(t.broadcast?.enabled&&function(e,t={}){const i=t.channel||"fused-bus",n=t.dataset||"all",r=Ze("map-broadcast"),o=Ve(i);let a=null;function l(){const t=function(e){const t=e.getBounds();return[+t.getWest().toFixed(6),+t.getSouth().toFixed(6),+t.getEast().toFixed(6),+t.getNorth().toFixed(6)]}(e);if(l=a,(i=t)&&l&&i[0]===l[0]&&i[1]===l[1]&&i[2]===l[2]&&i[3]===l[3])return;var i,l;a=t;const[s,c,d,u]=t;o.send({type:"filter",fromComponent:r,timestamp:Date.now(),dataset:n,filter:{type:"spatial",field:"geometry",values:[s,c,d,u]}})}e.on("move",l),e.on("moveend",l),e.on("load",()=>{setTimeout(l,300)}),e.loaded()&&setTimeout(l,100),setTimeout(()=>{o.send({type:"component_ready",componentType:"map",componentId:r,capabilities:["spatial_filter"],dataSource:"viewport",protocol:"unified"})},200)}(e,{channel:t.broadcast.channel,dataset:t.broadcast.dataset}),t.sync?.enabled&&function(e,t={}){let i=t.channel||"default";i.includes("::")||(i=`map-sync::${i}`);const n=Ze("map"),r=Ve(i);let o=!1,a=!1,l={x:NaN,y:NaN,z:NaN};const s=(e,t,i)=>Math.abs(e-t)<i;function c(){const t=e.getCenter();return{longitude:+t.lng.toFixed(6),latitude:+t.lat.toFixed(6),zoom:+e.getZoom().toFixed(3),bearing:+e.getBearing().toFixed(1),pitch:+e.getPitch().toFixed(1),id:n,ts:Date.now()}}function d(){if(o)return;const e=c(),{longitude:t,latitude:i,zoom:n}=e;s(t,l.x,1e-6)&&s(i,l.y,1e-6)&&s(n,l.z,.001)||(l={x:t,y:i,z:n},r.send({type:"sync",...e}))}let u=null;const p=()=>{a=!0},y=()=>{a&&(a=!1,d())};e.on("dragstart",p),e.on("zoomstart",p),e.on("rotatestart",p),e.on("pitchstart",p),e.on("moveend",y),e.on("move",()=>{a&&!o&&(u&&clearTimeout(u),u=setTimeout(d,0))}),r.onMessage(t=>{var i;"sync"===t.type&&t.id!==n&&(i=t)&&i.id!==n&&(o||a||(o=!0,e.jumpTo({center:[i.longitude,i.latitude],zoom:i.zoom,bearing:i.bearing,pitch:i.pitch}),requestAnimationFrame(()=>{o=!1})))}),e.on("load",()=>{setTimeout(()=>r.send({type:"sync",...c()}),100+100*Math.random())}),document.addEventListener("visibilitychange",()=>{document.hidden&&(o=!1,a=!1)})}(e,{channel:t.sync.channel}),t.clickBroadcast?.enabled){const o=Je(e,i,n||null,{channel:t.clickBroadcast.channel,messageType:t.clickBroadcast.messageType,properties:t.clickBroadcast.properties,includeCoords:t.clickBroadcast.includeCoords,includeLayer:t.clickBroadcast.includeLayer});r.clickBroadcastDestroy=o.destroy}if(t.locationListener?.enabled){const i=function(e,t={}){const i=t.channel||"fused-bus",n=t.zoomOffset??0,r=t.padding??100,o=t.maxZoom??16,a=Ze("location-listener"),l=Ve(i);return l.onMessage(function(t){if(!t)return;if(t.fromComponent===a)return;const i=t.type||t.message_type;if("clear_selection"!==i&&"feature_deselect"!==i){if("location_change"===i||"feature_click"===i||"hex_click"===i){const i=t.bounds||t.location?.bounds,a=t.properties||t.location;if(a&&"function"==typeof window.__fusedHighlightByProperties)try{window.__fusedHighlightByProperties(a)}catch{}if(i&&Array.isArray(i)&&4===i.length){const[t,a,l,s]=i;if(!(Number.isFinite(t)&&Number.isFinite(a)&&Number.isFinite(l)&&Number.isFinite(s)))return void console.warn("[LocationListener] Invalid bounds:",i);const c=Math.max(0,Math.min(r,250));n>0&&e.once?.("moveend",()=>{const t=e.getZoom(),i=Math.min(t+n,o);e.easeTo?.({zoom:i,duration:300})});try{e.fitBounds([[t,a],[l,s]],{padding:c,duration:800,maxZoom:o})}catch(i){console.warn("[LocationListener] fitBounds failed, using flyTo fallback:",i);const n=(t+l)/2,r=(a+s)/2;e.flyTo?.({center:[n,r],zoom:14,duration:800})}}}}else try{if("function"==typeof window.__fusedHighlightClear)window.__fusedHighlightClear();else if(e.getSource("feature-hl")){const t=e.getSource("feature-hl");t&&"function"==typeof t.setData&&t.setData({type:"FeatureCollection",features:[]})}}catch{}}),{destroy:function(){l.destroy()}}}(e,{channel:t.locationListener.channel,zoomOffset:t.locationListener.zoomOffset,padding:t.locationListener.padding,maxZoom:t.locationListener.maxZoom,idFields:t.locationListener.idFields});r.locationListenerDestroy=i.destroy}return r}const Xe="1.33.1-dev13.0",Qe=new Map;function Ke(e){return/^[A-Za-z_][A-Za-z0-9_]*$/.test(e)}class et{constructor(e){this.duck=null,this.db=null,this.conn=null,this.tableByLayerId=new Map,this.loadedTables=new Set,this.hasSpatial=!1,this.version=e?.version||Xe}get ready(){return!!this.conn}async init(){if(this.conn)return;this.duck=await async function(e=Xe){const t=Qe.get(e);if(t)return t;const i=import(`https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@${e}/+esm`);return Qe.set(e,i),i}(this.version);const e=this.duck,t=await e.selectBundle(e.getJsDelivrBundles()),i=await(await fetch(t.mainWorker)).text(),n=new Worker(URL.createObjectURL(new Blob([i],{type:"application/javascript"}))),r=new e.AsyncDuckDB(new e.ConsoleLogger,n);await r.instantiate(t.mainModule);const o=await r.connect();try{await o.query("INSTALL h3 FROM community")}catch(e){}try{await o.query("LOAD h3")}catch(e){}try{await o.query("INSTALL spatial")}catch(e){}try{await o.query("LOAD spatial"),this.hasSpatial=!0}catch(e){this.hasSpatial=!1}this.db=r,this.conn=o}layerTableName(e){const t=this.tableByLayerId.get(e.id);if(t)return t;const i=e.id.replace(/-/g,"_");return this.tableByLayerId.set(e.id,i),i}async ensureLayerTable(e){if(await this.init(),!this.db||!this.conn)throw new Error("DuckDB not initialized");const t=this.layerTableName(e);if(this.loadedTables.has(t))return t;let i=null;if(e.parquetData)i=function(e){const t=atob(e),i=new Uint8Array(t.length);for(let e=0;e<t.length;e++)i[e]=t.charCodeAt(e);return i}(e.parquetData);else if(e.parquetUrl){const t=await fetch(e.parquetUrl);if(!t.ok)throw new Error(`Failed to fetch parquetUrl (${t.status})`);const n=await t.arrayBuffer();i=new Uint8Array(n)}if(!i)throw new Error("Missing parquetData or parquetUrl for SQL layer");return await this.db.registerFileBuffer(`${t}.parquet`,i),await this.conn.query(`CREATE OR REPLACE TABLE ${t} AS SELECT * FROM read_parquet('${t}.parquet')`),this.loadedTables.add(t),t}async runSql(e,t){if(await this.ensureLayerTable(e),!this.conn)throw new Error("DuckDB not initialized");const i=this.layerTableName(e);await this.conn.query(`CREATE OR REPLACE VIEW data AS SELECT * FROM ${i}`);const n=(t||"").trim(),r=/^(with|select)\b/i.test(n)?n:`SELECT * FROM data WHERE (${n||"1=1"})`,o=(await this.conn.query(r)).toArray().map(e=>function(e){const t=new Set(["hex","h3","index","id"]),i={};for(const n of Object.keys(e)){let r=e[n];"bigint"==typeof r&&(r=t.has(n.toLowerCase())?r.toString(16):Number(r)),i[n]=r}const n=s(i.hex??i.h3??i.index??i.id);return n&&(i.hex=n),i}(e)).filter(e=>!!e.hex);return{rows:o,count:o.length}}async getMinMaxFromQuery(e,t,i){if(await this.ensureLayerTable(e),!this.conn)return null;const n=this.layerTableName(e);await this.conn.query(`CREATE OR REPLACE VIEW data AS SELECT * FROM ${n}`);const r=(i||"").trim(),o=/^(with|select)\b/i.test(r)?r:`SELECT * FROM data WHERE (${r||"1=1"})`,a=`"${String(t).replace(/"/g,'""')}"`,l=(await this.conn.query(`SELECT MIN(${a}) as min_val, MAX(${a}) as max_val FROM (${o}) AS q`)).toArray()[0];if(!l)return null;let s=l.min_val,c=l.max_val;return"bigint"==typeof s&&(s=Number(s)),"bigint"==typeof c&&(c=Number(c)),Number.isFinite(s)&&Number.isFinite(c)?{min:s,max:c}:null}async runSqlGeoJSON(e,t){if(await this.ensureLayerTable(e),!this.conn)throw new Error("DuckDB not initialized");if(!this.hasSpatial)return null;const i=this.layerTableName(e);await this.conn.query(`CREATE OR REPLACE VIEW data AS SELECT * FROM ${i}`);const n=(t||"").trim(),r=/^(with|select)\b/i.test(n)?n:`SELECT * FROM data WHERE (${n||"1=1"})`,o=await this.conn.query(`SELECT * FROM (${r}) AS q LIMIT 0`),a=(o?.schema?.fields||[]).map(e=>String(e?.name||"")).filter(Boolean),l=["hex","h3","index","id"].find(e=>a.includes(e))||null;if(!l)return null;if(!a.every(Ke))return null;const s=`\n      WITH q AS (${r})\n      SELECT\n        count(*)::BIGINT AS cnt,\n        CASE\n          WHEN count(*) = 0 THEN '{"type":"FeatureCollection","features":[]}'\n          ELSE (\n            '{"type":"FeatureCollection","features":[' ||\n              string_agg(\n                '{"type":"Feature","geometry":' ||\n                  ST_AsGeoJSON(ST_GeomFromText(h3_cell_to_boundary_wkt(CAST("${l}" AS BIGINT)))) ||\n                ',"properties":' || to_json(struct_pack(${a.map(e=>`${e} := "${e}"`).join(", ")})) || '}',\n                ','\n              ) ||\n            ']}'\n          )\n        END AS gj\n      FROM q\n      WHERE "${l}" IS NOT NULL\n        AND h3_is_valid_cell(CAST("${l}" AS BIGINT))\n    `,c=(await this.conn.query(s)).toArray()[0];if(!c)return{geojson:{type:"FeatureCollection",features:[]},count:0};let d=c.cnt;"bigint"==typeof d&&(d=Number(d));const u=String(c.gj||'{"type":"FeatureCollection","features":[]}');return{geojson:JSON.parse(u),count:Number(d)||0}}async getMinMax(e,t){if(await this.ensureLayerTable(e),!this.conn)return null;const i=this.layerTableName(e);await this.conn.query(`CREATE OR REPLACE VIEW data AS SELECT * FROM ${i}`);const n=(await this.conn.query(`SELECT MIN("${t}") as min_val, MAX("${t}") as max_val FROM data`)).toArray()[0];if(!n)return null;let r=n.min_val,o=n.max_val;return"bigint"==typeof r&&(r=Number(r)),"bigint"==typeof o&&(o=Number(o)),Number.isFinite(r)&&Number.isFinite(o)?{min:r,max:o}:null}}let tt=null,it={};function nt(e){return!("hex"!==e.layerType||e.isTileLayer||!e.parquetData&&!e.parquetUrl)}function rt(){let e=document.getElementById("sql-loader");e||(e=document.createElement("div"),e.id="sql-loader",e.innerHTML='<div class="loader-spinner"></div><span id="sql-loader-text">DuckDB…</span>',document.body.appendChild(e));const t=document.getElementById("sql-loader-text");let i=null;const n=new Map;return{setStatus:(r,o)=>{n.set(r,String(o||"")),(()=>{if(!e)return;const r=[...n.entries()].filter(([,e])=>(e=>{const t=(e||"").toLowerCase();return!!t&&!t.startsWith("error:")&&!t.includes(" rows")&&(t.includes("initializ")||t.includes("running")||t.includes("loading")||t.includes("fetch"))})(e));if(r.length){i&&clearTimeout(i),e.classList.add("active");const n=r.some(([,e])=>String(e||"").toLowerCase().includes("initializ"));return void(t&&(t.textContent=n?"Initialising…":"Loading…"))}i=setTimeout(()=>e?.classList.remove("active"),300)})()}}}function ot(e,t){try{window.dispatchEvent(new CustomEvent("fusedmaps:sql:status",{detail:{layerId:e,status:t}}))}catch(e){}try{tt||(tt=rt()),tt?.setStatus(e,t)}catch(e){}}class at{constructor(){this.layers=new Map,this.listeners=new Map,this.nextOrder=0,this.listeners.set("*",new Set)}init(e){this.layers.clear(),this.nextOrder=0,e.forEach((e,t)=>{const i={config:e,visible:!1!==e.visible,order:t};this.layers.set(e.id,i),this.nextOrder=Math.max(this.nextOrder,t+1)}),this.emit({type:"batch",layerId:"*"})}add(e,t){if(this.layers.has(e.id))return console.warn(`[LayerStore] Layer ${e.id} already exists, updating instead`),this.update(e.id,e);const i=t?.order??this.nextOrder;void 0!==t?.order&&this.shiftOrdersFrom(i,1);const n={config:e,visible:!1!==e.visible,order:i};return this.layers.set(e.id,n),this.nextOrder=Math.max(this.nextOrder,i+1),this.emit({type:"add",layerId:e.id,layer:n}),n}remove(e){const t=this.layers.get(e);return!!t&&(this.layers.delete(e),this.recomputeOrders(),this.emit({type:"remove",layerId:e,layer:t}),!0)}update(e,t){const i=this.layers.get(e);if(i)return i.config={...i.config,...t},"visible"in t&&(i.visible=!1!==t.visible),this.emit({type:"update",layerId:e,layer:i,changes:t}),i;console.warn(`[LayerStore] Layer ${e} not found`)}updateStyle(e,t,i){const n=this.layers.get(e);if(!n)return;const r=n.config;return r[t]||(r[t]={}),r[t]={...r[t],...i},this.emit({type:"update",layerId:e,layer:n,changes:{[t]:r[t]}}),n}setVisible(e,t){const i=this.layers.get(e);i&&i.visible!==t&&(i.visible=t,i.config.visible=t,this.emit({type:"visibility",layerId:e,layer:i}))}toggleVisible(e){const t=this.layers.get(e);return!!t&&(this.setVisible(e,!t.visible),t.visible)}setVisibleBatch(e){Object.entries(e).forEach(([e,t])=>{const i=this.layers.get(e);i&&i.visible!==t&&(i.visible=t,i.config.visible=t)}),this.emit({type:"batch",layerId:"*"})}reorder(e,t){const i=this.layers.get(e);if(!i)return;const n=i.order;if(n===t)return;const r=this.layers.size-1;t=Math.max(0,Math.min(r,t)),this.layers.forEach((i,r)=>{r!==e&&(n<t?i.order>n&&i.order<=t&&i.order--:i.order>=t&&i.order<n&&i.order++)}),i.order=t,this.emit({type:"reorder",layerId:e,layer:i,previousOrder:n,newOrder:t})}moveUp(e){const t=this.layers.get(e);t&&this.reorder(e,t.order+1)}moveDown(e){const t=this.layers.get(e);t&&this.reorder(e,t.order-1)}moveToTop(e){this.reorder(e,this.layers.size-1)}moveToBottom(e){this.reorder(e,0)}setGeoJSON(e,t){const i=this.layers.get(e);i&&(i.geojson=t,this.emit({type:"geojson",layerId:e,layer:i}))}getGeoJSON(e){return this.layers.get(e)?.geojson}getAllGeoJSONs(){const e={};return this.layers.forEach((t,i)=>{t.geojson&&(e[i]=t.geojson)}),e}get(e){return this.layers.get(e)}getConfig(e){return this.layers.get(e)?.config}has(e){return this.layers.has(e)}getAll(){return[...this.layers.values()].sort((e,t)=>e.order-t.order)}getAllConfigs(){return this.getAll().map(e=>e.config)}getVisible(){return this.getAll().filter(e=>e.visible)}getVisibleConfigs(){return this.getVisible().map(e=>e.config)}getVisibilityState(){const e={};return this.layers.forEach((t,i)=>{e[i]=t.visible}),e}getByType(e){return this.getAll().filter(t=>t.config.layerType===e)}get size(){return this.layers.size}on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>this.off(e,t)}off(e,t){this.listeners.get(e)?.delete(t)}emit(e){this.listeners.get(e.type)?.forEach(t=>{try{t(e)}catch(e){console.error("[LayerStore] Event handler error:",e)}}),this.listeners.get("*")?.forEach(t=>{try{t(e)}catch(e){console.error("[LayerStore] Event handler error:",e)}})}shiftOrdersFrom(e,t){this.layers.forEach(i=>{i.order>=e&&(i.order+=t)})}recomputeOrders(){const e=this.getAll();e.forEach((e,t)=>{e.order=t}),this.nextOrder=e.length}clone(e,t,i){const n=this.layers.get(e);if(!n)return;const r=JSON.parse(JSON.stringify(n.config));return r.id=t,i&&(r.name=i),this.add(r,{order:n.order+1})}rename(e,t){const i=this.layers.get(e);i&&(i.config.name=t,this.emit({type:"update",layerId:e,layer:i,changes:{name:t}}))}clear(){this.layers.clear(),this.nextOrder=0,this.emit({type:"batch",layerId:"*"})}export(){return{layers:this.getAllConfigs(),visibility:this.getVisibilityState()}}}function lt(){return new at}function st(e){if(e){if("string"==typeof e)return e;if(Array.isArray(e))return(t=e).length>=4?`rgba(${t[0]},${t[1]},${t[2]},${t[3]/255})`:`rgb(${t[0]},${t[1]},${t[2]})`;var t;if("type"in e){if("continuous"===e.type){const t=e;return{"@@function":"colorContinuous",attr:t.attr,domain:t.domain||[0,1],colors:t.palette,steps:t.steps,nullColor:t.nullColor,reverse:t.reverse,autoDomain:t.autoDomain??!0}}if("categorical"===e.type){const t=e;return{"@@function":"colorCategories",attr:t.attr,categories:t.categories,labelAttr:t.labelAttr,colors:t.palette,nullColor:t.nullColor}}}return"@@function"in e?e:void 0}}function ct(e){switch(e.layerType){case"hex":return function(e){const t=e.style||{},i=e.tile||{};return{id:e.id,name:e.name,layerType:"hex",visible:e.visible,data:e.data,tileUrl:e.tileUrl,isTileLayer:!!e.tileUrl,parquetUrl:e.parquetUrl,parquetData:e.parquetData,sql:e.sql,dataRef:e.dataRef,tooltipColumns:e.tooltip,hexLayer:{filled:t.filled??!0,stroked:t.stroked??!0,extruded:t.extruded??!1,opacity:t.opacity??1,elevationProperty:t.elevationAttr,elevationScale:t.elevationScale??1,getFillColor:st(t.fillColor),getLineColor:st(t.lineColor),lineWidthMinPixels:t.lineWidth??1,tooltipColumns:e.tooltip},tileLayerConfig:Object.keys(i).length>0?{minZoom:i.minZoom,maxZoom:i.maxZoom,zoomOffset:i.zoomOffset,tileSize:i.tileSize,maxRequests:i.maxRequests}:void 0}}(e);case"vector":return function(e){const t=e.style||{},i=st(t.fillColor),n=st(t.lineColor);return{id:e.id,name:e.name,layerType:"vector",visible:e.visible,geojson:e.geojson,geojsonSource:e.source,dataRef:e.dataRef,tooltipColumns:e.tooltip,vectorLayer:{filled:t.filled??!0,stroked:t.stroked??!0,opacity:t.opacity??.8,getFillColor:i,getLineColor:n,lineWidthMinPixels:t.lineWidth??1,pointRadiusMinPixels:t.pointRadius??6},fillColorConfig:dt(i)?i:void 0,fillColorRgba:"string"==typeof i?i:void 0,lineColorConfig:dt(n)?n:void 0,lineColorRgba:"string"==typeof n?n:void 0,lineWidth:t.lineWidth??1,pointRadius:t.pointRadius??6,isFilled:t.filled??!0,isStroked:t.stroked??!0,opacity:t.opacity??.8}}(e);case"mvt":return function(e){const t=e.style||{},i=e.tile||{},n=st(t.fillColor),r=st(t.lineColor);return{id:e.id,name:e.name,layerType:"mvt",visible:e.visible,tileUrl:e.tileUrl,sourceLayer:e.sourceLayer,dataRef:e.dataRef,tooltipColumns:e.tooltip,minzoom:i.minZoom,maxzoom:i.maxZoom,fillColorConfig:dt(n)?n:void 0,fillColor:"string"==typeof n?n:void 0,fillOpacity:t.opacity??.8,isFilled:t.filled??!0,lineColorConfig:dt(r)?r:void 0,lineColor:"string"==typeof r?r:void 0,lineWidth:t.lineWidth??1,isExtruded:t.extruded??!1,heightProperty:t.elevationAttr,heightMultiplier:t.elevationScale}}(e);case"raster":return{id:(t=e).id,name:t.name,layerType:"raster",visible:t.visible,tileUrl:t.tileUrl,imageUrl:t.imageUrl,imageBounds:t.imageBounds,dataRef:t.dataRef,opacity:t.opacity??1,rasterLayer:{opacity:t.opacity??1}};case"pmtiles":return function(e){const t=e.style||{},i=e.tile||{},n=st(t.fillColor),r=st(t.lineColor);return{id:e.id,name:e.name,layerType:"pmtiles",visible:e.visible,pmtilesUrl:e.pmtilesUrl,pmtilesPath:e.pmtilesPath,sourceLayer:e.sourceLayer,excludeSourceLayers:e.excludeSourceLayers,dataRef:e.dataRef,tooltipColumns:e.tooltip,minzoom:i.minZoom,maxzoom:i.maxZoom,fillColorConfig:dt(n)?n:void 0,lineColorConfig:dt(r)?r:void 0,fillOpacity:t.opacity??.8,lineWidth:t.lineWidth??1,pointRadiusMinPixels:t.pointRadius??4,isFilled:t.filled??!0,isStroked:t.stroked??!0,renderPoints:e.renderPoints,renderLines:e.renderLines,renderPolygons:e.renderPolygons,colorAttribute:t.fillColor?.attr}}(e);default:return e}var t}function dt(e){return!(!e||"object"!=typeof e||Array.isArray(e))&&("@@function"in e||"type"in e)}function ut(e){return"style"in e||"tile"in e||"tooltip"in e}const pt={sequential:["Viridis","Mint","BluGrn","Sunset","Magenta","SunsetDark","Teal","TealGrn","Purp","PurpOr","Emrld","OrYel","Peach","Burg","RedOr","BurgYl","BluYl","PinkYl","DarkMint"],diverging:["TealRose","Temps","Tropic","Earth","Fall","Geyser","ArmyRose"],qualitative:["Bold","Prism","Safe","Vivid","Pastel","Antique"]},yt=[...pt.sequential,...pt.diverging,...pt.qualitative],ft={Viridis:{category:"sequential",description:"Purple to yellow, perceptually uniform",goodFor:"General purpose, works well for most numeric data"},Mint:{category:"sequential",description:"Light to dark mint green",goodFor:"Environmental data, growth metrics"},BluGrn:{category:"sequential",description:"Blue to green gradient",goodFor:"Water, environmental, cool-toned data"},Sunset:{category:"sequential",description:"Yellow to purple through orange/pink",goodFor:"Warm data, intensity, heat"},Magenta:{category:"sequential",description:"Light pink to deep magenta",goodFor:"Single-hue emphasis, density"},SunsetDark:{category:"sequential",description:"Dark version of Sunset",goodFor:"Dark backgrounds, high contrast"},Teal:{category:"sequential",description:"Light to dark teal",goodFor:"Water depth, calm data"},TealGrn:{category:"sequential",description:"Teal to green",goodFor:"Nature, ecology data"},Purp:{category:"sequential",description:"Light to dark purple",goodFor:"Density, single-hue data"},PurpOr:{category:"sequential",description:"Purple to orange",goodFor:"Wide value range, attention-grabbing"},Emrld:{category:"sequential",description:"Light to emerald green",goodFor:"Currency, growth, positive metrics"},OrYel:{category:"sequential",description:"Orange to yellow",goodFor:"Warm metrics, energy"},Peach:{category:"sequential",description:"Light peach to deep coral",goodFor:"Soft data visualization"},Burg:{category:"sequential",description:"Light to burgundy",goodFor:"Wine, health, serious data"},RedOr:{category:"sequential",description:"Red to orange",goodFor:"Heat, urgency, warnings"},TealRose:{category:"diverging",description:"Teal ↔ neutral ↔ rose",goodFor:"Positive/negative, above/below average"},Temps:{category:"diverging",description:"Cool ↔ warm temperature feel",goodFor:"Temperature, sentiment"},Tropic:{category:"diverging",description:"Cyan ↔ neutral ↔ magenta",goodFor:"Bipolar data, contrast"},Earth:{category:"diverging",description:"Green ↔ brown earth tones",goodFor:"Land use, terrain"},Fall:{category:"diverging",description:"Autumn color diverging",goodFor:"Seasonal, natural data"},Geyser:{category:"diverging",description:"Blue ↔ neutral ↔ orange",goodFor:"Classic diverging, politics"},ArmyRose:{category:"diverging",description:"Army green ↔ rose",goodFor:"Contrast, opposing categories"},Bold:{category:"qualitative",description:"High-contrast distinct colors",goodFor:"Categories that need to stand out"},Prism:{category:"qualitative",description:"Rainbow-like distinct colors",goodFor:"Many categories, playful data"},Safe:{category:"qualitative",description:"Colorblind-safe palette",goodFor:"Accessibility-critical visualizations"},Vivid:{category:"qualitative",description:"Bright saturated colors",goodFor:"Eye-catching categories"},Pastel:{category:"qualitative",description:"Soft muted colors",goodFor:"Subtle category distinction"},Antique:{category:"qualitative",description:"Muted vintage colors",goodFor:"Historical data, elegant style"}};function gt(e){return[...pt[e]]}function mt(e){return ft[e]}function ht(e){const{dataType:t,colorblindSafe:i}=e;if(i&&"categorical"===t)return"Safe";switch(t){case"continuous":default:return"Viridis";case"categorical":return"Bold";case"diverging":return"Geyser"}}function bt(e,t=7){if("undefined"==typeof window)return null;const i=window.cartocolor;if(!i)return null;const n=i[e];if(!n)return null;const r=Object.keys(n).map(Number).filter(e=>!isNaN(e)).sort((e,t)=>e-t),o=r.find(e=>e>=t)||r[r.length-1];return n[o]?[...n[o]]:null}function vt(e){const t=e.toLowerCase(),i=yt.find(e=>e.toLowerCase()===t);if(i)return i;const n={"blue-green":"BluGrn",bluegreen:"BluGrn",purple:"Purp",tealgreen:"TealGrn","teal-green":"TealGrn","orange-yellow":"OrYel","red-orange":"RedOr","purple-orange":"PurpOr"};if(n[t])return n[t];return yt.find(e=>e.toLowerCase().startsWith(t))||null}const xt=["hex","vector","mvt","raster","pmtiles"],Ct=["dark","light","streets","satellite","none"];function wt(e){const t=[],i=[];if(!e||"object"!=typeof e)return t.push({path:"",message:"Config must be an object",received:typeof e,expected:"object"}),{valid:!1,errors:t,warnings:i};const n=e;if(void 0!==n.center)if(Array.isArray(n.center)&&2===n.center.length){const[e,r]=n.center;"number"!=typeof e||"number"!=typeof r?t.push({path:"center",message:"center coordinates must be numbers",received:n.center,expected:"[number, number]"}):((e<-180||e>180)&&t.push({path:"center[0]",message:"longitude must be between -180 and 180",received:e,expected:"-180 to 180"}),(r<-90||r>90)&&t.push({path:"center[1]",message:"latitude must be between -90 and 90",received:r,expected:"-90 to 90"}),Math.abs(e)<=90&&Math.abs(r)>90&&i.push("center coordinates may be swapped - format is [longitude, latitude], not [latitude, longitude]"))}else t.push({path:"center",message:"center must be [longitude, latitude] array",received:n.center,expected:"[number, number]",suggestion:"Example: [-122.4, 37.8] for San Francisco"});return void 0!==n.zoom&&("number"!=typeof n.zoom||n.zoom<0||n.zoom>22)&&t.push({path:"zoom",message:"zoom must be a number between 0 and 22",received:n.zoom,expected:"number (0-22)"}),void 0!==n.basemap&&(Ct.includes(n.basemap)||t.push({path:"basemap",message:`Invalid basemap: "${n.basemap}"`,received:n.basemap,expected:Ct.join(" | "),suggestion:`Use one of: ${Ct.join(", ")}`})),n.layers?Array.isArray(n.layers)?(0===n.layers.length&&i.push("layers array is empty - map will show only basemap"),n.layers.forEach((e,n)=>{!function(e,t,i,n){if(!e||"object"!=typeof e)return void i.push({path:t,message:"Layer must be an object",received:typeof e,expected:"object"});const r=e;if(!r.layerType)return void i.push({path:`${t}.layerType`,message:"layerType is required",expected:xt.join(" | "),suggestion:'Common types: "hex" for H3 hexagons, "vector" for GeoJSON'});if(!xt.includes(r.layerType)){const e={hexagon:"hex",hexagons:"hex",h3:"hex",geojson:"vector",json:"vector",points:"vector",polygons:"vector",lines:"vector",tiles:"mvt",vectortiles:"mvt","vector-tiles":"mvt",image:"raster",xyz:"raster",pmtile:"pmtiles"}[r.layerType.toLowerCase()]||null;return void i.push({path:`${t}.layerType`,message:`Invalid layerType: "${r.layerType}"`,received:r.layerType,expected:xt.join(" | "),suggestion:e?`Did you mean "${e}"?`:void 0})}const o=r.layerType;"hex"===o?function(e,t,i){const n=void 0!==e.data,r=void 0!==e.dataUrl,o=void 0!==e.tileUrl,a=void 0!==e.parquetUrl;if(n||r||o||a){if(n)if(Array.isArray(e.data)){if(e.data.length>0){const n=e.data[0];n.h3||n.H3||n.hex||i.push({path:`${t}.data[0]`,message:'H3 data items must have an "h3" property with the H3 index',received:Object.keys(n).join(", "),expected:'object with "h3" property',suggestion:'Each item needs: { h3: "8928308280fffff", ...otherProps }'})}}else i.push({path:`${t}.data`,message:"data must be an array of objects with h3 indices",received:typeof e.data,expected:"array",suggestion:'Example: [{ h3: "8928308280fffff", value: 100 }]'})}else i.push({path:t,message:"Hex layer requires a data source",suggestion:"Provide one of: data (inline H3 array), dataUrl, tileUrl, or parquetUrl"})}(r,t,i):"vector"===o?function(e,t,i){const n=void 0!==e.data,r=void 0!==e.dataUrl,o=void 0!==e.geojson;if(!n&&!r&&!o)return void i.push({path:t,message:"Vector layer requires a data source",suggestion:"Provide one of: data (GeoJSON), dataUrl (URL to GeoJSON), or geojson"});const a=e.data||e.geojson;a&&"object"==typeof a&&("FeatureCollection"!==a.type?i.push({path:`${t}.data.type`,message:"GeoJSON must be a FeatureCollection",received:a.type,expected:'"FeatureCollection"',suggestion:'Wrap features in: { type: "FeatureCollection", features: [...] }'}):Array.isArray(a.features)||i.push({path:`${t}.data.features`,message:"FeatureCollection must have a features array",expected:"array of Feature objects"}))}(r,t,i):"mvt"===o?r.tileUrl||i.push({path:`${t}.tileUrl`,message:"MVT layer requires tileUrl",expected:"URL with {z}/{x}/{y} placeholders"}):"raster"===o?r.tileUrl||r.imageUrl||i.push({path:`${t}`,message:"Raster layer requires tileUrl or imageUrl",suggestion:"Provide tileUrl for XYZ tiles or imageUrl for static image overlay"}):"pmtiles"===o&&(r.pmtilesUrl||i.push({path:`${t}.pmtilesUrl`,message:"PMTiles layer requires pmtilesUrl",expected:"URL to .pmtiles file"})),r.style&&function(e,t,i,n){if("object"!=typeof e||null===e)return void i.push({path:t,message:"style must be an object",received:typeof e,expected:"object"});const r=e;void 0!==r.fillColor&&Lt(r.fillColor,`${t}.fillColor`,i,n),void 0!==r.lineColor&&Lt(r.lineColor,`${t}.lineColor`,i,n),void 0!==r.opacity&&("number"!=typeof r.opacity||r.opacity<0||r.opacity>1)&&i.push({path:`${t}.opacity`,message:"opacity must be a number between 0 and 1",received:r.opacity,expected:"number (0-1)"}),void 0!==r.pointRadius&&("number"!=typeof r.pointRadius||r.pointRadius<0)&&i.push({path:`${t}.pointRadius`,message:"pointRadius must be a positive number",received:r.pointRadius,expected:"number > 0"}),void 0!==r.lineWidth&&("number"!=typeof r.lineWidth||r.lineWidth<0)&&i.push({path:`${t}.lineWidth`,message:"lineWidth must be a positive number",received:r.lineWidth,expected:"number > 0"})}(r.style,`${t}.style`,i,n),void 0!==r.id&&"string"!=typeof r.id&&i.push({path:`${t}.id`,message:"id must be a string",received:typeof r.id,expected:"string"}),void 0!==r.tooltip&&(Array.isArray(r.tooltip)?r.tooltip.every(e=>"string"==typeof e)||i.push({path:`${t}.tooltip`,message:"tooltip array must contain only strings",expected:"string[]"}):i.push({path:`${t}.tooltip`,message:"tooltip must be an array of property names",received:typeof r.tooltip,expected:"string[]"}))}(e,`layers[${n}]`,t,i)}),{valid:0===t.length,errors:t,warnings:i}):(t.push({path:"layers",message:"layers must be an array",received:typeof n.layers,expected:"array"}),{valid:!1,errors:t,warnings:i}):(t.push({path:"layers",message:"layers array is required",expected:"array of layer configs"}),{valid:!1,errors:t,warnings:i})}function Lt(e,t,i,n){if("string"!=typeof e){if(Array.isArray(e))return e.length<3||e.length>4?void i.push({path:t,message:"Color array must have 3 (RGB) or 4 (RGBA) elements",received:`array of length ${e.length}`,expected:"[r, g, b] or [r, g, b, a]"}):e.every(e=>"number"==typeof e)?void(Math.max(...e)<=1&&e.some(e=>e>0&&e<1)&&n.push(`${t}: Color values appear to be in 0-1 range. FusedMaps expects 0-255. Will auto-convert.`)):void i.push({path:t,message:"Color array must contain only numbers",received:e.map(e=>typeof e).join(", "),expected:"numbers"});if("object"==typeof e&&null!==e){const n=e;if(!n.type)return void i.push({path:`${t}.type`,message:'Color scale must have a "type" property',expected:'"continuous" or "categorical"'});if("continuous"!==n.type&&"categorical"!==n.type)return void i.push({path:`${t}.type`,message:`Invalid color scale type: "${n.type}"`,received:n.type,expected:'"continuous" or "categorical"',suggestion:"linear"===n.type?'Did you mean "continuous"?':void 0});if(n.attr?"string"!=typeof n.attr&&i.push({path:`${t}.attr`,message:"attr must be a string (property name)",received:typeof n.attr,expected:"string"}):i.push({path:`${t}.attr`,message:'Color scale requires "attr" - the data property to map to color',suggestion:'Example: { type: "continuous", attr: "value", palette: "Viridis" }'}),void 0!==n.palette)if("string"!=typeof n.palette)i.push({path:`${t}.palette`,message:"palette must be a string",received:typeof n.palette,expected:"string"});else if(!yt.includes(n.palette)){const e=vt(n.palette);i.push({path:`${t}.palette`,message:`Unknown palette: "${n.palette}"`,received:n.palette,expected:"Valid palette name",suggestion:e?`Did you mean "${e}"?`:"Popular options: Viridis, Mint, Sunset, Bold, Prism"})}if("continuous"===n.type&&void 0!==n.domain)if(Array.isArray(n.domain)&&2===n.domain.length){const[e,r]=n.domain;"number"!=typeof e||"number"!=typeof r?i.push({path:`${t}.domain`,message:"domain values must be numbers",received:n.domain,expected:"[number, number]"}):e>=r&&i.push({path:`${t}.domain`,message:"domain[0] (min) must be less than domain[1] (max)",received:n.domain,suggestion:`Swap values: [${r}, ${e}] → [${e}, ${r}]`})}else i.push({path:`${t}.domain`,message:"domain must be [min, max] array",received:n.domain,expected:"[number, number]"});return}i.push({path:t,message:"Invalid color value",received:typeof e,expected:"string, RGB array, or color scale object",suggestion:'Examples: "#ff0000", [255, 0, 0], { type: "continuous", attr: "value", palette: "Viridis" }'})}else e.match(/^#[0-9a-f]{3,8}$/i)||e.match(/^(rgb|rgba|hsl|hsla)\s*\(/i)||function(e){return new Set(["black","white","red","green","blue","yellow","cyan","magenta","gray","grey","orange","pink","purple","brown","navy","teal","olive","maroon","aqua","fuchsia","lime","silver","transparent"]).has(e.toLowerCase())}(e)||n.push(`${t}: "${e}" may not be a valid CSS color`)}function Et(e){if(e.valid)return"Config is valid";const t=["Validation failed:"];return e.errors.forEach(e=>{t.push(`  • ${e.path||"config"}: ${e.message}`),e.suggestion&&t.push(`    → ${e.suggestion}`)}),e.warnings.length>0&&(t.push("Warnings:"),e.warnings.forEach(e=>t.push(`  ⚠ ${e}`))),t.join("\n")}let St=0;function At(e){return e&&"object"==typeof e?{...e,center:e.center?Tt(e.center):void 0,basemap:e.basemap?$t(e.basemap):void 0,layers:Array.isArray(e.layers)?e.layers.map(kt):e.layers}:e}function kt(e){return e&&"object"==typeof e?{...e,layerType:Ft(e.layerType),data:e.data?(i=e.data,n=e.layerType,i?!Array.isArray(i)||"hex"!==n&&"hexagon"!==n&&"h3"!==n?"object"!=typeof i||"FeatureCollection"!==i.type&&!i.features?i:jt(i):i.map(Pt):i):void 0,style:e.style?(t=e.style,t&&"object"==typeof t?{...t,fillColor:t.fillColor?Mt(t.fillColor):void 0,lineColor:t.lineColor?Mt(t.lineColor):void 0,strokeColor:t.strokeColor?Mt(t.strokeColor):void 0,opacity:Nt(t.opacity),pointRadius:t.pointRadius??t.radius??t.circleRadius,lineWidth:t.lineWidth??t.strokeWidth??t.width}:t):void 0,geojson:e.geojson?jt(e.geojson):void 0}:e;var t,i,n}function Ft(e){return e&&{hexagon:"hex",hexagons:"hex",h3:"hex","h3-hex":"hex","hex-layer":"hex",geojson:"vector",json:"vector",feature:"vector",features:"vector",points:"vector",point:"vector",polygons:"vector",polygon:"vector",lines:"vector",line:"vector",linestring:"vector",tiles:"mvt",tile:"mvt",vectortiles:"mvt","vector-tiles":"mvt","mapbox-vector-tiles":"mvt",image:"raster",xyz:"raster",tms:"raster",wms:"raster",pmtile:"pmtiles","pm-tiles":"pmtiles"}[e.toLowerCase().trim()]||e}function Tt(e){if(e){if(Array.isArray(e)&&e.length>=2)return[Number(e[0]),Number(e[1])];if("object"==typeof e){const t=e.lng??e.longitude??e.lon??e.x,i=e.lat??e.latitude??e.y;if(void 0!==t&&void 0!==i)return[Number(t),Number(i)]}}}function $t(e){return e?{dark:"dark","dark-v11":"dark","mapbox-dark":"dark",light:"light","light-v11":"light","mapbox-light":"light",streets:"streets","streets-v12":"streets","mapbox-streets":"streets",road:"streets",roadmap:"streets",satellite:"satellite","satellite-streets":"satellite","satellite-v9":"satellite",aerial:"satellite",none:"none",empty:"none",blank:"none",transparent:"none"}[e.toLowerCase().trim()]||e:"dark"}function Mt(e){return null==e?e:"string"==typeof e?function(e){const t=e.trim();return/^[0-9a-f]{6}$/i.test(t)||/^[0-9a-f]{3}$/i.test(t)?`#${t}`:t}(e):Array.isArray(e)?function(e){if(e.length<3)return e;return Math.max(...e.slice(0,3))<=1&&e.slice(0,3).some(e=>e>0&&e<1)?e.map((e,t)=>t<3||3===t&&e<=1?Math.round(255*e):e):e.map(e=>Math.round(e))}(e):"object"==typeof e?function(e){const t={...e};if(e.type){const i={linear:"continuous",gradient:"continuous",sequential:"continuous",discrete:"categorical",category:"categorical",categories:"categorical",qualitative:"categorical"};t.type=i[e.type.toLowerCase()]||e.type}if(e.palette){const i=vt(e.palette);i&&(t.palette=i)}if(!t.palette&&(e.colors||e.color)){const i=e.colors||e.color;if("string"==typeof i){const e=vt(i);e&&(t.palette=e)}}if(t.attr||(t.attr=e.attribute||e.field||e.property||e.column),e.domain&&!Array.isArray(e.domain)&&"object"==typeof e.domain&&void 0!==e.domain.min&&(t.domain=[e.domain.min,e.domain.max]),Array.isArray(t.domain)&&2===t.domain.length){const[e,i]=t.domain;e>i&&(t.domain=[i,e])}return t}(e):e}function Nt(e){if(null==e)return;const t=Number(e);return isNaN(t)?void 0:t>1&&t<=100?t/100:Math.max(0,Math.min(1,t))}function Pt(e){if(!e||"object"!=typeof e)return e;const t=e.h3||e.H3||e.hex||e.hexagon||e.h3_index||e.h3Index;if(t&&!e.h3){const{H3:i,hex:n,hexagon:r,h3_index:o,h3Index:a,...l}=e;return{h3:t,...l}}return e}function jt(e){return e&&"object"==typeof e?Array.isArray(e)?{type:"FeatureCollection",features:e.map(Ot)}:e.features&&!e.type?{type:"FeatureCollection",features:e.features.map(Ot)}:"Feature"===e.type?{type:"FeatureCollection",features:[Ot(e)]}:e.type&&e.coordinates?{type:"FeatureCollection",features:[{type:"Feature",geometry:e,properties:{}}]}:"FeatureCollection"===e.type?{...e,features:(e.features||[]).map(Ot)}:e:e}function Ot(e){return e&&"object"==typeof e?e.type&&e.coordinates&&!e.geometry?{type:"Feature",geometry:e,properties:{}}:e.properties?e:{...e,properties:{}}:e}let qt=null,It=null,Rt=null,Dt=0;function _t(e){qt||(qt=document.getElementById("tile-loader"),qt||(qt=document.createElement("div"),qt.id="tile-loader",qt.innerHTML='<div class="loader-spinner"></div><span id="loader-text">Loading tiles...</span>',document.body.appendChild(qt)),It=document.getElementById("loader-text")),Dt=Math.max(0,Dt+e),qt&&(Dt>0?(Rt&&(clearTimeout(Rt),Rt=null),qt.classList.add("active"),It&&(It.textContent=1===Dt?"Loading tile...":`Loading ${Dt} tiles...`)):Rt=setTimeout(()=>{qt?.classList.remove("active")},300))}const Bt={hexLayer:{name:"Simple Hex Layer",description:"H3 hexagons with continuous color scale",config:{layers:[{layerType:"hex",data:[{h3:"8928308280fffff",value:100},{h3:"8928308281fffff",value:200},{h3:"8928308283fffff",value:150}],style:{fillColor:{type:"continuous",attr:"value",palette:"Viridis"}}}]}},vectorPoints:{name:"GeoJSON Points",description:"Point markers from GeoJSON with categorical colors",config:{center:[-122.4,37.8],zoom:12,layers:[{layerType:"vector",data:{type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"Point",coordinates:[-122.41,37.78]},properties:{name:"Location A",category:"retail"}},{type:"Feature",geometry:{type:"Point",coordinates:[-122.42,37.79]},properties:{name:"Location B",category:"office"}},{type:"Feature",geometry:{type:"Point",coordinates:[-122.4,37.77]},properties:{name:"Location C",category:"retail"}}]},style:{fillColor:{type:"categorical",attr:"category",palette:"Bold"},pointRadius:8}}]}},vectorPolygons:{name:"GeoJSON Polygons",description:"Polygon regions with continuous color scale",config:{layers:[{layerType:"vector",data:{type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"Polygon",coordinates:[[[-122.5,37.7],[-122.5,37.8],[-122.4,37.8],[-122.4,37.7],[-122.5,37.7]]]},properties:{name:"Region A",population:5e4}}]},style:{fillColor:{type:"continuous",attr:"population",palette:"Sunset"},opacity:.7}}]}},staticColor:{name:"Static Color Layer",description:"Layer with a single static color (no data mapping)",config:{center:[-122.4,37.8],zoom:10,layers:[{layerType:"vector",data:{type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"Point",coordinates:[-122.4,37.8]},properties:{name:"My Point"}}]},style:{fillColor:"#3388ff",opacity:.8,pointRadius:10}}]}},multiLayer:{name:"Multiple Layers",description:"Map with multiple overlapping layers",config:{center:[-122.4,37.8],zoom:10,layers:[{id:"background",name:"Background Region",layerType:"vector",data:{type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"Polygon",coordinates:[[[-122.6,37.6],[-122.6,38],[-122.2,38],[-122.2,37.6],[-122.6,37.6]]]},properties:{}}]},style:{fillColor:"#cccccc",opacity:.3}},{id:"data-layer",name:"Data Points",layerType:"hex",data:[{h3:"8928308280fffff",metric:100},{h3:"8928308281fffff",metric:250}],style:{fillColor:{type:"continuous",attr:"metric",palette:"Magenta"}}}]}},extruded3D:{name:"3D Extruded Hexagons",description:"Hexagons with height based on data values",config:{center:[-122.4,37.8],zoom:11,layers:[{layerType:"hex",data:[{h3:"8a28308280fffff",value:100,height:500},{h3:"8a28308281fffff",value:200,height:1e3},{h3:"8a28308283fffff",value:150,height:750}],style:{fillColor:{type:"continuous",attr:"value",palette:"Sunset"},extruded:!0,elevationAttr:"height",elevationScale:1}}]}},dataFromUrl:{name:"Data from URL",description:"Load GeoJSON from external URL",config:{layers:[{layerType:"vector",dataUrl:"https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson",style:{fillColor:"#3388ff",opacity:.5,stroked:!0,lineColor:"#ffffff",lineWidth:1}}]}},rasterTiles:{name:"Raster Tile Layer",description:"XYZ raster tile overlay",config:{center:[0,20],zoom:2,layers:[{layerType:"raster",tileUrl:"https://tile.openstreetmap.org/{z}/{x}/{y}.png",opacity:.7}]}},withTooltip:{name:"Layer with Tooltip",description:"Configure which properties show in hover tooltip",config:{center:[-122.4,37.8],zoom:12,layers:[{layerType:"vector",data:{type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"Point",coordinates:[-122.4,37.8]},properties:{name:"Store #1",revenue:125e3,employees:12,category:"retail"}}]},tooltip:["name","revenue","category"],style:{fillColor:{type:"categorical",attr:"category",palette:"Bold"},pointRadius:10}}]}}};function zt(e){return Bt[e]}function Ut(){return Object.keys(Bt)}const Wt=["hex","vector","mvt","raster","pmtiles"];function Ht(e){const t=At(e),i=wt(t);if(!i.valid)return{success:!1,instance:null,state:null,errors:i.errors,warnings:i.warnings};const n=function(e){const t=e.layers.map((e,t)=>function(e,t){const i={id:e.id||"layer-"+ ++St,name:e.name||e.id||`Layer ${t+1}`,visible:!1!==e.visible,...e};switch(e.layerType){case"hex":return{...i,layerType:"hex",style:{opacity:.8,filled:!0,stroked:!0,...e.style}};case"vector":return{...i,layerType:"vector",style:{opacity:.8,filled:!0,stroked:!0,lineWidth:1,pointRadius:5,...e.style}};case"mvt":return{...i,layerType:"mvt",style:{opacity:.8,filled:!0,stroked:!0,...e.style}};case"raster":return{...i,layerType:"raster",opacity:e.opacity??1};case"pmtiles":return{...i,layerType:"pmtiles",style:{opacity:.8,filled:!0,stroked:!0,...e.style}};default:return i}}(e,t)),i=e.center?{longitude:e.center[0],latitude:e.center[1],zoom:e.zoom??10,pitch:e.pitch??0,bearing:e.bearing??0}:{longitude:0,latitude:0,zoom:1,pitch:0,bearing:0},n=function(e){const t={dark:"mapbox://styles/mapbox/dark-v11",light:"mapbox://styles/mapbox/light-v11",streets:"mapbox://styles/mapbox/streets-v12",satellite:"mapbox://styles/mapbox/satellite-streets-v12",none:"mapbox://styles/mapbox/empty-v9"};return t[e||"dark"]||t.dark}(e.basemap);return{containerId:"map",mapboxToken:e.mapboxToken||function(){if("undefined"==typeof window)return"";const e=window;return e.MAPBOX_TOKEN||e.MAPBOX_ACCESS_TOKEN||e.mapboxToken||e.mapboxAccessToken||e.mapboxgl?.accessToken||""}(),styleUrl:n,initialViewState:i,layers:t,hasCustomView:!!e.center,ui:{tooltip:!1!==e.ui?.tooltip,legend:!1!==e.ui?.legend,layerPanel:!1!==e.ui?.layerPanel,screenshot:!0,basemapSwitcher:!0}}}(t);try{const e=Jt(n);return{success:!0,instance:e,state:e.getState(),errors:[],warnings:i.warnings}}catch(e){return{success:!1,instance:null,state:null,errors:[{path:"",message:`Failed to create map: ${e.message}`,suggestion:"Check that mapboxToken is valid and container element exists"}],warnings:i.warnings}}}function Gt(e){return wt(At(e))}function Vt(){return{all:[...yt],byCategory:pt,sequential:gt("sequential"),diverging:gt("diverging"),qualitative:gt("qualitative")}}const Zt={getToolDefinition:function(){return{name:"create_map",description:'Create an interactive map with data visualization layers.\n\nSupported layer types:\n- hex: H3 hexagon grids (pass array of {h3: "index", ...props})\n- vector: GeoJSON points, lines, polygons\n- raster: Tile image overlays\n- mvt: Mapbox Vector Tiles\n- pmtiles: PMTiles format\n\nColor options:\n- Static: "#ff0000" or [255, 0, 0]\n- Continuous: { type: "continuous", attr: "fieldName", palette: "Viridis" }\n- Categorical: { type: "categorical", attr: "fieldName", palette: "Bold" }\n\nPopular palettes: Viridis, Mint, Sunset, Magenta, Bold, Prism, Safe',parameters:{type:"object",required:["layers"],properties:{center:{type:"array",items:{type:"number"},minItems:2,maxItems:2,description:"Map center [longitude, latitude]. Omit to auto-fit to data."},zoom:{type:"number",minimum:0,maximum:22,description:"Zoom level 0-22. Default: 10"},layers:{type:"array",description:"Data layers to display",items:{type:"object",required:["layerType"],properties:{id:{type:"string",description:"Unique layer ID. Auto-generated if omitted."},name:{type:"string",description:"Display name for legend/panel."},layerType:{type:"string",enum:["hex","vector","raster","mvt","pmtiles"],description:"Layer type"},data:{description:"Inline data (H3 array or GeoJSON)"},dataUrl:{type:"string",description:"URL to GeoJSON/CSV/Parquet"},style:{type:"object",properties:{fillColor:{description:"Fill color - string, RGB array, or color scale object"},lineColor:{description:"Stroke color"},opacity:{type:"number",description:"0-1, default 0.8"},pointRadius:{type:"number",description:"Point size in pixels"},lineWidth:{type:"number",description:"Stroke width in pixels"},extruded:{type:"boolean",description:"3D extrusion"},elevationAttr:{type:"string",description:"Attribute for 3D height"}}},tooltip:{type:"array",items:{type:"string"},description:"Properties to show on hover"}}}},basemap:{type:"string",enum:["dark","light","streets","satellite"],description:"Base map style. Default: dark"}}}}},getSimpleToolDefinition:function(){return{name:"create_map",description:"Create an interactive map. Pass center [lng, lat], zoom, and layers array.",parameters:{type:"object",required:["layers"],properties:{center:{type:"array",description:"[longitude, latitude] or omit to auto-fit"},zoom:{type:"number",description:"Zoom 0-22, default 10"},layers:{type:"array",items:{type:"object",required:["layerType","data"],properties:{layerType:{enum:["hex","vector"]},data:{description:"Array of {h3, ...} for hex, or GeoJSON for vector"},style:{type:"object",properties:{fillColor:{description:'"#hex" or {type:"continuous",attr:"field",palette:"Viridis"}'}}}}}}}}}},getMcpToolDefinition:function(){return{name:"fusedmaps_create_map",description:"Create an interactive geospatial map with data layers. Supports H3 hexagons, GeoJSON, and tile layers.",inputSchema:{type:"object",required:["layers"],properties:{center:{type:"array",items:{type:"number"},minItems:2,maxItems:2,description:"Map center [longitude, latitude]. Omit to auto-fit to data."},zoom:{type:"number",minimum:0,maximum:22,description:"Zoom level 0-22. Default: 10"},layers:{type:"array",description:"Data layers to display",items:{type:"object",required:["layerType"],properties:{id:{type:"string",description:"Unique layer ID. Auto-generated if omitted."},name:{type:"string",description:"Display name for legend/panel."},layerType:{type:"string",enum:["hex","vector","raster","mvt","pmtiles"],description:"Layer type"},data:{description:"Inline data (H3 array or GeoJSON)"},dataUrl:{type:"string",description:"URL to GeoJSON/CSV/Parquet"},style:{type:"object",properties:{fillColor:{description:"Fill color - string, RGB array, or color scale object"},lineColor:{description:"Stroke color"},opacity:{type:"number",description:"0-1, default 0.8"},pointRadius:{type:"number",description:"Point size in pixels"},lineWidth:{type:"number",description:"Stroke width in pixels"},extruded:{type:"boolean",description:"3D extrusion"},elevationAttr:{type:"string",description:"Attribute for 3D height"}}},tooltip:{type:"array",items:{type:"string"},description:"Properties to show on hover"}}}},basemap:{type:"string",enum:["dark","light","streets","satellite"],description:"Base map style. Default: dark"}}}}}};function Jt(i){const r=i.containerId||"map",o=i.layers.map(e=>ut(e)?ct(e):e),a={...i,layers:o},s=lt();s.init(o);try{const e="light"===i.ui?.theme?"light":"dark";document.documentElement.setAttribute("data-theme",e)}catch(e){}const p=function(e){const{containerId:t,mapboxToken:i,styleUrl:n,initialViewState:r,screenshotEnabled:o}=e;window.mapboxgl.accessToken=i;const a=new window.mapboxgl.Map({container:t,style:n,center:[r.longitude,r.latitude],zoom:r.zoom,pitch:r.pitch||0,bearing:r.bearing||0,projection:"mercator",pitchWithRotate:!0,attributionControl:!1,...o?{preserveDrawingBuffer:!0}:{}});return a.addControl(new window.mapboxgl.AttributionControl({compact:!0})),a.on("error",e=>{const t=e?.error?.message||"";t.includes("Could not load image")||t.includes("not, or is no longer, usable")||console.warn("[FusedMaps] Map error:",e?.error||e)}),a}({containerId:r,mapboxToken:i.mapboxToken,styleUrl:i.styleUrl,initialViewState:i.initialViewState,screenshotEnabled:!1!==i.ui?.screenshot}),y=i.widgets||{},g=(e,t)=>!1===e?{position:!1,expanded:!1}:"string"==typeof e?{position:e,expanded:!1}:e&&"object"==typeof e?{position:e.position??t,expanded:!0===e.expanded}:{position:t,expanded:!1},m=g(y.controls,"bottom-left"),b=g(y.scale,"bottom-left"),v=g(y.basemap,"bottom-left"),x=g(y.layers,"top-right"),C=g(y.legend,"bottom-right"),w=g(y.geocoder,!1),L=m.position,E=b.position,S=v.position,A=x.position,k=C.position,F=w.position,T=ve(p,i.initialViewState,{screenshot:!1!==i.ui?.screenshot,basemapSwitcher:!1!==i.ui?.basemapSwitcher&&!1!==S,currentStyle:i.styleUrl||"",positions:{controls:!1!==L&&L,scale:!1!==E&&E,basemap:!1!==S&&S}}),$=a.sidebar||!!a.debug?ze(p,a):null,M={current:null};let N=null,P=null;const j=()=>p.resize(),O=()=>{document.hidden||setTimeout(j,100)},q=()=>s.getVisibilityState(),I=()=>{try{return M.current?.__fused_hex_tiles__?.getTileData?.()||void 0}catch(e){return}},D=()=>{try{pe(s.getAllConfigs(),q())}catch(e){}try{ge(s.getAllConfigs(),q(),s.getAllGeoJSONs(),I())}catch(e){}},_=s.on("*",e=>{"visibility"!==e.type&&"update"!==e.type&&"batch"!==e.type||D()});let U=null;!1!==F&&(U=function(e,t){const{position:i="top-right",placeholder:n="Search location...",mapboxToken:r}=t,o="top-center"!==i;let a=document.getElementById("location-search");a||(a=document.createElement("div"),a.id="location-search",o?Q(i).appendChild(a):(document.body.appendChild(a),Object.assign(a.style,{position:"fixed",top:"12px",left:"50%",transform:"translateX(-50%)",right:"auto",bottom:"auto"}))),a.innerHTML=`\n    <input type="text" id="search-input" placeholder="${n}" autocomplete="off" />\n    <div class="search-results" id="search-results"></div>\n  `;const l=document.getElementById("search-input"),s=document.getElementById("search-results");let c=null;function d(t){const i=t.target.value.trim();if(c&&clearTimeout(c),i.length<2)return s.classList.remove("visible"),void(s.innerHTML="");c=setTimeout(()=>{!async function(t){try{const n=`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(t)}.json?access_token=${r}&limit=5`,o=await fetch(n);if(!o.ok)throw new Error("Geocoding failed");const a=await o.json();a.features&&a.features.length>0?(i=a.features,s.innerHTML=i.map(e=>{const t=e.text||e.place_name,i=e.place_name.replace(e.text+", ","").replace(e.text,"");return`\n        <div class="search-item" data-lng="${e.center[0]}" data-lat="${e.center[1]}" data-bbox="${e.bbox?e.bbox.join(","):""}">\n          <div class="place-name">${t}</div>\n          ${i?`<div class="place-context">${i}</div>`:""}\n        </div>\n      `}).join(""),s.classList.add("visible"),s.querySelectorAll(".search-item").forEach(t=>{t.addEventListener("click",()=>{const i=t,n=parseFloat(i.dataset.lng||"0"),r=parseFloat(i.dataset.lat||"0"),o=i.dataset.bbox;if(o){const[t,i,n,r]=o.split(",").map(Number);e.fitBounds([[t,i],[n,r]],{padding:50,duration:1500})}else e.flyTo({center:[n,r],zoom:12,duration:1500});l.value=i.querySelector(".place-name")?.textContent||"",s.classList.remove("visible")})})):(s.innerHTML='<div class="search-item" style="color:var(--ui-muted);">No results found</div>',s.classList.add("visible"))}catch(e){console.error("[Geocoder] Error:",e),s.classList.remove("visible")}var i}(i)},300)}function u(e){"Escape"===e.key&&(s.classList.remove("visible"),l.blur())}function p(e){e.target?.closest?.("#location-search")||s.classList.remove("visible")}return l.addEventListener("input",d),l.addEventListener("keydown",u),document.addEventListener("click",p),{destroy:function(){c&&clearTimeout(c),l.removeEventListener("input",d),l.removeEventListener("keydown",u),document.removeEventListener("click",p),a?.remove()}}}(p,{position:F,mapboxToken:i.mapboxToken}),F===A&&setTimeout(()=>{const e=document.getElementById("layer-panel");e&&(e.style.top="56px")},0)),!1!==i.ui?.legend&&!1!==k&&function(e,t,i,n="bottom-right",r,o=!1){const a=Q(n);let l=document.getElementById("color-legend");if(!l){l=document.createElement("div"),l.id="color-legend",l.className=o?"color-legend fm-dropdown-widget":"color-legend fm-dropdown-widget collapsed",l.style.display="none",l.innerHTML=`\n      <button id="legend-toggle" class="fm-dropdown-toggle" title="Legend">\n        ${fe}\n      </button>\n      <div class="fm-dropdown-panel" id="legend-dropdown">\n        <div class="fm-dropdown-header">\n          <span class="fm-dropdown-header-icon">${fe}</span>\n          <span class="fm-dropdown-title">Legend</span>\n          <button class="fm-dropdown-close" id="legend-close" title="Close"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>\n        </div>\n        <div id="legend-content"></div>\n      </div>\n    `,a.appendChild(l);const e=document.getElementById("legend-toggle");e?.addEventListener("click",e=>{e.stopPropagation();const t=l?.classList.contains("collapsed");t&&document.querySelectorAll(".fm-dropdown-widget:not(#color-legend)").forEach(e=>{e.classList.add("collapsed")}),l?.classList.toggle("collapsed")});const t=document.getElementById("legend-close");t?.addEventListener("click",e=>{e.stopPropagation(),l?.classList.add("collapsed")}),document.addEventListener("click",e=>{l?.contains(e.target)||l?.classList.add("collapsed")})}ge(e,t,i,r)}(s.getAllConfigs(),q(),s.getAllGeoJSONs(),k,void 0,C.expanded),!1!==i.ui?.layerPanel&&!1!==A&&de(s.getAllConfigs(),q(),(e,t)=>{Yt(e,t,p,s,M.current)},s,A,x.expanded);let W=null;p.on("load",()=>{const e=H(p,s.getAllConfigs(),q(),a);M.current=e.deckOverlay;const r=s.getAllConfigs().filter(e=>"mvt"===e.layerType||"raster"===e.layerType||"pmtiles"===e.layerType).map(e=>e.id);r.length>0&&(W=function(e,t){if(!t.length)return()=>{};const i=new Set(t),n=new Set,r=e=>{const t=e?.sourceId;if(t&&i.has(t)&&e?.tile&&!n.has(`${t}-${e.tile.tileID?.key}`)){const i=`${t}-${e.tile.tileID?.key||Math.random()}`;n.add(i),_t(1)}},o=e=>{const t=e?.sourceId;if(t&&i.has(t)&&e?.tile){e.tile.tileID;for(const e of n)if(e.startsWith(`${t}-`)){n.delete(e),_t(-1);break}}},a=()=>{const e=n.size;n.clear(),e>0&&_t(-e)};return e.on("sourcedataloading",r),e.on("sourcedata",o),e.on("idle",a),()=>{e.off("sourcedataloading",r),e.off("sourcedata",o),e.off("idle",a);const t=n.size;n.clear(),t>0&&_t(-t)}}(p,r));const o=B();Object.entries(o).forEach(([e,t])=>{s.setGeoJSON(e,t)}),D(),N=()=>{ge(s.getAllConfigs(),q(),s.getAllGeoJSONs(),I())};try{window.addEventListener("fusedmaps:legend:update",N)}catch(e){}if(!1!==i.ui?.tooltip&&function(e,t,i,n){const r={current:n};let o=document.getElementById("tooltip");o||(o=document.createElement("div"),o.id="tooltip",document.body.appendChild(o));const a=[];t.forEach(e=>{if(e.isTileLayer)return;const t=[];"hex"===e.layerType?((e.hexLayer||{}).extruded?t.push(`${e.id}-extrusion`):t.push(`${e.id}-fill`),t.push(`${e.id}-outline`)):"vector"===e.layerType?t.push(`${e.id}-fill`,`${e.id}-outline`,`${e.id}-circle`,`${e.id}-line`):"mvt"===e.layerType?t.push(`${e.id}-fill`,`${e.id}-line`,`${e.id}-extrusion`):e.layerType,t.forEach(t=>{a.push({layerId:t,layerDef:e})})}),e.on("mousemove",i=>{const n=[...a];try{const i=e.getStyle?.()?.layers||[];for(const e of t){if("pmtiles"!==e.layerType)continue;const t=`${e.id}-`;for(const r of i){const i=r?.id;"string"==typeof i&&i.startsWith(t)&&n.push({layerId:i,layerDef:e})}}}catch(e){}const l=n.map(e=>e.layerId).filter(t=>e.getLayer(t)),s=e=>{const i=t.findIndex(t=>t.id===e);return-1===i?Number.POSITIVE_INFINITY:i};let c=null,d=Number.POSITIVE_INFINITY;if(l.length){const t=e.queryRenderedFeatures(i.point,{layers:l});for(const e of t||[]){const t=n.find(t=>t.layerId===e.layer?.id);if(!t)continue;const i=s(t.layerDef.id);i<d&&(d=i,c={type:"mapbox",layerDef:t.layerDef,props:e.properties||{}});break}}const u=r.current;if(u){let e=null;const n=u.__fused_hex_tiles__;if(n?.getHoverInfo&&(e=n.getHoverInfo()),!e?.object)try{"function"==typeof u.pickObject&&(e=u.pickObject({x:i.point.x,y:i.point.y,radius:4}))}catch(e){}if(e?.object){const i=String(e.layer?.id||""),n=i.includes("-tiles")?i.split("-tiles")[0]:i.split("-")[0],r=t.find(e=>e.id===n)||t.find(e=>i.startsWith(e.id));if(r){const t=s(r.id);t<d&&(d=t,c={type:"deck",layerDef:r,props:e.object.properties||e.object||{}})}}}if(!c)return o.style.display="none",void(e.getCanvas().style.cursor="");e.getCanvas().style.cursor="pointer";const p=function(e){const t=e;if("hex"===e.layerType){const i=e;return i.hexLayer?.tooltipColumns||i.hexLayer?.tooltipAttrs||i.tooltipColumns||t.tooltip||[]}if("vector"===e.layerType){const i=e;return i.vectorLayer?.tooltipColumns||i.vectorLayer?.tooltipAttrs||i.tooltipColumns||t.tooltip||[]}return"pmtiles"===e.layerType?t.vectorLayer?.tooltipColumns||t.vectorLayer?.tooltipAttrs||t.tooltipColumns||t.tooltip||[]:t.tooltipColumns||t.tooltip||[]}(c.layerDef),y=function(e,t,i){const n=[];if(null!=e.hex&&n.push(`<span class="tt-row"><span class="tt-key">hex</span><span class="tt-val">${String(e.hex).slice(0,12)}...</span></span>`),t.length)return t.forEach(t=>{if("hex"===t)return;const i=e[t];if(null==i)return;const r="number"==typeof i?me(i):String(i);n.push(`<span class="tt-row"><span class="tt-key">${t}</span><span class="tt-val">${r}</span></span>`)}),n;if("hex"===i?.layerType){const t=i,r=t.hexLayer?.getFillColor?.attr||"metric";if(null!=e[r]){const t=e[r],i="number"==typeof t?me(t):String(t);return n.push(`<span class="tt-row"><span class="tt-key">${r}</span><span class="tt-val">${i}</span></span>`),n}}return 0===n.length&&Object.keys(e).filter(e=>"hex"!==e&&"properties"!==e).slice(0,5).forEach(t=>{const i=e[t];if(null==i)return;const r="number"==typeof i?me(i):String(i);n.push(`<span class="tt-row"><span class="tt-key">${t}</span><span class="tt-val">${r}</span></span>`)}),n}(c.props,p,c.layerDef);y.length?(o.innerHTML=`<strong class="tt-title">${c.layerDef.name}</strong>`+y.join(""),o.style.left=`${i.point.x+10}px`,o.style.top=`${i.point.y+10}px`,o.style.display="block"):o.style.display="none"}),e.on("mouseleave",()=>{e.getCanvas().style.cursor="",o.style.display="none"})}(p,s.getAllConfigs(),q(),M.current),!1!==i.highlightOnClick&&function(e,t,i,n){window.__fusedHighlightByProperties=i=>{!function(e,t,i){if(!i||0===Object.keys(i).length)return;const n=He(e,t);if(!n.length)return;let r=[];try{r=e.queryRenderedFeatures(void 0,{layers:n})||[]}catch(e){return}const o=["Field Name","field_name","name","id","ID","fid","FID","OBJECTID"];for(const t of r){const n=t.properties||{};for(const r of o)if(void 0!==i[r]&&void 0!==n[r]&&String(i[r])===String(n[r]))return void Ge(e,t);let r=!0;for(const[e,t]of Object.entries(i))if(void 0!==n[e]&&String(n[e])!==String(t)){r=!1;break}if(r&&Object.keys(i).length>0&&Object.keys(i).some(e=>void 0!==n[e]))return void Ge(e,t)}}(e,t,i)},window.__fusedHighlightClear=()=>{Ge(e,null)},e.on("click",i=>{const r=He(e,t);if(!r.length)return;let o=[];try{o=e.queryRenderedFeatures(i.point,{layers:r})||[]}catch(e){}if(o.length>0)Ge(e,o[0]);else if(n){const t=n?.pickObject?.({x:i.point.x,y:i.point.y,radius:4});t?.object?Ge(e,{properties:t.object.properties||t.object,geometry:null}):We&&Ge(e,null)}else We&&Ge(e,null)})}(p,s.getAllConfigs(),q(),M.current),i.messaging&&Ye(p,i.messaging,s.getAllConfigs(),M.current),P=function(e,t,i,r){const o=(t.layers||[]).filter(nt);if(!o.length)return null;try{it={};for(const e of o)it[e.id]=e.name||e.id}catch(e){}try{tt||(tt=rt())}catch(e){}const a=new et;let s=!1;const c=async(t,o)=>{if(!s){ot(t.id,"initializing...");try{if(await a.init(),s)return;try{const e=t.hexLayer?.getFillColor,i=e&&"object"==typeof e&&!Array.isArray(e)?e.attr:null,n=e&&"object"==typeof e&&!Array.isArray(e)&&(!0===e.autoDomain||!Array.isArray(e.domain));if(i&&n&&!0!==t.fillDomainFromUser){const e=await a.getMinMax(t,String(i));e&&t.hexLayer&&"object"==typeof t.hexLayer.getFillColor&&!Array.isArray(t.hexLayer.getFillColor)&&(t.hexLayer.getFillColor.domain=[e.min,e.max])}}catch(e){}t.sql=o||t.sql||"SELECT * FROM data";try{const e=t.sql||"SELECT * FROM data",i=!0===t.fillDomainFromUser,n=t.hexLayer?.getFillColor;if(!i&&n&&"object"==typeof n&&!Array.isArray(n)&&"colorContinuous"===n["@@function"]){const i=String(n.attr||"");if(i&&!0===n.autoDomain){const r=await a.getMinMaxFromQuery(t,i,e);r&&(n.domain=[r.min,r.max])}}const r=t.hexLayer?.getLineColor;if(!i&&r&&"object"==typeof r&&!Array.isArray(r)&&"colorContinuous"===r["@@function"]){const i=String(r.attr||"");if(i&&!0===r.autoDomain){const n=await a.getMinMaxFromQuery(t,i,e);n&&(r.domain=[n.min,n.max])}}}catch(e){}ot(t.id,"running...");const c=await a.runSqlGeoJSON(t,t.sql||"SELECT * FROM data");if(s)return;if(!c?.geojson)throw new Error("DuckDB GeoJSON path unavailable (requires spatial + h3 extensions and compatible columns).");const u=c.geojson;z(t.id,u);const p=!1!==i[t.id],y=function(e,t,i){try{const n=e.getSource(t);if(n&&"function"==typeof n.setData)return n.setData(i),!0}catch(e){}return!1}(e,t.id,u);if(!y)try{d(e,t,u,p)}catch(e){}!function(e,t){const i=t.hexLayer||{},r=t.data||[],o=Array.isArray(i.getFillColor)?n(i.getFillColor,.8):l(i.getFillColor,r)||"rgba(0,144,255,0.7)",a=i.getLineColor?Array.isArray(i.getLineColor)?n(i.getLineColor,1):l(i.getLineColor,r):"rgba(255,255,255,0.3)",s="number"==typeof i.opacity&&isFinite(i.opacity)?Math.max(0,Math.min(1,i.opacity)):.8;try{i.extruded&&e.getLayer(`${t.id}-extrusion`)&&(e.setPaintProperty(`${t.id}-extrusion`,"fill-extrusion-color",o),e.setPaintProperty(`${t.id}-extrusion`,"fill-extrusion-opacity",s))}catch(e){}try{!i.extruded&&e.getLayer(`${t.id}-fill`)&&(e.setPaintProperty(`${t.id}-fill`,"fill-color",o),e.setPaintProperty(`${t.id}-fill`,"fill-opacity",s))}catch(e){}try{e.getLayer(`${t.id}-outline`)&&(e.setPaintProperty(`${t.id}-outline`,"line-color",a),e.setPaintProperty(`${t.id}-outline`,"line-width",i.lineWidthMinPixels||.5))}catch(e){}}(e,t),ot(t.id,`${(c.count||0).toLocaleString()} rows`),function(){try{window.dispatchEvent(new Event("fusedmaps:legend:update"))}catch(e){}}();try{r?.()}catch(e){}}catch(e){ot(t.id,`error: ${(e?.message||"query failed").slice(0,60)}`)}}};(async()=>{for(const e of o){if(s)break;const t=(e.sql||"SELECT * FROM data").trim();await c(e,t)}})();const u=e=>{const t=e?.detail||{},i=String(t.layerId||""),n=String(t.sql||""),r=o.find(e=>e.id===i);r&&c(r,n)};try{window.addEventListener("fusedmaps:sql:update",u)}catch(e){}return{destroy:()=>{s=!0;try{window.removeEventListener("fusedmaps:sql:update",u)}catch(e){}}}}(p,a,q(),()=>{const e=B();Object.entries(e).forEach(([e,t])=>{s.setGeoJSON(e,t)}),D()}),!i.hasCustomView){!function(e,t,i){const n=new mapboxgl.LngLatBounds,r=i.getAllGeoJSONs();t.forEach(e=>{if(e.isTileLayer)return;if("raster"===e.layerType){const t=e.imageBounds;if(Array.isArray(t)&&4===t.length){const[e,i,r,o]=t;[e,i,r,o].every(e=>"number"==typeof e&&Number.isFinite(e))&&(n.extend([e,i]),n.extend([r,o]))}return}const t=r[e.id];t?.features?.length&&t.features.forEach(e=>{"Point"===e.geometry?.type?n.extend(e.geometry.coordinates):"Polygon"===e.geometry?.type||"MultiPolygon"===e.geometry?.type?("Polygon"===e.geometry.type?[e.geometry.coordinates]:e.geometry.coordinates).forEach(e=>e[0]?.forEach(e=>n.extend(e))):"LineString"===e.geometry?.type&&e.geometry.coordinates.forEach(e=>n.extend(e))})}),n.isEmpty()||e.fitBounds(n,{padding:50,maxZoom:15,duration:500})}(p,s.getAllConfigs(),s);try{const e=()=>{try{const e=t(p);T?.setHomeViewState?.(e)}catch(e){}try{p.off("moveend",e)}catch(e){}};p.on("moveend",e)}catch(e){}}p.on("style.load",()=>{try{const e=H(p,s.getAllConfigs(),q(),a);M.current=e.deckOverlay;const t=B();Object.entries(t).forEach(([e,t])=>{s.setGeoJSON(e,t)}),s.getAllConfigs().forEach(e=>{if("hex"===e.layerType&&!e.isTileLayer&&(e.parquetUrl||e.parquetData))try{window.dispatchEvent(new CustomEvent("fusedmaps:sql:update",{detail:{layerId:e.id,sql:e.sql||"SELECT * FROM data"}}))}catch(e){}}),D()}catch(e){console.warn("[style.load] Error re-adding layers:",e)}})}),p.on("load",()=>{[100,500,1e3].forEach(e=>setTimeout(j,e))}),window.addEventListener("resize",j),document.addEventListener("visibilitychange",O);const X=()=>{const e=t(p);let i;try{const e=p.getBounds();i={west:e.getWest(),south:e.getSouth(),east:e.getEast(),north:e.getNorth()}}catch(e){}const n=s.getAllGeoJSONs();return{viewState:e,...i?{bounds:i}:{},layers:s.getAll().map(e=>{const t=e.config,i=Array.isArray(t.tooltipColumns)?t.tooltipColumns:Array.isArray(t.hexLayer?.tooltipColumns)?t.hexLayer.tooltipColumns:Array.isArray(t.hexLayer?.tooltipAttrs)?t.hexLayer.tooltipAttrs:Array.isArray(t.vectorLayer?.tooltipColumns)?t.vectorLayer.tooltipColumns:Array.isArray(t.vectorLayer?.tooltipAttrs)?t.vectorLayer.tooltipAttrs:void 0;let r;try{const t=n[e.config.id],i=t?.features?.[0],o=i?.properties;o&&"object"==typeof o&&(r=Object.keys(o).slice(0,200))}catch(e){}return{id:e.config.id,name:e.config.name,layerType:e.config.layerType,visible:e.visible,order:e.order,...r?{propertyKeys:r}:{},...i?{tooltipColumns:i}:{}}})}},K={map:p,get deckOverlay(){return M.current},store:s,getState:X,dispatch:t=>{const i=Array.isArray(t)?t:[t];for(const t of i)if(t&&"object"==typeof t)switch(t.type){case"setViewState":{const i=t.viewState||{},n=Number.isFinite(t.options?.duration)?t.options.duration:null;if(n&&n>0)try{p.easeTo({...i,duration:n});break}catch(e){}e(p,i);break}case"fitBounds":{const e=t.bounds;if(Array.isArray(e)&&4===e.length){const[i,n,r,o]=e,a=t.options||{};try{p.fitBounds([[i,n],[r,o]],{padding:Number.isFinite(a.padding)?a.padding:50,maxZoom:Number.isFinite(a.maxZoom)?a.maxZoom:15,duration:Number.isFinite(a.duration)?a.duration:500})}catch(e){}}break}case"setLayerVisibility":Yt(t.layerId,!!t.visible,p,s,M.current);break;case"updateLayer":{const e=t.layerId,i=t.changes||{};try{K.updateLayer(e,i)}catch(e){}break}case"addLayer":try{K.addLayer(t.layer,t.options)}catch(e){}break;case"removeLayer":try{K.removeLayer(t.layerId)}catch(e){}break;case"moveLayerUp":try{K.moveLayerUp(t.layerId)}catch(e){}break;case"moveLayerDown":try{K.moveLayerDown(t.layerId)}catch(e){}break;case"updateLegend":try{ge(s.getAllConfigs(),q(),s.getAllGeoJSONs(),I())}catch(e){}}return X()},setLayerVisibility:(e,t)=>{Yt(e,t,p,s,M.current)},updateLegend:()=>{ge(s.getAllConfigs(),q(),s.getAllGeoJSONs(),I())},addLayer:(e,t)=>{const i=function(e){return e&&"object"==typeof e?e.id&&"string"==typeof e.id?e.layerType&&Wt.includes(e.layerType)?{valid:!0}:{valid:!1,error:`Layer config must have a valid layerType: ${Wt.join(", ")}`}:{valid:!1,error:"Layer config must have a string id"}:{valid:!1,error:"Layer config must be an object"}}(e);if(!i.valid)return console.warn("[FusedMaps] addLayer:",i.error),null;const n=ut(e)?ct(e):e,r=s.add(n,t);try{G(p,r.config,r.visible,a)}catch{const e=H(p,s.getAllConfigs(),q(),a);M.current=e.deckOverlay}return D(),r},removeLayer:e=>{if(!e||"string"!=typeof e)return console.warn("[FusedMaps] removeLayer: layerId must be a non-empty string"),!1;const t=s.get(e)?.config,i=s.remove(e);if(i){try{t&&V(p,t)}catch{const e=H(p,s.getAllConfigs(),q(),a);M.current=e.deckOverlay}D()}return i},updateLayer:(e,t)=>{if(!e||"string"!=typeof e)return console.warn("[FusedMaps] updateLayer: layerId must be a non-empty string"),null;if(!t||"object"!=typeof t)return console.warn("[FusedMaps] updateLayer: changes must be an object"),null;const i=s.get(e)?.config,r=s.update(e,t);if(r){if((1!==Object.keys(t).length||!Object.prototype.hasOwnProperty.call(t,"visible"))&&i){const e=function(e,t,i,r){if(!t||!i)return!1;if(t.id!==i.id)return!1;if(t.layerType!==i.layerType)return!1;const o=i.id;if("raster"===i.layerType){const n=t,a=i;if(n.tileUrl!==a.tileUrl||n.imageUrl!==a.imageUrl||JSON.stringify(n.imageBounds)!==JSON.stringify(a.imageBounds))return!1;const l=a.opacity??a.rasterLayer?.opacity??1;return Z(e,`${o}-raster`,"raster-opacity",Math.max(0,Math.min(1,l))),h(e,o,r),!0}if("vector"===i.layerType){const n=t,a=i;if(n.isFilled!==a.isFilled||n.isStroked!==a.isStroked||n.tileUrl!==a.tileUrl||n.sourceLayer!==a.sourceLayer)return!1;if(a.geojson&&!Y(e,o,a.geojson)&&!e.getSource(o))return!1;const s=a.geojson,c=s?.features?.map(e=>e.properties||{})||[],d=a.fillColorConfig?.["@@function"]?l(a.fillColorConfig,c):a.fillColorRgba||"rgba(0,144,255,0.6)",u=a.lineColorConfig?.["@@function"]?l(a.lineColorConfig,c):a.lineColorRgba||"rgba(100,100,100,0.8)",p="number"==typeof a.lineWidth&&isFinite(a.lineWidth)?a.lineWidth:1,y="number"==typeof a.opacity&&isFinite(a.opacity)?Math.max(0,Math.min(1,a.opacity)):.8,g="number"==typeof a.pointRadius&&isFinite(a.pointRadius)?a.pointRadius:6;return Z(e,`${o}-fill`,"fill-color",d),Z(e,`${o}-fill`,"fill-opacity",y),Z(e,`${o}-outline`,"line-color",u),Z(e,`${o}-outline`,"line-width",p),Z(e,`${o}-line`,"line-color",u),Z(e,`${o}-line`,"line-width",p),Z(e,`${o}-line`,"line-opacity",1),Z(e,`${o}-circle`,"circle-radius",g),Z(e,`${o}-circle`,"circle-color",d),Z(e,`${o}-circle`,"circle-opacity",.9),Z(e,`${o}-circle`,"circle-stroke-color",u),Z(e,`${o}-circle`,"circle-stroke-width",1),f(e,o,r),!0}if("hex"===i.layerType){const a=t,s=i;if(s.isTileLayer)return!1;if(a.hexLayer?.extruded!==s.hexLayer?.extruded||a.hexLayer?.filled!==s.hexLayer?.filled||a.hexLayer?.stroked!==s.hexLayer?.stroked)return!1;const d=s.data&&Array.isArray(s.data)?c(s.data):null;if(d&&!Y(e,o,d)&&!e.getSource(o))return!1;const p=s.hexLayer||{},y=s.data||[],f=Array.isArray(p.getFillColor)?n(p.getFillColor,.8):l(p.getFillColor,y)||"rgba(0,144,255,0.7)",g=p.getLineColor?Array.isArray(p.getLineColor)?n(p.getLineColor,1):l(p.getLineColor,y):"rgba(255,255,255,0.3)",m="number"==typeof p.opacity&&isFinite(p.opacity)?Math.max(0,Math.min(1,p.opacity)):.8;Z(e,`${o}-fill`,"fill-color",f),Z(e,`${o}-fill`,"fill-opacity",m),Z(e,`${o}-outline`,"line-color",g),Z(e,`${o}-outline`,"line-width",p.lineWidthMinPixels||.5);const h=p.elevationScale||1,b=p.elevationProperty||p.getFillColor?.attr||null;return Z(e,`${o}-extrusion`,"fill-extrusion-color",f),Z(e,`${o}-extrusion`,"fill-extrusion-height",b?["*",["to-number",["get",b],0],h]:100),Z(e,`${o}-extrusion`,"fill-extrusion-opacity",m),u(e,o,r,!0===p.extruded),!0}if("mvt"===i.layerType){const n=t,a=i;if(n.tileUrl!==a.tileUrl||n.sourceLayer!==a.sourceLayer||n.isExtruded!==a.isExtruded||n.isFilled!==a.isFilled)return!1;const s=a.fillColorConfig?.["@@function"]?l(a.fillColorConfig,void 0):a.fillColor||"#FFF5CC",c=a.lineColorConfig?.["@@function"]?l(a.lineColorConfig,void 0):a.lineColor||"#FFFFFF",d=a.fillOpacity??.8,u=a.lineWidth??1;return Z(e,`${o}-fill`,"fill-color",s),Z(e,`${o}-fill`,"fill-opacity",d),Z(e,`${o}-line`,"line-color",c),Z(e,`${o}-line`,"line-width",u),e.getLayer(`${o}-extrusion`)&&(Z(e,`${o}-extrusion`,"fill-extrusion-color",s),Z(e,`${o}-extrusion`,"fill-extrusion-height",["*",["get",a.heightProperty||"height"],a.heightMultiplier||1]),Z(e,`${o}-extrusion`,"fill-extrusion-opacity",a.extrusionOpacity??.9)),f(e,o,r),!0}if("pmtiles"===i.layerType){const n=t,a=i;if(n.pmtilesUrl!==a.pmtilesUrl||n.pmtilesPath!==a.pmtilesPath||JSON.stringify(n.excludeSourceLayers||[])!==JSON.stringify(a.excludeSourceLayers||[])||n.sourceLayer!==a.sourceLayer||n.renderPoints!==a.renderPoints||n.renderLines!==a.renderLines||n.renderPolygons!==a.renderPolygons)return!1;const l=a.vectorLayer||{},s=a.fillOpacity??l.opacity??.8,c=a.lineWidth??1,d=a.pointRadiusMinPixels??4,u=!1!==a.isFilled,p=!1!==a.isStroked?c:0,y=u?s:0,f=a.colorAttribute||"value",g=R(a.fillColorConfig||l.getFillColor,f,"#ff8c00"),m=R(a.lineColorConfig||l.getLineColor,f,"#ffffff"),h=`${o}-`,b=e.getStyle()?.layers||[];for(const t of b){const i=t?.id;i&&i.startsWith(h)&&(i.endsWith("-fill")?(Z(e,i,"fill-color",g),Z(e,i,"fill-opacity",y)):i.endsWith("-line")?(Z(e,i,"line-color",m),Z(e,i,"line-width",p),Z(e,i,"line-opacity",s)):i.endsWith("-circles")&&(Z(e,i,"circle-radius",["interpolate",["exponential",2],["zoom"],0,.5*d,10,d,15,4*d,20,20*d]),Z(e,i,"circle-color",g),Z(e,i,"circle-opacity",y),Z(e,i,"circle-stroke-color",m),Z(e,i,"circle-stroke-width",p)),J(e,i,"visibility",r?"visible":"none"))}return!0}return!1}(p,i,r.config,r.visible);if(!e)try{V(p,i),G(p,r.config,r.visible,a)}catch{const e=H(p,s.getAllConfigs(),q(),a);M.current=e.deckOverlay}}D()}return r},getLayer:e=>s.get(e),getLayers:()=>s.getAll(),moveLayerUp:e=>{s.moveUp(e);const t=H(p,s.getAllConfigs(),q(),a);M.current=t.deckOverlay},moveLayerDown:e=>{s.moveDown(e);const t=H(p,s.getAllConfigs(),q(),a);M.current=t.deckOverlay},destroy:()=>{try{window.removeEventListener("resize",j)}catch{}try{document.removeEventListener("visibilitychange",O)}catch{}try{N&&window.removeEventListener("fusedmaps:legend:update",N)}catch{}try{_()}catch{}try{M.current?.__fused_hex_tiles__?.destroy?.()}catch{}try{T?.destroy?.()}catch{}try{$?.destroy?.()}catch{}try{P?.destroy?.()}catch{}try{U?.destroy?.()}catch{}try{W?.()}catch{}p.remove?.()}};return K}function Yt(e,t,i,n,r){n.setVisible(e,t);const o=n.getVisibilityState();let a;!function(e,t,i,n,r,o){const a=n.find(e=>e.id===t);if(a)switch(a.layerType){case"hex":{const n=a;if(n.isTileLayer){const e=r?.__fused_hex_tiles__;try{e?.rebuild?.(o)}catch(e){}}else u(e,t,i,!0===n.hexLayer?.extruded);break}case"vector":case"mvt":f(e,t,i);break;case"raster":h(e,t,i);break;case"pmtiles":!function(e,t,i){const n=`${t}-`,r=e.getStyle()?.layers||[];for(const t of r){const r=t?.id;if(r&&r.startsWith(n))try{e.setLayoutProperty(r,"visibility",i?"visible":"none")}catch(e){}}}(e,t,i)}}(i,e,t,n.getAllConfigs(),r,o);try{a=r?.__fused_hex_tiles__?.getTileData?.()||void 0}catch(e){}pe(n.getAllConfigs(),o),ge(n.getAllConfigs(),o,n.getAllGeoJSONs(),a)}"undefined"!=typeof window&&(window.FusedMaps={init:Jt,createMap:Ht,validate:Gt,formatErrors:Et,getPalettes:Vt,getPaletteColors:bt,getPaletteInfo:mt,suggestPalette:ht,schema:Zt,examples:Bt,getExample:zt,listExamples:Ut});var Xt={init:Jt,createMap:Ht,validate:Gt,formatErrors:Et,getPalettes:Vt,getPaletteColors:bt,getPaletteInfo:mt,suggestPalette:ht,schema:Zt,examples:Bt,getExample:zt,listExamples:Ut};export{at as LayerStore,lt as createLayerStore,Ht as createMap,Xt as default,Bt as examples,Et as formatErrors,zt as getExample,bt as getPaletteColors,mt as getPaletteInfo,Vt as getPalettes,Jt as init,Ut as listExamples,Zt as schema,ht as suggestPalette,Gt as validate};
//# sourceMappingURL=fusedmaps.esm.js.map
