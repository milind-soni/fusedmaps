!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).FusedMaps={})}(this,function(e){"use strict";function t(e,t){const n=window.cartocolor;if(!n)return null;const i=n[e];if(!i)return null;const a=Object.keys(i).map(Number).filter(e=>!isNaN(e)).sort((e,t)=>e-t),o=a.find(e=>e>=t)||a[a.length-1];return i[o]?[...i[o]]:null}function n(e,t){if(!Array.isArray(e)||e.length<3)return null;const[n,i,a]=e;return`rgba(${n},${i},${a},${e.length>=4?e[3]/255:t??1})`}const i=["#e0f3db","#ccebc5","#a8ddb5","#7bccc4","#4eb3d3","#2b8cbe","#0868ac","#084081"],a=["#7F3C8D","#11A579","#3969AC","#F2B701","#E73F74","#80BA5A","#E68310","#008695","#CF1C90","#f97b72"];function o(e,n){if(!e)return null;if(Array.isArray(e))return null;if("string"==typeof e)return e;const i=e["@@function"],o=e.attr;return i&&o?"colorCategories"===i?function(e,n){let i=e.categories?e.categories.map(e=>"object"==typeof e?e:{value:e,label:String(e)}):function(e,t,n){const i=new Map;return(e||[]).forEach(e=>{const a=e?.[t]??e?.properties?.[t];if(null!=a&&""!==a&&"null"!==a&&!i.has(a)){const t=n?e?.[n]??e?.properties?.[n]??a:a;i.set(a,String(t))}}),[...i.entries()].sort((e,t)=>"number"==typeof e[0]&&"number"==typeof t[0]?e[0]-t[0]:String(e[0]).localeCompare(String(t[0]))).map(([e,t])=>({value:e,label:t}))}(n,e.attr,e.labelAttr);if(!i.length)return"rgba(128,128,128,0.5)";let o=t(e.colors||"Bold",Math.max(i.length,3));o&&o.length||(o=a);const r=e.nullColor?`rgb(${e.nullColor.slice(0,3).join(",")})`:"rgba(128,128,128,0.5)",l=["match",["get",e.attr]];return i.forEach((e,t)=>{l.push(e.value),l.push(o[t%o.length])}),l.push(r),e._detectedCategories=i,l}(e,n):"colorContinuous"===i?function(e){if(!e.domain?.length)return null;const[n,i]=e.domain,a=n>i,o=a?[i,n]:[n,i],r=e.steps||7;let l=t(e.colors||"TealGrn",r);if(!l||!l.length)return["interpolate",["linear"],["get",e.attr],o[0],"rgb(237,248,251)",o[1],"rgb(0,109,44)"];a&&l.reverse();const s=["interpolate",["linear"],["get",e.attr]];return l.forEach((e,t)=>{const n=o[0]+(o[1]-o[0])*t/(l.length-1);s.push(n),s.push(e)}),s}(e):null:null}function r(e){if(null==e)return null;try{if("string"==typeof e){const t=e.startsWith("0x")?e.slice(2):e;return/^\d+$/.test(t)?BigInt(t).toString(16):(/[a-f]/i.test(t),t.toLowerCase())}if("number"==typeof e)return BigInt(Math.trunc(e)).toString(16);if("bigint"==typeof e)return e.toString(16)}catch(e){}return null}function l(e){const t=[];for(const n of e){const e=r(n.hex??n.h3??n.index??n.id);if(e&&window.h3?.isValidCell(e))try{const i=window.h3.cellToBoundary(e).map(([e,t])=>[t,e]);i.push(i[0]),t.push({type:"Feature",properties:{...n,hex:e},geometry:{type:"Polygon",coordinates:[i]}})}catch(e){}}return{type:"FeatureCollection",features:t}}function s(e,t,i,a){const r=t.hexLayer||{},l=t.data||[];try{const n=e.getSource(t.id);n&&"function"==typeof n.setData?n.setData(i):n||e.addSource(t.id,{type:"geojson",data:i})}catch(e){}const s=Array.isArray(r.getFillColor)?n(r.getFillColor,.8):o(r.getFillColor,l)||"rgba(0,144,255,0.7)",c=r.getLineColor?Array.isArray(r.getLineColor)?n(r.getLineColor,1):o(r.getLineColor,l):"rgba(255,255,255,0.3)",d="number"==typeof r.opacity&&isFinite(r.opacity)?Math.max(0,Math.min(1,r.opacity)):.8;if(r.extruded){const n=r.elevationScale||1;e.addLayer({id:`${t.id}-extrusion`,type:"fill-extrusion",source:t.id,paint:{"fill-extrusion-color":s,"fill-extrusion-height":r.getFillColor?.attr?["*",["get",r.getFillColor.attr],n]:100,"fill-extrusion-base":0,"fill-extrusion-opacity":d},layout:{visibility:a?"visible":"none"}})}else!1!==r.filled&&e.addLayer({id:`${t.id}-fill`,type:"fill",source:t.id,paint:{"fill-color":s,"fill-opacity":d},layout:{visibility:a?"visible":"none"}});!1!==r.stroked&&e.addLayer({id:`${t.id}-outline`,type:"line",source:t.id,paint:{"line-color":c,"line-width":r.lineWidthMinPixels||.5},layout:{visibility:a?"visible":"none"}})}let c=null;function d(){return window.deck||null}function u(e){if(!e)return null;if(Array.isArray(e))return e;if("string"==typeof e&&e.startsWith("@@=")){const t=e.slice(3);return e=>{try{return new Function("object",`const properties = object?.properties || object || {}; return (${t});`)(e)}catch{return null}}}if("object"==typeof e&&e["@@function"]){const n=e["@@function"],i=e.attr;if(!i)return null;if("colorContinuous"===n){const n=e.domain;if(!Array.isArray(n)||n.length<2)return null;const a=Number(n[0]),o=Number(n[n.length-1]);if(!Number.isFinite(a)||!Number.isFinite(o)||a===o)return null;const r=Math.max(2,Number(e.steps??7)),l=t(e.colors||"ArmyRose",r)||null;if(!l?.length)return null;const s=a>o,c=!!e.reverse,d=(s?!c:c)?[...l].reverse():[...l],u=Math.min(a,o),y=Math.max(a,o),p=Array.isArray(e.nullColor)?e.nullColor:[184,184,184];return e=>{const t=(e?.properties||e||{})[i];let n=null;if("number"==typeof t)n=t;else if("string"==typeof t){const e=parseFloat(t);n=Number.isFinite(e)?e:null}if(null==n||!Number.isFinite(n))return p;const a=(n-u)/(y-u),o=Math.max(0,Math.min(d.length-1,Math.round(a*(d.length-1)))),r=d[o].replace("#","");return[parseInt(r.slice(0,2),16),parseInt(r.slice(2,4),16),parseInt(r.slice(4,6),16)]}}if("colorCategories"===n){const n=Array.isArray(e.categories)?e.categories:Array.isArray(e.domain)?e.domain:[],a=t(e.colors||"Bold",Math.max(n.length,3))||null,o=Array.isArray(e.nullColor)?e.nullColor:[184,184,184],r=new Map;return a?.length&&n.length&&n.forEach((e,t)=>{const n=a[t%a.length]||"#999999",i=String(n).replace("#",""),o=parseInt(i.slice(0,2),16),l=parseInt(i.slice(2,4),16),s=parseInt(i.slice(4,6),16);r.set(String(e),[o,l,s])}),e=>{const t=(e?.properties||e||{})[i];return null==t?o:r.get(String(t))||o}}}return null}function y(e,t,n){const i=Math.PI-2*Math.PI*t/Math.pow(2,n),a=e/Math.pow(2,n)*360-180,o=180/Math.PI*Math.atan(Math.sinh(i)),r=Math.PI-2*Math.PI*(t+1)/Math.pow(2,n),l=(e+1)/Math.pow(2,n)*360-180;return{west:a,south:180/Math.PI*Math.atan(Math.sinh(r)),east:l,north:o}}function p(e,t){return!(e.east<t.west||e.west>t.east||e.north<t.south||e.south>t.north)}function g(e){const t=e.hexLayer?.getFillColor;if(!t||"object"!=typeof t||Array.isArray(t))return{enabled:!1,attr:null};if("colorContinuous"!==t["@@function"])return{enabled:!1,attr:null};const n=t.attr||null;if(!n)return{enabled:!1,attr:null};if(!0===e.fillDomainFromUser||!0===t.fillDomainFromUser)return{enabled:!1,attr:n};const i=Array.isArray(t.domain)&&t.domain.length>=2;return{enabled:!0===t.autoDomain||!i,attr:n}}function m(e){if(null==e)return null;if("number"==typeof e)return Number.isFinite(e)?e:null;if("bigint"==typeof e){const t=Number(e);return Number.isFinite(t)?t:null}if("string"==typeof e){const t=parseFloat(e);return Number.isFinite(t)?t:null}return null}function f(e,t,n,i,a){return function(e,t,n,i){if(e.getZoom()<10)return null;const a=t.tileStats[n.id];if(!a)return null;const o=e.getBounds(),r={west:o.getWest(),east:o.getEast(),south:o.getSouth(),north:o.getNorth()};let l=Number.POSITIVE_INFINITY,s=Number.NEGATIVE_INFINITY,c=0;for(const[e,t]of Object.entries(a)){const[n,a,o]=e.split("/").map(Number);Number.isFinite(n)&&Number.isFinite(a)&&Number.isFinite(o)&&(Math.abs(n-i)>1||p(y(a,o,n),r)&&(Number.isFinite(t.min)&&(l=Math.min(l,t.min),c++),Number.isFinite(t.max)&&(s=Math.max(s,t.max))))}if(c<2||!Number.isFinite(l)||!Number.isFinite(s))return null;const d=s-l;if(Number.isFinite(d)&&d>0){const e=.01*d;l-=e,s+=e}return l>=s?[l-1,s+1]:[l,s]}(e,t,n,a)}function h(e,t){const n=e.hexLayer?.getFillColor;if(!n||"object"!=typeof n)return!1;const i=n._dynamicDomain;return!!(!Array.isArray(i)||i.length<2||(()=>{const e=i[1]-i[0]?i[1]-i[0]:1;return Math.abs(t[0]-i[0])/e>.05||Math.abs(t[1]-i[1])/e>.05})())&&(n._dynamicDomain=t,!0)}function b(e){const t=e.tileLayerConfig||{};return{tileSize:t.tileSize??256,minZoom:t.minZoom??0,maxZoom:t.maxZoom??19,zoomOffset:t.zoomOffset??0,maxRequests:t.maxRequests??10,refinementStrategy:t.refinementStrategy??"best-available"}}function v(e,t,n,i){const a=d();if(!a)return[];const o=a.TileLayer,l=a.H3HexagonLayer||a?.GeoLayers?.H3HexagonLayer;return o&&l?e.filter(e=>"hex"===e.layerType&&e.isTileLayer&&e.tileUrl).map(e=>e).filter(e=>!1!==t[e.id]).slice().reverse().map(e=>{const t=e.tileUrl,a=b(e),s=e.hexLayer||{},d=s.getFillColor,y=d&&"object"==typeof d&&!Array.isArray(d)&&Array.isArray(d._dynamicDomain)?{...d,domain:d._dynamicDomain}:d,p=s.getLineColor,f=p&&"object"==typeof p&&!Array.isArray(p)&&Array.isArray(p._dynamicDomain)?{...p,domain:p._dynamicDomain}:p,h=u(y),v=u(f),w=function(e){let t=5381;for(let n=0;n<e.length;n++)t=(t<<5)+t^e.charCodeAt(n);return(t>>>0).toString(16)}(`${JSON.stringify({fd:y&&"object"==typeof y?y.domain||y._dynamicDomain:null,ld:f&&"object"==typeof f?f.domain||f._dynamicDomain:null})}|${JSON.stringify({f:y,l:f,stroked:!1!==s.stroked,filled:!1!==s.filled,extruded:!0===s.extruded,opacity:s.opacity,elevationScale:s.elevationScale,coverage:s.coverage,lineWidthMinPixels:s.lineWidthMinPixels})}`),C=!1!==s.stroked,x=!1!==s.filled,E=!0===s.extruded,L="number"==typeof s.opacity?s.opacity:.8,S=s.lineWidthMinPixels??1,F=s.elevationScale??1,$=s.coverage??.9,T=g(e),A=a.refinementStrategy||(T.enabled?"no-overlap":"best-available");return new o({id:`${e.id}-tiles-${w}`,data:t,tileSize:a.tileSize,minZoom:a.minZoom,maxZoom:a.maxZoom,zoomOffset:a.zoomOffset,maxRequests:a.maxRequests,refinementStrategy:A,pickable:!0,visible:!0,getTileData:async({index:a,signal:o})=>{const{x:l,y:s,z:d}=a,u=t.replace("{z}",d).replace("{x}",l).replace("{y}",s),y=u,p=`${d}/${l}/${s}`;if(n.cache.has(y))return n.cache.get(y);if(n.inflight.has(y))try{return await n.inflight.get(y)}catch{return n.cache.get(y)||[]}i(1);const f=(async()=>{try{const i=await fetch(u,{signal:o});if(o?.aborted)return null;if(!i.ok)throw new Error(`tile http ${i.status}`);const l=(i.headers.get("Content-Type")||"").toLowerCase();let s,d=null;if(l.includes("application/octet-stream")||l.includes("application/parquet")||u.endsWith(".parquet")){let e=window.hyparquet;if(!e?.parquetMetadataAsync||!e?.parquetReadObjects)try{e=await async function(){const e=window;return e.hyparquet?.parquetMetadataAsync&&e.hyparquet?.parquetReadObjects?e.hyparquet:c||(c=(async()=>{const t=await new Function("u","return import(u)")("https://cdn.jsdelivr.net/npm/hyparquet@1.23.3/+esm"),n=t?.default&&(t.default.parquetReadObjects||t.default.parquetMetadataAsync)?t.default:t;return e.hyparquet=n,e.hyparquet})().catch(e=>{throw c=null,e}),c)}()}catch(e){return console.error("[tiles] failed to auto-load hyparquet",e),null}const t=await i.arrayBuffer();if(o?.aborted)return null;if(!t||0===t.byteLength)return[];const n={byteLength:t.byteLength,slice:async(e,n)=>t.slice(e,n)},a=await e.parquetMetadataAsync(n);if(d=a,o?.aborted)return null;s=await e.parquetReadObjects({file:n,utf8:!1,metadata:a})}else{let e=await i.text();if(o?.aborted)return null;e=e.replace(/\"(hex|h3|index|id)\"\s*:\s*(\d+)/gi,(e,t,n)=>`"${t}":"${n}"`),s=JSON.parse(e)}const f=(a=s,t=(Array.isArray(a)?a:Array.isArray(a?.data)?a.data:Array.isArray(a?.features)?a.features:[]).map(e=>e?.properties?{...e.properties}:{...e}).map(e=>{const t=r(e.hex??e.h3??e.index??e.id);if(!t)return null;const n={...e,hex:t};return{...n,properties:{...n}}}).filter(Boolean),(t||[]).map(e=>{const t=function(e){const t={};for(const n of Object.keys(e||{})){const i=e[n];if("bigint"==typeof i){const e=String(n).toLowerCase();"hex"===e||"h3"===e||"index"===e||"id"===e?t[n]=i.toString(16):i<=BigInt(Number.MAX_SAFE_INTEGER)&&i>=BigInt(Number.MIN_SAFE_INTEGER)?t[n]=Number(i):t[n]=i.toString()}else t[n]=i}return t}(e?.properties?e.properties:e||{});return{...t,properties:{...t}}}));n.cache.set(y,f);try{const t=g(e);if(t.enabled&&t.attr&&d){const i=function(e,t){const n=e?.row_groups||e?.rowGroups||e?.row_groups_list||null;if(!Array.isArray(n)||0===n.length)return null;let i=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY,o=!1;for(const e of n){const n=e?.columns||e?.columns_list||null;if(Array.isArray(n))for(const e of n){const n=e?.meta_data||e?.metaData||e?.metadata||null,r=n?.path_in_schema||n?.pathInSchema||n?.path||null,l=Array.isArray(r)?String(r[r.length-1]):"string"==typeof r?r:null;if(!l||l!==t)continue;const s=n?.statistics||n?.stats||e?.statistics||null;if(!s)continue;const c=m(s.min_value??s.min??s.minimum??s.minValue),d=m(s.max_value??s.max??s.maximum??s.maxValue);null!=c&&null!=d&&(o=!0,c<i&&(i=c),d>a&&(a=d))}}return o&&Number.isFinite(i)&&Number.isFinite(a)?i===a?{min:i-1,max:a+1}:{min:i,max:a}:null}(d,t.attr);if(i){n.tileStats[e.id]||(n.tileStats[e.id]={}),n.tileStats[e.id][p]={min:i.min,max:i.max};try{window.dispatchEvent(new CustomEvent("fusedmaps:autodomain:dirty"))}catch{}}}}catch(e){}return f}catch(e){return null}finally{n.inflight.delete(y),i(-1)}var t,a})();return n.inflight.set(y,f),await f},renderSubLayers:e=>{const t=e.data||[];return t&&t.length?new l({id:`${e.id}-h3`,data:t,getHexagon:e=>e.hex,pickable:!0,stroked:C,filled:x,extruded:E,opacity:L,coverage:$,lineWidthMinPixels:S,elevationScale:F,...h?{getFillColor:h}:{},...v?{getLineColor:v}:{}}):null}})}):[]}const w={};function C(){return w}function x(e,t,n,i){!function(e,t){t.forEach(t=>{[`${t.id}-fill`,`${t.id}-extrusion`,`${t.id}-outline`,`${t.id}-circle`,`${t.id}-line`,`${t.id}-raster`].forEach(t=>{try{e.getLayer(t)&&e.removeLayer(t)}catch(e){}});try{e.getSource(t.id)&&e.removeSource(t.id)}catch(e){}})}(e,t),[...t].reverse().forEach(t=>{const i=!1!==n[t.id];switch(t.layerType){case"hex":{const n=t;if(n.isTileLayer);else if(n.data?.length){const a=l(n.data);w[t.id]=a,s(e,n,a,i)}break}case"vector":{const n=t;n.geojson&&(w[t.id]=n.geojson,function(e,t,n){const i=t.geojson;if(!i?.features?.length)return;e.addSource(t.id,{type:"geojson",data:i});const a=i.features.map(e=>e.properties||{}),r=t.fillColorConfig?.["@@function"]?o(t.fillColorConfig,a):t.fillColorRgba||"rgba(0,144,255,0.6)",l=t.lineColorConfig?.["@@function"]?o(t.lineColorConfig,a):t.lineColorRgba||"rgba(100,100,100,0.8)",s="number"==typeof t.lineWidth&&isFinite(t.lineWidth)?t.lineWidth:1,c="number"==typeof t.opacity&&isFinite(t.opacity)?Math.max(0,Math.min(1,t.opacity)):.8;let d=!1,u=!1,y=!1;for(const e of i.features){const t=e.geometry?.type;"Point"!==t&&"MultiPoint"!==t||(u=!0),"Polygon"!==t&&"MultiPolygon"!==t||(d=!0),"LineString"!==t&&"MultiLineString"!==t||(y=!0)}d&&(!1!==t.isFilled&&e.addLayer({id:`${t.id}-fill`,type:"fill",source:t.id,paint:{"fill-color":r,"fill-opacity":c},filter:["any",["==",["geometry-type"],"Polygon"],["==",["geometry-type"],"MultiPolygon"]],layout:{visibility:n?"visible":"none"}}),!1!==t.isStroked&&e.addLayer({id:`${t.id}-outline`,type:"line",source:t.id,layout:{"line-join":"round","line-cap":"round",visibility:n?"visible":"none"},paint:{"line-color":l,"line-width":s},filter:["any",["==",["geometry-type"],"Polygon"],["==",["geometry-type"],"MultiPolygon"]]})),y&&e.addLayer({id:`${t.id}-line`,type:"line",source:t.id,layout:{"line-join":"round","line-cap":"round",visibility:n?"visible":"none"},paint:{"line-color":l,"line-width":s,"line-opacity":1},filter:["any",["==",["geometry-type"],"LineString"],["==",["geometry-type"],"MultiLineString"]]}),u&&e.addLayer({id:`${t.id}-circle`,type:"circle",source:t.id,paint:{"circle-radius":t.pointRadius||6,"circle-color":r,"circle-stroke-color":"rgba(0,0,0,0.5)","circle-stroke-width":1,"circle-opacity":.9},filter:["any",["==",["geometry-type"],"Point"],["==",["geometry-type"],"MultiPoint"]],layout:{visibility:n?"visible":"none"}})}(e,n,i));break}case"mvt":!function(e,t,n){const i=t.sourceLayer||"udf";e.addSource(t.id,{type:"vector",tiles:[t.tileUrl],minzoom:t.minzoom||0,maxzoom:t.maxzoom||22});const a=t.fillColor||"#FFF5CC",o=t.lineColor||"#FFFFFF",r=t.fillOpacity??.8,l=t.lineWidth??1;!1!==t.isFilled&&e.addLayer({id:`${t.id}-fill`,type:"fill",source:t.id,"source-layer":i,paint:{"fill-color":a,"fill-opacity":r},layout:{visibility:n?"visible":"none"}}),e.addLayer({id:`${t.id}-line`,type:"line",source:t.id,"source-layer":i,paint:{"line-color":o,"line-width":l},layout:{visibility:n?"visible":"none"}}),t.isExtruded&&e.addLayer({id:`${t.id}-extrusion`,type:"fill-extrusion",source:t.id,"source-layer":i,paint:{"fill-extrusion-color":a,"fill-extrusion-height":["*",["get",t.heightProperty||"height"],t.heightMultiplier||1],"fill-extrusion-base":0,"fill-extrusion-opacity":t.extrusionOpacity??.9},layout:{visibility:n?"visible":"none"}})}(e,t,i);break;case"raster":!function(e,t,n){const i=t.opacity??t.rasterLayer?.opacity??1;e.addSource(t.id,{type:"raster",tiles:[t.tileUrl],tileSize:256}),e.addLayer({id:`${t.id}-raster`,type:"raster",source:t.id,paint:{"raster-opacity":Math.max(0,Math.min(1,i))},layout:{visibility:n?"visible":"none"}})}(e,t,i)}});let a=null;if(t.some(e=>"hex"===e.layerType&&e.isTileLayer&&e.tileUrl)){const i=function(e,t,n){const i=d();if(!i?.MapboxOverlay||!i?.TileLayer)return null;const a={cache:new Map,inflight:new Map,tilesLoading:0,tileStats:{}},o=function(){let e=document.getElementById("tile-loader");e||(e=document.createElement("div"),e.id="tile-loader",e.innerHTML='<div class="loader-spinner"></div><span id="loader-text">Loading tiles...</span>',document.body.appendChild(e));const t=document.getElementById("loader-text");let n=null,i=0;return{setLoading:a=>{i=Math.max(0,i+a),e&&(i>0?(n&&clearTimeout(n),e.classList.add("active"),t&&(t.textContent=1===i?"Loading tile...":`Loading ${i} tiles...`)):n=setTimeout(()=>e?.classList.remove("active"),300))}}}(),r=()=>v(t,n,a,o.setLoading),l=new i.MapboxOverlay({interleaved:!0,useDevicePixels:!0,layers:r()});try{e.addControl(l)}catch{}const s=()=>{try{l.setProps({layers:r()});try{e.triggerRepaint?.()}catch{}}catch{}},c=t.filter(e=>"hex"===e.layerType&&e.isTileLayer).map(e=>({layer:e,...g(e),tileCfg:b(e)})).filter(e=>e.enabled&&e.attr);let u=null;const y=t=>{c.length&&(u&&clearTimeout(u),u=setTimeout(()=>{let t=!1;for(const n of c){const i=Math.round(e.getZoom())+(n.tileCfg.zoomOffset||0),o=f(e,a,n.layer,n.attr,i);o&&h(n.layer,o)&&(t=!0)}if(t){s();try{window.dispatchEvent(new CustomEvent("fusedmaps:legend:update"))}catch{}}},t))},p=()=>y(800),m=()=>y(1200),w=()=>y(150);if(c.length){e.on("moveend",p),e.on("idle",m);try{window.addEventListener("fusedmaps:autodomain:dirty",w)}catch{}y(1500)}return{overlay:l,rebuild:s,pickObject:e=>{try{return l.pickObject(e)}catch{return null}},destroy:()=>{u&&clearTimeout(u);try{e.off("moveend",p)}catch{}try{e.off("idle",m)}catch{}try{window.removeEventListener("fusedmaps:autodomain:dirty",w)}catch{}try{e.removeControl(l)}catch{}}}}(e,t,n);a=i?.overlay||null,a&&i&&(a.__fused_hex_tiles__=i)}return{deckOverlay:a}}let E=null,L=[],S={},F=!1;function $(e,i){L=e,S=i;const a=document.getElementById("layer-list");a&&(a.innerHTML=e.map(e=>{const a=!1!==i[e.id],o=function(e){let i="#0090ff";const a=e=>e&&e.length?1===e.length?e[0]:`linear-gradient(to bottom, ${e.map((t,n)=>`${t} ${n/(e.length-1)*100}%`).join(", ")})`:null;if("hex"===e.layerType){const o=e.hexLayer||{},r=!1===o.filled&&o.getLineColor?o.getLineColor:o.getFillColor;if(Array.isArray(r)){const e=n(r,1);e&&(i=e)}else if(r&&"object"==typeof r){const e=r["@@function"];if("colorContinuous"===e||"colorCategories"===e){let n=t(r.colors||("colorCategories"===e?"Bold":"TealGrn"),r.steps||7);if(n?.length){const e=r.domain,t=Array.isArray(e)&&e.length>=2&&e[0]>e[e.length-1],o=!!r.reverse;(t?!o:o)&&(n=[...n].reverse()),i=a(n)||i}}}}else if("vector"===e.layerType){const n=e;if(n.lineColorRgba&&!n.isFilled)i=n.lineColorRgba;else if(n.fillColorRgba)i=n.fillColorRgba;else if(n.fillColorConfig&&"object"==typeof n.fillColorConfig){const e=n.fillColorConfig.colors;if(e){const n=t(e,7);n?.length&&(i=a(n)||i)}}}else"raster"===e.layerType&&(i="linear-gradient(to bottom, #888, #444)");return i}(e),r=a?'<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>':'<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/></svg>';return`\n      <div class="layer-item ${a?"":"disabled"}" \n           data-layer-id="${e.id}" \n           style="--layer-strip: ${o};" \n           onclick="onLayerItemClick(event, '${e.id}')">\n        <span class="layer-name">${e.name}</span>\n        <span class="layer-eye" onclick="event.stopPropagation(); toggleLayerVisibility('${e.id}', ${!a})">${r}</span>\n      </div>\n    `}).join(""))}function T(e,n,o){const r=document.getElementById("color-legend");if(!r)return;const l=e.filter(e=>!1!==n[e.id]);if(!l.length)return void(r.style.display="none");let s="";l.forEach(e=>{const n=function(e){let n=null;if("hex"===e.layerType){const t=e.hexLayer||{};n=!1===t.filled&&t.getLineColor?t.getLineColor:t.getFillColor}else if("vector"===e.layerType){const t=e;if(n=t.fillColorConfig,!n?.["@@function"]&&t.lineColorRgba&&!t.isFilled)return`\n        <div class="legend-layer">\n          <div class="legend-title">\n            <span class="legend-line" style="background:${t.lineColorRgba};"></span>\n            ${e.name}\n          </div>\n        </div>\n      `}const o=n?.["@@function"];if(!o||!n?.attr)return"";if("colorContinuous"!==o&&"colorCategories"!==o)return"";const r=n.colors||("colorCategories"===o?"Bold":"TealGrn");return"colorCategories"===o?function(e,n,i){let o=n._detectedCategories||n.categories||[];if(o=o.map(e=>"object"==typeof e&&e.label?e:{value:e,label:e}),!o.length)return"";let r=t(i,Math.max(o.length,3));r?.length||(r=a);const l=n.labelAttr||n.attr;return`\n    <div class="legend-layer">\n      <div class="legend-title">\n        <span class="legend-dot" style="background:${r[0]};"></span>\n        ${e}: ${l}\n      </div>\n      <div class="legend-categories">\n        ${o.map((e,t)=>`\n          <div class="legend-cat-item">\n            <div class="legend-cat-swatch" style="background:${r[t%r.length]};"></div>\n            <span class="legend-cat-label" title="${e.label}">${e.label}</span>\n          </div>\n        `).join("")}\n      </div>\n    </div>\n  `}(e.name,n,r):"colorContinuous"===o?function(e,n,a){const o=n._dynamicDomain||n.domain;if(!o?.length)return"";const[r,l]=o,s=r>l;let c=t(a,n.steps||7);c?.length||(c=i),s&&(c=[...c].reverse());const d=`linear-gradient(to right, ${c.map((e,t)=>`${e} ${t/(c.length-1)*100}%`).join(", ")})`;return`\n    <div class="legend-layer">\n      <div class="legend-title">\n        <span class="legend-dot" style="background:${c[Math.floor(c.length/2)]};"></span>\n        ${e}: ${n.attr}\n      </div>\n      <div class="legend-gradient" style="background:${d};"></div>\n      <div class="legend-labels">\n        <span>${r.toFixed(1)}</span>\n        <span>${l.toFixed(1)}</span>\n      </div>\n    </div>\n  `}(e.name,n,r):""}(e);n&&(s+=n)}),s?(r.innerHTML=s,r.style.display="block"):r.style.display="none"}function A(e,t,n){class i{onAdd(e){this._map=e;const i=document.createElement("div");i.className="mapboxgl-ctrl mapboxgl-ctrl-group";const a=(e,t,n)=>{const i=document.createElement("button");return i.type="button",i.title=t,i.setAttribute("aria-label",t),i.style.fontSize="16px",i.style.lineHeight="20px",i.style.fontWeight="600",i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="center",i.textContent=e,i.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation();try{n()}catch(e){}}),i};return i.appendChild(a("+","Zoom in",()=>e.zoomIn({duration:250}))),i.appendChild(a("−","Zoom out",()=>e.zoomOut({duration:250}))),i.appendChild(a("⌂","Reset view",()=>{e.easeTo({center:[t.longitude,t.latitude],zoom:Number.isFinite(t.zoom)?t.zoom:e.getZoom(),pitch:Number.isFinite(t.pitch??0)?t.pitch??0:e.getPitch(),bearing:Number.isFinite(t.bearing??0)?t.bearing??0:e.getBearing(),duration:600})})),n&&i.appendChild(((t,n)=>{const i=document.createElement("button");return i.type="button",i.title=n,i.setAttribute("aria-label",n),i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="center",i.innerHTML='<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" style="display:block">\n              <path d="M4 8h3l1.2-2h7.6L17 8h3a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2z"/>\n              <circle cx="12" cy="14" r="3.2"/>\n            </svg>',i.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation();try{!function(e){const t=`map-screenshot-${(new Date).toISOString().replace(/[:.]/g,"-")}.png`;try{const n=e.getCanvas(),i=document.createElement("a");if(i.download=t,"function"==typeof n.toBlob)return void n.toBlob(e=>{try{if(!e)throw new Error("toBlob returned null");const t=URL.createObjectURL(e);i.href=t,document.body.appendChild(i),i.click(),i.remove(),setTimeout(()=>URL.revokeObjectURL(t),1e3)}catch(e){console.error("Screenshot failed:",e),alert("Screenshot blocked (likely due to CORS/tainted canvas from raster tiles). Try using only CORS-enabled layers/tiles.")}},"image/png");const a=n.toDataURL("image/png");i.href=a,document.body.appendChild(i),i.click(),i.remove()}catch(e){console.error("Screenshot failed:",e),alert("Screenshot blocked (likely due to CORS/tainted canvas from raster tiles). Try using only CORS-enabled layers/tiles.")}}(e)}catch(e){}}),i})(0,"Download screenshot")),this._container=i,i}onRemove(){try{this._container?.parentNode?.removeChild(this._container)}catch(e){}this._map=void 0,this._container=void 0}}try{e.addControl(new i,"bottom-left")}catch(e){}}function I(e,t,n){!function(e){try{e.addControl(new mapboxgl.ScaleControl({maxWidth:110,unit:"metric"}),"bottom-left")}catch(e){}}(e),A(e,t,n);const i=function(e){const t=e.getCanvasContainer?.()||e.getCanvas?.();if(!t)return()=>{};let n=!1,i=0,a=0,o=0,r=0;const l=()=>{if(n){n=!1;try{e.dragPan.enable()}catch(e){}try{t.style.cursor=""}catch(e){}window.removeEventListener("pointermove",s,{passive:!1}),window.removeEventListener("pointerup",c,{passive:!1}),window.removeEventListener("pointercancel",c,{passive:!1})}},s=t=>{if(!n)return;if(!t.metaKey)return l();const s=t.clientX-i,c=t.clientY-a;var d;e.setBearing(o+.35*s),e.setPitch((d=r-.25*c,Math.max(0,Math.min(85,d)))),t.preventDefault()},c=e=>{l();try{e.preventDefault()}catch(e){}},d=l=>{if(0===l.button&&l.ctrlKey&&!l.metaKey)return l.preventDefault(),void l.stopPropagation();if(!n&&0===l.button&&l.metaKey){n=!0,i=l.clientX,a=l.clientY,o=e.getBearing(),r=e.getPitch();try{e.dragPan.disable()}catch(e){}try{t.style.cursor="grabbing"}catch(e){}window.addEventListener("pointermove",s,{passive:!1}),window.addEventListener("pointerup",c,{passive:!1}),window.addEventListener("pointercancel",c,{passive:!1}),l.stopPropagation(),l.preventDefault()}};return t.addEventListener("pointerdown",d,{passive:!1,capture:!0}),()=>{try{l()}catch(e){}try{t.removeEventListener("pointerdown",d,{capture:!0})}catch(e){}}}(e);return{destroy:()=>{try{i()}catch(e){}}}}function N(e,t){try{return Number.isFinite(e)?e.toFixed(t):""}catch{return""}}function M(e,t,n){try{const i=t.getBoundingClientRect().width||280;e.style.setProperty("--debug-panel-w",`${i}px`);const a=t.classList.contains("collapsed");n.style.left=a?"0px":`var(--debug-panel-w, ${i}px)`}catch(e){}}function k(e,t,n){return Math.max(t,Math.min(n,e))}function B(e){return e&&"object"==typeof e?"colorContinuous"!==e["@@function"]?null:e:null}function _(e){const t=new Set;try{const n=e.hexLayer?.getFillColor,i=e.hexLayer?.getLineColor;n?.attr&&t.add(String(n.attr)),i?.attr&&t.add(String(i.attr));const a=e.hexLayer?.tooltipAttrs;Array.isArray(a)&&a.forEach(e=>t.add(String(e)))}catch(e){}return[...t].filter(Boolean)}function j(e){try{const t=e.geojson?.features?.[0],n=t?.properties||{};return Object.keys(n||{}).filter(e=>e&&"_fused_idx"!==e)}catch(e){return[]}}function R(e,t,n,i){try{e.getLayer(t)&&e.setPaintProperty(t,n,i)}catch(e){}}let q=!1,P=null;function D(e,t){let n={type:"FeatureCollection",features:[]};if(t){const e=t.properties||{},i=e.hex||e.h3;if(i&&window.h3)try{const t=r(i);if(t&&window.h3.isValidCell(t)){const i=window.h3.cellToBoundary(t).map(([e,t])=>[t,e]);i.push(i[0]),n.features.push({type:"Feature",geometry:{type:"Polygon",coordinates:[i]},properties:e})}}catch(e){}else t.geometry&&n.features.push({type:"Feature",geometry:t.geometry,properties:e})}q?e.getSource("feature-hl").setData(n):(e.addSource("feature-hl",{type:"geojson",data:n}),e.addLayer({id:"feature-hl-fill",type:"fill",source:"feature-hl",paint:{"fill-color":"rgba(255,255,0,0.3)","fill-opacity":1}}),e.addLayer({id:"feature-hl-line",type:"line",source:"feature-hl",paint:{"line-color":"rgba(255,255,0,1)","line-width":3}}),q=!0),P=t}function O(e){let t=null,n=null;try{"BroadcastChannel"in window&&(t=new BroadcastChannel(e))}catch(e){}function i(e){if(!n)return;let t;try{t="string"==typeof e.data?JSON.parse(e.data):e.data}catch{return}n(t)}return{send:function(e){const n=JSON.stringify(e);try{t&&t.postMessage(e)}catch(e){}try{window.parent.postMessage(n,"*")}catch(e){}try{window.top&&window.top!==window.parent&&window.top.postMessage(n,"*")}catch(e){}try{if(window.top?.frames)for(let e=0;e<window.top.frames.length;e++){const t=window.top.frames[e];if(t!==window)try{t.postMessage(n,"*")}catch(e){}}}catch(e){}},onMessage:function(e){n=e,t&&(t.onmessage=e=>{n&&n(e.data)}),window.addEventListener("message",i)},destroy:function(){t&&(t.close(),t=null),window.removeEventListener("message",i),n=null}}}function z(e="component"){return`${e}-${Math.random().toString(36).substr(2,9)}`}function W(e,t,n){t.broadcast?.enabled&&function(e,t={}){const n=t.channel||"fused-bus",i=t.dataset||"all",a=z("map-broadcast"),o=O(n);let r=null;function l(){const t=function(e){const t=e.getBounds();return[+t.getWest().toFixed(6),+t.getSouth().toFixed(6),+t.getEast().toFixed(6),+t.getNorth().toFixed(6)]}(e);if(l=r,(n=t)&&l&&n[0]===l[0]&&n[1]===l[1]&&n[2]===l[2]&&n[3]===l[3])return;var n,l;r=t;const[s,c,d,u]=t;o.send({type:"filter",fromComponent:a,timestamp:Date.now(),dataset:i,filter:{type:"spatial",field:"geometry",values:[s,c,d,u]}}),o.send({type:"spatial_filter",source:a,timestamp:Date.now(),bounds:{sw:{lng:s,lat:c},ne:{lng:d,lat:u}}})}e.on("move",l),e.on("moveend",l),e.on("load",()=>{setTimeout(l,300)}),e.loaded()&&setTimeout(l,100),setTimeout(()=>{o.send({type:"component_ready",componentType:"map",componentId:a,capabilities:["spatial_filter"],dataSource:"viewport",protocol:"unified"})},200)}(e,{channel:t.broadcast.channel,dataset:t.broadcast.dataset}),t.sync?.enabled&&function(e,t={}){let n=t.channel||"default";n.includes("::")||(n=`map-sync::${n}`);const i=z("map"),a=O(n);let o=!1,r=!1,l={x:NaN,y:NaN,z:NaN};const s=(e,t,n)=>Math.abs(e-t)<n;function c(){const t=e.getCenter();return{longitude:+t.lng.toFixed(6),latitude:+t.lat.toFixed(6),zoom:+e.getZoom().toFixed(3),bearing:+e.getBearing().toFixed(1),pitch:+e.getPitch().toFixed(1),id:i,ts:Date.now()}}function d(){if(o)return;const e=c(),{longitude:t,latitude:n,zoom:i}=e;s(t,l.x,1e-6)&&s(n,l.y,1e-6)&&s(i,l.z,.001)||(l={x:t,y:n,z:i},a.send({type:"sync",...e}))}let u=null;const y=()=>{r=!0},p=()=>{r&&(r=!1,d())};e.on("dragstart",y),e.on("zoomstart",y),e.on("rotatestart",y),e.on("pitchstart",y),e.on("moveend",p),e.on("move",()=>{r&&!o&&(u&&clearTimeout(u),u=setTimeout(d,0))}),a.onMessage(t=>{var n;"sync"===t.type&&t.id!==i&&(n=t)&&n.id!==i&&(o||r||(o=!0,e.jumpTo({center:[n.longitude,n.latitude],zoom:n.zoom,bearing:n.bearing,pitch:n.pitch}),requestAnimationFrame(()=>{o=!1})))}),e.on("load",()=>{setTimeout(()=>a.send({type:"sync",...c()}),100+100*Math.random())}),document.addEventListener("visibilitychange",()=>{document.hidden&&(o=!1,r=!1)})}(e,{channel:t.sync.channel}),t.clickBroadcast,t.locationListener}const H="1.33.1-dev13.0",U=new Map;function V(e){return/^[A-Za-z_][A-Za-z0-9_]*$/.test(e)}class Z{constructor(e){this.duck=null,this.db=null,this.conn=null,this.tableByLayerId=new Map,this.loadedTables=new Set,this.hasSpatial=!1,this.version=e?.version||H}get ready(){return!!this.conn}async init(){if(this.conn)return;this.duck=await async function(e=H){const t=U.get(e);if(t)return t;const n=import(`https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@${e}/+esm`);return U.set(e,n),n}(this.version);const e=this.duck,t=await e.selectBundle(e.getJsDelivrBundles()),n=await(await fetch(t.mainWorker)).text(),i=new Worker(URL.createObjectURL(new Blob([n],{type:"application/javascript"}))),a=new e.AsyncDuckDB(new e.ConsoleLogger,i);await a.instantiate(t.mainModule);const o=await a.connect();try{await o.query("INSTALL h3 FROM community")}catch(e){}try{await o.query("LOAD h3")}catch(e){}try{await o.query("INSTALL spatial")}catch(e){}try{await o.query("LOAD spatial"),this.hasSpatial=!0}catch(e){this.hasSpatial=!1}this.db=a,this.conn=o}layerTableName(e){const t=this.tableByLayerId.get(e.id);if(t)return t;const n=e.id.replace(/-/g,"_");return this.tableByLayerId.set(e.id,n),n}async ensureLayerTable(e){if(await this.init(),!this.db||!this.conn)throw new Error("DuckDB not initialized");const t=this.layerTableName(e);if(this.loadedTables.has(t))return t;let n=null;if(e.parquetData)n=function(e){const t=atob(e),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n}(e.parquetData);else if(e.parquetUrl){const t=await fetch(e.parquetUrl);if(!t.ok)throw new Error(`Failed to fetch parquetUrl (${t.status})`);const i=await t.arrayBuffer();n=new Uint8Array(i)}if(!n)throw new Error("Missing parquetData or parquetUrl for SQL layer");return await this.db.registerFileBuffer(`${t}.parquet`,n),await this.conn.query(`CREATE OR REPLACE TABLE ${t} AS SELECT * FROM read_parquet('${t}.parquet')`),this.loadedTables.add(t),t}async runSql(e,t){if(await this.ensureLayerTable(e),!this.conn)throw new Error("DuckDB not initialized");const n=this.layerTableName(e);await this.conn.query(`CREATE OR REPLACE VIEW data AS SELECT * FROM ${n}`);const i=(t||"").trim(),a=/^(with|select)\b/i.test(i)?i:`SELECT * FROM data WHERE (${i||"1=1"})`,o=(await this.conn.query(a)).toArray().map(e=>function(e){const t=new Set(["hex","h3","index","id"]),n={};for(const i of Object.keys(e)){let a=e[i];"bigint"==typeof a&&(a=t.has(i.toLowerCase())?a.toString(16):Number(a)),n[i]=a}const i=r(n.hex??n.h3??n.index??n.id);return i&&(n.hex=i),n}(e)).filter(e=>!!e.hex);return{rows:o,count:o.length}}async getMinMaxFromQuery(e,t,n){if(await this.ensureLayerTable(e),!this.conn)return null;const i=this.layerTableName(e);await this.conn.query(`CREATE OR REPLACE VIEW data AS SELECT * FROM ${i}`);const a=(n||"").trim(),o=/^(with|select)\b/i.test(a)?a:`SELECT * FROM data WHERE (${a||"1=1"})`,r=`"${String(t).replace(/"/g,'""')}"`,l=(await this.conn.query(`SELECT MIN(${r}) as min_val, MAX(${r}) as max_val FROM (${o}) AS q`)).toArray()[0];if(!l)return null;let s=l.min_val,c=l.max_val;return"bigint"==typeof s&&(s=Number(s)),"bigint"==typeof c&&(c=Number(c)),Number.isFinite(s)&&Number.isFinite(c)?{min:s,max:c}:null}async runSqlGeoJSON(e,t){if(await this.ensureLayerTable(e),!this.conn)throw new Error("DuckDB not initialized");if(!this.hasSpatial)return null;const n=this.layerTableName(e);await this.conn.query(`CREATE OR REPLACE VIEW data AS SELECT * FROM ${n}`);const i=(t||"").trim(),a=/^(with|select)\b/i.test(i)?i:`SELECT * FROM data WHERE (${i||"1=1"})`,o=await this.conn.query(`SELECT * FROM (${a}) AS q LIMIT 0`),r=(o?.schema?.fields||[]).map(e=>String(e?.name||"")).filter(Boolean),l=["hex","h3","index","id"].find(e=>r.includes(e))||null;if(!l)return null;if(!r.every(V))return null;const s=`\n      WITH q AS (${a})\n      SELECT\n        count(*)::BIGINT AS cnt,\n        CASE\n          WHEN count(*) = 0 THEN '{"type":"FeatureCollection","features":[]}'\n          ELSE (\n            '{"type":"FeatureCollection","features":[' ||\n              string_agg(\n                '{"type":"Feature","geometry":' ||\n                  ST_AsGeoJSON(ST_GeomFromText(h3_cell_to_boundary_wkt(CAST("${l}" AS BIGINT)))) ||\n                ',"properties":' || to_json(struct_pack(${r.map(e=>`${e} := "${e}"`).join(", ")})) || '}',\n                ','\n              ) ||\n            ']}'\n          )\n        END AS gj\n      FROM q\n      WHERE "${l}" IS NOT NULL\n        AND h3_is_valid_cell(CAST("${l}" AS BIGINT))\n    `,c=(await this.conn.query(s)).toArray()[0];if(!c)return{geojson:{type:"FeatureCollection",features:[]},count:0};let d=c.cnt;"bigint"==typeof d&&(d=Number(d));const u=String(c.gj||'{"type":"FeatureCollection","features":[]}');return{geojson:JSON.parse(u),count:Number(d)||0}}async getMinMax(e,t){if(await this.ensureLayerTable(e),!this.conn)return null;const n=this.layerTableName(e);await this.conn.query(`CREATE OR REPLACE VIEW data AS SELECT * FROM ${n}`);const i=(await this.conn.query(`SELECT MIN("${t}") as min_val, MAX("${t}") as max_val FROM data`)).toArray()[0];if(!i)return null;let a=i.min_val,o=i.max_val;return"bigint"==typeof a&&(a=Number(a)),"bigint"==typeof o&&(o=Number(o)),Number.isFinite(a)&&Number.isFinite(o)?{min:a,max:o}:null}}let G=null,J={};function X(e){return!("hex"!==e.layerType||e.isTileLayer||!e.parquetData&&!e.parquetUrl)}function Y(){let e=document.getElementById("sql-loader");e||(e=document.createElement("div"),e.id="sql-loader",e.innerHTML='<div class="loader-spinner"></div><span id="sql-loader-text">DuckDB…</span>',document.body.appendChild(e));const t=document.getElementById("sql-loader-text");let n=null;const i=new Map;return{setStatus:(a,o)=>{i.set(a,String(o||"")),(()=>{if(!e)return;const a=[...i.entries()].filter(([,e])=>(e=>{const t=(e||"").toLowerCase();return!!t&&!t.startsWith("error:")&&!t.includes(" rows")&&(t.includes("initializ")||t.includes("running")||t.includes("loading")||t.includes("fetch"))})(e));if(a.length){n&&clearTimeout(n),e.classList.add("active");const i=a.some(([,e])=>String(e||"").toLowerCase().includes("initializ"));return void(t&&(t.textContent=i?"Initialising…":"Loading…"))}n=setTimeout(()=>e?.classList.remove("active"),300)})()}}}function Q(e,t){try{window.dispatchEvent(new CustomEvent("fusedmaps:sql:status",{detail:{layerId:e,status:t}}))}catch(e){}try{G||(G=Y()),G?.setStatus(e,t)}catch(e){}}const K={};function ee(e){const t=e.containerId||"map";try{const t="light"===e.ui?.theme?"light":"dark";document.documentElement.setAttribute("data-theme",t)}catch(e){}e.layers.forEach(e=>{K[e.id]=!1!==e.visible});const i=function(e){const{containerId:t,mapboxToken:n,styleUrl:i,initialViewState:a,screenshotEnabled:o}=e;return window.mapboxgl.accessToken=n,new window.mapboxgl.Map({container:t,style:i,center:[a.longitude,a.latitude],zoom:a.zoom,pitch:a.pitch||0,bearing:a.bearing||0,projection:"mercator",pitchWithRotate:!0,...o?{preserveDrawingBuffer:!0}:{}})}({containerId:t,mapboxToken:e.mapboxToken,styleUrl:e.styleUrl,initialViewState:e.initialViewState,screenshotEnabled:!1!==e.ui?.screenshot}),a=I(i,e.initialViewState,!1!==e.ui?.screenshot),r=e.debug?function(e,t){let n=document.getElementById("debug-shell");n||(n=document.createElement("div"),n.id="debug-shell",n.innerHTML='\n      <div id="debug-panel">\n        <div id="debug-content">\n          <div class="debug-section">\n            <div class="debug-section-title">Editing Layer</div>\n            <div class="debug-row">\n              <span class="debug-label">Layer</span>\n              <select class="debug-select" id="dbg-layer-select"></select>\n            </div>\n          </div>\n\n          <div class="debug-section">\n            <div class="debug-section-title">Hex Layer</div>\n            <div class="debug-toggles">\n              <label class="debug-checkbox"><input type="checkbox" id="dbg-filled" checked /> Filled</label>\n              <label class="debug-checkbox"><input type="checkbox" id="dbg-stroked" checked /> Stroked</label>\n              <label class="debug-checkbox"><input type="checkbox" id="dbg-extruded" /> Extruded</label>\n            </div>\n            <div class="debug-row" style="margin-top:8px;">\n              <span class="debug-label">Opacity</span>\n              <input type="range" class="debug-slider" id="dbg-opacity-slider" min="0" max="1" step="0.05" value="1" />\n              <input type="number" class="debug-input debug-input-sm" id="dbg-opacity" step="0.1" min="0" max="1" value="1" />\n            </div>\n          </div>\n\n          <div class="debug-section" id="fill-color-section">\n            <div class="debug-section-title">Fill Color</div>\n            <div class="debug-row">\n              <span class="debug-label">Function</span>\n              <select class="debug-select" id="dbg-fill-fn">\n                <option value="colorContinuous">colorContinuous</option>\n                <option value="static">Static Color</option>\n              </select>\n            </div>\n            <div id="fill-fn-options">\n              <div class="debug-row">\n                <span class="debug-label">Attribute</span>\n                <select class="debug-select" id="dbg-attr"></select>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label">Palette</span>\n                <select class="debug-select pal-hidden" id="dbg-palette"></select>\n                <div class="pal-dd" id="dbg-palette-dd">\n                  <button type="button" class="pal-trigger" id="dbg-palette-trigger" title="Palette">\n                    <span class="pal-name" id="dbg-palette-name">Palette</span>\n                    <span class="pal-swatch" id="dbg-palette-swatch"></span>\n                  </button>\n                  <div class="pal-menu" id="dbg-palette-menu" style="display:none;"></div>\n                </div>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label">Domain</span>\n                <input type="number" class="debug-input debug-input-sm" id="dbg-domain-min" step="0.1" placeholder="min" />\n                <span style="color:#666;">–</span>\n                <input type="number" class="debug-input debug-input-sm" id="dbg-domain-max" step="0.1" placeholder="max" />\n              </div>\n            <div class="debug-row">\n              <span class="debug-label"></span>\n              <div class="debug-dual-range" aria-label="Domain range">\n                <input type="range" class="debug-range-min" id="dbg-domain-range-min" min="0" max="100" step="0.1" value="0" />\n                <input type="range" class="debug-range-max" id="dbg-domain-range-max" min="0" max="100" step="0.1" value="100" />\n              </div>\n            </div>\n              <div class="debug-row">\n                <span class="debug-label">Steps</span>\n                <input type="number" class="debug-input debug-input-sm" id="dbg-steps" step="1" min="2" max="20" value="7" />\n              </div>\n              <div class="debug-row">\n                <span class="debug-label">Null Color</span>\n                <input type="color" class="debug-color" id="dbg-null-color" value="#b8b8b8" />\n                <span class="debug-color-label" id="dbg-null-color-label">#b8b8b8</span>\n              </div>\n            </div>\n            <div id="fill-static-options" style="display:none;">\n              <div class="debug-row">\n                <span class="debug-label">Color</span>\n                <input type="color" class="debug-color" id="dbg-fill-static" value="#0090ff" />\n                <span class="debug-color-label" id="dbg-fill-static-label">#0090ff</span>\n              </div>\n            </div>\n          </div>\n\n          <div class="debug-section" id="line-color-section">\n            <div class="debug-section-title">Line Color</div>\n            <div class="debug-row">\n              <span class="debug-label">Function</span>\n              <select class="debug-select" id="dbg-line-fn">\n                <option value="colorContinuous">colorContinuous</option>\n                <option value="static" selected>Static Color</option>\n              </select>\n            </div>\n            <div id="line-fn-options" style="display:none;">\n              <div class="debug-row">\n                <span class="debug-label">Attribute</span>\n                <select class="debug-select" id="dbg-line-attr"></select>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label">Palette</span>\n                <select class="debug-select pal-hidden" id="dbg-line-palette"></select>\n                <div class="pal-dd" id="dbg-line-palette-dd">\n                  <button type="button" class="pal-trigger" id="dbg-line-palette-trigger" title="Palette">\n                    <span class="pal-name" id="dbg-line-palette-name">Palette</span>\n                    <span class="pal-swatch" id="dbg-line-palette-swatch"></span>\n                  </button>\n                  <div class="pal-menu" id="dbg-line-palette-menu" style="display:none;"></div>\n                </div>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label">Domain</span>\n                <input type="number" class="debug-input debug-input-sm" id="dbg-line-domain-min" step="0.1" placeholder="min" />\n                <span style="color:#666;">–</span>\n                <input type="number" class="debug-input debug-input-sm" id="dbg-line-domain-max" step="0.1" placeholder="max" />\n              </div>\n            </div>\n            <div id="line-static-options">\n              <div class="debug-row">\n                <span class="debug-label">Color</span>\n                <input type="color" class="debug-color" id="dbg-line-static" value="#ffffff" />\n                <span class="debug-color-label" id="dbg-line-static-label">#ffffff</span>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label">Line Width</span>\n                <input type="range" class="debug-slider" id="dbg-line-width-slider" min="0" max="5" step="0.5" value="1" />\n                <input type="number" class="debug-input debug-input-sm" id="dbg-line-width" step="0.5" min="0" max="10" value="1" />\n              </div>\n            </div>\n          </div>\n\n          <div class="debug-section">\n            <div class="debug-section-title">View State</div>\n            <div class="debug-row">\n              <span class="debug-label">Longitude</span>\n              <input type="number" class="debug-input" id="dbg-lng" step="0.0001" />\n            </div>\n            <div class="debug-row">\n              <span class="debug-label">Latitude</span>\n              <input type="number" class="debug-input" id="dbg-lat" step="0.0001" />\n            </div>\n            <div class="debug-row">\n              <span class="debug-label">Zoom</span>\n              <input type="number" class="debug-input" id="dbg-zoom" step="0.1" min="0" max="22" />\n            </div>\n            <div class="debug-row">\n              <span class="debug-label">Pitch</span>\n              <input type="number" class="debug-input" id="dbg-pitch" step="1" min="0" max="85" />\n            </div>\n            <div class="debug-row">\n              <span class="debug-label">Bearing</span>\n              <input type="number" class="debug-input" id="dbg-bearing" step="1" />\n            </div>\n            <div class="debug-row">\n              <span class="debug-label"></span>\n              <button type="button" class="debug-btn" id="dbg-apply">Apply</button>\n              <button type="button" class="debug-btn debug-btn-secondary" id="dbg-copy">Copy current</button>\n            </div>\n          </div>\n\n          <div class="debug-section" id="sql-section" style="display:none;">\n            <div class="debug-section-title">SQL <span id="sql-status" style="float:right;font-weight:normal;color:var(--ui-muted-2);"></span></div>\n            <textarea id="dbg-sql" class="debug-output" style="height:60px;font-family:monospace;font-size:11px;resize:vertical;" placeholder="WHERE expression (e.g. data = 111)\n—or—\nFull SQL (SELECT ... FROM data ...)"></textarea>\n          </div>\n\n          <div class="debug-section">\n            <div class="debug-section-title">Current ViewState</div>\n            <textarea id="dbg-view-output" class="debug-output" readonly></textarea>\n          </div>\n\n          <div class="debug-section">\n            <div class="debug-section-title">Layer Config</div>\n            <textarea id="dbg-output" class="debug-output" readonly></textarea>\n          </div>\n        </div>\n        <div id="debug-resize-handle" title="Drag to resize"></div>\n      </div>\n      <div id="debug-toggle" title="Toggle debug panel">&#x2039;</div>\n    ',document.body.appendChild(n));const i=document.getElementById("debug-panel"),a=document.getElementById("debug-toggle"),r=document.getElementById("debug-resize-handle"),c=document.getElementById("dbg-layer-select"),d=document.getElementById("dbg-filled"),u=document.getElementById("dbg-stroked"),y=document.getElementById("dbg-extruded"),p=document.getElementById("dbg-opacity-slider"),g=document.getElementById("dbg-opacity"),m=document.getElementById("dbg-fill-fn"),f=document.getElementById("fill-fn-options"),h=document.getElementById("fill-static-options"),b=document.getElementById("dbg-attr"),v=document.getElementById("dbg-palette"),w=document.getElementById("dbg-palette-trigger"),x=document.getElementById("dbg-palette-swatch"),E=document.getElementById("dbg-palette-menu"),L=document.getElementById("dbg-domain-min"),S=document.getElementById("dbg-domain-max"),F=document.getElementById("dbg-domain-range-min"),$=document.getElementById("dbg-domain-range-max"),T=document.getElementById("dbg-steps"),A=document.getElementById("dbg-null-color"),I=document.getElementById("dbg-null-color-label"),q=document.getElementById("dbg-fill-static"),P=document.getElementById("dbg-fill-static-label"),D=document.getElementById("dbg-line-fn"),O=document.getElementById("line-fn-options"),z=document.getElementById("line-static-options"),W=document.getElementById("dbg-line-attr"),H=document.getElementById("dbg-line-palette"),U=document.getElementById("dbg-line-palette-trigger"),V=document.getElementById("dbg-line-palette-swatch"),Z=document.getElementById("dbg-line-palette-menu"),G=document.getElementById("dbg-line-domain-min"),J=document.getElementById("dbg-line-domain-max"),X=document.getElementById("dbg-line-static"),Y=document.getElementById("dbg-line-static-label"),Q=document.getElementById("dbg-line-width-slider"),K=document.getElementById("dbg-line-width"),ee=document.getElementById("dbg-lng"),te=document.getElementById("dbg-lat"),ne=document.getElementById("dbg-zoom"),ie=document.getElementById("dbg-pitch"),ae=document.getElementById("dbg-bearing"),oe=document.getElementById("dbg-view-output"),re=document.getElementById("dbg-output"),le=document.getElementById("sql-section"),se=document.getElementById("sql-status"),ce=document.getElementById("dbg-sql"),de=t.initialViewState,ue=Object.keys(window.cartocolor||{}).sort((e,t)=>e.localeCompare(t)),ye=e=>{e.innerHTML=ue.map(e=>`<option value="${e}">${e}</option>`).join("")};ye(v),ye(H);const pe=(e,t=9)=>{const n=((e,t)=>{try{const n=window.cartocolor?.[e];if(!n)return null;const i=Object.keys(n).map(e=>Number(e)).filter(e=>Number.isFinite(e)).sort((e,t)=>e-t),a=n[i.find(e=>e>=t)??i[i.length-1]];return Array.isArray(a)?[...a]:null}catch(e){return null}})(e,Math.max(t,3));return n?.length?`linear-gradient(90deg, ${n.map((e,t)=>`${e} ${t/Math.max(1,n.length-1)*100}%`).join(", ")})`:"linear-gradient(90deg, #555, #999)"},ge=(e,t,n)=>{const i=e.value||"Palette";t.style.background=pe(i),n.title=i},me=()=>{try{E.style.display="none"}catch(e){}try{Z.style.display="none"}catch(e){}},fe=(e,t,n,i)=>{((e,t,n,i)=>{t.innerHTML=ue.map(e=>`<div class="pal-item" data-pal="${e}" title="${e}">\n          <div class="pal-item-swatch" style="background:${pe(e)};"></div>\n        </div>`).join(""),t.querySelectorAll(".pal-item").forEach(a=>{a.addEventListener("click",o=>{try{o.preventDefault(),o.stopPropagation()}catch(e){}const r=a.getAttribute("data-pal")||"";r&&(e.value=r),ge(e,n,i),t.style.display="none",Se()})})})(e,t,n,i),ge(e,n,i),i.addEventListener("click",e=>{try{e.preventDefault(),e.stopPropagation()}catch(e){}const n="none"!==t.style.display;me(),t.style.display=n?"none":"block"})},he=()=>me();document.addEventListener("click",he),window.addEventListener("blur",he);const be=t.layers.filter(e=>"hex"===e.layerType||"vector"===e.layerType);c.innerHTML=be.map(e=>`<option value="${e.id}">${e.name||e.id}</option>`).join(""),!c.value&&be.length&&(c.value=be[0].id);const ve=()=>{const e=c.value;return be.find(t=>t.id===e)||null},we=()=>{try{const n=(e._controls||[]).find(e=>e&&e.__fused_hex_tiles__);t.__deckOverlay=n||t.__deckOverlay}catch(e){}};we();const Ce=()=>{try{const e=ve();if(!e)return void(re.value="");const t=50,n=2e5;if("vector"===e.layerType){const t=e.geojson,i=Array.isArray(t?.features)?t.features:[],a=i.slice(0,10),o={id:e.id,name:e.name,layerType:e.layerType,visible:e.visible,geojson:{type:t?.type||"FeatureCollection",rowCount:i.length,featuresPreview:a},vectorLayer:e.vectorLayer,style:{isFilled:e.isFilled,isStroked:e.isStroked,opacity:e.opacity,pointRadius:e.pointRadius,lineWidth:e.lineWidth,fillColorConfig:e.fillColorConfig,fillColorRgba:e.fillColorRgba,lineColorConfig:e.lineColorConfig,lineColorRgba:e.lineColorRgba}};let r=JSON.stringify(o,null,2);return r.length>n&&(r=r.slice(0,n)+"\n... (truncated)\n"),void(re.value=r)}const i={...e};try{const t="string"==typeof e.sql?e.sql.trim():"";if(t){const e=/^(with|select)\b/i.test(t);i.sql=t,i.sqlResolved=e?t:`SELECT * FROM data WHERE (${t||"1=1"})`}}catch(e){}Array.isArray(e.data)&&(i.rowCount=e.data.length,i.dataPreview=e.data.slice(0,t),e.data.length>t&&(i.dataPreviewTruncated=!0),delete i.data),i.geojson&&i.geojson.features&&Array.isArray(i.geojson.features)&&(i.geojson={type:i.geojson.type,rowCount:i.geojson.features.length,featuresPreview:i.geojson.features.slice(0,Math.min(10,i.geojson.features.length))},i.geojsonPreviewTruncated=i.geojson.featuresPreview.length<(e.geojson?.features?.length||0));let a=JSON.stringify(i,null,2);a.length>n&&(a=a.slice(0,n)+"\n... (truncated)\n"),re.value=a}catch(e){re.value=""}},xe=()=>{const e=m.value;f.style.display="colorContinuous"===e?"block":"none",h.style.display="static"===e?"block":"none"},Ee=()=>{const e=D.value;O.style.display="colorContinuous"===e?"block":"none",z.style.display="static"===e?"block":"none"},Le=()=>{const e=ve();if(!e)return;const t="hex"===e.layerType,n="vector"===e.layerType,i=t&&e.hexLayer||{};t?(d.checked=!1!==i.filled,u.checked=!1!==i.stroked,y.checked=!0===i.extruded):(d.checked=!1!==e.isFilled,u.checked=!1!==e.isStroked,y.checked=!1);const a=t?"number"==typeof i.opacity?i.opacity:1:"number"==typeof e.opacity?e.opacity:.9;if(p.value=String(a),g.value=String(a),t){const t=i.getFillColor,n=B(t);if(n){m.value="colorContinuous",b.innerHTML=_(e).map(e=>`<option value="${e}">${e}</option>`).join(""),n.attr&&(b.value=String(n.attr)),n.colors&&(v.value=String(n.colors)),ge(v,x,w);const t=Array.isArray(n.domain)?n.domain:[0,1];L.value=N(Number(t[0]),2),S.value=N(Number(t[1]),2);try{const e=Math.min(Number(t[0]),Number(t[1])),n=Math.max(Number(t[0]),Number(t[1]));Number.isFinite(e)&&Number.isFinite(n)&&(F.min=String(e),F.max=String(n),$.min=String(e),$.max=String(n),F.step="0.1",$.step="0.1",F.value=String(Number(t[0])),$.value=String(Number(t[1])))}catch(e){}T.value=String(n.steps??7);const i=`#${(Array.isArray(n.nullColor)?n.nullColor:[184,184,184]).slice(0,3).map(e=>k(Number(e),0,255).toString(16).padStart(2,"0")).join("")}`;A.value=i,I.textContent=i}else if(Array.isArray(t)){m.value="static";const e=`#${t.slice(0,3).map(e=>k(Number(e),0,255).toString(16).padStart(2,"0")).join("")}`;q.value=e,P.textContent=e}else m.value="colorContinuous"}else if(n){const t=e,n=j(e);b.innerHTML=n.map(e=>`<option value="${e}">${e}</option>`).join("");const i=t.fillColorConfig;if(i&&"object"==typeof i&&"colorContinuous"===i["@@function"]){m.value="colorContinuous",i.attr&&(b.value=String(i.attr)),i.colors&&(v.value=String(i.colors)),ge(v,x,w);const e=Array.isArray(i.domain)?i.domain:[0,1];L.value=N(Number(e[0]),2),S.value=N(Number(e[1]),2),T.value=String(i.steps??7);const t=`#${(Array.isArray(i.nullColor)?i.nullColor:[184,184,184]).slice(0,3).map(e=>k(Number(e),0,255).toString(16).padStart(2,"0")).join("")}`;A.value=t,I.textContent=t}else m.value="static",q.value="#0090ff",P.textContent=q.value}if(t){const t=i.getLineColor,n=B(t);if(n){D.value="colorContinuous",W.innerHTML=_(e).map(e=>`<option value="${e}">${e}</option>`).join(""),n.attr&&(W.value=String(n.attr)),n.colors&&(H.value=String(n.colors)),ge(H,V,U);const t=Array.isArray(n.domain)?n.domain:[0,1];G.value=N(Number(t[0]),2),J.value=N(Number(t[1]),2)}else if(Array.isArray(t)){D.value="static";const e=`#${t.slice(0,3).map(e=>k(Number(e),0,255).toString(16).padStart(2,"0")).join("")}`;X.value=e,Y.textContent=e}else D.value="static"}else if(n){const t=e,n=j(e);W.innerHTML=n.map(e=>`<option value="${e}">${e}</option>`).join("");const i=t.lineColorConfig;if(i&&"object"==typeof i&&"colorContinuous"===i["@@function"]){D.value="colorContinuous",i.attr&&(W.value=String(i.attr)),i.colors&&(H.value=String(i.colors)),ge(H,V,U);const e=Array.isArray(i.domain)?i.domain:[0,1];G.value=N(Number(e[0]),2),J.value=N(Number(e[1]),2)}else D.value="static"}const o=t?i.lineWidthMinPixels??1:e.lineWidth??1;Q.value=String(o),K.value=String(o),xe(),Ee(),Ce();try{const t=!("hex"!==e.layerType||e.isTileLayer||!e.parquetData&&!e.parquetUrl);le&&(le.style.display=t?"block":"none"),ce&&t&&(ce.value=String(e.sql||"SELECT * FROM data")),se&&(se.textContent="")}catch(e){}},Se=()=>{const n=ve();if(!n)return;const i="hex"===n.layerType,a="vector"===n.layerType;i&&(n.hexLayer=n.hexLayer||{});const r=i?n.hexLayer:{},c=parseFloat(g.value),p=Number.isFinite(c)?k(c,0,1):1;if(i)r.filled=!!d.checked,r.stroked=!!u.checked,r.extruded=!!y.checked,r.opacity=p;else if(a){n.isFilled=!!d.checked,n.isStroked=!!u.checked,n.opacity=p;try{n.vectorLayer={...n.vectorLayer||{},filled:!!d.checked,stroked:!!u.checked,opacity:p}}catch(e){}}if(i)if("static"===m.value){const e=q.value||"#0090ff",t=parseInt(e.slice(1,3),16),n=parseInt(e.slice(3,5),16),i=parseInt(e.slice(5,7),16);r.getFillColor=[t,n,i]}else{const e=b.value||"data_avg",t=v.value||"Earth",n=parseFloat(L.value),i=parseFloat(S.value),a=parseInt(T.value||"7",10),o=A.value||"#b8b8b8",l=parseInt(o.slice(1,3),16),s=parseInt(o.slice(3,5),16),c=parseInt(o.slice(5,7),16);r.getFillColor={"@@function":"colorContinuous",attr:e,domain:[Number.isFinite(n)?n:0,Number.isFinite(i)?i:1],colors:t,steps:Number.isFinite(a)?a:7,nullColor:[l,s,c],autoDomain:!1!==r.getFillColor?.autoDomain}}else if(a)if("static"===m.value){const e=q.value||"#0090ff";n.fillColorConfig=null,n.fillColorRgba=e}else{const e=b.value||"house_age",t=v.value||"ArmyRose",i=parseFloat(L.value),a=parseFloat(S.value),o=parseInt(T.value||"7",10),r=A.value||"#b8b8b8",l=parseInt(r.slice(1,3),16),s=parseInt(r.slice(3,5),16),c=parseInt(r.slice(5,7),16);n.fillColorRgba=null,n.fillColorConfig={"@@function":"colorContinuous",attr:e,domain:[Number.isFinite(i)?i:0,Number.isFinite(a)?a:1],colors:t,steps:Number.isFinite(o)?o:7,nullColor:[l,s,c]}}if(i)if("static"===D.value){const e=X.value||"#ffffff",t=parseInt(e.slice(1,3),16),n=parseInt(e.slice(3,5),16),i=parseInt(e.slice(5,7),16);r.getLineColor=[t,n,i]}else{const e=W.value||"data_avg",t=H.value||"Earth",n=parseFloat(G.value),i=parseFloat(J.value);r.getLineColor={"@@function":"colorContinuous",attr:e,domain:[Number.isFinite(n)?n:0,Number.isFinite(i)?i:1],colors:t,steps:parseInt(T.value||"7",10)||7,autoDomain:!1!==r.getLineColor?.autoDomain}}else if(a)if("static"===D.value){const e=X.value||"#ffffff";n.lineColorConfig=null,n.lineColorRgba=e}else{const e=W.value||"house_age",t=H.value||"ArmyRose",i=parseFloat(G.value),a=parseFloat(J.value);n.lineColorRgba=null,n.lineColorConfig={"@@function":"colorContinuous",attr:e,domain:[Number.isFinite(i)?i:0,Number.isFinite(a)?a:1],colors:t,steps:parseInt(T.value||"7",10)||7}}const f=parseFloat(K.value),h=Number.isFinite(f)?k(f,0,10):1;i?r.lineWidthMinPixels=h:a&&(n.lineWidth=h),Ce(),we(),(()=>{try{const e=t.__deckOverlay||null,n=e?.__fused_hex_tiles__;n?.rebuild?.()}catch(e){}try{window.dispatchEvent(new CustomEvent("fusedmaps:legend:update"))}catch(e){}})();try{if("hex"===n.layerType&&!n.isTileLayer){const t=n.parquetData||n.parquetUrl?C()?.[n.id]||{type:"FeatureCollection",features:[]}:l(n.data||[]),i=function(e,t){try{const n=e.getStyle?.(),i=n?.layers||[],a=[`${t}-fill`,`${t}-extrusion`,`${t}-outline`];for(const e of a){const t=i.find(t=>t&&t.id===e);if(!t)continue;const n=t.layout?.visibility;return"none"!==n}}catch(e){}return!0}(e,n.id);!function(e,t,n,i){try{const i=e.getSource(t.id);i&&"function"==typeof i.setData?i.setData(n):e.addSource(t.id,{type:"geojson",data:n})}catch(e){}!function(e,t){const n=[`${t}-fill`,`${t}-extrusion`,`${t}-outline`];for(const t of n)try{e.getLayer(t)&&e.removeLayer(t)}catch(e){}}(e,t.id),s(e,t,n,i)}(e,n,t,i)}}catch(e){}try{if(a){const t=n,i=t.geojson,a=i?.features?.map(e=>e?.properties||{})||[],r=t.fillColorConfig?.["@@function"]?o(t.fillColorConfig,a):t.fillColorRgba||"#0090ff",l=t.lineColorConfig?.["@@function"]?o(t.lineColorConfig,a):t.lineColorRgba||"#ffffff",s=!1===t.isFilled?0:p,c=!1===t.isStroked?0:1;R(e,`${t.id}-fill`,"fill-color",r),R(e,`${t.id}-fill`,"fill-opacity",s),R(e,`${t.id}-outline`,"line-color",l),R(e,`${t.id}-outline`,"line-width",h),R(e,`${t.id}-outline`,"line-opacity",c),R(e,`${t.id}-line`,"line-color",l),R(e,`${t.id}-line`,"line-width",h),R(e,`${t.id}-line`,"line-opacity",c),R(e,`${t.id}-circle`,"circle-color",r),R(e,`${t.id}-circle`,"circle-opacity",s),R(e,`${t.id}-circle`,"circle-stroke-color",l),R(e,`${t.id}-circle`,"circle-stroke-width",h)}}catch(e){}},Fe=()=>{const e=parseFloat(L.value),t=parseFloat(S.value);Number.isFinite(e)&&(F.value=String(e)),Number.isFinite(t)&&($.value=String(t))},$e=()=>{let e=parseFloat(F.value),t=parseFloat($.value);Number.isFinite(e)&&Number.isFinite(t)&&(e>t&&([e,t]=[t,e]),F.value=String(e),$.value=String(t),L.value=String(e),S.value=String(t))},Te=()=>{const e=ve();if(e){e.fillDomainFromUser=!0;try{if("hex"!==e.layerType)return;const t=e.hexLayer||{};if(t.getFillColor&&"object"==typeof t.getFillColor){t.getFillColor.autoDomain=!1;try{delete t.getFillColor._dynamicDomain}catch(e){}}if(t.getLineColor&&"object"==typeof t.getLineColor){t.getLineColor.autoDomain=!1;try{delete t.getLineColor._dynamicDomain}catch(e){}}}catch(e){}}},Ae=()=>{$e()},Ie=()=>{$e(),Te(),Se()},Ne=()=>{try{const t=function(e){const t=e.getCenter();return{longitude:t.lng,latitude:t.lat,zoom:e.getZoom(),pitch:e.getPitch(),bearing:e.getBearing()}}(e);if(oe.value=JSON.stringify(t,null,2),n&&function(){const e=document.activeElement;return!(!e||!e.closest?.("#debug-panel")||"INPUT"!==e.tagName&&"TEXTAREA"!==e.tagName&&"SELECT"!==e.tagName)}())return;ee.value=N(t.longitude,5),te.value=N(t.latitude,5),ne.value=N(t.zoom,2),ie.value=N(t.pitch??0,1),ae.value=N(t.bearing??0,1)}catch(e){}},Me=()=>{const e=i.classList.toggle("collapsed");a.innerHTML=e?"&#x203A;":"&#x2039;",M(n,i,a)},ke=t=>{try{t.preventDefault(),t.stopPropagation()}catch(e){}(()=>{const t=parseFloat(ee.value),n=parseFloat(te.value),i=parseFloat(ne.value),a=parseFloat(ie.value),o=parseFloat(ae.value);try{e.jumpTo({center:[Number.isFinite(t)?t:de.longitude,Number.isFinite(n)?n:de.latitude],zoom:Number.isFinite(i)?i:e.getZoom(),pitch:Number.isFinite(a)?a:e.getPitch(),bearing:Number.isFinite(o)?o:e.getBearing()})}catch(e){}})()},Be=async e=>{try{e.preventDefault(),e.stopPropagation()}catch(e){}await(async()=>{try{await navigator.clipboard.writeText(oe.value||"")}catch(e){}})()};let _e=!1,je=0,Re=280;const qe=e=>{if(!_e)return;const t=e.clientX-je,o=k(Re+t,240,520);i.style.width=`${o}px`,M(n,i,a),e.preventDefault()},Pe=e=>{_e&&(_e=!1,window.removeEventListener("pointermove",qe),window.removeEventListener("pointerup",Pe))},De=e=>{_e=!0,je=e.clientX,Re=i.getBoundingClientRect().width||280,window.addEventListener("pointermove",qe,{passive:!1}),window.addEventListener("pointerup",Pe),e.preventDefault(),e.stopPropagation()};a.addEventListener("click",Me),document.getElementById("dbg-apply").addEventListener("click",ke),document.getElementById("dbg-copy").addEventListener("click",Be),r.addEventListener("pointerdown",De,{passive:!1}),c.addEventListener("change",()=>Le()),m.addEventListener("change",()=>{xe(),Se()}),D.addEventListener("change",()=>{Ee(),Se()}),[d,u,y].forEach(e=>e.addEventListener("change",Se)),p.addEventListener("input",()=>{g.value=p.value,Se()}),g.addEventListener("change",()=>{p.value=g.value,Se()}),[b,T].forEach(e=>e.addEventListener("change",Se)),L.addEventListener("input",()=>{Fe()}),S.addEventListener("input",()=>{Fe()}),L.addEventListener("change",()=>{Te(),Se()}),S.addEventListener("change",()=>{Te(),Se()}),F.addEventListener("input",Ae),$.addEventListener("input",Ae),F.addEventListener("change",Ie),$.addEventListener("change",Ie),A.addEventListener("input",()=>{I.textContent=A.value,Se()}),q.addEventListener("input",()=>{P.textContent=q.value,Se()}),[W,G,J].forEach(e=>e.addEventListener("change",Se)),X.addEventListener("input",()=>{Y.textContent=X.value,Se()}),Q.addEventListener("input",()=>{K.value=Q.value,Se()}),K.addEventListener("change",()=>{Q.value=K.value,Se()});let Oe=null;const ze=()=>{const e=ve();if(!e)return;if("hex"!==e.layerType||e.isTileLayer||!e.parquetData&&!e.parquetUrl)return;const t=String(ce?.value||"").trim()||"SELECT * FROM data";try{ce&&(ce.value=t)}catch(e){}e.sql=t;try{Ce()}catch(e){}se&&(se.textContent="typing..."),clearTimeout(Oe),Oe=setTimeout(()=>{try{window.dispatchEvent(new CustomEvent("fusedmaps:sql:update",{detail:{layerId:e.id,sql:t}}))}catch(e){}},500)};try{ce?.addEventListener("input",ze)}catch(e){}const We=e=>{try{const t=e?.detail||{},n=String(t.layerId||""),i=String(t.status||""),a=ve();if(!a||a.id!==n)return;se&&(se.textContent=i)}catch(e){}};try{window.addEventListener("fusedmaps:sql:status",We)}catch(e){}try{e.on("moveend",Ne),e.on("rotateend",Ne),e.on("pitchend",Ne)}catch(e){}return xe(),Ee(),fe(v,E,x,w),fe(H,Z,V,U),Le(),Ne(),M(n,i,a),window.addEventListener("resize",()=>M(n,i,a)),{destroy:()=>{try{document.removeEventListener("click",he)}catch(e){}try{window.removeEventListener("blur",he)}catch(e){}try{a.removeEventListener("click",Me)}catch(e){}try{document.getElementById("dbg-apply").removeEventListener("click",ke),document.getElementById("dbg-copy").removeEventListener("click",Be)}catch(e){}try{r.removeEventListener("pointerdown",De)}catch(e){}try{e.off("moveend",Ne),e.off("rotateend",Ne),e.off("pitchend",Ne)}catch(e){}try{window.removeEventListener("fusedmaps:sql:status",We)}catch(e){}try{n?.remove()}catch(e){}}}}(i,e):null;let c=null,d=null,u=null;return!1!==e.ui?.layerPanel&&function(t,n){E=(t,n)=>{te(t,n,i,e,c)},L=t,S=n;let a=document.getElementById("layer-panel");if(a||(a=document.createElement("div"),a.id="layer-panel",a.innerHTML='<div id="layer-list"></div>',document.body.appendChild(a)),window.toggleLayerVisibility=(e,t)=>{E&&E(e,t)},window.onLayerItemClick=(e,t)=>{try{if(e&&e.target.closest?.(".layer-eye"))return}catch(e){}const i=!1!==n[t];E&&E(t,!i)},$(t,n),!F){F=!0;try{window.addEventListener("fusedmaps:legend:update",()=>{try{$(L,S)}catch(e){}})}catch(e){}}}(e.layers,K),!1!==e.ui?.legend&&function(e,t){let n=document.getElementById("color-legend");n||(n=document.createElement("div"),n.id="color-legend",n.className="color-legend",n.style.display="none",document.body.appendChild(n)),T(e,t)}(e.layers,K),i.on("load",()=>{const t=x(i,e.layers,K);c=t.deckOverlay,$(e.layers,K),T(e.layers,K),d=()=>{T(e.layers,K)};try{window.addEventListener("fusedmaps:legend:update",d)}catch(e){}!1!==e.ui?.tooltip&&function(e,t,n,i){let a=document.getElementById("tooltip");a||(a=document.createElement("div"),a.id="tooltip",document.body.appendChild(a));const o=[];t.forEach(e=>{if(e.isTileLayer)return;const t=[];"hex"===e.layerType?((e.hexLayer||{}).extruded?t.push(`${e.id}-extrusion`):t.push(`${e.id}-fill`),t.push(`${e.id}-outline`)):"vector"===e.layerType?t.push(`${e.id}-fill`,`${e.id}-outline`,`${e.id}-circle`,`${e.id}-line`):"mvt"===e.layerType&&t.push(`${e.id}-fill`,`${e.id}-line`,`${e.id}-extrusion`),t.forEach(t=>{o.push({layerId:t,layerDef:e})})}),e.on("mousemove",r=>{const l=o.map(e=>e.layerId).filter(t=>e.getLayer(t)),s=e=>{const n=t.findIndex(t=>t.id===e);return-1===n?Number.POSITIVE_INFINITY:n};let c=null,d=Number.POSITIVE_INFINITY;if(l.length){const t=e.queryRenderedFeatures(r.point,{layers:l});for(const e of t||[]){const t=o.find(t=>t.layerId===e.layer?.id);if(!t)continue;if(!1===n[t.layerDef.id])continue;const i=s(t.layerDef.id);i<d&&(d=i,c={type:"mapbox",layerDef:t.layerDef,props:e.properties||{}});break}}if(i){const e=i.__fused_hex_tiles__,a=e?.pickObject||i?.pickObject;try{const e=a?.({x:r.point.x,y:r.point.y,radius:4});if(e?.object){const i=String(e.layer?.id||""),a=i.includes("-tiles")?i.split("-tiles")[0]:i,o=t.find(e=>e.id===a);if(o&&!1!==n[o.id]){const t=s(o.id);t<d&&(d=t,c={type:"deck",layerDef:o,props:e.object.properties||e.object||{}})}}}catch(e){}}if(!c)return a.style.display="none",void(e.getCanvas().style.cursor="");e.getCanvas().style.cursor="pointer";const u=function(e){if("hex"===e.layerType){const t=e;return t.hexLayer?.tooltipColumns||t.hexLayer?.tooltipAttrs||t.tooltipColumns||[]}if("vector"===e.layerType){const t=e;return t.vectorLayer?.tooltipColumns||t.vectorLayer?.tooltipAttrs||t.tooltipColumns||[]}return e.tooltipColumns||[]}(c.layerDef),y=function(e,t){const n=[];return null!=e.hex&&n.push(`<span class="tt-row"><span class="tt-key">hex</span><span class="tt-val">${String(e.hex).slice(0,12)}...</span></span>`),t.length?(t.forEach(t=>{if("hex"===t)return;const i=e[t];if(null==i)return;const a="number"==typeof i?Number(i).toFixed(2):String(i);n.push(`<span class="tt-row"><span class="tt-key">${t}</span><span class="tt-val">${a}</span></span>`)}),n):(0===n.length&&Object.keys(e).slice(0,5).forEach(t=>{n.push(`<span class="tt-row"><span class="tt-key">${t}</span><span class="tt-val">${e[t]}</span></span>`)}),n)}(c.props,u);y.length?(a.innerHTML=`<strong class="tt-title">${c.layerDef.name}</strong>`+y.join(""),a.style.left=`${r.point.x+10}px`,a.style.top=`${r.point.y+10}px`,a.style.display="block"):a.style.display="none"}),e.on("mouseleave",()=>{e.getCanvas().style.cursor="",a.style.display="none"})}(i,e.layers,K,c),!1!==e.highlightOnClick&&function(e,t,n,i){e.on("click",n=>{const a=function(e,t){const n=[];return t.forEach(t=>{if(t.isTileLayer)return;const i=t.layerType;let a=[];if("vector"===i)a=[`${t.id}-fill`,`${t.id}-circle`,`${t.id}-line`];else if("hex"===i){const e=t;a=[e.hexLayer?.extruded?`${t.id}-extrusion`:`${t.id}-fill`]}a.forEach(t=>{try{e.getLayer(t)&&n.push(t)}catch(e){}})}),["gdf-fill","gdf-circle","hex-fill"].forEach(t=>{try{e.getLayer(t)&&n.push(t)}catch(e){}}),n}(e,t);if(!a.length)return;let o=[];try{o=e.queryRenderedFeatures(n.point,{layers:a})||[]}catch(e){}if(o.length>0)D(e,o[0]);else if(i){const t=i?.pickObject?.({x:n.point.x,y:n.point.y,radius:4});t?.object?D(e,{properties:t.object.properties||t.object,geometry:null}):P&&D(e,null)}else P&&D(e,null)})}(i,e.layers,0,c),e.messaging&&W(i,e.messaging,e.layers),u=function(e,t,i,a){const r=(t.layers||[]).filter(X);if(!r.length)return null;try{J={};for(const e of r)J[e.id]=e.name||e.id}catch(e){}try{G||(G=Y())}catch(e){}const l=new Z;let c=!1;const d=async(t,r)=>{if(!c){Q(t.id,"initializing...");try{if(await l.init(),c)return;try{const e=t.hexLayer?.getFillColor,n=e&&"object"==typeof e&&!Array.isArray(e)?e.attr:null,i=e&&"object"==typeof e&&!Array.isArray(e)&&(!0===e.autoDomain||!Array.isArray(e.domain));if(n&&i&&!0!==t.fillDomainFromUser){const e=await l.getMinMax(t,String(n));e&&t.hexLayer&&"object"==typeof t.hexLayer.getFillColor&&!Array.isArray(t.hexLayer.getFillColor)&&(t.hexLayer.getFillColor.domain=[e.min,e.max])}}catch(e){}t.sql=r||t.sql||"SELECT * FROM data";try{const e=t.sql||"SELECT * FROM data",n=!0===t.fillDomainFromUser,i=t.hexLayer?.getFillColor;if(!n&&i&&"object"==typeof i&&!Array.isArray(i)&&"colorContinuous"===i["@@function"]){const n=String(i.attr||"");if(n&&!0===i.autoDomain){const a=await l.getMinMaxFromQuery(t,n,e);a&&(i.domain=[a.min,a.max])}}const a=t.hexLayer?.getLineColor;if(!n&&a&&"object"==typeof a&&!Array.isArray(a)&&"colorContinuous"===a["@@function"]){const n=String(a.attr||"");if(n&&!0===a.autoDomain){const i=await l.getMinMaxFromQuery(t,n,e);i&&(a.domain=[i.min,i.max])}}}catch(e){}Q(t.id,"running...");const d=await l.runSqlGeoJSON(t,t.sql||"SELECT * FROM data");if(c)return;if(!d?.geojson)throw new Error("DuckDB GeoJSON path unavailable (requires spatial + h3 extensions and compatible columns).");const u=d.geojson;!function(e,t){w[e]=t}(t.id,u);const y=!1!==i[t.id],p=function(e,t,n){try{const i=e.getSource(t);if(i&&"function"==typeof i.setData)return i.setData(n),!0}catch(e){}return!1}(e,t.id,u);if(!p)try{s(e,t,u,y)}catch(e){}!function(e,t){const i=t.hexLayer||{},a=t.data||[],r=Array.isArray(i.getFillColor)?n(i.getFillColor,.8):o(i.getFillColor,a)||"rgba(0,144,255,0.7)",l=i.getLineColor?Array.isArray(i.getLineColor)?n(i.getLineColor,1):o(i.getLineColor,a):"rgba(255,255,255,0.3)",s="number"==typeof i.opacity&&isFinite(i.opacity)?Math.max(0,Math.min(1,i.opacity)):.8;try{i.extruded&&e.getLayer(`${t.id}-extrusion`)&&(e.setPaintProperty(`${t.id}-extrusion`,"fill-extrusion-color",r),e.setPaintProperty(`${t.id}-extrusion`,"fill-extrusion-opacity",s))}catch(e){}try{!i.extruded&&e.getLayer(`${t.id}-fill`)&&(e.setPaintProperty(`${t.id}-fill`,"fill-color",r),e.setPaintProperty(`${t.id}-fill`,"fill-opacity",s))}catch(e){}try{e.getLayer(`${t.id}-outline`)&&(e.setPaintProperty(`${t.id}-outline`,"line-color",l),e.setPaintProperty(`${t.id}-outline`,"line-width",i.lineWidthMinPixels||.5))}catch(e){}}(e,t),Q(t.id,`${(d.count||0).toLocaleString()} rows`),function(){try{window.dispatchEvent(new Event("fusedmaps:legend:update"))}catch(e){}}();try{a?.()}catch(e){}}catch(e){Q(t.id,`error: ${(e?.message||"query failed").slice(0,60)}`)}}};(async()=>{for(const e of r){if(c)break;const t=(e.sql||"SELECT * FROM data").trim();await d(e,t)}})();const u=e=>{const t=e?.detail||{},n=String(t.layerId||""),i=String(t.sql||""),a=r.find(e=>e.id===n);a&&d(a,i)};try{window.addEventListener("fusedmaps:sql:update",u)}catch(e){}return{destroy:()=>{c=!0;try{window.removeEventListener("fusedmaps:sql:update",u)}catch(e){}}}}(i,e,K,()=>{try{$(e.layers,K)}catch(e){}try{T(e.layers,K,C())}catch(e){}}),e.hasCustomView||function(e,t){const n=new mapboxgl.LngLatBounds,i=C();t.forEach(e=>{if(e.isTileLayer)return;const t=i[e.id];t?.features?.length&&t.features.forEach(e=>{"Point"===e.geometry?.type?n.extend(e.geometry.coordinates):"Polygon"===e.geometry?.type||"MultiPolygon"===e.geometry?.type?("Polygon"===e.geometry.type?[e.geometry.coordinates]:e.geometry.coordinates).forEach(e=>e[0]?.forEach(e=>n.extend(e))):"LineString"===e.geometry?.type&&e.geometry.coordinates.forEach(e=>n.extend(e))})}),n.isEmpty()||e.fitBounds(n,{padding:50,maxZoom:15,duration:500})}(i,e.layers)}),i.on("load",()=>{[100,500,1e3].forEach(e=>setTimeout(()=>i.resize(),e))}),window.addEventListener("resize",()=>i.resize()),document.addEventListener("visibilitychange",()=>{document.hidden||setTimeout(()=>i.resize(),100)}),{map:i,deckOverlay:c,setLayerVisibility:(t,n)=>{te(t,n,i,e,c)},updateLegend:()=>{T(e.layers,K)},destroy:()=>{try{c?.__fused_hex_tiles__?.destroy?.()}catch(e){}try{a?.destroy?.()}catch(e){}try{r?.destroy?.()}catch(e){}try{u?.destroy?.()}catch(e){}try{d&&window.removeEventListener("fusedmaps:legend:update",d)}catch(e){}i.remove?.()}}}function te(e,t,n,i,a){K[e]=t,function(e,t,n,i,a){const o=i.find(e=>e.id===t);if(o)switch(o.layerType){case"hex":{const i=o;if(i.isTileLayer){const e=a?.__fused_hex_tiles__;try{e?.rebuild?.()}catch(e){}}else!function(e,t,n,i){(i?[`${t}-extrusion`,`${t}-outline`]:[`${t}-fill`,`${t}-outline`]).forEach(t=>{try{e.getLayer(t)&&e.setLayoutProperty(t,"visibility",n?"visible":"none")}catch(e){}})}(e,t,n,!0===i.hexLayer?.extruded);break}case"vector":case"mvt":!function(e,t,n){[`${t}-fill`,`${t}-outline`,`${t}-line`,`${t}-circle`,`${t}-extrusion`].forEach(t=>{try{e.getLayer(t)&&e.setLayoutProperty(t,"visibility",n?"visible":"none")}catch(e){}})}(e,t,n);break;case"raster":!function(e,t,n){const i=`${t}-raster`;try{e.getLayer(i)&&e.setLayoutProperty(i,"visibility",n?"visible":"none")}catch(e){}}(e,t,n)}}(n,e,t,i.layers,a),$(i.layers,K),T(i.layers,K)}"undefined"!=typeof window&&(window.FusedMaps={init:ee});var ne={init:ee};e.default=ne,e.init=ee,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=fusedmaps.umd.js.map
