!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).FusedMaps={})}(this,function(e){"use strict";function t(e,t){const n=window.cartocolor;if(!n)return null;const i=n[e];if(!i)return null;const o=Object.keys(i).map(Number).filter(e=>!isNaN(e)).sort((e,t)=>e-t),r=o.find(e=>e>=t)||o[o.length-1];return i[r]?[...i[r]]:null}function n(e,t){if(!Array.isArray(e)||e.length<3)return null;const[n,i,o]=e;return`rgba(${n},${i},${o},${e.length>=4?e[3]/255:t??1})`}const i=["#e0f3db","#ccebc5","#a8ddb5","#7bccc4","#4eb3d3","#2b8cbe","#0868ac","#084081"],o=["#7F3C8D","#11A579","#3969AC","#F2B701","#E73F74","#80BA5A","#E68310","#008695","#CF1C90","#f97b72"];function r(e,n){if(!e)return null;if(Array.isArray(e))return null;if("string"==typeof e)return e;const i=e["@@function"],r=e.attr;return i&&r?"colorCategories"===i?function(e,n){let i=e.categories?e.categories.map(e=>"object"==typeof e?e:{value:e,label:String(e)}):function(e,t,n){const i=new Map;return(e||[]).forEach(e=>{const o=e?.[t]??e?.properties?.[t];if(null!=o&&""!==o&&"null"!==o&&!i.has(o)){const t=n?e?.[n]??e?.properties?.[n]??o:o;i.set(o,String(t))}}),[...i.entries()].sort((e,t)=>"number"==typeof e[0]&&"number"==typeof t[0]?e[0]-t[0]:String(e[0]).localeCompare(String(t[0]))).map(([e,t])=>({value:e,label:t}))}(n,e.attr,e.labelAttr);if(!i.length)return"rgba(128,128,128,0.5)";let r=t(e.colors||"Bold",Math.max(i.length,3));r&&r.length||(r=o);const l=e.nullColor?`rgb(${e.nullColor.slice(0,3).join(",")})`:"rgba(128,128,128,0.5)",a=["match",["get",e.attr]];return i.forEach((e,t)=>{a.push(e.value),a.push(r[t%r.length])}),a.push(l),e._detectedCategories=i,a}(e,n):"colorContinuous"===i?function(e){if(!e.domain?.length)return null;const[n,i]=e.domain,o=n>i,r=o?[i,n]:[n,i],l=e.steps||7;let a=t(e.colors||"TealGrn",l);if(!a||!a.length)return["interpolate",["linear"],["get",e.attr],r[0],"rgb(237,248,251)",r[1],"rgb(0,109,44)"];o&&a.reverse();const s=["interpolate",["linear"],["get",e.attr]];return a.forEach((e,t)=>{const n=r[0]+(r[1]-r[0])*t/(a.length-1);s.push(n),s.push(e)}),s}(e):null:null}function l(e){if(null==e)return null;try{if("string"==typeof e){const t=e.startsWith("0x")?e.slice(2):e;return/^\d+$/.test(t)?BigInt(t).toString(16):(/[a-f]/i.test(t),t.toLowerCase())}if("number"==typeof e)return BigInt(Math.trunc(e)).toString(16);if("bigint"==typeof e)return e.toString(16)}catch(e){}return null}function a(){return window.deck||null}function s(e){if(!e)return null;if(Array.isArray(e))return e;if("string"==typeof e&&e.startsWith("@@=")){const t=e.slice(3);return e=>{try{return new Function("object",`const properties = object?.properties || object || {}; return (${t});`)(e)}catch{return null}}}if("object"==typeof e&&e["@@function"]){const n=e["@@function"],i=e.attr;if(!i)return null;if("colorContinuous"===n){const n=e.domain;if(!Array.isArray(n)||n.length<2)return null;const o=Number(n[0]),r=Number(n[n.length-1]);if(!Number.isFinite(o)||!Number.isFinite(r)||o===r)return null;const l=Math.max(2,Number(e.steps??7)),a=t(e.colors||"ArmyRose",l)||null;if(!a?.length)return null;const s=o>r,c=!!e.reverse,u=(s?!c:c)?[...a].reverse():[...a],d=Math.min(o,r),y=Math.max(o,r),p=Array.isArray(e.nullColor)?e.nullColor:[184,184,184];return e=>{const t=(e?.properties||e||{})[i];let n=null;if("number"==typeof t)n=t;else if("string"==typeof t){const e=parseFloat(t);n=Number.isFinite(e)?e:null}if(null==n||!Number.isFinite(n))return p;const o=(n-d)/(y-d),r=Math.max(0,Math.min(u.length-1,Math.round(o*(u.length-1)))),l=u[r].replace("#","");return[parseInt(l.slice(0,2),16),parseInt(l.slice(2,4),16),parseInt(l.slice(4,6),16)]}}if("colorCategories"===n){const n=Array.isArray(e.categories)?e.categories:Array.isArray(e.domain)?e.domain:[],o=t(e.colors||"Bold",Math.max(n.length,3))||null,r=Array.isArray(e.nullColor)?e.nullColor:[184,184,184],l=new Map;return o?.length&&n.length&&n.forEach((e,t)=>{const n=o[t%o.length]||"#999999",i=String(n).replace("#",""),r=parseInt(i.slice(0,2),16),a=parseInt(i.slice(2,4),16),s=parseInt(i.slice(4,6),16);l.set(String(e),[r,a,s])}),e=>{const t=(e?.properties||e||{})[i];return null==t?r:l.get(String(t))||r}}}return null}const c=5e3;function u(e,t,n){const i=Math.PI-2*Math.PI*t/Math.pow(2,n),o=e/Math.pow(2,n)*360-180,r=180/Math.PI*Math.atan(Math.sinh(i)),l=Math.PI-2*Math.PI*(t+1)/Math.pow(2,n),a=(e+1)/Math.pow(2,n)*360-180;return{west:o,south:180/Math.PI*Math.atan(Math.sinh(l)),east:a,north:r}}function d(e,t){return!(e.east<t.west||e.west>t.east||e.north<t.south||e.south>t.north)}function y(e){const t=e.hexLayer?.getFillColor;if(!t||"object"!=typeof t||Array.isArray(t))return{enabled:!1,attr:null};if("colorContinuous"!==t["@@function"])return{enabled:!1,attr:null};const n=t.attr||null;if(!n)return{enabled:!1,attr:null};const i=Array.isArray(t.domain)&&t.domain.length>=2;return{enabled:!0===t.autoDomain||!i,attr:n}}function p(e,t,n,i,o){if(e.getZoom()<10)return null;const r=t.tileStore[n.id];if(!r)return null;const l=e.getBounds(),a={west:l.getWest(),east:l.getEast(),south:l.getSouth(),north:l.getNorth()};let s=0;const y=[];for(const[e,t]of Object.entries(r)){const[n,i,r]=e.split("/").map(Number);Number.isFinite(n)&&Number.isFinite(i)&&Number.isFinite(r)&&(Math.abs(n-o)>1||d(u(i,r,n),a)&&(y.push(t),s+=t.length))}if(s<30)return null;const p=Math.max(1,Math.floor(s/c)),f=[];let g=0;for(const e of y){for(const t of e){if(g++,p>1&&g%p!==0)continue;const e=(t?.properties||t||{})[i];let n=null;if("number"==typeof e)n=e;else if("string"==typeof e){const t=parseFloat(e);n=Number.isFinite(t)?t:null}if(null!=n&&Number.isFinite(n)&&f.push(n),f.length>=c)break}if(f.length>=c)break}if(f.length<30)return null;f.sort((e,t)=>e-t);const h=Math.max(0,Math.min(f.length-1,Math.floor(.02*f.length))),m=Math.max(0,Math.min(f.length-1,Math.floor(.98*f.length)));let b=f[h],v=f[Math.max(m,h)];const x=v-b;if(Number.isFinite(x)&&x>0){const e=.01*x;b-=e,v+=e}return b>=v?[b-1,v+1]:[b,v]}function f(e,t){const n=e.hexLayer?.getFillColor;if(!n||"object"!=typeof n)return!1;const i=n._dynamicDomain;return!!(!Array.isArray(i)||i.length<2||(()=>{const e=i[1]-i[0]?i[1]-i[0]:1;return Math.abs(t[0]-i[0])/e>.05||Math.abs(t[1]-i[1])/e>.05})())&&(n._dynamicDomain=t,!0)}function g(e){const t=e.tileLayerConfig||{};return{tileSize:t.tileSize??256,minZoom:t.minZoom??0,maxZoom:t.maxZoom??19,zoomOffset:t.zoomOffset??0,maxRequests:t.maxRequests??10}}function h(e,t,n,i){const o=a();if(!o)return[];const r=o.TileLayer,c=o.H3HexagonLayer||o?.GeoLayers?.H3HexagonLayer;return r&&c?e.filter(e=>"hex"===e.layerType&&e.isTileLayer&&e.tileUrl).map(e=>e).slice().reverse().map(e=>{const o=!1!==t[e.id],a=e.tileUrl,u=g(e),d=e.hexLayer||{},y=d.getFillColor;y&&"object"==typeof y&&!Array.isArray(y)&&Array.isArray(y._dynamicDomain)&&(y.domain=y._dynamicDomain);const p=d.getLineColor;p&&"object"==typeof p&&!Array.isArray(p)&&Array.isArray(p._dynamicDomain)&&(p.domain=p._dynamicDomain);const f=s(y),h=s(p),m=!1!==d.stroked,b=!1!==d.filled,v=!0===d.extruded,x="number"==typeof d.opacity?d.opacity:.8,w=d.lineWidthMinPixels??1,C=d.elevationScale??1,L=d.coverage??.9;return new r({id:`${e.id}-tiles`,data:a,tileSize:u.tileSize,minZoom:u.minZoom,maxZoom:u.maxZoom,zoomOffset:u.zoomOffset,maxRequests:u.maxRequests,refinementStrategy:"best-available",pickable:!0,visible:o,getTileData:async({index:t,signal:o})=>{const{x:r,y:s,z:c}=t,u=a.replace("{z}",c).replace("{x}",r).replace("{y}",s),d=u,y=`${c}/${r}/${s}`;if(n.cache.has(d))return n.cache.get(d);if(n.inflight.has(d))try{return await n.inflight.get(d)}catch{return n.cache.get(d)||[]}i(1);const p=(async()=>{try{const i=await fetch(u,{signal:o});if(o?.aborted)return null;if(!i.ok)throw new Error(`tile http ${i.status}`);const a=(i.headers.get("Content-Type")||"").toLowerCase();let s;if(a.includes("application/octet-stream")||a.includes("application/parquet")||u.endsWith(".parquet")){const e=window.hyparquet;if(!e?.parquetMetadataAsync||!e?.parquetReadObjects)return null;const t=await i.arrayBuffer();if(o?.aborted)return null;if(!t||0===t.byteLength)return[];const n={byteLength:t.byteLength,slice:async(e,n)=>t.slice(e,n)},r=await e.parquetMetadataAsync(n);if(o?.aborted)return null;s=await e.parquetReadObjects({file:n,utf8:!1,metadata:r})}else{let e=await i.text();if(o?.aborted)return null;e=e.replace(/\"(hex|h3|index|id)\"\s*:\s*(\d+)/gi,(e,t,n)=>`"${t}":"${n}"`),s=JSON.parse(e)}const c=(r=s,t=(Array.isArray(r)?r:Array.isArray(r?.data)?r.data:Array.isArray(r?.features)?r.features:[]).map(e=>e?.properties?{...e.properties}:{...e}).map(e=>{const t=l(e.hex??e.h3??e.index??e.id);if(!t)return null;const n={...e,hex:t};return{...n,properties:{...n}}}).filter(Boolean),(t||[]).map(e=>{const t=function(e){const t={};for(const n of Object.keys(e||{})){const i=e[n];if("bigint"==typeof i){const e=String(n).toLowerCase();"hex"===e||"h3"===e||"index"===e||"id"===e?t[n]=i.toString(16):i<=BigInt(Number.MAX_SAFE_INTEGER)&&i>=BigInt(Number.MIN_SAFE_INTEGER)?t[n]=Number(i):t[n]=i.toString()}else t[n]=i}return t}(e?.properties?e.properties:e||{});return{...t,properties:{...t}}}));return n.cache.set(d,c),n.tileStore[e.id]||(n.tileStore[e.id]={}),n.tileStore[e.id][y]=c,c}catch(e){return null}finally{n.inflight.delete(d),i(-1)}var t,r})();return n.inflight.set(d,p),await p},renderSubLayers:e=>{const t=e.data||[];return t&&t.length?new c({id:`${e.id}-h3`,data:t,getHexagon:e=>e.hex,pickable:!0,stroked:m,filled:b,extruded:v,opacity:x,coverage:L,lineWidthMinPixels:w,elevationScale:C,...f?{getFillColor:f}:{},...h?{getLineColor:h}:{}}):null}})}):[]}const m={};function b(e,t,i,o){!function(e,t){t.forEach(t=>{[`${t.id}-fill`,`${t.id}-extrusion`,`${t.id}-outline`,`${t.id}-circle`,`${t.id}-line`,`${t.id}-raster`].forEach(t=>{try{e.getLayer(t)&&e.removeLayer(t)}catch(e){}});try{e.getSource(t.id)&&e.removeSource(t.id)}catch(e){}})}(e,t),[...t].reverse().forEach(t=>{const o=!1!==i[t.id];switch(t.layerType){case"hex":{const i=t;if(i.isTileLayer);else if(i.data?.length){const a=function(e){const t=[];for(const n of e){const e=l(n.hex??n.h3??n.index??n.id);if(e&&window.h3?.isValidCell(e))try{const i=window.h3.cellToBoundary(e).map(([e,t])=>[t,e]);i.push(i[0]),t.push({type:"Feature",properties:{...n,hex:e},geometry:{type:"Polygon",coordinates:[i]}})}catch(e){}}return{type:"FeatureCollection",features:t}}(i.data);m[t.id]=a,function(e,t,i,o){const l=t.hexLayer||{},a=t.data||[];e.addSource(t.id,{type:"geojson",data:i});const s=Array.isArray(l.getFillColor)?n(l.getFillColor,.8):r(l.getFillColor,a)||"rgba(0,144,255,0.7)",c=l.getLineColor?Array.isArray(l.getLineColor)?n(l.getLineColor,1):r(l.getLineColor,a):"rgba(255,255,255,0.3)",u="number"==typeof l.opacity&&isFinite(l.opacity)?Math.max(0,Math.min(1,l.opacity)):.8;if(l.extruded){const n=l.elevationScale||1;e.addLayer({id:`${t.id}-extrusion`,type:"fill-extrusion",source:t.id,paint:{"fill-extrusion-color":s,"fill-extrusion-height":l.getFillColor?.attr?["*",["get",l.getFillColor.attr],n]:100,"fill-extrusion-base":0,"fill-extrusion-opacity":u},layout:{visibility:o?"visible":"none"}})}else!1!==l.filled&&e.addLayer({id:`${t.id}-fill`,type:"fill",source:t.id,paint:{"fill-color":s,"fill-opacity":u},layout:{visibility:o?"visible":"none"}});e.addLayer({id:`${t.id}-outline`,type:"line",source:t.id,paint:{"line-color":c,"line-width":l.lineWidthMinPixels||.5},layout:{visibility:o?"visible":"none"}})}(e,i,a,o)}break}case"vector":{const n=t;n.geojson&&(m[t.id]=n.geojson,function(e,t,n){const i=t.geojson;if(!i?.features?.length)return;e.addSource(t.id,{type:"geojson",data:i});const o=i.features.map(e=>e.properties||{}),l=t.fillColorConfig?.["@@function"]?r(t.fillColorConfig,o):t.fillColorRgba||"rgba(0,144,255,0.6)",a=t.lineColorConfig?.["@@function"]?r(t.lineColorConfig,o):t.lineColorRgba||"rgba(100,100,100,0.8)",s="number"==typeof t.lineWidth&&isFinite(t.lineWidth)?t.lineWidth:1,c="number"==typeof t.opacity&&isFinite(t.opacity)?Math.max(0,Math.min(1,t.opacity)):.8;let u=!1,d=!1,y=!1;for(const e of i.features){const t=e.geometry?.type;"Point"!==t&&"MultiPoint"!==t||(d=!0),"Polygon"!==t&&"MultiPolygon"!==t||(u=!0),"LineString"!==t&&"MultiLineString"!==t||(y=!0)}u&&(!1!==t.isFilled&&e.addLayer({id:`${t.id}-fill`,type:"fill",source:t.id,paint:{"fill-color":l,"fill-opacity":c},filter:["any",["==",["geometry-type"],"Polygon"],["==",["geometry-type"],"MultiPolygon"]],layout:{visibility:n?"visible":"none"}}),!1!==t.isStroked&&e.addLayer({id:`${t.id}-outline`,type:"line",source:t.id,layout:{"line-join":"round","line-cap":"round",visibility:n?"visible":"none"},paint:{"line-color":a,"line-width":s},filter:["any",["==",["geometry-type"],"Polygon"],["==",["geometry-type"],"MultiPolygon"]]})),y&&e.addLayer({id:`${t.id}-line`,type:"line",source:t.id,layout:{"line-join":"round","line-cap":"round",visibility:n?"visible":"none"},paint:{"line-color":a,"line-width":s,"line-opacity":1},filter:["any",["==",["geometry-type"],"LineString"],["==",["geometry-type"],"MultiLineString"]]}),d&&e.addLayer({id:`${t.id}-circle`,type:"circle",source:t.id,paint:{"circle-radius":t.pointRadius||6,"circle-color":l,"circle-stroke-color":"rgba(0,0,0,0.5)","circle-stroke-width":1,"circle-opacity":.9},filter:["any",["==",["geometry-type"],"Point"],["==",["geometry-type"],"MultiPoint"]],layout:{visibility:n?"visible":"none"}})}(e,n,o));break}case"mvt":!function(e,t,n){const i=t.sourceLayer||"udf";e.addSource(t.id,{type:"vector",tiles:[t.tileUrl],minzoom:t.minzoom||0,maxzoom:t.maxzoom||22});const o=t.fillColor||"#FFF5CC",r=t.lineColor||"#FFFFFF",l=t.fillOpacity??.8,a=t.lineWidth??1;!1!==t.isFilled&&e.addLayer({id:`${t.id}-fill`,type:"fill",source:t.id,"source-layer":i,paint:{"fill-color":o,"fill-opacity":l},layout:{visibility:n?"visible":"none"}}),e.addLayer({id:`${t.id}-line`,type:"line",source:t.id,"source-layer":i,paint:{"line-color":r,"line-width":a},layout:{visibility:n?"visible":"none"}}),t.isExtruded&&e.addLayer({id:`${t.id}-extrusion`,type:"fill-extrusion",source:t.id,"source-layer":i,paint:{"fill-extrusion-color":o,"fill-extrusion-height":["*",["get",t.heightProperty||"height"],t.heightMultiplier||1],"fill-extrusion-base":0,"fill-extrusion-opacity":t.extrusionOpacity??.9},layout:{visibility:n?"visible":"none"}})}(e,t,o);break;case"raster":!function(e,t,n){const i=t.opacity??t.rasterLayer?.opacity??1;e.addSource(t.id,{type:"raster",tiles:[t.tileUrl],tileSize:256}),e.addLayer({id:`${t.id}-raster`,type:"raster",source:t.id,paint:{"raster-opacity":Math.max(0,Math.min(1,i))},layout:{visibility:n?"visible":"none"}})}(e,t,o)}});let s=null;if(t.some(e=>"hex"===e.layerType&&e.isTileLayer&&e.tileUrl)){const n=function(e,t,n){const i=a();if(!i?.MapboxOverlay||!i?.TileLayer)return null;const o={cache:new Map,inflight:new Map,tilesLoading:0,tileStore:{}},r=function(){let e=document.getElementById("tile-loader");e||(e=document.createElement("div"),e.id="tile-loader",e.innerHTML='<div class="loader-spinner"></div><span id="loader-text">Loading tiles...</span>',document.body.appendChild(e));const t=document.getElementById("loader-text");let n=null,i=0;return{setLoading:o=>{i=Math.max(0,i+o),e&&(i>0?(n&&clearTimeout(n),e.classList.add("active"),t&&(t.textContent=1===i?"Loading tile...":`Loading ${i} tiles...`)):n=setTimeout(()=>e?.classList.remove("active"),300))}}}(),l=()=>h(t,n,o,r.setLoading),s=new i.MapboxOverlay({interleaved:!0,useDevicePixels:!0,layers:l()});try{e.addControl(s)}catch{}const c=()=>{try{s.setProps({layers:l()});try{e.triggerRepaint?.()}catch{}}catch{}},u=t.filter(e=>"hex"===e.layerType&&e.isTileLayer).map(e=>({layer:e,...y(e),tileCfg:g(e)})).filter(e=>e.enabled&&e.attr);let d=null;const m=t=>{u.length&&(d&&clearTimeout(d),d=setTimeout(()=>{let t=!1;for(const n of u){const i=Math.round(e.getZoom())+(n.tileCfg.zoomOffset||0),r=p(e,o,n.layer,n.attr,i);r&&f(n.layer,r)&&(t=!0)}if(t){c();try{window.dispatchEvent(new CustomEvent("fusedmaps:legend:update"))}catch{}}},t))},b=()=>m(800),v=()=>m(1200);return u.length&&(e.on("moveend",b),e.on("idle",v),m(1500)),{overlay:s,rebuild:c,pickObject:e=>{try{return s.pickObject(e)}catch{return null}},destroy:()=>{d&&clearTimeout(d);try{e.off("moveend",b)}catch{}try{e.off("idle",v)}catch{}try{e.removeControl(s)}catch{}}}}(e,t,i);s=n?.overlay||null,s&&n&&(s.__fused_hex_tiles__=n)}return{deckOverlay:s}}let v=null;function x(e,i){const o=document.getElementById("layer-list");o&&(o.innerHTML=e.map(e=>{const o=!1!==i[e.id],r=function(e){let i="#0090ff";const o=e=>e&&e.length?1===e.length?e[0]:`linear-gradient(to bottom, ${e.map((t,n)=>`${t} ${n/(e.length-1)*100}%`).join(", ")})`:null;if("hex"===e.layerType){const r=e.hexLayer||{},l=!1===r.filled&&r.getLineColor?r.getLineColor:r.getFillColor;if(Array.isArray(l)){const e=n(l,1);e&&(i=e)}else if(l&&"object"==typeof l){const e=l["@@function"];if("colorContinuous"===e||"colorCategories"===e){let n=t(l.colors||("colorCategories"===e?"Bold":"TealGrn"),l.steps||7);if(n?.length){const e=l.domain,t=Array.isArray(e)&&e.length>=2&&e[0]>e[e.length-1],r=!!l.reverse;(t?!r:r)&&(n=[...n].reverse()),i=o(n)||i}}}}else if("vector"===e.layerType){const n=e;if(n.lineColorRgba&&!n.isFilled)i=n.lineColorRgba;else if(n.fillColorRgba)i=n.fillColorRgba;else if(n.fillColorConfig&&"object"==typeof n.fillColorConfig){const e=n.fillColorConfig.colors;if(e){const n=t(e,7);n?.length&&(i=o(n)||i)}}}else"raster"===e.layerType&&(i="linear-gradient(to bottom, #888, #444)");return i}(e),l=o?'<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>':'<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/></svg>';return`\n      <div class="layer-item ${o?"":"disabled"}" \n           data-layer-id="${e.id}" \n           style="--layer-strip: ${r};" \n           onclick="onLayerItemClick(event, '${e.id}')">\n        <span class="layer-name">${e.name}</span>\n        <span class="layer-eye" onclick="event.stopPropagation(); toggleLayerVisibility('${e.id}', ${!o})">${l}</span>\n      </div>\n    `}).join(""))}function w(e,n,r){const l=document.getElementById("color-legend");if(!l)return;const a=e.filter(e=>!1!==n[e.id]);if(!a.length)return void(l.style.display="none");let s="";a.forEach(e=>{const n=function(e){let n=null;if("hex"===e.layerType){const t=e.hexLayer||{};n=!1===t.filled&&t.getLineColor?t.getLineColor:t.getFillColor}else if("vector"===e.layerType){const t=e;if(n=t.fillColorConfig,!n?.["@@function"]&&t.lineColorRgba&&!t.isFilled)return`\n        <div class="legend-layer">\n          <div class="legend-title">\n            <span class="legend-line" style="background:${t.lineColorRgba};"></span>\n            ${e.name}\n          </div>\n        </div>\n      `}const r=n?.["@@function"];if(!r||!n?.attr)return"";if("colorContinuous"!==r&&"colorCategories"!==r)return"";const l=n.colors||("colorCategories"===r?"Bold":"TealGrn");return"colorCategories"===r?function(e,n,i){let r=n._detectedCategories||n.categories||[];if(r=r.map(e=>"object"==typeof e&&e.label?e:{value:e,label:e}),!r.length)return"";let l=t(i,Math.max(r.length,3));l?.length||(l=o);const a=n.labelAttr||n.attr;return`\n    <div class="legend-layer">\n      <div class="legend-title">\n        <span class="legend-dot" style="background:${l[0]};"></span>\n        ${e}: ${a}\n      </div>\n      <div class="legend-categories">\n        ${r.map((e,t)=>`\n          <div class="legend-cat-item">\n            <div class="legend-cat-swatch" style="background:${l[t%l.length]};"></div>\n            <span class="legend-cat-label" title="${e.label}">${e.label}</span>\n          </div>\n        `).join("")}\n      </div>\n    </div>\n  `}(e.name,n,l):"colorContinuous"===r?function(e,n,o){const r=n._dynamicDomain||n.domain;if(!r?.length)return"";const[l,a]=r,s=l>a;let c=t(o,n.steps||7);c?.length||(c=i),s&&(c=[...c].reverse());const u=`linear-gradient(to right, ${c.map((e,t)=>`${e} ${t/(c.length-1)*100}%`).join(", ")})`;return`\n    <div class="legend-layer">\n      <div class="legend-title">\n        <span class="legend-dot" style="background:${c[Math.floor(c.length/2)]};"></span>\n        ${e}: ${n.attr}\n      </div>\n      <div class="legend-gradient" style="background:${u};"></div>\n      <div class="legend-labels">\n        <span>${l.toFixed(1)}</span>\n        <span>${a.toFixed(1)}</span>\n      </div>\n    </div>\n  `}(e.name,n,l):""}(e);n&&(s+=n)}),s?(l.innerHTML=s,l.style.display="block"):l.style.display="none"}let C=!1,L=null;function $(e,t){let n={type:"FeatureCollection",features:[]};if(t){const e=t.properties||{},i=e.hex||e.h3;if(i&&window.h3)try{const t=l(i);if(t&&window.h3.isValidCell(t)){const i=window.h3.cellToBoundary(t).map(([e,t])=>[t,e]);i.push(i[0]),n.features.push({type:"Feature",geometry:{type:"Polygon",coordinates:[i]},properties:e})}}catch(e){}else t.geometry&&n.features.push({type:"Feature",geometry:t.geometry,properties:e})}C?e.getSource("feature-hl").setData(n):(e.addSource("feature-hl",{type:"geojson",data:n}),e.addLayer({id:"feature-hl-fill",type:"fill",source:"feature-hl",paint:{"fill-color":"rgba(255,255,0,0.3)","fill-opacity":1}}),e.addLayer({id:"feature-hl-line",type:"line",source:"feature-hl",paint:{"line-color":"rgba(255,255,0,1)","line-width":3}}),C=!0),L=t}function M(e){let t=null,n=null;try{"BroadcastChannel"in window&&(t=new BroadcastChannel(e))}catch(e){}function i(e){if(!n)return;let t;try{t="string"==typeof e.data?JSON.parse(e.data):e.data}catch{return}n(t)}return{send:function(e){const n=JSON.stringify(e);try{t&&t.postMessage(e)}catch(e){}try{window.parent.postMessage(n,"*")}catch(e){}try{window.top&&window.top!==window.parent&&window.top.postMessage(n,"*")}catch(e){}try{if(window.top?.frames)for(let e=0;e<window.top.frames.length;e++){const t=window.top.frames[e];if(t!==window)try{t.postMessage(n,"*")}catch(e){}}}catch(e){}},onMessage:function(e){n=e,t&&(t.onmessage=e=>{n&&n(e.data)}),window.addEventListener("message",i)},destroy:function(){t&&(t.close(),t=null),window.removeEventListener("message",i),n=null}}}function F(e="component"){return`${e}-${Math.random().toString(36).substr(2,9)}`}function T(e,t,n){t.broadcast?.enabled&&function(e,t={}){const n=t.channel||"fused-bus",i=t.dataset||"all",o=F("map-broadcast"),r=M(n);let l=null;function a(){const t=function(e){const t=e.getBounds();return[+t.getWest().toFixed(6),+t.getSouth().toFixed(6),+t.getEast().toFixed(6),+t.getNorth().toFixed(6)]}(e);if(a=l,(n=t)&&a&&n[0]===a[0]&&n[1]===a[1]&&n[2]===a[2]&&n[3]===a[3])return;var n,a;l=t;const[s,c,u,d]=t;r.send({type:"filter",fromComponent:o,timestamp:Date.now(),dataset:i,filter:{type:"spatial",field:"geometry",values:[s,c,u,d]}}),r.send({type:"spatial_filter",source:o,timestamp:Date.now(),bounds:{sw:{lng:s,lat:c},ne:{lng:u,lat:d}}})}e.on("move",a),e.on("moveend",a),e.on("load",()=>{setTimeout(a,300)}),e.loaded()&&setTimeout(a,100),setTimeout(()=>{r.send({type:"component_ready",componentType:"map",componentId:o,capabilities:["spatial_filter"],dataSource:"viewport",protocol:"unified"})},200)}(e,{channel:t.broadcast.channel,dataset:t.broadcast.dataset}),t.sync?.enabled&&function(e,t={}){let n=t.channel||"default";n.includes("::")||(n=`map-sync::${n}`);const i=F("map"),o=M(n);let r=!1,l=!1,a={x:NaN,y:NaN,z:NaN};const s=(e,t,n)=>Math.abs(e-t)<n;function c(){const t=e.getCenter();return{longitude:+t.lng.toFixed(6),latitude:+t.lat.toFixed(6),zoom:+e.getZoom().toFixed(3),bearing:+e.getBearing().toFixed(1),pitch:+e.getPitch().toFixed(1),id:i,ts:Date.now()}}function u(){if(r)return;const e=c(),{longitude:t,latitude:n,zoom:i}=e;s(t,a.x,1e-6)&&s(n,a.y,1e-6)&&s(i,a.z,.001)||(a={x:t,y:n,z:i},o.send({type:"sync",...e}))}let d=null;const y=()=>{l=!0},p=()=>{l&&(l=!1,u())};e.on("dragstart",y),e.on("zoomstart",y),e.on("rotatestart",y),e.on("pitchstart",y),e.on("moveend",p),e.on("move",()=>{l&&!r&&(d&&clearTimeout(d),d=setTimeout(u,0))}),o.onMessage(t=>{var n;"sync"===t.type&&t.id!==i&&(n=t)&&n.id!==i&&(r||l||(r=!0,e.jumpTo({center:[n.longitude,n.latitude],zoom:n.zoom,bearing:n.bearing,pitch:n.pitch}),requestAnimationFrame(()=>{r=!1})))}),e.on("load",()=>{setTimeout(()=>o.send({type:"sync",...c()}),100+100*Math.random())}),document.addEventListener("visibilitychange",()=>{document.hidden&&(r=!1,l=!1)})}(e,{channel:t.sync.channel}),t.clickBroadcast,t.locationListener}const A={};function E(e){const t=e.containerId||"map";try{const t="light"===e.ui?.theme?"light":"dark";document.documentElement.setAttribute("data-theme",t)}catch(e){}e.layers.forEach(e=>{A[e.id]=!1!==e.visible});const n=function(e){const{containerId:t,mapboxToken:n,styleUrl:i,initialViewState:o}=e;return window.mapboxgl.accessToken=n,new window.mapboxgl.Map({container:t,style:i,center:[o.longitude,o.latitude],zoom:o.zoom,pitch:o.pitch||0,bearing:o.bearing||0,projection:"mercator"})}({containerId:t,mapboxToken:e.mapboxToken,styleUrl:e.styleUrl,initialViewState:e.initialViewState});let i=null,o=null;return!1!==e.ui?.layerPanel&&function(t,o){v=(t,o)=>{S(t,o,n,e,i)};let r=document.getElementById("layer-panel");r||(r=document.createElement("div"),r.id="layer-panel",r.innerHTML='<div id="layer-list"></div>',document.body.appendChild(r)),window.toggleLayerVisibility=(e,t)=>{v&&v(e,t)},window.onLayerItemClick=(e,t)=>{try{if(e&&e.target.closest?.(".layer-eye"))return}catch(e){}const n=!1!==o[t];v&&v(t,!n)},x(t,o)}(e.layers,A),!1!==e.ui?.legend&&function(e,t){let n=document.getElementById("color-legend");n||(n=document.createElement("div"),n.id="color-legend",n.className="color-legend",n.style.display="none",document.body.appendChild(n)),w(e,t)}(e.layers,A),n.on("load",()=>{const t=b(n,e.layers,A);i=t.deckOverlay,x(e.layers,A),w(e.layers,A),o=()=>{w(e.layers,A)};try{window.addEventListener("fusedmaps:legend:update",o)}catch(e){}!1!==e.ui?.tooltip&&function(e,t,n,i){let o=document.getElementById("tooltip");o||(o=document.createElement("div"),o.id="tooltip",document.body.appendChild(o));const r=[];t.forEach(e=>{if(e.isTileLayer)return;const t=[];"hex"===e.layerType?((e.hexLayer||{}).extruded?t.push(`${e.id}-extrusion`):t.push(`${e.id}-fill`),t.push(`${e.id}-outline`)):"vector"===e.layerType?t.push(`${e.id}-fill`,`${e.id}-outline`,`${e.id}-circle`,`${e.id}-line`):"mvt"===e.layerType&&t.push(`${e.id}-fill`,`${e.id}-line`,`${e.id}-extrusion`),t.forEach(t=>{r.push({layerId:t,layerDef:e})})}),e.on("mousemove",l=>{const a=r.map(e=>e.layerId).filter(t=>e.getLayer(t)),s=e=>{const n=t.findIndex(t=>t.id===e);return-1===n?Number.POSITIVE_INFINITY:n};let c=null,u=Number.POSITIVE_INFINITY;if(a.length){const t=e.queryRenderedFeatures(l.point,{layers:a});for(const e of t||[]){const t=r.find(t=>t.layerId===e.layer?.id);if(!t)continue;if(!1===n[t.layerDef.id])continue;const i=s(t.layerDef.id);i<u&&(u=i,c={type:"mapbox",layerDef:t.layerDef,props:e.properties||{}});break}}if(i){const e=i.__fused_hex_tiles__,o=e?.pickObject||i?.pickObject;try{const e=o?.({x:l.point.x,y:l.point.y,radius:4});if(e?.object){const i=String(e.layer?.id||""),o=i.includes("-tiles")?i.split("-tiles")[0]:i,r=t.find(e=>e.id===o);if(r&&!1!==n[r.id]){const t=s(r.id);t<u&&(u=t,c={type:"deck",layerDef:r,props:e.object.properties||e.object||{}})}}}catch(e){}}if(!c)return o.style.display="none",void(e.getCanvas().style.cursor="");e.getCanvas().style.cursor="pointer";const d=function(e){if("hex"===e.layerType){const t=e;return t.hexLayer?.tooltipColumns||t.hexLayer?.tooltipAttrs||t.tooltipColumns||[]}if("vector"===e.layerType){const t=e;return t.vectorLayer?.tooltipColumns||t.vectorLayer?.tooltipAttrs||t.tooltipColumns||[]}return e.tooltipColumns||[]}(c.layerDef),y=function(e,t){const n=[];return null!=e.hex&&n.push(`<span class="tt-row"><span class="tt-key">hex</span><span class="tt-val">${String(e.hex).slice(0,12)}...</span></span>`),t.length?(t.forEach(t=>{if("hex"===t)return;const i=e[t];if(null==i)return;const o="number"==typeof i?Number(i).toFixed(2):String(i);n.push(`<span class="tt-row"><span class="tt-key">${t}</span><span class="tt-val">${o}</span></span>`)}),n):(0===n.length&&Object.keys(e).slice(0,5).forEach(t=>{n.push(`<span class="tt-row"><span class="tt-key">${t}</span><span class="tt-val">${e[t]}</span></span>`)}),n)}(c.props,d);y.length?(o.innerHTML=`<strong class="tt-title">${c.layerDef.name}</strong>`+y.join(""),o.style.left=`${l.point.x+10}px`,o.style.top=`${l.point.y+10}px`,o.style.display="block"):o.style.display="none"}),e.on("mouseleave",()=>{e.getCanvas().style.cursor="",o.style.display="none"})}(n,e.layers,A,i),!1!==e.highlightOnClick&&function(e,t,n,i){e.on("click",n=>{const o=function(e,t){const n=[];return t.forEach(t=>{if(t.isTileLayer)return;const i=t.layerType;let o=[];if("vector"===i)o=[`${t.id}-fill`,`${t.id}-circle`,`${t.id}-line`];else if("hex"===i){const e=t;o=[e.hexLayer?.extruded?`${t.id}-extrusion`:`${t.id}-fill`]}o.forEach(t=>{try{e.getLayer(t)&&n.push(t)}catch(e){}})}),["gdf-fill","gdf-circle","hex-fill"].forEach(t=>{try{e.getLayer(t)&&n.push(t)}catch(e){}}),n}(e,t);if(!o.length)return;let r=[];try{r=e.queryRenderedFeatures(n.point,{layers:o})||[]}catch(e){}if(r.length>0)$(e,r[0]);else if(i){const t=i?.pickObject?.({x:n.point.x,y:n.point.y,radius:4});t?.object?$(e,{properties:t.object.properties||t.object,geometry:null}):L&&$(e,null)}else L&&$(e,null)})}(n,e.layers,0,i),e.messaging&&T(n,e.messaging,e.layers),e.hasCustomView||function(e,t){const n=new mapboxgl.LngLatBounds,i=m;t.forEach(e=>{if(e.isTileLayer)return;const t=i[e.id];t?.features?.length&&t.features.forEach(e=>{"Point"===e.geometry?.type?n.extend(e.geometry.coordinates):"Polygon"===e.geometry?.type||"MultiPolygon"===e.geometry?.type?("Polygon"===e.geometry.type?[e.geometry.coordinates]:e.geometry.coordinates).forEach(e=>e[0]?.forEach(e=>n.extend(e))):"LineString"===e.geometry?.type&&e.geometry.coordinates.forEach(e=>n.extend(e))})}),n.isEmpty()||e.fitBounds(n,{padding:50,maxZoom:15,duration:500})}(n,e.layers)}),n.on("load",()=>{[100,500,1e3].forEach(e=>setTimeout(()=>n.resize(),e))}),window.addEventListener("resize",()=>n.resize()),document.addEventListener("visibilitychange",()=>{document.hidden||setTimeout(()=>n.resize(),100)}),{map:n,deckOverlay:i,setLayerVisibility:(t,o)=>{S(t,o,n,e,i)},updateLegend:()=>{w(e.layers,A)},destroy:()=>{try{i?.__fused_hex_tiles__?.destroy?.()}catch(e){}try{o&&window.removeEventListener("fusedmaps:legend:update",o)}catch(e){}n.remove?.()}}}function S(e,t,n,i,o){A[e]=t,function(e,t,n,i,o){const r=i.find(e=>e.id===t);if(r)switch(r.layerType){case"hex":{const i=r;if(i.isTileLayer){const e=o?.__fused_hex_tiles__;try{e?.rebuild?.()}catch(e){}}else!function(e,t,n,i){(i?[`${t}-extrusion`,`${t}-outline`]:[`${t}-fill`,`${t}-outline`]).forEach(t=>{try{e.getLayer(t)&&e.setLayoutProperty(t,"visibility",n?"visible":"none")}catch(e){}})}(e,t,n,!0===i.hexLayer?.extruded);break}case"vector":case"mvt":!function(e,t,n){[`${t}-fill`,`${t}-outline`,`${t}-line`,`${t}-circle`,`${t}-extrusion`].forEach(t=>{try{e.getLayer(t)&&e.setLayoutProperty(t,"visibility",n?"visible":"none")}catch(e){}})}(e,t,n);break;case"raster":!function(e,t,n){const i=`${t}-raster`;try{e.getLayer(i)&&e.setLayoutProperty(i,"visibility",n?"visible":"none")}catch(e){}}(e,t,n)}}(n,e,t,i.layers,o),x(i.layers,A),w(i.layers,A)}"undefined"!=typeof window&&(window.FusedMaps={init:E});var k={init:E};e.default=k,e.init=E,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=fusedmaps.umd.js.map
