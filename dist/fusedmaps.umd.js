!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).FusedMaps={})}(this,function(e){"use strict";function t(e){const t=e.getCenter();return{longitude:t.lng,latitude:t.lat,zoom:e.getZoom(),pitch:e.getPitch(),bearing:e.getBearing()}}function n(e,t){const n=window.cartocolor;if(!n)return null;const i=n[e];if(!i)return null;const o=Object.keys(i).map(Number).filter(e=>!isNaN(e)).sort((e,t)=>e-t),r=o.find(e=>e>=t)||o[o.length-1];return i[r]?[...i[r]]:null}function i(e,t){if(!Array.isArray(e)||e.length<3)return null;const[n,i,o]=e;return`rgba(${n},${i},${o},${e.length>=4?e[3]/255:t??1})`}const o=["#e0f3db","#ccebc5","#a8ddb5","#7bccc4","#4eb3d3","#2b8cbe","#0868ac","#084081"],r=["#7F3C8D","#11A579","#3969AC","#F2B701","#E73F74","#80BA5A","#E68310","#008695","#CF1C90","#f97b72"];function l(e,t,n){const i=new Map;return(e||[]).forEach(e=>{const o=e?.[t]??e?.properties?.[t];if(null!=o&&""!==o&&"null"!==o&&!i.has(o)){const t=n?e?.[n]??e?.properties?.[n]??o:o;i.set(o,String(t))}}),[...i.entries()].sort((e,t)=>"number"==typeof e[0]&&"number"==typeof t[0]?e[0]-t[0]:String(e[0]).localeCompare(String(t[0]))).map(([e,t])=>({value:e,label:t}))}function a(e,t){if(!e)return null;if(Array.isArray(e))return null;if("string"==typeof e)return e;const i=e["@@function"],o=e.attr;return i&&o?"colorCategories"===i?function(e,t){const i=Array.isArray(e.domain)?e.domain:[];let o=e.categories?e.categories.map(e=>"object"==typeof e?e:{value:e,label:String(e)}):i.length?i.map(e=>({value:e,label:String(e?.label??e)})):l(t,e.attr,e.labelAttr);if(!o.length)return"rgba(128,128,128,0.5)";let a=n(e.colors||"Bold",Math.max(o.length,3));a&&a.length||(a=r);const s=e.nullColor?`rgb(${e.nullColor.slice(0,3).join(",")})`:"rgba(128,128,128,0.5)",c=["match",["get",e.attr]];return o.forEach((e,t)=>{c.push(e.value),c.push(a[t%a.length])}),c.push(s),e._detectedCategories=o,c}(e,t):"colorContinuous"===i?function(e){if(!e.domain?.length)return null;const[t,i]=e.domain,o=t>i,r=o?[i,t]:[t,i],l=!!e.reverse,a=e.steps||7;let s=n(e.colors||"TealGrn",a);if(!s||!s.length)return["interpolate",["linear"],["get",e.attr],r[0],"rgb(237,248,251)",r[1],"rgb(0,109,44)"];(o?!l:l)&&(s=[...s].reverse());const c=["interpolate",["linear"],["get",e.attr]];return s.forEach((e,t)=>{const n=r[0]+(r[1]-r[0])*t/(s.length-1);c.push(n),c.push(e)}),c}(e):null:null}function s(e){if(null==e)return null;try{if("string"==typeof e){const t=e.startsWith("0x")?e.slice(2):e;return/^\d+$/.test(t)?BigInt(t).toString(16):(/[a-f]/i.test(t),t.toLowerCase())}if("number"==typeof e)return BigInt(Math.trunc(e)).toString(16);if("bigint"==typeof e)return e.toString(16)}catch(e){}return null}function c(e){const t=[];for(const n of e){const e=s(n.hex??n.h3??n.index??n.id);if(e&&window.h3?.isValidCell(e))try{const i=window.h3.cellToBoundary(e).map(([e,t])=>[t,e]);i.push(i[0]),t.push({type:"Feature",properties:{...n,hex:e},geometry:{type:"Polygon",coordinates:[i]}})}catch(e){}}return{type:"FeatureCollection",features:t}}function d(e,t,n,o){const r=t.hexLayer||{},l=t.data||[];try{const i=e.getSource(t.id);i&&"function"==typeof i.setData?i.setData(n):i||e.addSource(t.id,{type:"geojson",data:n})}catch(e){}const s=Array.isArray(r.getFillColor)?i(r.getFillColor,.8):a(r.getFillColor,l)||"rgba(0,144,255,0.7)",c=r.getLineColor?Array.isArray(r.getLineColor)?i(r.getLineColor,1):a(r.getLineColor,l):"rgba(255,255,255,0.3)",d="number"==typeof r.opacity&&isFinite(r.opacity)?Math.max(0,Math.min(1,r.opacity)):.8;if(r.extruded){const n=r.elevationScale||1,i=r.elevationProperty||r.getFillColor?.attr||null;e.addLayer({id:`${t.id}-extrusion`,type:"fill-extrusion",source:t.id,paint:{"fill-extrusion-color":s,"fill-extrusion-height":i?["*",["to-number",["get",i],0],n]:100,"fill-extrusion-base":0,"fill-extrusion-opacity":d},layout:{visibility:o?"visible":"none"}})}else!1!==r.filled&&e.addLayer({id:`${t.id}-fill`,type:"fill",source:t.id,paint:{"fill-color":s,"fill-opacity":d},layout:{visibility:o?"visible":"none"}});!1!==r.stroked&&e.addLayer({id:`${t.id}-outline`,type:"line",source:t.id,paint:{"line-color":c,"line-width":r.lineWidthMinPixels||.5},layout:{visibility:o?"visible":"none"}})}let u=null;function p(){return window.deck||null}function y(e,t,i){if(!i)return null;if(Array.isArray(i))return i;if("string"==typeof i&&i.startsWith("@@=")){const e=i.slice(3);return t=>{try{return new Function("object",`const properties = object?.properties || object || {}; return (${e});`)(t)}catch{return null}}}if("object"==typeof i&&i["@@function"]){const o=i["@@function"],r=i.attr;if(!r)return null;if("colorContinuous"===o){const e=i.domain;if(!Array.isArray(e)||e.length<2)return null;const t=Number(e[0]),o=Number(e[e.length-1]);if(!Number.isFinite(t)||!Number.isFinite(o)||t===o)return null;const l=Math.max(2,Number(i.steps??7)),a=n(i.colors||"ArmyRose",l)||null;if(!a?.length)return null;const s=t>o,c=!!i.reverse,d=(s?!c:c)?[...a].reverse():[...a],u=Math.min(t,o),p=Math.max(t,o),y=Array.isArray(i.nullColor)?i.nullColor:[184,184,184];return e=>{const t=(e?.properties||e||{})[r];let n=null;if("number"==typeof t)n=t;else if("string"==typeof t){const e=parseFloat(t);n=Number.isFinite(e)?e:null}if(null==n||!Number.isFinite(n))return y;const i=(n-u)/(p-u),o=Math.max(0,Math.min(d.length-1,Math.round(i*(d.length-1)))),l=d[o].replace("#","");return[parseInt(l.slice(0,2),16),parseInt(l.slice(2,4),16),parseInt(l.slice(4,6),16)]}}if("colorCategories"===o){const o=Array.isArray(i.categories)?i.categories:Array.isArray(i.domain)?i.domain:[],l=i.colors||"Bold",a=Array.isArray(i.nullColor)?i.nullColor:[184,184,184];if(o.length){const e=n(l,Math.max(o.length,3))||null,t=new Map;e?.length&&o.forEach((n,i)=>{const o=e[i%e.length]||"#999999",r=String(o).replace("#",""),l=parseInt(r.slice(0,2),16),a=parseInt(r.slice(2,4),16),s=parseInt(r.slice(4,6),16);t.set(String(n?.value??n),[l,a,s])});try{i._detectedCategories=o.map(e=>"object"==typeof e?{value:e.value,label:String(e.label??e.value)}:{value:e,label:String(e)})}catch(e){}return e=>{const n=(e?.properties||e||{})[r];return null==n?a:t.get(String(n))||a}}const s=t.id;e.catState[s]=e.catState[s]||{};const c=e.catState[s][r]||{lut:new Map,pairs:[],next:0};e.catState[s][r]=c;const d=n(l,12)||null,u=d?.length?d:["#7fc97f","#beaed4","#fdc086","#ffff99","#386cb0","#f0027f","#bf5b17","#666666"],p=()=>{try{if(c.debounce)return;c.debounce=setTimeout(()=>{c.debounce=null;try{window.dispatchEvent(new CustomEvent("fusedmaps:legend:update"))}catch(e){}},150)}catch(e){}};return e=>{const t=(e?.properties||e||{})[r];if(null==t||""===t||"null"===t)return a;const n=String(t);let o=c.lut.get(n);if(!o){const e=u[c.next%u.length]||"#999999";c.next+=1;const t=String(e).replace("#","");o=[parseInt(t.slice(0,2),16),parseInt(t.slice(2,4),16),parseInt(t.slice(4,6),16)],c.lut.set(n,o),c.pairs.length<50&&c.pairs.push({value:n,label:n});try{i._detectedCategories=c.pairs}catch(e){}p()}return o||a}}}return null}function g(e,t,n){const i=Math.PI-2*Math.PI*t/Math.pow(2,n),o=e/Math.pow(2,n)*360-180,r=180/Math.PI*Math.atan(Math.sinh(i)),l=Math.PI-2*Math.PI*(t+1)/Math.pow(2,n),a=(e+1)/Math.pow(2,n)*360-180;return{west:o,south:180/Math.PI*Math.atan(Math.sinh(l)),east:a,north:r}}function f(e,t){return!(e.east<t.west||e.west>t.east||e.north<t.south||e.south>t.north)}function m(e){const t=e.hexLayer?.getFillColor;if(!t||"object"!=typeof t||Array.isArray(t))return{enabled:!1,attr:null};if("colorContinuous"!==t["@@function"])return{enabled:!1,attr:null};const n=t.attr||null;if(!n)return{enabled:!1,attr:null};if(!0===e.fillDomainFromUser||!0===t.fillDomainFromUser)return{enabled:!1,attr:n};const i=Array.isArray(t.domain)&&t.domain.length>=2;return{enabled:!0===t.autoDomain||!i,attr:n}}function h(e){if(null==e)return null;if("number"==typeof e)return Number.isFinite(e)?e:null;if("bigint"==typeof e){const t=Number(e);return Number.isFinite(t)?t:null}if("string"==typeof e){const t=parseFloat(e);return Number.isFinite(t)?t:null}return null}function b(e,t,n,i,o){return function(e,t,n,i){if(e.getZoom()<10)return null;const o=t.tileStats[n.id];if(!o)return null;const r=e.getBounds(),l={west:r.getWest(),east:r.getEast(),south:r.getSouth(),north:r.getNorth()};let a=Number.POSITIVE_INFINITY,s=Number.NEGATIVE_INFINITY,c=0;for(const[e,t]of Object.entries(o)){const[n,o,r]=e.split("/").map(Number);Number.isFinite(n)&&Number.isFinite(o)&&Number.isFinite(r)&&(Math.abs(n-i)>1||f(g(o,r,n),l)&&(Number.isFinite(t.min)&&(a=Math.min(a,t.min),c++),Number.isFinite(t.max)&&(s=Math.max(s,t.max))))}if(c<2||!Number.isFinite(a)||!Number.isFinite(s))return null;const d=s-a;if(Number.isFinite(d)&&d>0){const e=.01*d;a-=e,s+=e}return a>=s?[a-1,s+1]:[a,s]}(e,t,n,o)}function v(e,t){const n=e.hexLayer?.getFillColor;if(!n||"object"!=typeof n)return!1;const i=n._dynamicDomain;return!!(!Array.isArray(i)||i.length<2||(()=>{const e=i[1]-i[0]?i[1]-i[0]:1;return Math.abs(t[0]-i[0])/e>.05||Math.abs(t[1]-i[1])/e>.05})())&&(n._dynamicDomain=t,!0)}function w(e){const t=e.tileLayerConfig||{};return{tileSize:t.tileSize??256,minZoom:t.minZoom??0,maxZoom:t.maxZoom??19,zoomOffset:t.zoomOffset??0,maxRequests:t.maxRequests??10,refinementStrategy:t.refinementStrategy??"best-available"}}function x(e,t,n,i){const o=p();if(!o)return[];const r=o.TileLayer,l=o.H3HexagonLayer||o?.GeoLayers?.H3HexagonLayer;return r&&l?e.filter(e=>"hex"===e.layerType&&e.isTileLayer&&e.tileUrl).map(e=>e).filter(e=>!1!==t[e.id]).slice().reverse().map(e=>{const t=e.tileUrl,o=w(e),a=e.hexLayer||{},c=a.getFillColor,d=c&&"object"==typeof c&&!Array.isArray(c)&&Array.isArray(c._dynamicDomain)?{...c,domain:c._dynamicDomain}:c,p=a.getLineColor,g=p&&"object"==typeof p&&!Array.isArray(p)&&Array.isArray(p._dynamicDomain)?{...p,domain:p._dynamicDomain}:p,f=y(n,e,d),b=y(n,e,g),v=function(e){let t=5381;for(let n=0;n<e.length;n++)t=(t<<5)+t^e.charCodeAt(n);return(t>>>0).toString(16)}(`${JSON.stringify({fd:d&&"object"==typeof d?d.domain||d._dynamicDomain:null,ld:g&&"object"==typeof g?g.domain||g._dynamicDomain:null})}|${JSON.stringify({f:d,l:g,stroked:!1!==a.stroked,filled:!1!==a.filled,extruded:!0===a.extruded,opacity:a.opacity,elevationScale:a.elevationScale,coverage:a.coverage,lineWidthMinPixels:a.lineWidthMinPixels})}`),x=!1!==a.stroked,C=!1!==a.filled,L=!0===a.extruded,E="number"==typeof a.opacity?a.opacity:.8,S=a.lineWidthMinPixels??1,k=a.elevationScale??1,F=a.coverage??.9,$=a.elevationProperty||(d&&"object"==typeof d?d.attr:null)||null,A=m(e),T=o.refinementStrategy||(A.enabled?"no-overlap":"best-available");return new r({id:`${e.id}-tiles-${v}`,data:t,tileSize:o.tileSize,minZoom:o.minZoom,maxZoom:o.maxZoom,zoomOffset:o.zoomOffset,maxRequests:o.maxRequests,refinementStrategy:T,pickable:!0,visible:!0,getTileData:async({index:o,signal:r})=>{const{x:l,y:a,z:c}=o,d=t.replace("{z}",c).replace("{x}",l).replace("{y}",a),p=d,y=`${c}/${l}/${a}`;if(n.cache.has(p))return n.cache.get(p);if(n.inflight.has(p))try{return await n.inflight.get(p)}catch{return n.cache.get(p)||[]}i(1);const g=(async()=>{try{const i=await fetch(d,{signal:r});if(r?.aborted)return null;if(!i.ok)throw new Error(`tile http ${i.status}`);const l=(i.headers.get("Content-Type")||"").toLowerCase();let a,c=null;if(l.includes("application/octet-stream")||l.includes("application/parquet")||d.endsWith(".parquet")){let e=window.hyparquet;if(!e?.parquetMetadataAsync||!e?.parquetReadObjects)try{e=await async function(){const e=window;return e.hyparquet?.parquetMetadataAsync&&e.hyparquet?.parquetReadObjects?e.hyparquet:u||(u=(async()=>{const t=await new Function("u","return import(u)")("https://cdn.jsdelivr.net/npm/hyparquet@1.23.3/+esm"),n=t?.default&&(t.default.parquetReadObjects||t.default.parquetMetadataAsync)?t.default:t;return e.hyparquet=n,e.hyparquet})().catch(e=>{throw u=null,e}),u)}()}catch(e){return console.error("[tiles] failed to auto-load hyparquet",e),null}const t=await i.arrayBuffer();if(r?.aborted)return null;if(!t||0===t.byteLength)return[];const n={byteLength:t.byteLength,slice:async(e,n)=>t.slice(e,n)},o=await e.parquetMetadataAsync(n);if(c=o,r?.aborted)return null;a=await e.parquetReadObjects({file:n,utf8:!1,metadata:o})}else{let e=await i.text();if(r?.aborted)return null;e=e.replace(/\"(hex|h3|index|id)\"\s*:\s*(\d+)/gi,(e,t,n)=>`"${t}":"${n}"`),a=JSON.parse(e)}const g=(o=a,t=(Array.isArray(o)?o:Array.isArray(o?.data)?o.data:Array.isArray(o?.features)?o.features:[]).map(e=>e?.properties?{...e.properties}:{...e}).map(e=>{const t=s(e.hex??e.h3??e.index??e.id);if(!t)return null;const n={...e,hex:t};return{...n,properties:{...n}}}).filter(Boolean),(t||[]).map(e=>{const t=function(e){const t={};for(const n of Object.keys(e||{})){const i=e[n];if("bigint"==typeof i){const e=String(n).toLowerCase();"hex"===e||"h3"===e||"index"===e||"id"===e?t[n]=i.toString(16):i<=BigInt(Number.MAX_SAFE_INTEGER)&&i>=BigInt(Number.MIN_SAFE_INTEGER)?t[n]=Number(i):t[n]=i.toString()}else t[n]=i}return t}(e?.properties?e.properties:e||{});return{...t,properties:{...t}}}));n.cache.set(p,g);try{const t=m(e);if(t.enabled&&t.attr&&c){const i=function(e,t){const n=e?.row_groups||e?.rowGroups||e?.row_groups_list||null;if(!Array.isArray(n)||0===n.length)return null;let i=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY,r=!1;for(const e of n){const n=e?.columns||e?.columns_list||null;if(Array.isArray(n))for(const e of n){const n=e?.meta_data||e?.metaData||e?.metadata||null,l=n?.path_in_schema||n?.pathInSchema||n?.path||null,a=Array.isArray(l)?String(l[l.length-1]):"string"==typeof l?l:null;if(!a||a!==t)continue;const s=n?.statistics||n?.stats||e?.statistics||null;if(!s)continue;const c=h(s.min_value??s.min??s.minimum??s.minValue),d=h(s.max_value??s.max??s.maximum??s.maxValue);null!=c&&null!=d&&(r=!0,c<i&&(i=c),d>o&&(o=d))}}return r&&Number.isFinite(i)&&Number.isFinite(o)?i===o?{min:i-1,max:o+1}:{min:i,max:o}:null}(c,t.attr);if(i){n.tileStats[e.id]||(n.tileStats[e.id]={}),n.tileStats[e.id][y]={min:i.min,max:i.max};try{window.dispatchEvent(new CustomEvent("fusedmaps:autodomain:dirty"))}catch{}}}}catch(e){}return g}catch(e){return null}finally{n.inflight.delete(p),i(-1)}var t,o})();return n.inflight.set(p,g),await g},renderSubLayers:e=>{const t=e.data||[];return t&&t.length?new l({id:`${e.id}-h3`,data:t,getHexagon:e=>e.hex,pickable:!0,stroked:x,filled:C,extruded:L,opacity:E,coverage:F,lineWidthMinPixels:S,elevationScale:k,...L&&$?{getElevation:e=>Number(e?.[$]??0)}:{},...f?{getFillColor:f}:{},...b?{getLineColor:b}:{}}):null}})}):[]}let C=null,L=!1,E=null,S=null,k=null;const F=new Map;function $(e){const t=e?.json||{},n=[];if(Array.isArray(t.vector_layers))for(const e of t.vector_layers)e?.id&&n.push(String(e.id));if(t?.tilestats?.layers&&Array.isArray(t.tilestats.layers))for(const e of t.tilestats.layers){const t=e?.layer;t&&!n.includes(String(t))&&n.push(String(t))}return n}async function A(e){if(F.has(e))return F.get(e);const t=(async()=>{const t=new((await async function(){return S||k||(k=new Function("u","return import(u)")("https://cdn.jsdelivr.net/npm/pmtiles@3.0.6/+esm").then(e=>(S=e,S)).finally(()=>{k=null}),k)}()).PMTiles)(e);let n={};try{n=await t.getMetadata()}catch(e){n={}}const i=[];if(n?.vector_layers?.length>0)for(const e of n.vector_layers)e?.id&&i.push(String(e.id));if(n?.tilestats?.layers&&Array.isArray(n.tilestats.layers))for(const e of n.tilestats.layers){const t=e?.layer;t&&!i.includes(String(t))&&i.push(String(t))}return i})();return F.set(e,t),t.catch(()=>F.delete(e)),t}async function T(){return C||E||(window.mapboxPmTiles?(C=window.mapboxPmTiles,C):(E=new Promise((e,t)=>{const n=document.createElement("script");n.src="https://cdn.jsdelivr.net/npm/mapbox-pmtiles@1.0.54/dist/mapbox-pmtiles.umd.min.js",n.onload=()=>{C=window.mapboxPmTiles,e(C)},n.onerror=()=>t(new Error("Failed to load mapbox-pmtiles library")),document.head.appendChild(n)}).finally(()=>{E=null}),E))}function M(e,t,n="#ff8c00"){if(!e)return n;if("string"==typeof e)return e;if(Array.isArray(e))return e;const i=e["@@function"],o=e.attr||t;if("colorContinuous"===i){const t=e.domain||[0,100],n=e.steps||7,i=!!e.reverse;let r=e.colors;"string"==typeof r&&(r=function(e,t=7){const n=window.cartocolor,i=["#440154","#414487","#2a788e","#22a884","#7ad151","#fde725"];if(!n)return i;const o=n[e];if(o){const e=Object.keys(o).map(Number).filter(e=>!isNaN(e)).sort((e,t)=>t-e);return o[e.find(e=>e<=t)||e[e.length-1]]||i}return i}(r,n)),r&&Array.isArray(r)||(r=["#440154","#21918c","#fde725"]),i&&r.length>1&&(r=[...r].reverse());const l=["interpolate",["linear"],["coalesce",["to-number",["get",o]],0]],a=r.length;for(let e=0;e<a;e++){const n=e/(a-1),i=t[0]+n*(t[1]-t[0]);l.push(i,r[e])}return l}if("colorCategories"===i){const t=e.categories||{},n=e.othersColor||"#888888",i=["match",["get",o]];for(const[e,n]of Object.entries(t))i.push(e,n);return i.push(n),i}return n}const I={};function N(){return I}function _(e,t,n,i){!function(e,t){t.forEach(t=>{if("pmtiles"!==t.layerType){[`${t.id}-fill`,`${t.id}-extrusion`,`${t.id}-outline`,`${t.id}-circle`,`${t.id}-line`,`${t.id}-raster`,`${t.id}-circles`].forEach(t=>{try{e.getLayer(t)&&e.removeLayer(t)}catch(e){}});try{e.getSource(t.id)&&e.removeSource(t.id),e.getSource(`${t.id}-source`)&&e.removeSource(`${t.id}-source`)}catch(e){}}else!function(e,t){const n=`${t}-`,i=e.getStyle()?.layers||[];for(let t=i.length-1;t>=0;t--){const o=i[t]?.id;if(o&&o.startsWith(n))try{e.getLayer(o)&&e.removeLayer(o)}catch(e){}}const o=`${t}-source`;e.getSource(o)&&e.removeSource(o)}(e,t.id)})}(e,t),[...t].reverse().forEach(t=>{const i=!1!==n[t.id];switch(t.layerType){case"hex":{const n=t;if(n.isTileLayer);else if(n.data?.length){const o=c(n.data);I[t.id]=o,d(e,n,o,i)}break}case"vector":{const n=t;n.geojson&&(I[t.id]=n.geojson,function(e,t,n){const i=t.geojson;if(!i?.features?.length)return;e.addSource(t.id,{type:"geojson",data:i});const o=i.features.map(e=>e.properties||{}),r=t.fillColorConfig?.["@@function"]?a(t.fillColorConfig,o):t.fillColorRgba||"rgba(0,144,255,0.6)",l=t.lineColorConfig?.["@@function"]?a(t.lineColorConfig,o):t.lineColorRgba||"rgba(100,100,100,0.8)",s="number"==typeof t.lineWidth&&isFinite(t.lineWidth)?t.lineWidth:1,c="number"==typeof t.opacity&&isFinite(t.opacity)?Math.max(0,Math.min(1,t.opacity)):.8;let d=!1,u=!1,p=!1;for(const e of i.features){const t=e.geometry?.type;"Point"!==t&&"MultiPoint"!==t||(u=!0),"Polygon"!==t&&"MultiPolygon"!==t||(d=!0),"LineString"!==t&&"MultiLineString"!==t||(p=!0)}d&&(!1!==t.isFilled&&e.addLayer({id:`${t.id}-fill`,type:"fill",source:t.id,paint:{"fill-color":r,"fill-opacity":c},filter:["any",["==",["geometry-type"],"Polygon"],["==",["geometry-type"],"MultiPolygon"]],layout:{visibility:n?"visible":"none"}}),!1!==t.isStroked&&e.addLayer({id:`${t.id}-outline`,type:"line",source:t.id,layout:{"line-join":"round","line-cap":"round",visibility:n?"visible":"none"},paint:{"line-color":l,"line-width":s},filter:["any",["==",["geometry-type"],"Polygon"],["==",["geometry-type"],"MultiPolygon"]]})),p&&e.addLayer({id:`${t.id}-line`,type:"line",source:t.id,layout:{"line-join":"round","line-cap":"round",visibility:n?"visible":"none"},paint:{"line-color":l,"line-width":s,"line-opacity":1},filter:["any",["==",["geometry-type"],"LineString"],["==",["geometry-type"],"MultiLineString"]]}),u&&e.addLayer({id:`${t.id}-circle`,type:"circle",source:t.id,paint:{"circle-radius":t.pointRadius||6,"circle-color":r,"circle-stroke-color":"rgba(0,0,0,0.5)","circle-stroke-width":1,"circle-opacity":.9},filter:["any",["==",["geometry-type"],"Point"],["==",["geometry-type"],"MultiPoint"]],layout:{visibility:n?"visible":"none"}})}(e,n,i));break}case"mvt":!function(e,t,n){const i=t.sourceLayer||"udf";e.addSource(t.id,{type:"vector",tiles:[t.tileUrl],minzoom:t.minzoom||0,maxzoom:t.maxzoom||22});const o=t.fillColorConfig?.["@@function"]?a(t.fillColorConfig,void 0):t.fillColor||"#FFF5CC",r=t.lineColorConfig?.["@@function"]?a(t.lineColorConfig,void 0):t.lineColor||"#FFFFFF",l=t.fillOpacity??.8,s=t.lineWidth??1;!1!==t.isFilled&&e.addLayer({id:`${t.id}-fill`,type:"fill",source:t.id,"source-layer":i,paint:{"fill-color":o,"fill-opacity":l},layout:{visibility:n?"visible":"none"}}),e.addLayer({id:`${t.id}-line`,type:"line",source:t.id,"source-layer":i,paint:{"line-color":r,"line-width":s},layout:{visibility:n?"visible":"none"}}),t.isExtruded&&e.addLayer({id:`${t.id}-extrusion`,type:"fill-extrusion",source:t.id,"source-layer":i,paint:{"fill-extrusion-color":o,"fill-extrusion-height":["*",["get",t.heightProperty||"height"],t.heightMultiplier||1],"fill-extrusion-base":0,"fill-extrusion-opacity":t.extrusionOpacity??.9},layout:{visibility:n?"visible":"none"}})}(e,t,i);break;case"raster":!function(e,t,n){const i=t.opacity??t.rasterLayer?.opacity??1,o="string"==typeof t.tileUrl&&t.tileUrl.length>0,r="string"==typeof t.imageUrl&&t.imageUrl.length>0&&Array.isArray(t.imageBounds)&&4===t.imageBounds.length;if(o||r){if(r){const n=function(e){const[t,n,i,o]=e;return[[t,o],[i,o],[i,n],[t,n]]}(t.imageBounds);e.addSource(t.id,{type:"image",url:t.imageUrl,coordinates:n})}else e.addSource(t.id,{type:"raster",tiles:[t.tileUrl],tileSize:256});var l;e.addLayer({id:`${t.id}-raster`,type:"raster",source:t.id,paint:{"raster-opacity":(l=i,Math.max(0,Math.min(1,l)))},layout:{visibility:n?"visible":"none"}})}}(e,t,i)}});let o=null;if(t.some(e=>"hex"===e.layerType&&e.isTileLayer&&e.tileUrl)){const i=function(e,t,n){const i=p();if(!i?.MapboxOverlay||!i?.TileLayer)return null;const o={cache:new Map,inflight:new Map,tilesLoading:0,tileStats:{},catState:{}},r=function(){let e=document.getElementById("tile-loader");e||(e=document.createElement("div"),e.id="tile-loader",e.innerHTML='<div class="loader-spinner"></div><span id="loader-text">Loading tiles...</span>',document.body.appendChild(e));const t=document.getElementById("loader-text");let n=null,i=0;return{setLoading:o=>{i=Math.max(0,i+o),e&&(i>0?(n&&clearTimeout(n),e.classList.add("active"),t&&(t.textContent=1===i?"Loading tile...":`Loading ${i} tiles...`)):n=setTimeout(()=>e?.classList.remove("active"),300))}}}(),l=()=>x(t,n,o,r.setLoading),a=new i.MapboxOverlay({interleaved:!0,useDevicePixels:!0,layers:l()});try{e.addControl(a)}catch{}const s=()=>{try{a.setProps({layers:l()});try{e.triggerRepaint?.()}catch{}}catch{}},c=t.filter(e=>"hex"===e.layerType&&e.isTileLayer).map(e=>({layer:e,...m(e),tileCfg:w(e)})).filter(e=>e.enabled&&e.attr);let d=null;const u=t=>{c.length&&(d&&clearTimeout(d),d=setTimeout(()=>{let t=!1;for(const n of c){const i=Math.round(e.getZoom())+(n.tileCfg.zoomOffset||0),r=b(e,o,n.layer,n.attr,i);r&&v(n.layer,r)&&(t=!0)}if(t){s();try{window.dispatchEvent(new CustomEvent("fusedmaps:legend:update"))}catch{}}},t))},y=()=>u(800),g=()=>u(1200),f=()=>u(150);if(c.length){e.on("moveend",y),e.on("idle",g);try{window.addEventListener("fusedmaps:autodomain:dirty",f)}catch{}u(1500)}return{overlay:a,rebuild:s,pickObject:e=>{try{return a.pickObject(e)}catch{return null}},destroy:()=>{d&&clearTimeout(d);try{e.off("moveend",y)}catch{}try{e.off("idle",g)}catch{}try{window.removeEventListener("fusedmaps:autodomain:dirty",f)}catch{}try{e.removeControl(a)}catch{}}}}(e,t,n);o=i?.overlay||null,o&&i&&(o.__fused_hex_tiles__=i)}const r=t.filter(e=>"pmtiles"===e.layerType);return r.length>0&&async function(e,t,n,i=!1){if(0===t.length)return;await async function(){if(L)return;const e=window.mapboxgl;if(!e?.Style?.setSourceType)throw new Error("Mapbox GL JS v3 with Style.setSourceType is required for PMTiles");const t=await T();e.Style.setSourceType(t.SOURCE_TYPE,t.PmTilesSource),L=!0}();const o=await T();for(let r=0;r<t.length;r++){const l=t[r];if(!l.pmtilesUrl)continue;const a=!1!==n[l.id],s=`${l.id}-source`;try{const t=await o.PmTilesSource.getHeader(l.pmtilesUrl),n=[t.minLon,t.minLat,t.maxLon,t.maxLat];let c=$(t);const d=c[0]||"default",u="string"==typeof l.sourceLayer?l.sourceLayer.trim():"";if(!u&&0===c.length)try{c=await A(l.pmtilesUrl)}catch(e){}const p=c[0]||d,y=new Set([...l.excludeSourceLayers||[],...l.exclude_source_layers||[],...l.vectorLayer?.excludeSourceLayers||[],...l.vectorLayer?.exclude_source_layers||[]].filter(Boolean)),g=e=>e.filter(e=>!y.has(e)),f=!u&&c.length>1?g(c):c,m="*"===u?g(c):u?[u]:c.length>1?f:[p];0===m.length&&console.warn("[FusedMaps] PMTiles: could not detect any source-layers; set `source_layer` explicitly for:",l.id),u&&"*"!==u&&c.length>0&&!c.includes(u)&&console.warn("[FusedMaps] PMTiles: requested source-layer not found in header.json:",{requested:u,available:c}),e.getSource(s)||e.addSource(s,{type:o.SOURCE_TYPE,url:l.pmtilesUrl,minzoom:t.minZoom,maxzoom:t.maxZoom,bounds:n});const h=l.vectorLayer||{},b=l.fillOpacity??h.opacity??.8,v=l.lineWidth??1,w=l.pointRadiusMinPixels??4,x=!1!==l.isFilled,C=!1!==l.isStroked?v:0,L=x?b:0,E=!1!==l.renderPoints&&!1!==l.vectorLayer?.renderPoints,S=!1!==l.renderLines&&!1!==l.vectorLayer?.renderLines,k=!1!==l.renderPolygons&&!1!==l.vectorLayer?.renderPolygons,F=M(l.fillColorConfig||h.getFillColor,l.colorAttribute||"value","#ff8c00"),T=M(l.lineColorConfig||h.getLineColor,l.colorAttribute||"value","#ffffff"),I=e=>e.replace(/[^a-zA-Z0-9_-]+/g,"-");for(const t of m){const n=I(t||"default"),i={};if("number"==typeof l.minzoom&&(i.minzoom=l.minzoom),"number"==typeof l.maxzoom&&(i.maxzoom=l.maxzoom),E){const o=`${l.id}-${n}-circles`;e.getLayer(o)||e.addLayer({id:o,type:"circle",source:s,"source-layer":t,...i,paint:{"circle-radius":["interpolate",["exponential",2],["zoom"],0,.5*w,10,w,15,4*w,20,20*w],"circle-color":F,"circle-opacity":L,"circle-stroke-color":T,"circle-stroke-width":C},layout:{visibility:a?"visible":"none"}})}if(k){const o=`${l.id}-${n}-fill`;e.getLayer(o)||e.addLayer({id:o,type:"fill",source:s,"source-layer":t,...i,paint:{"fill-color":F,"fill-opacity":L},layout:{visibility:a?"visible":"none"}})}if(S){const o=`${l.id}-${n}-line`;e.getLayer(o)||e.addLayer({id:o,type:"line",source:s,"source-layer":t,...i,paint:{"line-color":T,"line-width":C,"line-opacity":b},layout:{visibility:a?"visible":"none"}})}}!i&&n&&0===r&&e.fitBounds([[n[0],n[1]],[n[2],n[3]]],{padding:50,duration:0})}catch(e){console.error(`[FusedMaps] Failed to add PMTiles layer ${l.id}:`,e)}}}(e,r,n,!0===i?.hasCustomView).catch(e=>{console.error("[FusedMaps] Failed to add PMTiles layers:",e)}),{deckOverlay:o}}let P=null,B=[],j={},O=!1;function D(e,t){B=e,j=t;const o=document.getElementById("layer-list");o&&(o.innerHTML=e.map(e=>{const o=!1!==t[e.id],r=function(e){let t="#0090ff";const o=e=>e&&e.length?1===e.length?e[0]:`linear-gradient(to bottom, ${e.map((t,n)=>`${t} ${n/(e.length-1)*100}%`).join(", ")})`:null;if("hex"===e.layerType){const r=e.hexLayer||{},l=!1===r.filled&&r.getLineColor?r.getLineColor:r.getFillColor;if(Array.isArray(l)){const e=i(l,1);e&&(t=e)}else if(l&&"object"==typeof l){const e=l["@@function"];if("colorContinuous"===e||"colorCategories"===e){let i=n(l.colors||("colorCategories"===e?"Bold":"TealGrn"),l.steps||7);if(i?.length){const e=l.domain,n=Array.isArray(e)&&e.length>=2&&e[0]>e[e.length-1],r=!!l.reverse;(n?!r:r)&&(i=[...i].reverse()),t=o(i)||t}}}}else if("vector"===e.layerType){const i=e;if(i.lineColorRgba&&!i.isFilled)t=i.lineColorRgba;else if(i.fillColorRgba)t=i.fillColorRgba;else if(i.fillColorConfig&&"object"==typeof i.fillColorConfig){const e=i.fillColorConfig.colors;if(e){const i=n(e,7);i?.length&&(t=o(i)||t)}}}else"raster"===e.layerType&&(t="linear-gradient(to bottom, #888, #444)");return t}(e),l=o?'<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>':'<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/></svg>';return`\n      <div class="layer-item ${o?"":"disabled"}" \n           data-layer-id="${e.id}" \n           style="--layer-strip: ${r};" \n           onclick="onLayerItemClick(event, '${e.id}')">\n        <span class="layer-name">${e.name}</span>\n        <span class="layer-eye" onclick="event.stopPropagation(); toggleLayerVisibility('${e.id}', ${!o})">${l}</span>\n      </div>\n    `}).join(""))}function R(e,t,i){const a=document.getElementById("color-legend");if(!a)return;const s=e.filter(e=>!1!==t[e.id]);if(!s.length)return void(a.style.display="none");let c="";s.forEach(e=>{const t=function(e,t){let i=null;if("hex"===e.layerType){const t=e.hexLayer||{};i=!1===t.filled&&t.getLineColor?t.getLineColor:t.getFillColor}else if("vector"===e.layerType){const t=e;if(i=t.fillColorConfig,!i?.["@@function"]&&t.lineColorRgba&&!t.isFilled)return`\n        <div class="legend-layer">\n          <div class="legend-title">\n            <span class="legend-line" style="background:${t.lineColorRgba};"></span>\n            ${e.name}\n          </div>\n        </div>\n      `}const a=i?.["@@function"];if(!a||!i?.attr)return"";if("colorContinuous"!==a&&"colorCategories"!==a)return"";const s=i.colors||("colorCategories"===a?"Bold":"TealGrn");if("colorCategories"===a){try{const n=i;if(!(Array.isArray(n._detectedCategories)&&n._detectedCategories.length||Array.isArray(n.categories)&&n.categories.length)&&n.attr){let i=[];const o=t?.[e.id];if(o?.features?.length)i=o.features.map(e=>e?.properties||{});else if("hex"===e.layerType)i=e.data||[];else if("vector"===e.layerType){const t=e.geojson;t?.features?.length&&(i=t.features.map(e=>e?.properties||{}))}const r=l(i,n.attr,n.labelAttr);n._detectedCategories=r.slice(0,50)}}catch(e){}return function(e,t,i){let o=t._detectedCategories||t.categories||[];if(o=o.map(e=>"object"==typeof e&&e.label?e:{value:e,label:e}),!o.length)return"";let l=n(i,Math.max(o.length,3));l?.length||(l=r);const a=t.labelAttr||t.attr;return`\n    <div class="legend-layer">\n      <div class="legend-title">\n        <span class="legend-dot" style="background:${l[0]};"></span>\n        ${e}: ${a}\n      </div>\n      <div class="legend-categories">\n        ${o.map((e,t)=>`\n          <div class="legend-cat-item">\n            <div class="legend-cat-swatch" style="background:${l[t%l.length]};"></div>\n            <span class="legend-cat-label" title="${e.label}">${e.label}</span>\n          </div>\n        `).join("")}\n      </div>\n    </div>\n  `}(e.name,i,s)}return"colorContinuous"===a?function(e,t,i){const r=t._dynamicDomain||t.domain;if(!r?.length)return"";const[l,a]=r,s=l>a;let c=n(i,t.steps||7);c?.length||(c=o),s&&(c=[...c].reverse());const d=`linear-gradient(to right, ${c.map((e,t)=>`${e} ${t/(c.length-1)*100}%`).join(", ")})`;return`\n    <div class="legend-layer">\n      <div class="legend-title">\n        <span class="legend-dot" style="background:${c[Math.floor(c.length/2)]};"></span>\n        ${e}: ${t.attr}\n      </div>\n      <div class="legend-gradient" style="background:${d};"></div>\n      <div class="legend-labels">\n        <span>${l.toFixed(1)}</span>\n        <span>${a.toFixed(1)}</span>\n      </div>\n    </div>\n  `}(e.name,i,s):""}(e,i);t&&(c+=t)}),c?(a.innerHTML=c,a.style.display="block"):a.style.display="none"}function q(e,t,n){const i={...t};class o{onAdd(e){this._map=e;const t=document.createElement("div");t.className="mapboxgl-ctrl mapboxgl-ctrl-group";const o=(e,t,n)=>{const i=document.createElement("button");return i.type="button",i.title=t,i.setAttribute("aria-label",t),i.style.fontSize="16px",i.style.lineHeight="20px",i.style.fontWeight="600",i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="center",i.textContent=e,i.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation();try{n()}catch(e){}}),i};return t.appendChild(o("+","Zoom in",()=>e.zoomIn({duration:250}))),t.appendChild(o("−","Zoom out",()=>e.zoomOut({duration:250}))),t.appendChild(o("⌂","Reset view",()=>{e.easeTo({center:[i.longitude,i.latitude],zoom:Number.isFinite(i.zoom)?i.zoom:e.getZoom(),pitch:Number.isFinite(i.pitch??0)?i.pitch??0:e.getPitch(),bearing:Number.isFinite(i.bearing??0)?i.bearing??0:e.getBearing(),duration:600})})),n&&t.appendChild(((t,n)=>{const i=document.createElement("button");return i.type="button",i.title=n,i.setAttribute("aria-label",n),i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="center",i.innerHTML='<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" style="display:block">\n              <path d="M4 8h3l1.2-2h7.6L17 8h3a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2z"/>\n              <circle cx="12" cy="14" r="3.2"/>\n            </svg>',i.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation();try{!function(e){const t=`map-screenshot-${(new Date).toISOString().replace(/[:.]/g,"-")}.png`;try{const n=e.getCanvas(),i=document.createElement("a");if(i.download=t,"function"==typeof n.toBlob)return void n.toBlob(e=>{try{if(!e)throw new Error("toBlob returned null");const t=URL.createObjectURL(e);i.href=t,document.body.appendChild(i),i.click(),i.remove(),setTimeout(()=>URL.revokeObjectURL(t),1e3)}catch(e){console.error("Screenshot failed:",e),alert("Screenshot blocked (likely due to CORS/tainted canvas from raster tiles). Try using only CORS-enabled layers/tiles.")}},"image/png");const o=n.toDataURL("image/png");i.href=o,document.body.appendChild(i),i.click(),i.remove()}catch(e){console.error("Screenshot failed:",e),alert("Screenshot blocked (likely due to CORS/tainted canvas from raster tiles). Try using only CORS-enabled layers/tiles.")}}(e)}catch(e){}}),i})(0,"Download screenshot")),this._container=t,t}onRemove(){try{this._container?.parentNode?.removeChild(this._container)}catch(e){}this._map=void 0,this._container=void 0}}try{e.addControl(new o,"bottom-left")}catch(e){}return{setHomeViewState:e=>{try{if(!e)return;"number"==typeof e.longitude&&Number.isFinite(e.longitude)&&(i.longitude=e.longitude),"number"==typeof e.latitude&&Number.isFinite(e.latitude)&&(i.latitude=e.latitude),"number"==typeof e.zoom&&Number.isFinite(e.zoom)&&(i.zoom=e.zoom),"number"==typeof e.pitch&&Number.isFinite(e.pitch)&&(i.pitch=e.pitch),"number"==typeof e.bearing&&Number.isFinite(e.bearing)&&(i.bearing=e.bearing)}catch(e){}}}}function z(e,t,n){!function(e){try{e.addControl(new mapboxgl.ScaleControl({maxWidth:110,unit:"metric"}),"bottom-left")}catch(e){}}(e);const i=q(e,t,n),o=function(e){const t=e.getCanvasContainer?.()||e.getCanvas?.();if(!t)return()=>{};let n=!1,i=0,o=0,r=0,l=0;const a=()=>{if(n){n=!1;try{e.dragPan.enable()}catch(e){}try{t.style.cursor=""}catch(e){}window.removeEventListener("pointermove",s,{passive:!1}),window.removeEventListener("pointerup",c,{passive:!1}),window.removeEventListener("pointercancel",c,{passive:!1})}},s=t=>{if(!n)return;if(!t.metaKey)return a();const s=t.clientX-i,c=t.clientY-o;var d;e.setBearing(r+.35*s),e.setPitch((d=l-.25*c,Math.max(0,Math.min(85,d)))),t.preventDefault()},c=e=>{a();try{e.preventDefault()}catch(e){}},d=a=>{if(0===a.button&&a.ctrlKey&&!a.metaKey)return a.preventDefault(),void a.stopPropagation();if(!n&&0===a.button&&a.metaKey){n=!0,i=a.clientX,o=a.clientY,r=e.getBearing(),l=e.getPitch();try{e.dragPan.disable()}catch(e){}try{t.style.cursor="grabbing"}catch(e){}window.addEventListener("pointermove",s,{passive:!1}),window.addEventListener("pointerup",c,{passive:!1}),window.addEventListener("pointercancel",c,{passive:!1}),a.stopPropagation(),a.preventDefault()}};return t.addEventListener("pointerdown",d,{passive:!1,capture:!0}),()=>{try{a()}catch(e){}try{t.removeEventListener("pointerdown",d,{capture:!0})}catch(e){}}}(e);return{destroy:()=>{try{o()}catch(e){}},setHomeViewState:i?.setHomeViewState}}function W(e,t){try{return Number.isFinite(e)?e.toFixed(t):""}catch{return""}}function U(e,t,n){try{const i=t.getBoundingClientRect().width||280;e.style.setProperty("--debug-panel-w",`${i}px`);const o=t.classList.contains("collapsed");n.style.left=o?"0px":`var(--debug-panel-w, ${i}px)`}catch(e){}}function H(e,t,n){return Math.max(t,Math.min(n,e))}function V(e){return e&&"object"==typeof e?"colorContinuous"!==e["@@function"]?null:e:null}function Z(e){const t=new Set;try{const n=e.hexLayer?.getFillColor,i=e.hexLayer?.getLineColor;n?.attr&&t.add(String(n.attr)),i?.attr&&t.add(String(i.attr));const o=e.hexLayer?.tooltipAttrs;Array.isArray(o)&&o.forEach(e=>t.add(String(e)))}catch(e){}return[...t].filter(Boolean)}function G(e){try{const t=e.geojson?.features?.[0],n=t?.properties||{};return Object.keys(n||{}).filter(e=>e&&"_fused_idx"!==e)}catch(e){return[]}}function J(e,t,n,i){try{e.getLayer(t)&&e.setPaintProperty(t,n,i)}catch(e){}}function X(e,t,n,i){try{const o=e.getStyle?.()?.layers||[];for(const r of o){const o=r?.id;if(o&&o.startsWith(t)&&e.getLayer(o))try{e.setPaintProperty(o,n,i)}catch(e){}}}catch(e){}}function Y(e,t){try{const n=String(e||"").trim();if(!/^#[0-9a-fA-F]{6}$/.test(n))return null;const i=parseInt(n.slice(1,3),16),o=parseInt(n.slice(3,5),16),r=parseInt(n.slice(5,7),16);return"number"==typeof t&&Number.isFinite(t)?[i,o,r,Math.max(0,Math.min(255,Math.round(t)))]:[i,o,r]}catch(e){return null}}const Q={filled:!0,stroked:!0,pickable:!0,extruded:!1,elevationScale:1,opacity:1,getHexagon:"@@=properties.hex",getFillColor:{"@@function":"colorContinuous",attr:"cnt",steps:20,colors:"ArmyRose",nullColor:[184,184,184]},getLineColor:[255,255,255],lineWidthMinPixels:1},K={minZoom:0,maxZoom:19,zoomOffset:0},ee={filled:!0,stroked:!0,pickable:!0,opacity:.8,lineWidthMinPixels:0,pointRadiusMinPixels:10,getFillColor:{"@@function":"colorContinuous",attr:"house_age",domain:[0,50],colors:"ArmyRose",steps:7,nullColor:[200,200,200,180]}};function te(e){return!!e&&"object"==typeof e&&!Array.isArray(e)}function ne(e,t){if(e===t)return!0;if(typeof e!=typeof t)return!1;if(Array.isArray(e)&&Array.isArray(t)){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(!ne(e[n],t[n]))return!1;return!0}if(te(e)&&te(t)){const n=Object.keys(e),i=Object.keys(t);if(n.length!==i.length)return!1;for(const i of n){if(!(i in t))return!1;if(!ne(e[i],t[i]))return!1}return!0}return!1}function ie(e,t){if(ne(e,t))return;if(Array.isArray(t))return t;if(!te(t))return t;const n={};for(const i of Object.keys(t)){const o=ie(e?.[i],t[i]);void 0!==o&&(n[i]=o)}return Object.keys(n).length?n:void 0}function oe(e,t=0){const n=e=>"  ".repeat(e),i=t+1;if(null==e)return"None";const o=typeof e;if("boolean"===o)return e?"True":"False";if("number"===o)return Number.isFinite(e)?String(e):"None";if("string"===o){if(e.startsWith("@@py:")){const t=e.slice(5).trim();if(/^[A-Za-z_][A-Za-z0-9_\\.]*$/.test(t))return t}return JSON.stringify(e)}if(Array.isArray(e))return e.length?`[\n${e.map(e=>`${n(i)}${oe(e,i)}`).join(",\n")}\n${n(t)}]`:"[]";if(te(e)){const o=Object.keys(e);return o.length?`{\n${o.map(t=>`${n(i)}${JSON.stringify(t)}: ${oe(e[t],i)}`).join(",\n")}\n${n(t)}}`:"{}"}try{return JSON.stringify(String(e))}catch{return"None"}}let re=!1,le=null;function ae(e){return{select:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n      <path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/>\n    </svg>',freehand:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n      <path d="M12 19l7-7 3 3-7 7-3-3z"/>\n      <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/>\n    </svg>',line:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n      <line x1="5" y1="19" x2="19" y2="5"/>\n    </svg>',polygon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n      <polygon points="12 2 22 8.5 22 15.5 12 22 2 15.5 2 8.5"/>\n    </svg>',rectangle:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n      <rect x="3" y="3" width="18" height="18" rx="2"/>\n    </svg>',circle:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n      <circle cx="12" cy="12" r="10"/>\n    </svg>',trash:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n      <polyline points="3 6 5 6 21 6"/>\n      <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>\n    </svg>'}[e]||""}function se(e,t){const n=Math.max(0,Math.min(1,t)),i=String(e||"").replace("#","");return 6!==i.length?`rgba(99,102,241,${n})`:`rgba(${parseInt(i.slice(0,2),16)},${parseInt(i.slice(2,4),16)},${parseInt(i.slice(4,6),16)},${n})`}function ce(e,t,n){const i=["coalesce",["get","stroke"],e],o=["coalesce",["get","fill"],t],r=["coalesce",["get","strokeWidth"],n],l="mapbox-gl-draw-cold",a="mapbox-gl-draw-hot";return[{id:"gl-draw-polygon-fill-cold",type:"fill",source:l,filter:["all",["==","$type","Polygon"],["!=","mode","static"]],paint:{"fill-color":o,"fill-opacity":1}},{id:"gl-draw-polygon-fill-hot",type:"fill",source:a,filter:["all",["==","$type","Polygon"],["!=","mode","static"]],paint:{"fill-color":o,"fill-opacity":1}},{id:"gl-draw-polygon-stroke-cold",type:"line",source:l,filter:["all",["==","$type","Polygon"],["!=","mode","static"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":i,"line-width":r}},{id:"gl-draw-polygon-stroke-hot",type:"line",source:a,filter:["all",["==","$type","Polygon"],["!=","mode","static"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":i,"line-width":r}},{id:"gl-draw-line-cold",type:"line",source:l,filter:["all",["==","$type","LineString"],["!=","mode","static"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":i,"line-width":r}},{id:"gl-draw-line-hot",type:"line",source:a,filter:["all",["==","$type","LineString"],["!=","mode","static"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":i,"line-width":r}},{id:"gl-draw-point-cold",type:"circle",source:l,filter:["all",["==","$type","Point"],["!=","mode","static"]],paint:{"circle-radius":4,"circle-color":i,"circle-stroke-color":"#000","circle-stroke-width":1}},{id:"gl-draw-point-hot",type:"circle",source:a,filter:["all",["==","$type","Point"],["!=","mode","static"]],paint:{"circle-radius":4,"circle-color":i,"circle-stroke-color":"#000","circle-stroke-width":1}}]}let de=!1,ue=null;function pe(e,t){let n={type:"FeatureCollection",features:[]};if(t){const e=t.properties||{},i=e.hex||e.h3;if(i&&window.h3)try{const t=s(i);if(t&&window.h3.isValidCell(t)){const i=window.h3.cellToBoundary(t).map(([e,t])=>[t,e]);i.push(i[0]),n.features.push({type:"Feature",geometry:{type:"Polygon",coordinates:[i]},properties:e})}}catch(e){}else t.geometry&&n.features.push({type:"Feature",geometry:t.geometry,properties:e})}de?e.getSource("feature-hl").setData(n):(e.addSource("feature-hl",{type:"geojson",data:n}),e.addLayer({id:"feature-hl-fill",type:"fill",source:"feature-hl",paint:{"fill-color":"rgba(255,255,0,0.3)","fill-opacity":1}}),e.addLayer({id:"feature-hl-line",type:"line",source:"feature-hl",paint:{"line-color":"rgba(255,255,0,1)","line-width":3}}),de=!0),ue=t}function ye(e){let t=null,n=null;try{"BroadcastChannel"in window&&(t=new BroadcastChannel(e))}catch(e){}function i(e){if(!n)return;let t;try{t="string"==typeof e.data?JSON.parse(e.data):e.data}catch{return}n(t)}return{send:function(e){const n=JSON.stringify(e);try{t&&t.postMessage(e)}catch(e){}try{window.parent.postMessage(n,"*")}catch(e){}try{window.top&&window.top!==window.parent&&window.top.postMessage(n,"*")}catch(e){}try{if(window.top?.frames)for(let e=0;e<window.top.frames.length;e++){const t=window.top.frames[e];if(t!==window)try{t.postMessage(n,"*")}catch(e){}}}catch(e){}},onMessage:function(e){n=e,t&&(t.onmessage=e=>{n&&n(e.data)}),window.addEventListener("message",i)},destroy:function(){t&&(t.close(),t=null),window.removeEventListener("message",i),n=null}}}function ge(e="component"){return`${e}-${Math.random().toString(36).substr(2,9)}`}function fe(e,t,n){t.broadcast?.enabled&&function(e,t={}){const n=t.channel||"fused-bus",i=t.dataset||"all",o=ge("map-broadcast"),r=ye(n);let l=null;function a(){const t=function(e){const t=e.getBounds();return[+t.getWest().toFixed(6),+t.getSouth().toFixed(6),+t.getEast().toFixed(6),+t.getNorth().toFixed(6)]}(e);if(a=l,(n=t)&&a&&n[0]===a[0]&&n[1]===a[1]&&n[2]===a[2]&&n[3]===a[3])return;var n,a;l=t;const[s,c,d,u]=t;r.send({type:"filter",fromComponent:o,timestamp:Date.now(),dataset:i,filter:{type:"spatial",field:"geometry",values:[s,c,d,u]}}),r.send({type:"spatial_filter",source:o,timestamp:Date.now(),bounds:{sw:{lng:s,lat:c},ne:{lng:d,lat:u}}})}e.on("move",a),e.on("moveend",a),e.on("load",()=>{setTimeout(a,300)}),e.loaded()&&setTimeout(a,100),setTimeout(()=>{r.send({type:"component_ready",componentType:"map",componentId:o,capabilities:["spatial_filter"],dataSource:"viewport",protocol:"unified"})},200)}(e,{channel:t.broadcast.channel,dataset:t.broadcast.dataset}),t.sync?.enabled&&function(e,t={}){let n=t.channel||"default";n.includes("::")||(n=`map-sync::${n}`);const i=ge("map"),o=ye(n);let r=!1,l=!1,a={x:NaN,y:NaN,z:NaN};const s=(e,t,n)=>Math.abs(e-t)<n;function c(){const t=e.getCenter();return{longitude:+t.lng.toFixed(6),latitude:+t.lat.toFixed(6),zoom:+e.getZoom().toFixed(3),bearing:+e.getBearing().toFixed(1),pitch:+e.getPitch().toFixed(1),id:i,ts:Date.now()}}function d(){if(r)return;const e=c(),{longitude:t,latitude:n,zoom:i}=e;s(t,a.x,1e-6)&&s(n,a.y,1e-6)&&s(i,a.z,.001)||(a={x:t,y:n,z:i},o.send({type:"sync",...e}))}let u=null;const p=()=>{l=!0},y=()=>{l&&(l=!1,d())};e.on("dragstart",p),e.on("zoomstart",p),e.on("rotatestart",p),e.on("pitchstart",p),e.on("moveend",y),e.on("move",()=>{l&&!r&&(u&&clearTimeout(u),u=setTimeout(d,0))}),o.onMessage(t=>{var n;"sync"===t.type&&t.id!==i&&(n=t)&&n.id!==i&&(r||l||(r=!0,e.jumpTo({center:[n.longitude,n.latitude],zoom:n.zoom,bearing:n.bearing,pitch:n.pitch}),requestAnimationFrame(()=>{r=!1})))}),e.on("load",()=>{setTimeout(()=>o.send({type:"sync",...c()}),100+100*Math.random())}),document.addEventListener("visibilitychange",()=>{document.hidden&&(r=!1,l=!1)})}(e,{channel:t.sync.channel}),t.clickBroadcast,t.locationListener}const me="1.33.1-dev13.0",he=new Map;function be(e){return/^[A-Za-z_][A-Za-z0-9_]*$/.test(e)}class ve{constructor(e){this.duck=null,this.db=null,this.conn=null,this.tableByLayerId=new Map,this.loadedTables=new Set,this.hasSpatial=!1,this.version=e?.version||me}get ready(){return!!this.conn}async init(){if(this.conn)return;this.duck=await async function(e=me){const t=he.get(e);if(t)return t;const n=import(`https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@${e}/+esm`);return he.set(e,n),n}(this.version);const e=this.duck,t=await e.selectBundle(e.getJsDelivrBundles()),n=await(await fetch(t.mainWorker)).text(),i=new Worker(URL.createObjectURL(new Blob([n],{type:"application/javascript"}))),o=new e.AsyncDuckDB(new e.ConsoleLogger,i);await o.instantiate(t.mainModule);const r=await o.connect();try{await r.query("INSTALL h3 FROM community")}catch(e){}try{await r.query("LOAD h3")}catch(e){}try{await r.query("INSTALL spatial")}catch(e){}try{await r.query("LOAD spatial"),this.hasSpatial=!0}catch(e){this.hasSpatial=!1}this.db=o,this.conn=r}layerTableName(e){const t=this.tableByLayerId.get(e.id);if(t)return t;const n=e.id.replace(/-/g,"_");return this.tableByLayerId.set(e.id,n),n}async ensureLayerTable(e){if(await this.init(),!this.db||!this.conn)throw new Error("DuckDB not initialized");const t=this.layerTableName(e);if(this.loadedTables.has(t))return t;let n=null;if(e.parquetData)n=function(e){const t=atob(e),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n}(e.parquetData);else if(e.parquetUrl){const t=await fetch(e.parquetUrl);if(!t.ok)throw new Error(`Failed to fetch parquetUrl (${t.status})`);const i=await t.arrayBuffer();n=new Uint8Array(i)}if(!n)throw new Error("Missing parquetData or parquetUrl for SQL layer");return await this.db.registerFileBuffer(`${t}.parquet`,n),await this.conn.query(`CREATE OR REPLACE TABLE ${t} AS SELECT * FROM read_parquet('${t}.parquet')`),this.loadedTables.add(t),t}async runSql(e,t){if(await this.ensureLayerTable(e),!this.conn)throw new Error("DuckDB not initialized");const n=this.layerTableName(e);await this.conn.query(`CREATE OR REPLACE VIEW data AS SELECT * FROM ${n}`);const i=(t||"").trim(),o=/^(with|select)\b/i.test(i)?i:`SELECT * FROM data WHERE (${i||"1=1"})`,r=(await this.conn.query(o)).toArray().map(e=>function(e){const t=new Set(["hex","h3","index","id"]),n={};for(const i of Object.keys(e)){let o=e[i];"bigint"==typeof o&&(o=t.has(i.toLowerCase())?o.toString(16):Number(o)),n[i]=o}const i=s(n.hex??n.h3??n.index??n.id);return i&&(n.hex=i),n}(e)).filter(e=>!!e.hex);return{rows:r,count:r.length}}async getMinMaxFromQuery(e,t,n){if(await this.ensureLayerTable(e),!this.conn)return null;const i=this.layerTableName(e);await this.conn.query(`CREATE OR REPLACE VIEW data AS SELECT * FROM ${i}`);const o=(n||"").trim(),r=/^(with|select)\b/i.test(o)?o:`SELECT * FROM data WHERE (${o||"1=1"})`,l=`"${String(t).replace(/"/g,'""')}"`,a=(await this.conn.query(`SELECT MIN(${l}) as min_val, MAX(${l}) as max_val FROM (${r}) AS q`)).toArray()[0];if(!a)return null;let s=a.min_val,c=a.max_val;return"bigint"==typeof s&&(s=Number(s)),"bigint"==typeof c&&(c=Number(c)),Number.isFinite(s)&&Number.isFinite(c)?{min:s,max:c}:null}async runSqlGeoJSON(e,t){if(await this.ensureLayerTable(e),!this.conn)throw new Error("DuckDB not initialized");if(!this.hasSpatial)return null;const n=this.layerTableName(e);await this.conn.query(`CREATE OR REPLACE VIEW data AS SELECT * FROM ${n}`);const i=(t||"").trim(),o=/^(with|select)\b/i.test(i)?i:`SELECT * FROM data WHERE (${i||"1=1"})`,r=await this.conn.query(`SELECT * FROM (${o}) AS q LIMIT 0`),l=(r?.schema?.fields||[]).map(e=>String(e?.name||"")).filter(Boolean),a=["hex","h3","index","id"].find(e=>l.includes(e))||null;if(!a)return null;if(!l.every(be))return null;const s=`\n      WITH q AS (${o})\n      SELECT\n        count(*)::BIGINT AS cnt,\n        CASE\n          WHEN count(*) = 0 THEN '{"type":"FeatureCollection","features":[]}'\n          ELSE (\n            '{"type":"FeatureCollection","features":[' ||\n              string_agg(\n                '{"type":"Feature","geometry":' ||\n                  ST_AsGeoJSON(ST_GeomFromText(h3_cell_to_boundary_wkt(CAST("${a}" AS BIGINT)))) ||\n                ',"properties":' || to_json(struct_pack(${l.map(e=>`${e} := "${e}"`).join(", ")})) || '}',\n                ','\n              ) ||\n            ']}'\n          )\n        END AS gj\n      FROM q\n      WHERE "${a}" IS NOT NULL\n        AND h3_is_valid_cell(CAST("${a}" AS BIGINT))\n    `,c=(await this.conn.query(s)).toArray()[0];if(!c)return{geojson:{type:"FeatureCollection",features:[]},count:0};let d=c.cnt;"bigint"==typeof d&&(d=Number(d));const u=String(c.gj||'{"type":"FeatureCollection","features":[]}');return{geojson:JSON.parse(u),count:Number(d)||0}}async getMinMax(e,t){if(await this.ensureLayerTable(e),!this.conn)return null;const n=this.layerTableName(e);await this.conn.query(`CREATE OR REPLACE VIEW data AS SELECT * FROM ${n}`);const i=(await this.conn.query(`SELECT MIN("${t}") as min_val, MAX("${t}") as max_val FROM data`)).toArray()[0];if(!i)return null;let o=i.min_val,r=i.max_val;return"bigint"==typeof o&&(o=Number(o)),"bigint"==typeof r&&(r=Number(r)),Number.isFinite(o)&&Number.isFinite(r)?{min:o,max:r}:null}}let we=null,xe={};function Ce(e){return!("hex"!==e.layerType||e.isTileLayer||!e.parquetData&&!e.parquetUrl)}function Le(){let e=document.getElementById("sql-loader");e||(e=document.createElement("div"),e.id="sql-loader",e.innerHTML='<div class="loader-spinner"></div><span id="sql-loader-text">DuckDB…</span>',document.body.appendChild(e));const t=document.getElementById("sql-loader-text");let n=null;const i=new Map;return{setStatus:(o,r)=>{i.set(o,String(r||"")),(()=>{if(!e)return;const o=[...i.entries()].filter(([,e])=>(e=>{const t=(e||"").toLowerCase();return!!t&&!t.startsWith("error:")&&!t.includes(" rows")&&(t.includes("initializ")||t.includes("running")||t.includes("loading")||t.includes("fetch"))})(e));if(o.length){n&&clearTimeout(n),e.classList.add("active");const i=o.some(([,e])=>String(e||"").toLowerCase().includes("initializ"));return void(t&&(t.textContent=i?"Initialising…":"Loading…"))}n=setTimeout(()=>e?.classList.remove("active"),300)})()}}}function Ee(e,t){try{window.dispatchEvent(new CustomEvent("fusedmaps:sql:status",{detail:{layerId:e,status:t}}))}catch(e){}try{we||(we=Le()),we?.setStatus(e,t)}catch(e){}}const Se={};function ke(e){const n=e.containerId||"map";try{const t="light"===e.ui?.theme?"light":"dark";document.documentElement.setAttribute("data-theme",t)}catch(e){}if(e.drawing?.enabled){const t=e.drawing.layerId||"drawings";e.layers.some(e=>e.id===t)||e.layers.push({id:t,name:e.drawing.layerName||"Drawings",layerType:"drawing",visible:!0})}e.layers.forEach(e=>{Se[e.id]=!1!==e.visible}),e.__visibilityState=Se;const o=function(e){const{containerId:t,mapboxToken:n,styleUrl:i,initialViewState:o,screenshotEnabled:r}=e;return window.mapboxgl.accessToken=n,new window.mapboxgl.Map({container:t,style:i,center:[o.longitude,o.latitude],zoom:o.zoom,pitch:o.pitch||0,bearing:o.bearing||0,projection:"mercator",pitchWithRotate:!0,...r?{preserveDrawingBuffer:!0}:{}})}({containerId:n,mapboxToken:e.mapboxToken,styleUrl:e.styleUrl,initialViewState:e.initialViewState,screenshotEnabled:!1!==e.ui?.screenshot}),r=z(o,e.initialViewState,!1!==e.ui?.screenshot),l=e.sidebar||!!e.debug?function(e,n){const i=n.sidebar||(n.debug?"show":null);let o=document.getElementById("debug-shell");o||(o=document.createElement("div"),o.id="debug-shell",o.innerHTML='\n      <div id="debug-panel">\n        <div id="debug-content">\n          <div class="debug-section">\n            <div class="debug-section-title">Editing Layer</div>\n            <div class="debug-row">\n              <span class="debug-label">Layer</span>\n              <select class="debug-select" id="dbg-layer-select"></select>\n            </div>\n          </div>\n\n          <div class="debug-section" id="dbg-hex-section">\n            <div class="debug-section-title">Hex Layer</div>\n            <div class="debug-toggles">\n              <label class="debug-checkbox"><input type="checkbox" id="dbg-filled" checked /> Filled</label>\n              <label class="debug-checkbox"><input type="checkbox" id="dbg-stroked" checked /> Stroked</label>\n              <label class="debug-checkbox"><input type="checkbox" id="dbg-extruded" /> Extruded</label>\n            </div>\n            <div id="dbg-extrusion-controls" style="display:none;margin-top:8px;">\n              <div class="debug-row">\n                <span class="debug-label">Height attr</span>\n                <select class="debug-select" id="dbg-elev-attr"></select>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label">Height scale</span>\n                <input type="number" class="debug-input debug-input-sm" id="dbg-elev-scale" step="0.1" value="1" />\n              </div>\n            </div>\n            <div class="debug-row" style="margin-top:8px;">\n              <span class="debug-label">Opacity</span>\n              <input type="range" class="debug-slider" id="dbg-opacity-slider" min="0" max="1" step="0.05" value="1" />\n              <input type="number" class="debug-input debug-input-sm" id="dbg-opacity" step="0.1" min="0" max="1" value="1" />\n            </div>\n          </div>\n\n          <div class="debug-section" id="drawing-section" style="display:none;">\n            <div class="debug-section-title">Drawings</div>\n            <textarea id="dbg-drawing-geojson" class="debug-output" style="height:160px;font-family:monospace;font-size:11px;resize:vertical;" readonly></textarea>\n          </div>\n\n          <div class="debug-section" id="fill-color-section">\n            <div class="debug-section-title">Fill Color</div>\n            <div class="debug-row">\n              <span class="debug-label">Function</span>\n              <select class="debug-select" id="dbg-fill-fn">\n                <option value="colorContinuous">colorContinuous</option>\n                <option value="static">Static Color</option>\n              </select>\n            </div>\n            <div id="fill-fn-options">\n              <div class="debug-row">\n                <span class="debug-label">Attribute</span>\n                <select class="debug-select" id="dbg-attr"></select>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label">Palette</span>\n                <select class="debug-select pal-hidden" id="dbg-palette"></select>\n                <div class="pal-dd" id="dbg-palette-dd">\n                  <button type="button" class="pal-trigger" id="dbg-palette-trigger" title="Palette">\n                    <span class="pal-name" id="dbg-palette-name">Palette</span>\n                    <span class="pal-swatch" id="dbg-palette-swatch"></span>\n                  </button>\n                  <div class="pal-menu" id="dbg-palette-menu" style="display:none;"></div>\n                </div>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label"></span>\n                <label class="debug-checkbox" style="margin-left:auto;"><input type="checkbox" id="dbg-fill-reverse" /> Reverse</label>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label">Domain</span>\n                <input type="number" class="debug-input debug-input-sm" id="dbg-domain-min" step="0.1" placeholder="min" />\n                <span style="color:#666;">–</span>\n                <input type="number" class="debug-input debug-input-sm" id="dbg-domain-max" step="0.1" placeholder="max" />\n              </div>\n            <div class="debug-row">\n              <span class="debug-label"></span>\n              <div class="debug-dual-range" aria-label="Domain range">\n                <input type="range" class="debug-range-min" id="dbg-domain-range-min" min="0" max="100" step="0.1" value="0" />\n                <input type="range" class="debug-range-max" id="dbg-domain-range-max" min="0" max="100" step="0.1" value="100" />\n              </div>\n            </div>\n              <div class="debug-row">\n                <span class="debug-label">Steps</span>\n                <input type="number" class="debug-input debug-input-sm" id="dbg-steps" step="1" min="2" max="20" value="7" />\n              </div>\n              <div class="debug-row">\n                <span class="debug-label">Null Color</span>\n                <input type="color" class="debug-color" id="dbg-null-color" value="#b8b8b8" />\n                <span class="debug-color-label" id="dbg-null-color-label">#b8b8b8</span>\n              </div>\n            </div>\n            <div id="fill-static-options" style="display:none;">\n              <div class="debug-row">\n                <span class="debug-label">Color</span>\n                <input type="color" class="debug-color" id="dbg-fill-static" value="#0090ff" />\n                <span class="debug-color-label" id="dbg-fill-static-label">#0090ff</span>\n              </div>\n            </div>\n          </div>\n\n          <div class="debug-section" id="line-color-section">\n            <div class="debug-section-title">Line Color</div>\n            <div class="debug-row">\n              <span class="debug-label">Function</span>\n              <select class="debug-select" id="dbg-line-fn">\n                <option value="colorContinuous">colorContinuous</option>\n                <option value="static" selected>Static Color</option>\n              </select>\n            </div>\n            <div id="line-fn-options" style="display:none;">\n              <div class="debug-row">\n                <span class="debug-label">Attribute</span>\n                <select class="debug-select" id="dbg-line-attr"></select>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label">Palette</span>\n                <select class="debug-select pal-hidden" id="dbg-line-palette"></select>\n                <div class="pal-dd" id="dbg-line-palette-dd">\n                  <button type="button" class="pal-trigger" id="dbg-line-palette-trigger" title="Palette">\n                    <span class="pal-name" id="dbg-line-palette-name">Palette</span>\n                    <span class="pal-swatch" id="dbg-line-palette-swatch"></span>\n                  </button>\n                  <div class="pal-menu" id="dbg-line-palette-menu" style="display:none;"></div>\n                </div>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label"></span>\n                <label class="debug-checkbox" style="margin-left:auto;"><input type="checkbox" id="dbg-line-reverse" /> Reverse</label>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label">Domain</span>\n                <input type="number" class="debug-input debug-input-sm" id="dbg-line-domain-min" step="0.1" placeholder="min" />\n                <span style="color:#666;">–</span>\n                <input type="number" class="debug-input debug-input-sm" id="dbg-line-domain-max" step="0.1" placeholder="max" />\n              </div>\n            </div>\n            <div id="line-static-options">\n              <div class="debug-row">\n                <span class="debug-label">Color</span>\n                <input type="color" class="debug-color" id="dbg-line-static" value="#ffffff" />\n                <span class="debug-color-label" id="dbg-line-static-label">#ffffff</span>\n              </div>\n              <div class="debug-row">\n                <span class="debug-label">Line Width</span>\n                <input type="range" class="debug-slider" id="dbg-line-width-slider" min="0" max="5" step="0.5" value="1" />\n                <input type="number" class="debug-input debug-input-sm" id="dbg-line-width" step="0.5" min="0" max="10" value="1" />\n              </div>\n            </div>\n          </div>\n\n          <div class="debug-section" id="dbg-viewstate-section">\n            <div class="debug-section-title">View State</div>\n            <div class="debug-row">\n              <span class="debug-label">Longitude</span>\n              <input type="number" class="debug-input" id="dbg-lng" step="0.0001" />\n            </div>\n            <div class="debug-row">\n              <span class="debug-label">Latitude</span>\n              <input type="number" class="debug-input" id="dbg-lat" step="0.0001" />\n            </div>\n            <div class="debug-row">\n              <span class="debug-label">Zoom</span>\n              <input type="number" class="debug-input" id="dbg-zoom" step="0.1" min="0" max="22" />\n            </div>\n            <div class="debug-row">\n              <span class="debug-label">Pitch</span>\n              <input type="number" class="debug-input" id="dbg-pitch" step="1" min="0" max="85" />\n            </div>\n            <div class="debug-row">\n              <span class="debug-label">Bearing</span>\n              <input type="number" class="debug-input" id="dbg-bearing" step="1" />\n            </div>\n          </div>\n\n          <div class="debug-section" id="sql-section" style="display:none;">\n            <div class="debug-section-title">SQL <span id="sql-status" style="float:right;font-weight:normal;color:var(--ui-muted-2);"></span></div>\n            <textarea id="dbg-sql" class="debug-output" style="height:60px;font-family:monospace;font-size:11px;resize:vertical;" placeholder="WHERE expression (e.g. data = 111)\n—or—\nFull SQL (SELECT ... FROM data ...)"></textarea>\n          </div>\n\n          <div class="debug-section">\n            <details id="dbg-view-details">\n              <summary class="debug-section-title" style="cursor:pointer; user-select:none;">Current ViewState</summary>\n              <textarea id="dbg-view-output" class="debug-output" readonly></textarea>\n            </details>\n          </div>\n\n          <div class="debug-section">\n            <div class="debug-section-title">Layer Config</div>\n            <textarea id="dbg-output" class="debug-output" readonly></textarea>\n          </div>\n        </div>\n        <div id="debug-resize-handle" title="Drag to resize"></div>\n      </div>\n      <div id="debug-toggle" title="Toggle sidebar">&#x2039;</div>\n    ',document.body.appendChild(o));const r=document.getElementById("debug-panel"),l=document.getElementById("debug-toggle"),s=document.getElementById("debug-resize-handle");try{"hide"===i?(r.classList.add("collapsed"),l.innerHTML="&#x203A;"):(r.classList.remove("collapsed"),l.innerHTML="&#x2039;"),U(o,r,l)}catch(e){}const u=document.getElementById("dbg-layer-select"),p=document.getElementById("dbg-hex-section"),y=document.getElementById("dbg-viewstate-section"),g=document.getElementById("drawing-section"),f=document.getElementById("dbg-drawing-geojson"),m=document.getElementById("fill-color-section"),h=document.getElementById("line-color-section"),b=document.getElementById("dbg-filled"),v=document.getElementById("dbg-stroked"),w=document.getElementById("dbg-extruded"),x=document.getElementById("dbg-extrusion-controls"),C=document.getElementById("dbg-elev-attr"),L=document.getElementById("dbg-elev-scale"),E=document.getElementById("dbg-opacity-slider"),S=document.getElementById("dbg-opacity"),k=document.getElementById("dbg-fill-fn"),F=document.getElementById("fill-fn-options"),$=document.getElementById("fill-static-options"),A=document.getElementById("dbg-attr"),T=document.getElementById("dbg-palette"),M=document.getElementById("dbg-palette-trigger"),I=document.getElementById("dbg-palette-swatch"),_=document.getElementById("dbg-palette-menu"),P=document.getElementById("dbg-domain-min"),B=document.getElementById("dbg-domain-max"),j=document.getElementById("dbg-domain-range-min"),O=document.getElementById("dbg-domain-range-max"),D=document.getElementById("dbg-steps"),R=document.getElementById("dbg-fill-reverse"),q=document.getElementById("dbg-null-color"),z=document.getElementById("dbg-null-color-label"),te=document.getElementById("dbg-fill-static"),ne=document.getElementById("dbg-fill-static-label"),re=document.getElementById("dbg-line-fn"),le=document.getElementById("line-fn-options"),ae=document.getElementById("line-static-options"),se=document.getElementById("dbg-line-attr"),ce=document.getElementById("dbg-line-palette"),de=document.getElementById("dbg-line-palette-trigger"),ue=document.getElementById("dbg-line-palette-swatch"),pe=document.getElementById("dbg-line-palette-menu"),ye=document.getElementById("dbg-line-domain-min"),ge=document.getElementById("dbg-line-domain-max"),fe=document.getElementById("dbg-line-reverse"),me=document.getElementById("dbg-line-static"),he=document.getElementById("dbg-line-static-label"),be=document.getElementById("dbg-line-width-slider"),ve=document.getElementById("dbg-line-width"),we=document.getElementById("dbg-lng"),xe=document.getElementById("dbg-lat"),Ce=document.getElementById("dbg-zoom"),Le=document.getElementById("dbg-pitch"),Ee=document.getElementById("dbg-bearing"),Se=document.getElementById("dbg-view-output"),ke=document.getElementById("dbg-output"),Fe=document.getElementById("sql-section"),$e=document.getElementById("sql-status"),Ae=document.getElementById("dbg-sql");n.initialViewState;const Te=Object.keys(window.cartocolor||{}).sort((e,t)=>e.localeCompare(t)),Me=e=>{e.innerHTML=Te.map(e=>`<option value="${e}">${e}</option>`).join("")};Me(T),Me(ce);const Ie=(e,t=9,n=!1)=>{const i=((e,t)=>{try{const n=window.cartocolor?.[e];if(!n)return null;const i=Object.keys(n).map(e=>Number(e)).filter(e=>Number.isFinite(e)).sort((e,t)=>e-t),o=n[i.find(e=>e>=t)??i[i.length-1]];return Array.isArray(o)?[...o]:null}catch(e){return null}})(e,Math.max(t,3)),o=n&&i?.length?[...i].reverse():i;return o?.length?`linear-gradient(90deg, ${o.map((e,t)=>`${e} ${t/Math.max(1,o.length-1)*100}%`).join(", ")})`:"linear-gradient(90deg, #555, #999)"},Ne=()=>{const e=parseInt(D?.value||"7",10);return Number.isFinite(e)?Math.max(2,Math.min(20,e)):7},_e=(e,t,n,i)=>{const o=e.value||"Palette";t.style.background=Ie(o,Ne(),i),n.title=o},Pe=()=>{try{_.style.display="none"}catch(e){}try{pe.style.display="none"}catch(e){}},Be=(e,t,n,i,o)=>{t.innerHTML=Te.map(e=>`<div class="pal-item" data-pal="${e}" title="${e}">\n          <div class="pal-item-swatch" style="background:${Ie(e,Ne(),o)};"></div>\n        </div>`).join(""),t.querySelectorAll(".pal-item").forEach(r=>{r.addEventListener("click",l=>{try{l.preventDefault(),l.stopPropagation()}catch(e){}const a=r.getAttribute("data-pal")||"";a&&(e.value=a),_e(e,n,i,o),t.style.display="none",Ve()})})},je=(e,t,n,i)=>{const o=e===T,r=o?!!R.checked:!!fe.checked;Be(e,t,n,i,r),_e(e,n,i,r),i.addEventListener("click",r=>{try{r.preventDefault(),r.stopPropagation()}catch(e){}const l="none"!==t.style.display;Pe();try{const r=o?!!R.checked:!!fe.checked;Be(e,t,n,i,r),_e(e,n,i,r)}catch(e){}t.style.display=l?"none":"block"})},Oe=()=>Pe();document.addEventListener("click",Oe),window.addEventListener("blur",Oe);const De=n.layers.filter(e=>"hex"===e.layerType||"vector"===e.layerType||"pmtiles"===e.layerType||"drawing"===e.layerType);u.innerHTML=De.map(e=>`<option value="${e.id}">${e.name||e.id}</option>`).join(""),!u.value&&De.length&&(u.value=De[0].id);const Re=()=>{const e=u.value;return De.find(t=>t.id===e)||null},qe=()=>{try{const t=(e._controls||[]).find(e=>e&&e.__fused_hex_tiles__);n.__deckOverlay=t||n.__deckOverlay}catch(e){}};qe();const ze=()=>{try{const e=2e5,t=e=>{const t={name:e.name};if(!1===e.visible&&(t.visible=!1),"hex"===e.layerType){const n=e.hexLayer||{},i={hexLayer:ie(Q,n)||{}};if(e.isTileLayer&&e.tileUrl){t.type="hex",t.tile_url=e.tileUrl;const n=e.tileLayerConfig||e.tileLayer||null;if(n&&"object"==typeof n){const e=ie(K,n);e&&Object.keys(e).length&&(i.tileLayer=e)}}else t.type="hex",e.parquetUrl&&(t.parquetUrl=e.parquetUrl),e.sql&&(t.sql=e.sql),e.parquetUrl||(t.data=e.dataRef?`@@py:${String(e.dataRef)}`:null);return t.config=i,t}if("vector"===e.layerType)return t.type="vector",t.data=e.dataRef?`@@py:${String(e.dataRef)}`:null,t.config={vectorLayer:ie(ee,e.vectorLayer||{})||{}},t;if("mvt"===e.layerType){t.type="vector",t.tile_url=e.tileUrl,t.source_layer=e.sourceLayer||"udf";const n={};return e.fillColorConfig?n.getFillColor=e.fillColorConfig:e.fillColor&&(n.getFillColor=e.fillColor),e.lineColorConfig?n.getLineColor=e.lineColorConfig:e.lineColor&&(n.getLineColor=e.lineColor),"number"==typeof e.lineWidth&&(n.lineWidthMinPixels=e.lineWidth),"number"==typeof e.fillOpacity&&(n.opacity=e.fillOpacity),t.config={vectorLayer:n},t}if("pmtiles"===e.layerType){t.type="pmtiles",e.pmtilesPath?t.pmtiles_path=e.pmtilesPath:t.pmtiles_url=e.pmtilesUrl,e.sourceLayer&&(t.source_layer=e.sourceLayer),"number"==typeof e.minzoom&&(t.minzoom=e.minzoom),"number"==typeof e.maxzoom&&(t.maxzoom=e.maxzoom);const n={...e.vectorLayer||{}};return e.fillColorConfig&&(n.getFillColor=e.fillColorConfig),e.lineColorConfig&&(n.getLineColor=e.lineColorConfig),"number"==typeof e.fillOpacity&&(n.opacity=e.fillOpacity),"number"==typeof e.lineWidth&&(n.lineWidthMinPixels=e.lineWidth),"number"==typeof e.pointRadiusMinPixels&&(n.pointRadiusMinPixels=e.pointRadiusMinPixels),"boolean"==typeof e.isFilled&&(n.filled=e.isFilled),"boolean"==typeof e.isStroked&&(n.stroked=e.isStroked),t.config={vectorLayer:ie(ee,n)||{}},t}if("raster"===e.layerType){t.type="raster",e.tileUrl&&(t.tile_url=e.tileUrl),e.imageUrl&&(t.image_url=e.imageUrl),e.imageBounds&&(t.bounds=e.imageBounds);const n=e.opacity??e.rasterLayer?.opacity;return t.config="number"==typeof n&&Number.isFinite(n)&&1!==n?{rasterLayer:{opacity:n}}:{},t}return t};let i=`layers = ${oe((n.layers||[]).map(t),0)}`;try{const e=n.__drawingHandle,t=n.drawing;if(t?.enabled){const n=e?.getGeoJSON?.()||{type:"FeatureCollection",features:[]};i+=`\n\ndrawing = ${oe({enabled:!0,position:t.position||"bottom",layer_id:t.layerId||"drawings",layer_name:t.layerName||"Drawings",default_mode:t.defaultMode||"freehand",tools:t.tools||["select","freehand","line","polygon","rectangle","circle"],style:t.style||{stroke:"#6366f1",strokeWidth:4},initial_geojson:n},0)}`}}catch(e){}if(i.length>e){const t=i.includes("\n\ndrawing = ")?Math.max(e,1e6):e;i.length>t&&(i=i.slice(0,t)+"\n... (truncated)\n")}ke.value=i}catch(e){ke.value=""}},We=()=>{const e=k.value;F.style.display="colorContinuous"===e?"block":"none",$.style.display="static"===e?"block":"none"},Ue=()=>{const e=re.value;le.style.display="colorContinuous"===e?"block":"none",ae.style.display="static"===e?"block":"none"},He=()=>{const e=Re();if(!e)return;const t="hex"===e.layerType,i="vector"===e.layerType,o="pmtiles"===e.layerType,r="drawing"===e.layerType,l=t&&e.hexLayer||{};try{p&&(p.style.display=t?"block":"none")}catch(e){}try{m&&(m.style.display=t||i||o?"block":"none")}catch(e){}try{h&&(h.style.display=t||i||o?"block":"none")}catch(e){}try{Fe&&(Fe.style.display="none")}catch(e){}try{g&&(g.style.display=r?"block":"none")}catch(e){}try{y&&(y.style.display="block")}catch(e){}if(r){try{const e=n.__drawingHandle,t=e?.getGeoJSON?.()||{type:"FeatureCollection",features:[]};f&&(f.value=JSON.stringify(t,null,2))}catch(e){f&&(f.value="")}try{ze()}catch(e){}return}t?(b.checked=!1!==l.filled,v.checked=!1!==l.stroked,w.checked=!0===l.extruded):(b.checked=!1!==e.isFilled,v.checked=!1!==e.isStroked,w.checked=!1);try{if(x&&(x.style.display=t&&w.checked?"block":"none"),t&&C){const t=Z(e),n=[""].concat(t||[]);C.innerHTML=n.map(e=>e?`<option value="${e}">${e}</option>`:'<option value="">(use fill attr)</option>').join(""),C.value=String(l.elevationProperty||"")}t&&L&&(L.value=String("number"==typeof l.elevationScale&&Number.isFinite(l.elevationScale)?l.elevationScale:1))}catch(e){}const a=t?"number"==typeof l.opacity?l.opacity:1:"number"==typeof e.opacity?e.opacity:.9;if(E.value=String(a),S.value=String(a),t){const t=l.getFillColor,n=V(t);if(n){k.value="colorContinuous",A.innerHTML=Z(e).map(e=>`<option value="${e}">${e}</option>`).join(""),n.attr&&(A.value=String(n.attr)),n.colors&&(T.value=String(n.colors));try{R.checked=!!n.reverse}catch(e){R.checked=!1}_e(T,I,M,!!R.checked);const t=Array.isArray(n.domain)?n.domain:[0,1];P.value=W(Number(t[0]),2),B.value=W(Number(t[1]),2);try{const e=Math.min(Number(t[0]),Number(t[1])),n=Math.max(Number(t[0]),Number(t[1]));Number.isFinite(e)&&Number.isFinite(n)&&(j.min=String(e),j.max=String(n),O.min=String(e),O.max=String(n),j.step="0.1",O.step="0.1",j.value=String(Number(t[0])),O.value=String(Number(t[1])))}catch(e){}D.value=String(n.steps??7);const i=`#${(Array.isArray(n.nullColor)?n.nullColor:[184,184,184]).slice(0,3).map(e=>H(Number(e),0,255).toString(16).padStart(2,"0")).join("")}`;q.value=i,z.textContent=i}else if(Array.isArray(t)){k.value="static";try{R.checked=!1}catch(e){}const e=`#${t.slice(0,3).map(e=>H(Number(e),0,255).toString(16).padStart(2,"0")).join("")}`;te.value=e,ne.textContent=e}else{k.value="colorContinuous";try{R.checked=!1}catch(e){}}}else if(i||o){const t=e,n=o?t.colorAttribute?[t.colorAttribute]:["value"]:G(e);A.innerHTML=n.map(e=>`<option value="${e}">${e}</option>`).join("");const i=t.fillColorConfig;if(i&&"object"==typeof i&&"colorContinuous"===i["@@function"]){k.value="colorContinuous",i.attr&&(A.value=String(i.attr)),i.colors&&(T.value=String(i.colors));try{R.checked=!!i.reverse}catch(e){R.checked=!1}_e(T,I,M,!!R.checked);const e=Array.isArray(i.domain)?i.domain:[0,1];P.value=W(Number(e[0]),2),B.value=W(Number(e[1]),2),D.value=String(i.steps??7);const t=`#${(Array.isArray(i.nullColor)?i.nullColor:[184,184,184]).slice(0,3).map(e=>H(Number(e),0,255).toString(16).padStart(2,"0")).join("")}`;q.value=t,z.textContent=t}else{k.value="static";try{R.checked=!1}catch(e){}te.value="#0090ff",ne.textContent=te.value}}if(t){const t=l.getLineColor,n=V(t);if(n){re.value="colorContinuous",se.innerHTML=Z(e).map(e=>`<option value="${e}">${e}</option>`).join(""),n.attr&&(se.value=String(n.attr)),n.colors&&(ce.value=String(n.colors));try{fe.checked=!!n.reverse}catch(e){fe.checked=!1}_e(ce,ue,de,!!fe.checked);const t=Array.isArray(n.domain)?n.domain:[0,1];ye.value=W(Number(t[0]),2),ge.value=W(Number(t[1]),2)}else if(Array.isArray(t)){re.value="static";try{fe.checked=!1}catch(e){}const e=`#${t.slice(0,3).map(e=>H(Number(e),0,255).toString(16).padStart(2,"0")).join("")}`;me.value=e,he.textContent=e}else{re.value="static";try{fe.checked=!1}catch(e){}}}else if(i||o){const t=e,n=o?t.colorAttribute?[t.colorAttribute]:["value"]:G(e);se.innerHTML=n.map(e=>`<option value="${e}">${e}</option>`).join("");const i=t.lineColorConfig;if(i&&"object"==typeof i&&"colorContinuous"===i["@@function"]){re.value="colorContinuous",i.attr&&(se.value=String(i.attr)),i.colors&&(ce.value=String(i.colors));try{fe.checked=!!i.reverse}catch(e){fe.checked=!1}_e(ce,ue,de,!!fe.checked);const e=Array.isArray(i.domain)?i.domain:[0,1];ye.value=W(Number(e[0]),2),ge.value=W(Number(e[1]),2)}else{re.value="static";try{fe.checked=!1}catch(e){}}}const s=t?l.lineWidthMinPixels??1:e.lineWidth??1;be.value=String(s),ve.value=String(s),We(),Ue(),ze();try{const t=!("hex"!==e.layerType||e.isTileLayer||!e.parquetData&&!e.parquetUrl);Fe&&(Fe.style.display=t?"block":"none"),Ae&&t&&(Ae.value=String(e.sql||"SELECT * FROM data")),$e&&($e.textContent="")}catch(e){}},Ve=()=>{const t=Re();if(!t)return;const i="hex"===t.layerType,o="vector"===t.layerType,r="pmtiles"===t.layerType;i&&(t.hexLayer=t.hexLayer||{});const l=i?t.hexLayer:{},s=parseFloat(S.value),u=Number.isFinite(s)?H(s,0,1):1;if(i){l.filled=!!b.checked,l.stroked=!!v.checked,l.extruded=!!w.checked,l.opacity=u;try{x&&(x.style.display=l.extruded?"block":"none");const e=parseFloat(L?.value||"1");l.elevationScale=Number.isFinite(e)?e:1;const t=String(C?.value||"").trim();t?l.elevationProperty=t:delete l.elevationProperty}catch(e){}}else if(o||r){t.isFilled=!!b.checked,t.isStroked=!!v.checked,t.opacity=u;try{t.vectorLayer={...t.vectorLayer||{},filled:!!b.checked,stroked:!!v.checked,opacity:u}}catch(e){}}if(i)if("static"===k.value){const e=te.value||"#0090ff",t=parseInt(e.slice(1,3),16),n=parseInt(e.slice(3,5),16),i=parseInt(e.slice(5,7),16);l.getFillColor=[t,n,i]}else{const e=A.value||"data_avg",t=T.value||"Earth",n=!!R.checked,i=parseFloat(P.value),o=parseFloat(B.value),r=parseInt(D.value||"7",10),a=q.value||"#b8b8b8",s=parseInt(a.slice(1,3),16),c=parseInt(a.slice(3,5),16),d=parseInt(a.slice(5,7),16);l.getFillColor={"@@function":"colorContinuous",attr:e,domain:[Number.isFinite(i)?i:0,Number.isFinite(o)?o:1],colors:t,reverse:n,steps:Number.isFinite(r)?r:7,nullColor:[s,c,d],autoDomain:!1!==l.getFillColor?.autoDomain}}else if(o||r)if("static"===k.value){const e=te.value||"#0090ff";t.fillColorConfig=null,t.fillColorRgba=e;try{const n=Y(e,200)||Y(e)||null;t.vectorLayer&&(t.vectorLayer.getFillColor=n||e)}catch(e){}}else{const e=A.value||"value",n=T.value||"ArmyRose",i=!!R.checked,o=parseFloat(P.value),l=parseFloat(B.value),a=parseInt(D.value||"7",10),s=q.value||"#b8b8b8",c=parseInt(s.slice(1,3),16),d=parseInt(s.slice(3,5),16),u=parseInt(s.slice(5,7),16);t.fillColorRgba=null;const p={"@@function":"colorContinuous",attr:e,domain:[Number.isFinite(o)?o:0,Number.isFinite(l)?l:1],colors:n,reverse:i,steps:Number.isFinite(a)?a:7,nullColor:[c,d,u]};t.fillColorConfig=p,r&&(t.colorAttribute=e);try{t.vectorLayer&&(t.vectorLayer.getFillColor=p)}catch(e){}}if(i)if("static"===re.value){const e=me.value||"#ffffff",t=parseInt(e.slice(1,3),16),n=parseInt(e.slice(3,5),16),i=parseInt(e.slice(5,7),16);l.getLineColor=[t,n,i]}else{const e=se.value||"data_avg",t=ce.value||"Earth",n=!!fe.checked,i=parseFloat(ye.value),o=parseFloat(ge.value);l.getLineColor={"@@function":"colorContinuous",attr:e,domain:[Number.isFinite(i)?i:0,Number.isFinite(o)?o:1],colors:t,reverse:n,steps:parseInt(D.value||"7",10)||7,autoDomain:!1!==l.getLineColor?.autoDomain}}else if(o||r)if("static"===re.value){const e=me.value||"#ffffff";t.lineColorConfig=null,t.lineColorRgba=e;try{const n=Y(e,255)||Y(e)||null;t.vectorLayer&&(t.vectorLayer.getLineColor=n||e)}catch(e){}}else{const e=se.value||"value",n=ce.value||"ArmyRose",i=!!fe.checked,o=parseFloat(ye.value),r=parseFloat(ge.value);t.lineColorRgba=null;const l={"@@function":"colorContinuous",attr:e,domain:[Number.isFinite(o)?o:0,Number.isFinite(r)?r:1],colors:n,reverse:i,steps:parseInt(D.value||"7",10)||7};t.lineColorConfig=l;try{t.vectorLayer&&(t.vectorLayer.getLineColor=l)}catch(e){}}const p=parseFloat(ve.value),y=Number.isFinite(p)?H(p,0,10):1;if(i)l.lineWidthMinPixels=y;else if(o||r){t.lineWidth=y;try{t.vectorLayer&&(t.vectorLayer.lineWidthMinPixels=y)}catch(e){}}ze(),qe(),(()=>{try{const e=n.__deckOverlay||null,t=e?.__fused_hex_tiles__;t?.rebuild?.()}catch(e){}try{window.dispatchEvent(new CustomEvent("fusedmaps:legend:update"))}catch(e){}})();try{if("hex"===t.layerType&&!t.isTileLayer){const n=t.parquetData||t.parquetUrl?N()?.[t.id]||{type:"FeatureCollection",features:[]}:c(t.data||[]),i=function(e,t){try{const n=e.getStyle?.(),i=n?.layers||[],o=[`${t}-fill`,`${t}-extrusion`,`${t}-outline`];for(const e of o){const t=i.find(t=>t&&t.id===e);if(!t)continue;const n=t.layout?.visibility;return"none"!==n}}catch(e){}return!0}(e,t.id);!function(e,t,n,i){try{const i=e.getSource(t.id);i&&"function"==typeof i.setData?i.setData(n):e.addSource(t.id,{type:"geojson",data:n})}catch(e){}!function(e,t){const n=[`${t}-fill`,`${t}-extrusion`,`${t}-outline`];for(const t of n)try{e.getLayer(t)&&e.removeLayer(t)}catch(e){}}(e,t.id),d(e,t,n,i)}(e,t,n,i)}}catch(e){}try{if(o){const n=t,i=n.geojson,o=i?.features?.map(e=>e?.properties||{})||[],r=n.fillColorConfig?.["@@function"]?a(n.fillColorConfig,o):n.fillColorRgba||"#0090ff",l=n.lineColorConfig?.["@@function"]?a(n.lineColorConfig,o):n.lineColorRgba||"#ffffff",s=!1===n.isFilled?0:u,c=!1===n.isStroked?0:1;X(e,`${n.id}-`,"fill-color",r),X(e,`${n.id}-`,"fill-opacity",s),J(e,`${n.id}-outline`,"line-color",l),J(e,`${n.id}-outline`,"line-width",y),J(e,`${n.id}-outline`,"line-opacity",c),X(e,`${n.id}-`,"line-color",l),X(e,`${n.id}-`,"line-width",y),X(e,`${n.id}-`,"line-opacity",c),J(e,`${n.id}-circle`,"circle-color",r),J(e,`${n.id}-circle`,"circle-opacity",s),J(e,`${n.id}-circle`,"circle-stroke-color",l),J(e,`${n.id}-circle`,"circle-stroke-width",y)}}catch(e){}try{if(r){const n=t,i=!1===n.isFilled?0:u,o=!1===n.isStroked?0:1,r=(e,t)=>{if(!e)return t;if("string"==typeof e)return e;if(Array.isArray(e))return e;const i=e["@@function"],o=e.attr||n.colorAttribute||"value";if("colorContinuous"===i){const t=e.domain||[0,100],n=e.steps||7,i=!!e.reverse;let r=e.colors;if("string"==typeof r){const e=window.cartocolor;if(e&&e[r]){const t=e[r],i=Object.keys(t).map(Number).filter(e=>!isNaN(e)).sort((e,t)=>t-e);r=t[i.find(e=>e<=n)||i[i.length-1]]||["#440154","#21918c","#fde725"]}else r=["#440154","#21918c","#fde725"]}r&&Array.isArray(r)||(r=["#440154","#21918c","#fde725"]),i&&r.length>1&&(r=[...r].reverse());const l=["interpolate",["linear"],["coalesce",["to-number",["get",o]],0]],a=r.length;for(let e=0;e<a;e++){const n=e/(a-1),i=t[0]+n*(t[1]-t[0]);l.push(i,r[e])}return l}return t},l=n.fillColorConfig?r(n.fillColorConfig,"#ff8c00"):n.fillColorRgba||"#ff8c00",a=n.lineColorConfig?r(n.lineColorConfig,"#ffffff"):n.lineColorRgba||"#ffffff",s=!1===n.isStroked?0:y;X(e,`${n.id}-`,"fill-color",l),X(e,`${n.id}-`,"fill-opacity",i),X(e,`${n.id}-`,"line-color",a),X(e,`${n.id}-`,"line-width",s),X(e,`${n.id}-`,"line-opacity",o),X(e,`${n.id}-`,"circle-color",l),X(e,`${n.id}-`,"circle-opacity",i),X(e,`${n.id}-`,"circle-stroke-color",a),X(e,`${n.id}-`,"circle-stroke-width",s)}}catch(e){console.warn("[FusedMaps] PMTiles update error:",e)}},Ze=()=>{const e=parseFloat(P.value),t=parseFloat(B.value);Number.isFinite(e)&&(j.value=String(e)),Number.isFinite(t)&&(O.value=String(t))},Ge=()=>{let e=parseFloat(j.value),t=parseFloat(O.value);Number.isFinite(e)&&Number.isFinite(t)&&(e>t&&([e,t]=[t,e]),j.value=String(e),O.value=String(t),P.value=String(e),B.value=String(t))},Je=()=>{const e=Re();if(e){e.fillDomainFromUser=!0;try{if("hex"!==e.layerType)return;const t=e.hexLayer||{};if(t.getFillColor&&"object"==typeof t.getFillColor){t.getFillColor.autoDomain=!1;try{delete t.getFillColor._dynamicDomain}catch(e){}}if(t.getLineColor&&"object"==typeof t.getLineColor){t.getLineColor.autoDomain=!1;try{delete t.getLineColor._dynamicDomain}catch(e){}}}catch(e){}}},Xe=()=>{Ge()},Ye=()=>{Ge(),Je(),Ve()},Qe=()=>{try{const n=t(e);if(Se.value=`initialViewState = ${oe(n,0)}`,o&&function(){const e=document.activeElement;return!(!e||!e.closest?.("#debug-panel")||"INPUT"!==e.tagName&&"TEXTAREA"!==e.tagName&&"SELECT"!==e.tagName)}())return;we.value=W(n.longitude,5),xe.value=W(n.latitude,5),Ce.value=W(n.zoom,2),Le.value=W(n.pitch??0,1),Ee.value=W(n.bearing??0,1)}catch(e){}},Ke=()=>{const e=r.classList.toggle("collapsed");l.innerHTML=e?"&#x203A;":"&#x2039;",U(o,r,l)};let et=!1,tt=0,nt=280;const it=e=>{if(!et)return;const t=e.clientX-tt,n=H(nt+t,240,520);r.style.width=`${n}px`,U(o,r,l),e.preventDefault()},ot=e=>{et&&(et=!1,window.removeEventListener("pointermove",it),window.removeEventListener("pointerup",ot))},rt=e=>{et=!0,tt=e.clientX,nt=r.getBoundingClientRect().width||280,window.addEventListener("pointermove",it,{passive:!1}),window.addEventListener("pointerup",ot),e.preventDefault(),e.stopPropagation()};l.addEventListener("click",Ke),s.addEventListener("pointerdown",rt,{passive:!1}),u.addEventListener("change",()=>He()),k.addEventListener("change",()=>{We(),Ve()}),re.addEventListener("change",()=>{Ue(),Ve()}),[b,v].forEach(e=>e.addEventListener("change",Ve)),w.addEventListener("change",()=>{try{x&&(x.style.display=w.checked?"block":"none")}catch(e){}Ve()}),C.addEventListener("change",Ve),L.addEventListener("input",Ve),L.addEventListener("change",Ve),E.addEventListener("input",()=>{S.value=E.value,Ve()}),S.addEventListener("change",()=>{E.value=S.value,Ve()}),[A,D,R].forEach(e=>e.addEventListener("change",()=>{je(T,_,I,M),Ve()})),P.addEventListener("input",()=>{Ze()}),B.addEventListener("input",()=>{Ze()}),P.addEventListener("change",()=>{Je(),Ve()}),B.addEventListener("change",()=>{Je(),Ve()}),j.addEventListener("input",Xe),O.addEventListener("input",Xe),j.addEventListener("change",Ye),O.addEventListener("change",Ye),q.addEventListener("input",()=>{z.textContent=q.value,Ve()}),te.addEventListener("input",()=>{ne.textContent=te.value,Ve()}),[se,ye,ge,fe].forEach(e=>e.addEventListener("change",()=>{je(ce,pe,ue,de),Ve()})),me.addEventListener("input",()=>{he.textContent=me.value,Ve()}),be.addEventListener("input",()=>{ve.value=be.value,Ve()}),ve.addEventListener("change",()=>{be.value=ve.value,Ve()});let lt=null;const at=()=>{const e=Re();if(!e)return;if("hex"!==e.layerType||e.isTileLayer||!e.parquetData&&!e.parquetUrl)return;const t=String(Ae?.value||"").trim()||"SELECT * FROM data";try{Ae&&(Ae.value=t)}catch(e){}e.sql=t;try{ze()}catch(e){}$e&&($e.textContent="typing..."),clearTimeout(lt),lt=setTimeout(()=>{try{window.dispatchEvent(new CustomEvent("fusedmaps:sql:update",{detail:{layerId:e.id,sql:t}}))}catch(e){}},500)};try{Ae?.addEventListener("input",at)}catch(e){}const st=e=>{try{const t=e?.detail||{},n=String(t.layerId||""),i=String(t.status||""),o=Re();if(!o||o.id!==n)return;$e&&($e.textContent=i)}catch(e){}};try{window.addEventListener("fusedmaps:sql:status",st)}catch(e){}try{e.on("moveend",Qe),e.on("rotateend",Qe),e.on("pitchend",Qe)}catch(e){}return We(),Ue(),je(T,_,I,M),je(ce,pe,ue,de),He(),Qe(),U(o,r,l),window.addEventListener("resize",()=>U(o,r,l)),{destroy:()=>{try{document.removeEventListener("click",Oe)}catch(e){}try{window.removeEventListener("blur",Oe)}catch(e){}try{l.removeEventListener("click",Ke)}catch(e){}try{s.removeEventListener("pointerdown",rt)}catch(e){}try{e.off("moveend",Qe),e.off("rotateend",Qe),e.off("pitchend",Qe)}catch(e){}try{window.removeEventListener("fusedmaps:sql:status",st)}catch(e){}try{o?.remove()}catch(e){}}}}(o,e):null;let s=null,u=null,p=null,y=null;return!1!==e.ui?.layerPanel&&function(t,n){P=(t,n)=>{Fe(t,n,o,e,s)},B=t,j=n;let i=document.getElementById("layer-panel");if(i||(i=document.createElement("div"),i.id="layer-panel",i.innerHTML='<div id="layer-list"></div>',document.body.appendChild(i)),window.toggleLayerVisibility=(e,t)=>{P&&P(e,t)},window.onLayerItemClick=(e,t)=>{try{if(e&&e.target.closest?.(".layer-eye"))return}catch(e){}const i=!1!==n[t];P&&P(t,!i)},D(t,n),!O){O=!0;try{window.addEventListener("fusedmaps:legend:update",()=>{try{D(B,j)}catch(e){}})}catch(e){}}}(e.layers,Se),!1!==e.ui?.legend&&function(e,t,n){let i=document.getElementById("color-legend");i||(i=document.createElement("div"),i.id="color-legend",i.className="color-legend",i.style.display="none",document.body.appendChild(i)),R(e,t,n)}(e.layers,Se,N()),o.on("load",()=>{const n=_(o,e.layers,Se,e);s=n.deckOverlay,D(e.layers,Se),R(e.layers,Se,N()),u=()=>{R(e.layers,Se,N())};try{window.addEventListener("fusedmaps:legend:update",u)}catch(e){}if(!1!==e.ui?.tooltip&&function(e,t,n,i){let o=document.getElementById("tooltip");o||(o=document.createElement("div"),o.id="tooltip",document.body.appendChild(o));const r=[];t.forEach(e=>{if(e.isTileLayer)return;const t=[];"hex"===e.layerType?((e.hexLayer||{}).extruded?t.push(`${e.id}-extrusion`):t.push(`${e.id}-fill`),t.push(`${e.id}-outline`)):"vector"===e.layerType?t.push(`${e.id}-fill`,`${e.id}-outline`,`${e.id}-circle`,`${e.id}-line`):"mvt"===e.layerType?t.push(`${e.id}-fill`,`${e.id}-line`,`${e.id}-extrusion`):e.layerType,t.forEach(t=>{r.push({layerId:t,layerDef:e})})}),e.on("mousemove",l=>{const a=[...r];try{const n=e.getStyle?.()?.layers||[];for(const e of t){if("pmtiles"!==e.layerType)continue;const t=`${e.id}-`;for(const i of n){const n=i?.id;"string"==typeof n&&n.startsWith(t)&&a.push({layerId:n,layerDef:e})}}}catch(e){}const s=a.map(e=>e.layerId).filter(t=>e.getLayer(t)),c=e=>{const n=t.findIndex(t=>t.id===e);return-1===n?Number.POSITIVE_INFINITY:n};let d=null,u=Number.POSITIVE_INFINITY;if(s.length){const t=e.queryRenderedFeatures(l.point,{layers:s});for(const e of t||[]){const t=a.find(t=>t.layerId===e.layer?.id);if(!t)continue;if(!1===n[t.layerDef.id])continue;const i=c(t.layerDef.id);i<u&&(u=i,d={type:"mapbox",layerDef:t.layerDef,props:e.properties||{}});break}}if(i){const e=i.__fused_hex_tiles__,o=e?.pickObject||i?.pickObject;try{const e=o?.({x:l.point.x,y:l.point.y,radius:4});if(e?.object){const i=String(e.layer?.id||""),o=i.includes("-tiles")?i.split("-tiles")[0]:i,r=t.find(e=>e.id===o);if(r&&!1!==n[r.id]){const t=c(r.id);t<u&&(u=t,d={type:"deck",layerDef:r,props:e.object.properties||e.object||{}})}}}catch(e){}}if(!d)return o.style.display="none",void(e.getCanvas().style.cursor="");e.getCanvas().style.cursor="pointer";const p=function(e){if("hex"===e.layerType){const t=e;return t.hexLayer?.tooltipColumns||t.hexLayer?.tooltipAttrs||t.tooltipColumns||[]}if("vector"===e.layerType){const t=e;return t.vectorLayer?.tooltipColumns||t.vectorLayer?.tooltipAttrs||t.tooltipColumns||[]}if("pmtiles"===e.layerType){const t=e;return t.vectorLayer?.tooltipColumns||t.vectorLayer?.tooltipAttrs||t.tooltipColumns||[]}return e.tooltipColumns||[]}(d.layerDef),y=function(e,t){const n=[];return null!=e.hex&&n.push(`<span class="tt-row"><span class="tt-key">hex</span><span class="tt-val">${String(e.hex).slice(0,12)}...</span></span>`),t.length?(t.forEach(t=>{if("hex"===t)return;const i=e[t];if(null==i)return;const o="number"==typeof i?Number(i).toFixed(2):String(i);n.push(`<span class="tt-row"><span class="tt-key">${t}</span><span class="tt-val">${o}</span></span>`)}),n):(0===n.length&&Object.keys(e).slice(0,5).forEach(t=>{n.push(`<span class="tt-row"><span class="tt-key">${t}</span><span class="tt-val">${e[t]}</span></span>`)}),n)}(d.props,p);y.length?(o.innerHTML=`<strong class="tt-title">${d.layerDef.name}</strong>`+y.join(""),o.style.left=`${l.point.x+10}px`,o.style.top=`${l.point.y+10}px`,o.style.display="block"):o.style.display="none"}),e.on("mouseleave",()=>{e.getCanvas().style.cursor="",o.style.display="none"})}(o,e.layers,Se,s),e.drawing?.enabled&&async function(e,t){const n=t.drawing;if(!n?.enabled)return null;!function(){if(document.getElementById("fusedmaps-drawing-style"))return;const e=document.createElement("style");e.id="fusedmaps-drawing-style",e.textContent="\n    :root {\n      --fm-bg-glass: rgba(15, 15, 20, 0.85);\n      --fm-bg-glass-hover: rgba(25, 25, 35, 0.9);\n      --fm-border-glass: rgba(255, 255, 255, 0.08);\n      --fm-text-primary: #f0f0f5;\n      --fm-text-muted: #8888a0;\n      --fm-accent: #6366f1;\n      --fm-accent-glow: rgba(99, 102, 241, 0.4);\n    }\n    .fm-toolbar {\n      position: fixed;\n      left: 50%;\n      transform: translateX(-50%);\n      z-index: 1000;\n      display: flex;\n      gap: 4px;\n      padding: 6px;\n      background: var(--fm-bg-glass);\n      backdrop-filter: blur(20px);\n      -webkit-backdrop-filter: blur(20px);\n      border: 1px solid var(--fm-border-glass);\n      border-radius: 16px;\n      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);\n      user-select: none;\n    }\n    .fm-toolbar.bottom { bottom: 16px; }\n    .fm-toolbar.top { top: 16px; }\n    .fm-toolbar-group { display:flex; gap:2px; }\n    .fm-toolbar-group + .fm-toolbar-group {\n      margin-left: 4px;\n      padding-left: 8px;\n      border-left: 1px solid var(--fm-border-glass);\n    }\n    .fm-tool-btn {\n      display:flex;\n      align-items:center;\n      justify-content:center;\n      width: 40px;\n      height: 40px;\n      border: none;\n      border-radius: 10px;\n      background: transparent;\n      color: var(--fm-text-muted);\n      cursor: pointer;\n      transition: all 0.15s ease;\n      position: relative;\n    }\n    .fm-tool-btn:hover { background: var(--fm-bg-glass-hover); color: var(--fm-text-primary); }\n    .fm-tool-btn.active { background: var(--fm-accent); color: white; box-shadow: 0 0 20px var(--fm-accent-glow); }\n    .fm-tool-btn:disabled { opacity: 0.35; cursor: not-allowed; }\n    .fm-tool-btn svg { width: 20px; height: 20px; }\n\n    .fm-color-btn {\n      width: 40px;\n      height: 40px;\n      border: 2px solid transparent;\n      border-radius: 10px;\n      background: var(--fm-current-color, #6366f1);\n      cursor: pointer;\n      transition: all 0.15s ease;\n    }\n    .fm-color-btn:hover { transform: scale(1.05); }\n    .fm-color-btn.active { border-color: white; box-shadow: 0 0 12px var(--fm-current-color, #6366f1); }\n\n    .fm-popover {\n      position: absolute;\n      bottom: 100%;\n      left: 50%;\n      transform: translateX(-50%);\n      margin-bottom: 8px;\n      padding: 8px;\n      background: var(--fm-bg-glass);\n      backdrop-filter: blur(20px);\n      border: 1px solid var(--fm-border-glass);\n      border-radius: 12px;\n      display: none;\n      box-shadow: 0 8px 32px rgba(0,0,0,0.4);\n    }\n    /* Popovers: show state should preserve each popover's intended layout (grid vs flex) */\n    .fm-popover.show { display: block; }\n    .fm-popover.fm-color-grid.show { display: grid; }\n    .fm-popover.fm-stroke-list.show { display: flex; }\n    .fm-color-grid {\n      display:grid;\n      grid-template-columns: repeat(4, 1fr);\n      gap: 6px;\n    }\n    .fm-color-opt {\n      width: 28px;\n      height: 28px;\n      border: 2px solid transparent;\n      border-radius: 50%;\n      cursor: pointer;\n      transition: all 0.15s ease;\n    }\n    .fm-color-opt:hover { transform: scale(1.15); }\n    .fm-color-opt.selected { border-color: white; }\n\n    .fm-stroke-list { display:flex; flex-direction:column; gap:4px; }\n    .fm-stroke-opt {\n      display:flex; align-items:center; gap:10px;\n      padding: 6px 12px;\n      border:none;\n      border-radius: 8px;\n      background: transparent;\n      color: var(--fm-text-muted);\n      cursor:pointer;\n      font-size: 12px;\n      white-space: nowrap;\n    }\n    .fm-stroke-opt:hover { background: var(--fm-bg-glass-hover); color: var(--fm-text-primary); }\n    .fm-stroke-opt.selected { color: var(--fm-accent); }\n    .fm-stroke-line { width: 40px; height: var(--stroke-height,2px); background: currentColor; border-radius: 2px; }\n  ",document.head.appendChild(e)}();const i=await async function(){return window.MapboxDraw?window.MapboxDraw:le||(le=new Promise((e,t)=>{try{if(!re){re=!0;const e=document.createElement("link");e.rel="stylesheet",e.href="https://unpkg.com/@mapbox/mapbox-gl-draw@1.5.0/dist/mapbox-gl-draw.css",document.head.appendChild(e)}const n=document.createElement("script");n.src="https://unpkg.com/@mapbox/mapbox-gl-draw@1.5.0/dist/mapbox-gl-draw.js",n.onload=()=>e(window.MapboxDraw),n.onerror=()=>t(new Error("Failed to load mapbox-gl-draw")),document.head.appendChild(n)}catch(e){t(e)}}).finally(()=>{le=null}),le)}(),o=n.style?.stroke||"#6366f1",r=n.style?.fill||se(o,.25),l="number"==typeof n.style?.strokeWidth?n.style.strokeWidth:4,a=new i({displayControlsDefault:!1,modes:{...i.modes||{},draw_freehand:{onSetup(e={}){const t=this.newFeature({type:"Feature",properties:{stroke:"string"==typeof e.stroke?e.stroke:void 0,fill:"string"==typeof e.fill?e.fill:void 0,strokeWidth:"number"==typeof e.strokeWidth?e.strokeWidth:void 0},geometry:{type:"LineString",coordinates:[]}});return this.addFeature(t),this.clearSelectedFeatures(),this.updateUIClasses({mouse:"add"}),this.setActionableState({trash:!0}),{line:t,lastPt:null,isDown:!1}},onMouseDown(e,t){e.isDown=!0;const n=[t.lngLat.lng,t.lngLat.lat];e.line.updateCoordinate("0",n[0],n[1]),e.lastPt=this.map.project(t.lngLat)},onMouseMove(e,t){if(!e.isDown)return;const n=this.map.project(t.lngLat);if(e.lastPt){const t=n.x-e.lastPt.x,i=n.y-e.lastPt.y;if(t*t+i*i<9)return}const i=e.line.getCoordinates().length;e.line.updateCoordinate(String(i),t.lngLat.lng,t.lngLat.lat),e.lastPt=n},onMouseUp(e){e.isDown=!1;const t=e.line.getCoordinates();if(!t||t.length<2)return this.deleteFeature([e.line.id],{silent:!0}),void this.changeMode("simple_select");this.changeMode("simple_select",{featureIds:[e.line.id]})},onStop(e){this.updateUIClasses({mouse:"none"})},toDisplayFeatures(e,t,n){n(t)}}},styles:ce(o,r,l)});e.addControl(a,"top-left");try{const e=document.getElementsByClassName("mapboxgl-ctrl-draw");for(const t of Array.from(e))t.style.display="none"}catch(e){}try{n.initialGeoJSON&&a.add(n.initialGeoJSON)}catch(e){}const s=document.createElement("div");s.className="fm-toolbar "+("top"===n.position?"top":"bottom");const c=n.tools?.length?n.tools:["select","freehand","line","polygon","rectangle","circle"];let d=o,u=l,p=n.defaultMode||"select";const y=document.createElement("div");y.className="fm-toolbar-group";const g=(e,t,n,i=!0)=>{const o=document.createElement("button");return o.className="fm-tool-btn",o.type="button",o.title=t,o.disabled=!i,o.innerHTML=ae(n),y.appendChild(o),o},f={};c.includes("select")&&(f.select=g(0,"Select","select",!0)),c.includes("freehand")&&(f.freehand=g(0,"Freehand","freehand",!0)),c.includes("line")&&(f.line=g(0,"Line","line",!0)),c.includes("polygon")&&(f.polygon=g(0,"Polygon","polygon",!0)),c.includes("rectangle")&&(f.rectangle=g(0,"Rectangle (coming soon)","rectangle",!1)),c.includes("circle")&&(f.circle=g(0,"Circle (coming soon)","circle",!1)),s.appendChild(y);const m=document.createElement("div");m.className="fm-toolbar-group",m.style.position="relative";const h=document.createElement("div");h.style.position="relative";const b=document.createElement("button");b.className="fm-color-btn",b.type="button",b.title="Color",b.style.setProperty("--fm-current-color",d),b.style.background=d;const v=document.createElement("div");v.className="fm-popover fm-color-grid",["#ef4444","#f97316","#eab308","#22c55e","#06b6d4","#3b82f6","#8b5cf6","#ec4899","#f43f5e","#6366f1","#14b8a6","#84cc16","#a855f7","#0ea5e9","#64748b","#ffffff"].forEach(e=>{const t=document.createElement("div");t.className="fm-color-opt"+(e===d?" selected":""),t.style.background=e,t.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),d=e,b.style.background=d,b.style.setProperty("--fm-current-color",d);try{k()}catch(e){}Array.from(v.querySelectorAll(".fm-color-opt")).forEach(e=>{e.classList.toggle("selected",e.style.background===d)}),v.classList.remove("show"),M()}),v.appendChild(t)}),b.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),v.classList.toggle("show"),C.classList.remove("show")}),h.appendChild(b),h.appendChild(v);const w=document.createElement("div");w.style.position="relative";const x=document.createElement("button");x.className="fm-tool-btn",x.type="button",x.title="Stroke Width",x.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n    <line x1="4" y1="6" x2="20" y2="6" stroke-width="1"/>\n    <line x1="4" y1="12" x2="20" y2="12" stroke-width="2"/>\n    <line x1="4" y1="18" x2="20" y2="18" stroke-width="4"/>\n  </svg>';const C=document.createElement("div");C.className="fm-popover fm-stroke-list",[{width:2,label:"Fine"},{width:4,label:"Medium"},{width:6,label:"Bold"},{width:10,label:"Heavy"}].forEach(e=>{const t=document.createElement("button");t.type="button",t.className="fm-stroke-opt"+(e.width===u?" selected":""),t.innerHTML=`<span class="fm-stroke-line" style="--stroke-height:${e.width}px"></span><span>${e.label}</span>`,t.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),u=e.width;try{k()}catch(e){}Array.from(C.querySelectorAll(".fm-stroke-opt")).forEach(t=>{t.classList.toggle("selected",t.textContent?.includes(e.label))}),C.classList.remove("show"),M()}),C.appendChild(t)}),x.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),C.classList.toggle("show"),v.classList.remove("show")}),w.appendChild(x),w.appendChild(C),m.appendChild(h),m.appendChild(w),s.appendChild(m);const L=document.createElement("div");L.className="fm-toolbar-group";const E=document.createElement("button");E.className="fm-tool-btn",E.type="button",E.title="Clear All",E.innerHTML=ae("trash"),E.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation();try{a.deleteAll()}catch(e){}}),L.appendChild(E),s.appendChild(L),document.body.appendChild(s);const S=["gl-draw-polygon-fill-cold","gl-draw-polygon-fill-hot","gl-draw-polygon-stroke-cold","gl-draw-polygon-stroke-hot","gl-draw-line-cold","gl-draw-line-hot","gl-draw-point-cold","gl-draw-point-hot"],k=()=>{const t=["coalesce",["get","stroke"],d],n=["coalesce",["get","fill"],se(d,.25)],i=["coalesce",["get","strokeWidth"],u];try{for(const o of S)if(e.getLayer?.(o)){if(o.includes("fill"))try{e.setPaintProperty(o,"fill-color",n)}catch(e){}if(o.includes("stroke")||o.includes("line")){try{e.setPaintProperty(o,"line-color",t)}catch(e){}try{e.setPaintProperty(o,"line-width",i)}catch(e){}}if(o.includes("point"))try{e.setPaintProperty(o,"circle-color",t)}catch(e){}}}catch(e){}},F=()=>{try{for(const t of S)try{e.getLayer?.(t)&&e.moveLayer(t)}catch(e){}}catch(e){}};try{k(),F(),setTimeout(k,50),setTimeout(F,60),setTimeout(k,250),setTimeout(F,260),setTimeout(k,750),setTimeout(F,760)}catch(e){}let $=null;const A=()=>{clearTimeout($),$=setTimeout(()=>{try{F()}catch(e){}try{k()}catch(e){}},50)};try{e.on("styledata",A)}catch(e){}const T=e=>{try{for(const t of e||[])if(t)try{a.setFeatureProperty(t,"stroke",d),a.setFeatureProperty(t,"fill",se(d,.25)),a.setFeatureProperty(t,"strokeWidth",u)}catch(e){}}catch(e){}};function M(){try{const e=a.getSelectedIds&&a.getSelectedIds()||[];if(!e.length)return;T(e)}catch(e){}}function I(e){p=e,function(e,t){Object.entries(e).forEach(([e,n])=>{try{n.classList.toggle("active",e===t)}catch(e){}})}(f,e);try{"select"===e?a.changeMode("simple_select"):"freehand"===e?a.changeMode("draw_freehand",{stroke:d,strokeWidth:u,fill:se(d,.25)}):"line"===e?a.changeMode("draw_line_string"):"polygon"===e&&a.changeMode("draw_polygon")}catch(e){}}Object.entries(f).forEach(([e,t])=>{t.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),I(e)})}),I(p);const N=new Set;try{const e=a.getAll?.()?.features||[];for(const t of e)t?.id&&N.add(String(t.id))}catch(e){}const _=e=>{try{const t=String(e?.mode||"");"simple_select"!==t&&"direct_select"!==t||((()=>{try{const e=a.getAll?.()?.features||[],t=[];for(const n of e){const e=n?.id?String(n.id):"";e&&(N.has(e)||(N.add(e),t.push(e)))}t.length&&T(t)}catch(e){}})(),(()=>{try{const e=a.getAll?.()?.features||[];for(const t of e){const e=t?.id?String(t.id):"";if(!e)continue;const n=t.properties||{},i=!("string"==typeof n.stroke&&n.stroke.length),o=!("string"==typeof n.fill&&n.fill.length),r=!("number"==typeof n.strokeWidth&&Number.isFinite(n.strokeWidth));if(i||o||r)try{i&&a.setFeatureProperty(e,"stroke",d),o&&a.setFeatureProperty(e,"fill",se(d,.25)),r&&a.setFeatureProperty(e,"strokeWidth",u)}catch(e){}}}catch(e){}})())}catch(e){}},P=()=>{try{const e=a.getSelectedIds&&a.getSelectedIds()||[];if(!e.length)return;const t=a.get(e[0]),n=t?.properties||{};if("string"==typeof n.stroke&&n.stroke){d=n.stroke,b.style.background=d,b.style.setProperty("--fm-current-color",d);try{k()}catch(e){}}if("number"==typeof n.strokeWidth&&Number.isFinite(n.strokeWidth)){u=n.strokeWidth;try{k()}catch(e){}}try{Array.from(v.querySelectorAll(".fm-color-opt")).forEach(e=>{e.classList.toggle("selected",e.style.background===d)})}catch(e){}}catch(e){}};try{e.on("draw.modechange",_),e.on("draw.selectionchange",P)}catch(e){}const B=()=>{try{v.classList.remove("show")}catch(e){}try{C.classList.remove("show")}catch(e){}};document.addEventListener("click",B);const j=n.layerId||"drawings",O=t=>function(e,t){try{const n=e.getStyle?.()?.layers||[];for(const i of n){const n=i?.id;if("string"==typeof n&&(n.startsWith("gl-draw")||n.startsWith("mapbox-gl-draw")))try{e.setLayoutProperty(n,"visibility",t?"visible":"none")}catch(e){}}}catch(e){}}(e,t);try{const e=t.__visibilityState?.[j];!1===e&&O(!1)}catch(e){}return{destroy:()=>{try{document.removeEventListener("click",B)}catch(e){}try{s.remove()}catch(e){}try{e.off("draw.modechange",_),e.off("draw.selectionchange",P)}catch(e){}try{e.off("styledata",A)}catch(e){}try{e.removeControl(a)}catch(e){}},setVisible:O,getGeoJSON:()=>{try{return a.getAll?.()||{type:"FeatureCollection",features:[]}}catch(e){return{type:"FeatureCollection",features:[]}}}}}(o,e).then(t=>{y=t;try{e.__drawingHandle=t}catch(e){}try{const t=e.drawing?.layerId||"drawings",n=!1!==Se[t];y?.setVisible?.(n)}catch(e){}}).catch(e=>{console.error("[FusedMaps] Failed to setup drawing:",e)}),!1!==e.highlightOnClick&&function(e,t,n,i){e.on("click",n=>{const o=function(e,t){const n=[];return t.forEach(t=>{if(t.isTileLayer)return;const i=t.layerType;let o=[];if("vector"===i)o=[`${t.id}-fill`,`${t.id}-circle`,`${t.id}-line`];else if("hex"===i){const e=t;o=[e.hexLayer?.extruded?`${t.id}-extrusion`:`${t.id}-fill`]}o.forEach(t=>{try{e.getLayer(t)&&n.push(t)}catch(e){}})}),["gdf-fill","gdf-circle","hex-fill"].forEach(t=>{try{e.getLayer(t)&&n.push(t)}catch(e){}}),n}(e,t);if(!o.length)return;let r=[];try{r=e.queryRenderedFeatures(n.point,{layers:o})||[]}catch(e){}if(r.length>0)pe(e,r[0]);else if(i){const t=i?.pickObject?.({x:n.point.x,y:n.point.y,radius:4});t?.object?pe(e,{properties:t.object.properties||t.object,geometry:null}):ue&&pe(e,null)}else ue&&pe(e,null)})}(o,e.layers,0,s),e.messaging&&fe(o,e.messaging,e.layers),p=function(e,t,n,o){const r=(t.layers||[]).filter(Ce);if(!r.length)return null;try{xe={};for(const e of r)xe[e.id]=e.name||e.id}catch(e){}try{we||(we=Le())}catch(e){}const l=new ve;let s=!1;const c=async(t,r)=>{if(!s){Ee(t.id,"initializing...");try{if(await l.init(),s)return;try{const e=t.hexLayer?.getFillColor,n=e&&"object"==typeof e&&!Array.isArray(e)?e.attr:null,i=e&&"object"==typeof e&&!Array.isArray(e)&&(!0===e.autoDomain||!Array.isArray(e.domain));if(n&&i&&!0!==t.fillDomainFromUser){const e=await l.getMinMax(t,String(n));e&&t.hexLayer&&"object"==typeof t.hexLayer.getFillColor&&!Array.isArray(t.hexLayer.getFillColor)&&(t.hexLayer.getFillColor.domain=[e.min,e.max])}}catch(e){}t.sql=r||t.sql||"SELECT * FROM data";try{const e=t.sql||"SELECT * FROM data",n=!0===t.fillDomainFromUser,i=t.hexLayer?.getFillColor;if(!n&&i&&"object"==typeof i&&!Array.isArray(i)&&"colorContinuous"===i["@@function"]){const n=String(i.attr||"");if(n&&!0===i.autoDomain){const o=await l.getMinMaxFromQuery(t,n,e);o&&(i.domain=[o.min,o.max])}}const o=t.hexLayer?.getLineColor;if(!n&&o&&"object"==typeof o&&!Array.isArray(o)&&"colorContinuous"===o["@@function"]){const n=String(o.attr||"");if(n&&!0===o.autoDomain){const i=await l.getMinMaxFromQuery(t,n,e);i&&(o.domain=[i.min,i.max])}}}catch(e){}Ee(t.id,"running...");const c=await l.runSqlGeoJSON(t,t.sql||"SELECT * FROM data");if(s)return;if(!c?.geojson)throw new Error("DuckDB GeoJSON path unavailable (requires spatial + h3 extensions and compatible columns).");const u=c.geojson;!function(e,t){I[e]=t}(t.id,u);const p=!1!==n[t.id],y=function(e,t,n){try{const i=e.getSource(t);if(i&&"function"==typeof i.setData)return i.setData(n),!0}catch(e){}return!1}(e,t.id,u);if(!y)try{d(e,t,u,p)}catch(e){}!function(e,t){const n=t.hexLayer||{},o=t.data||[],r=Array.isArray(n.getFillColor)?i(n.getFillColor,.8):a(n.getFillColor,o)||"rgba(0,144,255,0.7)",l=n.getLineColor?Array.isArray(n.getLineColor)?i(n.getLineColor,1):a(n.getLineColor,o):"rgba(255,255,255,0.3)",s="number"==typeof n.opacity&&isFinite(n.opacity)?Math.max(0,Math.min(1,n.opacity)):.8;try{n.extruded&&e.getLayer(`${t.id}-extrusion`)&&(e.setPaintProperty(`${t.id}-extrusion`,"fill-extrusion-color",r),e.setPaintProperty(`${t.id}-extrusion`,"fill-extrusion-opacity",s))}catch(e){}try{!n.extruded&&e.getLayer(`${t.id}-fill`)&&(e.setPaintProperty(`${t.id}-fill`,"fill-color",r),e.setPaintProperty(`${t.id}-fill`,"fill-opacity",s))}catch(e){}try{e.getLayer(`${t.id}-outline`)&&(e.setPaintProperty(`${t.id}-outline`,"line-color",l),e.setPaintProperty(`${t.id}-outline`,"line-width",n.lineWidthMinPixels||.5))}catch(e){}}(e,t),Ee(t.id,`${(c.count||0).toLocaleString()} rows`),function(){try{window.dispatchEvent(new Event("fusedmaps:legend:update"))}catch(e){}}();try{o?.()}catch(e){}}catch(e){Ee(t.id,`error: ${(e?.message||"query failed").slice(0,60)}`)}}};(async()=>{for(const e of r){if(s)break;const t=(e.sql||"SELECT * FROM data").trim();await c(e,t)}})();const u=e=>{const t=e?.detail||{},n=String(t.layerId||""),i=String(t.sql||""),o=r.find(e=>e.id===n);o&&c(o,i)};try{window.addEventListener("fusedmaps:sql:update",u)}catch(e){}return{destroy:()=>{s=!0;try{window.removeEventListener("fusedmaps:sql:update",u)}catch(e){}}}}(o,e,Se,()=>{try{D(e.layers,Se)}catch(e){}try{R(e.layers,Se,N())}catch(e){}}),!e.hasCustomView){!function(e,t){const n=new mapboxgl.LngLatBounds,i=N();t.forEach(e=>{if(e.isTileLayer)return;if("raster"===e.layerType){const t=e.imageBounds;if(Array.isArray(t)&&4===t.length){const[e,i,o,r]=t;[e,i,o,r].every(e=>"number"==typeof e&&Number.isFinite(e))&&(n.extend([e,i]),n.extend([o,r]))}return}const t=i[e.id];t?.features?.length&&t.features.forEach(e=>{"Point"===e.geometry?.type?n.extend(e.geometry.coordinates):"Polygon"===e.geometry?.type||"MultiPolygon"===e.geometry?.type?("Polygon"===e.geometry.type?[e.geometry.coordinates]:e.geometry.coordinates).forEach(e=>e[0]?.forEach(e=>n.extend(e))):"LineString"===e.geometry?.type&&e.geometry.coordinates.forEach(e=>n.extend(e))})}),n.isEmpty()||e.fitBounds(n,{padding:50,maxZoom:15,duration:500})}(o,e.layers);try{const e=()=>{try{const e=t(o);r?.setHomeViewState?.(e)}catch(e){}try{o.off("moveend",e)}catch(e){}};o.on("moveend",e)}catch(e){}}}),o.on("load",()=>{[100,500,1e3].forEach(e=>setTimeout(()=>o.resize(),e))}),window.addEventListener("resize",()=>o.resize()),document.addEventListener("visibilitychange",()=>{document.hidden||setTimeout(()=>o.resize(),100)}),{map:o,deckOverlay:s,setLayerVisibility:(t,n)=>{Fe(t,n,o,e,s)},updateLegend:()=>{R(e.layers,Se,N())},destroy:()=>{try{s?.__fused_hex_tiles__?.destroy?.()}catch(e){}try{r?.destroy?.()}catch(e){}try{l?.destroy?.()}catch(e){}try{p?.destroy?.()}catch(e){}try{y?.destroy?.()}catch(e){}try{u&&window.removeEventListener("fusedmaps:legend:update",u)}catch(e){}o.remove?.()}}}function Fe(e,t,n,i,o){Se[e]=t;const r=i.layers.find(t=>t.id===e);if("drawing"===r?.layerType)try{const e=i.__drawingHandle;e?.setVisible?.(t)}catch(e){}else!function(e,t,n,i,o){const r=i.find(e=>e.id===t);if(r)switch(r.layerType){case"hex":{const i=r;if(i.isTileLayer){const e=o?.__fused_hex_tiles__;try{e?.rebuild?.()}catch(e){}}else!function(e,t,n,i){(i?[`${t}-extrusion`,`${t}-outline`]:[`${t}-fill`,`${t}-outline`]).forEach(t=>{try{e.getLayer(t)&&e.setLayoutProperty(t,"visibility",n?"visible":"none")}catch(e){}})}(e,t,n,!0===i.hexLayer?.extruded);break}case"vector":case"mvt":!function(e,t,n){[`${t}-fill`,`${t}-outline`,`${t}-line`,`${t}-circle`,`${t}-extrusion`].forEach(t=>{try{e.getLayer(t)&&e.setLayoutProperty(t,"visibility",n?"visible":"none")}catch(e){}})}(e,t,n);break;case"raster":!function(e,t,n){const i=`${t}-raster`;try{e.getLayer(i)&&e.setLayoutProperty(i,"visibility",n?"visible":"none")}catch(e){}}(e,t,n);break;case"pmtiles":!function(e,t,n){const i=`${t}-`,o=e.getStyle()?.layers||[];for(const t of o){const o=t?.id;if(o&&o.startsWith(i))try{e.setLayoutProperty(o,"visibility",n?"visible":"none")}catch(e){}}}(e,t,n)}}(n,e,t,i.layers,o);D(i.layers,Se),R(i.layers,Se,N())}"undefined"!=typeof window&&(window.FusedMaps={init:ke});var $e={init:ke};e.default=$e,e.init=ke,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=fusedmaps.umd.js.map
