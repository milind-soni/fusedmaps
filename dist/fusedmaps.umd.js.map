{"version":3,"file":"fusedmaps.umd.js","sources":["../src/core/map.ts","../src/color/palettes.ts","../src/color/expressions.ts","../src/layers/hex.ts","../src/layers/vector.ts","../src/layers/raster.ts","../src/layers/hex-tiles.ts","../src/layers/pmtiles.ts","../src/layers/index.ts","../src/ui/layer-panel.ts","../src/ui/legend.ts","../src/ui/widgets.ts","../src/ui/debug/export.ts","../src/ui/debug/palettes.ts","../src/ui/debug/template.ts","../src/utils.ts","../src/ui/debug/apply.ts","../src/ui/debug/sql_panel.ts","../src/ui/debug.ts","../src/ui/debug/ai_panel.ts","../src/interactions/highlight.ts","../src/messaging/bus.ts","../src/messaging/index.ts","../src/messaging/broadcast.ts","../src/core/view.ts","../src/messaging/sync.ts","../src/sql/duckdb.ts","../src/sql/setup.ts","../src/state/layer-store.ts","../src/config/normalize.ts","../src/index.ts","../src/ui/tooltip.ts"],"sourcesContent":["/**\n * Core map initialization\n */\n\nimport type { ViewState } from '../types';\n\ninterface MapInitOptions {\n  containerId: string;\n  mapboxToken: string;\n  styleUrl: string;\n  initialViewState: ViewState;\n  screenshotEnabled?: boolean;\n}\n\n/**\n * Initialize a Mapbox GL map\n */\nexport function initMap(options: MapInitOptions): mapboxgl.Map {\n  const { containerId, mapboxToken, styleUrl, initialViewState, screenshotEnabled } = options;\n  \n  // Set access token\n  (window.mapboxgl as any).accessToken = mapboxToken;\n  \n  // Create map\n  const map = new window.mapboxgl.Map({\n    container: containerId,\n    style: styleUrl,\n    center: [initialViewState.longitude, initialViewState.latitude],\n    zoom: initialViewState.zoom,\n    pitch: initialViewState.pitch || 0,\n    bearing: initialViewState.bearing || 0,\n    projection: 'mercator',\n    // Match map_utils.py: enable pitch behavior; Cmd+drag orbit is implemented separately.\n    pitchWithRotate: true,\n    // Needed for reliable canvas capture (screenshot button). May increase GPU memory usage.\n    ...(screenshotEnabled ? { preserveDrawingBuffer: true } : {})\n  });\n  \n  return map;\n}\n\n/**\n * Apply view state to an existing map\n */\nexport function applyViewState(map: mapboxgl.Map, viewState: Partial<ViewState>): void {\n  if (viewState.longitude !== undefined && viewState.latitude !== undefined) {\n    map.setCenter([viewState.longitude, viewState.latitude]);\n  }\n  if (viewState.zoom !== undefined) {\n    map.setZoom(viewState.zoom);\n  }\n  if (viewState.pitch !== undefined) {\n    map.setPitch(viewState.pitch);\n  }\n  if (viewState.bearing !== undefined) {\n    map.setBearing(viewState.bearing);\n  }\n}\n\n/**\n * Get current view state from map\n */\nexport function getViewState(map: mapboxgl.Map): ViewState {\n  const center = map.getCenter();\n  return {\n    longitude: center.lng,\n    latitude: center.lat,\n    zoom: map.getZoom(),\n    pitch: map.getPitch(),\n    bearing: map.getBearing()\n  };\n}\n\n","/**\n * Color palette utilities using CartoColor\n * \n * CartoColor is loaded via CDN and available on window.cartocolor\n */\n\n/**\n * Get colors from a CartoColor palette\n */\nexport function getPaletteColors(name: string, steps: number): string[] | null {\n  const cartocolor = window.cartocolor;\n  if (!cartocolor) return null;\n  \n  const pal = cartocolor[name];\n  if (!pal) return null;\n  \n  // Find the best matching step count\n  const keys = Object.keys(pal)\n    .map(Number)\n    .filter(n => !isNaN(n))\n    .sort((a, b) => a - b);\n  \n  const best = keys.find(n => n >= steps) || keys[keys.length - 1];\n  return pal[best] ? [...pal[best]] : null;\n}\n\n/**\n * Convert RGB array to CSS rgba string\n */\nexport function toRgba(arr: number[] | unknown, defaultAlpha?: number): string | null {\n  if (!Array.isArray(arr) || arr.length < 3) return null;\n  const [r, g, b] = arr as number[];\n  const a = arr.length >= 4 ? (arr[3] as number) / 255 : (defaultAlpha ?? 1);\n  return `rgba(${r},${g},${b},${a})`;\n}\n\n/**\n * Default fallback colors\n */\nexport const FALLBACK_CONTINUOUS_COLORS = [\n  '#e0f3db', '#ccebc5', '#a8ddb5', '#7bccc4', \n  '#4eb3d3', '#2b8cbe', '#0868ac', '#084081'\n];\n\nexport const FALLBACK_CATEGORICAL_COLORS = [\n  '#7F3C8D', '#11A579', '#3969AC', '#F2B701', '#E73F74',\n  '#80BA5A', '#E68310', '#008695', '#CF1C90', '#f97b72'\n];\n\n/**\n * Known CartoColor palettes\n */\nexport const KNOWN_PALETTES = new Set([\n  'ArmyRose', 'Antique', 'BluGrn', 'BluYl', 'Bold', 'BrwnYl', 'Burg', 'BurgYl',\n  'DarkMint', 'Earth', 'Emrld', 'Fall', 'Geyser', 'Magenta', 'Mint', 'OrYel',\n  'Pastel', 'Peach', 'PinkYl', 'Prism', 'Purp', 'PurpOr', 'RedOr', 'Safe',\n  'Sunset', 'SunsetDark', 'Teal', 'TealGrn', 'TealRose', 'Temps', 'Tropic',\n  'Vivid', 'ag_GrnYl', 'ag_Sunset', 'cb_Accent', 'cb_Blues', 'cb_BrBG',\n  'cb_BuGn', 'cb_BuPu', 'cb_Dark2', 'cb_GnBu', 'cb_Greens', 'cb_Greys',\n  'cb_OrRd', 'cb_Oranges', 'cb_PRGn', 'cb_Paired', 'cb_Pastel1', 'cb_Pastel2',\n  'cb_PiYG', 'cb_PuBu', 'cb_PuBuGn', 'cb_PuOr', 'cb_PuRd', 'cb_Purples',\n  'cb_RdBu', 'cb_RdGy', 'cb_RdPu', 'cb_RdYlBu', 'cb_RdYlGn', 'cb_Reds',\n  'cb_Set1', 'cb_Set2', 'cb_Set3', 'cb_Spectral', 'cb_YlGn', 'cb_YlGnBu',\n  'cb_YlOrBr', 'cb_YlOrRd'\n]);\n\n","/**\n * Build Mapbox GL style expressions from color configurations\n */\n\nimport type { ColorConfig, ColorContinuousConfig, ColorCategoriesConfig } from '../types';\nimport { getPaletteColors, FALLBACK_CONTINUOUS_COLORS, FALLBACK_CATEGORICAL_COLORS } from './palettes';\n\ninterface CategoryPair {\n  value: string | number;\n  label: string;\n}\n\n/**\n * Extract unique categories from data for an attribute\n */\nexport function getUniqueCategories(\n  data: Array<Record<string, unknown>> | undefined,\n  attr: string,\n  labelAttr?: string\n): CategoryPair[] {\n  const seen = new Map<string | number, string>();\n  \n  (data || []).forEach(d => {\n    const val = d?.[attr] ?? (d as any)?.properties?.[attr];\n    if (val != null && val !== '' && val !== 'null') {\n      if (!seen.has(val as string | number)) {\n        const label = labelAttr \n          ? (d?.[labelAttr] ?? (d as any)?.properties?.[labelAttr] ?? val) as string\n          : val as string;\n        seen.set(val as string | number, String(label));\n      }\n    }\n  });\n  \n  // Sort by value\n  const sorted = [...seen.entries()].sort((a, b) => {\n    if (typeof a[0] === 'number' && typeof b[0] === 'number') return a[0] - b[0];\n    return String(a[0]).localeCompare(String(b[0]));\n  });\n  \n  return sorted.map(([value, label]) => ({ value, label }));\n}\n\n/**\n * Build a Mapbox GL color expression from a color config\n */\nexport function buildColorExpr(\n  cfg: ColorConfig | undefined,\n  data?: Array<Record<string, unknown>>\n): unknown | null {\n  if (!cfg) return null;\n  \n  // Handle static RGB array\n  if (Array.isArray(cfg)) {\n    return null; // Will use toRgba elsewhere\n  }\n  \n  // Handle string color\n  if (typeof cfg === 'string') {\n    return cfg;\n  }\n  \n  // Handle color functions\n  const fnType = (cfg as any)['@@function'];\n  const attr = (cfg as any).attr;\n  \n  if (!fnType || !attr) return null;\n  \n  // Handle colorCategories\n  if (fnType === 'colorCategories') {\n    return buildCategoricalExpr(cfg as ColorCategoriesConfig, data);\n  }\n  \n  // Handle colorContinuous\n  if (fnType === 'colorContinuous') {\n    return buildContinuousExpr(cfg as ColorContinuousConfig);\n  }\n  \n  return null;\n}\n\n/**\n * Build a categorical color expression\n */\nfunction buildCategoricalExpr(\n  cfg: ColorCategoriesConfig,\n  data?: Array<Record<string, unknown>>\n): unknown {\n  // Get categories - either from config or auto-detect from data\n  const domainCats: any[] = Array.isArray((cfg as any).domain) ? (cfg as any).domain : [];\n  let catPairs: CategoryPair[] = cfg.categories\n    ? cfg.categories.map(c =>\n        typeof c === 'object' ? c : { value: c, label: String(c) }\n      )\n    : domainCats.length\n      ? domainCats.map((c) => ({ value: c as any, label: String((c as any)?.label ?? c) }))\n      : getUniqueCategories(data, cfg.attr, cfg.labelAttr);\n  \n  if (!catPairs.length) return 'rgba(128,128,128,0.5)';\n  \n  // Get palette colors\n  const paletteName = cfg.colors || 'Bold';\n  let colors = getPaletteColors(paletteName, Math.max(catPairs.length, 3));\n  if (!colors || !colors.length) {\n    colors = FALLBACK_CATEGORICAL_COLORS;\n  }\n  \n  // Fallback color for null values\n  const fallback = cfg.nullColor \n    ? `rgb(${cfg.nullColor.slice(0, 3).join(',')})` \n    : 'rgba(128,128,128,0.5)';\n  \n  // Build match expression: ['match', ['get', attr], val1, color1, val2, color2, ..., fallback]\n  const expr: unknown[] = ['match', ['get', cfg.attr]];\n  catPairs.forEach((cat, i) => {\n    expr.push(cat.value);\n    expr.push(colors![i % colors!.length]);\n  });\n  expr.push(fallback);\n  \n  // Store detected categories for legend\n  (cfg as any)._detectedCategories = catPairs;\n  \n  return expr;\n}\n\n/**\n * Build a continuous color expression (interpolate)\n */\nfunction buildContinuousExpr(cfg: ColorContinuousConfig): unknown {\n  if (!cfg.domain?.length) return null;\n  \n  const [d0, d1] = cfg.domain;\n  const isReversed = d0 > d1;\n  const domain = isReversed ? [d1, d0] : [d0, d1];\n  const wantsReverse = !!(cfg as any).reverse;\n  \n  const steps = cfg.steps || 7;\n  const paletteName = cfg.colors || 'TealGrn';\n  \n  let colors = getPaletteColors(paletteName, steps);\n  if (!colors || !colors.length) {\n    // Fallback gradient\n    return [\n      'interpolate', ['linear'], ['get', cfg.attr],\n      domain[0], 'rgb(237,248,251)',\n      domain[1], 'rgb(0,109,44)'\n    ];\n  }\n  \n  // `reverse` flips palette direction (lowâ†”high). If the domain itself is reversed,\n  // we already normalize it, so we invert the meaning of `reverse`.\n  const shouldReverse = isReversed ? !wantsReverse : wantsReverse;\n  if (shouldReverse) colors = [...colors].reverse();\n  \n  // Build interpolate expression\n  const expr: unknown[] = ['interpolate', ['linear'], ['get', cfg.attr]];\n  colors.forEach((c, i) => {\n    const value = domain[0] + (domain[1] - domain[0]) * i / (colors!.length - 1);\n    expr.push(value);\n    expr.push(c);\n  });\n  \n  return expr;\n}\n\n/**\n * Check if a color config uses a dynamic function\n */\nexport function isDynamicColorConfig(cfg: ColorConfig | undefined): boolean {\n  if (!cfg || typeof cfg !== 'object' || Array.isArray(cfg)) return false;\n  const fn = (cfg as any)['@@function'];\n  return fn === 'colorContinuous' || fn === 'colorCategories';\n}\n\n","/**\n * H3 Hexagon layer rendering\n * \n * Supports both static data (converted to GeoJSON) and tile-based loading via Deck.gl\n */\n\nimport type { HexLayerConfig, FusedMapsConfig } from '../types';\nimport { buildColorExpr } from '../color/expressions';\nimport { toRgba } from '../color/palettes';\n\n/**\n * Convert H3 hex ID to canonical string format\n */\nexport function toH3(hex: unknown): string | null {\n  if (hex == null) return null;\n  \n  try {\n    if (typeof hex === 'string') {\n      const s = hex.startsWith('0x') ? hex.slice(2) : hex;\n      // If it's all digits, convert from BigInt\n      if (/^\\d+$/.test(s)) {\n        return BigInt(s).toString(16);\n      }\n      // Check if it contains hex letters\n      return /[a-f]/i.test(s) ? s.toLowerCase() : s.toLowerCase();\n    }\n    \n    if (typeof hex === 'number') {\n      return BigInt(Math.trunc(hex)).toString(16);\n    }\n    \n    if (typeof hex === 'bigint') {\n      return hex.toString(16);\n    }\n  } catch (e) {\n    // Ignore conversion errors\n  }\n  \n  return null;\n}\n\n/**\n * Convert H3 hex data array to GeoJSON FeatureCollection\n */\nexport function hexToGeoJSON(data: Array<Record<string, unknown>>): GeoJSON.FeatureCollection {\n  const features: GeoJSON.Feature[] = [];\n  \n  for (const d of data) {\n    const hexId = toH3(d.hex ?? d.h3 ?? d.index ?? d.id);\n    if (!hexId || !window.h3?.isValidCell(hexId)) continue;\n    \n    try {\n      const boundary = window.h3.cellToBoundary(hexId);\n      const coords = boundary.map(([lat, lng]) => [lng, lat]);\n      coords.push(coords[0]); // Close the polygon\n      \n      features.push({\n        type: 'Feature',\n        properties: { ...d, hex: hexId },\n        geometry: {\n          type: 'Polygon',\n          coordinates: [coords]\n        }\n      });\n    } catch (e) {\n      // Skip invalid hexagons\n    }\n  }\n  \n  return { type: 'FeatureCollection', features };\n}\n\n/**\n * Add a static hex layer to the map (using Mapbox GL)\n */\nexport function addStaticHexLayer(\n  map: mapboxgl.Map,\n  layer: HexLayerConfig,\n  geojson: GeoJSON.FeatureCollection,\n  visible: boolean\n): void {\n  const cfg = layer.hexLayer || {};\n  const data = layer.data || [];\n  \n  // Add or update source (debug panel may call this repeatedly)\n  try {\n    const src: any = map.getSource(layer.id) as any;\n    if (src && typeof src.setData === 'function') {\n      src.setData(geojson);\n    } else if (!src) {\n      map.addSource(layer.id, { type: 'geojson', data: geojson });\n    }\n  } catch (_) {\n    // If we can't access the source (style not ready / race), we still try to proceed.\n    // Mapbox will throw again on addLayer if source truly doesn't exist, but this avoids\n    // the common \"Source already exists\" crash on debug edits.\n  }\n  \n  // Build fill color expression\n  const fillColor = Array.isArray(cfg.getFillColor)\n    ? toRgba(cfg.getFillColor, 0.8)\n    : buildColorExpr(cfg.getFillColor, data) || 'rgba(0,144,255,0.7)';\n  \n  // Build line color expression\n  const lineColor = cfg.getLineColor\n    ? (Array.isArray(cfg.getLineColor) \n        ? toRgba(cfg.getLineColor, 1) \n        : buildColorExpr(cfg.getLineColor, data))\n    : 'rgba(255,255,255,0.3)';\n  \n  // Layer opacity\n  const layerOpacity = (typeof cfg.opacity === 'number' && isFinite(cfg.opacity))\n    ? Math.max(0, Math.min(1, cfg.opacity))\n    : 0.8;\n  \n  // Handle extruded (3D) vs flat rendering\n  if (cfg.extruded) {\n    const elevScale = cfg.elevationScale || 1;\n    const elevProp =\n      (cfg as any).elevationProperty ||\n      (cfg.getFillColor as any)?.attr ||\n      null;\n    map.addLayer({\n      id: `${layer.id}-extrusion`,\n      type: 'fill-extrusion',\n      source: layer.id,\n      paint: {\n        'fill-extrusion-color': fillColor,\n        'fill-extrusion-height': elevProp\n          ? ['*', ['to-number', ['get', elevProp], 0], elevScale]\n          : 100,\n        'fill-extrusion-base': 0,\n        'fill-extrusion-opacity': layerOpacity\n      },\n      layout: { visibility: visible ? 'visible' : 'none' }\n    });\n  } else {\n    // Flat fill layer\n    if (cfg.filled !== false) {\n      map.addLayer({\n        id: `${layer.id}-fill`,\n        type: 'fill',\n        source: layer.id,\n        paint: {\n          'fill-color': fillColor,\n          'fill-opacity': layerOpacity\n        },\n        layout: { visibility: visible ? 'visible' : 'none' }\n      });\n    }\n  }\n  \n  // Outline layer (honor stroked flag)\n  if (cfg.stroked !== false) {\n    map.addLayer({\n      id: `${layer.id}-outline`,\n      type: 'line',\n      source: layer.id,\n      paint: {\n        'line-color': lineColor,\n        'line-width': cfg.lineWidthMinPixels || 0.5\n      },\n      layout: { visibility: visible ? 'visible' : 'none' }\n    });\n  }\n}\n\n/**\n * Toggle visibility of hex layer\n */\nexport function setHexLayerVisibility(\n  map: mapboxgl.Map,\n  layerId: string,\n  visible: boolean,\n  isExtruded: boolean\n): void {\n  const layerIds = isExtruded\n    ? [`${layerId}-extrusion`, `${layerId}-outline`]\n    : [`${layerId}-fill`, `${layerId}-outline`];\n  \n  layerIds.forEach(id => {\n    try {\n      if (map.getLayer(id)) {\n        map.setLayoutProperty(id, 'visibility', visible ? 'visible' : 'none');\n      }\n    } catch (e) {\n      // Ignore errors\n    }\n  });\n}\n\nfunction removeStaticHexSublayers(map: mapboxgl.Map, layerId: string): void {\n  const ids = [`${layerId}-fill`, `${layerId}-extrusion`, `${layerId}-outline`];\n  for (const id of ids) {\n    try {\n      if (map.getLayer(id)) map.removeLayer(id);\n    } catch (_) {}\n  }\n}\n\n/**\n * Re-apply a static hex layer's structure + style (Mapbox GL).\n * This is used by the debug panel (filled/stroked/extruded toggles, color changes).\n */\nexport function updateStaticHexLayer(\n  map: mapboxgl.Map,\n  layer: HexLayerConfig,\n  geojson: GeoJSON.FeatureCollection,\n  visible: boolean\n): void {\n  // Ensure source exists and data is current\n  try {\n    const src: any = map.getSource(layer.id) as any;\n    if (src && typeof src.setData === 'function') {\n      src.setData(geojson);\n    } else {\n      map.addSource(layer.id, { type: 'geojson', data: geojson });\n    }\n  } catch (_) {\n    // If addSource fails due to race, we still try to proceed with layer rebuild.\n  }\n\n  // Rebuild sublayers so structural toggles (extruded/filled/stroked) take effect\n  removeStaticHexSublayers(map, layer.id);\n  addStaticHexLayer(map, layer, geojson, visible);\n}\n\n","/**\n * Vector layer rendering (GeoJSON and MVT)\n */\n\nimport type { VectorLayerConfig, MVTLayerConfig } from '../types';\nimport { buildColorExpr } from '../color/expressions';\nimport { toRgba } from '../color/palettes';\n\n/**\n * Add a GeoJSON vector layer to the map\n */\nexport function addVectorLayer(\n  map: mapboxgl.Map,\n  layer: VectorLayerConfig,\n  visible: boolean\n): void {\n  const geojson = layer.geojson;\n  if (!geojson?.features?.length) return;\n  \n  // Add source\n  map.addSource(layer.id, { type: 'geojson', data: geojson });\n  \n  // Extract layer properties\n  const vecData = geojson.features.map(f => f.properties || {});\n  \n  // Build color expressions\n  const fillColorExpr = (layer.fillColorConfig as any)?.['@@function']\n    ? buildColorExpr(layer.fillColorConfig, vecData)\n    : (layer.fillColorRgba || 'rgba(0,144,255,0.6)');\n  \n  const lineColorExpr = (layer.lineColorConfig as any)?.['@@function']\n    ? buildColorExpr(layer.lineColorConfig, vecData)\n    : (layer.lineColorRgba || 'rgba(100,100,100,0.8)');\n  \n  const lineW = (typeof layer.lineWidth === 'number' && isFinite(layer.lineWidth))\n    ? layer.lineWidth\n    : 1;\n  \n  const layerOpacity = (typeof layer.opacity === 'number' && isFinite(layer.opacity))\n    ? Math.max(0, Math.min(1, layer.opacity))\n    : 0.8;\n  \n  // Detect geometry types\n  let hasPoly = false, hasPoint = false, hasLine = false;\n  for (const f of geojson.features) {\n    const t = f.geometry?.type;\n    if (t === 'Point' || t === 'MultiPoint') hasPoint = true;\n    if (t === 'Polygon' || t === 'MultiPolygon') hasPoly = true;\n    if (t === 'LineString' || t === 'MultiLineString') hasLine = true;\n  }\n  \n  // Add polygon layers\n  if (hasPoly) {\n    if (layer.isFilled !== false) {\n      map.addLayer({\n        id: `${layer.id}-fill`,\n        type: 'fill',\n        source: layer.id,\n        paint: {\n          'fill-color': fillColorExpr as any,\n          'fill-opacity': layerOpacity\n        },\n        filter: ['any', ['==', ['geometry-type'], 'Polygon'], ['==', ['geometry-type'], 'MultiPolygon']],\n        layout: { visibility: visible ? 'visible' : 'none' }\n      });\n    }\n    \n    if (layer.isStroked !== false) {\n      map.addLayer({\n        id: `${layer.id}-outline`,\n        type: 'line',\n        source: layer.id,\n        layout: {\n          'line-join': 'round',\n          'line-cap': 'round',\n          visibility: visible ? 'visible' : 'none'\n        },\n        paint: {\n          'line-color': lineColorExpr as any,\n          'line-width': lineW\n        },\n        filter: ['any', ['==', ['geometry-type'], 'Polygon'], ['==', ['geometry-type'], 'MultiPolygon']]\n      });\n    }\n  }\n  \n  // Add line layers\n  if (hasLine) {\n    map.addLayer({\n      id: `${layer.id}-line`,\n      type: 'line',\n      source: layer.id,\n      layout: {\n        'line-join': 'round',\n        'line-cap': 'round',\n        visibility: visible ? 'visible' : 'none'\n      },\n      paint: {\n        'line-color': lineColorExpr as any,\n        'line-width': lineW,\n        'line-opacity': 1\n      },\n      filter: ['any', ['==', ['geometry-type'], 'LineString'], ['==', ['geometry-type'], 'MultiLineString']]\n    });\n  }\n  \n  // Add point layers\n  if (hasPoint) {\n    map.addLayer({\n      id: `${layer.id}-circle`,\n      type: 'circle',\n      source: layer.id,\n      paint: {\n        'circle-radius': layer.pointRadius || 6,\n        'circle-color': fillColorExpr as any,\n        'circle-stroke-color': 'rgba(0,0,0,0.5)',\n        'circle-stroke-width': 1,\n        'circle-opacity': 0.9\n      },\n      filter: ['any', ['==', ['geometry-type'], 'Point'], ['==', ['geometry-type'], 'MultiPoint']],\n      layout: { visibility: visible ? 'visible' : 'none' }\n    });\n  }\n}\n\n/**\n * Add an MVT vector tile layer to the map\n */\nexport function addMVTLayer(\n  map: mapboxgl.Map,\n  layer: MVTLayerConfig,\n  visible: boolean\n): void {\n  const sourceLayer = layer.sourceLayer || 'udf';\n  \n  // Add vector tile source\n  map.addSource(layer.id, {\n    type: 'vector',\n    tiles: [layer.tileUrl],\n    minzoom: layer.minzoom || 0,\n    maxzoom: layer.maxzoom || 22\n  });\n  \n  // Dynamic color expressions are supported for MVT since Mapbox evaluates them per-feature.\n  const fillColorExpr = (layer.fillColorConfig as any)?.['@@function']\n    ? (buildColorExpr(layer.fillColorConfig as any, undefined) as any)\n    : (layer.fillColor || '#FFF5CC');\n  const lineColorExpr = (layer.lineColorConfig as any)?.['@@function']\n    ? (buildColorExpr(layer.lineColorConfig as any, undefined) as any)\n    : (layer.lineColor || '#FFFFFF');\n\n  const fillOpacity = layer.fillOpacity ?? 0.8;\n  const lineWidth = layer.lineWidth ?? 1;\n  \n  // Fill layer\n  if (layer.isFilled !== false) {\n    map.addLayer({\n      id: `${layer.id}-fill`,\n      type: 'fill',\n      source: layer.id,\n      'source-layer': sourceLayer,\n      paint: {\n        'fill-color': fillColorExpr as any,\n        'fill-opacity': fillOpacity\n      },\n      layout: { visibility: visible ? 'visible' : 'none' }\n    });\n  }\n  \n  // Line layer\n  map.addLayer({\n    id: `${layer.id}-line`,\n    type: 'line',\n    source: layer.id,\n    'source-layer': sourceLayer,\n    paint: {\n      'line-color': lineColorExpr as any,\n      'line-width': lineWidth\n    },\n    layout: { visibility: visible ? 'visible' : 'none' }\n  });\n  \n  // Extrusion layer (if enabled)\n  if (layer.isExtruded) {\n    map.addLayer({\n      id: `${layer.id}-extrusion`,\n      type: 'fill-extrusion',\n      source: layer.id,\n      'source-layer': sourceLayer,\n      paint: {\n        'fill-extrusion-color': fillColorExpr as any,\n        'fill-extrusion-height': ['*', ['get', layer.heightProperty || 'height'], layer.heightMultiplier || 1],\n        'fill-extrusion-base': 0,\n        'fill-extrusion-opacity': layer.extrusionOpacity ?? 0.9\n      },\n      layout: { visibility: visible ? 'visible' : 'none' }\n    });\n  }\n}\n\n/**\n * Toggle visibility of vector layer\n */\nexport function setVectorLayerVisibility(\n  map: mapboxgl.Map,\n  layerId: string,\n  visible: boolean\n): void {\n  const layerIds = [\n    `${layerId}-fill`,\n    `${layerId}-outline`,\n    `${layerId}-line`,\n    `${layerId}-circle`,\n    `${layerId}-extrusion`\n  ];\n  \n  layerIds.forEach(id => {\n    try {\n      if (map.getLayer(id)) {\n        map.setLayoutProperty(id, 'visibility', visible ? 'visible' : 'none');\n      }\n    } catch (e) {\n      // Ignore errors\n    }\n  });\n}\n\n\n\n\n","/**\n * Raster rendering\n *\n * Supports:\n * - Raster XYZ tiles (`tileUrl`)\n * - Static image overlay (`imageUrl` + `imageBounds`)\n */\n\nimport type { RasterLayerConfig } from '../types';\n\nfunction clamp01(x: number) {\n  return Math.max(0, Math.min(1, x));\n}\n\nfunction boundsToCoordinates(b: [number, number, number, number]) {\n  const [west, south, east, north] = b;\n  // Mapbox image source expects [[w,n],[e,n],[e,s],[w,s]]\n  return [\n    [west, north],\n    [east, north],\n    [east, south],\n    [west, south]\n  ] as [number, number][];\n}\n\n/**\n * Add a raster layer to the map\n */\nexport function addRasterLayer(\n  map: mapboxgl.Map,\n  layer: RasterLayerConfig,\n  visible: boolean\n): void {\n  const opacity = layer.opacity ?? layer.rasterLayer?.opacity ?? 1.0;\n\n  const hasTileUrl = typeof layer.tileUrl === 'string' && layer.tileUrl.length > 0;\n  const hasImage = typeof layer.imageUrl === 'string' && layer.imageUrl.length > 0\n    && Array.isArray(layer.imageBounds) && layer.imageBounds.length === 4;\n\n  if (!hasTileUrl && !hasImage) {\n    // Nothing to render\n    return;\n  }\n\n  if (hasImage) {\n    const coords = boundsToCoordinates(layer.imageBounds as any);\n    map.addSource(layer.id, {\n      type: 'image',\n      url: layer.imageUrl as string,\n      coordinates: coords as any\n    } as any);\n  } else {\n    map.addSource(layer.id, {\n      type: 'raster',\n      tiles: [layer.tileUrl as string],\n      tileSize: 256\n    });\n  }\n\n  map.addLayer({\n    id: `${layer.id}-raster`,\n    type: 'raster',\n    source: layer.id,\n    paint: { 'raster-opacity': clamp01(opacity) },\n    layout: { visibility: visible ? 'visible' : 'none' }\n  });\n}\n\n/**\n * Toggle visibility of raster layer\n */\nexport function setRasterLayerVisibility(\n  map: mapboxgl.Map,\n  layerId: string,\n  visible: boolean\n): void {\n  const id = `${layerId}-raster`;\n  try {\n    if (map.getLayer(id)) {\n      map.setLayoutProperty(id, 'visibility', visible ? 'visible' : 'none');\n    }\n  } catch (e) {\n    // Ignore errors\n  }\n}\n\n\n\n\n\n","/**\n * Hex tile layers via Deck.gl TileLayer + MapboxOverlay.\n *\n * Notes:\n * - We intentionally use globals (window.deck, window.hyparquet) to match the\n *   original map_utils.py approach and keep Rollup externals working.\n * - Required globals when tile layers are present:\n *   - window.deck (deck.gl UMD)\n *   - window.hyparquet (hyparquet ESM loaded into window)\n */\n\nimport type { HexLayerConfig, LayerConfig, TileLayerConfig } from '../types';\nimport { toH3 } from './hex';\nimport { getPaletteColors } from '../color/palettes';\n\ntype DeckGlobal = any;\n\nexport interface DeckTileOverlayState {\n  overlay: any; // deck.MapboxOverlay instance\n  rebuild: () => void;\n  pickObject: (opts: { x: number; y: number; radius?: number }) => any;\n  destroy: () => void;\n}\n\ninterface TileRuntime {\n  cache: Map<string, any[]>;\n  inflight: Map<string, Promise<any[] | null>>;\n  tilesLoading: number;\n  tileStats: Record<string, Record<string, { min: number; max: number }>>; // layerId -> \"z/x/y\" -> min/max\n  catState: Record<string, Record<string, { lut: Map<string, number[]>; pairs: Array<{ value: string; label: string }>; next: number; debounce?: any }>>; // layerId -> attr -> state\n}\n\nconst DEFAULT_MAX_REQUESTS = 10;\nconst DEFAULT_HYPARQUET_ESM_URL = 'https://cdn.jsdelivr.net/npm/hyparquet@1.23.3/+esm';\n\nlet HYPARQUET_LOAD_PROMISE: Promise<any> | null = null;\n\nasync function ensureHyparquetLoaded(): Promise<any> {\n  const w = window as any;\n  if (w.hyparquet?.parquetMetadataAsync && w.hyparquet?.parquetReadObjects) {\n    return w.hyparquet;\n  }\n  if (HYPARQUET_LOAD_PROMISE) return HYPARQUET_LOAD_PROMISE;\n\n  // Important: keep Rollup from trying to bundle/transform dynamic import in UMD.\n  const dynamicImport = (u: string) => (new Function('u', 'return import(u)') as any)(u);\n\n  HYPARQUET_LOAD_PROMISE = (async () => {\n    const mod = await dynamicImport(DEFAULT_HYPARQUET_ESM_URL);\n    // hyparquet exports vary: use module itself if functions are present, else default/named.\n    const candidate = mod?.default && (mod.default.parquetReadObjects || mod.default.parquetMetadataAsync)\n      ? mod.default\n      : mod;\n    w.hyparquet = candidate;\n    return w.hyparquet;\n  })()\n    .catch((e: any) => {\n      // allow retry on next tile\n      HYPARQUET_LOAD_PROMISE = null;\n      throw e;\n    });\n\n  return HYPARQUET_LOAD_PROMISE;\n}\n\nfunction hashString(s: string): string {\n  // Small stable hash (djb2-ish) for IDs; not crypto.\n  let h = 5381;\n  for (let i = 0; i < s.length; i++) {\n    h = ((h << 5) + h) ^ s.charCodeAt(i);\n  }\n  return (h >>> 0).toString(16);\n}\n\nfunction getDeck(): DeckGlobal | null {\n  return (window as any).deck || null;\n}\n\nfunction ensureTileLoader(): { setLoading: (delta: number) => void } {\n  let el = document.getElementById('tile-loader');\n  if (!el) {\n    el = document.createElement('div');\n    el.id = 'tile-loader';\n    el.innerHTML = `<div class=\"loader-spinner\"></div><span id=\"loader-text\">Loading tiles...</span>`;\n    document.body.appendChild(el);\n  }\n\n  const textEl = document.getElementById('loader-text');\n  let hideTimeout: any = null;\n  let tilesCurrentlyLoading = 0;\n\n  const setLoading = (delta: number) => {\n    tilesCurrentlyLoading = Math.max(0, tilesCurrentlyLoading + delta);\n    if (!el) return;\n    if (tilesCurrentlyLoading > 0) {\n      if (hideTimeout) clearTimeout(hideTimeout);\n      el.classList.add('active');\n      if (textEl) {\n        textEl.textContent =\n          tilesCurrentlyLoading === 1 ? 'Loading tile...' : `Loading ${tilesCurrentlyLoading} tiles...`;\n      }\n    } else {\n      hideTimeout = setTimeout(() => el?.classList.remove('active'), 300);\n    }\n  };\n\n  return { setLoading };\n}\n\nfunction normalizeTileData(raw: any): any[] {\n  const arr: any[] = Array.isArray(raw)\n    ? raw\n    : Array.isArray(raw?.data)\n      ? raw.data\n      : Array.isArray(raw?.features)\n        ? raw.features\n        : [];\n\n  const rows = arr.map((d: any) => (d?.properties ? { ...d.properties } : { ...d }));\n\n  return rows\n    .map((p: any) => {\n      const hexRaw = p.hex ?? p.h3 ?? p.index ?? p.id;\n      const hex = toH3(hexRaw);\n      if (!hex) return null;\n      const props = { ...p, hex };\n      return { ...props, properties: { ...props } };\n    })\n    .filter(Boolean);\n}\n\nfunction sanitizeProperties(obj: Record<string, any>): Record<string, any> {\n  // Mirrors the workbench approach: avoid BigInt leaking into Deck/tooltip.\n  const out: Record<string, any> = {};\n  for (const k of Object.keys(obj || {})) {\n    const v = (obj as any)[k];\n    if (typeof v === 'bigint') {\n      const lk = String(k).toLowerCase();\n      if (lk === 'hex' || lk === 'h3' || lk === 'index' || lk === 'id') {\n        // Likely an H3 index stored as int64\n        out[k] = v.toString(16);\n      } else if (v <= BigInt(Number.MAX_SAFE_INTEGER) && v >= BigInt(Number.MIN_SAFE_INTEGER)) {\n        out[k] = Number(v);\n      } else {\n        // Fallback: stringify to avoid breaking render/tooltip\n        out[k] = v.toString();\n      }\n    } else {\n      out[k] = v;\n    }\n  }\n  return out;\n}\n\nfunction sanitizeRows(rows: any[]): any[] {\n  return (rows || []).map((r: any) => {\n    const p = r?.properties ? sanitizeProperties(r.properties) : sanitizeProperties(r || {});\n    // Ensure both root and properties exist (Deck picks often look at object.properties)\n    return { ...p, properties: { ...p } };\n  });\n}\n\nfunction coerceKnownIdsToStrings(jsonText: string): string {\n  // IMPORTANT: H3 indexes are often > 2^53 and will lose precision if parsed as JS numbers.\n  // Coerce known id fields to strings before JSON.parse.\n  return jsonText.replace(/\\\"(hex|h3|index|id)\\\"\\s*:\\s*(\\d+)/gi, (_m, k, d) => `\"${k}\":\"${d}\"`);\n}\n\nfunction buildColorAccessor(\n  runtime: TileRuntime,\n  layer: HexLayerConfig,\n  colorCfg: any\n): ((obj: any) => any) | any[] | null {\n  if (!colorCfg) return null;\n\n  // Static color arrays\n  if (Array.isArray(colorCfg)) return colorCfg;\n\n  // Dynamic expression accessor\n  if (typeof colorCfg === 'string' && colorCfg.startsWith('@@=')) {\n    const code = colorCfg.slice(3);\n    return (object: any) => {\n      try {\n        const fn = new Function(\n          'object',\n          `const properties = object?.properties || object || {}; return (${code});`\n        );\n        const res = fn(object);\n        return res;\n      } catch {\n        return null;\n      }\n    };\n  }\n\n  // colorContinuous / colorCategories\n  if (typeof colorCfg === 'object' && colorCfg['@@function']) {\n    const fnType = colorCfg['@@function'];\n    const attr = colorCfg.attr;\n    if (!attr) return null;\n\n    if (fnType === 'colorContinuous') {\n      // Expect domain [min, max] (numbers). If omitted, just return null.\n      const dom = colorCfg.domain;\n      if (!Array.isArray(dom) || dom.length < 2) return null;\n      const d0 = Number(dom[0]);\n      const d1 = Number(dom[dom.length - 1]);\n      if (!Number.isFinite(d0) || !Number.isFinite(d1) || d0 === d1) return null;\n\n      const steps = Math.max(2, Number(colorCfg.steps ?? 7));\n      const paletteName = colorCfg.colors || 'ArmyRose';\n      const cols0 = getPaletteColors(paletteName, steps) || null;\n      if (!cols0?.length) return null;\n\n      const domainReversed = d0 > d1;\n      const wantsReverse = !!colorCfg.reverse;\n      const shouldReverse = domainReversed ? !wantsReverse : wantsReverse;\n      const cols = shouldReverse ? [...cols0].reverse() : [...cols0];\n\n      const minV = Math.min(d0, d1);\n      const maxV = Math.max(d0, d1);\n      const nullColor = Array.isArray(colorCfg.nullColor) ? colorCfg.nullColor : [184, 184, 184];\n\n      return (obj: any) => {\n        const p = obj?.properties || obj || {};\n        const raw = p[attr];\n        let v: number | null = null;\n        if (typeof raw === 'number') v = raw;\n        else if (typeof raw === 'string') {\n          const n = parseFloat(raw);\n          v = Number.isFinite(n) ? n : null;\n        }\n        if (v == null || !Number.isFinite(v)) return nullColor;\n\n        const t = (v - minV) / (maxV - minV);\n        const idx = Math.max(0, Math.min(cols.length - 1, Math.round(t * (cols.length - 1))));\n        // Convert \"#rrggbb\" to [r,g,b]\n        const hex = cols[idx].replace('#', '');\n        const r = parseInt(hex.slice(0, 2), 16);\n        const g = parseInt(hex.slice(2, 4), 16);\n        const b = parseInt(hex.slice(4, 6), 16);\n        return [r, g, b];\n      };\n    }\n\n    if (fnType === 'colorCategories') {\n      const categories: any[] = Array.isArray(colorCfg.categories)\n        ? colorCfg.categories\n        : Array.isArray(colorCfg.domain)\n          ? colorCfg.domain\n          : [];\n\n      const paletteName = colorCfg.colors || 'Bold';\n      const nullColor = Array.isArray(colorCfg.nullColor) ? colorCfg.nullColor : [184, 184, 184];\n\n      // If categories are provided, use a fixed lookup.\n      if (categories.length) {\n        const cols0 = getPaletteColors(paletteName, Math.max(categories.length, 3)) || null;\n        const lut = new Map<string, any[]>();\n        if (cols0?.length) {\n          categories.forEach((c, i) => {\n            const col = cols0[i % cols0.length] || '#999999';\n            const hex = String(col).replace('#', '');\n            const r = parseInt(hex.slice(0, 2), 16);\n            const g = parseInt(hex.slice(2, 4), 16);\n            const b = parseInt(hex.slice(4, 6), 16);\n            lut.set(String((c as any)?.value ?? c), [r, g, b]);\n          });\n        }\n        // Also expose for legend if user passed objects\n        try {\n          (colorCfg as any)._detectedCategories = categories.map((c: any) =>\n            typeof c === 'object' ? { value: c.value, label: String(c.label ?? c.value) } : { value: c, label: String(c) }\n          );\n        } catch (_) {}\n\n        return (obj: any) => {\n          const p = obj?.properties || obj || {};\n          const v = p[attr];\n          if (v == null) return nullColor;\n          const hit = lut.get(String(v));\n          return hit || nullColor;\n        };\n      }\n\n      // No categories provided: progressively discover categories from loaded tiles.\n      const layerId = layer.id;\n      runtime.catState[layerId] = runtime.catState[layerId] || {};\n      const st = runtime.catState[layerId][attr] || { lut: new Map(), pairs: [], next: 0 };\n      runtime.catState[layerId][attr] = st;\n\n      // Use a reasonable palette size for discovery.\n      const cols0 = getPaletteColors(paletteName, 12) || null;\n      const cols = cols0?.length ? cols0 : ['#7fc97f', '#beaed4', '#fdc086', '#ffff99', '#386cb0', '#f0027f', '#bf5b17', '#666666'];\n\n      const scheduleLegendUpdate = () => {\n        try {\n          if (st.debounce) return;\n          st.debounce = setTimeout(() => {\n            st.debounce = null;\n            try { window.dispatchEvent(new CustomEvent('fusedmaps:legend:update')); } catch (_) {}\n          }, 150);\n        } catch (_) {}\n      };\n\n      return (obj: any) => {\n        const p = obj?.properties || obj || {};\n        const v = p[attr];\n        if (v == null || v === '' || v === 'null') return nullColor;\n        const key = String(v);\n        let hit = st.lut.get(key);\n        if (!hit) {\n          const col = cols[st.next % cols.length] || '#999999';\n          st.next += 1;\n          const hex = String(col).replace('#', '');\n          const r = parseInt(hex.slice(0, 2), 16);\n          const g = parseInt(hex.slice(2, 4), 16);\n          const b = parseInt(hex.slice(4, 6), 16);\n          hit = [r, g, b];\n          st.lut.set(key, hit);\n          // cap legend categories for sanity\n          if (st.pairs.length < 50) st.pairs.push({ value: key, label: key });\n          try { (colorCfg as any)._detectedCategories = st.pairs; } catch (_) {}\n          scheduleLegendUpdate();\n        }\n        return hit || nullColor;\n      };\n    }\n  }\n\n  return null;\n}\n\nfunction createTileRuntime(): TileRuntime {\n  return {\n    cache: new Map(),\n    inflight: new Map(),\n    tilesLoading: 0,\n    tileStats: {},\n    catState: {}\n  };\n}\n\n// --- AutoDomain (Parquet stats-only) ---\nconst AUTO_DOMAIN_MIN_ZOOM = 10;\nconst AUTO_DOMAIN_ZOOM_TOLERANCE = 1;\nconst AUTO_DOMAIN_REBUILD_REL_TOL = 0.05;\n\nfunction tileToBounds(x: number, y: number, z: number) {\n  const n = Math.PI - (2 * Math.PI * y) / Math.pow(2, z);\n  const west = (x / Math.pow(2, z)) * 360 - 180;\n  const north = (180 / Math.PI) * Math.atan(Math.sinh(n));\n\n  const n2 = Math.PI - (2 * Math.PI * (y + 1)) / Math.pow(2, z);\n  const east = ((x + 1) / Math.pow(2, z)) * 360 - 180;\n  const south = (180 / Math.PI) * Math.atan(Math.sinh(n2));\n\n  return { west, south, east, north };\n}\n\nfunction boundsIntersect(a: any, b: any) {\n  return !(a.east < b.west || a.west > b.east || a.north < b.south || a.south > b.north);\n}\n\nfunction wantsAutoDomain(layer: HexLayerConfig): { enabled: boolean; attr: string | null } {\n  const fc: any = (layer.hexLayer as any)?.getFillColor;\n  if (!fc || typeof fc !== 'object' || Array.isArray(fc)) return { enabled: false, attr: null };\n  if (fc['@@function'] !== 'colorContinuous') return { enabled: false, attr: null };\n  const attr = fc.attr || null;\n  if (!attr) return { enabled: false, attr: null };\n  // If the user explicitly set a domain (e.g. via debug UI), never override it.\n  if ((layer as any).fillDomainFromUser === true || (fc as any).fillDomainFromUser === true) {\n    return { enabled: false, attr };\n  }\n  const hasDomain = Array.isArray(fc.domain) && fc.domain.length >= 2;\n  const enabled = fc.autoDomain === true || !hasDomain;\n  return { enabled, attr };\n}\n\nfunction parseMaybeNumber(v: any): number | null {\n  if (v == null) return null;\n  if (typeof v === 'number') return Number.isFinite(v) ? v : null;\n  if (typeof v === 'bigint') {\n    const n = Number(v);\n    return Number.isFinite(n) ? n : null;\n  }\n  if (typeof v === 'string') {\n    const n = parseFloat(v);\n    return Number.isFinite(n) ? n : null;\n  }\n  return null;\n}\n\nfunction extractParquetMinMaxFromMetadata(metadata: any, columnName: string): { min: number; max: number } | null {\n  // Hyparquet metadata shape varies across builds; be defensive:\n  const rowGroups = metadata?.row_groups || metadata?.rowGroups || metadata?.row_groups_list || null;\n  if (!Array.isArray(rowGroups) || rowGroups.length === 0) return null;\n\n  let minAll = Number.POSITIVE_INFINITY;\n  let maxAll = Number.NEGATIVE_INFINITY;\n  let found = false;\n\n  for (const rg of rowGroups) {\n    const cols = rg?.columns || rg?.columns_list || null;\n    if (!Array.isArray(cols)) continue;\n\n    for (const c of cols) {\n      const md = c?.meta_data || c?.metaData || c?.metadata || null;\n      const path = md?.path_in_schema || md?.pathInSchema || md?.path || null;\n      const leaf = Array.isArray(path) ? String(path[path.length - 1]) : (typeof path === 'string' ? path : null);\n      if (!leaf || leaf !== columnName) continue;\n\n      const stats = md?.statistics || md?.stats || c?.statistics || null;\n      if (!stats) continue;\n\n      const mn = parseMaybeNumber(stats.min_value ?? stats.min ?? stats.minimum ?? stats.minValue);\n      const mx = parseMaybeNumber(stats.max_value ?? stats.max ?? stats.maximum ?? stats.maxValue);\n      if (mn == null || mx == null) continue;\n\n      found = true;\n      if (mn < minAll) minAll = mn;\n      if (mx > maxAll) maxAll = mx;\n    }\n  }\n\n  if (!found || !Number.isFinite(minAll) || !Number.isFinite(maxAll)) return null;\n  if (minAll === maxAll) return { min: minAll - 1, max: maxAll + 1 };\n  return { min: minAll, max: maxAll };\n}\n\nfunction calculateDomainFromTileStats(\n  map: mapboxgl.Map,\n  runtime: TileRuntime,\n  layer: HexLayerConfig,\n  expectedZ: number\n): [number, number] | null {\n  if (map.getZoom() < AUTO_DOMAIN_MIN_ZOOM) return null;\n\n  const store = runtime.tileStats[layer.id];\n  if (!store) return null;\n\n  const b = map.getBounds();\n  const viewportBounds = {\n    west: b.getWest(),\n    east: b.getEast(),\n    south: b.getSouth(),\n    north: b.getNorth()\n  };\n\n  let minAll = Number.POSITIVE_INFINITY;\n  let maxAll = Number.NEGATIVE_INFINITY;\n  let count = 0;\n\n  for (const [tileKey, st] of Object.entries(store)) {\n    const [z, x, y] = tileKey.split('/').map(Number);\n    if (!Number.isFinite(z) || !Number.isFinite(x) || !Number.isFinite(y)) continue;\n    if (Math.abs(z - expectedZ) > AUTO_DOMAIN_ZOOM_TOLERANCE) continue;\n    const tb = tileToBounds(x, y, z);\n    if (!boundsIntersect(tb, viewportBounds)) continue;\n\n    if (Number.isFinite(st.min)) {\n      minAll = Math.min(minAll, st.min);\n      count++;\n    }\n    if (Number.isFinite(st.max)) {\n      maxAll = Math.max(maxAll, st.max);\n    }\n  }\n\n  if (count < 2 || !Number.isFinite(minAll) || !Number.isFinite(maxAll)) return null;\n\n  // 1% padding\n  const span = maxAll - minAll;\n  if (Number.isFinite(span) && span > 0) {\n    const pad = span * 0.01;\n    minAll -= pad;\n    maxAll += pad;\n  }\n  if (minAll >= maxAll) return [minAll - 1, maxAll + 1];\n  return [minAll, maxAll];\n}\n\nfunction calculateDomainFromTiles(\n  map: mapboxgl.Map,\n  runtime: TileRuntime,\n  layer: HexLayerConfig,\n  _attr: string,\n  expectedZ: number\n): [number, number] | null {\n  // Stats-only (Parquet). If stats aren't there, we intentionally don't update.\n  return calculateDomainFromTileStats(map, runtime, layer, expectedZ);\n}\n\nfunction maybeUpdateDynamicDomain(layer: HexLayerConfig, next: [number, number]): boolean {\n  const fc: any = (layer.hexLayer as any)?.getFillColor;\n  if (!fc || typeof fc !== 'object') return false;\n  const old: any = fc._dynamicDomain;\n\n  const changedEnough = !Array.isArray(old) || old.length < 2\n    ? true\n    : (() => {\n        const denom = (old[1] - old[0]) ? (old[1] - old[0]) : 1;\n        return (\n          Math.abs(next[0] - old[0]) / denom > AUTO_DOMAIN_REBUILD_REL_TOL ||\n          Math.abs(next[1] - old[1]) / denom > AUTO_DOMAIN_REBUILD_REL_TOL\n        );\n      })();\n\n  if (!changedEnough) return false;\n  fc._dynamicDomain = next;\n  return true;\n}\n\nfunction getTileConfig(\n  layer: HexLayerConfig\n): Required<TileLayerConfig> & { maxRequests: number; zoomOffset: number; refinementStrategy: string } {\n  const cfg = layer.tileLayerConfig || {};\n  return {\n    tileSize: cfg.tileSize ?? 256,\n    minZoom: cfg.minZoom ?? 0,\n    maxZoom: cfg.maxZoom ?? 19,\n    zoomOffset: (cfg as any).zoomOffset ?? 0,\n    maxRequests: (cfg as any).maxRequests ?? DEFAULT_MAX_REQUESTS,\n    refinementStrategy: (cfg as any).refinementStrategy ?? 'best-available'\n  };\n}\n\nfunction buildHexTileDeckLayers(\n  layers: LayerConfig[],\n  visibility: Record<string, boolean>,\n  runtime: TileRuntime,\n  onLoadingDelta: (delta: number) => void\n): any[] {\n  const deck = getDeck();\n  if (!deck) return [];\n\n  const TileLayer = deck.TileLayer;\n  const H3HexagonLayer = deck.H3HexagonLayer || deck?.GeoLayers?.H3HexagonLayer;\n  if (!TileLayer || !H3HexagonLayer) return [];\n\n  // IMPORTANT: Only include visible tile layers.\n  // Using `visible: false` on Deck layers can still leave stale tiles/picking artifacts in some setups.\n  // Filtering them out ensures the layer is truly removed from rendering + picking (matches map_utils.py).\n  const tileLayers = layers\n    .filter((l) => l.layerType === 'hex' && (l as any).isTileLayer && (l as any).tileUrl)\n    .map((l) => l as HexLayerConfig)\n    .filter((l) => visibility[l.id] !== false);\n\n  // Reverse to keep UI order consistent (top of menu renders on top)\n  return tileLayers\n    .slice()\n    .reverse()\n    .map((layer) => {\n      const visible = true;\n      const tileUrl = layer.tileUrl!;\n      const tileCfg = getTileConfig(layer);\n      const rawHexCfg: any = layer.hexLayer || {};\n\n      // Prefer dynamic domain (autoDomain) when present (without mutating config object)\n      const fillCfg: any = rawHexCfg.getFillColor;\n      const fillCfgEffective =\n        fillCfg && typeof fillCfg === 'object' && !Array.isArray(fillCfg) && Array.isArray(fillCfg._dynamicDomain)\n          ? { ...fillCfg, domain: fillCfg._dynamicDomain }\n          : fillCfg;\n\n      const lineCfg: any = rawHexCfg.getLineColor;\n      const lineCfgEffective =\n        lineCfg && typeof lineCfg === 'object' && !Array.isArray(lineCfg) && Array.isArray(lineCfg._dynamicDomain)\n          ? { ...lineCfg, domain: lineCfg._dynamicDomain }\n          : lineCfg;\n\n      const getFillColor = buildColorAccessor(runtime, layer, fillCfgEffective);\n      const getLineColor = buildColorAccessor(runtime, layer, lineCfgEffective);\n\n      // IMPORTANT: When autoDomain updates, we must force TileLayer + its sublayers to fully update.\n      // Otherwise, some already-loaded tiles can keep old attribute buffers and you see \"tile seams\".\n      const domKey = JSON.stringify({\n        fd: (fillCfgEffective && typeof fillCfgEffective === 'object') ? (fillCfgEffective.domain || fillCfgEffective._dynamicDomain) : null,\n        ld: (lineCfgEffective && typeof lineCfgEffective === 'object') ? (lineCfgEffective.domain || lineCfgEffective._dynamicDomain) : null\n      });\n      const styleKey = JSON.stringify({\n        f: fillCfgEffective,\n        l: lineCfgEffective,\n        stroked: rawHexCfg.stroked !== false,\n        filled: rawHexCfg.filled !== false,\n        extruded: rawHexCfg.extruded === true,\n        opacity: rawHexCfg.opacity,\n        elevationScale: rawHexCfg.elevationScale,\n        coverage: rawHexCfg.coverage,\n        lineWidthMinPixels: rawHexCfg.lineWidthMinPixels\n      });\n      const idHash = hashString(`${domKey}|${styleKey}`);\n\n      const stroked = rawHexCfg.stroked !== false;\n      const filled = rawHexCfg.filled !== false;\n      const extruded = rawHexCfg.extruded === true;\n      const opacity = typeof rawHexCfg.opacity === 'number' ? rawHexCfg.opacity : 0.8;\n      const lineWidthMinPixels = rawHexCfg.lineWidthMinPixels ?? 1;\n      const elevationScale = rawHexCfg.elevationScale ?? 1;\n      const coverage = rawHexCfg.coverage ?? 0.9;\n      const elevationProperty =\n        rawHexCfg.elevationProperty ||\n        (fillCfgEffective && typeof fillCfgEffective === 'object' ? (fillCfgEffective as any).attr : null) ||\n        null;\n\n      const auto = wantsAutoDomain(layer);\n      const refinementStrategy =\n        (tileCfg as any).refinementStrategy ||\n        (auto.enabled ? 'no-overlap' : 'best-available');\n\n      return new TileLayer({\n        id: `${layer.id}-tiles-${idHash}`,\n        data: tileUrl,\n        tileSize: tileCfg.tileSize,\n        minZoom: tileCfg.minZoom,\n        maxZoom: tileCfg.maxZoom,\n        zoomOffset: tileCfg.zoomOffset,\n        maxRequests: tileCfg.maxRequests,\n        refinementStrategy,\n        pickable: true,\n        visible,\n        getTileData: async ({ index, signal }: any) => {\n          const { x, y, z } = index;\n          const url = tileUrl.replace('{z}', z).replace('{x}', x).replace('{y}', y);\n          const cacheKey = url;\n          const tileKey = `${z}/${x}/${y}`;\n\n          if (runtime.cache.has(cacheKey)) return runtime.cache.get(cacheKey);\n          if (runtime.inflight.has(cacheKey)) {\n            try {\n              const data = await runtime.inflight.get(cacheKey);\n              // IMPORTANT: preserve null (abort) so the tileset doesn't think we loaded data.\n              return data;\n            } catch {\n              return runtime.cache.get(cacheKey) || [];\n            }\n          }\n\n          onLoadingDelta(1);\n          const p = (async () => {\n            try {\n              const res = await fetch(url, { signal });\n              if (signal?.aborted) return null;\n              if (!res.ok) throw new Error(`tile http ${res.status}`);\n\n              const ct = (res.headers.get('Content-Type') || '').toLowerCase();\n              let data: any;\n              let parquetMetadata: any = null;\n\n              // Parquet tiles\n              if (ct.includes('application/octet-stream') || ct.includes('application/parquet') || url.endsWith('.parquet')) {\n                let hp = (window as any).hyparquet;\n                if (!hp?.parquetMetadataAsync || !hp?.parquetReadObjects) {\n                  try {\n                    hp = await ensureHyparquetLoaded();\n                  } catch (e) {\n                    console.error('[tiles] failed to auto-load hyparquet', e);\n                    // IMPORTANT: don't mark tile as loaded; allow retry after hyparquet becomes available.\n                    return null;\n                  }\n                }\n                const buf = await res.arrayBuffer();\n                if (signal?.aborted) return null;\n                if (!buf || (buf as ArrayBuffer).byteLength === 0) return [];\n                const file = {\n                  byteLength: buf.byteLength,\n                  async slice(start: number, end: number) {\n                    return (buf as ArrayBuffer).slice(start, end);\n                  }\n                };\n                const metadata = await hp.parquetMetadataAsync(file);\n                parquetMetadata = metadata;\n                if (signal?.aborted) return null;\n                const rows = await hp.parquetReadObjects({ file, utf8: false, metadata });\n                data = rows;\n              } else {\n                let text = await res.text();\n                if (signal?.aborted) return null;\n                text = coerceKnownIdsToStrings(text);\n                data = JSON.parse(text);\n              }\n\n              // Normalize + sanitize\n              const normalized = sanitizeRows(normalizeTileData(data));\n              runtime.cache.set(cacheKey, normalized);\n\n              // Parquet metadata min/max (instant autoDomain)\n              try {\n                const auto = wantsAutoDomain(layer);\n                if (auto.enabled && auto.attr && parquetMetadata) {\n                  const mm = extractParquetMinMaxFromMetadata(parquetMetadata, auto.attr);\n                  if (mm) {\n                    if (!runtime.tileStats[layer.id]) runtime.tileStats[layer.id] = {};\n                    runtime.tileStats[layer.id][tileKey] = { min: mm.min, max: mm.max };\n                    // Trigger a quick autoDomain recompute (listener is in createHexTileOverlay)\n                    try { window.dispatchEvent(new CustomEvent('fusedmaps:autodomain:dirty')); } catch {}\n                  }\n                }\n              } catch (_) {}\n              return normalized;\n            } catch (e) {\n              if (signal?.aborted) return null;\n              // IMPORTANT: do NOT cache failures; return null so the tileset may retry.\n              return null;\n            } finally {\n              runtime.inflight.delete(cacheKey);\n              onLoadingDelta(-1);\n            }\n          })();\n\n          runtime.inflight.set(cacheKey, p);\n          const out = await p;\n          // Preserve null for abort/failure semantics (prevents \"holes stuck forever\")\n          return out;\n        },\n        renderSubLayers: (props: any) => {\n          const data = props.data || [];\n          // If aborted/failed, props.data can be null; return nothing so parent placeholders can show\n          if (!data || !data.length) return null;\n\n          return new H3HexagonLayer({\n            id: `${props.id}-h3`,\n            data,\n            getHexagon: (d: any) => d.hex,\n            pickable: true,\n            stroked,\n            filled,\n            extruded,\n            opacity,\n            coverage,\n            lineWidthMinPixels,\n            elevationScale,\n            ...(extruded && elevationProperty ? { getElevation: (d: any) => Number(d?.[elevationProperty] ?? 0) } : {}),\n            ...(getFillColor ? { getFillColor } : {}),\n            ...(getLineColor ? { getLineColor } : {})\n          });\n        }\n      });\n    });\n}\n\nexport function createHexTileOverlay(\n  map: mapboxgl.Map,\n  layers: LayerConfig[],\n  visibility: Record<string, boolean>\n): DeckTileOverlayState | null {\n  const deck = getDeck();\n  if (!deck?.MapboxOverlay || !deck?.TileLayer) return null;\n\n  const runtime = createTileRuntime();\n  const loader = ensureTileLoader();\n  const build = () => buildHexTileDeckLayers(layers, visibility, runtime, loader.setLoading);\n\n  const overlay = new deck.MapboxOverlay({\n    interleaved: true,\n    useDevicePixels: true,\n    layers: build()\n  });\n\n  // Attach to map\n  try {\n    map.addControl(overlay);\n  } catch {\n    // ignore\n  }\n\n  const rebuild = () => {\n    try {\n      overlay.setProps({ layers: build() });\n      try {\n        (map as any).triggerRepaint?.();\n      } catch {}\n    } catch {\n      // ignore\n    }\n  };\n\n  const pickObject = (opts: { x: number; y: number; radius?: number }) => {\n    try {\n      return overlay.pickObject(opts);\n    } catch {\n      return null;\n    }\n  };\n\n  // AutoDomain scheduler (only for layers that request it)\n  const autoLayers = layers.filter((l) => l.layerType === 'hex' && (l as any).isTileLayer) as HexLayerConfig[];\n  const autoCandidates = autoLayers\n    .map((l) => ({ layer: l, ...wantsAutoDomain(l), tileCfg: getTileConfig(l) }))\n    .filter((x) => x.enabled && x.attr);\n\n  let autoTimer: any = null;\n  const scheduleAuto = (delayMs: number) => {\n    if (!autoCandidates.length) return;\n    if (autoTimer) clearTimeout(autoTimer);\n    autoTimer = setTimeout(() => {\n      let changed = false;\n      for (const c of autoCandidates) {\n        const expectedZ = Math.round(map.getZoom()) + (c.tileCfg.zoomOffset || 0);\n        const dom = calculateDomainFromTiles(map, runtime, c.layer, c.attr!, expectedZ);\n        if (dom) {\n          const did = maybeUpdateDynamicDomain(c.layer, dom);\n          if (did) changed = true;\n        }\n      }\n      if (changed) {\n        rebuild();\n        // Ask host to refresh legend (index.ts listens)\n        try { window.dispatchEvent(new CustomEvent('fusedmaps:legend:update')); } catch {}\n      }\n    }, delayMs);\n  };\n\n  const onMoveEnd = () => scheduleAuto(800);\n  const onIdle = () => scheduleAuto(1200);\n  const onDirty = () => scheduleAuto(150);\n  if (autoCandidates.length) {\n    map.on('moveend', onMoveEnd);\n    map.on('idle', onIdle);\n    try { window.addEventListener('fusedmaps:autodomain:dirty', onDirty as any); } catch {}\n    // Initial attempt after some tiles arrive\n    scheduleAuto(1500);\n  }\n\n  const destroy = () => {\n    if (autoTimer) clearTimeout(autoTimer);\n    try { map.off('moveend', onMoveEnd); } catch {}\n    try { map.off('idle', onIdle); } catch {}\n    try { window.removeEventListener('fusedmaps:autodomain:dirty', onDirty as any); } catch {}\n    try { map.removeControl(overlay); } catch {}\n  };\n\n  return { overlay, rebuild, pickObject, destroy };\n}\n\n\n","/**\n * PMTiles support for FusedMaps\n * \n * Uses mapbox-pmtiles library with Mapbox GL JS v3's setSourceType()\n */\n\nimport type { PMTilesLayerConfig } from '../types';\n\nlet mapboxPmtilesLib: any = null;\nlet sourceTypeRegistered = false;\n\n// In-flight loaders to avoid double-loading scripts/modules\nlet mapboxPmtilesLoadPromise: Promise<any> | null = null;\n\n// Optional: minimal metadata fallback. Some PMTiles do not expose `vector_layers`\n// via mapbox-pmtiles `getHeader().json`, so we read PMTiles metadata only when needed.\nlet pmtilesLib: any = null;\nlet pmtilesLoadPromise: Promise<any> | null = null;\nconst pmtilesLayerNamesCache = new Map<string, Promise<string[]>>();\n\nfunction extractVectorLayerNamesFromHeader(header: any): string[] {\n  const json = header?.json || {};\n  const names: string[] = [];\n  // mapbox-pmtiles docs show `header.json.vector_layers`\n  if (Array.isArray(json.vector_layers)) {\n    for (const vl of json.vector_layers) {\n      if (vl?.id) names.push(String(vl.id));\n    }\n  }\n  // Sometimes tilestats exist\n  if (json?.tilestats?.layers && Array.isArray(json.tilestats.layers)) {\n    for (const tl of json.tilestats.layers) {\n      const n = tl?.layer;\n      if (n && !names.includes(String(n))) names.push(String(n));\n    }\n  }\n  return names;\n}\n\nasync function ensurePmtilesMetadataLibLoaded(): Promise<any> {\n  if (pmtilesLib) return pmtilesLib;\n  if (pmtilesLoadPromise) return pmtilesLoadPromise;\n  const dynamicImport = (u: string) => (new Function('u', 'return import(u)') as any)(u);\n  pmtilesLoadPromise = dynamicImport('https://cdn.jsdelivr.net/npm/pmtiles@3.0.6/+esm')\n    .then((m: any) => {\n      pmtilesLib = m;\n      return pmtilesLib;\n    })\n    .finally(() => {\n      pmtilesLoadPromise = null;\n    });\n  return pmtilesLoadPromise;\n}\n\nasync function getVectorLayerNamesFallback(url: string): Promise<string[]> {\n  if (pmtilesLayerNamesCache.has(url)) return pmtilesLayerNamesCache.get(url)!;\n  const p = (async () => {\n    const pmtiles = await ensurePmtilesMetadataLibLoaded();\n    const inst = new pmtiles.PMTiles(url);\n    let metadata: any = {};\n    try {\n      metadata = await inst.getMetadata();\n    } catch (_) {\n      metadata = {};\n    }\n    const names: string[] = [];\n    if (metadata?.vector_layers?.length > 0) {\n      for (const vl of metadata.vector_layers) {\n        if (vl?.id) names.push(String(vl.id));\n      }\n    }\n    if (metadata?.tilestats?.layers && Array.isArray(metadata.tilestats.layers)) {\n      for (const tl of metadata.tilestats.layers) {\n        const n = tl?.layer;\n        if (n && !names.includes(String(n))) names.push(String(n));\n      }\n    }\n    return names;\n  })();\n  pmtilesLayerNamesCache.set(url, p);\n  p.catch(() => pmtilesLayerNamesCache.delete(url));\n  return p;\n}\n\n/**\n * Lazy load the mapbox-pmtiles library for Mapbox GL JS v3\n */\nasync function ensureMapboxPMTilesLoaded(): Promise<any> {\n  if (mapboxPmtilesLib) return mapboxPmtilesLib;\n  if (mapboxPmtilesLoadPromise) return mapboxPmtilesLoadPromise;\n  \n  // Check if already loaded globally\n  if ((window as any).mapboxPmTiles) {\n    mapboxPmtilesLib = (window as any).mapboxPmTiles;\n    return mapboxPmtilesLib;\n  }\n  \n  // Load via script tag (UMD build)\n  mapboxPmtilesLoadPromise = new Promise((resolve, reject) => {\n    const script = document.createElement('script');\n    script.src = 'https://cdn.jsdelivr.net/npm/mapbox-pmtiles@1.0.54/dist/mapbox-pmtiles.umd.min.js';\n    script.onload = () => {\n      mapboxPmtilesLib = (window as any).mapboxPmTiles;\n      resolve(mapboxPmtilesLib);\n    };\n    script.onerror = () => reject(new Error('Failed to load mapbox-pmtiles library'));\n    document.head.appendChild(script);\n  }).finally(() => {\n    mapboxPmtilesLoadPromise = null;\n  });\n  return mapboxPmtilesLoadPromise;\n}\n\n/**\n * Register PMTiles source type with Mapbox GL JS v3\n */\nasync function registerPMTilesSourceType(): Promise<void> {\n  if (sourceTypeRegistered) return;\n  \n  const mapboxgl = (window as any).mapboxgl;\n  if (!mapboxgl?.Style?.setSourceType) {\n    throw new Error('Mapbox GL JS v3 with Style.setSourceType is required for PMTiles');\n  }\n  \n  const mapboxPmTiles = await ensureMapboxPMTilesLoaded();\n  mapboxgl.Style.setSourceType(mapboxPmTiles.SOURCE_TYPE, mapboxPmTiles.PmTilesSource);\n  sourceTypeRegistered = true;\n}\n\n/**\n * Resolve a palette name (e.g., \"Sunset\", \"Viridis\") to an array of hex colors\n */\nfunction resolvePalette(paletteName: string, steps: number = 7): string[] {\n  const cartocolor = (window as any).cartocolor;\n  \n  // Default fallback colors\n  const fallback = ['#440154', '#414487', '#2a788e', '#22a884', '#7ad151', '#fde725'];\n  \n  if (!cartocolor) return fallback;\n  \n  // Try to find the palette in cartocolor\n  const palette = cartocolor[paletteName];\n  if (palette) {\n    // cartocolor palettes have different step counts (3-11 typically)\n    const availableSteps = Object.keys(palette).map(Number).filter(n => !isNaN(n)).sort((a, b) => b - a);\n    const bestMatch = availableSteps.find(s => s <= steps) || availableSteps[availableSteps.length - 1];\n    return palette[bestMatch] || fallback;\n  }\n  \n  return fallback;\n}\n\n/**\n * Build a Mapbox GL color expression from a color config\n */\nexport function buildPMTilesColorExpression(\n  colorConfig: any,\n  attribute: string,\n  defaultColor: string = '#ff8c00'\n): any {\n  if (!colorConfig) return defaultColor;\n  if (typeof colorConfig === 'string') return colorConfig;\n  if (Array.isArray(colorConfig)) return colorConfig;\n  \n  const fn = colorConfig['@@function'];\n  const attr = colorConfig.attr || attribute;\n  \n  if (fn === 'colorContinuous') {\n    const domain = colorConfig.domain || [0, 100];\n    const steps = colorConfig.steps || 7;\n    const reverse = !!colorConfig.reverse;\n    \n    // Resolve palette name to colors array\n    let colors = colorConfig.colors;\n    if (typeof colors === 'string') {\n      colors = resolvePalette(colors, steps);\n    }\n    if (!colors || !Array.isArray(colors)) {\n      colors = ['#440154', '#21918c', '#fde725'];\n    }\n    if (reverse && colors.length > 1) {\n      colors = [...colors].reverse();\n    }\n    \n    // Build interpolate expression with all color stops\n    const expr: any[] = ['interpolate', ['linear'], ['coalesce', ['to-number', ['get', attr]], 0]];\n    \n    const numColors = colors.length;\n    for (let i = 0; i < numColors; i++) {\n      const t = i / (numColors - 1);\n      const value = domain[0] + t * (domain[1] - domain[0]);\n      expr.push(value, colors[i]);\n    }\n    \n    return expr;\n  }\n  \n  if (fn === 'colorCategories') {\n    const categories = colorConfig.categories || {};\n    const fallback = colorConfig.othersColor || '#888888';\n    \n    const expr: any[] = ['match', ['get', attr]];\n    for (const [cat, color] of Object.entries(categories)) {\n      expr.push(cat, color);\n    }\n    expr.push(fallback);\n    \n    return expr;\n  }\n  \n  return defaultColor;\n}\n\n/**\n * Add PMTiles layers to the map\n */\nexport async function addPMTilesLayers(\n  map: mapboxgl.Map,\n  layers: PMTilesLayerConfig[],\n  visibilityState: Record<string, boolean>,\n  hasCustomView: boolean = false\n): Promise<void> {\n  if (layers.length === 0) return;\n  \n  // Register PMTiles source type\n  await registerPMTilesSourceType();\n  const mapboxPmTiles = await ensureMapboxPMTilesLoaded();\n  \n  for (let i = 0; i < layers.length; i++) {\n    const layer = layers[i];\n    if (!layer.pmtilesUrl) continue;\n    \n    const visible = visibilityState[layer.id] !== false;\n    const sourceId = `${layer.id}-source`;\n    \n    try {\n      // Use mapbox-pmtiles native getHeader() method - this is what the library docs recommend\n      // This ensures we get the header the same way the library expects\n      const header = await mapboxPmTiles.PmTilesSource.getHeader(layer.pmtilesUrl);\n      const bounds: [number, number, number, number] = [\n        header.minLon,\n        header.minLat,\n        header.maxLon,\n        header.maxLat,\n      ];\n      let allLayerNames = extractVectorLayerNamesFromHeader(header);\n      const defaultLayerName = allLayerNames[0] || 'default';\n\n      const requestedSourceLayer =\n        typeof (layer as any).sourceLayer === 'string' ? ((layer as any).sourceLayer as string).trim() : '';\n\n      // Minimal fallback: if we couldn't detect source-layers from header.json\n      // and the user didn't specify one, try reading PMTiles metadata once.\n      if (!requestedSourceLayer && allLayerNames.length === 0) {\n        try {\n          allLayerNames = await getVectorLayerNamesFallback(layer.pmtilesUrl);\n        } catch (_) {}\n      }\n      const defaultLayerName2 = allLayerNames[0] || defaultLayerName;\n\n      // New behavior:\n      // - sourceLayer=\"*\" => render ALL source-layers found in metadata\n      // - sourceLayer unset/empty AND metadata has multiple layers => render ALL layers (acts like OL's \"dynamic\")\n      // - otherwise render the single requested/detected layer\n      // Optional exclusion list (useful when PMTiles contains helper layers like vertex/corner points)\n      const exclude = new Set<string>([\n        ...(((layer as any).excludeSourceLayers as string[]) || []),\n        ...(((layer as any).exclude_source_layers as string[]) || []),\n        ...(((layer.vectorLayer as any)?.excludeSourceLayers as string[]) || []),\n        ...(((layer.vectorLayer as any)?.exclude_source_layers as string[]) || []),\n      ].filter(Boolean));\n\n      const filterExcluded = (names: string[]) => names.filter((n) => !exclude.has(n));\n      const autoAll = !requestedSourceLayer && allLayerNames.length > 1;\n      const autoAllFiltered = autoAll ? filterExcluded(allLayerNames) : allLayerNames;\n\n      const sourceLayerNamesToRender: string[] =\n        requestedSourceLayer === '*'\n          ? filterExcluded(allLayerNames)\n          : requestedSourceLayer\n            ? [requestedSourceLayer]\n            : (allLayerNames.length > 1 ? autoAllFiltered : [defaultLayerName2]);\n\n      if (sourceLayerNamesToRender.length === 0) {\n        console.warn('[FusedMaps] PMTiles: could not detect any source-layers; set `source_layer` explicitly for:', layer.id);\n      }\n      if (requestedSourceLayer && requestedSourceLayer !== '*' && allLayerNames.length > 0 && !allLayerNames.includes(requestedSourceLayer)) {\n        console.warn('[FusedMaps] PMTiles: requested source-layer not found in header.json:', {\n          requested: requestedSourceLayer,\n          available: allLayerNames,\n        });\n      }\n      \n      // Add source if not exists\n      // IMPORTANT: Use header values from mapbox-pmtiles native getHeader() for correct tile fetching\n      if (!map.getSource(sourceId)) {\n        map.addSource(sourceId, {\n          type: mapboxPmTiles.SOURCE_TYPE,\n          url: layer.pmtilesUrl,\n          minzoom: header.minZoom,\n          maxzoom: header.maxZoom,\n          bounds: bounds,\n        } as any);\n      }\n      \n      // Get styling config\n      const vectorStyle = layer.vectorLayer || {};\n      const opacity = layer.fillOpacity ?? vectorStyle.opacity ?? 0.8;\n      const baseLineWidth = layer.lineWidth ?? 1;\n      const pointRadius = layer.pointRadiusMinPixels ?? 4;\n      \n      // Check filled/stroked booleans\n      const isFilled = (layer as any).isFilled !== false;\n      const isStroked = (layer as any).isStroked !== false;\n      const effectiveLineWidth = isStroked ? baseLineWidth : 0;\n      const effectiveFillOpacity = isFilled ? opacity : 0;\n\n      // Render toggles (default true). Helpful when PMTiles contains \"helper\" point layers.\n      const renderPoints = (layer as any).renderPoints !== false && (layer.vectorLayer as any)?.renderPoints !== false;\n      const renderLines = (layer as any).renderLines !== false && (layer.vectorLayer as any)?.renderLines !== false;\n      const renderPolygons = (layer as any).renderPolygons !== false && (layer.vectorLayer as any)?.renderPolygons !== false;\n      \n      // Determine colors\n      const fillColorExpr = buildPMTilesColorExpression(\n        layer.fillColorConfig || vectorStyle.getFillColor,\n        layer.colorAttribute || 'value',\n        '#ff8c00'\n      );\n      \n      const lineColorExpr = buildPMTilesColorExpression(\n        layer.lineColorConfig || vectorStyle.getLineColor,\n        layer.colorAttribute || 'value',\n        '#ffffff'\n      );\n      \n      const slugify = (s: string) => s.replace(/[^a-zA-Z0-9_-]+/g, '-');\n\n      // NEW: render one set of Mapbox layers per source-layer name\n      for (const sl of sourceLayerNamesToRender) {\n        const slSlug = slugify(sl || 'default');\n        const layerZoomProps: any = {};\n        if (typeof layer.minzoom === 'number') layerZoomProps.minzoom = layer.minzoom;\n        if (typeof layer.maxzoom === 'number') layerZoomProps.maxzoom = layer.maxzoom;\n\n        if (renderPoints) {\n          // Circle layer\n          const circleLayerId = `${layer.id}-${slSlug}-circles`;\n          if (!map.getLayer(circleLayerId)) {\n            map.addLayer({\n              id: circleLayerId,\n              type: 'circle',\n              source: sourceId,\n              'source-layer': sl,\n              ...layerZoomProps,\n              paint: {\n                'circle-radius': [\n                  'interpolate', ['exponential', 2], ['zoom'],\n                  0, pointRadius * 0.5,\n                  10, pointRadius,\n                  15, pointRadius * 4,\n                  20, pointRadius * 20,\n                ],\n                'circle-color': fillColorExpr,\n                'circle-opacity': effectiveFillOpacity,\n                'circle-stroke-color': lineColorExpr,\n                'circle-stroke-width': effectiveLineWidth,\n              },\n              layout: { visibility: visible ? 'visible' : 'none' },\n            });\n          }\n        }\n\n        if (renderPolygons) {\n          // Fill layer\n          const fillLayerId = `${layer.id}-${slSlug}-fill`;\n          if (!map.getLayer(fillLayerId)) {\n            map.addLayer({\n              id: fillLayerId,\n              type: 'fill',\n              source: sourceId,\n              'source-layer': sl,\n              ...layerZoomProps,\n              paint: {\n                'fill-color': fillColorExpr,\n                'fill-opacity': effectiveFillOpacity,\n              },\n              layout: { visibility: visible ? 'visible' : 'none' },\n            });\n          }\n        }\n\n        if (renderLines) {\n          // Line layer\n          const lineLayerId = `${layer.id}-${slSlug}-line`;\n          if (!map.getLayer(lineLayerId)) {\n            map.addLayer({\n              id: lineLayerId,\n              type: 'line',\n              source: sourceId,\n              'source-layer': sl,\n              ...layerZoomProps,\n              paint: {\n                'line-color': lineColorExpr,\n                'line-width': effectiveLineWidth,\n                'line-opacity': opacity,\n              },\n              layout: { visibility: visible ? 'visible' : 'none' },\n            });\n          }\n        }\n      }\n      \n      // Fit to bounds if available and this is the first layer, and user didn't provide a custom view\n      // IMPORTANT: use the header bounds directly (SW/NE pairs) so the map starts on the dataset.\n      if (!hasCustomView && bounds && i === 0) {\n        map.fitBounds([[bounds[0], bounds[1]], [bounds[2], bounds[3]]], {\n          padding: 50,\n          duration: 0,\n        });\n      }\n      \n    } catch (e) {\n      console.error(`[FusedMaps] Failed to add PMTiles layer ${layer.id}:`, e);\n    }\n  }\n}\n\n/**\n * Update visibility of PMTiles layers\n */\nexport function updatePMTilesVisibility(\n  map: mapboxgl.Map,\n  layerId: string,\n  visible: boolean\n): void {\n  const prefix = `${layerId}-`;\n  // We now create multiple Mapbox layers per PMTiles source-layer (e.g. `${layerId}-input10-fill`)\n  // So visibility toggling is prefix-based.\n  const styleLayers = (map.getStyle()?.layers || []) as any[];\n  for (const l of styleLayers) {\n    const id = l?.id as string | undefined;\n    if (id && id.startsWith(prefix)) {\n      try {\n        map.setLayoutProperty(id, 'visibility', visible ? 'visible' : 'none');\n      } catch (_) {}\n    }\n  }\n}\n\n/**\n * Remove PMTiles layers from the map\n */\nexport function removePMTilesLayers(map: mapboxgl.Map, layerId: string): void {\n  const prefix = `${layerId}-`;\n  const styleLayers = (map.getStyle()?.layers || []) as any[];\n  // Remove from end to avoid style index shifting issues\n  for (let i = styleLayers.length - 1; i >= 0; i--) {\n    const id = styleLayers[i]?.id as string | undefined;\n    if (id && id.startsWith(prefix)) {\n      try {\n        if (map.getLayer(id)) map.removeLayer(id);\n      } catch (_) {}\n    }\n  }\n  \n  const sourceId = `${layerId}-source`;\n  if (map.getSource(sourceId)) {\n    map.removeSource(sourceId);\n  }\n}\n\n/**\n * Check if PMTiles layers exist for a given layer ID\n */\nexport function hasPMTilesLayers(map: mapboxgl.Map, layerId: string): boolean {\n  const prefix = `${layerId}-`;\n  const styleLayers = (map.getStyle()?.layers || []) as any[];\n  return styleLayers.some(l => {\n    const id = l?.id as string | undefined;\n    return !!(id && id.startsWith(prefix));\n  });\n}\n","/**\n * Layer management - add, remove, toggle visibility\n * \n * This module handles the actual Mapbox GL layer operations.\n * State is managed by LayerStore in state/layer-store.ts.\n */\n\nimport type { LayerConfig, HexLayerConfig, VectorLayerConfig, MVTLayerConfig, RasterLayerConfig, PMTilesLayerConfig, FusedMapsConfig } from '../types';\nimport { hexToGeoJSON, addStaticHexLayer, setHexLayerVisibility } from './hex';\nimport { addVectorLayer, addMVTLayer, setVectorLayerVisibility } from './vector';\nimport { addRasterLayer, setRasterLayerVisibility } from './raster';\nimport { createHexTileOverlay } from './hex-tiles';\nimport { addPMTilesLayers, updatePMTilesVisibility, removePMTilesLayers, buildPMTilesColorExpression } from './pmtiles';\nimport { buildColorExpr } from '../color/expressions';\nimport { toRgba } from '../color/palettes';\n\n// Store computed GeoJSONs for legend/tooltip access (legacy, now synced to LayerStore)\nconst layerGeoJSONs: Record<string, GeoJSON.FeatureCollection> = {};\n\n/**\n * Get all computed layer GeoJSONs\n */\nexport function getLayerGeoJSONs(): Record<string, GeoJSON.FeatureCollection> {\n  return layerGeoJSONs;\n}\n\n/**\n * Update (or create) a computed GeoJSON for a layer.\n * Also syncs to LayerStore if available.\n */\nexport function setLayerGeoJSON(layerId: string, geojson: GeoJSON.FeatureCollection): void {\n  layerGeoJSONs[layerId] = geojson;\n}\n\n/**\n * Clear a layer's GeoJSON from cache\n */\nexport function clearLayerGeoJSON(layerId: string): void {\n  delete layerGeoJSONs[layerId];\n}\n\n/**\n * Add all layers to the map\n */\nexport function addAllLayers(\n  map: mapboxgl.Map,\n  layers: LayerConfig[],\n  visibilityState: Record<string, boolean>,\n  config: FusedMapsConfig\n): { deckOverlay: unknown } {\n  // Clear existing layers\n  removeAllLayers(map, layers);\n  \n  // Process layers in reverse order (top of menu renders on top)\n  const renderOrder = [...layers].reverse();\n  \n  renderOrder.forEach(layer => {\n    const visible = visibilityState[layer.id] !== false;\n    \n    switch (layer.layerType) {\n      case 'hex': {\n        const hexLayer = layer as HexLayerConfig;\n        if (hexLayer.isTileLayer) {\n          // Tile layers are handled by Deck.gl overlay\n          // Skip here - they'll be set up separately\n        } else if (hexLayer.data?.length) {\n          // Convert hex data to GeoJSON\n          const geojson = hexToGeoJSON(hexLayer.data);\n          setLayerGeoJSON(layer.id, geojson);\n          addStaticHexLayer(map, hexLayer, geojson, visible);\n        }\n        break;\n      }\n      \n      case 'vector': {\n        const vectorLayer = layer as VectorLayerConfig;\n        if (vectorLayer.geojson) {\n          setLayerGeoJSON(layer.id, vectorLayer.geojson);\n          addVectorLayer(map, vectorLayer, visible);\n        }\n        break;\n      }\n      \n      case 'mvt': {\n        const mvtLayer = layer as MVTLayerConfig;\n        addMVTLayer(map, mvtLayer, visible);\n        break;\n      }\n      \n      case 'raster': {\n        const rasterLayer = layer as RasterLayerConfig;\n        addRasterLayer(map, rasterLayer, visible);\n        break;\n      }\n      \n      case 'pmtiles': {\n        // PMTiles layers are handled separately after all sync layers\n        break;\n      }\n    }\n  });\n  \n  // Set up Deck.gl overlay for hex tile layers (if any)\n  const hasHexTileLayers = layers.some(l => l.layerType === 'hex' && (l as any).isTileLayer && (l as any).tileUrl);\n  let deckOverlay: unknown = null;\n  if (hasHexTileLayers) {\n    const state = createHexTileOverlay(map, layers, visibilityState);\n    deckOverlay = state?.overlay || null;\n    if (deckOverlay && state) {\n      // Attach a small shim so visibility toggles can rebuild the overlay layers.\n      (deckOverlay as any).__fused_hex_tiles__ = state;\n    }\n  }\n  \n  // Set up PMTiles layers (async - uses native Mapbox vector sources)\n  const pmtilesLayers = layers.filter(l => l.layerType === 'pmtiles') as PMTilesLayerConfig[];\n  if (pmtilesLayers.length > 0) {\n    // Add PMTiles layers asynchronously\n    addPMTilesLayers(map, pmtilesLayers, visibilityState, config?.hasCustomView === true).catch(e => {\n      console.error('[FusedMaps] Failed to add PMTiles layers:', e);\n    });\n  }\n  \n  return { deckOverlay };\n}\n\n/**\n * Add a single layer to the map\n */\nexport function addSingleLayer(\n  map: mapboxgl.Map,\n  layer: LayerConfig,\n  visible: boolean,\n  config?: FusedMapsConfig\n): void {\n  switch (layer.layerType) {\n    case 'hex': {\n      const hexLayer = layer as HexLayerConfig;\n      if (!hexLayer.isTileLayer && hexLayer.data?.length) {\n        const geojson = hexToGeoJSON(hexLayer.data);\n        setLayerGeoJSON(layer.id, geojson);\n        addStaticHexLayer(map, hexLayer, geojson, visible);\n      }\n      break;\n    }\n    \n    case 'vector': {\n      const vectorLayer = layer as VectorLayerConfig;\n      if (vectorLayer.geojson) {\n        setLayerGeoJSON(layer.id, vectorLayer.geojson);\n        addVectorLayer(map, vectorLayer, visible);\n      }\n      break;\n    }\n    \n    case 'mvt': {\n      const mvtLayer = layer as MVTLayerConfig;\n      addMVTLayer(map, mvtLayer, visible);\n      break;\n    }\n    \n    case 'raster': {\n      const rasterLayer = layer as RasterLayerConfig;\n      addRasterLayer(map, rasterLayer, visible);\n      break;\n    }\n    \n    case 'pmtiles': {\n      const pmLayer = layer as PMTilesLayerConfig;\n      addPMTilesLayers(map, [pmLayer], { [layer.id]: visible }, config?.hasCustomView === true).catch(e => {\n        console.error('[FusedMaps] Failed to add PMTiles layer:', e);\n      });\n      break;\n    }\n  }\n}\n\n/**\n * Remove a single layer from the map\n */\nexport function removeSingleLayer(map: mapboxgl.Map, layer: LayerConfig): void {\n  // Handle PMTiles layers specially\n  if (layer.layerType === 'pmtiles') {\n    removePMTilesLayers(map, layer.id);\n    clearLayerGeoJSON(layer.id);\n    return;\n  }\n  \n  const layerIds = [\n    `${layer.id}-fill`,\n    `${layer.id}-extrusion`,\n    `${layer.id}-outline`,\n    `${layer.id}-circle`,\n    `${layer.id}-line`,\n    `${layer.id}-raster`,\n    `${layer.id}-circles`,\n  ];\n  \n  layerIds.forEach(id => {\n    try {\n      if (map.getLayer(id)) map.removeLayer(id);\n    } catch (e) {}\n  });\n  \n  try {\n    if (map.getSource(layer.id)) map.removeSource(layer.id);\n    if (map.getSource(`${layer.id}-source`)) map.removeSource(`${layer.id}-source`);\n  } catch (e) {}\n  \n  clearLayerGeoJSON(layer.id);\n}\n\nfunction setPaintSafe(map: mapboxgl.Map, layerId: string, prop: string, value: any) {\n  try {\n    if (map.getLayer(layerId)) map.setPaintProperty(layerId, prop as any, value as any);\n  } catch (_) {}\n}\n\nfunction setLayoutSafe(map: mapboxgl.Map, layerId: string, prop: string, value: any) {\n  try {\n    if (map.getLayer(layerId)) map.setLayoutProperty(layerId, prop as any, value as any);\n  } catch (_) {}\n}\n\nfunction setGeoJSONSourceData(map: mapboxgl.Map, sourceId: string, geojson: any): boolean {\n  try {\n    const src: any = map.getSource(sourceId) as any;\n    if (src && typeof src.setData === 'function') {\n      src.setData(geojson);\n      return true;\n    }\n  } catch (_) {}\n  return false;\n}\n\n/**\n * Attempt an in-place style update for a layer.\n * Returns true if update was applied without needing remove+add.\n *\n * We only do this for \"style-ish\" changes. For structural changes\n * (URL/source changes, geometry toggles, etc.), return false.\n */\nexport function updateLayerStyleInPlace(\n  map: mapboxgl.Map,\n  before: LayerConfig,\n  after: LayerConfig,\n  visible: boolean\n): boolean {\n  if (!before || !after) return false;\n  if (before.id !== after.id) return false;\n  if (before.layerType !== after.layerType) return false;\n\n  const id = after.id;\n\n  // ------------------------------------------------------------------\n  // Raster: opacity + visibility can be updated in place\n  // ------------------------------------------------------------------\n  if (after.layerType === 'raster') {\n    const b = before as RasterLayerConfig;\n    const a = after as RasterLayerConfig;\n\n    // Structural changes => rebuild\n    const structural =\n      b.tileUrl !== a.tileUrl ||\n      b.imageUrl !== a.imageUrl ||\n      JSON.stringify(b.imageBounds) !== JSON.stringify(a.imageBounds);\n    if (structural) return false;\n\n    const opacity = a.opacity ?? a.rasterLayer?.opacity ?? 1.0;\n    setPaintSafe(map, `${id}-raster`, 'raster-opacity', Math.max(0, Math.min(1, opacity)));\n    setRasterLayerVisibility(map, id, visible);\n    return true;\n  }\n\n  // ------------------------------------------------------------------\n  // Vector (GeoJSON): paint props + source data updates\n  // ------------------------------------------------------------------\n  if (after.layerType === 'vector') {\n    const b = before as VectorLayerConfig;\n    const a = after as VectorLayerConfig;\n\n    // Structural toggles that affect which sublayers exist => rebuild\n    const structural =\n      b.isFilled !== a.isFilled ||\n      b.isStroked !== a.isStroked ||\n      b.tileUrl !== a.tileUrl ||\n      b.sourceLayer !== a.sourceLayer;\n    if (structural) return false;\n\n    // Update source data if provided\n    if (a.geojson) {\n      const ok = setGeoJSONSourceData(map, id, a.geojson as any);\n      // If source doesn't exist, can't do in-place\n      if (!ok && !map.getSource(id)) return false;\n    }\n\n    // Build expressions\n    const geojson = a.geojson;\n    const vecData = geojson?.features?.map((f: any) => f.properties || {}) || [];\n\n    const fillColorExpr = (a.fillColorConfig as any)?.['@@function']\n      ? buildColorExpr(a.fillColorConfig as any, vecData)\n      : (a.fillColorRgba || 'rgba(0,144,255,0.6)');\n\n    const lineColorExpr = (a.lineColorConfig as any)?.['@@function']\n      ? buildColorExpr(a.lineColorConfig as any, vecData)\n      : (a.lineColorRgba || 'rgba(100,100,100,0.8)');\n\n    const lineW = (typeof a.lineWidth === 'number' && isFinite(a.lineWidth)) ? a.lineWidth : 1;\n    const layerOpacity = (typeof a.opacity === 'number' && isFinite(a.opacity))\n      ? Math.max(0, Math.min(1, a.opacity))\n      : 0.8;\n\n    const pointRadius = (typeof a.pointRadius === 'number' && isFinite(a.pointRadius))\n      ? a.pointRadius\n      : 6;\n\n    // Apply paint props (only if sublayers exist)\n    setPaintSafe(map, `${id}-fill`, 'fill-color', fillColorExpr as any);\n    setPaintSafe(map, `${id}-fill`, 'fill-opacity', layerOpacity);\n\n    setPaintSafe(map, `${id}-outline`, 'line-color', lineColorExpr as any);\n    setPaintSafe(map, `${id}-outline`, 'line-width', lineW);\n\n    setPaintSafe(map, `${id}-line`, 'line-color', lineColorExpr as any);\n    setPaintSafe(map, `${id}-line`, 'line-width', lineW);\n    setPaintSafe(map, `${id}-line`, 'line-opacity', 1);\n\n    setPaintSafe(map, `${id}-circle`, 'circle-radius', pointRadius);\n    setPaintSafe(map, `${id}-circle`, 'circle-color', fillColorExpr as any);\n    setPaintSafe(map, `${id}-circle`, 'circle-opacity', 0.9);\n    setPaintSafe(map, `${id}-circle`, 'circle-stroke-color', lineColorExpr as any);\n    setPaintSafe(map, `${id}-circle`, 'circle-stroke-width', 1);\n\n    setVectorLayerVisibility(map, id, visible);\n    return true;\n  }\n\n  // ------------------------------------------------------------------\n  // Hex (static Mapbox): paint props + source data updates\n  // ------------------------------------------------------------------\n  if (after.layerType === 'hex') {\n    const b = before as HexLayerConfig;\n    const a = after as HexLayerConfig;\n\n    // Tile-mode hex is Deck; not handled here\n    if ((a as any).isTileLayer) return false;\n\n    // Structural toggles that affect sublayers => rebuild\n    const structural =\n      (b.hexLayer as any)?.extruded !== (a.hexLayer as any)?.extruded ||\n      (b.hexLayer as any)?.filled !== (a.hexLayer as any)?.filled ||\n      (b.hexLayer as any)?.stroked !== (a.hexLayer as any)?.stroked;\n    if (structural) return false;\n\n    // Update source data if we can\n    const geojson = (a.data && Array.isArray(a.data)) ? hexToGeoJSON(a.data) : null;\n    if (geojson) {\n      const ok = setGeoJSONSourceData(map, id, geojson as any);\n      if (!ok && !map.getSource(id)) return false;\n    }\n\n    const cfg: any = a.hexLayer || {};\n    const data = a.data || [];\n\n    const fillColor = Array.isArray(cfg.getFillColor)\n      ? toRgba(cfg.getFillColor, 0.8)\n      : (buildColorExpr(cfg.getFillColor, data) || 'rgba(0,144,255,0.7)');\n\n    const lineColor = cfg.getLineColor\n      ? (Array.isArray(cfg.getLineColor) ? toRgba(cfg.getLineColor, 1) : buildColorExpr(cfg.getLineColor, data))\n      : 'rgba(255,255,255,0.3)';\n\n    const layerOpacity = (typeof cfg.opacity === 'number' && isFinite(cfg.opacity))\n      ? Math.max(0, Math.min(1, cfg.opacity))\n      : 0.8;\n\n    // Flat fill\n    setPaintSafe(map, `${id}-fill`, 'fill-color', fillColor);\n    setPaintSafe(map, `${id}-fill`, 'fill-opacity', layerOpacity);\n\n    // Outline\n    setPaintSafe(map, `${id}-outline`, 'line-color', lineColor);\n    setPaintSafe(map, `${id}-outline`, 'line-width', cfg.lineWidthMinPixels || 0.5);\n\n    // Extrusion (only if it exists)\n    const elevScale = cfg.elevationScale || 1;\n    const elevProp = cfg.elevationProperty || (cfg.getFillColor as any)?.attr || null;\n    setPaintSafe(map, `${id}-extrusion`, 'fill-extrusion-color', fillColor);\n    setPaintSafe(\n      map,\n      `${id}-extrusion`,\n      'fill-extrusion-height',\n      elevProp ? ['*', ['to-number', ['get', elevProp], 0], elevScale] : 100\n    );\n    setPaintSafe(map, `${id}-extrusion`, 'fill-extrusion-opacity', layerOpacity);\n\n    setHexLayerVisibility(map, id, visible, cfg.extruded === true);\n    return true;\n  }\n\n  // ------------------------------------------------------------------\n  // MVT: update paint props only (source is stable)\n  // ------------------------------------------------------------------\n  if (after.layerType === 'mvt') {\n    const b = before as MVTLayerConfig;\n    const a = after as MVTLayerConfig;\n\n    const structural =\n      b.tileUrl !== a.tileUrl ||\n      b.sourceLayer !== a.sourceLayer ||\n      b.isExtruded !== a.isExtruded ||\n      b.isFilled !== a.isFilled;\n    if (structural) return false;\n\n    const fillColorExpr = (a.fillColorConfig as any)?.['@@function']\n      ? (buildColorExpr(a.fillColorConfig as any, undefined) as any)\n      : (a.fillColor || '#FFF5CC');\n    const lineColorExpr = (a.lineColorConfig as any)?.['@@function']\n      ? (buildColorExpr(a.lineColorConfig as any, undefined) as any)\n      : (a.lineColor || '#FFFFFF');\n\n    const fillOpacity = a.fillOpacity ?? 0.8;\n    const lineWidth = a.lineWidth ?? 1;\n\n    setPaintSafe(map, `${id}-fill`, 'fill-color', fillColorExpr);\n    setPaintSafe(map, `${id}-fill`, 'fill-opacity', fillOpacity);\n    setPaintSafe(map, `${id}-line`, 'line-color', lineColorExpr);\n    setPaintSafe(map, `${id}-line`, 'line-width', lineWidth);\n\n    // Extrusion paint if present\n    if (map.getLayer(`${id}-extrusion`)) {\n      setPaintSafe(map, `${id}-extrusion`, 'fill-extrusion-color', fillColorExpr);\n      setPaintSafe(\n        map,\n        `${id}-extrusion`,\n        'fill-extrusion-height',\n        ['*', ['get', a.heightProperty || 'height'], a.heightMultiplier || 1]\n      );\n      setPaintSafe(map, `${id}-extrusion`, 'fill-extrusion-opacity', a.extrusionOpacity ?? 0.9);\n    }\n\n    setVectorLayerVisibility(map, id, visible);\n    return true;\n  }\n\n  // ------------------------------------------------------------------\n  // PMTiles: update paint props for all prefix-based layers\n  // ------------------------------------------------------------------\n  if (after.layerType === 'pmtiles') {\n    const b = before as PMTilesLayerConfig;\n    const a = after as PMTilesLayerConfig;\n\n    const structural =\n      b.pmtilesUrl !== a.pmtilesUrl ||\n      b.pmtilesPath !== a.pmtilesPath ||\n      JSON.stringify(b.excludeSourceLayers || []) !== JSON.stringify(a.excludeSourceLayers || []) ||\n      b.sourceLayer !== a.sourceLayer ||\n      b.renderPoints !== a.renderPoints ||\n      b.renderLines !== a.renderLines ||\n      b.renderPolygons !== a.renderPolygons;\n    if (structural) return false;\n\n    const vectorStyle: any = a.vectorLayer || {};\n    const opacity = a.fillOpacity ?? vectorStyle.opacity ?? 0.8;\n    const baseLineWidth = a.lineWidth ?? 1;\n    const pointRadius = a.pointRadiusMinPixels ?? 4;\n\n    const isFilled = (a as any).isFilled !== false;\n    const isStroked = (a as any).isStroked !== false;\n    const effectiveLineWidth = isStroked ? baseLineWidth : 0;\n    const effectiveFillOpacity = isFilled ? opacity : 0;\n\n    const attr = a.colorAttribute || 'value';\n    const fillColorExpr = buildPMTilesColorExpression(a.fillColorConfig || vectorStyle.getFillColor, attr, '#ff8c00');\n    const lineColorExpr = buildPMTilesColorExpression(a.lineColorConfig || vectorStyle.getLineColor, attr, '#ffffff');\n\n    const prefix = `${id}-`;\n    const styleLayers = (map.getStyle()?.layers || []) as any[];\n\n    for (const l of styleLayers) {\n      const lid = l?.id as string | undefined;\n      if (!lid || !lid.startsWith(prefix)) continue;\n\n      if (lid.endsWith('-fill')) {\n        setPaintSafe(map, lid, 'fill-color', fillColorExpr);\n        setPaintSafe(map, lid, 'fill-opacity', effectiveFillOpacity);\n      } else if (lid.endsWith('-line')) {\n        setPaintSafe(map, lid, 'line-color', lineColorExpr);\n        setPaintSafe(map, lid, 'line-width', effectiveLineWidth);\n        setPaintSafe(map, lid, 'line-opacity', opacity);\n      } else if (lid.endsWith('-circles')) {\n        // Mirror the zoom expression from addPMTilesLayers\n        const radiusExpr: any = [\n          'interpolate', ['exponential', 2], ['zoom'],\n          0, pointRadius * 0.5,\n          10, pointRadius,\n          15, pointRadius * 4,\n          20, pointRadius * 20,\n        ];\n        setPaintSafe(map, lid, 'circle-radius', radiusExpr);\n        setPaintSafe(map, lid, 'circle-color', fillColorExpr);\n        setPaintSafe(map, lid, 'circle-opacity', effectiveFillOpacity);\n        setPaintSafe(map, lid, 'circle-stroke-color', lineColorExpr);\n        setPaintSafe(map, lid, 'circle-stroke-width', effectiveLineWidth);\n      }\n\n      // Keep visibility in sync too\n      setLayoutSafe(map, lid, 'visibility', visible ? 'visible' : 'none');\n    }\n\n    return true;\n  }\n\n  return false;\n}\n\n/**\n * Remove all layers from the map\n */\nfunction removeAllLayers(map: mapboxgl.Map, layers: LayerConfig[]): void {\n  layers.forEach(layer => {\n    removeSingleLayer(map, layer);\n  });\n}\n\n/**\n * Set visibility for a single layer\n */\nexport function setLayerVisibility(\n  map: mapboxgl.Map,\n  layerId: string,\n  visible: boolean,\n  layers: LayerConfig[],\n  deckOverlay: unknown\n): void {\n  const layer = layers.find(l => l.id === layerId);\n  if (!layer) return;\n  \n  switch (layer.layerType) {\n    case 'hex': {\n      const hexLayer = layer as HexLayerConfig;\n      if (hexLayer.isTileLayer) {\n        // Rebuild deck overlay layers so visibility takes effect\n        const state = (deckOverlay as any)?.__fused_hex_tiles__;\n        try {\n          state?.rebuild?.();\n        } catch (e) {}\n      } else {\n        setHexLayerVisibility(map, layerId, visible, hexLayer.hexLayer?.extruded === true);\n      }\n      break;\n    }\n    \n    case 'vector':\n    case 'mvt':\n      setVectorLayerVisibility(map, layerId, visible);\n      break;\n    \n    case 'raster':\n      setRasterLayerVisibility(map, layerId, visible);\n      break;\n    \n    case 'pmtiles':\n      updatePMTilesVisibility(map, layerId, visible);\n      break;\n  }\n}\n\n// Re-export layer utilities\nexport * from './hex';\nexport * from './vector';\nexport * from './raster';\nexport * from './pmtiles';\n","/**\n * Layer visibility toggle panel\n * Matching the original map_utils.py design with eye icons and gradient strips\n * \n * Now integrates with LayerStore for centralized state management.\n */\n\nimport type { LayerConfig, HexLayerConfig, VectorLayerConfig, PMTilesLayerConfig } from '../types';\nimport { getPaletteColors, toRgba } from '../color/palettes';\nimport type { LayerStore } from '../state';\n\ntype VisibilityCallback = (layerId: string, visible: boolean) => void;\n\nlet visibilityCallback: VisibilityCallback | null = null;\nlet unsubscribeStore: (() => void) | null = null;\nlet installedListeners = false;\nlet clickHandlerInstalled = false;\nlet activeStore: LayerStore | null = null;\nlet activeVisibilityState: Record<string, boolean> = {};\nlet panelEl: HTMLElement | null = null;\n\nfunction getCurrentVisible(layerId: string): boolean {\n  try {\n    if (activeStore) return activeStore.get(layerId)?.visible !== false;\n    return activeVisibilityState[layerId] !== false;\n  } catch (_) {\n    return true;\n  }\n}\n\nfunction handlePanelClick(e: MouseEvent): void {\n  try {\n    const target = e.target as HTMLElement | null;\n    if (!target) return;\n\n    // Ignore clicks on drag handle (reorder not implemented yet)\n    if (target.closest?.('.layer-drag')) return;\n\n    const item = target.closest?.('.layer-item') as HTMLElement | null;\n    if (!item) return;\n    const layerId = item.getAttribute('data-layer-id') || '';\n    if (!layerId) return;\n\n    const isEye = !!target.closest?.('.layer-eye');\n\n    // Clicking on the item body toggles; clicking on the eye also toggles.\n    // (We don't need stopPropagation because this is a single delegated handler.)\n    if (isEye || target.closest?.('.layer-item')) {\n      const current = getCurrentVisible(layerId);\n      visibilityCallback?.(layerId, !current);\n      e.preventDefault();\n    }\n  } catch (_) {}\n}\n\n// Eye icon SVGs\nconst EYE_OPEN_SVG = '<svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"currentColor\"><path d=\"M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z\"/></svg>';\nconst EYE_CLOSED_SVG = '<svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"currentColor\"><path d=\"M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z\"/></svg>';\n\n// Drag icons for reordering\nconst DRAG_HANDLE_SVG = '<svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"currentColor\" opacity=\"0.5\"><path d=\"M11 18c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zm-2-8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 4c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z\"/></svg>';\n\n/**\n * Setup the layer panel\n */\nexport function setupLayerPanel(\n  layers: LayerConfig[],\n  visibilityState: Record<string, boolean>,\n  onVisibilityChange: VisibilityCallback,\n  store?: LayerStore\n): { destroy: () => void } {\n  visibilityCallback = onVisibilityChange;\n  const _store = store;\n  activeStore = _store || null;\n  activeVisibilityState = visibilityState || {};\n  \n  // Create panel container if it doesn't exist\n  let panel = document.getElementById('layer-panel');\n  if (!panel) {\n    panel = document.createElement('div');\n    panel.id = 'layer-panel';\n    panel.innerHTML = `<div id=\"layer-list\"></div>`;\n    document.body.appendChild(panel);\n  }\n  panelEl = panel;\n  \n  // One delegated click handler for the whole panel (no window globals, no inline onclick)\n  if (!clickHandlerInstalled) {\n    try {\n      panel.addEventListener('click', handlePanelClick as any);\n      clickHandlerInstalled = true;\n    } catch (_) {}\n  }\n  \n  // Initial render\n  if (_store) renderPanel(_store);\n  else updateLayerPanel(layers, visibilityState);\n\n  // Subscribe to store changes for automatic updates (when provided)\n  if (_store) {\n    unsubscribeStore = _store.on('*', (event) => {\n      if (event.type === 'visibility' || event.type === 'reorder' || event.type === 'add' || event.type === 'remove' || event.type === 'batch') {\n        renderPanel(_store);\n      }\n    });\n  }\n\n  // Keep the \"gutter\" gradient strips in sync when layer styles change\n  if (!installedListeners) {\n    installedListeners = true;\n    try {\n      window.addEventListener('fusedmaps:legend:update', () => {\n        try { if (_store) renderPanel(_store); } catch (_) {}\n      });\n    } catch (_) {}\n  }\n\n  return {\n    destroy: () => {\n      if (unsubscribeStore) {\n        unsubscribeStore();\n        unsubscribeStore = null;\n      }\n      // Remove click handler if this is the last/only panel instance\n      try {\n        panelEl?.removeEventListener('click', handlePanelClick as any);\n      } catch (_) {}\n      clickHandlerInstalled = false;\n      panelEl = null;\n      activeStore = null;\n    }\n  };\n}\n\n/**\n * Render the panel from store state\n */\nfunction renderPanel(store: LayerStore): void {\n  const list = document.getElementById('layer-list');\n  if (!list) return;\n  \n  const layers = store.getAll();\n  \n  list.innerHTML = layers.map(layerState => {\n    const layer = layerState.config;\n    const visible = layerState.visible;\n    const stripBg = getLayerStripGradient(layer);\n    const eyeIcon = visible ? EYE_OPEN_SVG : EYE_CLOSED_SVG;\n    \n    return `\n      <div class=\"layer-item ${visible ? '' : 'disabled'}\" \n           data-layer-id=\"${layer.id}\"\n           data-order=\"${layerState.order}\"\n           style=\"--layer-strip: ${stripBg};\">\n        <span class=\"layer-drag\" title=\"Drag to reorder\">${DRAG_HANDLE_SVG}</span>\n        <span class=\"layer-name\">${layer.name}</span>\n        <span class=\"layer-eye\" title=\"Toggle visibility\">${eyeIcon}</span>\n      </div>\n    `;\n  }).join('');\n}\n\n/**\n * Update the layer panel UI (legacy interface for compatibility)\n */\nexport function updateLayerPanel(\n  layers: LayerConfig[],\n  visibilityState: Record<string, boolean>\n): void {\n  const list = document.getElementById('layer-list');\n  if (!list) return;\n  activeVisibilityState = visibilityState || {};\n  \n  list.innerHTML = layers.map(layer => {\n    const visible = visibilityState[layer.id] !== false;\n    const stripBg = getLayerStripGradient(layer);\n    const eyeIcon = visible ? EYE_OPEN_SVG : EYE_CLOSED_SVG;\n    \n    return `\n      <div class=\"layer-item ${visible ? '' : 'disabled'}\" \n           data-layer-id=\"${layer.id}\" \n           style=\"--layer-strip: ${stripBg};\">\n        <span class=\"layer-name\">${layer.name}</span>\n        <span class=\"layer-eye\" title=\"Toggle visibility\">${eyeIcon}</span>\n      </div>\n    `;\n  }).join('');\n}\n\n/**\n * Get the gradient strip background for a layer\n */\nfunction getLayerStripGradient(layer: LayerConfig): string {\n  let stripBg = '#0090ff';\n  \n  const toGradient = (cols: string[]): string | null => {\n    if (!cols || !cols.length) return null;\n    if (cols.length === 1) return cols[0];\n    const stops = cols.map((c, i) => `${c} ${(i / (cols.length - 1)) * 100}%`).join(', ');\n    return `linear-gradient(to bottom, ${stops})`;\n  };\n  \n  if (layer.layerType === 'hex') {\n    const hexLayer = layer as HexLayerConfig;\n    const cfg = hexLayer.hexLayer || {};\n    const colorCfg = (cfg.filled === false && cfg.getLineColor) \n      ? cfg.getLineColor \n      : cfg.getFillColor;\n    \n    if (Array.isArray(colorCfg)) {\n      const rgba = toRgba(colorCfg, 1);\n      if (rgba) stripBg = rgba;\n    } else if (colorCfg && typeof colorCfg === 'object') {\n      const fn = (colorCfg as any)['@@function'];\n      if (fn === 'colorContinuous' || fn === 'colorCategories') {\n        const paletteName = (colorCfg as any).colors || (fn === 'colorCategories' ? 'Bold' : 'TealGrn');\n        let cols = getPaletteColors(paletteName, (colorCfg as any).steps || 7);\n        if (cols?.length) {\n          // Handle domain reversal\n          const dom = (colorCfg as any).domain;\n          const domainReversed = Array.isArray(dom) && dom.length >= 2 && dom[0] > dom[dom.length - 1];\n          const wantsReverse = !!(colorCfg as any).reverse;\n          const shouldReverse = domainReversed ? !wantsReverse : wantsReverse;\n          if (shouldReverse) cols = [...cols].reverse();\n          stripBg = toGradient(cols) || stripBg;\n        }\n      }\n    }\n  } else if (layer.layerType === 'vector') {\n    const vecLayer = layer as VectorLayerConfig;\n    if (vecLayer.lineColorRgba && !vecLayer.isFilled) {\n      stripBg = vecLayer.lineColorRgba;\n    } else if (vecLayer.fillColorRgba) {\n      stripBg = vecLayer.fillColorRgba;\n    } else if (vecLayer.fillColorConfig && typeof vecLayer.fillColorConfig === 'object') {\n      const paletteName = (vecLayer.fillColorConfig as any).colors;\n      if (paletteName) {\n        const cols = getPaletteColors(paletteName, 7);\n        if (cols?.length) stripBg = toGradient(cols) || stripBg;\n      }\n    }\n  } else if (layer.layerType === 'pmtiles') {\n    const pmLayer = layer as PMTilesLayerConfig;\n    if (pmLayer.fillColorConfig && typeof pmLayer.fillColorConfig === 'object') {\n      const paletteName = (pmLayer.fillColorConfig as any).colors;\n      if (paletteName) {\n        let cols = getPaletteColors(paletteName, 7);\n        if (cols?.length) {\n          const wantsReverse = !!(pmLayer.fillColorConfig as any).reverse;\n          if (wantsReverse) cols = [...cols].reverse();\n          stripBg = toGradient(cols) || stripBg;\n        }\n      }\n    }\n  } else if (layer.layerType === 'raster') {\n    stripBg = 'linear-gradient(to bottom, #888, #444)';\n  }\n  \n  return stripBg;\n}\n","/**\n * Color legend component\n */\n\nimport type { LayerConfig, HexLayerConfig, VectorLayerConfig, ColorContinuousConfig, ColorCategoriesConfig } from '../types';\nimport { getPaletteColors, FALLBACK_CATEGORICAL_COLORS, FALLBACK_CONTINUOUS_COLORS } from '../color/palettes';\nimport { getUniqueCategories } from '../color/expressions';\n\n/**\n * Setup the legend container\n */\nexport function setupLegend(\n  layers: LayerConfig[],\n  visibilityState: Record<string, boolean>,\n  geojsons: Record<string, GeoJSON.FeatureCollection>\n): void {\n  // Create legend container if it doesn't exist\n  let legend = document.getElementById('color-legend');\n  if (!legend) {\n    legend = document.createElement('div');\n    legend.id = 'color-legend';\n    legend.className = 'color-legend';\n    legend.style.display = 'none';\n    document.body.appendChild(legend);\n  }\n  \n  updateLegend(layers, visibilityState, geojsons);\n}\n\n/**\n * Update the legend based on visible layers\n */\nexport function updateLegend(\n  layers: LayerConfig[],\n  visibilityState: Record<string, boolean>,\n  geojsons: Record<string, GeoJSON.FeatureCollection>\n): void {\n  const legend = document.getElementById('color-legend');\n  if (!legend) return;\n  \n  const visibleLayers = layers.filter(l => visibilityState[l.id] !== false);\n  if (!visibleLayers.length) {\n    legend.style.display = 'none';\n    return;\n  }\n  \n  let html = '';\n  \n  visibleLayers.forEach(layer => {\n    const legendHtml = buildLayerLegend(layer, geojsons);\n    if (legendHtml) {\n      html += legendHtml;\n    }\n  });\n  \n  if (html) {\n    legend.innerHTML = html;\n    legend.style.display = 'block';\n  } else {\n    legend.style.display = 'none';\n  }\n}\n\n/**\n * Build legend HTML for a single layer\n */\nfunction buildLayerLegend(\n  layer: LayerConfig,\n  geojsons: Record<string, GeoJSON.FeatureCollection>\n): string {\n  let colorCfg: any = null;\n  \n  if (layer.layerType === 'hex') {\n    const hexLayer = layer as HexLayerConfig;\n    const cfg = hexLayer.hexLayer || {};\n    colorCfg = (cfg.filled === false && cfg.getLineColor) \n      ? cfg.getLineColor \n      : cfg.getFillColor;\n  } else if (layer.layerType === 'vector') {\n    const vecLayer = layer as VectorLayerConfig;\n    colorCfg = vecLayer.fillColorConfig;\n    \n    // Show simple line legend for stroke-only vector layers\n    if (!colorCfg?.['@@function'] && vecLayer.lineColorRgba && !vecLayer.isFilled) {\n      return `\n        <div class=\"legend-layer\">\n          <div class=\"legend-title\">\n            <span class=\"legend-line\" style=\"background:${vecLayer.lineColorRgba};\"></span>\n            ${layer.name}\n          </div>\n        </div>\n      `;\n    }\n  }\n  \n  // Only show legend for layers with explicit color functions\n  const fnType = colorCfg?.['@@function'];\n  if (!fnType || !colorCfg?.attr) return '';\n  if (fnType !== 'colorContinuous' && fnType !== 'colorCategories') return '';\n  \n  const paletteName = colorCfg.colors || (fnType === 'colorCategories' ? 'Bold' : 'TealGrn');\n  \n  // Handle categorical legend\n  if (fnType === 'colorCategories') {\n    // Auto-detect categories if they weren't provided and haven't been detected yet.\n    // This fixes cases where a categorical style exists but the rendering path didn't\n    // populate `_detectedCategories` (e.g., some tile flows).\n    try {\n      const cc = colorCfg as any;\n      const hasCats =\n        Array.isArray(cc._detectedCategories) && cc._detectedCategories.length\n          ? true\n          : Array.isArray(cc.categories) && cc.categories.length\n            ? true\n            : false;\n      if (!hasCats && cc.attr) {\n        let rows: Array<Record<string, unknown>> = [];\n        // Prefer cached GeoJSON for the layer (includes SQL hex outputs).\n        const gj = geojsons?.[(layer as any).id];\n        if (gj?.features?.length) {\n          rows = gj.features.map((f: any) => (f?.properties || {}));\n        } else if ((layer as any).layerType === 'hex') {\n          rows = (((layer as any).data || []) as any[]);\n        } else if ((layer as any).layerType === 'vector') {\n          const vgj = (layer as any).geojson;\n          if (vgj?.features?.length) rows = vgj.features.map((f: any) => (f?.properties || {}));\n        }\n        const pairs = getUniqueCategories(rows, cc.attr, cc.labelAttr);\n        // cap for UI sanity\n        cc._detectedCategories = pairs.slice(0, 50);\n      }\n    } catch (_) {}\n    return buildCategoricalLegend(layer.name, colorCfg, paletteName);\n  }\n  \n  // Handle continuous legend\n  if (fnType === 'colorContinuous') {\n    return buildContinuousLegend(layer.name, colorCfg, paletteName);\n  }\n  \n  return '';\n}\n\n/**\n * Build categorical legend HTML\n */\nfunction buildCategoricalLegend(\n  layerName: string,\n  colorCfg: ColorCategoriesConfig,\n  paletteName: string\n): string {\n  // Use detected categories or provided ones\n  let catPairs = colorCfg._detectedCategories || colorCfg.categories || [];\n  catPairs = catPairs.map((c: any) => \n    typeof c === 'object' && c.label ? c : { value: c, label: c }\n  );\n  \n  if (!catPairs.length) return '';\n  \n  let colors = getPaletteColors(paletteName, Math.max(catPairs.length, 3));\n  if (!colors?.length) {\n    colors = FALLBACK_CATEGORICAL_COLORS;\n  }\n  \n  const titleAttr = colorCfg.labelAttr || colorCfg.attr;\n  \n  return `\n    <div class=\"legend-layer\">\n      <div class=\"legend-title\">\n        <span class=\"legend-dot\" style=\"background:${colors[0]};\"></span>\n        ${layerName}: ${titleAttr}\n      </div>\n      <div class=\"legend-categories\">\n        ${catPairs.map((cat: any, i: number) => `\n          <div class=\"legend-cat-item\">\n            <div class=\"legend-cat-swatch\" style=\"background:${colors![i % colors!.length]};\"></div>\n            <span class=\"legend-cat-label\" title=\"${cat.label}\">${cat.label}</span>\n          </div>\n        `).join('')}\n      </div>\n    </div>\n  `;\n}\n\n/**\n * Build continuous legend HTML\n */\nfunction buildContinuousLegend(\n  layerName: string,\n  colorCfg: ColorContinuousConfig,\n  paletteName: string\n): string {\n  // Prefer dynamic domain (autoDomain) when present\n  const domain: any = (colorCfg as any)._dynamicDomain || colorCfg.domain;\n  if (!domain?.length) return '';\n  \n  const [d0, d1] = domain;\n  const isReversed = d0 > d1;\n  const steps = colorCfg.steps || 7;\n  \n  let colors = getPaletteColors(paletteName, steps);\n  if (!colors?.length) {\n    colors = FALLBACK_CONTINUOUS_COLORS;\n  }\n  if (isReversed) colors = [...colors].reverse();\n  \n  const gradient = `linear-gradient(to right, ${colors.map((c, i) => \n    `${c} ${i / (colors!.length - 1) * 100}%`\n  ).join(', ')})`;\n  \n  const dotColor = colors[Math.floor(colors.length / 2)];\n  \n  return `\n    <div class=\"legend-layer\">\n      <div class=\"legend-title\">\n        <span class=\"legend-dot\" style=\"background:${dotColor};\"></span>\n        ${layerName}: ${colorCfg.attr}\n      </div>\n      <div class=\"legend-gradient\" style=\"background:${gradient};\"></div>\n      <div class=\"legend-labels\">\n        <span>${d0.toFixed(1)}</span>\n        <span>${d1.toFixed(1)}</span>\n      </div>\n    </div>\n  `;\n}\n\n","/**\n * Map widgets: scale, zoom/home, screenshot, and Cmd+drag orbit.\n * Ported from map_utils.py for UI parity.\n */\n\nimport type { ViewState } from '../types';\n\nexport interface WidgetsHandle {\n  destroy: () => void;\n  setHomeViewState?: (view: ViewState) => void;\n}\n\nfunction downloadScreenshot(map: mapboxgl.Map) {\n  const ts = new Date().toISOString().replace(/[:.]/g, '-');\n  const filename = `map-screenshot-${ts}.png`;\n\n  try {\n    const canvas = map.getCanvas();\n    const a = document.createElement('a');\n    a.download = filename;\n\n    // Prefer Blob download: more reliable filename/extension across browsers than data URLs.\n    if (typeof canvas.toBlob === 'function') {\n      canvas.toBlob(\n        (blob) => {\n          try {\n            if (!blob) throw new Error('toBlob returned null');\n            const url = URL.createObjectURL(blob);\n            a.href = url;\n            document.body.appendChild(a);\n            a.click();\n            a.remove();\n            setTimeout(() => URL.revokeObjectURL(url), 1000);\n          } catch (e) {\n            // eslint-disable-next-line no-console\n            console.error('Screenshot failed:', e);\n            alert(\n              'Screenshot blocked (likely due to CORS/tainted canvas from raster tiles). Try using only CORS-enabled layers/tiles.'\n            );\n          }\n        },\n        'image/png'\n      );\n      return;\n    }\n\n    // Fallback: data URL\n    const dataUrl = canvas.toDataURL('image/png');\n    a.href = dataUrl;\n    document.body.appendChild(a);\n    a.click();\n    a.remove();\n  } catch (e) {\n    // Likely CORS/tainted canvas due to raster tiles\n    // eslint-disable-next-line no-console\n    console.error('Screenshot failed:', e);\n    alert(\n      'Screenshot blocked (likely due to CORS/tainted canvas from raster tiles). Try using only CORS-enabled layers/tiles.'\n    );\n  }\n}\n\nfunction addScaleControl(map: mapboxgl.Map) {\n  try {\n    map.addControl(new mapboxgl.ScaleControl({ maxWidth: 110, unit: 'metric' }), 'bottom-left');\n  } catch (_) {}\n}\n\nfunction addZoomHomeControl(\n  map: mapboxgl.Map,\n  initialView: ViewState,\n  screenshotEnabled: boolean\n): { setHomeViewState: (view: ViewState) => void } {\n  // Keep home target mutable so callers can update it after auto-fit.\n  const homeView: ViewState = { ...initialView };\n\n  const setHomeViewState = (v: ViewState) => {\n    try {\n      if (!v) return;\n      if (typeof v.longitude === 'number' && Number.isFinite(v.longitude)) homeView.longitude = v.longitude;\n      if (typeof v.latitude === 'number' && Number.isFinite(v.latitude)) homeView.latitude = v.latitude;\n      if (typeof v.zoom === 'number' && Number.isFinite(v.zoom)) homeView.zoom = v.zoom;\n      if (typeof v.pitch === 'number' && Number.isFinite(v.pitch)) homeView.pitch = v.pitch;\n      if (typeof v.bearing === 'number' && Number.isFinite(v.bearing)) homeView.bearing = v.bearing;\n    } catch (_) {}\n  };\n\n  class ZoomHomeControl {\n    private _map?: mapboxgl.Map;\n    private _container?: HTMLElement;\n\n    onAdd(m: mapboxgl.Map) {\n      this._map = m;\n      const container = document.createElement('div');\n      container.className = 'mapboxgl-ctrl mapboxgl-ctrl-group';\n\n      const mkBtn = (label: string, title: string, onClick: () => void) => {\n        const b = document.createElement('button');\n        b.type = 'button';\n        b.title = title;\n        b.setAttribute('aria-label', title);\n        b.style.fontSize = '16px';\n        b.style.lineHeight = '20px';\n        b.style.fontWeight = '600';\n        b.style.display = 'flex';\n        b.style.alignItems = 'center';\n        b.style.justifyContent = 'center';\n        b.textContent = label;\n        b.addEventListener('click', (e) => {\n          e.preventDefault();\n          e.stopPropagation();\n          try {\n            onClick();\n          } catch (_) {}\n        });\n        return b;\n      };\n\n      const mkSvgBtn = (svgHtml: string, title: string, onClick: () => void) => {\n        const b = document.createElement('button');\n        b.type = 'button';\n        b.title = title;\n        b.setAttribute('aria-label', title);\n        b.style.display = 'flex';\n        b.style.alignItems = 'center';\n        b.style.justifyContent = 'center';\n        b.innerHTML = svgHtml;\n        b.addEventListener('click', (e) => {\n          e.preventDefault();\n          e.stopPropagation();\n          try {\n            onClick();\n          } catch (_) {}\n        });\n        return b;\n      };\n\n      container.appendChild(mkBtn('+', 'Zoom in', () => m.zoomIn({ duration: 250 })));\n      container.appendChild(mkBtn('âˆ’', 'Zoom out', () => m.zoomOut({ duration: 250 })));\n      container.appendChild(\n        mkBtn('âŒ‚', 'Reset view', () => {\n          m.easeTo({\n            center: [homeView.longitude, homeView.latitude],\n            zoom: Number.isFinite(homeView.zoom) ? homeView.zoom : m.getZoom(),\n            pitch: Number.isFinite(homeView.pitch ?? 0) ? (homeView.pitch ?? 0) : m.getPitch(),\n            bearing: Number.isFinite(homeView.bearing ?? 0) ? (homeView.bearing ?? 0) : m.getBearing(),\n            duration: 600\n          });\n        })\n      );\n\n      if (screenshotEnabled) {\n        container.appendChild(\n          mkSvgBtn(\n            `<svg viewBox=\"0 0 24 24\" width=\"16\" height=\"16\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.7\" stroke-linecap=\"round\" stroke-linejoin=\"round\" aria-hidden=\"true\" style=\"display:block\">\n              <path d=\"M4 8h3l1.2-2h7.6L17 8h3a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2z\"/>\n              <circle cx=\"12\" cy=\"14\" r=\"3.2\"/>\n            </svg>`,\n            'Download screenshot',\n            () => downloadScreenshot(m)\n          )\n        );\n      }\n\n      this._container = container;\n      return container;\n    }\n\n    onRemove() {\n      try {\n        this._container?.parentNode?.removeChild(this._container);\n      } catch (_) {}\n      this._map = undefined;\n      this._container = undefined;\n    }\n  }\n\n  try {\n    map.addControl(new ZoomHomeControl() as any, 'bottom-left');\n  } catch (_) {}\n\n  return { setHomeViewState };\n}\n\nfunction enableCmdDragOrbit(map: mapboxgl.Map): () => void {\n  const canvas: any = (map as any).getCanvasContainer?.() || (map as any).getCanvas?.();\n  if (!canvas) return () => {};\n\n  let active = false;\n  let startX = 0;\n  let startY = 0;\n  let startBearing = 0;\n  let startPitch = 0;\n\n  const clamp = (v: number, lo: number, hi: number) => Math.max(lo, Math.min(hi, v));\n  const PITCH_MIN = 0;\n  const PITCH_MAX = 85;\n  const SPEED_PITCH = 0.25; // degrees per pixel\n  const SPEED_BEARING = 0.35; // degrees per pixel\n\n  const stop = () => {\n    if (!active) return;\n    active = false;\n    try {\n      map.dragPan.enable();\n    } catch (_) {}\n    try {\n      canvas.style.cursor = '';\n    } catch (_) {}\n    window.removeEventListener('pointermove', onMove as any, { passive: false } as any);\n    window.removeEventListener('pointerup', onUp as any, { passive: false } as any);\n    window.removeEventListener('pointercancel', onUp as any, { passive: false } as any);\n  };\n\n  const onMove = (e: PointerEvent) => {\n    if (!active) return;\n    if (!(e as any).metaKey) return stop();\n    const dx = e.clientX - startX;\n    const dy = e.clientY - startY;\n    map.setBearing(startBearing + dx * SPEED_BEARING);\n    map.setPitch(clamp(startPitch - dy * SPEED_PITCH, PITCH_MIN, PITCH_MAX));\n    e.preventDefault();\n  };\n\n  const onUp = (e: PointerEvent) => {\n    stop();\n    try {\n      e.preventDefault();\n    } catch (_) {}\n  };\n\n  const onDown = (e: PointerEvent) => {\n    // Block Mapbox default ctrl+drag rotate so Cmd becomes the shortcut.\n    if (e.button === 0 && (e as any).ctrlKey && !(e as any).metaKey) {\n      e.preventDefault();\n      e.stopPropagation();\n      return;\n    }\n    if (active) return;\n    if (e.button !== 0) return;\n    if (!(e as any).metaKey) return;\n\n    active = true;\n    startX = e.clientX;\n    startY = e.clientY;\n    startBearing = map.getBearing();\n    startPitch = map.getPitch();\n    try {\n      map.dragPan.disable();\n    } catch (_) {}\n    try {\n      canvas.style.cursor = 'grabbing';\n    } catch (_) {}\n\n    window.addEventListener('pointermove', onMove as any, { passive: false });\n    window.addEventListener('pointerup', onUp as any, { passive: false });\n    window.addEventListener('pointercancel', onUp as any, { passive: false });\n    e.stopPropagation();\n    e.preventDefault();\n  };\n\n  canvas.addEventListener('pointerdown', onDown as any, { passive: false, capture: true });\n\n  return () => {\n    try {\n      stop();\n    } catch (_) {}\n    try {\n      canvas.removeEventListener('pointerdown', onDown as any, { capture: true } as any);\n    } catch (_) {}\n  };\n}\n\nexport function setupWidgets(map: mapboxgl.Map, initialView: ViewState, screenshotEnabled: boolean): WidgetsHandle {\n  addScaleControl(map);\n  const zh = addZoomHomeControl(map, initialView, screenshotEnabled);\n  const cleanupOrbit = enableCmdDragOrbit(map);\n\n  return {\n    destroy: () => {\n      try {\n        cleanupOrbit();\n      } catch (_) {}\n    },\n    setHomeViewState: zh?.setHomeViewState\n  };\n}\n\n\n","/**\n * Debug panel export helpers\n *\n * Pure utilities used to generate \"paste-back\" Python snippets and compact config deltas.\n * Kept separate to reduce the size/coupling of `ui/debug.ts`.\n */\n\nfunction isPlainObject(x: any) {\n  return !!x && typeof x === 'object' && !Array.isArray(x);\n}\n\nfunction deepEqual(a: any, b: any): boolean {\n  if (a === b) return true;\n  if (typeof a !== typeof b) return false;\n  if (Array.isArray(a) && Array.isArray(b)) {\n    if (a.length !== b.length) return false;\n    for (let i = 0; i < a.length; i++) if (!deepEqual(a[i], b[i])) return false;\n    return true;\n  }\n  if (isPlainObject(a) && isPlainObject(b)) {\n    const ka = Object.keys(a);\n    const kb = Object.keys(b);\n    if (ka.length !== kb.length) return false;\n    for (const k of ka) {\n      if (!(k in b)) return false;\n      if (!deepEqual(a[k], b[k])) return false;\n    }\n    return true;\n  }\n  return false;\n}\n\nexport function deepDelta(base: any, cur: any): any {\n  // Return only keys in `cur` that differ from `base`.\n  if (deepEqual(base, cur)) return undefined;\n  if (Array.isArray(cur)) return cur;\n  if (!isPlainObject(cur)) return cur;\n\n  const out: any = {};\n  for (const k of Object.keys(cur)) {\n    const d = deepDelta(base?.[k], cur[k]);\n    if (d !== undefined) out[k] = d;\n  }\n  return Object.keys(out).length ? out : undefined;\n}\n\nexport function toPyLiteral(x: any, indent = 0): string {\n  const pad = (n: number) => '  '.repeat(n);\n  const next = indent + 1;\n\n  if (x === null || x === undefined) return 'None';\n  const t = typeof x;\n  if (t === 'boolean') return x ? 'True' : 'False';\n  if (t === 'number') return Number.isFinite(x) ? String(x) : 'None';\n  if (t === 'string') {\n    // Special marker: allow embedding a raw Python symbol in the export, e.g. \"@@py:df\".\n    // This lets users get `data=df` in the paste-back snippet (the browser can't infer var names).\n    if (x.startsWith('@@py:')) {\n      const sym = x.slice('@@py:'.length).trim();\n      // Safety: only allow simple identifiers / dotted paths.\n      if (/^[A-Za-z_][A-Za-z0-9_\\\\.]*$/.test(sym)) return sym;\n    }\n    return JSON.stringify(x);\n  }\n  if (Array.isArray(x)) {\n    if (!x.length) return '[]';\n    const items = x.map((v) => `${pad(next)}${toPyLiteral(v, next)}`);\n    return `[\\n${items.join(',\\n')}\\n${pad(indent)}]`;\n  }\n  if (isPlainObject(x)) {\n    const keys = Object.keys(x);\n    if (!keys.length) return '{}';\n    const items = keys.map((k) => `${pad(next)}${JSON.stringify(k)}: ${toPyLiteral((x as any)[k], next)}`);\n    return `{\\n${items.join(',\\n')}\\n${pad(indent)}}`;\n  }\n  // Fallback for anything else\n  try {\n    return JSON.stringify(String(x));\n  } catch {\n    return 'None';\n  }\n}\n\n\n","/**\n * Debug panel palette dropdown helpers\n *\n * Encapsulates cartocolor palette listing + dropdown wiring (open/close, rebuild swatches).\n * Kept separate to reduce the size/coupling of `ui/debug.ts`.\n */\n\nexport function getPaletteNames(): string[] {\n  try {\n    return Object.keys((window as any).cartocolor || {}).sort((a, b) => a.localeCompare(b));\n  } catch (_) {\n    return [];\n  }\n}\n\nexport function setPaletteOptions(sel: HTMLSelectElement, palettes: string[]): void {\n  try {\n    sel.innerHTML = palettes.map((p) => `<option value=\"${p}\">${p}</option>`).join('');\n  } catch (_) {}\n}\n\nfunction getPaletteColors(paletteName: string, steps: number): string[] | null {\n  try {\n    const pal = (window as any).cartocolor?.[paletteName];\n    if (!pal) return null;\n    const keys = Object.keys(pal)\n      .map((x: any) => Number(x))\n      .filter((n: number) => Number.isFinite(n))\n      .sort((a: number, b: number) => a - b);\n    const best = keys.find((n: number) => n >= steps) ?? keys[keys.length - 1];\n    const cols = pal[best];\n    return Array.isArray(cols) ? [...cols] : null;\n  } catch (_) {\n    return null;\n  }\n}\n\nfunction paletteGradient(paletteName: string, steps: number, reverse: boolean): string {\n  const cols0 = getPaletteColors(paletteName, Math.max(steps, 3));\n  const cols = (reverse && cols0?.length) ? [...cols0].reverse() : cols0;\n  if (!cols?.length) return 'linear-gradient(90deg, #555, #999)';\n  const g = cols.map((c: string, i: number) => `${c} ${(i / Math.max(1, cols.length - 1)) * 100}%`).join(', ');\n  return `linear-gradient(90deg, ${g})`;\n}\n\nexport interface PaletteDropdown {\n  refresh: () => void;\n  destroy: () => void;\n}\n\ninterface DropdownOpts {\n  palettes: string[];\n  selectEl: HTMLSelectElement;\n  menuEl: HTMLElement;\n  swatchEl: HTMLElement;\n  triggerEl: HTMLButtonElement;\n  getSteps: () => number;\n  getReverse: () => boolean;\n  onPicked: () => void;\n  closeAll: () => void;\n}\n\nfunction buildMenu(opts: DropdownOpts) {\n  const reverse = !!opts.getReverse();\n  const steps = Math.max(2, Math.min(20, opts.getSteps()));\n  opts.menuEl.innerHTML = opts.palettes\n    .map((p) => {\n      const bg = paletteGradient(p, steps, reverse);\n      return `<div class=\"pal-item\" data-pal=\"${p}\" title=\"${p}\">\n        <div class=\"pal-item-swatch\" style=\"background:${bg};\"></div>\n      </div>`;\n    })\n    .join('');\n\n  opts.menuEl.querySelectorAll('.pal-item').forEach((el) => {\n    el.addEventListener('click', (e) => {\n      try {\n        e.preventDefault();\n        e.stopPropagation();\n      } catch (_) {}\n      const pal = (el as HTMLElement).getAttribute('data-pal') || '';\n      if (pal) opts.selectEl.value = pal;\n      opts.menuEl.style.display = 'none';\n      try {\n        opts.onPicked();\n      } catch (_) {}\n    });\n  });\n}\n\nfunction updateSwatch(opts: DropdownOpts) {\n  try {\n    const reverse = !!opts.getReverse();\n    const steps = Math.max(2, Math.min(20, opts.getSteps()));\n    const name = opts.selectEl.value || 'Palette';\n    opts.swatchEl.style.background = paletteGradient(name, steps, reverse);\n    opts.triggerEl.title = name;\n  } catch (_) {}\n}\n\nexport function createPaletteDropdownManager(palettes: string[]): {\n  attach: (opts: Omit<DropdownOpts, 'palettes' | 'closeAll'>) => PaletteDropdown;\n  refreshAll: () => void;\n  destroy: () => void;\n} {\n  const menus: HTMLElement[] = [];\n  const attached: PaletteDropdown[] = [];\n\n  const closeAll = () => {\n    try {\n      menus.forEach((m) => {\n        try {\n          m.style.display = 'none';\n        } catch (_) {}\n      });\n    } catch (_) {}\n  };\n\n  const onDocClick = () => closeAll();\n\n  try {\n    document.addEventListener('click', onDocClick);\n    window.addEventListener('blur', onDocClick);\n  } catch (_) {}\n\n  const attach = (partial: Omit<DropdownOpts, 'palettes' | 'closeAll'>): PaletteDropdown => {\n    const opts: DropdownOpts = { ...partial, palettes, closeAll };\n    menus.push(opts.menuEl);\n\n    // Initial build\n    try {\n      buildMenu(opts);\n      updateSwatch(opts);\n    } catch (_) {}\n\n    const onTrigger = (e: Event) => {\n      try {\n        e.preventDefault();\n        e.stopPropagation();\n      } catch (_) {}\n      const isOpen = opts.menuEl.style.display !== 'none';\n      opts.closeAll();\n      // Rebuild each open so gradient reflects current steps/reverse.\n      try {\n        buildMenu(opts);\n        updateSwatch(opts);\n      } catch (_) {}\n      opts.menuEl.style.display = isOpen ? 'none' : 'block';\n    };\n\n    try {\n      opts.triggerEl.addEventListener('click', onTrigger);\n    } catch (_) {}\n\n    const dropdown: PaletteDropdown = {\n      refresh: () => {\n        try {\n          buildMenu(opts);\n          updateSwatch(opts);\n        } catch (_) {}\n      },\n      destroy: () => {\n        try {\n          opts.triggerEl.removeEventListener('click', onTrigger);\n        } catch (_) {}\n        try {\n          const idx = menus.indexOf(opts.menuEl);\n          if (idx >= 0) menus.splice(idx, 1);\n        } catch (_) {}\n      }\n    };\n    attached.push(dropdown);\n    return dropdown;\n  };\n\n  return {\n    attach,\n    refreshAll: () => {\n      try {\n        attached.forEach((d) => d.refresh());\n      } catch (_) {}\n    },\n    destroy: () => {\n      try {\n        attached.forEach((d) => d.destroy());\n      } catch (_) {}\n      try {\n        document.removeEventListener('click', onDocClick);\n        window.removeEventListener('blur', onDocClick);\n      } catch (_) {}\n    }\n  };\n}\n\n\n","/**\n * Debug panel DOM template + element lookup\n *\n * Keeps `ui/debug.ts` focused on behavior rather than giant HTML strings and querySelector boilerplate.\n */\n\nexport type SidebarMode = 'show' | 'hide' | null;\n\nexport const DEBUG_SHELL_ID = 'debug-shell';\n\nexport function getDebugShellHtml(): string {\n  // NOTE: Keep IDs stable; many callers query by id.\n  return `\n      <div id=\"debug-panel\">\n        <div id=\"debug-content\">\n          <div class=\"debug-tabs\" role=\"tablist\" aria-label=\"Debug tabs\">\n            <button type=\"button\" class=\"debug-tab-btn active\" id=\"dbg-tab-btn-ui\" data-tab=\"ui\" role=\"tab\" aria-selected=\"true\">UI</button>\n            <button type=\"button\" class=\"debug-tab-btn\" id=\"dbg-tab-btn-sql\" data-tab=\"sql\" role=\"tab\" aria-selected=\"false\">SQL</button>\n            <button type=\"button\" class=\"debug-tab-btn\" id=\"dbg-tab-btn-ai\" data-tab=\"ai\" role=\"tab\" aria-selected=\"false\">AI</button>\n          </div>\n\n          <div class=\"debug-tab-panel\" id=\"dbg-tab-panel-ui\" role=\"tabpanel\" aria-label=\"UI tab\">\n          <div class=\"debug-section\">\n            <div class=\"debug-section-title\">Editing Layer</div>\n            <div class=\"debug-row\">\n              <span class=\"debug-label\">Layer</span>\n              <select class=\"debug-select\" id=\"dbg-layer-select\"></select>\n            </div>\n          </div>\n\n          <div class=\"debug-section\" id=\"dbg-hex-section\">\n            <div class=\"debug-section-title\">Hex Layer</div>\n            <div class=\"debug-toggles\">\n              <label class=\"debug-checkbox\"><input type=\"checkbox\" id=\"dbg-filled\" checked /> Filled</label>\n              <label class=\"debug-checkbox\"><input type=\"checkbox\" id=\"dbg-stroked\" checked /> Stroked</label>\n              <label class=\"debug-checkbox\"><input type=\"checkbox\" id=\"dbg-extruded\" /> Extruded</label>\n            </div>\n            <div id=\"dbg-extrusion-controls\" style=\"display:none;margin-top:8px;\">\n              <div class=\"debug-row\">\n                <span class=\"debug-label\">Height attr</span>\n                <select class=\"debug-select\" id=\"dbg-elev-attr\"></select>\n              </div>\n              <div class=\"debug-row\">\n                <span class=\"debug-label\">Height scale</span>\n                <input type=\"number\" class=\"debug-input debug-input-sm\" id=\"dbg-elev-scale\" step=\"0.1\" value=\"1\" />\n              </div>\n            </div>\n            <div class=\"debug-row\" style=\"margin-top:8px;\">\n              <span class=\"debug-label\">Opacity</span>\n              <input type=\"range\" class=\"debug-slider\" id=\"dbg-opacity-slider\" min=\"0\" max=\"1\" step=\"0.05\" value=\"1\" />\n              <input type=\"number\" class=\"debug-input debug-input-sm\" id=\"dbg-opacity\" step=\"0.1\" min=\"0\" max=\"1\" value=\"1\" />\n            </div>\n          </div>\n\n          <div class=\"debug-section\" id=\"fill-color-section\">\n            <div class=\"debug-section-title\">Fill Color</div>\n            <div class=\"debug-row\">\n              <span class=\"debug-label\">Function</span>\n              <select class=\"debug-select\" id=\"dbg-fill-fn\">\n                <option value=\"colorContinuous\">colorContinuous</option>\n                <option value=\"static\">Static Color</option>\n              </select>\n            </div>\n            <div id=\"fill-fn-options\">\n              <div class=\"debug-row\">\n                <span class=\"debug-label\">Attribute</span>\n                <select class=\"debug-select\" id=\"dbg-attr\"></select>\n              </div>\n              <div class=\"debug-row\">\n                <span class=\"debug-label\">Palette</span>\n                <select class=\"debug-select pal-hidden\" id=\"dbg-palette\"></select>\n                <div class=\"pal-dd\" id=\"dbg-palette-dd\">\n                  <button type=\"button\" class=\"pal-trigger\" id=\"dbg-palette-trigger\" title=\"Palette\">\n                    <span class=\"pal-name\" id=\"dbg-palette-name\">Palette</span>\n                    <span class=\"pal-swatch\" id=\"dbg-palette-swatch\"></span>\n                  </button>\n                  <div class=\"pal-menu\" id=\"dbg-palette-menu\" style=\"display:none;\"></div>\n                </div>\n              </div>\n              <div class=\"debug-row\">\n                <span class=\"debug-label\"></span>\n                <label class=\"debug-checkbox\" style=\"margin-left:auto;\"><input type=\"checkbox\" id=\"dbg-fill-reverse\" /> Reverse</label>\n              </div>\n              <div class=\"debug-row\">\n                <span class=\"debug-label\">Domain</span>\n                <input type=\"number\" class=\"debug-input debug-input-sm\" id=\"dbg-domain-min\" step=\"0.1\" placeholder=\"min\" />\n                <span style=\"color:#666;\">â€“</span>\n                <input type=\"number\" class=\"debug-input debug-input-sm\" id=\"dbg-domain-max\" step=\"0.1\" placeholder=\"max\" />\n              </div>\n            <div class=\"debug-row\">\n              <span class=\"debug-label\"></span>\n              <div class=\"debug-dual-range\" aria-label=\"Domain range\">\n                <input type=\"range\" class=\"debug-range-min\" id=\"dbg-domain-range-min\" min=\"0\" max=\"100\" step=\"0.1\" value=\"0\" />\n                <input type=\"range\" class=\"debug-range-max\" id=\"dbg-domain-range-max\" min=\"0\" max=\"100\" step=\"0.1\" value=\"100\" />\n              </div>\n            </div>\n              <div class=\"debug-row\">\n                <span class=\"debug-label\">Steps</span>\n                <input type=\"number\" class=\"debug-input debug-input-sm\" id=\"dbg-steps\" step=\"1\" min=\"2\" max=\"20\" value=\"7\" />\n              </div>\n              <div class=\"debug-row\">\n                <span class=\"debug-label\">Null Color</span>\n                <input type=\"color\" class=\"debug-color\" id=\"dbg-null-color\" value=\"#b8b8b8\" />\n                <span class=\"debug-color-label\" id=\"dbg-null-color-label\">#b8b8b8</span>\n              </div>\n            </div>\n            <div id=\"fill-static-options\" style=\"display:none;\">\n              <div class=\"debug-row\">\n                <span class=\"debug-label\">Color</span>\n                <input type=\"color\" class=\"debug-color\" id=\"dbg-fill-static\" value=\"#0090ff\" />\n                <span class=\"debug-color-label\" id=\"dbg-fill-static-label\">#0090ff</span>\n              </div>\n            </div>\n          </div>\n\n          <div class=\"debug-section\" id=\"line-color-section\">\n            <div class=\"debug-section-title\">Line Color</div>\n            <div class=\"debug-row\">\n              <span class=\"debug-label\">Function</span>\n              <select class=\"debug-select\" id=\"dbg-line-fn\">\n                <option value=\"colorContinuous\">colorContinuous</option>\n                <option value=\"static\" selected>Static Color</option>\n              </select>\n            </div>\n            <div id=\"line-fn-options\" style=\"display:none;\">\n              <div class=\"debug-row\">\n                <span class=\"debug-label\">Attribute</span>\n                <select class=\"debug-select\" id=\"dbg-line-attr\"></select>\n              </div>\n              <div class=\"debug-row\">\n                <span class=\"debug-label\">Palette</span>\n                <select class=\"debug-select pal-hidden\" id=\"dbg-line-palette\"></select>\n                <div class=\"pal-dd\" id=\"dbg-line-palette-dd\">\n                  <button type=\"button\" class=\"pal-trigger\" id=\"dbg-line-palette-trigger\" title=\"Palette\">\n                    <span class=\"pal-name\" id=\"dbg-line-palette-name\">Palette</span>\n                    <span class=\"pal-swatch\" id=\"dbg-line-palette-swatch\"></span>\n                  </button>\n                  <div class=\"pal-menu\" id=\"dbg-line-palette-menu\" style=\"display:none;\"></div>\n                </div>\n              </div>\n              <div class=\"debug-row\">\n                <span class=\"debug-label\"></span>\n                <label class=\"debug-checkbox\" style=\"margin-left:auto;\"><input type=\"checkbox\" id=\"dbg-line-reverse\" /> Reverse</label>\n              </div>\n              <div class=\"debug-row\">\n                <span class=\"debug-label\">Domain</span>\n                <input type=\"number\" class=\"debug-input debug-input-sm\" id=\"dbg-line-domain-min\" step=\"0.1\" placeholder=\"min\" />\n                <span style=\"color:#666;\">â€“</span>\n                <input type=\"number\" class=\"debug-input debug-input-sm\" id=\"dbg-line-domain-max\" step=\"0.1\" placeholder=\"max\" />\n              </div>\n            </div>\n            <div id=\"line-static-options\">\n              <div class=\"debug-row\">\n                <span class=\"debug-label\">Color</span>\n                <input type=\"color\" class=\"debug-color\" id=\"dbg-line-static\" value=\"#ffffff\" />\n                <span class=\"debug-color-label\" id=\"dbg-line-static-label\">#ffffff</span>\n              </div>\n              <div class=\"debug-row\">\n                <span class=\"debug-label\">Line Width</span>\n                <input type=\"range\" class=\"debug-slider\" id=\"dbg-line-width-slider\" min=\"0\" max=\"5\" step=\"0.5\" value=\"1\" />\n                <input type=\"number\" class=\"debug-input debug-input-sm\" id=\"dbg-line-width\" step=\"0.5\" min=\"0\" max=\"10\" value=\"1\" />\n              </div>\n            </div>\n          </div>\n\n          <div class=\"debug-section\" id=\"dbg-viewstate-section\">\n            <div class=\"debug-section-title\">View State</div>\n            <div class=\"debug-row\">\n              <span class=\"debug-label\">Longitude</span>\n              <input type=\"number\" class=\"debug-input\" id=\"dbg-lng\" step=\"0.0001\" />\n            </div>\n            <div class=\"debug-row\">\n              <span class=\"debug-label\">Latitude</span>\n              <input type=\"number\" class=\"debug-input\" id=\"dbg-lat\" step=\"0.0001\" />\n            </div>\n            <div class=\"debug-row\">\n              <span class=\"debug-label\">Zoom</span>\n              <input type=\"number\" class=\"debug-input\" id=\"dbg-zoom\" step=\"0.1\" min=\"0\" max=\"22\" />\n            </div>\n            <div class=\"debug-row\">\n              <span class=\"debug-label\">Pitch</span>\n              <input type=\"number\" class=\"debug-input\" id=\"dbg-pitch\" step=\"1\" min=\"0\" max=\"85\" />\n            </div>\n            <div class=\"debug-row\">\n              <span class=\"debug-label\">Bearing</span>\n              <input type=\"number\" class=\"debug-input\" id=\"dbg-bearing\" step=\"1\" />\n            </div>\n          </div>\n\n          <div class=\"debug-section\">\n            <details id=\"dbg-view-details\">\n              <summary class=\"debug-section-title\" style=\"cursor:pointer; user-select:none;\">Current ViewState</summary>\n              <textarea id=\"dbg-view-output\" class=\"debug-output\" readonly></textarea>\n            </details>\n          </div>\n\n          <div class=\"debug-section\">\n            <div class=\"debug-section-title\">Layer Config</div>\n            <textarea id=\"dbg-output\" class=\"debug-output\" readonly></textarea>\n          </div>\n          </div>\n\n          <div class=\"debug-tab-panel\" id=\"dbg-tab-panel-sql\" role=\"tabpanel\" aria-label=\"SQL tab\" style=\"display:none;\">\n            <div class=\"debug-section\" id=\"sql-section\">\n              <div class=\"debug-section-title\">SQL <span id=\"sql-status\" style=\"float:right;font-weight:normal;color:var(--ui-muted-2);\"></span></div>\n              <textarea id=\"dbg-sql\" class=\"debug-output\" style=\"height:80px;font-family:monospace;font-size:11px;resize:vertical;\" placeholder=\"WHERE expression (e.g. data = 111)\\nâ€”orâ€”\\nFull SQL (SELECT ... FROM data ...)\"></textarea>\n            </div>\n          </div>\n\n          <div class=\"debug-tab-panel\" id=\"dbg-tab-panel-ai\" role=\"tabpanel\" aria-label=\"AI tab\" style=\"display:none;\">\n            <div class=\"debug-section\" id=\"ai-section\">\n              <div class=\"debug-section-title\">AI SQL Assistant <span id=\"ai-status\" style=\"float:right;font-weight:normal;color:var(--ui-muted-2);\"></span></div>\n              <div id=\"ai-chat\" class=\"ai-chat-container\"></div>\n              <div id=\"ai-sql-preview\" class=\"ai-sql-preview-container\" style=\"display:none;\"></div>\n              <div class=\"ai-input-row\">\n                <textarea id=\"ai-input\" class=\"debug-input ai-input\" placeholder=\"Ask: &quot;Show hexes where pct > 50&quot;\" rows=\"2\"></textarea>\n                <button type=\"button\" id=\"ai-send\" class=\"ai-send-btn\" title=\"Send\">&#10148;</button>\n              </div>\n            </div>\n          </div>\n        </div>\n        <div id=\"debug-resize-handle\" title=\"Drag to resize\"></div>\n      </div>\n      <div id=\"debug-toggle\" title=\"Toggle sidebar\">&#x2039;</div>\n  `;\n}\n\nexport interface DebugShell {\n  shell: HTMLElement;\n  panel: HTMLElement;\n  toggle: HTMLElement;\n  resizeHandle: HTMLElement;\n}\n\nexport function ensureDebugShell(): DebugShell {\n  let shell = document.getElementById(DEBUG_SHELL_ID) as HTMLElement | null;\n  if (!shell) {\n    shell = document.createElement('div');\n    shell.id = DEBUG_SHELL_ID;\n    shell.innerHTML = getDebugShellHtml();\n    document.body.appendChild(shell);\n  }\n\n  const panel = document.getElementById('debug-panel') as HTMLElement | null;\n  const toggle = document.getElementById('debug-toggle') as HTMLElement | null;\n  const resizeHandle = document.getElementById('debug-resize-handle') as HTMLElement | null;\n\n  if (!panel || !toggle || !resizeHandle) {\n    // Should never happen unless template IDs were changed.\n    throw new Error('[FusedMaps] Debug panel DOM missing expected elements');\n  }\n\n  return { shell, panel, toggle, resizeHandle };\n}\n\nexport interface DebugElements {\n  layerSelect: HTMLSelectElement;\n\n  hexSection: HTMLElement;\n  viewStateSection: HTMLElement;\n  fillColorSection: HTMLElement;\n  lineColorSection: HTMLElement;\n\n  filledEl: HTMLInputElement;\n  strokedEl: HTMLInputElement;\n  extrudedEl: HTMLInputElement;\n  extrusionControls: HTMLElement;\n  elevAttrEl: HTMLSelectElement;\n  elevScaleEl: HTMLInputElement;\n  opacitySliderEl: HTMLInputElement;\n  opacityEl: HTMLInputElement;\n\n  fillFnEl: HTMLSelectElement;\n  fillFnOptions: HTMLElement;\n  fillStaticOptions: HTMLElement;\n  fillAttrEl: HTMLSelectElement;\n  fillPaletteEl: HTMLSelectElement;\n  fillPalTrigger: HTMLButtonElement;\n  fillPalSwatch: HTMLElement;\n  fillPalMenu: HTMLElement;\n  fillDomainMinEl: HTMLInputElement;\n  fillDomainMaxEl: HTMLInputElement;\n  fillRangeMinEl: HTMLInputElement;\n  fillRangeMaxEl: HTMLInputElement;\n  fillStepsEl: HTMLInputElement;\n  fillReverseEl: HTMLInputElement;\n  fillNullEl: HTMLInputElement;\n  fillNullLabel: HTMLElement;\n  fillStaticEl: HTMLInputElement;\n  fillStaticLabel: HTMLElement;\n\n  lineFnEl: HTMLSelectElement;\n  lineFnOptions: HTMLElement;\n  lineStaticOptions: HTMLElement;\n  lineAttrEl: HTMLSelectElement;\n  linePaletteEl: HTMLSelectElement;\n  linePalTrigger: HTMLButtonElement;\n  linePalSwatch: HTMLElement;\n  linePalMenu: HTMLElement;\n  lineDomainMinEl: HTMLInputElement;\n  lineDomainMaxEl: HTMLInputElement;\n  lineReverseEl: HTMLInputElement;\n  lineStaticEl: HTMLInputElement;\n  lineStaticLabel: HTMLElement;\n  lineWidthSliderEl: HTMLInputElement;\n  lineWidthEl: HTMLInputElement;\n\n  lngEl: HTMLInputElement;\n  latEl: HTMLInputElement;\n  zoomEl: HTMLInputElement;\n  pitchEl: HTMLInputElement;\n  bearingEl: HTMLInputElement;\n  viewOut: HTMLTextAreaElement;\n  layerOut: HTMLTextAreaElement;\n\n  sqlSection: HTMLElement;\n  sqlStatusEl: HTMLElement;\n  sqlInputEl: HTMLTextAreaElement;\n\n  aiSection: HTMLElement;\n  aiChatEl: HTMLElement;\n  aiInputEl: HTMLTextAreaElement;\n  aiSendBtn: HTMLButtonElement;\n  aiStatusEl: HTMLElement;\n  aiSqlPreviewEl: HTMLElement;\n}\n\nconst elementIds: Record<keyof DebugElements, string> = {\n  layerSelect: 'dbg-layer-select',\n  hexSection: 'dbg-hex-section',\n  viewStateSection: 'dbg-viewstate-section',\n  fillColorSection: 'fill-color-section',\n  lineColorSection: 'line-color-section',\n  filledEl: 'dbg-filled',\n  strokedEl: 'dbg-stroked',\n  extrudedEl: 'dbg-extruded',\n  extrusionControls: 'dbg-extrusion-controls',\n  elevAttrEl: 'dbg-elev-attr',\n  elevScaleEl: 'dbg-elev-scale',\n  opacitySliderEl: 'dbg-opacity-slider',\n  opacityEl: 'dbg-opacity',\n  fillFnEl: 'dbg-fill-fn',\n  fillFnOptions: 'fill-fn-options',\n  fillStaticOptions: 'fill-static-options',\n  fillAttrEl: 'dbg-attr',\n  fillPaletteEl: 'dbg-palette',\n  fillPalTrigger: 'dbg-palette-trigger',\n  fillPalSwatch: 'dbg-palette-swatch',\n  fillPalMenu: 'dbg-palette-menu',\n  fillDomainMinEl: 'dbg-domain-min',\n  fillDomainMaxEl: 'dbg-domain-max',\n  fillRangeMinEl: 'dbg-domain-range-min',\n  fillRangeMaxEl: 'dbg-domain-range-max',\n  fillStepsEl: 'dbg-steps',\n  fillReverseEl: 'dbg-fill-reverse',\n  fillNullEl: 'dbg-null-color',\n  fillNullLabel: 'dbg-null-color-label',\n  fillStaticEl: 'dbg-fill-static',\n  fillStaticLabel: 'dbg-fill-static-label',\n  lineFnEl: 'dbg-line-fn',\n  lineFnOptions: 'line-fn-options',\n  lineStaticOptions: 'line-static-options',\n  lineAttrEl: 'dbg-line-attr',\n  linePaletteEl: 'dbg-line-palette',\n  linePalTrigger: 'dbg-line-palette-trigger',\n  linePalSwatch: 'dbg-line-palette-swatch',\n  linePalMenu: 'dbg-line-palette-menu',\n  lineDomainMinEl: 'dbg-line-domain-min',\n  lineDomainMaxEl: 'dbg-line-domain-max',\n  lineReverseEl: 'dbg-line-reverse',\n  lineStaticEl: 'dbg-line-static',\n  lineStaticLabel: 'dbg-line-static-label',\n  lineWidthSliderEl: 'dbg-line-width-slider',\n  lineWidthEl: 'dbg-line-width',\n  lngEl: 'dbg-lng',\n  latEl: 'dbg-lat',\n  zoomEl: 'dbg-zoom',\n  pitchEl: 'dbg-pitch',\n  bearingEl: 'dbg-bearing',\n  viewOut: 'dbg-view-output',\n  layerOut: 'dbg-output',\n  sqlSection: 'sql-section',\n  sqlStatusEl: 'sql-status',\n  sqlInputEl: 'dbg-sql',\n  aiSection: 'ai-section',\n  aiChatEl: 'ai-chat',\n  aiInputEl: 'ai-input',\n  aiSendBtn: 'ai-send',\n  aiStatusEl: 'ai-status',\n  aiSqlPreviewEl: 'ai-sql-preview',\n};\n\nexport function queryDebugElements(): DebugElements {\n  const result = {} as DebugElements;\n  for (const [key, id] of Object.entries(elementIds)) {\n    const el = document.getElementById(id);\n    if (!el) throw new Error(`[FusedMaps] Debug panel missing element #${id}`);\n    (result as any)[key] = el;\n  }\n  return result;\n}\n\n\n","/**\n * Shared utility functions\n */\n\n/**\n * Clamp a number between min and max\n */\nexport function clamp(v: number, lo: number, hi: number): number {\n  return Math.max(lo, Math.min(hi, v));\n}\n\n/**\n * Safely execute a function, swallowing errors\n */\nexport function safe(fn: () => void): void {\n  try { fn(); } catch {}\n}\n\n/**\n * Parse hex color string to RGB array\n * @param hex - Color string like \"#ff0000\"\n * @param alpha - Optional alpha value (0-255)\n * @returns [r, g, b] or [r, g, b, a] array, or null if invalid\n */\nexport function parseHexColor(hex: string, alpha?: number): number[] | null {\n  try {\n    const c = String(hex || '').trim();\n    if (!/^#[0-9a-fA-F]{6}$/.test(c)) return null;\n    const r = parseInt(c.slice(1, 3), 16);\n    const g = parseInt(c.slice(3, 5), 16);\n    const b = parseInt(c.slice(5, 7), 16);\n    if (typeof alpha === 'number' && Number.isFinite(alpha)) {\n      return [r, g, b, clamp(Math.round(alpha), 0, 255)];\n    }\n    return [r, g, b];\n  } catch {\n    return null;\n  }\n}\n\n/**\n * Convert RGB array to hex string\n */\nexport function rgbToHex(rgb: number[]): string {\n  if (!Array.isArray(rgb) || rgb.length < 3) return '#888888';\n  return '#' + rgb.slice(0, 3)\n    .map(x => clamp(Math.round(x), 0, 255).toString(16).padStart(2, '0'))\n    .join('');\n}\n\n/**\n * Format number with fixed decimal places\n */\nexport function fmt(n: number, digits: number): string {\n  try {\n    return Number.isFinite(n) ? n.toFixed(digits) : '';\n  } catch {\n    return '';\n  }\n}\n","/**\n * Debug panel \"apply UI -> layer config + map style updates\"\n *\n * Extracted from `ui/debug.ts` to reduce file size and make behavior testable in isolation.\n * This module mutates the in-memory layer config objects (same as legacy behavior).\n */\n\nimport type { HexLayerConfig } from '../../types';\nimport { hexToGeoJSON, updateStaticHexLayer } from '../../layers/hex';\nimport { getLayerGeoJSONs } from '../../layers';\nimport { buildColorExpr } from '../../color/expressions';\nimport { buildPMTilesColorExpression } from '../../layers/pmtiles';\nimport { clamp, parseHexColor } from '../../utils';\n\nfunction getCurrentLayerVisibility(map: mapboxgl.Map, layerId: string): boolean {\n  try {\n    const style: any = map.getStyle?.();\n    const layers: any[] = style?.layers || [];\n    const ids = [`${layerId}-fill`, `${layerId}-extrusion`, `${layerId}-outline`];\n    for (const id of ids) {\n      const l = layers.find((x: any) => x && x.id === id);\n      if (!l) continue;\n      return l.layout?.visibility !== 'none';\n    }\n  } catch {}\n  return true;\n}\n\nfunction setPaintSafe(map: mapboxgl.Map, layerId: string, prop: string, value: any) {\n  try {\n    if (map.getLayer(layerId)) map.setPaintProperty(layerId, prop as any, value as any);\n  } catch {}\n}\n\nfunction setPaintBatch(map: mapboxgl.Map, prefix: string, props: Record<string, any>) {\n  try {\n    const layers: any[] = (map.getStyle?.()?.layers || []) as any[];\n    for (const l of layers) {\n      const id = l?.id as string | undefined;\n      if (id && id.startsWith(prefix) && map.getLayer(id)) {\n        for (const [prop, value] of Object.entries(props)) {\n          try { map.setPaintProperty(id, prop as any, value as any); } catch {}\n        }\n      }\n    }\n  } catch {}\n}\n\nexport interface DebugApplyElements {\n  filledEl: HTMLInputElement;\n  strokedEl: HTMLInputElement;\n  extrudedEl: HTMLInputElement;\n  extrusionControls: HTMLElement;\n  elevAttrEl: HTMLSelectElement;\n  elevScaleEl: HTMLInputElement;\n  opacityEl: HTMLInputElement;\n\n  fillFnEl: HTMLSelectElement;\n  fillAttrEl: HTMLSelectElement;\n  fillPaletteEl: HTMLSelectElement;\n  fillReverseEl: HTMLInputElement;\n  fillDomainMinEl: HTMLInputElement;\n  fillDomainMaxEl: HTMLInputElement;\n  fillStepsEl: HTMLInputElement;\n  fillNullEl: HTMLInputElement;\n  fillStaticEl: HTMLInputElement;\n\n  lineFnEl: HTMLSelectElement;\n  lineAttrEl: HTMLSelectElement;\n  linePaletteEl: HTMLSelectElement;\n  lineReverseEl: HTMLInputElement;\n  lineDomainMinEl: HTMLInputElement;\n  lineDomainMaxEl: HTMLInputElement;\n  lineStaticEl: HTMLInputElement;\n  lineWidthEl: HTMLInputElement;\n}\n\nexport interface ApplyDebugUIOpts {\n  map: mapboxgl.Map;\n  layer: any;\n  els: DebugApplyElements;\n  updateLayerOutput: () => void;\n  findDeckOverlayOnMap: () => void;\n  rebuildDeck: () => void;\n}\n\nexport function applyDebugUIToLayer(opts: ApplyDebugUIOpts): void {\n  const { map, layer, els, updateLayerOutput, findDeckOverlayOnMap, rebuildDeck } = opts;\n  if (!layer) return;\n\n  const isHex = layer.layerType === 'hex';\n  const isVector = layer.layerType === 'vector';\n  const isPmtiles = layer.layerType === 'pmtiles';\n\n  if (isHex) {\n    layer.hexLayer = layer.hexLayer || {};\n  }\n  const hexCfg: any = isHex ? layer.hexLayer : {};\n\n  const op = parseFloat(els.opacityEl.value);\n  const opClamped = Number.isFinite(op) ? clamp(op, 0, 1) : 1;\n\n  if (isHex) {\n    hexCfg.filled = !!els.filledEl.checked;\n    hexCfg.stroked = !!els.strokedEl.checked;\n    hexCfg.extruded = !!els.extrudedEl.checked;\n    hexCfg.opacity = opClamped;\n\n    // Extrusion controls (hex only)\n    try {\n      if (els.extrusionControls) els.extrusionControls.style.display = hexCfg.extruded ? 'block' : 'none';\n      const s = parseFloat(els.elevScaleEl?.value || '1');\n      hexCfg.elevationScale = Number.isFinite(s) ? s : 1;\n      const ep = String(els.elevAttrEl?.value || '').trim();\n      if (ep) hexCfg.elevationProperty = ep;\n      else delete hexCfg.elevationProperty;\n    } catch (_) {}\n  } else if (isVector || isPmtiles) {\n    layer.isFilled = !!els.filledEl.checked;\n    layer.isStroked = !!els.strokedEl.checked;\n    layer.opacity = opClamped;\n    try {\n      layer.vectorLayer = { ...(layer.vectorLayer || {}), filled: !!els.filledEl.checked, stroked: !!els.strokedEl.checked, opacity: opClamped };\n    } catch (_) {}\n  }\n\n  // Fill\n  if (isHex) {\n    if (els.fillFnEl.value === 'static') {\n      const c = els.fillStaticEl.value || '#0090ff';\n      const r = parseInt(c.slice(1, 3), 16);\n      const g = parseInt(c.slice(3, 5), 16);\n      const b = parseInt(c.slice(5, 7), 16);\n      hexCfg.getFillColor = [r, g, b];\n    } else {\n      const attr = els.fillAttrEl.value || 'data_avg';\n      const colors = els.fillPaletteEl.value || 'Earth';\n      const reverse = !!els.fillReverseEl.checked;\n      const d0 = parseFloat(els.fillDomainMinEl.value);\n      const d1 = parseFloat(els.fillDomainMaxEl.value);\n      const steps = parseInt(els.fillStepsEl.value || '7', 10);\n      const nc = els.fillNullEl.value || '#b8b8b8';\n      const nr = parseInt(nc.slice(1, 3), 16);\n      const ng = parseInt(nc.slice(3, 5), 16);\n      const nb = parseInt(nc.slice(5, 7), 16);\n      hexCfg.getFillColor = {\n        '@@function': 'colorContinuous',\n        attr,\n        domain: [Number.isFinite(d0) ? d0 : 0, Number.isFinite(d1) ? d1 : 1],\n        colors,\n        reverse,\n        steps: Number.isFinite(steps) ? steps : 7,\n        nullColor: [nr, ng, nb],\n        // Default to autoDomain unless user explicitly overrides the domain.\n        autoDomain: (hexCfg.getFillColor?.autoDomain !== false)\n      };\n    }\n  } else if (isVector || isPmtiles) {\n    if (els.fillFnEl.value === 'static') {\n      const c = els.fillStaticEl.value || '#0090ff';\n      layer.fillColorConfig = null;\n      layer.fillColorRgba = c;\n      try {\n        const arr = parseHexColor(c, 200) || parseHexColor(c);\n        if (layer.vectorLayer) layer.vectorLayer.getFillColor = arr || c;\n      } catch {}\n    } else {\n      const attr = els.fillAttrEl.value || 'value';\n      const colors = els.fillPaletteEl.value || 'ArmyRose';\n      const reverse = !!els.fillReverseEl.checked;\n      const d0 = parseFloat(els.fillDomainMinEl.value);\n      const d1 = parseFloat(els.fillDomainMaxEl.value);\n      const steps = parseInt(els.fillStepsEl.value || '7', 10);\n      const nc = els.fillNullEl.value || '#b8b8b8';\n      const nr = parseInt(nc.slice(1, 3), 16);\n      const ng = parseInt(nc.slice(3, 5), 16);\n      const nb = parseInt(nc.slice(5, 7), 16);\n      layer.fillColorRgba = null;\n      const cfgObj = {\n        '@@function': 'colorContinuous',\n        attr,\n        domain: [Number.isFinite(d0) ? d0 : 0, Number.isFinite(d1) ? d1 : 1],\n        colors,\n        reverse,\n        steps: Number.isFinite(steps) ? steps : 7,\n        nullColor: [nr, ng, nb],\n      };\n      layer.fillColorConfig = cfgObj;\n      if (isPmtiles) layer.colorAttribute = attr;\n      try {\n        if (layer.vectorLayer) layer.vectorLayer.getFillColor = cfgObj;\n      } catch (_) {}\n    }\n  }\n\n  // Line\n  if (isHex) {\n    if (els.lineFnEl.value === 'static') {\n      const c = els.lineStaticEl.value || '#ffffff';\n      const r = parseInt(c.slice(1, 3), 16);\n      const g = parseInt(c.slice(3, 5), 16);\n      const b = parseInt(c.slice(5, 7), 16);\n      hexCfg.getLineColor = [r, g, b];\n    } else {\n      const attr = els.lineAttrEl.value || 'data_avg';\n      const colors = els.linePaletteEl.value || 'Earth';\n      const reverse = !!els.lineReverseEl.checked;\n      const d0 = parseFloat(els.lineDomainMinEl.value);\n      const d1 = parseFloat(els.lineDomainMaxEl.value);\n      hexCfg.getLineColor = {\n        '@@function': 'colorContinuous',\n        attr,\n        domain: [Number.isFinite(d0) ? d0 : 0, Number.isFinite(d1) ? d1 : 1],\n        colors,\n        reverse,\n        steps: parseInt(els.fillStepsEl.value || '7', 10) || 7,\n        autoDomain: (hexCfg.getLineColor?.autoDomain !== false)\n      };\n    }\n  } else if (isVector || isPmtiles) {\n    if (els.lineFnEl.value === 'static') {\n      const c = els.lineStaticEl.value || '#ffffff';\n      layer.lineColorConfig = null;\n      layer.lineColorRgba = c;\n      try {\n        const arr = parseHexColor(c, 255) || parseHexColor(c);\n        if (layer.vectorLayer) layer.vectorLayer.getLineColor = arr || c;\n      } catch {}\n    } else {\n      const attr = els.lineAttrEl.value || 'value';\n      const colors = els.linePaletteEl.value || 'ArmyRose';\n      const reverse = !!els.lineReverseEl.checked;\n      const d0 = parseFloat(els.lineDomainMinEl.value);\n      const d1 = parseFloat(els.lineDomainMaxEl.value);\n      layer.lineColorRgba = null;\n      const cfgObj = {\n        '@@function': 'colorContinuous',\n        attr,\n        domain: [Number.isFinite(d0) ? d0 : 0, Number.isFinite(d1) ? d1 : 1],\n        colors,\n        reverse,\n        steps: parseInt(els.fillStepsEl.value || '7', 10) || 7,\n      };\n      layer.lineColorConfig = cfgObj;\n      try {\n        if (layer.vectorLayer) layer.vectorLayer.getLineColor = cfgObj;\n      } catch (_) {}\n    }\n  }\n\n  const lw = parseFloat(els.lineWidthEl.value);\n  const lwClamped = Number.isFinite(lw) ? clamp(lw, 0, 10) : 1;\n  if (isHex) {\n    hexCfg.lineWidthMinPixels = lwClamped;\n  } else if (isVector || isPmtiles) {\n    layer.lineWidth = lwClamped;\n    try {\n      if (layer.vectorLayer) layer.vectorLayer.lineWidthMinPixels = lwClamped;\n    } catch (_) {}\n  }\n\n  updateLayerOutput();\n  findDeckOverlayOnMap();\n  rebuildDeck();\n\n  // Non-tile hex layers are Mapbox GL layers, not Deck.gl. Rebuild them so UI edits apply.\n  try {\n    const isStaticHex = layer.layerType === 'hex' && !layer.isTileLayer;\n    if (isStaticHex) {\n      const isSql = !!layer.parquetData || !!layer.parquetUrl;\n      const g = isSql\n        ? (getLayerGeoJSONs()?.[layer.id] || ({ type: 'FeatureCollection', features: [] } as any))\n        : hexToGeoJSON(layer.data || []);\n      const visible = getCurrentLayerVisibility(map, layer.id);\n      updateStaticHexLayer(map, layer as HexLayerConfig, g, visible);\n    }\n  } catch (_) {}\n\n  // Vector layers are Mapbox GL layers. Update paint properties directly so edits apply instantly.\n  try {\n    if (isVector) {\n      const v: any = layer;\n      const vecData = v.geojson?.features?.map((f: any) => f?.properties || {}) || [];\n      const fillExpr = (v.fillColorConfig as any)?.['@@function']\n        ? buildColorExpr(v.fillColorConfig, vecData) : (v.fillColorRgba || '#0090ff');\n      const lineExpr = (v.lineColorConfig as any)?.['@@function']\n        ? buildColorExpr(v.lineColorConfig, vecData) : (v.lineColorRgba || '#ffffff');\n      const fillOpacity = (v.isFilled === false) ? 0 : opClamped;\n      const lineOpacity = (v.isStroked === false) ? 0 : 1;\n\n      setPaintBatch(map, `${v.id}-`, {\n        'fill-color': fillExpr, 'fill-opacity': fillOpacity,\n        'line-color': lineExpr, 'line-width': lwClamped, 'line-opacity': lineOpacity,\n      });\n      setPaintSafe(map, `${v.id}-circle`, 'circle-color', fillExpr);\n      setPaintSafe(map, `${v.id}-circle`, 'circle-opacity', fillOpacity);\n      setPaintSafe(map, `${v.id}-circle`, 'circle-stroke-color', lineExpr);\n      setPaintSafe(map, `${v.id}-circle`, 'circle-stroke-width', lwClamped);\n    }\n  } catch {}\n\n  // PMTiles layers use Mapbox GL vector layers. Build color expressions and update paint.\n  try {\n    if (isPmtiles) {\n      const v: any = layer;\n      const fillOpacity = (v.isFilled === false) ? 0 : opClamped;\n      const lineOpacity = (v.isStroked === false) ? 0 : 1;\n      const attr = v.colorAttribute || 'value';\n      const fillExpr = v.fillColorConfig\n        ? buildPMTilesColorExpression(v.fillColorConfig, attr, '#ff8c00') : (v.fillColorRgba || '#ff8c00');\n      const lineExpr = v.lineColorConfig\n        ? buildPMTilesColorExpression(v.lineColorConfig, attr, '#ffffff') : (v.lineColorRgba || '#ffffff');\n      const lw = (v.isStroked === false) ? 0 : lwClamped;\n\n      setPaintBatch(map, `${v.id}-`, {\n        'fill-color': fillExpr, 'fill-opacity': fillOpacity,\n        'line-color': lineExpr, 'line-width': lw, 'line-opacity': lineOpacity,\n        'circle-color': fillExpr, 'circle-opacity': fillOpacity,\n        'circle-stroke-color': lineExpr, 'circle-stroke-width': lw,\n      });\n    }\n  } catch (e) {\n    console.warn('[FusedMaps] PMTiles update error:', e);\n  }\n}\n\n\n","import type { HexLayerConfig, VectorLayerConfig } from '../../types';\n\ntype AnyLayer = (HexLayerConfig | VectorLayerConfig) & Record<string, any>;\n\nexport interface SqlPanelDeps {\n  sqlSection: HTMLElement;\n  sqlStatusEl: HTMLElement;\n  sqlInputEl: HTMLTextAreaElement;\n  getActiveLayer: () => AnyLayer | null;\n  updateLayerOutput: () => void;\n}\n\nexport interface SqlPanel {\n  onTabActivated: () => void;\n  syncFromLayer: (layer: AnyLayer | null) => void;\n  applySql: (sql: string) => void;\n  destroy: () => void;\n}\n\nfunction isDuckDbHexLayer(layer: AnyLayer | null): boolean {\n  try {\n    if (!layer) return false;\n    const isHex = layer.layerType === 'hex';\n    const isTile = !!layer.isTileLayer;\n    const hasParquet = !!layer.parquetData || !!layer.parquetUrl;\n    return isHex && !isTile && hasParquet;\n  } catch (_) {\n    return false;\n  }\n}\n\nexport function createSqlPanel(deps: SqlPanelDeps): SqlPanel {\n  const { sqlSection, sqlStatusEl, sqlInputEl, getActiveLayer, updateLayerOutput } = deps;\n\n  // SQL tab always owns visibility.\n  try { sqlSection.style.display = 'block'; } catch (_) {}\n\n  let sqlTypingTimer: any = null;\n\n  // Optional CodeMirror (lazy-loaded)\n  let sqlCM: any = null;\n  let sqlCMLoading = false;\n  let sqlCMBound = false;\n\n  const getEditorValue = (): string => {\n    try {\n      if (sqlCM) return String(sqlCM.getValue() || '').trim();\n    } catch (_) {}\n    return String(sqlInputEl.value || '').trim();\n  };\n\n  let isUpdatingSql = false; // Guard against infinite loop\n\n  const dispatchSqlUpdate = () => {\n    if (isUpdatingSql) return; // Prevent re-entry\n\n    const layer = getActiveLayer();\n    if (!isDuckDbHexLayer(layer)) return;\n    const sql = getEditorValue() || 'SELECT * FROM data';\n\n    // Update the layer config (don't touch editor - would cause infinite loop)\n    try { (layer as any).sql = sql; } catch (_) {}\n    try { updateLayerOutput(); } catch (_) {}\n\n    try { sqlStatusEl.textContent = 'typing...'; } catch (_) {}\n    clearTimeout(sqlTypingTimer);\n    sqlTypingTimer = setTimeout(() => {\n      try {\n        window.dispatchEvent(new CustomEvent('fusedmaps:sql:update', { detail: { layerId: layer!.id, sql } }));\n      } catch (_) {}\n    }, 500);\n  };\n\n  const bindCodeMirrorChange = () => {\n    try {\n      if (!sqlCM || sqlCMBound) return;\n      sqlCMBound = true;\n      sqlCM.on('change', () => dispatchSqlUpdate());\n    } catch (_) {}\n  };\n\n  const loadCodeMirror = async () => {\n    try {\n      if (sqlCM || sqlCMLoading) return;\n      sqlCMLoading = true;\n\n      // If already present, mount immediately\n      if ((window as any).CodeMirror) {\n        try {\n          const CM = (window as any).CodeMirror;\n          sqlCM = CM.fromTextArea(sqlInputEl, {\n            mode: 'text/x-sql',\n            theme: 'material-darker',\n            lineNumbers: false,\n            gutters: [],\n            lineWrapping: true,\n            indentUnit: 2,\n            tabSize: 2,\n            indentWithTabs: false,\n          });\n          sqlCM.setSize('100%', '180px');\n        } catch (_) {}\n        bindCodeMirrorChange();\n        return;\n      }\n\n      const ensureCss = (href: string) => {\n        if (document.querySelector(`link[href=\"${href}\"]`)) return;\n        const link = document.createElement('link');\n        link.rel = 'stylesheet';\n        link.href = href;\n        document.head.appendChild(link);\n      };\n      ensureCss('https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css');\n      ensureCss('https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-darker.min.css');\n\n      const loadScript = (src: string) =>\n        new Promise<void>((resolve, reject) => {\n          if (document.querySelector(`script[src=\"${src}\"]`)) return resolve();\n          const s = document.createElement('script');\n          s.src = src;\n          s.async = true;\n          s.onload = () => resolve();\n          s.onerror = () => reject(new Error(`failed to load ${src}`));\n          document.head.appendChild(s);\n        });\n\n      await loadScript('https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js');\n      await loadScript('https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/sql/sql.min.js');\n\n      try {\n        const CM = (window as any).CodeMirror;\n        if (!CM) return;\n        sqlCM = CM.fromTextArea(sqlInputEl, {\n          mode: 'text/x-sql',\n          theme: 'material-darker',\n          lineNumbers: false,\n          gutters: [],\n          lineWrapping: true,\n          indentUnit: 2,\n          tabSize: 2,\n          indentWithTabs: false,\n        });\n        sqlCM.setSize('100%', '180px');\n      } catch (_) {}\n      bindCodeMirrorChange();\n    } finally {\n      sqlCMLoading = false;\n    }\n  };\n\n  // textarea fallback (when CodeMirror isn't mounted)\n  const onTextareaInput = () => dispatchSqlUpdate();\n  try { sqlInputEl.addEventListener('input', onTextareaInput); } catch (_) {}\n\n  // status updates from runtime\n  const onSqlStatus = (evt: any) => {\n    try {\n      const d = evt?.detail || {};\n      const layerId = String(d.layerId || '');\n      const status = String(d.status || '');\n      const active = getActiveLayer();\n      if (!active || String(active.id) !== layerId) return;\n      sqlStatusEl.textContent = status;\n    } catch (_) {}\n  };\n  try { window.addEventListener('fusedmaps:sql:status', onSqlStatus as any); } catch (_) {}\n\n  const syncFromLayer = (layer: AnyLayer | null) => {\n    const enabled = isDuckDbHexLayer(layer);\n\n    // Guard to prevent change events during sync\n    isUpdatingSql = true;\n    try {\n      sqlInputEl.disabled = !enabled;\n      if (enabled) {\n        sqlInputEl.value = String((layer as any).sql || 'SELECT * FROM data');\n        sqlInputEl.placeholder = 'SELECT * FROM data';\n      } else {\n        sqlInputEl.value = '';\n        sqlInputEl.placeholder = 'Select a DuckDB (parquetUrl/parquetData) hex layer to enable SQL.';\n      }\n    } catch (_) {}\n\n    try {\n      if (sqlCM) {\n        if (enabled) {\n          sqlCM.setValue(String((layer as any).sql || 'SELECT * FROM data'));\n          sqlCM.setOption('readOnly', false);\n        } else {\n          sqlCM.setValue('-- Select a DuckDB-backed hex layer to enable SQL');\n          sqlCM.setOption('readOnly', 'nocursor');\n        }\n        try { sqlCM.refresh?.(); } catch (_) {}\n      }\n    } catch (_) {}\n    isUpdatingSql = false;\n\n    try { sqlStatusEl.textContent = enabled ? '' : 'disabled'; } catch (_) {}\n  };\n\n  const applySql = (sql: string) => {\n    const layer = getActiveLayer();\n    if (!isDuckDbHexLayer(layer)) return;\n\n    // Guard to prevent change events during programmatic update\n    isUpdatingSql = true;\n    try {\n      // Update textarea and CodeMirror\n      sqlInputEl.value = sql;\n      if (sqlCM) {\n        sqlCM.setValue(sql);\n      }\n      // Update layer config\n      (layer as any).sql = sql;\n      updateLayerOutput();\n    } catch (_) {}\n    isUpdatingSql = false;\n\n    // Dispatch update event\n    try {\n      window.dispatchEvent(new CustomEvent('fusedmaps:sql:update', { detail: { layerId: layer!.id, sql } }));\n    } catch (_) {}\n  };\n\n  return {\n    onTabActivated: () => {\n      loadCodeMirror().then(() => {\n        try { sqlCM?.refresh?.(); } catch (_) {}\n      });\n    },\n    syncFromLayer,\n    applySql,\n    destroy: () => {\n      try { clearTimeout(sqlTypingTimer); } catch (_) {}\n      try { sqlInputEl.removeEventListener('input', onTextareaInput); } catch (_) {}\n      try { window.removeEventListener('fusedmaps:sql:status', onSqlStatus as any); } catch (_) {}\n      try { sqlCM?.toTextArea?.(); } catch (_) {}\n      sqlCM = null;\n    }\n  };\n}\n\n","/**\n * Debug panel (ported toward map_utils.py).\n *\n * In fusedmaps we focus on the deck/tile hex ecosystem; debug panel edits the in-memory\n * `config.layers` objects and triggers a Deck rebuild so changes apply immediately.\n */\n\nimport type { FusedMapsConfig, HexLayerConfig, VectorLayerConfig, ViewState } from '../types';\nimport { getViewState } from '../core/map';\nimport { deepDelta, toPyLiteral } from './debug/export';\nimport { createPaletteDropdownManager, getPaletteNames, setPaletteOptions } from './debug/palettes';\nimport { ensureDebugShell, queryDebugElements } from './debug/template';\nimport { applyDebugUIToLayer } from './debug/apply';\nimport { createSqlPanel, type SqlPanel } from './debug/sql_panel';\nimport { createAiPanel, type AiPanel, type AiConfig } from './debug/ai_panel';\nimport { clamp, fmt, rgbToHex } from '../utils';\n\nexport interface DebugHandle {\n  destroy: () => void;\n}\n\nfunction isEditingInputs(root: HTMLElement) {\n  const a = document.activeElement as HTMLElement | null;\n  if (!a) return false;\n  return !!a.closest?.('#debug-panel') && (a.tagName === 'INPUT' || a.tagName === 'TEXTAREA' || a.tagName === 'SELECT');\n}\n\nfunction updateDebugTogglePosition(shell: HTMLElement, panel: HTMLElement, toggle: HTMLElement) {\n  try {\n    const w = panel.getBoundingClientRect().width || 280;\n    shell.style.setProperty('--debug-panel-w', `${w}px`);\n    toggle.style.left = panel.classList.contains('collapsed') ? '0px' : `var(--debug-panel-w, ${w}px)`;\n  } catch {}\n}\n\nfunction ensureColorContinuousCfg(obj: any) {\n  if (!obj || typeof obj !== 'object') return null;\n  if (obj['@@function'] !== 'colorContinuous') return null;\n  return obj;\n}\n\nfunction getAttrCandidates(layer: HexLayerConfig): string[] {\n  const out = new Set<string>();\n  try {\n    const fc: any = (layer.hexLayer as any)?.getFillColor;\n    const lc: any = (layer.hexLayer as any)?.getLineColor;\n    if (fc?.attr) out.add(String(fc.attr));\n    if (lc?.attr) out.add(String(lc.attr));\n    // Check tooltipColumns/tooltipAttrs at both layer and hexLayer level\n    const ttc: any = (layer as any).tooltipColumns || (layer.hexLayer as any)?.tooltipColumns;\n    const tta: any = (layer as any).tooltipAttrs || (layer.hexLayer as any)?.tooltipAttrs;\n    if (Array.isArray(ttc)) ttc.forEach((x: any) => { if (x && x !== 'hex') out.add(String(x)); });\n    if (Array.isArray(tta)) tta.forEach((x: any) => { if (x && x !== 'hex') out.add(String(x)); });\n  } catch (_) {}\n  return [...out].filter(Boolean);\n}\n\nfunction getVectorAttrCandidates(layer: VectorLayerConfig): string[] {\n  try {\n    const f0: any = layer.geojson?.features?.[0];\n    const p = (f0?.properties || {}) as Record<string, unknown>;\n    return Object.keys(p || {}).filter((k) => k && k !== '_fused_idx');\n  } catch (_) {\n    return [];\n  }\n}\n\n// (Mapbox paint helpers and hexToRgb moved to ./debug/apply)\n\n// --- Defaults (debug output only) ---\nconst DEFAULT_HEX_STYLE: any = {\n  filled: true,\n  stroked: true,\n  pickable: true,\n  extruded: false,\n  elevationScale: 1,\n  opacity: 1,\n  getHexagon: '@@=properties.hex',\n  getFillColor: {\n    '@@function': 'colorContinuous',\n    attr: 'cnt',\n    steps: 20,\n    colors: 'ArmyRose',\n    nullColor: [184, 184, 184]\n  },\n  getLineColor: [255, 255, 255],\n  lineWidthMinPixels: 1\n};\n\nconst DEFAULT_TILE_LAYER: any = {\n  minZoom: 0,\n  maxZoom: 19,\n  zoomOffset: 0\n};\n\nconst DEFAULT_VECTOR_STYLE: any = {\n  filled: true,\n  stroked: true,\n  pickable: true,\n  opacity: 0.8,\n  lineWidthMinPixels: 0,\n  pointRadiusMinPixels: 10,\n  getFillColor: {\n    '@@function': 'colorContinuous',\n    attr: 'house_age',\n    domain: [0, 50],\n    colors: 'ArmyRose',\n    steps: 7,\n    nullColor: [200, 200, 200, 180]\n  }\n};\n\nexport function setupDebugPanel(map: mapboxgl.Map, config: FusedMapsConfig): DebugHandle {\n  const sidebarMode = (config as any).sidebar || ((config as any).debug ? 'show' : null);\n  const { shell, panel, toggle, resizeHandle } = ensureDebugShell();\n\n  // Initial open/closed state (only relevant when mounted)\n  try {\n    if (sidebarMode === 'hide') {\n      panel.classList.add('collapsed');\n      toggle.innerHTML = '&#x203A;';\n    } else {\n      panel.classList.remove('collapsed');\n      toggle.innerHTML = '&#x2039;';\n    }\n    updateDebugTogglePosition(shell!, panel, toggle);\n  } catch (_) {}\n\n  const {\n    layerSelect,\n    hexSection,\n    viewStateSection,\n    fillColorSection,\n    lineColorSection,\n    filledEl,\n    strokedEl,\n    extrudedEl,\n    extrusionControls,\n    elevAttrEl,\n    elevScaleEl,\n    opacitySliderEl,\n    opacityEl,\n    fillFnEl,\n    fillFnOptions,\n    fillStaticOptions,\n    fillAttrEl,\n    fillPaletteEl,\n    fillPalTrigger,\n    fillPalSwatch,\n    fillPalMenu,\n    fillDomainMinEl,\n    fillDomainMaxEl,\n    fillRangeMinEl,\n    fillRangeMaxEl,\n    fillStepsEl,\n    fillReverseEl,\n    fillNullEl,\n    fillNullLabel,\n    fillStaticEl,\n    fillStaticLabel,\n    lineFnEl,\n    lineFnOptions,\n    lineStaticOptions,\n    lineAttrEl,\n    linePaletteEl,\n    linePalTrigger,\n    linePalSwatch,\n    linePalMenu,\n    lineDomainMinEl,\n    lineDomainMaxEl,\n    lineReverseEl,\n    lineStaticEl,\n    lineStaticLabel,\n    lineWidthSliderEl,\n    lineWidthEl,\n    lngEl,\n    latEl,\n    zoomEl,\n    pitchEl,\n    bearingEl,\n    viewOut,\n    layerOut,\n    sqlSection,\n    sqlStatusEl,\n    sqlInputEl,\n    aiSection,\n    aiChatEl,\n    aiInputEl,\n    aiSendBtn,\n    aiStatusEl,\n    aiSqlPreviewEl,\n  } = queryDebugElements();\n\n  // --- Tabs (UI | SQL | AI) ---\n  const tabUiBtn = document.getElementById('dbg-tab-btn-ui') as HTMLButtonElement | null;\n  const tabSqlBtn = document.getElementById('dbg-tab-btn-sql') as HTMLButtonElement | null;\n  const tabAiBtn = document.getElementById('dbg-tab-btn-ai') as HTMLButtonElement | null;\n  const tabUiPanel = document.getElementById('dbg-tab-panel-ui') as HTMLElement | null;\n  const tabSqlPanel = document.getElementById('dbg-tab-panel-sql') as HTMLElement | null;\n  const tabAiPanel = document.getElementById('dbg-tab-panel-ai') as HTMLElement | null;\n\n  let sqlPanel: SqlPanel | null = null;\n  let aiPanel: AiPanel | null = null;\n\n  const setActiveTab = (tab: 'ui' | 'sql' | 'ai', persist = true) => {\n    try {\n      if (tabUiPanel) tabUiPanel.style.display = tab === 'ui' ? 'block' : 'none';\n      if (tabSqlPanel) tabSqlPanel.style.display = tab === 'sql' ? 'block' : 'none';\n      if (tabAiPanel) tabAiPanel.style.display = tab === 'ai' ? 'block' : 'none';\n      if (tabUiBtn) {\n        tabUiBtn.classList.toggle('active', tab === 'ui');\n        tabUiBtn.setAttribute('aria-selected', tab === 'ui' ? 'true' : 'false');\n      }\n      if (tabSqlBtn) {\n        tabSqlBtn.classList.toggle('active', tab === 'sql');\n        tabSqlBtn.setAttribute('aria-selected', tab === 'sql' ? 'true' : 'false');\n      }\n      if (tabAiBtn) {\n        tabAiBtn.classList.toggle('active', tab === 'ai');\n        tabAiBtn.setAttribute('aria-selected', tab === 'ai' ? 'true' : 'false');\n      }\n      if (persist) {\n        try { localStorage.setItem('fusedmaps:debug:tab', tab); } catch (_) {}\n      }\n    } catch (_) {}\n\n    try {\n      if (tab === 'sql') {\n        sqlPanel?.onTabActivated();\n      }\n    } catch (_) {}\n  };\n\n  const onTabClick = (e: any) => {\n    const el = e?.currentTarget as HTMLElement | null;\n    const tab = String(el?.getAttribute?.('data-tab') || '').toLowerCase();\n    if (tab === 'ui' || tab === 'sql' || tab === 'ai') setActiveTab(tab as any, true);\n  };\n\n  try {\n    tabUiBtn?.addEventListener('click', onTabClick as any);\n    tabSqlBtn?.addEventListener('click', onTabClick as any);\n    tabAiBtn?.addEventListener('click', onTabClick as any);\n  } catch (_) {}\n\n  try {\n    const saved = String(localStorage.getItem('fusedmaps:debug:tab') || '').toLowerCase();\n    if (saved === 'sql') setActiveTab('sql', false);\n    else if (saved === 'ai') setActiveTab('ai', false);\n    else setActiveTab('ui', false);\n  } catch (_) {\n    setActiveTab('ui', false);\n  }\n\n  const initial: ViewState = config.initialViewState;\n\n  const palettes = getPaletteNames();\n  setPaletteOptions(fillPaletteEl, palettes);\n  setPaletteOptions(linePaletteEl, palettes);\n\n  const getPreviewSteps = () => {\n    const s = parseInt(fillStepsEl?.value || '7', 10);\n    return Number.isFinite(s) ? Math.max(2, Math.min(20, s)) : 7;\n  };\n\n  const palMgr = createPaletteDropdownManager(palettes);\n  const fillPal = palMgr.attach({\n    selectEl: fillPaletteEl,\n    menuEl: fillPalMenu,\n    swatchEl: fillPalSwatch,\n    triggerEl: fillPalTrigger,\n    getSteps: getPreviewSteps,\n    getReverse: () => !!fillReverseEl.checked,\n    onPicked: () => applyUIToLayer(),\n  });\n  const linePal = palMgr.attach({\n    selectEl: linePaletteEl,\n    menuEl: linePalMenu,\n    swatchEl: linePalSwatch,\n    triggerEl: linePalTrigger,\n    getSteps: getPreviewSteps,\n    getReverse: () => !!lineReverseEl.checked,\n    onPicked: () => applyUIToLayer(),\n  });\n\n  // Find editable layers.\n  // Note: originally this panel was hex-only; we also support vector layers and pmtiles now.\n  const editableLayers = config.layers.filter((l) =>\n    l.layerType === 'hex' || l.layerType === 'vector' || l.layerType === 'pmtiles'\n  ) as any[];\n  layerSelect.innerHTML = editableLayers.map((l) => `<option value=\"${l.id}\">${l.name || l.id}</option>`).join('');\n  if (!layerSelect.value && editableLayers.length) layerSelect.value = editableLayers[0].id;\n\n  const getActiveLayer = (): (HexLayerConfig | VectorLayerConfig) | null => {\n    const id = layerSelect.value;\n    const l = editableLayers.find((x) => x.id === id) || null;\n    return l;\n  };\n\n  const rebuildDeck = () => {\n    try {\n      // hex tile overlay stores a rebuild helper on the MapboxOverlay instance\n      const overlay = (config as any).__deckOverlay || null;\n      const state = (overlay as any)?.__fused_hex_tiles__;\n      state?.rebuild?.();\n    } catch (_) {}\n    try {\n      window.dispatchEvent(new CustomEvent('fusedmaps:legend:update'));\n    } catch (_) {}\n  };\n\n  // We don't have direct access to deckOverlay in config; instead we locate it on the map's controls list.\n  const findDeckOverlayOnMap = () => {\n    try {\n      const controls = (map as any)._controls || [];\n      const deck = controls.find((c: any) => c && c.__fused_hex_tiles__);\n      (config as any).__deckOverlay = deck || (config as any).__deckOverlay;\n    } catch (_) {}\n  };\n  findDeckOverlayOnMap();\n\n  const updateLayerOutput = () => {\n    try {\n      // Paste-back config (short, combined):\n      // Emit a full `layers=[...]` list (map_utils style), where each layer's `config`\n      // is a delta against strong defaults.\n      const MAX_STRINGIFY_CHARS = 200_000;\n\n      const toLayerDef = (l: any) => {\n        const base: any = {\n          name: l.name\n        };\n        // Only include visibility when it's explicitly off (default True).\n        if (l.visible === false) base.visible = false;\n\n        // Hex (tile or static)\n        if (l.layerType === 'hex') {\n          const hl = l.hexLayer || {};\n          const cfg: any = { hexLayer: deepDelta(DEFAULT_HEX_STYLE, hl) || {} };\n          if (l.isTileLayer && l.tileUrl) {\n            base.type = 'hex';\n            base.tile_url = l.tileUrl;\n            const tl = l.tileLayerConfig || l.tileLayer || null;\n            if (tl && typeof tl === 'object') {\n              const dt = deepDelta(DEFAULT_TILE_LAYER, tl);\n              if (dt && Object.keys(dt).length) cfg.tileLayer = dt;\n            }\n          } else {\n            // Static hex data or DuckDB SQL-backed non-tile hex\n            base.type = 'hex';\n            if (l.parquetUrl) base.parquetUrl = l.parquetUrl;\n            if (l.sql) base.sql = l.sql;\n            // If this is not a parquet/sql-backed layer, keep an explicit data placeholder.\n            if (!l.parquetUrl) {\n              // Don't inline huge data arrays in the paste-back snippet.\n              // Use a placeholder (data=None) or a python symbol (data=df) if dataRef was provided.\n              base.data = (l as any).dataRef ? `@@py:${String((l as any).dataRef)}` : null;\n            }\n          }\n          base.config = cfg;\n          return base;\n        }\n\n        // Vector GeoJSON\n        if (l.layerType === 'vector') {\n          base.type = 'vector';\n          // Don't inline GeoJSON; keep paste-back snippet small and explicit.\n          base.data = (l as any).dataRef ? `@@py:${String((l as any).dataRef)}` : null;\n          base.config = { vectorLayer: deepDelta(DEFAULT_VECTOR_STYLE, l.vectorLayer || {}) || {} };\n          return base;\n        }\n\n        // MVT tiles\n        if (l.layerType === 'mvt') {\n          base.type = 'vector';\n          base.tile_url = l.tileUrl;\n          base.source_layer = l.sourceLayer || 'udf';\n          // For MVT, we accept styling via vectorLayer schema in map_utils_refactored\n          const vcfg: any = {};\n          if (l.fillColorConfig) vcfg.getFillColor = l.fillColorConfig;\n          else if (l.fillColor) vcfg.getFillColor = l.fillColor;\n          if (l.lineColorConfig) vcfg.getLineColor = l.lineColorConfig;\n          else if (l.lineColor) vcfg.getLineColor = l.lineColor;\n          if (typeof l.lineWidth === 'number') vcfg.lineWidthMinPixels = l.lineWidth;\n          if (typeof l.fillOpacity === 'number') vcfg.opacity = l.fillOpacity;\n          base.config = { vectorLayer: vcfg };\n          return base;\n        }\n\n        // PMTiles (Mapbox GL source via mapbox-pmtiles)\n        if (l.layerType === 'pmtiles') {\n          base.type = 'pmtiles';\n          // Prefer original path if available (cleaner paste-back). Otherwise fall back to URL.\n          if ((l as any).pmtilesPath) base.pmtiles_path = (l as any).pmtilesPath;\n          else base.pmtiles_url = l.pmtilesUrl;\n          if (l.sourceLayer) base.source_layer = l.sourceLayer;\n          if (typeof l.minzoom === 'number') base.minzoom = l.minzoom;\n          if (typeof l.maxzoom === 'number') base.maxzoom = l.maxzoom;\n\n          // Use vectorLayer style schema (same as map_utils_refactored expects)\n          // Emit a delta against DEFAULT_VECTOR_STYLE for compactness.\n          const v: any = l.vectorLayer || {};\n\n          // Ensure key overrides from the PMTiles config are reflected in the style block\n          // even if vectorLayer is missing them (PMTiles has some top-level style fields).\n          const vMerged: any = { ...v };\n          if (l.fillColorConfig) vMerged.getFillColor = l.fillColorConfig;\n          if (l.lineColorConfig) vMerged.getLineColor = l.lineColorConfig;\n          if (typeof l.fillOpacity === 'number') vMerged.opacity = l.fillOpacity;\n          if (typeof l.lineWidth === 'number') vMerged.lineWidthMinPixels = l.lineWidth;\n          if (typeof l.pointRadiusMinPixels === 'number') vMerged.pointRadiusMinPixels = l.pointRadiusMinPixels;\n          if (typeof l.isFilled === 'boolean') vMerged.filled = l.isFilled;\n          if (typeof l.isStroked === 'boolean') vMerged.stroked = l.isStroked;\n\n          base.config = { vectorLayer: deepDelta(DEFAULT_VECTOR_STYLE, vMerged) || {} };\n          return base;\n        }\n\n        // Raster tiles / static raster overlay\n        if (l.layerType === 'raster') {\n          base.type = 'raster';\n          if (l.tileUrl) base.tile_url = l.tileUrl;\n          if (l.imageUrl) base.image_url = l.imageUrl;\n          if (l.imageBounds) base.bounds = l.imageBounds;\n          const op = l.opacity ?? l.rasterLayer?.opacity;\n          base.config = (typeof op === 'number' && Number.isFinite(op) && op !== 1)\n            ? { rasterLayer: { opacity: op } }\n            : {};\n          return base;\n        }\n\n        // Unknown\n        return base;\n      };\n\n      const layersOut = (config.layers || []).map(toLayerDef);\n      // Layer Config output should be paste-back friendly.\n      // For drawings, users expect the full FeatureCollection (geojson.io style).\n      let s = `layers = ${toPyLiteral(layersOut, 0)}`;\n\n      // Keep truncation for general layer config\n      if (s.length > MAX_STRINGIFY_CHARS) {\n        s = s.slice(0, MAX_STRINGIFY_CHARS) + '\\n... (truncated)\\n';\n      }\n      layerOut.value = s;\n    } catch (_) {\n      layerOut.value = '';\n    }\n  };\n\n  // SQL tab support (CodeMirror is lazy-loaded on tab activation)\n  sqlPanel = createSqlPanel({\n    sqlSection,\n    sqlStatusEl,\n    sqlInputEl,\n    getActiveLayer: () => getActiveLayer() as any,\n    updateLayerOutput,\n  });\n\n  // AI panel (natural language to SQL)\n  aiPanel = createAiPanel({\n    aiSection,\n    aiChatEl,\n    aiInputEl,\n    aiSendBtn,\n    aiStatusEl,\n    aiSqlPreviewEl,\n    getActiveLayerId: () => getActiveLayer()?.id || null,\n    onSqlGenerated: (layerId: string, sql: string) => {\n      // Apply the generated SQL to the layer\n      const layer = editableLayers.find((l) => l.id === layerId);\n      if (!layer) return;\n      try {\n        // Update the layer's SQL\n        layer.sql = sql;\n        // Trigger rebuild via SQL panel's mechanism\n        sqlPanel?.applySql(sql);\n      } catch (_) {}\n    },\n  });\n\n  // Configure AI panel from config.ai\n  try {\n    const aiConfig = (config as any).ai as AiConfig | undefined;\n    if (aiConfig) {\n      aiPanel.setConfig(aiConfig);\n    }\n  } catch (_) {}\n\n  const updateFillFnOptions = () => {\n    const fn = fillFnEl.value;\n    fillFnOptions.style.display = fn === 'colorContinuous' ? 'block' : 'none';\n    fillStaticOptions.style.display = fn === 'static' ? 'block' : 'none';\n  };\n\n  const updateLineFnOptions = () => {\n    const fn = lineFnEl.value;\n    lineFnOptions.style.display = fn === 'colorContinuous' ? 'block' : 'none';\n    lineStaticOptions.style.display = fn === 'static' ? 'block' : 'none';\n  };\n\n  const readLayerToUI = () => {\n    const layer = getActiveLayer();\n    if (!layer) return;\n    const isHex = (layer as any).layerType === 'hex';\n    const isVector = (layer as any).layerType === 'vector';\n    const isPmtiles = (layer as any).layerType === 'pmtiles';\n    const hexCfg: any = isHex ? ((layer as any).hexLayer || {}) : {};\n\n    // Toggle section visibility\n    try { if (hexSection) hexSection.style.display = isHex ? 'block' : 'none'; } catch (_) {}\n    try { if (fillColorSection) fillColorSection.style.display = (isHex || isVector || isPmtiles) ? 'block' : 'none'; } catch (_) {}\n    try { if (lineColorSection) lineColorSection.style.display = (isHex || isVector || isPmtiles) ? 'block' : 'none'; } catch (_) {}\n    try { if (viewStateSection) viewStateSection.style.display = 'block'; } catch (_) {}\n\n    // Basic toggles\n    if (isHex) {\n      filledEl.checked = hexCfg.filled !== false;\n      strokedEl.checked = hexCfg.stroked !== false;\n      extrudedEl.checked = hexCfg.extruded === true;\n    } else {\n      // vector/pmtiles: treat filled/stroked as on/off hints; extruded doesn't apply\n      filledEl.checked = (layer as any).isFilled !== false;\n      strokedEl.checked = (layer as any).isStroked !== false;\n      extrudedEl.checked = false;\n    }\n\n    // Extrusion controls (hex only)\n    try {\n      if (extrusionControls) extrusionControls.style.display = (isHex && extrudedEl.checked) ? 'block' : 'none';\n      if (isHex && elevAttrEl) {\n        const attrs = getAttrCandidates(layer as any);\n        const opts = [''].concat(attrs || []);\n        elevAttrEl.innerHTML = opts\n          .map((a) => a ? `<option value=\"${a}\">${a}</option>` : `<option value=\"\">(use fill attr)</option>`)\n          .join('');\n        elevAttrEl.value = String(hexCfg.elevationProperty || '');\n      }\n      if (isHex && elevScaleEl) {\n        elevScaleEl.value = String(\n          (typeof hexCfg.elevationScale === 'number' && Number.isFinite(hexCfg.elevationScale))\n            ? hexCfg.elevationScale\n            : 1\n        );\n      }\n    } catch (_) {}\n\n    const op = isHex\n      ? (typeof hexCfg.opacity === 'number' ? hexCfg.opacity : 1)\n      : (typeof (layer as any).opacity === 'number' ? (layer as any).opacity : 0.9);\n    opacitySliderEl.value = String(op);\n    opacityEl.value = String(op);\n\n    // Fill\n    if (isHex) {\n      const fc: any = hexCfg.getFillColor;\n      const cc = ensureColorContinuousCfg(fc);\n      if (cc) {\n        fillFnEl.value = 'colorContinuous';\n        fillAttrEl.innerHTML = getAttrCandidates(layer as any).map((a) => `<option value=\"${a}\">${a}</option>`).join('');\n        if (cc.attr) fillAttrEl.value = String(cc.attr);\n        if (cc.colors) fillPaletteEl.value = String(cc.colors);\n        try { fillReverseEl.checked = !!(cc as any).reverse; } catch (_) { fillReverseEl.checked = false; }\n      try { fillPal.refresh(); } catch (_) {}\n        const dom = Array.isArray(cc.domain) ? cc.domain : [0, 1];\n        fillDomainMinEl.value = fmt(Number(dom[0]), 2);\n        fillDomainMaxEl.value = fmt(Number(dom[1]), 2);\n        // Keep dual slider aligned with inputs (map_utils style)\n        try {\n          const dmin = Math.min(Number(dom[0]), Number(dom[1]));\n          const dmax = Math.max(Number(dom[0]), Number(dom[1]));\n          if (Number.isFinite(dmin) && Number.isFinite(dmax)) {\n            fillRangeMinEl.min = String(dmin);\n            fillRangeMinEl.max = String(dmax);\n            fillRangeMaxEl.min = String(dmin);\n            fillRangeMaxEl.max = String(dmax);\n            fillRangeMinEl.step = '0.1';\n            fillRangeMaxEl.step = '0.1';\n            fillRangeMinEl.value = String(Number(dom[0]));\n            fillRangeMaxEl.value = String(Number(dom[1]));\n          }\n        } catch (_) {}\n        fillStepsEl.value = String(cc.steps ?? 7);\n        const nc = Array.isArray(cc.nullColor) ? cc.nullColor : [184, 184, 184];\n        const hex = rgbToHex(nc);\n        fillNullEl.value = hex;\n        fillNullLabel.textContent = hex;\n      } else if (Array.isArray(fc)) {\n        fillFnEl.value = 'static';\n        try { fillReverseEl.checked = false; } catch {}\n        const hex = rgbToHex(fc as number[]);\n        fillStaticEl.value = hex;\n        fillStaticLabel.textContent = hex;\n        // Still populate attr dropdown for when user switches to colorContinuous\n        const attrs = getAttrCandidates(layer as any);\n        if (attrs.length) {\n          fillAttrEl.innerHTML = attrs.map((a) => `<option value=\"${a}\">${a}</option>`).join('');\n        }\n      } else {\n        fillFnEl.value = 'colorContinuous';\n        try { fillReverseEl.checked = false; } catch (_) {}\n        // Populate attr dropdown from tooltipColumns\n        const attrs = getAttrCandidates(layer as any);\n        if (attrs.length) {\n          fillAttrEl.innerHTML = attrs.map((a) => `<option value=\"${a}\">${a}</option>`).join('');\n        }\n      }\n    } else if (isVector || isPmtiles) {\n      const v = layer as any;\n      const fcCfg = v.fillColorConfig;\n      // PMTiles layers may not have inline data for attribute detection.\n      // IMPORTANT: Always include the configured attr in the dropdown options,\n      // otherwise the <select> will silently fall back to its default (often \"value\"),\n      // and the map will appear \"wrong\" until the user touches the controls.\n      const attrs = (() => {\n        if (!isPmtiles) return getVectorAttrCandidates(layer as any);\n        const s = new Set<string>();\n        // Prefer explicit configured attrs\n        if (fcCfg?.attr) s.add(String(fcCfg.attr));\n        if (v.lineColorConfig?.attr) s.add(String(v.lineColorConfig.attr));\n        if (v.colorAttribute) s.add(String(v.colorAttribute));\n        // Safe default for many PMTiles datasets\n        s.add('value');\n        return [...s].filter(Boolean);\n      })();\n      fillAttrEl.innerHTML = attrs.map((a) => `<option value=\"${a}\">${a}</option>`).join('');\n      if (fcCfg && typeof fcCfg === 'object' && fcCfg['@@function'] === 'colorContinuous') {\n        fillFnEl.value = 'colorContinuous';\n        if (fcCfg.attr) fillAttrEl.value = String(fcCfg.attr);\n        if (fcCfg.colors) fillPaletteEl.value = String(fcCfg.colors);\n        try { fillReverseEl.checked = !!(fcCfg as any).reverse; } catch (_) { fillReverseEl.checked = false; }\n      try { fillPal.refresh(); } catch (_) {}\n        const dom = Array.isArray(fcCfg.domain) ? fcCfg.domain : [0, 1];\n        fillDomainMinEl.value = fmt(Number(dom[0]), 2);\n        fillDomainMaxEl.value = fmt(Number(dom[1]), 2);\n        // Keep dual slider aligned with inputs (same behavior as hex)\n        try {\n          const dmin = Math.min(Number(dom[0]), Number(dom[1]));\n          const dmax = Math.max(Number(dom[0]), Number(dom[1]));\n          if (Number.isFinite(dmin) && Number.isFinite(dmax)) {\n            fillRangeMinEl.min = String(dmin);\n            fillRangeMinEl.max = String(dmax);\n            fillRangeMaxEl.min = String(dmin);\n            fillRangeMaxEl.max = String(dmax);\n            fillRangeMinEl.step = '0.1';\n            fillRangeMaxEl.step = '0.1';\n            fillRangeMinEl.value = String(Number(dom[0]));\n            fillRangeMaxEl.value = String(Number(dom[1]));\n          }\n        } catch (_) {}\n        fillStepsEl.value = String(fcCfg.steps ?? 7);\n        const nc = Array.isArray(fcCfg.nullColor) ? fcCfg.nullColor : [184, 184, 184];\n        const hex = rgbToHex(nc);\n        fillNullEl.value = hex;\n        fillNullLabel.textContent = hex;\n      } else {\n        fillFnEl.value = 'static';\n        try { fillReverseEl.checked = false; } catch (_) {}\n        // best-effort: derive picker from rgba if possible, else keep default\n        fillStaticEl.value = '#0090ff';\n        fillStaticLabel.textContent = fillStaticEl.value;\n      }\n    }\n\n    // Line\n    if (isHex) {\n      const lc: any = hexCfg.getLineColor;\n      const lcCC = ensureColorContinuousCfg(lc);\n      if (lcCC) {\n        lineFnEl.value = 'colorContinuous';\n        lineAttrEl.innerHTML = getAttrCandidates(layer as any).map((a) => `<option value=\"${a}\">${a}</option>`).join('');\n        if (lcCC.attr) lineAttrEl.value = String(lcCC.attr);\n        if (lcCC.colors) linePaletteEl.value = String(lcCC.colors);\n        try { lineReverseEl.checked = !!(lcCC as any).reverse; } catch (_) { lineReverseEl.checked = false; }\n      try { linePal.refresh(); } catch (_) {}\n        const dom = Array.isArray(lcCC.domain) ? lcCC.domain : [0, 1];\n        lineDomainMinEl.value = fmt(Number(dom[0]), 2);\n        lineDomainMaxEl.value = fmt(Number(dom[1]), 2);\n      } else if (Array.isArray(lc)) {\n        lineFnEl.value = 'static';\n        try { lineReverseEl.checked = false; } catch {}\n        const hex = rgbToHex(lc as number[]);\n        lineStaticEl.value = hex;\n        lineStaticLabel.textContent = hex;\n      } else {\n        lineFnEl.value = 'static';\n        try { lineReverseEl.checked = false; } catch {}\n      }\n    } else if (isVector || isPmtiles) {\n      const v = layer as any;\n      const lcCfg = v.lineColorConfig;\n      const attrs = (() => {\n        if (!isPmtiles) return getVectorAttrCandidates(layer as any);\n        const s = new Set<string>();\n        if (lcCfg?.attr) s.add(String(lcCfg.attr));\n        if (v.fillColorConfig?.attr) s.add(String(v.fillColorConfig.attr));\n        if (v.colorAttribute) s.add(String(v.colorAttribute));\n        s.add('value');\n        return [...s].filter(Boolean);\n      })();\n      lineAttrEl.innerHTML = attrs.map((a) => `<option value=\"${a}\">${a}</option>`).join('');\n      if (lcCfg && typeof lcCfg === 'object' && lcCfg['@@function'] === 'colorContinuous') {\n        lineFnEl.value = 'colorContinuous';\n        if (lcCfg.attr) lineAttrEl.value = String(lcCfg.attr);\n        if (lcCfg.colors) linePaletteEl.value = String(lcCfg.colors);\n        try { lineReverseEl.checked = !!(lcCfg as any).reverse; } catch (_) { lineReverseEl.checked = false; }\n      try { linePal.refresh(); } catch (_) {}\n        const dom = Array.isArray(lcCfg.domain) ? lcCfg.domain : [0, 1];\n        lineDomainMinEl.value = fmt(Number(dom[0]), 2);\n        lineDomainMaxEl.value = fmt(Number(dom[1]), 2);\n      } else {\n        lineFnEl.value = 'static';\n        try { lineReverseEl.checked = false; } catch (_) {}\n      }\n    }\n\n    const lw = isHex ? (hexCfg.lineWidthMinPixels ?? 1) : ((layer as any).lineWidth ?? 1);\n    lineWidthSliderEl.value = String(lw);\n    lineWidthEl.value = String(lw);\n\n    updateFillFnOptions();\n    updateLineFnOptions();\n    updateLayerOutput();\n\n    // SQL (DuckDB) section: only for non-tile hex layers that have parquetData/parquetUrl\n    try {\n      sqlPanel?.syncFromLayer(layer as any);\n    } catch (_) {}\n  };\n\n  const applyUIToLayer = () => {\n    const layer = getActiveLayer();\n    if (!layer) return;\n    applyDebugUIToLayer({\n      map,\n      layer,\n      els: {\n        filledEl,\n        strokedEl,\n        extrudedEl,\n        extrusionControls,\n        elevAttrEl,\n        elevScaleEl,\n        opacityEl,\n        fillFnEl,\n        fillAttrEl,\n        fillPaletteEl,\n        fillReverseEl,\n        fillDomainMinEl,\n        fillDomainMaxEl,\n        fillStepsEl,\n        fillNullEl,\n        fillStaticEl,\n        lineFnEl,\n        lineAttrEl,\n        linePaletteEl,\n        lineReverseEl,\n        lineDomainMinEl,\n        lineDomainMaxEl,\n        lineStaticEl,\n        lineWidthEl,\n      },\n      updateLayerOutput,\n      findDeckOverlayOnMap,\n      rebuildDeck,\n    });\n  };\n\n  // Domain slider behavior (map_utils style)\n  const syncDomainSliderFromInputs = () => {\n    const minV = parseFloat(fillDomainMinEl.value);\n    const maxV = parseFloat(fillDomainMaxEl.value);\n    if (Number.isFinite(minV)) fillRangeMinEl.value = String(minV);\n    if (Number.isFinite(maxV)) fillRangeMaxEl.value = String(maxV);\n  };\n\n  const syncDomainInputsFromSlider = () => {\n    let a = parseFloat(fillRangeMinEl.value);\n    let b = parseFloat(fillRangeMaxEl.value);\n    if (!Number.isFinite(a) || !Number.isFinite(b)) return;\n    if (a > b) [a, b] = [b, a];\n    fillRangeMinEl.value = String(a);\n    fillRangeMaxEl.value = String(b);\n    fillDomainMinEl.value = String(a);\n    fillDomainMaxEl.value = String(b);\n  };\n\n  const markDomainFromUser = () => {\n    const layer = getActiveLayer();\n    if (!layer) return;\n    // This flag is checked by the tile autoDomain logic to avoid overwriting user edits.\n    (layer as any).fillDomainFromUser = true;\n    // Only hex layers have autoDomain behavior (tile autoDomain + SQL legend stats).\n    try {\n      if ((layer as any).layerType !== 'hex') return;\n      const hc: any = (layer as any).hexLayer || {};\n      if (hc.getFillColor && typeof hc.getFillColor === 'object') {\n        hc.getFillColor.autoDomain = false;\n        try { delete hc.getFillColor._dynamicDomain; } catch (_) {}\n      }\n      if (hc.getLineColor && typeof hc.getLineColor === 'object') {\n        hc.getLineColor.autoDomain = false;\n        try { delete hc.getLineColor._dynamicDomain; } catch (_) {}\n      }\n    } catch (_) {}\n  };\n\n  const onDomainSliderInput = () => {\n    // While dragging: update only the input boxes\n    syncDomainInputsFromSlider();\n  };\n\n  const onDomainSliderChange = () => {\n    // On mouseup/touchend: apply once + lock out autoDomain\n    syncDomainInputsFromSlider();\n    markDomainFromUser();\n    applyUIToLayer();\n  };\n\n  // ViewState updates: update output on map stop (moveend/rotateend/pitchend)\n  const updateFromMapStop = () => {\n    try {\n      const vs = getViewState(map);\n      // Always show a paste-ready Python assignment.\n      viewOut.value = `initialViewState = ${toPyLiteral(vs, 0)}`;\n      if (shell && isEditingInputs(shell)) return;\n      lngEl.value = fmt(vs.longitude, 5);\n      latEl.value = fmt(vs.latitude, 5);\n      zoomEl.value = fmt(vs.zoom, 2);\n      pitchEl.value = fmt(vs.pitch ?? 0, 1);\n      bearingEl.value = fmt(vs.bearing ?? 0, 1);\n    } catch (_) {}\n  };\n\n  const applyView = () => {\n    const lng = parseFloat(lngEl.value);\n    const lat = parseFloat(latEl.value);\n    const zoom = parseFloat(zoomEl.value);\n    const pitch = parseFloat(pitchEl.value);\n    const bearing = parseFloat(bearingEl.value);\n    try {\n      map.jumpTo({\n        center: [\n          Number.isFinite(lng) ? lng : initial.longitude,\n          Number.isFinite(lat) ? lat : initial.latitude\n        ],\n        zoom: Number.isFinite(zoom) ? zoom : map.getZoom(),\n        pitch: Number.isFinite(pitch) ? pitch : map.getPitch(),\n        bearing: Number.isFinite(bearing) ? bearing : map.getBearing()\n      } as any);\n    } catch (_) {}\n  };\n\n  const copyCurrent = async () => {\n    try {\n      await navigator.clipboard.writeText(viewOut.value || '');\n    } catch (_) {}\n  };\n\n  const onToggle = () => {\n    const collapsed = panel.classList.toggle('collapsed');\n    toggle.innerHTML = collapsed ? '&#x203A;' : '&#x2039;';\n    updateDebugTogglePosition(shell!, panel, toggle);\n  };\n\n\n  // Resize handle (sticky toggle)\n  let resizing = false;\n  let startX = 0;\n  let startW = 280;\n  const onResizeMove = (e: PointerEvent) => {\n    if (!resizing) return;\n    const dx = e.clientX - startX;\n    const w = clamp(startW + dx, 240, 520);\n    panel.style.width = `${w}px`;\n    updateDebugTogglePosition(shell!, panel, toggle);\n    e.preventDefault();\n  };\n  const onResizeUp = (_e: PointerEvent) => {\n    if (!resizing) return;\n    resizing = false;\n    window.removeEventListener('pointermove', onResizeMove as any);\n    window.removeEventListener('pointerup', onResizeUp as any);\n  };\n  const onResizeDown = (e: PointerEvent) => {\n    resizing = true;\n    startX = e.clientX;\n    startW = panel.getBoundingClientRect().width || 280;\n    window.addEventListener('pointermove', onResizeMove as any, { passive: false });\n    window.addEventListener('pointerup', onResizeUp as any);\n    e.preventDefault();\n    e.stopPropagation();\n  };\n\n  // Event wiring\n  toggle.addEventListener('click', onToggle);\n  resizeHandle.addEventListener('pointerdown', onResizeDown as any, { passive: false });\n\n  // Layer editor events\n  layerSelect.addEventListener('change', () => readLayerToUI());\n  fillFnEl.addEventListener('change', () => { updateFillFnOptions(); applyUIToLayer(); });\n  lineFnEl.addEventListener('change', () => { updateLineFnOptions(); applyUIToLayer(); });\n  [filledEl, strokedEl].forEach((el) => el.addEventListener('change', applyUIToLayer));\n  extrudedEl.addEventListener('change', () => {\n    try { if (extrusionControls) extrusionControls.style.display = extrudedEl.checked ? 'block' : 'none'; } catch (_) {}\n    applyUIToLayer();\n  });\n  elevAttrEl.addEventListener('change', applyUIToLayer);\n  // Number input: make it feel like Deck.gl (updates while typing / clicking steppers)\n  elevScaleEl.addEventListener('input', applyUIToLayer);\n  elevScaleEl.addEventListener('change', applyUIToLayer);\n  opacitySliderEl.addEventListener('input', () => { opacityEl.value = opacitySliderEl.value; applyUIToLayer(); });\n  opacityEl.addEventListener('change', () => { opacitySliderEl.value = opacityEl.value; applyUIToLayer(); });\n  [fillAttrEl, fillStepsEl, fillReverseEl].forEach((el) => el.addEventListener('change', () => {\n    // keep palette swatches/menu in sync with reverse + steps\n    try { fillPal.refresh(); } catch (_) {}\n    try { linePal.refresh(); } catch (_) {}\n    applyUIToLayer();\n  }));\n  // Domain inputs -> slider (no repaint while typing)\n  fillDomainMinEl.addEventListener('input', () => { syncDomainSliderFromInputs(); });\n  fillDomainMaxEl.addEventListener('input', () => { syncDomainSliderFromInputs(); });\n  // Enter/blur -> apply + disable autoDomain so it won't revert\n  fillDomainMinEl.addEventListener('change', () => { markDomainFromUser(); applyUIToLayer(); });\n  fillDomainMaxEl.addEventListener('change', () => { markDomainFromUser(); applyUIToLayer(); });\n  // Slider -> inputs (no repaint while dragging; repaint once on change)\n  fillRangeMinEl.addEventListener('input', onDomainSliderInput);\n  fillRangeMaxEl.addEventListener('input', onDomainSliderInput);\n  fillRangeMinEl.addEventListener('change', onDomainSliderChange);\n  fillRangeMaxEl.addEventListener('change', onDomainSliderChange);\n  fillNullEl.addEventListener('input', () => { fillNullLabel.textContent = fillNullEl.value; applyUIToLayer(); });\n  fillStaticEl.addEventListener('input', () => { fillStaticLabel.textContent = fillStaticEl.value; applyUIToLayer(); });\n  [lineAttrEl, lineDomainMinEl, lineDomainMaxEl, lineReverseEl].forEach((el) => el.addEventListener('change', () => {\n    try { linePal.refresh(); } catch (_) {}\n    applyUIToLayer();\n  }));\n  lineStaticEl.addEventListener('input', () => { lineStaticLabel.textContent = lineStaticEl.value; applyUIToLayer(); });\n  lineWidthSliderEl.addEventListener('input', () => { lineWidthEl.value = lineWidthSliderEl.value; applyUIToLayer(); });\n  lineWidthEl.addEventListener('change', () => { lineWidthSliderEl.value = lineWidthEl.value; applyUIToLayer(); });\n\n  // Update viewstate only on \"stop\"\n  try {\n    map.on('moveend', updateFromMapStop);\n    map.on('rotateend', updateFromMapStop);\n    map.on('pitchend', updateFromMapStop);\n  } catch (_) {}\n\n  // Initial render\n  updateFillFnOptions();\n  updateLineFnOptions();\n  try { fillPal.refresh(); } catch (_) {}\n  try { linePal.refresh(); } catch (_) {}\n  readLayerToUI();\n  updateFromMapStop();\n  updateDebugTogglePosition(shell!, panel, toggle);\n  window.addEventListener('resize', () => updateDebugTogglePosition(shell!, panel, toggle));\n\n  return {\n    destroy: () => {\n      try { palMgr.destroy(); } catch (_) {}\n      try { toggle.removeEventListener('click', onToggle); } catch (_) {}\n      try { tabUiBtn?.removeEventListener('click', onTabClick as any); } catch (_) {}\n      try { tabSqlBtn?.removeEventListener('click', onTabClick as any); } catch (_) {}\n      try { tabAiBtn?.removeEventListener('click', onTabClick as any); } catch (_) {}\n      // view state buttons removed\n      try { resizeHandle.removeEventListener('pointerdown', onResizeDown as any); } catch (_) {}\n      try {\n        map.off('moveend', updateFromMapStop);\n        map.off('rotateend', updateFromMapStop);\n        map.off('pitchend', updateFromMapStop);\n      } catch (_) {}\n      try { sqlPanel?.destroy(); } catch (_) {}\n      try { sqlPanel = null; } catch (_) {}\n      try { aiPanel?.destroy(); } catch (_) {}\n      try { aiPanel = null; } catch (_) {}\n      try { shell?.remove(); } catch (_) {}\n    }\n  };\n}\n\n\n","/**\n * AI Panel - Natural language to DuckDB SQL generation\n */\n\nexport interface AiConfig {\n  enabled: boolean;\n  apiKey?: string;\n  model?: string;\n  schema?: {\n    tables: Record<string, {\n      name: string;\n      columns: Array<{ name: string; type: string; description?: string }>;\n      sql?: string;\n    }>;\n    description?: string;\n  };\n  systemPrompt?: string;\n}\n\nexport interface AiPanelDeps {\n  aiSection: HTMLElement;\n  aiChatEl: HTMLElement;\n  aiInputEl: HTMLTextAreaElement;\n  aiSendBtn: HTMLButtonElement;\n  aiStatusEl: HTMLElement;\n  aiSqlPreviewEl: HTMLElement;\n  getActiveLayerId: () => string | null;\n  onSqlGenerated: (layerId: string, sql: string) => void;\n}\n\nexport interface AiPanel {\n  setConfig: (config: AiConfig) => void;\n  destroy: () => void;\n}\n\ninterface ChatMessage {\n  role: 'user' | 'assistant' | 'system';\n  content: string;\n  sql?: string;\n}\n\nconst DEFAULT_MODEL = 'openai/gpt-4o-mini';\n\nfunction buildSystemPrompt(config: AiConfig): string {\n  const schema = config.schema;\n  let schemaDesc = '';\n\n  if (schema?.tables) {\n    const tableDescs = Object.entries(schema.tables).map(([id, table]) => {\n      const cols = table.columns.map(c => {\n        let desc = `  - ${c.name} (${c.type})`;\n        if (c.description) desc += `: ${c.description}`;\n        return desc;\n      }).join('\\n');\n      return `Table: data (alias for layer \"${table.name}\")\\nColumns:\\n${cols}`;\n    });\n    schemaDesc = tableDescs.join('\\n\\n');\n  }\n\n  const customPrompt = config.systemPrompt || '';\n\n  return `You are a DuckDB SQL query assistant for a geospatial map application.\n\nYour job is to convert natural language questions into valid DuckDB SQL queries.\n\n${schema?.description || ''}\n\nAvailable Schema:\n${schemaDesc || 'No schema information available.'}\n\nRules:\n1. Always use \"data\" as the table name\n2. Output ONLY the SQL query, nothing else\n3. Use standard SQL syntax compatible with DuckDB\n4. For filtering, use WHERE clauses\n5. For aggregations, use GROUP BY with appropriate columns\n6. The \"hex\" column contains H3 hexagon IDs - always include it in SELECT\n7. Keep queries simple and focused on filtering/aggregating the data\n\n${customPrompt}\n\nExamples:\nUser: \"Show me areas with more than 50% coverage\"\nSQL: SELECT * FROM data WHERE pct > 50\n\nUser: \"Filter to crop type 1\"\nSQL: SELECT * FROM data WHERE data = 1\n\nUser: \"Show top 10 hexes by area\"\nSQL: SELECT * FROM data ORDER BY area DESC LIMIT 10`;\n}\n\nasync function callOpenRouter(\n  apiKey: string,\n  model: string,\n  messages: Array<{ role: string; content: string }>\n): Promise<string> {\n  const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n      'Authorization': `Bearer ${apiKey}`,\n    },\n    body: JSON.stringify({\n      model,\n      messages,\n      max_tokens: 500,\n      temperature: 0.1,\n    }),\n  });\n\n  if (!response.ok) {\n    const text = await response.text();\n    throw new Error(`API error ${response.status}: ${text}`);\n  }\n\n  const data = await response.json();\n  return data.choices?.[0]?.message?.content || '';\n}\n\nfunction extractSqlFromResponse(response: string): string {\n  // Try to extract SQL from markdown code blocks\n  const codeBlockMatch = response.match(/```(?:sql)?\\s*([\\s\\S]*?)```/i);\n  if (codeBlockMatch) {\n    return codeBlockMatch[1].trim();\n  }\n\n  // Try to find SELECT statement\n  const selectMatch = response.match(/(SELECT[\\s\\S]*?(?:;|$))/i);\n  if (selectMatch) {\n    return selectMatch[1].trim().replace(/;$/, '');\n  }\n\n  // Return as-is if it looks like SQL\n  const trimmed = response.trim();\n  if (trimmed.toUpperCase().startsWith('SELECT')) {\n    return trimmed.replace(/;$/, '');\n  }\n\n  return trimmed;\n}\n\nfunction validateSql(sql: string): { valid: boolean; error?: string } {\n  const upper = sql.toUpperCase();\n\n  // Block dangerous operations\n  const dangerous = ['DROP', 'DELETE', 'INSERT', 'UPDATE', 'ALTER', 'CREATE TABLE', 'TRUNCATE'];\n  for (const keyword of dangerous) {\n    if (upper.includes(keyword)) {\n      return { valid: false, error: `Dangerous operation not allowed: ${keyword}` };\n    }\n  }\n\n  // Must be a SELECT query\n  if (!upper.trim().startsWith('SELECT')) {\n    return { valid: false, error: 'Query must start with SELECT' };\n  }\n\n  return { valid: true };\n}\n\nexport function createAiPanel(deps: AiPanelDeps): AiPanel {\n  const {\n    aiSection,\n    aiChatEl,\n    aiInputEl,\n    aiSendBtn,\n    aiStatusEl,\n    aiSqlPreviewEl,\n    getActiveLayerId,\n    onSqlGenerated,\n  } = deps;\n\n  let config: AiConfig = { enabled: false };\n  let chatHistory: ChatMessage[] = [];\n  let isLoading = false;\n\n  const setStatus = (text: string, isError = false) => {\n    try {\n      aiStatusEl.textContent = text;\n      aiStatusEl.style.color = isError ? '#ff6b6b' : '#888';\n    } catch (_) {}\n  };\n\n  const renderChat = () => {\n    try {\n      aiChatEl.innerHTML = chatHistory\n        .filter(m => m.role !== 'system')\n        .map(m => {\n          const isUser = m.role === 'user';\n          return `\n            <div class=\"ai-message ${isUser ? 'user' : 'assistant'}\">\n              <div class=\"ai-message-content\">${escapeHtml(m.content)}</div>\n              ${m.sql ? `<div class=\"ai-message-sql\"><code>${escapeHtml(m.sql)}</code></div>` : ''}\n            </div>\n          `;\n        }).join('');\n      aiChatEl.scrollTop = aiChatEl.scrollHeight;\n    } catch (_) {}\n  };\n\n  const escapeHtml = (text: string): string => {\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n  };\n\n  const showSqlPreview = (sql: string) => {\n    try {\n      aiSqlPreviewEl.innerHTML = `\n        <div class=\"ai-sql-preview\">\n          <div class=\"ai-sql-label\">Generated SQL:</div>\n          <code>${escapeHtml(sql)}</code>\n          <div class=\"ai-sql-actions\">\n            <button class=\"ai-apply-btn\" title=\"Apply this query\">Apply</button>\n            <button class=\"ai-copy-btn\" title=\"Copy SQL\">Copy</button>\n          </div>\n        </div>\n      `;\n      aiSqlPreviewEl.style.display = 'block';\n\n      // Wire up buttons\n      const applyBtn = aiSqlPreviewEl.querySelector('.ai-apply-btn');\n      const copyBtn = aiSqlPreviewEl.querySelector('.ai-copy-btn');\n\n      applyBtn?.addEventListener('click', () => {\n        const layerId = getActiveLayerId();\n        if (layerId) {\n          onSqlGenerated(layerId, sql);\n          setStatus('Query applied!');\n        } else {\n          setStatus('No active layer', true);\n        }\n      });\n\n      copyBtn?.addEventListener('click', async () => {\n        try {\n          await navigator.clipboard.writeText(sql);\n          setStatus('Copied!');\n        } catch (_) {\n          setStatus('Copy failed', true);\n        }\n      });\n    } catch (_) {}\n  };\n\n  const hideSqlPreview = () => {\n    try {\n      aiSqlPreviewEl.style.display = 'none';\n      aiSqlPreviewEl.innerHTML = '';\n    } catch (_) {}\n  };\n\n  const sendMessage = async () => {\n    if (isLoading) return;\n\n    const userInput = aiInputEl.value.trim();\n    if (!userInput) return;\n\n    if (!config.apiKey) {\n      setStatus('No API key configured', true);\n      return;\n    }\n\n    const layerId = getActiveLayerId();\n    if (!layerId) {\n      setStatus('Select a DuckDB layer first', true);\n      return;\n    }\n\n    // Add user message\n    chatHistory.push({ role: 'user', content: userInput });\n    aiInputEl.value = '';\n    renderChat();\n    hideSqlPreview();\n\n    isLoading = true;\n    setStatus('Thinking...');\n    aiSendBtn.disabled = true;\n\n    try {\n      // Build messages for API\n      const systemPrompt = buildSystemPrompt(config);\n      const apiMessages = [\n        { role: 'system', content: systemPrompt },\n        ...chatHistory.map(m => ({ role: m.role, content: m.content })),\n      ];\n\n      const response = await callOpenRouter(\n        config.apiKey,\n        config.model || DEFAULT_MODEL,\n        apiMessages\n      );\n\n      const sql = extractSqlFromResponse(response);\n      const validation = validateSql(sql);\n\n      if (!validation.valid) {\n        chatHistory.push({\n          role: 'assistant',\n          content: `I generated a query but it was blocked: ${validation.error}`,\n        });\n        setStatus(validation.error || 'Invalid query', true);\n      } else {\n        chatHistory.push({\n          role: 'assistant',\n          content: 'Here\\'s the SQL query:',\n          sql,\n        });\n        showSqlPreview(sql);\n        setStatus('');\n      }\n    } catch (err: any) {\n      const errMsg = err?.message || 'Unknown error';\n      chatHistory.push({\n        role: 'assistant',\n        content: `Sorry, there was an error: ${errMsg}`,\n      });\n      setStatus(errMsg, true);\n    } finally {\n      isLoading = false;\n      aiSendBtn.disabled = false;\n      renderChat();\n    }\n  };\n\n  // Event listeners\n  const onKeydown = (e: KeyboardEvent) => {\n    if (e.key === 'Enter' && !e.shiftKey) {\n      e.preventDefault();\n      sendMessage();\n    }\n  };\n\n  const onSendClick = () => sendMessage();\n\n  try {\n    aiInputEl.addEventListener('keydown', onKeydown);\n    aiSendBtn.addEventListener('click', onSendClick);\n  } catch (_) {}\n\n  // Initial state\n  renderChat();\n  setStatus(config.enabled ? '' : 'AI not configured');\n\n  return {\n    setConfig: (newConfig: AiConfig) => {\n      config = newConfig;\n      if (!config.enabled || !config.apiKey) {\n        setStatus('AI not configured - add ai_config to deckgl_layers()');\n        aiInputEl.disabled = true;\n        aiSendBtn.disabled = true;\n      } else {\n        setStatus('');\n        aiInputEl.disabled = false;\n        aiSendBtn.disabled = false;\n        aiInputEl.placeholder = 'Ask: \"Show hexes where pct > 50\"';\n      }\n    },\n    destroy: () => {\n      try { aiInputEl.removeEventListener('keydown', onKeydown); } catch (_) {}\n      try { aiSendBtn.removeEventListener('click', onSendClick); } catch (_) {}\n    },\n  };\n}\n","/**\n * Click-to-highlight interaction\n */\n\nimport type { LayerConfig, HexLayerConfig } from '../types';\nimport { toH3 } from '../layers/hex';\n\nconst HIGHLIGHT_FILL = 'rgba(255,255,0,0.3)';\nconst HIGHLIGHT_LINE = 'rgba(255,255,0,1)';\nconst HIGHLIGHT_LINE_WIDTH = 3;\n\nlet highlightLayerAdded = false;\nlet selectedFeature: any = null;\n\n/**\n * Setup click-to-highlight for all layers\n */\nexport function setupHighlight(\n  map: mapboxgl.Map,\n  layers: LayerConfig[],\n  visibilityState: Record<string, boolean>,\n  deckOverlay: unknown\n): void {\n  map.on('click', (e: any) => {\n    const queryLayers = getQueryableLayers(map, layers);\n    if (!queryLayers.length) return;\n    \n    let features: any[] = [];\n    try {\n      features = map.queryRenderedFeatures(e.point, { layers: queryLayers }) || [];\n    } catch (err) {\n      // Ignore errors\n    }\n    \n    if (features.length > 0) {\n      highlightFeature(map, features[0]);\n    } else if (deckOverlay) {\n      // Try Deck.gl overlay\n      const info = (deckOverlay as any)?.pickObject?.({ x: e.point.x, y: e.point.y, radius: 4 });\n      if (info?.object) {\n        highlightFeature(map, {\n          properties: info.object.properties || info.object,\n          geometry: null\n        });\n      } else if (selectedFeature) {\n        highlightFeature(map, null);\n      }\n    } else if (selectedFeature) {\n      highlightFeature(map, null);\n    }\n  });\n}\n\n/**\n * Get queryable layer IDs for click\n */\nfunction getQueryableLayers(map: mapboxgl.Map, layers: LayerConfig[]): string[] {\n  const result: string[] = [];\n  \n  layers.forEach(layer => {\n    if ((layer as any).isTileLayer) return;\n    \n    const layerType = layer.layerType;\n    let ids: string[] = [];\n    \n    if (layerType === 'vector') {\n      ids = [`${layer.id}-fill`, `${layer.id}-circle`, `${layer.id}-line`];\n    } else if (layerType === 'hex') {\n      const hexLayer = layer as HexLayerConfig;\n      ids = [hexLayer.hexLayer?.extruded ? `${layer.id}-extrusion` : `${layer.id}-fill`];\n    }\n    \n    ids.forEach(id => {\n      try {\n        if (map.getLayer(id)) result.push(id);\n      } catch (e) {}\n    });\n  });\n  \n  // Also check for legacy layer IDs\n  ['gdf-fill', 'gdf-circle', 'hex-fill'].forEach(id => {\n    try {\n      if (map.getLayer(id)) result.push(id);\n    } catch (e) {}\n  });\n  \n  return result;\n}\n\n/**\n * Highlight a feature on the map\n */\nfunction highlightFeature(map: mapboxgl.Map, feature: any): void {\n  let geojson: GeoJSON.FeatureCollection = { type: 'FeatureCollection', features: [] };\n  \n  if (feature) {\n    const props = feature.properties || {};\n    const hexId = props.hex || props.h3;\n    \n    // If it's a hex, use H3 to get boundary\n    if (hexId && window.h3) {\n      try {\n        const id = toH3(hexId);\n        if (id && window.h3.isValidCell(id)) {\n          const boundary = window.h3.cellToBoundary(id).map(([lat, lng]: [number, number]) => [lng, lat]);\n          boundary.push(boundary[0]);\n          geojson.features.push({\n            type: 'Feature',\n            geometry: { type: 'Polygon', coordinates: [boundary] },\n            properties: props\n          });\n        }\n      } catch (e) {}\n    }\n    // Otherwise use the feature's actual geometry (for vectors)\n    else if (feature.geometry) {\n      geojson.features.push({\n        type: 'Feature',\n        geometry: feature.geometry,\n        properties: props\n      });\n    }\n  }\n  \n  if (!highlightLayerAdded) {\n    map.addSource('feature-hl', { type: 'geojson', data: geojson });\n    map.addLayer({\n      id: 'feature-hl-fill',\n      type: 'fill',\n      source: 'feature-hl',\n      paint: {\n        'fill-color': HIGHLIGHT_FILL,\n        'fill-opacity': 1\n      }\n    });\n    map.addLayer({\n      id: 'feature-hl-line',\n      type: 'line',\n      source: 'feature-hl',\n      paint: {\n        'line-color': HIGHLIGHT_LINE,\n        'line-width': HIGHLIGHT_LINE_WIDTH\n      }\n    });\n    highlightLayerAdded = true;\n  } else {\n    (map.getSource('feature-hl') as any).setData(geojson);\n  }\n  \n  selectedFeature = feature;\n}\n\n\n\n\n\n\n","/**\n * Message bus utilities for cross-component communication\n * \n * Uses BroadcastChannel API + postMessage fallback for iframe communication\n */\n\nexport interface BusMessage {\n  type: string;\n  fromComponent?: string;\n  timestamp?: number;\n  [key: string]: unknown;\n}\n\n/**\n * Create a message bus for a channel\n */\nexport function createBus(channel: string): {\n  send: (message: BusMessage) => void;\n  onMessage: (callback: (message: BusMessage) => void) => void;\n  destroy: () => void;\n} {\n  let bc: BroadcastChannel | null = null;\n  let messageCallback: ((message: BusMessage) => void) | null = null;\n  \n  // Try to create BroadcastChannel\n  try {\n    if ('BroadcastChannel' in window) {\n      bc = new BroadcastChannel(channel);\n    }\n  } catch (e) {\n    // BroadcastChannel not available\n  }\n  \n  /**\n   * Send a message to all possible targets\n   */\n  function send(obj: BusMessage): void {\n    const s = JSON.stringify(obj);\n    \n    // BroadcastChannel\n    try {\n      if (bc) bc.postMessage(obj);\n    } catch (e) {}\n    \n    // Parent frame\n    try {\n      window.parent.postMessage(s, '*');\n    } catch (e) {}\n    \n    // Top frame (if different from parent)\n    try {\n      if (window.top && window.top !== window.parent) {\n        window.top.postMessage(s, '*');\n      }\n    } catch (e) {}\n    \n    // Sibling frames\n    try {\n      if (window.top?.frames) {\n        for (let i = 0; i < window.top.frames.length; i++) {\n          const f = window.top.frames[i];\n          if (f !== window) {\n            try {\n              f.postMessage(s, '*');\n            } catch (e) {}\n          }\n        }\n      }\n    } catch (e) {}\n  }\n  \n  /**\n   * Set up message listener\n   */\n  function onMessage(callback: (message: BusMessage) => void): void {\n    messageCallback = callback;\n    \n    // Listen to BroadcastChannel\n    if (bc) {\n      bc.onmessage = (e) => {\n        if (messageCallback) messageCallback(e.data);\n      };\n    }\n    \n    // Listen to postMessage\n    window.addEventListener('message', handlePostMessage);\n  }\n  \n  function handlePostMessage(e: MessageEvent): void {\n    if (!messageCallback) return;\n    \n    let data: BusMessage;\n    try {\n      data = typeof e.data === 'string' ? JSON.parse(e.data) : e.data;\n    } catch {\n      return;\n    }\n    \n    messageCallback(data);\n  }\n  \n  /**\n   * Clean up\n   */\n  function destroy(): void {\n    if (bc) {\n      bc.close();\n      bc = null;\n    }\n    window.removeEventListener('message', handlePostMessage);\n    messageCallback = null;\n  }\n  \n  return { send, onMessage, destroy };\n}\n\n/**\n * Generate a unique component ID\n */\nexport function generateComponentId(prefix: string = 'component'): string {\n  return `${prefix}-${Math.random().toString(36).substr(2, 9)}`;\n}\n\n\n\n\n\n\n","/**\n * Messaging module - cross-component communication\n */\n\nimport type { MessagingConfig, LayerConfig } from '../types';\nimport { enableBroadcast } from './broadcast';\nimport { enableSync } from './sync';\n\nexport * from './bus';\nexport * from './broadcast';\nexport * from './sync';\n\n/**\n * Setup all messaging based on config\n */\nexport function setupMessaging(\n  map: mapboxgl.Map,\n  config: MessagingConfig,\n  layers: LayerConfig[]\n): void {\n  // Viewport broadcast\n  if (config.broadcast?.enabled) {\n    enableBroadcast(map, {\n      channel: config.broadcast.channel,\n      dataset: config.broadcast.dataset\n    });\n  }\n  \n  // Map sync\n  if (config.sync?.enabled) {\n    enableSync(map, {\n      channel: config.sync.channel\n    });\n  }\n  \n  // Click broadcast (TODO: implement)\n  if (config.clickBroadcast?.enabled) {\n    // enableClickBroadcast(map, layers, config.clickBroadcast);\n  }\n  \n  // Location listener (TODO: implement)\n  if (config.locationListener?.enabled) {\n    // enableLocationListener(map, config.locationListener);\n  }\n}\n\n\n\n\n\n\n","/**\n * Viewport broadcast - notify other components when map bounds change\n */\n\nimport { createBus, generateComponentId, BusMessage } from './bus';\nimport { getBoundsArray, boundsEqual } from '../core/view';\n\nexport interface BroadcastOptions {\n  channel?: string;\n  dataset?: string;\n}\n\n/**\n * Enable viewport bounds broadcast on a map\n */\nexport function enableBroadcast(\n  map: mapboxgl.Map,\n  options: BroadcastOptions = {}\n): () => void {\n  const channel = options.channel || 'fused-bus';\n  const dataset = options.dataset || 'all';\n  const componentId = generateComponentId('map-broadcast');\n  \n  const bus = createBus(channel);\n  let lastBounds: [number, number, number, number] | null = null;\n  \n  function broadcastBounds(): void {\n    const bounds = getBoundsArray(map);\n    if (boundsEqual(bounds, lastBounds)) return;\n    lastBounds = bounds;\n\n    const [west, south, east, north] = bounds;\n    bus.send({\n      type: 'filter',\n      fromComponent: componentId,\n      timestamp: Date.now(),\n      dataset: dataset,\n      filter: { type: 'spatial', field: 'geometry', values: [west, south, east, north] }\n    });\n  }\n  \n  // Listen for map movement\n  map.on('move', broadcastBounds);\n  map.on('moveend', broadcastBounds);\n  \n  // Initial broadcast on load\n  map.on('load', () => {\n    setTimeout(broadcastBounds, 300);\n  });\n  \n  // If map is already loaded, broadcast now\n  if (map.loaded()) {\n    setTimeout(broadcastBounds, 100);\n  }\n  \n  // Announce component ready\n  setTimeout(() => {\n    bus.send({\n      type: 'component_ready',\n      componentType: 'map',\n      componentId: componentId,\n      capabilities: ['spatial_filter'],\n      dataSource: 'viewport',\n      protocol: 'unified'\n    });\n  }, 200);\n  \n  // Return cleanup function\n  return () => {\n    map.off('move', broadcastBounds);\n    map.off('moveend', broadcastBounds);\n    bus.destroy();\n  };\n}\n\n","/**\n * View state management utilities\n */\n\n/**\n * Get bounds array from map [west, south, east, north]\n */\nexport function getBoundsArray(map: mapboxgl.Map): [number, number, number, number] {\n  const b = map.getBounds();\n  return [\n    +b.getWest().toFixed(6),\n    +b.getSouth().toFixed(6),\n    +b.getEast().toFixed(6),\n    +b.getNorth().toFixed(6)\n  ];\n}\n\n/**\n * Check if two bounds arrays are approximately equal\n */\nexport function boundsEqual(\n  a: [number, number, number, number] | null,\n  b: [number, number, number, number] | null\n): boolean {\n  if (!a || !b) return false;\n  return a[0] === b[0] && a[1] === b[1] && a[2] === b[2] && a[3] === b[3];\n}\n\n\n\n\n\n\n","/**\n * Map sync - synchronize multiple maps' viewports\n */\n\nimport { createBus, generateComponentId } from './bus';\nimport { getViewState } from '../core/map';\nimport type { ViewState } from '../types';\n\nexport interface SyncOptions {\n  channel?: string;\n}\n\ninterface SyncState extends ViewState {\n  id: string;\n  ts: number;\n}\n\n/**\n * Enable map sync on a map\n */\nexport function enableSync(\n  map: mapboxgl.Map,\n  options: SyncOptions = {}\n): () => void {\n  let channel = options.channel || 'default';\n  if (!channel.includes('::')) {\n    channel = `map-sync::${channel}`;\n  }\n  \n  const mapId = generateComponentId('map');\n  const bus = createBus(channel);\n  \n  let isSyncing = false;\n  let userInteracting = false;\n  let lastBroadcast = { x: NaN, y: NaN, z: NaN };\n  \n  const eq = (a: number, b: number, e: number) => Math.abs(a - b) < e;\n  \n  function getState(): SyncState {\n    const center = map.getCenter();\n    return {\n      longitude: +center.lng.toFixed(6),\n      latitude: +center.lat.toFixed(6),\n      zoom: +map.getZoom().toFixed(3),\n      bearing: +map.getBearing().toFixed(1),\n      pitch: +map.getPitch().toFixed(1),\n      id: mapId,\n      ts: Date.now()\n    };\n  }\n  \n  function broadcast(): void {\n    if (isSyncing) return;\n    \n    const state = getState();\n    const { longitude: x, latitude: y, zoom: z } = state;\n    \n    if (eq(x, lastBroadcast.x, 1e-6) &&\n        eq(y, lastBroadcast.y, 1e-6) &&\n        eq(z, lastBroadcast.z, 1e-3)) {\n      return;\n    }\n    \n    lastBroadcast = { x, y, z };\n    bus.send({ type: 'sync', ...state });\n  }\n  \n  function applySync(state: SyncState): void {\n    if (!state || state.id === mapId) return;\n    if (isSyncing || userInteracting) return;\n    \n    isSyncing = true;\n    map.jumpTo({\n      center: [state.longitude, state.latitude],\n      zoom: state.zoom,\n      bearing: state.bearing,\n      pitch: state.pitch\n    });\n    \n    requestAnimationFrame(() => {\n      isSyncing = false;\n    });\n  }\n  \n  let moveTimeout: ReturnType<typeof setTimeout> | null = null;\n  \n  function scheduleBroadcast(): void {\n    if (moveTimeout) clearTimeout(moveTimeout);\n    moveTimeout = setTimeout(broadcast, 0);\n  }\n  \n  const startInteraction = () => {\n    userInteracting = true;\n  };\n  \n  const finishInteraction = () => {\n    if (!userInteracting) return;\n    userInteracting = false;\n    broadcast();\n  };\n  \n  // Event listeners\n  map.on('dragstart', startInteraction);\n  map.on('zoomstart', startInteraction);\n  map.on('rotatestart', startInteraction);\n  map.on('pitchstart', startInteraction);\n  map.on('moveend', finishInteraction);\n  \n  map.on('move', () => {\n    if (userInteracting && !isSyncing) scheduleBroadcast();\n  });\n  \n  // Listen for sync messages\n  bus.onMessage((msg) => {\n    if (msg.type === 'sync' && (msg as unknown as SyncState).id !== mapId) {\n      applySync(msg as unknown as SyncState);\n    }\n  });\n  \n  // Initial sync on load\n  map.on('load', () => {\n    setTimeout(() => bus.send({ type: 'sync', ...getState() }), 100 + Math.random() * 100);\n  });\n  \n  // Handle visibility change\n  document.addEventListener('visibilitychange', () => {\n    if (document.hidden) {\n      isSyncing = false;\n      userInteracting = false;\n    }\n  });\n  \n  // Return cleanup function\n  return () => {\n    map.off('dragstart', startInteraction);\n    map.off('zoomstart', startInteraction);\n    map.off('rotatestart', startInteraction);\n    map.off('pitchstart', startInteraction);\n    map.off('moveend', finishInteraction);\n    bus.destroy();\n  };\n}\n\n","import type { HexLayerConfig } from '../types';\nimport { toH3 } from '../layers/hex';\nimport type { FeatureCollection } from 'geojson';\n\n// Default pinned DuckDB-WASM ESM version (can be overridden per runtime instance).\n// User requested: https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1.33.1-dev13.0/+esm\nconst DEFAULT_DUCKDB_WASM_VERSION = '1.33.1-dev13.0';\n\ntype DuckModule = any;\ntype DuckDb = any;\ntype DuckConn = any;\n\nconst duckModulePromisesByVersion = new Map<string, Promise<DuckModule>>();\n\nfunction isSafeStructKey(name: string): boolean {\n  return /^[A-Za-z_][A-Za-z0-9_]*$/.test(name);\n}\n\nfunction quoteIdent(name: string): string {\n  // DuckDB uses standard SQL identifier quoting with double quotes.\n  return `\"${String(name).replace(/\"/g, '\"\"')}\"`;\n}\n\nasync function ensureDuckModule(version: string = DEFAULT_DUCKDB_WASM_VERSION): Promise<DuckModule> {\n  const existing = duckModulePromisesByVersion.get(version);\n  if (existing) return existing;\n  const url = `https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@${version}/+esm`;\n  const p = import(/* @vite-ignore */ url) as any;\n  duckModulePromisesByVersion.set(version, p);\n  return p;\n}\n\nfunction decodeBase64ToBytes(b64: string): Uint8Array {\n  const binaryString = atob(b64);\n  const bytes = new Uint8Array(binaryString.length);\n  for (let i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i);\n  return bytes;\n}\n\nfunction sanitizeDuckRow(row: Record<string, unknown>): Record<string, unknown> {\n  const hexCols = new Set(['hex', 'h3', 'index', 'id']);\n  const out: Record<string, unknown> = {};\n  for (const k of Object.keys(row)) {\n    let v: any = (row as any)[k];\n    if (typeof v === 'bigint') {\n      if (hexCols.has(k.toLowerCase())) v = v.toString(16);\n      else v = Number(v);\n    }\n    out[k] = v;\n  }\n  // Normalize hex id into `hex` if present in any common column.\n  const rawHex: any = (out as any).hex ?? (out as any).h3 ?? (out as any).index ?? (out as any).id;\n  const h = toH3(rawHex);\n  if (h) out.hex = h;\n  return out;\n}\n\nexport class DuckDbSqlRuntime {\n  private duck: DuckModule | null = null;\n  private db: DuckDb | null = null;\n  private conn: DuckConn | null = null;\n  private tableByLayerId = new Map<string, string>(); // layer.id -> tableName\n  private loadedTables = new Set<string>(); // tableName\n  private version: string;\n  private hasSpatial = false;\n\n  constructor(opts?: { version?: string }) {\n    this.version = opts?.version || DEFAULT_DUCKDB_WASM_VERSION;\n  }\n\n  get ready(): boolean {\n    return !!this.conn;\n  }\n\n  async init(): Promise<void> {\n    if (this.conn) return;\n    this.duck = await ensureDuckModule(this.version);\n    const duck = this.duck;\n\n    const bundle = await duck.selectBundle(duck.getJsDelivrBundles());\n    const workerSrc = await (await fetch(bundle.mainWorker)).text();\n    const worker = new Worker(URL.createObjectURL(new Blob([workerSrc], { type: 'application/javascript' })));\n    const db = new duck.AsyncDuckDB(new duck.ConsoleLogger(), worker);\n    await db.instantiate(bundle.mainModule);\n    const conn = await db.connect();\n\n    // Optional: try to load H3 extension (ignored on failure).\n    try { await conn.query('INSTALL h3 FROM community'); } catch (_) {}\n    try { await conn.query('LOAD h3'); } catch (_) {}\n\n    // Optional: spatial extension enables ST_AsGeoJSON + ST_GeomFromText so we can build GeoJSON in DuckDB.\n    // (We still work without it; we just fall back to JS geometry.)\n    try { await conn.query('INSTALL spatial'); } catch (_) {}\n    try {\n      await conn.query('LOAD spatial');\n      this.hasSpatial = true;\n    } catch (_) {\n      this.hasSpatial = false;\n    }\n\n    this.db = db;\n    this.conn = conn;\n  }\n\n  private layerTableName(layer: HexLayerConfig): string {\n    const existing = this.tableByLayerId.get(layer.id);\n    if (existing) return existing;\n    const table = layer.id.replace(/-/g, '_');\n    this.tableByLayerId.set(layer.id, table);\n    return table;\n  }\n\n  async ensureLayerTable(layer: HexLayerConfig): Promise<string> {\n    await this.init();\n    if (!this.db || !this.conn) throw new Error('DuckDB not initialized');\n\n    const tableName = this.layerTableName(layer);\n    if (this.loadedTables.has(tableName)) return tableName;\n\n    // Load parquet bytes\n    let bytes: Uint8Array | null = null;\n    if (layer.parquetData) {\n      bytes = decodeBase64ToBytes(layer.parquetData);\n    } else if (layer.parquetUrl) {\n      const resp = await fetch(layer.parquetUrl);\n      if (!resp.ok) throw new Error(`Failed to fetch parquetUrl (${resp.status})`);\n      const ab = await resp.arrayBuffer();\n      bytes = new Uint8Array(ab);\n    }\n    if (!bytes) throw new Error('Missing parquetData or parquetUrl for SQL layer');\n\n    // Register and create table\n    await this.db.registerFileBuffer(`${tableName}.parquet`, bytes);\n    await this.conn.query(`CREATE OR REPLACE TABLE ${tableName} AS SELECT * FROM read_parquet('${tableName}.parquet')`);\n\n    this.loadedTables.add(tableName);\n    return tableName;\n  }\n\n  async runSql(layer: HexLayerConfig, sqlText: string): Promise<{ rows: Array<Record<string, unknown>>; count: number }> {\n    await this.ensureLayerTable(layer);\n    if (!this.conn) throw new Error('DuckDB not initialized');\n\n    const tableName = this.layerTableName(layer);\n    // Match map_utils.py semantics: \"data\" points at the current layer.\n    await this.conn.query(`CREATE OR REPLACE VIEW data AS SELECT * FROM ${tableName}`);\n\n    const sql = (sqlText || '').trim();\n    const isSelectLike = /^(with|select)\\b/i.test(sql);\n    const query = isSelectLike ? sql : `SELECT * FROM data WHERE (${sql || '1=1'})`;\n\n    const res = await this.conn.query(query);\n    const arr = res.toArray() as any[];\n    const rows = arr.map((r) => sanitizeDuckRow(r)).filter((r) => !!(r as any).hex);\n    return { rows, count: rows.length };\n  }\n\n  async getMinMaxFromQuery(\n    layer: HexLayerConfig,\n    attr: string,\n    sqlText: string\n  ): Promise<{ min: number; max: number } | null> {\n    await this.ensureLayerTable(layer);\n    if (!this.conn) return null;\n\n    const tableName = this.layerTableName(layer);\n    await this.conn.query(`CREATE OR REPLACE VIEW data AS SELECT * FROM ${tableName}`);\n\n    const sql = (sqlText || '').trim();\n    const isSelectLike = /^(with|select)\\b/i.test(sql);\n    const query = isSelectLike ? sql : `SELECT * FROM data WHERE (${sql || '1=1'})`;\n\n    const col = quoteIdent(attr);\n    const res = await this.conn.query(`SELECT MIN(${col}) as min_val, MAX(${col}) as max_val FROM (${query}) AS q`);\n    const row: any = (res.toArray() as any[])[0];\n    if (!row) return null;\n    let minVal: any = row.min_val;\n    let maxVal: any = row.max_val;\n    if (typeof minVal === 'bigint') minVal = Number(minVal);\n    if (typeof maxVal === 'bigint') maxVal = Number(maxVal);\n    if (!Number.isFinite(minVal) || !Number.isFinite(maxVal)) return null;\n    return { min: minVal, max: maxVal };\n  }\n\n  /**\n   * Build a GeoJSON FeatureCollection inside DuckDB when possible.\n   *\n   * Requirements:\n   * - h3 extension available (h3_cell_to_boundary_wkt / h3_is_valid_cell)\n   * - spatial extension available (ST_GeomFromText / ST_AsGeoJSON)\n   * - H3 cell column is present and castable to BIGINT (typical for Parquet int64 hex ids)\n   * - Column names are \"safe\" identifiers (for struct_pack); otherwise we fall back to JS.\n   */\n  async runSqlGeoJSON(\n    layer: HexLayerConfig,\n    sqlText: string\n  ): Promise<{ geojson: FeatureCollection; count: number } | null> {\n    await this.ensureLayerTable(layer);\n    if (!this.conn) throw new Error('DuckDB not initialized');\n    if (!this.hasSpatial) return null;\n\n    const tableName = this.layerTableName(layer);\n    await this.conn.query(`CREATE OR REPLACE VIEW data AS SELECT * FROM ${tableName}`);\n\n    const sql = (sqlText || '').trim();\n    const isSelectLike = /^(with|select)\\b/i.test(sql);\n    const query = isSelectLike ? sql : `SELECT * FROM data WHERE (${sql || '1=1'})`;\n\n    // Discover columns cheaply (LIMIT 0) so we can build properties JSON.\n    const schemaRes = await this.conn.query(`SELECT * FROM (${query}) AS q LIMIT 0`);\n    const fields: any[] = schemaRes?.schema?.fields || [];\n    const cols: string[] = fields.map((f: any) => String(f?.name || '')).filter(Boolean);\n\n    const h3Candidates = ['hex', 'h3', 'index', 'id'];\n    const h3Col = h3Candidates.find((c) => cols.includes(c)) || null;\n    if (!h3Col) return null;\n\n    // Only support simple identifier-like column names for now.\n    if (!cols.every(isSafeStructKey)) return null;\n\n    const propsExpr = `to_json(struct_pack(${cols.map((c) => `${c} := \"${c}\"`).join(', ')}))`;\n\n    // Build FeatureCollection as a single JSON string (map_utils.py style)\n    const q = `\n      WITH q AS (${query})\n      SELECT\n        count(*)::BIGINT AS cnt,\n        CASE\n          WHEN count(*) = 0 THEN '{\"type\":\"FeatureCollection\",\"features\":[]}'\n          ELSE (\n            '{\"type\":\"FeatureCollection\",\"features\":[' ||\n              string_agg(\n                '{\"type\":\"Feature\",\"geometry\":' ||\n                  ST_AsGeoJSON(ST_GeomFromText(h3_cell_to_boundary_wkt(CAST(\"${h3Col}\" AS BIGINT)))) ||\n                ',\"properties\":' || ${propsExpr} || '}',\n                ','\n              ) ||\n            ']}'\n          )\n        END AS gj\n      FROM q\n      WHERE \"${h3Col}\" IS NOT NULL\n        AND h3_is_valid_cell(CAST(\"${h3Col}\" AS BIGINT))\n    `;\n\n    const res = await this.conn.query(q);\n    const row: any = (res.toArray() as any[])[0];\n    if (!row) return { geojson: { type: 'FeatureCollection', features: [] } as any, count: 0 };\n\n    let cnt: any = row.cnt;\n    if (typeof cnt === 'bigint') cnt = Number(cnt);\n    const gjStr: string = String(row.gj || '{\"type\":\"FeatureCollection\",\"features\":[]}');\n    const gj = JSON.parse(gjStr);\n    return { geojson: gj as FeatureCollection, count: Number(cnt) || 0 };\n  }\n\n  async getMinMax(layer: HexLayerConfig, attr: string): Promise<{ min: number; max: number } | null> {\n    await this.ensureLayerTable(layer);\n    if (!this.conn) return null;\n    const tableName = this.layerTableName(layer);\n    await this.conn.query(`CREATE OR REPLACE VIEW data AS SELECT * FROM ${tableName}`);\n    const res = await this.conn.query(`SELECT MIN(\"${attr}\") as min_val, MAX(\"${attr}\") as max_val FROM data`);\n    const row: any = (res.toArray() as any[])[0];\n    if (!row) return null;\n    let minVal: any = row.min_val;\n    let maxVal: any = row.max_val;\n    if (typeof minVal === 'bigint') minVal = Number(minVal);\n    if (typeof maxVal === 'bigint') maxVal = Number(maxVal);\n    if (!Number.isFinite(minVal) || !Number.isFinite(maxVal)) return null;\n    return { min: minVal, max: maxVal };\n  }\n}\n\n// NOTE: We intentionally removed the JS geometry fallback for DuckDB SQL layers\n// to keep the implementation simple and fully DuckDB-driven.\n\n\n","import type { FusedMapsConfig, HexLayerConfig, LayerConfig } from '../types';\nimport { DuckDbSqlRuntime } from './duckdb';\nimport { addStaticHexLayer } from '../layers/hex';\nimport { setLayerGeoJSON } from '../layers/index';\nimport { buildColorExpr } from '../color/expressions';\nimport { toRgba } from '../color/palettes';\nimport type { FeatureCollection } from 'geojson';\n\nlet sqlLoader: { setStatus: (layerId: string, status: string) => void } | null = null;\nlet sqlLayerNames: Record<string, string> = {};\n\nfunction isSqlHexLayer(l: LayerConfig): l is HexLayerConfig {\n  return l.layerType === 'hex' && !(l as any).isTileLayer && (!!(l as any).parquetData || !!(l as any).parquetUrl);\n}\n\nfunction ensureSqlLoader(): { setStatus: (layerId: string, status: string) => void } {\n  let el = document.getElementById('sql-loader');\n  if (!el) {\n    el = document.createElement('div');\n    el.id = 'sql-loader';\n    el.innerHTML = `<div class=\"loader-spinner\"></div><span id=\"sql-loader-text\">DuckDBâ€¦</span>`;\n    document.body.appendChild(el);\n  }\n\n  const textEl = document.getElementById('sql-loader-text');\n  let hideTimeout: any = null;\n  const statusByLayer = new Map<string, string>();\n\n  const isBusy = (s: string) => {\n    const t = (s || '').toLowerCase();\n    if (!t) return false;\n    if (t.startsWith('error:')) return false;\n    if (t.includes(' rows')) return false;\n    return t.includes('initializ') || t.includes('running') || t.includes('loading') || t.includes('fetch');\n  };\n\n  const refresh = () => {\n    if (!el) return;\n    const busy = [...statusByLayer.entries()].filter(([, s]) => isBusy(s));\n    if (busy.length) {\n      if (hideTimeout) clearTimeout(hideTimeout);\n      el.classList.add('active');\n\n      // Keep text intentionally simple (map_utils style).\n      // We only show \"Initialisingâ€¦\" or \"Loadingâ€¦\" regardless of layer/count.\n      const anyInit = busy.some(([, s]) => String(s || '').toLowerCase().includes('initializ'));\n      if (textEl) textEl.textContent = anyInit ? 'Initialisingâ€¦' : 'Loadingâ€¦';\n      return;\n    }\n\n    hideTimeout = setTimeout(() => el?.classList.remove('active'), 300);\n  };\n\n  const setStatus = (layerId: string, status: string) => {\n    statusByLayer.set(layerId, String(status || ''));\n    refresh();\n  };\n\n  return { setStatus };\n}\n\nfunction safeSetGeoJsonSource(map: mapboxgl.Map, sourceId: string, geojson: FeatureCollection): boolean {\n  try {\n    const src: any = map.getSource(sourceId) as any;\n    if (src && typeof src.setData === 'function') {\n      src.setData(geojson);\n      return true;\n    }\n  } catch (_) {}\n  return false;\n}\n\nfunction updateHexPaint(map: mapboxgl.Map, layer: HexLayerConfig): void {\n  const cfg: any = layer.hexLayer || {};\n  const data = layer.data || [];\n\n  const fillColor = Array.isArray(cfg.getFillColor)\n    ? toRgba(cfg.getFillColor, 0.8)\n    : buildColorExpr(cfg.getFillColor, data) || 'rgba(0,144,255,0.7)';\n\n  const lineColor = cfg.getLineColor\n    ? (Array.isArray(cfg.getLineColor) ? toRgba(cfg.getLineColor, 1) : buildColorExpr(cfg.getLineColor, data))\n    : 'rgba(255,255,255,0.3)';\n\n  const layerOpacity = (typeof cfg.opacity === 'number' && isFinite(cfg.opacity))\n    ? Math.max(0, Math.min(1, cfg.opacity))\n    : 0.8;\n\n  try {\n    if (cfg.extruded && map.getLayer(`${layer.id}-extrusion`)) {\n      map.setPaintProperty(`${layer.id}-extrusion`, 'fill-extrusion-color', fillColor as any);\n      map.setPaintProperty(`${layer.id}-extrusion`, 'fill-extrusion-opacity', layerOpacity as any);\n    }\n  } catch (_) {}\n\n  try {\n    if (!cfg.extruded && map.getLayer(`${layer.id}-fill`)) {\n      map.setPaintProperty(`${layer.id}-fill`, 'fill-color', fillColor as any);\n      map.setPaintProperty(`${layer.id}-fill`, 'fill-opacity', layerOpacity as any);\n    }\n  } catch (_) {}\n\n  try {\n    if (map.getLayer(`${layer.id}-outline`)) {\n      map.setPaintProperty(`${layer.id}-outline`, 'line-color', lineColor as any);\n      map.setPaintProperty(`${layer.id}-outline`, 'line-width', (cfg.lineWidthMinPixels || 0.5) as any);\n    }\n  } catch (_) {}\n}\n\nfunction dispatchSqlStatus(layerId: string, status: string): void {\n  try {\n    window.dispatchEvent(new CustomEvent('fusedmaps:sql:status', { detail: { layerId, status } }));\n  } catch (_) {}\n  try {\n    if (!sqlLoader) sqlLoader = ensureSqlLoader();\n    sqlLoader?.setStatus(layerId, status);\n  } catch (_) {}\n}\n\nfunction dispatchLegendUpdate(): void {\n  try { window.dispatchEvent(new Event('fusedmaps:legend:update')); } catch (_) {}\n}\n\nexport function setupDuckDbSql(\n  map: mapboxgl.Map,\n  config: FusedMapsConfig,\n  visibilityState: Record<string, boolean>,\n  onUiUpdate?: () => void\n): { destroy: () => void } | null {\n  const sqlLayers = (config.layers || []).filter(isSqlHexLayer);\n  if (!sqlLayers.length) return null;\n\n  // For the global DuckDB loader label.\n  try {\n    sqlLayerNames = {};\n    for (const l of sqlLayers) sqlLayerNames[l.id] = l.name || l.id;\n  } catch (_) {}\n  try {\n    if (!sqlLoader) sqlLoader = ensureSqlLoader();\n  } catch (_) {}\n\n  const runtime = new DuckDbSqlRuntime();\n  let destroyed = false;\n\n  const runForLayer = async (layer: HexLayerConfig, sqlText: string) => {\n    if (destroyed) return;\n    dispatchSqlStatus(layer.id, 'initializing...');\n    try {\n      await runtime.init();\n      if (destroyed) return;\n\n      // If autoDomain is enabled and user has not overridden, initialize domain to dataset extent (full table)\n      try {\n        const fc: any = layer.hexLayer?.getFillColor;\n        const attr = fc && typeof fc === 'object' && !Array.isArray(fc) ? fc.attr : null;\n        const wantsAuto = fc && typeof fc === 'object' && !Array.isArray(fc) && (fc.autoDomain === true || !Array.isArray(fc.domain));\n        if (attr && wantsAuto && (layer as any).fillDomainFromUser !== true) {\n          const mm = await runtime.getMinMax(layer, String(attr));\n          if (mm && layer.hexLayer && typeof layer.hexLayer.getFillColor === 'object' && !Array.isArray(layer.hexLayer.getFillColor)) {\n            (layer.hexLayer.getFillColor as any).domain = [mm.min, mm.max];\n          }\n        }\n      } catch (_) {}\n\n      // Keep the layer's config in sync so debug panel + downstream consumers see it.\n      layer.sql = sqlText || layer.sql || 'SELECT * FROM data';\n\n      // Live domain/legend stats: compute min/max in DuckDB on the filtered query\n      // (avoids an O(N) JS scan + handles numeric types consistently).\n      try {\n        const sqlForStats = layer.sql || 'SELECT * FROM data';\n        const domainFromUser = (layer as any).fillDomainFromUser === true;\n\n        const fc: any = layer.hexLayer?.getFillColor;\n        if (!domainFromUser && fc && typeof fc === 'object' && !Array.isArray(fc) && fc['@@function'] === 'colorContinuous') {\n          const attr = String(fc.attr || '');\n          if (attr && fc.autoDomain === true) {\n            const mm = await runtime.getMinMaxFromQuery(layer, attr, sqlForStats);\n            if (mm) fc.domain = [mm.min, mm.max];\n          }\n        }\n\n        const lc: any = layer.hexLayer?.getLineColor;\n        if (!domainFromUser && lc && typeof lc === 'object' && !Array.isArray(lc) && lc['@@function'] === 'colorContinuous') {\n          const attr = String(lc.attr || '');\n          if (attr && lc.autoDomain === true) {\n            const mm = await runtime.getMinMaxFromQuery(layer, attr, sqlForStats);\n            if (mm) lc.domain = [mm.min, mm.max];\n          }\n        }\n      } catch (_) {}\n\n      // Geometry is generated in DuckDB (spatial + h3 extensions). We intentionally\n      // do NOT fall back to JS h3-js geometry to keep the code simpler.\n      dispatchSqlStatus(layer.id, 'running...');\n      const gj = await runtime.runSqlGeoJSON(layer, layer.sql || 'SELECT * FROM data');\n      if (destroyed) return;\n      if (!gj?.geojson) {\n        throw new Error('DuckDB GeoJSON path unavailable (requires spatial + h3 extensions and compatible columns).');\n      }\n      const geojson: FeatureCollection = gj.geojson as any;\n      setLayerGeoJSON(layer.id, geojson);\n\n      const visible = visibilityState[layer.id] !== false;\n      // If the source exists, update in-place; otherwise add the layer once.\n      const updated = safeSetGeoJsonSource(map, layer.id, geojson);\n      if (!updated) {\n        try { addStaticHexLayer(map, layer, geojson, visible); } catch (_) {}\n      }\n      // Always refresh paint expressions after data/domain changes.\n      updateHexPaint(map, layer);\n\n      dispatchSqlStatus(layer.id, `${(gj.count || 0).toLocaleString()} rows`);\n      dispatchLegendUpdate();\n      try { onUiUpdate?.(); } catch (_) {}\n    } catch (e: any) {\n      dispatchSqlStatus(layer.id, `error: ${(e?.message || 'query failed').slice(0, 60)}`);\n    }\n  };\n\n  // Initial run for all sql layers (non-blocking)\n  (async () => {\n    for (const l of sqlLayers) {\n      if (destroyed) break;\n      // Only run automatically if the layer provides a sql string (otherwise wait for debug input)\n      const sql = (l.sql || 'SELECT * FROM data').trim();\n      await runForLayer(l, sql);\n    }\n  })();\n\n  const onSqlUpdate = (evt: any) => {\n    const detail = evt?.detail || {};\n    const layerId = String(detail.layerId || '');\n    const sql = String(detail.sql || '');\n    const layer = sqlLayers.find((l) => l.id === layerId);\n    if (!layer) return;\n    void runForLayer(layer, sql);\n  };\n\n  try { window.addEventListener('fusedmaps:sql:update', onSqlUpdate as any); } catch (_) {}\n\n  return {\n    destroy: () => {\n      destroyed = true;\n      try { window.removeEventListener('fusedmaps:sql:update', onSqlUpdate as any); } catch (_) {}\n    }\n  };\n}\n\n\n","/**\n * LayerStore - Centralized state management for all map layers.\n *\n * This is the single source of truth for:\n * - Layer configurations\n * - Visibility state\n * - Render order\n * - Computed GeoJSONs\n *\n * Components subscribe to changes via events instead of passing state around.\n */\n\nimport type { LayerConfig, HexLayerConfig, VectorLayerConfig, PMTilesLayerConfig, RasterLayerConfig, MVTLayerConfig } from '../types';\nimport type { FeatureCollection } from 'geojson';\n\n// ============================================================\n// Types\n// ============================================================\n\nexport interface LayerState {\n  config: LayerConfig;\n  visible: boolean;\n  order: number;\n  geojson?: FeatureCollection;\n}\n\nexport type LayerEventType = \n  | 'add'\n  | 'remove'\n  | 'update'\n  | 'visibility'\n  | 'reorder'\n  | 'geojson'\n  | 'batch'; // For bulk updates\n\nexport interface LayerEvent {\n  type: LayerEventType;\n  layerId: string;\n  layer?: LayerState;\n  changes?: Partial<LayerConfig>;\n  previousOrder?: number;\n  newOrder?: number;\n}\n\nexport type LayerEventCallback = (event: LayerEvent) => void;\n\n// ============================================================\n// LayerStore Class\n// ============================================================\n\nexport class LayerStore {\n  private layers: Map<string, LayerState> = new Map();\n  private listeners: Map<LayerEventType | '*', Set<LayerEventCallback>> = new Map();\n  private nextOrder: number = 0;\n\n  constructor() {\n    // Initialize listener maps\n    this.listeners.set('*', new Set());\n  }\n\n  // ============================================================\n  // Initialization\n  // ============================================================\n\n  /**\n   * Initialize store with layers from config.\n   * Clears existing state.\n   */\n  init(layers: LayerConfig[]): void {\n    this.layers.clear();\n    this.nextOrder = 0;\n\n    layers.forEach((config, idx) => {\n      const state: LayerState = {\n        config,\n        visible: config.visible !== false,\n        order: idx,\n      };\n      this.layers.set(config.id, state);\n      this.nextOrder = Math.max(this.nextOrder, idx + 1);\n    });\n\n    this.emit({ type: 'batch', layerId: '*' });\n  }\n\n  // ============================================================\n  // CRUD Operations\n  // ============================================================\n\n  /**\n   * Add a new layer.\n   * @param config Layer configuration\n   * @param options.order Insert at specific order (default: end)\n   * @returns The new layer state\n   */\n  add(config: LayerConfig, options?: { order?: number }): LayerState {\n    if (this.layers.has(config.id)) {\n      console.warn(`[LayerStore] Layer ${config.id} already exists, updating instead`);\n      return this.update(config.id, config) as LayerState;\n    }\n\n    const order = options?.order ?? this.nextOrder;\n    \n    // Shift existing layers if inserting\n    if (options?.order !== undefined) {\n      this.shiftOrdersFrom(order, 1);\n    }\n\n    const state: LayerState = {\n      config,\n      visible: config.visible !== false,\n      order,\n    };\n\n    this.layers.set(config.id, state);\n    this.nextOrder = Math.max(this.nextOrder, order + 1);\n\n    this.emit({ type: 'add', layerId: config.id, layer: state });\n    return state;\n  }\n\n  /**\n   * Remove a layer by ID.\n   */\n  remove(layerId: string): boolean {\n    const layer = this.layers.get(layerId);\n    if (!layer) return false;\n\n    this.layers.delete(layerId);\n    \n    // Compact orders\n    this.recomputeOrders();\n\n    this.emit({ type: 'remove', layerId, layer });\n    return true;\n  }\n\n  /**\n   * Update a layer's configuration.\n   * Merges with existing config.\n   */\n  update(layerId: string, changes: Partial<LayerConfig>): LayerState | undefined {\n    const layer = this.layers.get(layerId);\n    if (!layer) {\n      console.warn(`[LayerStore] Layer ${layerId} not found`);\n      return undefined;\n    }\n\n    // Deep merge the config\n    layer.config = { ...layer.config, ...changes } as LayerConfig;\n\n    // Handle visibility if it was in the changes\n    if ('visible' in changes) {\n      layer.visible = changes.visible !== false;\n    }\n\n    this.emit({ type: 'update', layerId, layer, changes });\n    return layer;\n  }\n\n  /**\n   * Update nested layer style (hexLayer, vectorLayer, etc.)\n   */\n  updateStyle(layerId: string, styleProp: string, styleChanges: Record<string, unknown>): LayerState | undefined {\n    const layer = this.layers.get(layerId);\n    if (!layer) return undefined;\n\n    const config = layer.config as any;\n    if (!config[styleProp]) {\n      config[styleProp] = {};\n    }\n    config[styleProp] = { ...config[styleProp], ...styleChanges };\n\n    this.emit({ type: 'update', layerId, layer, changes: { [styleProp]: config[styleProp] } });\n    return layer;\n  }\n\n  // ============================================================\n  // Visibility\n  // ============================================================\n\n  /**\n   * Set layer visibility.\n   */\n  setVisible(layerId: string, visible: boolean): void {\n    const layer = this.layers.get(layerId);\n    if (!layer) return;\n\n    if (layer.visible === visible) return; // No change\n\n    layer.visible = visible;\n    layer.config.visible = visible;\n\n    this.emit({ type: 'visibility', layerId, layer });\n  }\n\n  /**\n   * Toggle layer visibility.\n   */\n  toggleVisible(layerId: string): boolean {\n    const layer = this.layers.get(layerId);\n    if (!layer) return false;\n\n    this.setVisible(layerId, !layer.visible);\n    return layer.visible;\n  }\n\n  /**\n   * Set visibility for multiple layers.\n   */\n  setVisibleBatch(updates: Record<string, boolean>): void {\n    Object.entries(updates).forEach(([id, visible]) => {\n      const layer = this.layers.get(id);\n      if (layer && layer.visible !== visible) {\n        layer.visible = visible;\n        layer.config.visible = visible;\n      }\n    });\n    this.emit({ type: 'batch', layerId: '*' });\n  }\n\n  // ============================================================\n  // Ordering\n  // ============================================================\n\n  /**\n   * Move a layer to a specific order index.\n   */\n  reorder(layerId: string, newOrder: number): void {\n    const layer = this.layers.get(layerId);\n    if (!layer) return;\n\n    const previousOrder = layer.order;\n    if (previousOrder === newOrder) return;\n\n    // Clamp to valid range\n    const maxOrder = this.layers.size - 1;\n    newOrder = Math.max(0, Math.min(maxOrder, newOrder));\n\n    // Shift other layers\n    this.layers.forEach((l, id) => {\n      if (id === layerId) return;\n      \n      if (previousOrder < newOrder) {\n        // Moving down: shift layers between previous and new up\n        if (l.order > previousOrder && l.order <= newOrder) {\n          l.order--;\n        }\n      } else {\n        // Moving up: shift layers between new and previous down\n        if (l.order >= newOrder && l.order < previousOrder) {\n          l.order++;\n        }\n      }\n    });\n\n    layer.order = newOrder;\n\n    this.emit({ type: 'reorder', layerId, layer, previousOrder, newOrder });\n  }\n\n  /**\n   * Move layer up one position (renders on top).\n   */\n  moveUp(layerId: string): void {\n    const layer = this.layers.get(layerId);\n    if (!layer) return;\n    this.reorder(layerId, layer.order + 1);\n  }\n\n  /**\n   * Move layer down one position (renders below).\n   */\n  moveDown(layerId: string): void {\n    const layer = this.layers.get(layerId);\n    if (!layer) return;\n    this.reorder(layerId, layer.order - 1);\n  }\n\n  /**\n   * Move layer to top (highest render order).\n   */\n  moveToTop(layerId: string): void {\n    this.reorder(layerId, this.layers.size - 1);\n  }\n\n  /**\n   * Move layer to bottom (lowest render order).\n   */\n  moveToBottom(layerId: string): void {\n    this.reorder(layerId, 0);\n  }\n\n  // ============================================================\n  // GeoJSON (computed data)\n  // ============================================================\n\n  /**\n   * Set the computed GeoJSON for a layer.\n   */\n  setGeoJSON(layerId: string, geojson: FeatureCollection): void {\n    const layer = this.layers.get(layerId);\n    if (!layer) return;\n\n    layer.geojson = geojson;\n    this.emit({ type: 'geojson', layerId, layer });\n  }\n\n  /**\n   * Get GeoJSON for a layer.\n   */\n  getGeoJSON(layerId: string): FeatureCollection | undefined {\n    return this.layers.get(layerId)?.geojson;\n  }\n\n  /**\n   * Get all GeoJSONs as a record (for legend/tooltip compatibility).\n   */\n  getAllGeoJSONs(): Record<string, FeatureCollection> {\n    const result: Record<string, FeatureCollection> = {};\n    this.layers.forEach((layer, id) => {\n      if (layer.geojson) {\n        result[id] = layer.geojson;\n      }\n    });\n    return result;\n  }\n\n  // ============================================================\n  // Queries\n  // ============================================================\n\n  /**\n   * Get a layer by ID.\n   */\n  get(layerId: string): LayerState | undefined {\n    return this.layers.get(layerId);\n  }\n\n  /**\n   * Get layer config by ID.\n   */\n  getConfig(layerId: string): LayerConfig | undefined {\n    return this.layers.get(layerId)?.config;\n  }\n\n  /**\n   * Check if a layer exists.\n   */\n  has(layerId: string): boolean {\n    return this.layers.has(layerId);\n  }\n\n  /**\n   * Get all layers ordered by render order.\n   */\n  getAll(): LayerState[] {\n    return [...this.layers.values()].sort((a, b) => a.order - b.order);\n  }\n\n  /**\n   * Get all layer configs ordered by render order.\n   */\n  getAllConfigs(): LayerConfig[] {\n    return this.getAll().map(l => l.config);\n  }\n\n  /**\n   * Get visible layers ordered by render order.\n   */\n  getVisible(): LayerState[] {\n    return this.getAll().filter(l => l.visible);\n  }\n\n  /**\n   * Get visible layer configs.\n   */\n  getVisibleConfigs(): LayerConfig[] {\n    return this.getVisible().map(l => l.config);\n  }\n\n  /**\n   * Get visibility state as a record (for compatibility).\n   */\n  getVisibilityState(): Record<string, boolean> {\n    const result: Record<string, boolean> = {};\n    this.layers.forEach((layer, id) => {\n      result[id] = layer.visible;\n    });\n    return result;\n  }\n\n  /**\n   * Get layers by type.\n   */\n  getByType(type: LayerConfig['layerType']): LayerState[] {\n    return this.getAll().filter(l => l.config.layerType === type);\n  }\n\n  /**\n   * Get total layer count.\n   */\n  get size(): number {\n    return this.layers.size;\n  }\n\n  // ============================================================\n  // Event System\n  // ============================================================\n\n  /**\n   * Subscribe to layer events.\n   * @param event Event type or '*' for all events\n   * @param callback Callback function\n   * @returns Unsubscribe function\n   */\n  on(event: LayerEventType | '*', callback: LayerEventCallback): () => void {\n    if (!this.listeners.has(event)) {\n      this.listeners.set(event, new Set());\n    }\n    this.listeners.get(event)!.add(callback);\n\n    // Return unsubscribe function\n    return () => this.off(event, callback);\n  }\n\n  /**\n   * Unsubscribe from layer events.\n   */\n  off(event: LayerEventType | '*', callback: LayerEventCallback): void {\n    this.listeners.get(event)?.delete(callback);\n  }\n\n  /**\n   * Emit an event to all listeners.\n   */\n  private emit(event: LayerEvent): void {\n    // Notify specific listeners\n    this.listeners.get(event.type)?.forEach(cb => {\n      try { cb(event); } catch (e) { console.error('[LayerStore] Event handler error:', e); }\n    });\n\n    // Notify wildcard listeners\n    this.listeners.get('*')?.forEach(cb => {\n      try { cb(event); } catch (e) { console.error('[LayerStore] Event handler error:', e); }\n    });\n  }\n\n  // ============================================================\n  // Utilities\n  // ============================================================\n\n  /**\n   * Shift all orders >= startOrder by delta.\n   */\n  private shiftOrdersFrom(startOrder: number, delta: number): void {\n    this.layers.forEach(layer => {\n      if (layer.order >= startOrder) {\n        layer.order += delta;\n      }\n    });\n  }\n\n  /**\n   * Recompute orders to be contiguous (0, 1, 2, ...).\n   */\n  private recomputeOrders(): void {\n    const sorted = this.getAll();\n    sorted.forEach((layer, idx) => {\n      layer.order = idx;\n    });\n    this.nextOrder = sorted.length;\n  }\n\n  /**\n   * Clone a layer with a new ID.\n   */\n  clone(layerId: string, newId: string, newName?: string): LayerState | undefined {\n    const layer = this.layers.get(layerId);\n    if (!layer) return undefined;\n\n    const clonedConfig = JSON.parse(JSON.stringify(layer.config)) as LayerConfig;\n    clonedConfig.id = newId;\n    if (newName) {\n      clonedConfig.name = newName;\n    }\n\n    return this.add(clonedConfig, { order: layer.order + 1 });\n  }\n\n  /**\n   * Rename a layer.\n   */\n  rename(layerId: string, newName: string): void {\n    const layer = this.layers.get(layerId);\n    if (!layer) return;\n\n    layer.config.name = newName;\n    this.emit({ type: 'update', layerId, layer, changes: { name: newName } });\n  }\n\n  /**\n   * Clear all layers.\n   */\n  clear(): void {\n    this.layers.clear();\n    this.nextOrder = 0;\n    this.emit({ type: 'batch', layerId: '*' });\n  }\n\n  /**\n   * Export current state as serializable object.\n   */\n  export(): { layers: LayerConfig[]; visibility: Record<string, boolean> } {\n    return {\n      layers: this.getAllConfigs(),\n      visibility: this.getVisibilityState(),\n    };\n  }\n}\n\n/**\n * Create a new LayerStore instance (for testing or isolated use).\n */\nexport function createLayerStore(): LayerStore {\n  return new LayerStore();\n}\n\n","/**\n * Config normalizer - converts new clean config format to internal format\n *\n * New format (user-facing):\n *   { type: 'continuous', attr: 'value', palette: 'Viridis', domain: [0, 100] }\n *\n * Internal format (renderer):\n *   { '@@function': 'colorContinuous', attr: 'value', colors: 'Viridis', domain: [0, 100] }\n */\n\nimport type {\n  LayerConfig,\n  HexLayer,\n  VectorLayer,\n  MVTLayer,\n  RasterLayer,\n  PMTilesLayer,\n  ColorValue,\n  ColorConfig,\n  ContinuousColor,\n  CategoricalColor,\n} from '../types';\n\n/**\n * Convert new-style color config to legacy @@function format\n */\nexport function normalizeColor(color: ColorValue | undefined): ColorConfig | undefined {\n  if (!color) return undefined;\n\n  // Already a string or array - pass through\n  if (typeof color === 'string') return color;\n  if (Array.isArray(color)) return color as [number, number, number, number?];\n\n  // New format: { type: 'continuous', ... }\n  if ('type' in color) {\n    if (color.type === 'continuous') {\n      const c = color as ContinuousColor;\n      return {\n        '@@function': 'colorContinuous',\n        attr: c.attr,\n        domain: c.domain || [0, 1],\n        colors: c.palette,\n        steps: c.steps,\n        nullColor: c.nullColor,\n        reverse: c.reverse,\n        autoDomain: c.autoDomain ?? true,\n      };\n    }\n    if (color.type === 'categorical') {\n      const c = color as CategoricalColor;\n      return {\n        '@@function': 'colorCategories',\n        attr: c.attr,\n        categories: c.categories,\n        labelAttr: c.labelAttr,\n        colors: c.palette,\n        nullColor: c.nullColor,\n      };\n    }\n  }\n\n  // Legacy format: { '@@function': ... } - pass through\n  if ('@@function' in color) {\n    return color as ColorConfig;\n  }\n\n  return undefined;\n}\n\n/**\n * Normalize a layer config to internal format\n */\nexport function normalizeLayerConfig(config: LayerConfig): LayerConfig {\n  switch (config.layerType) {\n    case 'hex':\n      return normalizeHexLayer(config);\n    case 'vector':\n      return normalizeVectorLayer(config);\n    case 'mvt':\n      return normalizeMVTLayer(config);\n    case 'raster':\n      return normalizeRasterLayer(config);\n    case 'pmtiles':\n      return normalizePMTilesLayer(config);\n    default:\n      return config;\n  }\n}\n\nfunction normalizeHexLayer(layer: HexLayer): any {\n  const style = layer.style || {};\n  const tile = layer.tile || {};\n\n  return {\n    id: layer.id,\n    name: layer.name,\n    layerType: 'hex',\n    visible: layer.visible,\n    data: layer.data,\n    tileUrl: layer.tileUrl,\n    isTileLayer: !!layer.tileUrl,\n    parquetUrl: layer.parquetUrl,\n    parquetData: layer.parquetData,\n    sql: layer.sql,\n    dataRef: layer.dataRef,\n    tooltipColumns: layer.tooltip,\n    hexLayer: {\n      filled: style.filled ?? true,\n      stroked: style.stroked ?? true,\n      extruded: style.extruded ?? false,\n      opacity: style.opacity ?? 1,\n      elevationProperty: style.elevationAttr,\n      elevationScale: style.elevationScale ?? 1,\n      getFillColor: normalizeColor(style.fillColor),\n      getLineColor: normalizeColor(style.lineColor),\n      lineWidthMinPixels: style.lineWidth ?? 1,\n      tooltipColumns: layer.tooltip,\n    },\n    tileLayerConfig: Object.keys(tile).length > 0 ? {\n      minZoom: tile.minZoom,\n      maxZoom: tile.maxZoom,\n      zoomOffset: tile.zoomOffset,\n      tileSize: tile.tileSize,\n      maxRequests: tile.maxRequests,\n    } : undefined,\n  };\n}\n\nfunction normalizeVectorLayer(layer: VectorLayer): any {\n  const style = layer.style || {};\n\n  const fillColor = normalizeColor(style.fillColor);\n  const lineColor = normalizeColor(style.lineColor);\n\n  return {\n    id: layer.id,\n    name: layer.name,\n    layerType: 'vector',\n    visible: layer.visible,\n    geojson: layer.geojson,\n    dataRef: layer.dataRef,\n    tooltipColumns: layer.tooltip,\n    vectorLayer: {\n      filled: style.filled ?? true,\n      stroked: style.stroked ?? true,\n      opacity: style.opacity ?? 0.8,\n      getFillColor: fillColor,\n      getLineColor: lineColor,\n      lineWidthMinPixels: style.lineWidth ?? 1,\n      pointRadiusMinPixels: style.pointRadius ?? 6,\n    },\n    fillColorConfig: typeof fillColor === 'object' && '@@function' in fillColor ? fillColor : undefined,\n    fillColorRgba: typeof fillColor === 'string' ? fillColor : undefined,\n    lineColorConfig: typeof lineColor === 'object' && '@@function' in lineColor ? lineColor : undefined,\n    lineColorRgba: typeof lineColor === 'string' ? lineColor : undefined,\n    lineWidth: style.lineWidth ?? 1,\n    pointRadius: style.pointRadius ?? 6,\n    isFilled: style.filled ?? true,\n    isStroked: style.stroked ?? true,\n    opacity: style.opacity ?? 0.8,\n  };\n}\n\nfunction normalizeMVTLayer(layer: MVTLayer): any {\n  const style = layer.style || {};\n  const tile = layer.tile || {};\n\n  const fillColor = normalizeColor(style.fillColor);\n  const lineColor = normalizeColor(style.lineColor);\n\n  return {\n    id: layer.id,\n    name: layer.name,\n    layerType: 'mvt',\n    visible: layer.visible,\n    tileUrl: layer.tileUrl,\n    sourceLayer: layer.sourceLayer,\n    dataRef: layer.dataRef,\n    tooltipColumns: layer.tooltip,\n    minzoom: tile.minZoom,\n    maxzoom: tile.maxZoom,\n    fillColorConfig: typeof fillColor === 'object' && '@@function' in fillColor ? fillColor : undefined,\n    fillColor: typeof fillColor === 'string' ? fillColor : undefined,\n    fillOpacity: style.opacity ?? 0.8,\n    isFilled: style.filled ?? true,\n    lineColorConfig: typeof lineColor === 'object' && '@@function' in lineColor ? lineColor : undefined,\n    lineColor: typeof lineColor === 'string' ? lineColor : undefined,\n    lineWidth: style.lineWidth ?? 1,\n    isExtruded: style.extruded ?? false,\n    heightProperty: style.elevationAttr,\n    heightMultiplier: style.elevationScale,\n  };\n}\n\nfunction normalizeRasterLayer(layer: RasterLayer): any {\n  return {\n    id: layer.id,\n    name: layer.name,\n    layerType: 'raster',\n    visible: layer.visible,\n    tileUrl: layer.tileUrl,\n    imageUrl: layer.imageUrl,\n    imageBounds: layer.imageBounds,\n    dataRef: layer.dataRef,\n    opacity: layer.opacity ?? 1,\n    rasterLayer: {\n      opacity: layer.opacity ?? 1,\n    },\n  };\n}\n\nfunction normalizePMTilesLayer(layer: PMTilesLayer): any {\n  const style = layer.style || {};\n  const tile = layer.tile || {};\n\n  const fillColor = normalizeColor(style.fillColor);\n  const lineColor = normalizeColor(style.lineColor);\n\n  return {\n    id: layer.id,\n    name: layer.name,\n    layerType: 'pmtiles',\n    visible: layer.visible,\n    pmtilesUrl: layer.pmtilesUrl,\n    pmtilesPath: layer.pmtilesPath,\n    sourceLayer: layer.sourceLayer,\n    excludeSourceLayers: layer.excludeSourceLayers,\n    dataRef: layer.dataRef,\n    tooltipColumns: layer.tooltip,\n    minzoom: tile.minZoom,\n    maxzoom: tile.maxZoom,\n    fillColorConfig: typeof fillColor === 'object' && '@@function' in fillColor ? fillColor : undefined,\n    lineColorConfig: typeof lineColor === 'object' && '@@function' in lineColor ? lineColor : undefined,\n    fillOpacity: style.opacity ?? 0.8,\n    lineWidth: style.lineWidth ?? 1,\n    pointRadiusMinPixels: style.pointRadius ?? 4,\n    isFilled: style.filled ?? true,\n    isStroked: style.stroked ?? true,\n    renderPoints: layer.renderPoints,\n    renderLines: layer.renderLines,\n    renderPolygons: layer.renderPolygons,\n    colorAttribute: (style.fillColor as ContinuousColor)?.attr,\n  };\n}\n\n/**\n * Check if a layer config uses the new format (has `style` key)\n */\nexport function isNewFormat(config: any): boolean {\n  return 'style' in config || 'tile' in config || 'tooltip' in config;\n}\n\n/**\n * Normalize all layers in a config\n */\nexport function normalizeConfig(config: any): any {\n  if (!config?.layers) return config;\n\n  return {\n    ...config,\n    layers: config.layers.map((layer: any) => {\n      // Only normalize if using new format\n      if (isNewFormat(layer)) {\n        return normalizeLayerConfig(layer);\n      }\n      return layer;\n    }),\n  };\n}\n","/**\n * FusedMaps - Interactive map library for Fused.io\n *\n * Renders H3 hexagon layers, GeoJSON vectors, MVT tiles, and raster tiles\n * using Mapbox GL JS and Deck.gl.\n */\n\nimport type { FusedMapsAction, FusedMapsConfig, FusedMapsInstance, FusedMapsState, LayerConfig, LayerSummary, LngLatBoundsLike } from './types';\nimport { initMap, applyViewState, getViewState } from './core/map';\nimport { addAllLayers, addSingleLayer, removeSingleLayer, setLayerVisibility, getLayerGeoJSONs, updateLayerStyleInPlace } from './layers';\nimport { setupLayerPanel, updateLayerPanel } from './ui/layer-panel';\nimport { setupLegend, updateLegend } from './ui/legend';\nimport { setupTooltip } from './ui/tooltip';\nimport { setupWidgets } from './ui/widgets';\nimport { setupDebugPanel } from './ui/debug';\nimport { setupHighlight } from './interactions/highlight';\nimport { setupMessaging } from './messaging';\nimport { setupDuckDbSql } from './sql/setup';\nimport { createLayerStore, LayerStore } from './state';\nimport { normalizeLayerConfig, isNewFormat } from './config';\n\nconst VALID_LAYER_TYPES = ['hex', 'vector', 'mvt', 'raster', 'pmtiles'] as const;\n\nfunction validateLayerConfig(config: any): { valid: boolean; error?: string } {\n  if (!config || typeof config !== 'object') {\n    return { valid: false, error: 'Layer config must be an object' };\n  }\n  if (!config.id || typeof config.id !== 'string') {\n    return { valid: false, error: 'Layer config must have a string id' };\n  }\n  if (!config.layerType || !VALID_LAYER_TYPES.includes(config.layerType)) {\n    return { valid: false, error: `Layer config must have a valid layerType: ${VALID_LAYER_TYPES.join(', ')}` };\n  }\n  return { valid: true };\n}\n\n// Re-export types\nexport * from './types';\n// Re-export state (selectively to avoid conflicts with types.ts)\nexport { createLayerStore, LayerStore } from './state';\nexport type { LayerEvent, LayerEventType, LayerEventCallback } from './state';\n\n/**\n * Initialize a FusedMaps instance\n */\nexport function init(config: FusedMapsConfig): FusedMapsInstance {\n  const containerId = config.containerId || 'map';\n\n  // Normalize layer configs (convert new format to internal format)\n  const normalizedLayers = config.layers.map((layer) =>\n    isNewFormat(layer) ? normalizeLayerConfig(layer) : layer\n  );\n\n  // Create normalized config for internal use\n  const normalizedConfig: FusedMapsConfig = {\n    ...config,\n    layers: normalizedLayers,\n  };\n\n  // Initialize layer store with normalized layers\n  const store = createLayerStore();\n  store.init(normalizedLayers);\n\n  // Theme (match map_utils.py: <html data-theme=\"dark|light\">)\n  try {\n    const theme = config.ui?.theme === 'light' ? 'light' : 'dark';\n    document.documentElement.setAttribute('data-theme', theme);\n  } catch (_) {}\n\n  // Create map\n  const map = initMap({\n    containerId,\n    mapboxToken: config.mapboxToken,\n    styleUrl: config.styleUrl,\n    initialViewState: config.initialViewState,\n    screenshotEnabled: config.ui?.screenshot !== false\n  });\n\n  // Widgets (zoom/home + optional screenshot + cmd-drag orbit)\n  const widgets = setupWidgets(map, config.initialViewState, config.ui?.screenshot !== false);\n\n  // Sidebar panel (inspector)\n  // - sidebar undefined => do not mount (no toggle)\n  // - sidebar 'show'|'hide' => mount\n  // Back-compat: debug=true => sidebar 'show'\n  const sidebarMode = (normalizedConfig as any).sidebar || ((normalizedConfig as any).debug ? 'show' : null);\n  const debugHandle = sidebarMode ? setupDebugPanel(map, normalizedConfig) : null;\n  \n  // Deck.gl overlay (for tile layers) - use object ref to avoid stale closures\n  const overlayRef = { current: null as unknown };\n  let legendUpdateHandler: (() => void) | null = null;\n  let duckHandle: { destroy?: () => void } | null = null;\n\n  // Global event handlers (stored for cleanup)\n  const resizeHandler = () => map.resize();\n  const visibilityHandler = () => { if (!document.hidden) setTimeout(resizeHandler, 100); };\n\n  // Helper to get visibility state from store (for compatibility)\n  const getVisibilityState = () => store.getVisibilityState();\n  \n  // Helper to refresh UI\n  const refreshUI = () => {\n    try { updateLayerPanel(store.getAllConfigs(), getVisibilityState()); } catch (_) {}\n    try { updateLegend(store.getAllConfigs(), getVisibilityState(), store.getAllGeoJSONs()); } catch (_) {}\n  };\n\n  // Subscribe to store changes for UI updates\n  const unsubscribeStore = store.on('*', (event) => {\n    if (event.type === 'visibility' || event.type === 'update' || event.type === 'batch') {\n      refreshUI();\n    }\n  });\n  \n  // Setup UI components\n  if (config.ui?.layerPanel !== false) {\n    setupLayerPanel(store.getAllConfigs(), getVisibilityState(), (layerId, visible) => {\n      handleVisibilityChange(layerId, visible, map, store, overlayRef.current);\n    }, store);\n  }\n  \n  if (config.ui?.legend !== false) {\n    setupLegend(store.getAllConfigs(), getVisibilityState(), store.getAllGeoJSONs());\n  }\n  \n  // Add layers when map loads\n  map.on('load', () => {\n    const result = addAllLayers(map, store.getAllConfigs(), getVisibilityState(), normalizedConfig);\n    overlayRef.current = result.deckOverlay;\n    \n    // Sync GeoJSONs from layer system to store\n    const geoJSONs = getLayerGeoJSONs();\n    Object.entries(geoJSONs).forEach(([id, geojson]) => {\n      store.setGeoJSON(id, geojson);\n    });\n    \n    // Update UI\n    refreshUI();\n\n    // Allow tile autoDomain to trigger legend refresh without tight coupling\n    legendUpdateHandler = () => {\n      updateLegend(store.getAllConfigs(), getVisibilityState(), store.getAllGeoJSONs());\n    };\n    try {\n      window.addEventListener('fusedmaps:legend:update', legendUpdateHandler);\n    } catch (_) {}\n\n    // Setup tooltip (needs deckOverlay for tile layers)\n    if (config.ui?.tooltip !== false) {\n      setupTooltip(map, store.getAllConfigs(), getVisibilityState(), overlayRef.current);\n    }\n\n    // Setup interactions\n    if (config.highlightOnClick !== false) {\n      setupHighlight(map, store.getAllConfigs(), getVisibilityState(), overlayRef.current);\n    }\n    \n    // Setup messaging\n    if (config.messaging) {\n      setupMessaging(map, config.messaging, store.getAllConfigs());\n    }\n\n    // DuckDB-WASM SQL layers (non-tile Parquet-backed hex layers)\n    duckHandle = setupDuckDbSql(\n      map,\n      normalizedConfig,\n      getVisibilityState(),\n      () => {\n        // Sync GeoJSONs after SQL update\n        const geoJSONs = getLayerGeoJSONs();\n        Object.entries(geoJSONs).forEach(([id, geojson]) => {\n          store.setGeoJSON(id, geojson);\n        });\n        refreshUI();\n      }\n    );\n    \n    // Auto-fit to bounds if no custom view\n    if (!config.hasCustomView) {\n      autoFitBounds(map, store.getAllConfigs(), store);\n      // Update home (âŒ‚) target to the auto-fit result (esp. raster-only maps).\n      try {\n        const handler = () => {\n          try {\n            const vs = getViewState(map);\n            widgets?.setHomeViewState?.(vs);\n          } catch (_) {}\n          try { map.off('moveend', handler as any); } catch (_) {}\n        };\n        map.on('moveend', handler as any);\n      } catch (_) {}\n    }\n  });\n  \n  // Handle resize - store handlers for cleanup\n  map.on('load', () => {\n    [100, 500, 1000].forEach(t => setTimeout(resizeHandler, t));\n  });\n  window.addEventListener('resize', resizeHandler);\n  document.addEventListener('visibilitychange', visibilityHandler);\n  \n  // Return instance with control methods\n  const getState = (): FusedMapsState => {\n    const viewState = getViewState(map);\n    let bounds: LngLatBoundsLike | undefined = undefined;\n    try {\n      const b = map.getBounds();\n      bounds = {\n        west: b.getWest(),\n        south: b.getSouth(),\n        east: b.getEast(),\n        north: b.getNorth()\n      };\n    } catch (_) {}\n\n    // Best-effort property keys from computed GeoJSONs (non-tile)\n    const geojsons = store.getAllGeoJSONs();\n    const layers: LayerSummary[] = store.getAll().map((s) => {\n      const cfg = s.config as any;\n      const tooltipColumns: string[] | undefined =\n        (Array.isArray(cfg.tooltipColumns) ? cfg.tooltipColumns :\n         Array.isArray(cfg.hexLayer?.tooltipColumns) ? cfg.hexLayer.tooltipColumns :\n         Array.isArray(cfg.hexLayer?.tooltipAttrs) ? cfg.hexLayer.tooltipAttrs :\n         Array.isArray(cfg.vectorLayer?.tooltipColumns) ? cfg.vectorLayer.tooltipColumns :\n         Array.isArray(cfg.vectorLayer?.tooltipAttrs) ? cfg.vectorLayer.tooltipAttrs :\n         undefined);\n\n      let propertyKeys: string[] | undefined = undefined;\n      try {\n        const gj: any = geojsons[s.config.id];\n        const f0 = gj?.features?.[0];\n        const props = f0?.properties;\n        if (props && typeof props === 'object') {\n          propertyKeys = Object.keys(props).slice(0, 200);\n        }\n      } catch (_) {}\n\n      return {\n        id: s.config.id,\n        name: s.config.name,\n        layerType: s.config.layerType,\n        visible: s.visible,\n        order: s.order,\n        ...(propertyKeys ? { propertyKeys } : {}),\n        ...(tooltipColumns ? { tooltipColumns } : {})\n      };\n    });\n\n    return { viewState, ...(bounds ? { bounds } : {}), layers };\n  };\n\n  const dispatch = (actionOrActions: FusedMapsAction | FusedMapsAction[]): FusedMapsState => {\n    const actions = Array.isArray(actionOrActions) ? actionOrActions : [actionOrActions];\n    for (const action of actions) {\n      if (!action || typeof action !== 'object') continue;\n\n      switch (action.type) {\n        case 'setViewState': {\n          const vs = (action as any).viewState || {};\n          const duration = Number.isFinite((action as any).options?.duration) ? (action as any).options.duration : null;\n          if (duration && duration > 0) {\n            try {\n              map.easeTo({ ...vs, duration });\n              break;\n            } catch (_) {}\n          }\n          applyViewState(map, vs);\n          break;\n        }\n        case 'fitBounds': {\n          const b = (action as any).bounds;\n          if (Array.isArray(b) && b.length === 4) {\n            const [west, south, east, north] = b;\n            const opts = (action as any).options || {};\n            try {\n              map.fitBounds([[west, south], [east, north]] as any, {\n                padding: Number.isFinite(opts.padding) ? opts.padding : 50,\n                maxZoom: Number.isFinite(opts.maxZoom) ? opts.maxZoom : 15,\n                duration: Number.isFinite(opts.duration) ? opts.duration : 500\n              } as any);\n            } catch (_) {}\n          }\n          break;\n        }\n        case 'setLayerVisibility': {\n          handleVisibilityChange((action as any).layerId, !!(action as any).visible, map, store, overlayRef.current);\n          break;\n        }\n        case 'updateLayer': {\n          const layerId = (action as any).layerId;\n          const changes = (action as any).changes || {};\n          try { (instance as any).updateLayer(layerId, changes); } catch (_) {}\n          break;\n        }\n        case 'addLayer': {\n          try { (instance as any).addLayer((action as any).layer, (action as any).options); } catch (_) {}\n          break;\n        }\n        case 'removeLayer': {\n          try { (instance as any).removeLayer((action as any).layerId); } catch (_) {}\n          break;\n        }\n        case 'moveLayerUp': {\n          try { (instance as any).moveLayerUp((action as any).layerId); } catch (_) {}\n          break;\n        }\n        case 'moveLayerDown': {\n          try { (instance as any).moveLayerDown((action as any).layerId); } catch (_) {}\n          break;\n        }\n        case 'updateLegend': {\n          try { updateLegend(store.getAllConfigs(), getVisibilityState(), store.getAllGeoJSONs()); } catch (_) {}\n          break;\n        }\n        default:\n          break;\n      }\n    }\n    return getState();\n  };\n\n  const instance: FusedMapsInstance = {\n    map,\n    get deckOverlay() { return overlayRef.current; },\n\n    // Layer store access\n    store,\n\n    // AI/tool-calling API\n    getState,\n    dispatch,\n    \n    // Legacy API\n    setLayerVisibility: (layerId: string, visible: boolean) => {\n      handleVisibilityChange(layerId, visible, map, store, overlayRef.current);\n    },\n    updateLegend: () => {\n      updateLegend(store.getAllConfigs(), getVisibilityState(), store.getAllGeoJSONs());\n    },\n    \n    // New Layer Management API\n    addLayer: (layerConfig: LayerConfig, options?: { order?: number }) => {\n      const validation = validateLayerConfig(layerConfig);\n      if (!validation.valid) {\n        console.warn('[FusedMaps] addLayer:', validation.error);\n        return null;\n      }\n      // Normalize if using new format\n      const normalizedConfig = isNewFormat(layerConfig)\n        ? normalizeLayerConfig(layerConfig)\n        : layerConfig;\n      const state = store.add(normalizedConfig, options);\n      // Incremental render\n      try {\n        addSingleLayer(map, state.config, state.visible, normalizedConfig);\n      } catch {\n        // Fallback to full rebuild if incremental add fails\n        const result = addAllLayers(map, store.getAllConfigs(), getVisibilityState(), normalizedConfig);\n        overlayRef.current = result.deckOverlay;\n      }\n      refreshUI();\n      return state;\n    },\n    \n    removeLayer: (layerId: string) => {\n      if (!layerId || typeof layerId !== 'string') {\n        console.warn('[FusedMaps] removeLayer: layerId must be a non-empty string');\n        return false;\n      }\n      const layer = store.get(layerId)?.config;\n      const removed = store.remove(layerId);\n      if (removed) {\n        try {\n          if (layer) removeSingleLayer(map, layer);\n        } catch {\n          const result = addAllLayers(map, store.getAllConfigs(), getVisibilityState(), normalizedConfig);\n          overlayRef.current = result.deckOverlay;\n        }\n        refreshUI();\n      }\n      return removed;\n    },\n    \n    updateLayer: (layerId: string, changes: Partial<LayerConfig>) => {\n      if (!layerId || typeof layerId !== 'string') {\n        console.warn('[FusedMaps] updateLayer: layerId must be a non-empty string');\n        return null;\n      }\n      if (!changes || typeof changes !== 'object') {\n        console.warn('[FusedMaps] updateLayer: changes must be an object');\n        return null;\n      }\n      const before = store.get(layerId)?.config;\n      const state = store.update(layerId, changes);\n      if (state) {\n        const onlyVisible =\n          Object.keys(changes).length === 1 &&\n          Object.prototype.hasOwnProperty.call(changes, 'visible');\n        if (!onlyVisible && before) {\n          // Prefer paint/layout updates in place (no flicker)\n          const applied = updateLayerStyleInPlace(map, before, state.config, state.visible);\n          if (!applied) {\n            // Fallback: recreate just this layer\n            try {\n              removeSingleLayer(map, before);\n              addSingleLayer(map, state.config, state.visible, normalizedConfig);\n            } catch {\n              const result = addAllLayers(map, store.getAllConfigs(), getVisibilityState(), normalizedConfig);\n              overlayRef.current = result.deckOverlay;\n            }\n          }\n        }\n        refreshUI();\n      }\n      return state;\n    },\n    \n    getLayer: (layerId: string) => store.get(layerId),\n    getLayers: () => store.getAll(),\n    \n    moveLayerUp: (layerId: string) => {\n      store.moveUp(layerId);\n      // Re-render to update z-order (safe fallback for now)\n      const result = addAllLayers(map, store.getAllConfigs(), getVisibilityState(), normalizedConfig);\n      overlayRef.current = result.deckOverlay;\n    },\n\n    moveLayerDown: (layerId: string) => {\n      store.moveDown(layerId);\n      const result = addAllLayers(map, store.getAllConfigs(), getVisibilityState(), normalizedConfig);\n      overlayRef.current = result.deckOverlay;\n    },\n    \n    destroy: () => {\n      // Cleanup global event handlers\n      try { window.removeEventListener('resize', resizeHandler); } catch {}\n      try { document.removeEventListener('visibilitychange', visibilityHandler); } catch {}\n      try { if (legendUpdateHandler) window.removeEventListener('fusedmaps:legend:update', legendUpdateHandler); } catch {}\n\n      // Cleanup components\n      try { unsubscribeStore(); } catch {}\n      try { (overlayRef.current as any)?.__fused_hex_tiles__?.destroy?.(); } catch {}\n      try { widgets?.destroy?.(); } catch {}\n      try { debugHandle?.destroy?.(); } catch {}\n      try { duckHandle?.destroy?.(); } catch {}\n\n      map.remove?.();\n    }\n  };\n\n  return instance;\n}\n\nfunction handleVisibilityChange(\n  layerId: string,\n  visible: boolean,\n  map: mapboxgl.Map,\n  store: LayerStore,\n  deckOverlay: unknown\n) {\n  store.setVisible(layerId, visible);\n\n  setLayerVisibility(map, layerId, visible, store.getAllConfigs(), deckOverlay);\n\n  updateLayerPanel(store.getAllConfigs(), store.getVisibilityState());\n  updateLegend(store.getAllConfigs(), store.getVisibilityState(), store.getAllGeoJSONs());\n}\n\nfunction autoFitBounds(map: mapboxgl.Map, layers: LayerConfig[], store: LayerStore) {\n  const bounds = new mapboxgl.LngLatBounds();\n  const geojsons = store.getAllGeoJSONs();\n  \n  layers.forEach(layer => {\n    // Hex tile layers are handled by Deck; don't auto-fit on their data.\n    if ((layer as any).isTileLayer) return;\n\n    // Raster static overlays can provide explicit bounds.\n    if ((layer as any).layerType === 'raster') {\n      const b = (layer as any).imageBounds;\n      if (Array.isArray(b) && b.length === 4) {\n        const [west, south, east, north] = b;\n        if ([west, south, east, north].every((x) => typeof x === 'number' && Number.isFinite(x))) {\n          bounds.extend([west, south]);\n          bounds.extend([east, north]);\n        }\n      }\n      return;\n    }\n\n    const geojson = geojsons[layer.id];\n    if (!geojson?.features?.length) return;\n\n    geojson.features.forEach((f: any) => {\n      if (f.geometry?.type === 'Point') {\n        bounds.extend(f.geometry.coordinates);\n      } else if (f.geometry?.type === 'Polygon' || f.geometry?.type === 'MultiPolygon') {\n        const coords = f.geometry.type === 'Polygon'\n          ? [f.geometry.coordinates]\n          : f.geometry.coordinates;\n        coords.forEach((poly: any) => poly[0]?.forEach((c: any) => bounds.extend(c)));\n      } else if (f.geometry?.type === 'LineString') {\n        f.geometry.coordinates.forEach((c: any) => bounds.extend(c));\n      }\n    });\n  });\n  \n  if (!bounds.isEmpty()) {\n    map.fitBounds(bounds, { padding: 50, maxZoom: 15, duration: 500 });\n  }\n}\n\n// Expose on window for UMD usage\nif (typeof window !== 'undefined') {\n  (window as any).FusedMaps = { init };\n}\n\nexport default { init };\n","/**\n * Hover tooltip component\n */\n\nimport type { LayerConfig, HexLayerConfig, VectorLayerConfig } from '../types';\n\ninterface QueryableLayer {\n  layerId: string;\n  layerDef: LayerConfig;\n}\n\n/**\n * Setup tooltip for the map\n */\nexport function setupTooltip(\n  map: mapboxgl.Map,\n  layers: LayerConfig[],\n  visibilityState: Record<string, boolean>,\n  deckOverlay?: unknown\n): void {\n  // Create tooltip element if it doesn't exist\n  let tt = document.getElementById('tooltip');\n  if (!tt) {\n    tt = document.createElement('div');\n    tt.id = 'tooltip';\n    document.body.appendChild(tt);\n  }\n  \n  // Build list of queryable layers\n  const allQueryableLayers: QueryableLayer[] = [];\n  \n  layers.forEach(layer => {\n    // Skip tile layers for Mapbox querying (handled by Deck.gl pick)\n    if ((layer as any).isTileLayer) return;\n    \n    const layerIds: string[] = [];\n    \n    if (layer.layerType === 'hex') {\n      const hexLayer = layer as HexLayerConfig;\n      const cfg = hexLayer.hexLayer || {};\n      if (cfg.extruded) {\n        layerIds.push(`${layer.id}-extrusion`);\n      } else {\n        layerIds.push(`${layer.id}-fill`);\n      }\n      layerIds.push(`${layer.id}-outline`);\n    } else if (layer.layerType === 'vector') {\n      layerIds.push(\n        `${layer.id}-fill`,\n        `${layer.id}-outline`,\n        `${layer.id}-circle`,\n        `${layer.id}-line`\n      );\n    } else if (layer.layerType === 'mvt') {\n      layerIds.push(\n        `${layer.id}-fill`,\n        `${layer.id}-line`,\n        `${layer.id}-extrusion`\n      );\n    } else if (layer.layerType === 'pmtiles') {\n      // PMTiles layers are generated dynamically (multiple Mapbox layers per source-layer),\n      // so we discover their ids at hover time via the `${layer.id}-` prefix.\n    }\n    \n    layerIds.forEach(layerId => {\n      allQueryableLayers.push({ layerId, layerDef: layer });\n    });\n  });\n  \n  // Mouse move handler\n  map.on('mousemove', (e: any) => {\n    // Build query layer IDs dynamically so PMTiles layers (which may be added async) are included.\n    const queryable: QueryableLayer[] = [...allQueryableLayers];\n    try {\n      const styleLayers: any[] = (map.getStyle?.()?.layers || []) as any[];\n      for (const ldef of layers) {\n        if (ldef.layerType !== 'pmtiles') continue;\n        const prefix = `${ldef.id}-`;\n        for (const sl of styleLayers) {\n          const id = sl?.id;\n          if (typeof id === 'string' && id.startsWith(prefix)) {\n            queryable.push({ layerId: id, layerDef: ldef });\n          }\n        }\n      }\n    } catch (_) {}\n\n    const queryIds = queryable.map(x => x.layerId).filter(id => map.getLayer(id));\n    \n    const layerOrderIndex = (layerId: string) => {\n      const idx = layers.findIndex(l => l.id === layerId);\n      return idx === -1 ? Number.POSITIVE_INFINITY : idx;\n    };\n\n    let best: { type: 'mapbox' | 'deck'; layerDef: LayerConfig; props: Record<string, any> } | null = null;\n    let bestIdx = Number.POSITIVE_INFINITY;\n\n    // 1) Mapbox layers\n    if (queryIds.length) {\n      const features = map.queryRenderedFeatures(e.point, { layers: queryIds });\n      for (const f of features || []) {\n        const match = queryable.find(x => x.layerId === (f as any).layer?.id);\n        if (!match) continue;\n        if (visibilityState[match.layerDef.id] === false) continue;\n        const idx = layerOrderIndex(match.layerDef.id);\n        if (idx < bestIdx) {\n          bestIdx = idx;\n          best = { type: 'mapbox', layerDef: match.layerDef, props: (f as any).properties || {} };\n        }\n        break; // queryRenderedFeatures returns in z-order; take first visible\n      }\n    }\n\n    // 2) Deck tile layers\n    if (deckOverlay) {\n      const state = (deckOverlay as any).__fused_hex_tiles__;\n      const picker = state?.pickObject || (deckOverlay as any)?.pickObject;\n      try {\n        const info = picker?.({ x: e.point.x, y: e.point.y, radius: 4 });\n        if (info?.object) {\n          // Tile layer id looks like \"<layerId>-tiles-...\"; normalize\n          const rawLayerId = String(info.layer?.id || '');\n          const baseId = rawLayerId.includes('-tiles') ? rawLayerId.split('-tiles')[0] : rawLayerId;\n          const layerDef = layers.find(l => l.id === baseId);\n          if (layerDef && visibilityState[layerDef.id] !== false) {\n            const idx = layerOrderIndex(layerDef.id);\n            if (idx < bestIdx) {\n              bestIdx = idx;\n              best = { type: 'deck', layerDef, props: info.object.properties || info.object || {} };\n            }\n          }\n        }\n      } catch (err) {\n        // ignore\n      }\n    }\n\n    if (!best) {\n      tt!.style.display = 'none';\n      map.getCanvas().style.cursor = '';\n      return;\n    }\n\n    map.getCanvas().style.cursor = 'pointer';\n\n    // Build tooltip content\n    const tooltipCols = getTooltipColumns(best.layerDef);\n    const lines = buildTooltipLines(best.props, tooltipCols);\n    \n    if (lines.length) {\n      tt!.innerHTML = `<strong class=\"tt-title\">${best.layerDef.name}</strong>` + lines.join('');\n      tt!.style.left = `${e.point.x + 10}px`;\n      tt!.style.top = `${e.point.y + 10}px`;\n      tt!.style.display = 'block';\n    } else {\n      tt!.style.display = 'none';\n    }\n  });\n  \n  // Mouse leave handler\n  map.on('mouseleave', () => {\n    map.getCanvas().style.cursor = '';\n    tt!.style.display = 'none';\n  });\n}\n\n/**\n * Get tooltip columns for a layer\n */\nfunction getTooltipColumns(layer: LayerConfig): string[] {\n  if (layer.layerType === 'hex') {\n    const hexLayer = layer as HexLayerConfig;\n    return hexLayer.hexLayer?.tooltipColumns || hexLayer.hexLayer?.tooltipAttrs || hexLayer.tooltipColumns || [];\n  } else if (layer.layerType === 'vector') {\n    const vecLayer = layer as VectorLayerConfig;\n    return vecLayer.vectorLayer?.tooltipColumns || vecLayer.vectorLayer?.tooltipAttrs || vecLayer.tooltipColumns || [];\n  } else if (layer.layerType === 'pmtiles') {\n    const p: any = layer as any;\n    return p.vectorLayer?.tooltipColumns || p.vectorLayer?.tooltipAttrs || p.tooltipColumns || [];\n  }\n  return layer.tooltipColumns || [];\n}\n\n/**\n * Build tooltip HTML lines\n */\nfunction buildTooltipLines(props: Record<string, unknown>, cols: string[]): string[] {\n  const lines: string[] = [];\n\n  // Match map_utils.py behavior: show hex first if present (even when cols are provided)\n  if ((props as any).hex != null) {\n    lines.push(\n      `<span class=\"tt-row\"><span class=\"tt-key\">hex</span><span class=\"tt-val\">${String((props as any).hex).slice(0, 12)}...</span></span>`\n    );\n  }\n\n  // If columns specified, render them (skipping hex)\n  if (cols.length) {\n    cols.forEach((k) => {\n      if (k === 'hex') return;\n      const val = (props as any)[k];\n      if (val == null) return;\n      const formatted = typeof val === 'number' ? Number(val).toFixed(2) : String(val);\n      lines.push(`<span class=\"tt-row\"><span class=\"tt-key\">${k}</span><span class=\"tt-val\">${formatted}</span></span>`);\n    });\n    return lines;\n  }\n\n  // Default fallback: if we didn't add anything yet, show first 5 properties\n  if (lines.length === 0) {\n    Object.keys(props)\n      .slice(0, 5)\n      .forEach((k) => {\n        lines.push(`<span class=\"tt-row\"><span class=\"tt-key\">${k}</span><span class=\"tt-val\">${(props as any)[k]}</span></span>`);\n      });\n  }\n\n  return lines;\n}\n\n"],"names":["applyViewState","map","viewState","undefined","longitude","latitude","setCenter","zoom","setZoom","pitch","setPitch","bearing","setBearing","getViewState","center","getCenter","lng","lat","getZoom","getPitch","getBearing","getPaletteColors","name","steps","cartocolor","window","pal","keys","Object","Number","filter","n","isNaN","sort","a","b","best","find","length","toRgba","arr","defaultAlpha","Array","isArray","r","g","FALLBACK_CONTINUOUS_COLORS","FALLBACK_CATEGORICAL_COLORS","getUniqueCategories","data","attr","labelAttr","seen","Map","forEach","d","val","properties","has","label","set","String","entries","localeCompare","value","buildColorExpr","cfg","fnType","domainCats","domain","catPairs","categories","c","colors","Math","max","fallback","nullColor","slice","join","expr","cat","i","push","_detectedCategories","buildCategoricalExpr","d0","d1","isReversed","wantsReverse","reverse","buildContinuousExpr","toH3","hex","s","startsWith","test","BigInt","toString","toLowerCase","trunc","e","hexToGeoJSON","features","hexId","h3","index","id","isValidCell","coords","cellToBoundary","type","geometry","coordinates","addStaticHexLayer","layer","geojson","visible","hexLayer","src","getSource","setData","addSource","_","fillColor","getFillColor","lineColor","getLineColor","layerOpacity","opacity","isFinite","min","extruded","elevScale","elevationScale","elevProp","elevationProperty","addLayer","source","paint","layout","visibility","filled","stroked","lineWidthMinPixels","setHexLayerVisibility","layerId","isExtruded","getLayer","setLayoutProperty","addVectorLayer","vecData","f","fillColorExpr","fillColorConfig","fillColorRgba","lineColorExpr","lineColorConfig","lineColorRgba","lineW","lineWidth","hasPoly","hasPoint","hasLine","t","isFilled","isStroked","pointRadius","addMVTLayer","sourceLayer","tiles","tileUrl","minzoom","maxzoom","fillOpacity","heightProperty","heightMultiplier","extrusionOpacity","setVectorLayerVisibility","addRasterLayer","rasterLayer","hasTileUrl","hasImage","imageUrl","imageBounds","west","south","east","north","boundsToCoordinates","url","tileSize","x","setRasterLayerVisibility","HYPARQUET_LOAD_PROMISE","getDeck","deck","buildColorAccessor","runtime","colorCfg","code","object","Function","fn","dom","cols0","domainReversed","cols","minV","maxV","obj","raw","v","parseFloat","idx","round","replace","parseInt","paletteName","lut","col","get","catState","st","pairs","next","scheduleLegendUpdate","debounce","setTimeout","dispatchEvent","CustomEvent","key","hit","tileToBounds","y","z","PI","pow","atan","sinh","n2","boundsIntersect","wantsAutoDomain","fc","enabled","fillDomainFromUser","hasDomain","autoDomain","parseMaybeNumber","calculateDomainFromTiles","_attr","expectedZ","store","tileStats","getBounds","viewportBounds","getWest","getEast","getSouth","getNorth","minAll","POSITIVE_INFINITY","maxAll","NEGATIVE_INFINITY","count","tileKey","split","abs","span","pad","calculateDomainFromTileStats","maybeUpdateDynamicDomain","old","_dynamicDomain","denom","getTileConfig","tileLayerConfig","minZoom","maxZoom","zoomOffset","maxRequests","refinementStrategy","buildHexTileDeckLayers","layers","onLoadingDelta","TileLayer","H3HexagonLayer","GeoLayers","l","layerType","isTileLayer","tileCfg","rawHexCfg","fillCfg","fillCfgEffective","lineCfg","lineCfgEffective","idHash","h","charCodeAt","hashString","JSON","stringify","fd","ld","coverage","auto","pickable","getTileData","async","signal","cacheKey","cache","inflight","p","res","fetch","aborted","ok","Error","status","ct","headers","parquetMetadata","includes","endsWith","hp","hyparquet","parquetMetadataAsync","parquetReadObjects","w","mod","candidate","default","catch","ensureHyparquetLoaded","console","error","buf","arrayBuffer","byteLength","file","start","end","metadata","utf8","text","_m","k","parse","normalized","rows","props","Boolean","out","lk","MAX_SAFE_INTEGER","MIN_SAFE_INTEGER","sanitizeProperties","mm","columnName","rowGroups","row_groups","row_groups_list","found","rg","columns","columns_list","md","meta_data","metaData","path","path_in_schema","pathInSchema","leaf","stats","statistics","mn","min_value","minimum","minValue","mx","max_value","maximum","maxValue","extractParquetMinMaxFromMetadata","delete","renderSubLayers","getHexagon","getElevation","mapboxPmtilesLib","sourceTypeRegistered","mapboxPmtilesLoadPromise","pmtilesLib","pmtilesLoadPromise","pmtilesLayerNamesCache","extractVectorLayerNamesFromHeader","header","json","names","vector_layers","vl","tilestats","tl","getVectorLayerNamesFallback","inst","then","m","finally","ensurePmtilesMetadataLibLoaded","PMTiles","getMetadata","ensureMapboxPMTilesLoaded","mapboxPmTiles","Promise","resolve","reject","script","document","createElement","onload","onerror","head","appendChild","buildPMTilesColorExpression","colorConfig","attribute","defaultColor","palette","availableSteps","resolvePalette","numColors","othersColor","color","addPMTilesLayers","visibilityState","hasCustomView","mapboxgl","Style","setSourceType","SOURCE_TYPE","PmTilesSource","registerPMTilesSourceType","pmtilesUrl","sourceId","getHeader","bounds","minLon","minLat","maxLon","maxLat","allLayerNames","defaultLayerName","requestedSourceLayer","trim","defaultLayerName2","exclude","Set","excludeSourceLayers","exclude_source_layers","vectorLayer","filterExcluded","autoAllFiltered","sourceLayerNamesToRender","warn","requested","available","vectorStyle","baseLineWidth","pointRadiusMinPixels","effectiveLineWidth","effectiveFillOpacity","renderPoints","renderLines","renderPolygons","colorAttribute","slugify","sl","slSlug","layerZoomProps","circleLayerId","fillLayerId","lineLayerId","fitBounds","padding","duration","layerGeoJSONs","getLayerGeoJSONs","setLayerGeoJSON","clearLayerGeoJSON","addAllLayers","config","removeSingleLayer","removeAllLayers","deckOverlay","some","state","MapboxOverlay","tilesLoading","loader","el","getElementById","innerHTML","body","textEl","hideTimeout","tilesCurrentlyLoading","setLoading","delta","clearTimeout","classList","add","textContent","remove","ensureTileLoader","build","overlay","interleaved","useDevicePixels","addControl","rebuild","setProps","triggerRepaint","autoCandidates","autoTimer","scheduleAuto","delayMs","changed","onMoveEnd","onIdle","onDirty","on","addEventListener","pickObject","opts","destroy","off","removeEventListener","removeControl","createHexTileOverlay","__fused_hex_tiles__","pmtilesLayers","addSingleLayer","prefix","styleLayers","getStyle","removeLayer","removeSource","removePMTilesLayers","setPaintSafe","prop","setPaintProperty","setLayoutSafe","setGeoJSONSourceData","visibilityCallback","unsubscribeStore","installedListeners","clickHandlerInstalled","activeStore","activeVisibilityState","panelEl","handlePanelClick","target","closest","item","getAttribute","current","getCurrentVisible","preventDefault","EYE_OPEN_SVG","EYE_CLOSED_SVG","setupLayerPanel","onVisibilityChange","_store","panel","renderPanel","updateLayerPanel","event","list","getAll","layerState","stripBg","getLayerStripGradient","eyeIcon","order","toGradient","rgba","vecLayer","pmLayer","updateLegend","geojsons","legend","visibleLayers","style","display","html","legendHtml","cc","gj","vgj","layerName","titleAttr","buildCategoricalLegend","gradient","floor","toFixed","buildContinuousLegend","buildLayerLegend","addZoomHomeControl","initialView","screenshotEnabled","homeView","ZoomHomeControl","onAdd","this","_map","container","className","mkBtn","title","onClick","setAttribute","fontSize","lineHeight","fontWeight","alignItems","justifyContent","stopPropagation","zoomIn","zoomOut","easeTo","svgHtml","filename","Date","toISOString","canvas","getCanvas","download","toBlob","blob","URL","createObjectURL","href","click","revokeObjectURL","alert","dataUrl","toDataURL","downloadScreenshot","mkSvgBtn","_container","onRemove","parentNode","removeChild","setHomeViewState","setupWidgets","ScaleControl","maxWidth","unit","addScaleControl","zh","cleanupOrbit","getCanvasContainer","active","startX","startY","startBearing","startPitch","stop","dragPan","enable","cursor","onMove","passive","onUp","metaKey","dx","clientX","dy","clientY","onDown","button","ctrlKey","disable","capture","enableCmdDragOrbit","isPlainObject","deepEqual","ka","kb","deepDelta","base","cur","toPyLiteral","indent","repeat","sym","setPaletteOptions","sel","palettes","paletteGradient","buildMenu","getReverse","getSteps","menuEl","querySelectorAll","selectEl","onPicked","updateSwatch","swatchEl","background","triggerEl","DEBUG_SHELL_ID","elementIds","layerSelect","hexSection","viewStateSection","fillColorSection","lineColorSection","filledEl","strokedEl","extrudedEl","extrusionControls","elevAttrEl","elevScaleEl","opacitySliderEl","opacityEl","fillFnEl","fillFnOptions","fillStaticOptions","fillAttrEl","fillPaletteEl","fillPalTrigger","fillPalSwatch","fillPalMenu","fillDomainMinEl","fillDomainMaxEl","fillRangeMinEl","fillRangeMaxEl","fillStepsEl","fillReverseEl","fillNullEl","fillNullLabel","fillStaticEl","fillStaticLabel","lineFnEl","lineFnOptions","lineStaticOptions","lineAttrEl","linePaletteEl","linePalTrigger","linePalSwatch","linePalMenu","lineDomainMinEl","lineDomainMaxEl","lineReverseEl","lineStaticEl","lineStaticLabel","lineWidthSliderEl","lineWidthEl","lngEl","latEl","zoomEl","pitchEl","bearingEl","viewOut","layerOut","sqlSection","sqlStatusEl","sqlInputEl","aiSection","aiChatEl","aiInputEl","aiSendBtn","aiStatusEl","aiSqlPreviewEl","clamp","lo","hi","parseHexColor","alpha","rgbToHex","rgb","padStart","fmt","digits","setPaintBatch","isDuckDbHexLayer","isHex","isTile","hasParquet","parquetData","parquetUrl","updateDebugTogglePosition","shell","toggle","getBoundingClientRect","width","setProperty","left","contains","ensureColorContinuousCfg","getAttrCandidates","lc","ttc","tooltipColumns","tta","tooltipAttrs","getVectorAttrCandidates","f0","DEFAULT_HEX_STYLE","DEFAULT_TILE_LAYER","DEFAULT_VECTOR_STYLE","setupDebugPanel","sidebarMode","sidebar","debug","resizeHandle","ensureDebugShell","result","queryDebugElements","tabUiBtn","tabSqlBtn","tabAiBtn","tabUiPanel","tabSqlPanel","tabAiPanel","sqlPanel","aiPanel","setActiveTab","tab","persist","localStorage","setItem","onTabActivated","onTabClick","currentTarget","saved","getItem","initialViewState","getPaletteNames","getPreviewSteps","palMgr","menus","attached","closeAll","onDocClick","attach","partial","onTrigger","isOpen","dropdown","refresh","indexOf","splice","refreshAll","createPaletteDropdownManager","fillPal","checked","applyUIToLayer","linePal","editableLayers","getActiveLayer","rebuildDeck","__deckOverlay","findDeckOverlayOnMap","_controls","updateLayerOutput","MAX_STRINGIFY_CHARS","toLayerDef","hl","tile_url","tileLayer","dt","sql","dataRef","source_layer","vcfg","pmtilesPath","pmtiles_path","pmtiles_url","vMerged","image_url","op","deps","sqlTypingTimer","sqlCM","sqlCMLoading","sqlCMBound","isUpdatingSql","dispatchSqlUpdate","getValue","getEditorValue","detail","bindCodeMirrorChange","onTextareaInput","onSqlStatus","evt","CodeMirror","CM","fromTextArea","mode","theme","lineNumbers","gutters","lineWrapping","indentUnit","tabSize","indentWithTabs","setSize","ensureCss","querySelector","link","rel","loadScript","loadCodeMirror","syncFromLayer","disabled","placeholder","setValue","setOption","applySql","toTextArea","createSqlPanel","getActiveLayerId","onSqlGenerated","chatHistory","isLoading","setStatus","isError","renderChat","role","escapeHtml","content","scrollTop","scrollHeight","div","sendMessage","userInput","apiKey","hideSqlPreview","systemPrompt","schema","schemaDesc","tables","table","desc","description","customPrompt","buildSystemPrompt","apiMessages","response","codeBlockMatch","match","selectMatch","trimmed","toUpperCase","extractSqlFromResponse","model","messages","method","Authorization","max_tokens","temperature","choices","message","callOpenRouter","validation","upper","dangerous","keyword","valid","validateSql","applyBtn","copyBtn","navigator","clipboard","writeText","showSqlPreview","err","errMsg","onKeydown","shiftKey","onSendClick","setConfig","newConfig","createAiPanel","aiConfig","ai","updateFillFnOptions","updateLineFnOptions","readLayerToUI","isVector","isPmtiles","hexCfg","attrs","concat","dmin","dmax","step","fcCfg","lcCC","lcCfg","lw","els","opClamped","ep","nc","nr","ng","nb","cfgObj","lwClamped","ids","getCurrentLayerVisibility","removeStaticHexSublayers","updateStaticHexLayer","fillExpr","lineExpr","lineOpacity","applyDebugUIToLayer","syncDomainSliderFromInputs","syncDomainInputsFromSlider","markDomainFromUser","hc","onDomainSliderInput","onDomainSliderChange","updateFromMapStop","vs","activeElement","tagName","isEditingInputs","onToggle","collapsed","resizing","startW","onResizeMove","onResizeUp","_e","onResizeDown","highlightLayerAdded","selectedFeature","highlightFeature","feature","boundary","createBus","channel","bc","messageCallback","BroadcastChannel","handlePostMessage","send","postMessage","parent","top","frames","onMessage","callback","onmessage","close","generateComponentId","random","substr","setupMessaging","broadcast","options","dataset","componentId","bus","lastBounds","broadcastBounds","getBoundsArray","fromComponent","timestamp","now","field","values","loaded","componentType","capabilities","dataSource","protocol","enableBroadcast","sync","mapId","isSyncing","userInteracting","lastBroadcast","NaN","eq","getState","ts","moveTimeout","startInteraction","finishInteraction","msg","jumpTo","requestAnimationFrame","hidden","enableSync","clickBroadcast","locationListener","DEFAULT_DUCKDB_WASM_VERSION","duckModulePromisesByVersion","isSafeStructKey","DuckDbSqlRuntime","constructor","duck","db","conn","tableByLayerId","loadedTables","hasSpatial","version","ready","init","existing","import","ensureDuckModule","bundle","selectBundle","getJsDelivrBundles","workerSrc","mainWorker","worker","Worker","Blob","AsyncDuckDB","ConsoleLogger","instantiate","mainModule","connect","query","layerTableName","ensureLayerTable","tableName","bytes","b64","binaryString","atob","Uint8Array","decodeBase64ToBytes","resp","ab","registerFileBuffer","runSql","sqlText","toArray","row","hexCols","sanitizeDuckRow","getMinMaxFromQuery","minVal","min_val","maxVal","max_val","runSqlGeoJSON","schemaRes","fields","h3Col","every","q","cnt","gjStr","getMinMax","sqlLoader","sqlLayerNames","isSqlHexLayer","ensureSqlLoader","statusByLayer","busy","isBusy","anyInit","dispatchSqlStatus","LayerStore","listeners","nextOrder","clear","emit","update","shiftOrdersFrom","recomputeOrders","changes","updateStyle","styleProp","styleChanges","setVisible","toggleVisible","setVisibleBatch","updates","reorder","newOrder","previousOrder","maxOrder","size","moveUp","moveDown","moveToTop","moveToBottom","setGeoJSON","getGeoJSON","getAllGeoJSONs","getConfig","getAllConfigs","getVisible","getVisibleConfigs","getVisibilityState","getByType","cb","startOrder","sorted","clone","newId","newName","clonedConfig","rename","createLayerStore","normalizeColor","normalizeLayerConfig","tile","tooltip","elevationAttr","normalizeHexLayer","normalizeVectorLayer","normalizeMVTLayer","normalizePMTilesLayer","isNewFormat","VALID_LAYER_TYPES","containerId","normalizedLayers","normalizedConfig","ui","documentElement","mapboxToken","styleUrl","accessToken","projection","pitchWithRotate","preserveDrawingBuffer","initMap","screenshot","widgets","debugHandle","overlayRef","legendUpdateHandler","duckHandle","resizeHandler","resize","visibilityHandler","refreshUI","layerPanel","handleVisibilityChange","setupLegend","geoJSONs","tt","allQueryableLayers","layerIds","layerDef","queryable","ldef","queryIds","layerOrderIndex","findIndex","bestIdx","queryRenderedFeatures","point","picker","info","radius","rawLayerId","baseId","tooltipCols","getTooltipColumns","lines","formatted","buildTooltipLines","setupTooltip","highlightOnClick","queryLayers","getQueryableLayers","setupHighlight","messaging","onUiUpdate","sqlLayers","destroyed","runForLayer","wantsAuto","sqlForStats","domainFromUser","updated","safeSetGeoJsonSource","updateHexPaint","toLocaleString","Event","dispatchLegendUpdate","onSqlUpdate","setupDuckDbSql","LngLatBounds","extend","poly","isEmpty","autoFitBounds","handler","propertyKeys","instance","dispatch","actionOrActions","actions","action","updateLayer","moveLayerUp","moveLayerDown","setLayerVisibility","layerConfig","validateLayerConfig","removed","before","prototype","hasOwnProperty","call","applied","after","lid","updateLayerStyleInPlace","getLayers","updatePMTilesVisibility","FusedMaps"],"mappings":"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"}